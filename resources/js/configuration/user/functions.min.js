var userLimit=null,limitOvercome=!1,company=null;function getUserLimit(){$.ajax({url:uri+"core/tools/accessControl.php",method:"POST",async:!1,data:{action:"getUserLimit"},type:"POST",async:!1,success:function(data){userLimit=$.parseJSON(data)}})}function getCompany(){$.ajax({url:uri+"core/tools/functions.php",method:"POST",data:{type:"getCompany"},dataType:"json",async:!1,success:function(data){company=data},error:function(){$("#block-message").html('<div class="alert alert-error alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> Error mientras se procesaba su solicitud. Vuelva a intentarlo más tarde. Disculpe las molestias.</div>'),setTimeout((function(){$("#block-message").empty()}),5e3)}})}function formatData(data){return data='<div id="'+data.id+'">'+data.text+"</div>"}function getLocation(locationID){var location;return null!=locationID?($.ajax({url:uri+"core/locations/read.php",data:{locationID:locationID},type:"POST",async:!1,success:function(data){location=$.parseJSON(data)}}),location):locationID}function changeSpaceFooter(){var heightFooter=$(".footer-static-bottom").height();$(".content-wrapper").css("padding-bottom",heightFooter)}$(window).scroll((function(){changeSpaceFooter()})),$(window).resize((function(){changeSpaceFooter()})),$((function(){getUserLimit(),$(".footer-static-bottom .block-2 .btn-gotop").before('<button type="button" id="backLink" class="btn btn-default"><i class="fa fa-arrow-circle-left c-lile" aria-hidden="true"></i> Volver</button>'),$("#backLink").click((function(event){event.preventDefault(),""==document.referrer||window.location.href==document.referrer?history.back(1):window.location.href=document.referrer})),changeSpaceFooter(),setWidthBottomToolbar(),$(window).resize((function(){setWidthBottomToolbar()})),$.fn.select2.defaults.set("width","100%");var province;$(".select2").select2({language:"es",placeholder:"--",allowClear:!1});$.ajax({url:uri+"core/locations/functions.php",data:{type:"getProvinces"},type:"POST",async:!1,success:function(data){var provinces=$.parseJSON(data);null!=provinces&&($(".province").append($("<option default />").val("").text("Selecciona una provincia")),$.each(provinces,(function(){$(".province").append($("<option />").val(this.province).text(this.province))})),$(".province").change((function(){$('.province option[value=""]').attr("disabled",!0)})))}}),$(".province").change((function(){province=$(this).val(),$(".location").prop("disabled",!1),$(".location").val("").trigger("change")})),$(".location").prop("disabled",!0),$(".location").select2({language:{inputTooShort:function(args){return"Escribir ..."},inputTooLong:function(args){return"Término demasiado largo"},errorLoading:function(){return"Sin resultados"},loadingMore:function(){return"Cargando más resultados"},noResults:function(){return"No hay resultados"},searching:function(){return"Buscando..."},maximumSelected:function(args){return"Sin resultados"}},placeholder:"--",allowClear:!0,ajax:{url:uri+"core/locations/data2.php",dataType:"json",delay:250,data:function(params){return{q:params.term||"",province:province}},processResults:function(data,params){return{results:$.map(data.items,(function(item){return{text:item.name,id:item.locationID}})),pagination:{more:!1}}},cache:!0},escapeMarkup:function(markup){return markup},templateResult:formatData,templateSelection:formatData}),$.ajax({url:uri+"core/users/functions2.php",method:"POST",data:{type:"getUserTypes"},async:!1,success:function(data){try{data=$.parseJSON(data),$(".type").empty(),null!=data&&$.each(data,(function(index,elem){$(".type").append('<option value="'+elem.id+'">'+elem.name+"</option>")}))}catch(e){$("#block-message").html('<div class="alert alert-error alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> Error mientras se procesaba su solicitud. Vuelva a intentarlo más tarde. Disculpe las molestias.</div>'),setTimeout((function(){$("#block-message").empty()}),5e3)}},error:function(){$("#block-message").html('<div class="alert alert-error alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> Error mientras se procesaba su solicitud. Vuelva a intentarlo más tarde. Disculpe las molestias.</div>'),setTimeout((function(){$("#block-message").empty()}),5e3)}}),$(".datepicker").datepicker({autoclose:!0,language:"es",weekStart:1,todayHighlight:!0,forceParse:!1});var table=$("#datatable").DataTable({ajax:uri+"core/users/listDatatables.php?all=0",responsive:!1,pageLength:25,lengthChange:!0,searching:!0,ordering:!0,info:!0,autoWidth:!0,language:{url:"https://cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/Spanish.json"},fixedHeader:{header:!0,footer:!0},columns:[{title:"#"},{title:"Nombre de Usuario"},{title:"Nombre"},{title:"E-mail"},{title:"Tipo"},{title:"Fecha de Baja"},{title:"Editar"},{title:"Eliminar"}],columnDefs:[{className:"id",targets:0,searchable:!1,visible:!1},{className:"1"==userType?"editClick":"",targets:[1,2,4]},{className:"email"+("1"==userType?" editClick":""),targets:3,render:function(data,type,row){return"display"===type?'<a href="mailto:'+data+'"  title="Enviar correo">'+data+"</a>":data}},{className:"date"+("1"==userType?" editClick":""),targets:5,render:function(data,type){return"display"===type||"filter"===type?null==data?"-":moment(data,"YYYY-MM-DD").format("DD/MM/YYYY"):null==data?0:moment(data,"YYYY-MM-DD").format("X")}},{className:"details-control centered"+("1"==userType?" editClick":""),targets:6,visible:"1"==userType,orderable:!1,searchable:!1,width:"4%",data:null,render:function(data,type,row){return"1"==userType?"<ul class='actions-menu'><li><a href='#' class='btn-edit'  title='Editar'><i class='fa fa-pencil' aria-hidden='true'></i></a></li></ul>":"-"}},{className:"details-control centered"+("1"==userType?" removeClick":""),targets:7,visible:"1"==userType,orderable:!1,searchable:!1,width:"4%",data:null,render:function(data,type,row){return"1"==userType&&row[0]!=user[0].userID?null==data[5]?"<ul class='actions-menu'><li><a href='javascript:void(0)' class='btn-delete' data-toggle='tooltip' title='Borrar'><i class='fa fa-trash' aria-hidden='true'></i></a></li></ul>":"":"-"}}],dom:'rt<"bottom bottom-2"Bp><"clear">',buttons:[{extend:"excelHtml5",exportOptions:{columns:[1,2,3,4,5],search:"applied",order:"applied"},filename:"usuarios",title:"Usuarios",text:'Excel <i class="fa fa-file-excel-o"></i>',className:"c-lile export-button"},{extend:"pdfHtml5",orientation:"portrait",pageSize:"A4",exportOptions:{columns:[1,2,3,4,5],search:"applied",order:"applied"},filename:"usuarios",title:"Usuarios",customize:function(doc){doc.content.splice(0,1),doc.pageMargins=[30,60,30,50],doc.defaultStyle.fontSize=10,doc.header=function(){return{columns:[{alignment:"left",text:"Listado de usuarios",bold:!0,fontSize:12},{alignment:"right",text:moment().format("DD/MM/YYYY HH:mm"),fontSize:10}],margin:30}},doc.footer=function(page,pages){return{columns:[{alignment:"center",text:"Página "+page.toString()+" de "+pages.toString(),fontSize:10}],margin:20}}},text:'PDF <i class="fa fa-file-pdf-o"></i>',className:"c-lile export-button"},{extend:"print",exportOptions:{columns:[1,2,3,4,5],search:"applied",order:"applied"},customize:function(win){$(win.document.body).find("h1").css("display","none")},text:'Imprimir <i class="fa fa-print" aria-hidden="true"></i>',className:"c-lile export-button"}],order:[[0,"desc"]],initComplete:function(){"1"!=company&&"8"!=company&&(table.rows().count()>=userLimit?(limitOvercome=!0,$("#userLimitOvercomeDiv").removeClass("hide"),$("#importUsersSection").remove()):($("#userLimitOvercomeDiv").remove(),$("#importUsersSection").removeClass("hide"))),$("#input-search").on("keyup",(function(){table.search(this.value).draw()}))}});$("#showDeleted").change((function(){$("#showDeleted").prop("checked")?table.ajax.url(uri+"core/users/list.php?all=1").load():table.ajax.url(uri+"core/users/list.php?all=0").load()})),$("#createUserButton").click((function(){limitOvercome?$("#user-limit-overcome").modal("show"):$("#modal-new-user").modal("show")})),$("#saveNewUser").click((function(){var validate=0;if(isEmpty($("#formNewData #username"))?validate++:isUsername($("#formNewData #username"))||validate++,isEmpty($("#formNewData #password"))?validate++:isPassword($("#formNewData #password"))||validate++,isEmpty($("#formNewData #name"))&&validate++,isEmpty($("#formNewData #nif"))?validate++:isNifCif($("#formNewData #nif"))||validate++,isEmpty($("#formNewData #type"))&&validate++,0==validate){var location=$("#formNewData #location").val();"undefined"!=location&&""!=location&&null!=location||(location="null");var type=$("#formNewData #type").val(),post=$("#formNewData #post").val(),username=$("#formNewData #username").val(),password=$("#formNewData #password").val(),nif=$("#formNewData #nif").val(),name=$("#formNewData #name").val(),surname=$("#formNewData #surname").val(),address=$("#formNewData #address").val(),mail=$("#formNewData #mail").val(),phones="";$("#formNewData .phones .label").each((function(){var number=$(this).find(".number").text();phones+=number+"-"})),phones=phones.slice(0,-1);var entryDate=$("#formNewData #entryDate").val();entryDate=moment(entryDate,"DD/MM/YYYY").isValid()?moment(entryDate,"DD/MM/YYYY").format("YYYY-MM-DD"):"NULL",$.post(uri+"core/users/create.php",{location:location,type:type,post:post,username:username,password:password,nif:nif,name:name,surname:surname,address:address,mail:mail,phones:phones,entryDate:entryDate},(function(data){(data=$.parseJSON(data)).success?(table.ajax.reload(),$("#modal-new-user").modal("hide"),$("#block-message").html('<div class="alert alert-success alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> El usuario se ha creado con éxito.</div>')):data.cif?$("#formNewData #msg").html('<div class="alert alert-error alert-dismissible text-center fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> Ya existe un usuario con ese NIF.</div>'):data.username?$("#formNewData #msg").html('<div class="alert alert-error alert-dismissible text-center fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> Ya existe un usuario con ese nombre de usuario.</div>'):data.email?$("#formNewData #msg").html('<div class="alert alert-error alert-dismissible text-center fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> Ya existe un usuario con ese email.</div>'):($("#block-message").html('<div class="alert alert-error alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> Error mientras se procesaba su solicitud. Vuelva a intentarlo más tarde. Disculpe las molestias.</div>'),$("#modal-new-user").modal("hide")),setTimeout((function(){$("#block-message").empty(),$("#formNewData #msg").empty()}),5e3)}))}else $("#modal-new-user #warning-message").html('<div class="alert alert-warning alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> Faltan campos por cubrir o tienen un formato incorrecto</div>'),setTimeout((function(){$("#modal-new-user #warning-message").empty()}),3500)})),table.on("click","tbody .editClick",(function(){$(".btn-edit").tooltip("hide");var rowClick=null==table.row($(this).closest("tr")).data()?table.row($(this).closest("tr.child").prev()).data():table.row($(this).closest("tr")).data();$.post(uri+"core/users/read.php",{userID:rowClick[0]},(function(data){if(data=$.parseJSON(data),$("#formEditData #userID").val(data[0].userID),$("#formEditData #name").val(data[0].userName),$("#formEditData #nif").val(data[0].nif),$("#formEditData #surname").val(data[0].surname),$("#formEditData #address").val(data[0].address),null!=data[0].locationID)if($("#formEditData #location").find("option[value='"+data[0].locationID+"']").length)$("#formEditData #location").val(data[0].locationID).trigger("change");else{var newOption=new Option(data[0].locationName+" - "+data[0].postalCode,data[0].locationID,!0,!0);$("#formEditData #location").append(newOption).trigger("change")}if(null==data[0].province?($("#formEditData #province option[value='']").attr("disabled",!1),$(".location").prop("disabled",!0)):(province=data[0].province,$("#formEditData #province option[value='']").attr("disabled",!0),$("#formEditData #province").val(data[0].province),$(".location").prop("disabled",!1)),null!=data[0].locationID)if($("#formEditData #location").prop("disabled",!1),$("#formEditData #location").find("option[value='"+data[0].locationID+"']").length)$("#formEditData #location").val(data[0].locationID).trigger("change");else{null==data[0].postalCode&&(data[0].postalCode="");newOption=new Option(data[0].locationName+" - "+data[0].postalCode,data[0].locationID,!0,!0);$("#formEditData #location").append(newOption).trigger("change")}var arrayPhones;$("#formEditData #mail").val(data[0].mail),$("#formEditData .phone").val(""),arrayPhones=null!=data[0].phones&&""!=data[0].phones?data[0].phones.split("-"):"";for(var i=0;i<arrayPhones.length;i++)$("#formEditData .phones").append('<span class="label label-default small labelPhones"><span class="number">'+arrayPhones[i]+'</span> <i class="fa fa-times-circle btn-remove" aria-hidden="true"></i></span><br>');$("#formEditData .phones").hasClass("in")||$("#formEditData .phones").addClass("in"),$("#formEditData .phones .label .btn-remove").click((function(){$(this).parent(".label").remove()})),$("#formEditData #phones").val(data[0].phones),$("#formEditData #username").val(data[0].username),$("#formEditData #type").val(data[0].type).trigger("change"),$("#formEditData #post").val(data[0].post),$("#formEditData #entryDate").val(data[0].entryDate)})),$("#modal-edit-user").modal("show")})),$("#saveEditUser").click((function(){var validate=0;if(isEmpty($("#formEditData #name"))&&validate++,isEmpty($("#formEditData #nif"))?validate++:isNifCif($("#formEditData #nif"))||validate++,isEmpty($("#formEditData #type"))&&validate++,0==validate){var userID=$("#formEditData #userID").val(),location=$("#formEditData #location").val();"undefined"!=location&&""!=location&&null!=location||(location="NULL");var type=$("#formEditData #type").val(),post=$("#formEditData #post").val(),username=$("#formEditData #username").val(),password=$("#formEditData #password").val(),nif=$("#formEditData #nif").val(),name=$("#formEditData #name").val(),surname=$("#formEditData #surname").val(),address=$("#formEditData #address").val(),mail=$("#formEditData #mail").val(),phones="";$("#formEditData .phones .label").each((function(){var number=$(this).find(".number").text();phones+=number+"-"})),phones=phones.slice(0,-1);var entryDate=$("#formEditData #entryDate").val();entryDate=moment(entryDate,"DD/MM/YYYY").isValid()?moment(entryDate,"DD/MM/YYYY").format("YYYY-MM-DD"):"NULL",$.post(uri+"core/users/update.php",{userID:userID,location:location,type:type,post:post,username:username,password:password,nif:nif,name:name,surname:surname,address:address,mail:mail,phones:phones,entryDate:entryDate},(function(data){(data=$.parseJSON(data)).success?(table.ajax.reload(),$("#modal-edit-user").modal("hide"),$("#block-message").html('<div class="alert alert-success alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> Los datos del usuario se han actualizado con éxito.</div>')):data.cif?$("#formEditData #msg").html('<div class="alert alert-error alert-dismissible text-center fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> Ya existe un usuario con ese NIF.</div>'):data.email?$("#formEditData #msg").html('<div class="alert alert-error alert-dismissible text-center fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> Ya existe un usuario con ese email.</div>'):($("#block-message").html('<div class="alert alert-error alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> Error mientras se procesaba su solicitud. Vuelva a intentarlo más tarde. Disculpe las molestias.</div>'),$("#modal-edit-user").modal("hide")),setTimeout((function(){$("#block-message").empty(),$("#formEditData #msg").empty()}),5e3)}))}else $("#modal-edit-user #warning-message").html('<div class="alert alert-warning alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> Faltan campos por cubrir o tienen un formato incorrecto</div>'),setTimeout((function(){$("#modal-edit-user #warning-message").empty()}),3500)})),table.on("click","tbody .removeClick",(function(){$(".btn-delete").tooltip("hide");var rowClick=null==table.row($(this).closest("tr")).data()?table.row($(this).closest("tr.child").prev()).data():table.row($(this).closest("tr")).data();if(100==parseInt(rowClick[0])||1==parseInt(rowClick[0]))return!1;null==rowClick[5]&&confirm("¿Está seguro de que quiere borrar el usuario "+rowClick[1]+"?")&&$.post(uri+"core/users/delete.php",{userID:rowClick[0]},(function(data){data?$("#block-message").html('<div class="alert alert-success alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> El usuario se ha eliminado con éxito.</div>'):$("#block-message").html('<div class="alert alert-error alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> Error mientras se procesaba su solicitud. Vuelva a intentarlo más tarde. Disculpe las molestias.</div>'),setTimeout((function(){$("#block-message").empty()}),5e3),table.ajax.reload()}))})),$(".btn-add-phone").click((function(){var phone=$(this).parent().parent().find("#phone"),phoneValue=phone.val();isPhone2(phone)&&($(".phone").val(""),$(".phones").append('<span class="label label-default small labelPhones"><span class="number">'+phoneValue+'</span> <i class="fa fa-times-circle btn-remove" aria-hidden="true"></i></span><br>'),$(".phones").hasClass("in")||$(".phones").addClass("in"),$(".phones .label .btn-remove").click((function(){$(this).parent(".label").remove()})))})),$(".phones .label .btn-remove").click((function(){$(this).parent(".label").remove()})),$("#modal-new-user").on("hidden.bs.modal",(function(e){$("#formNewData input").val(""),$(".phones").html(""),$("#formNewData .phones").hasClass("in")||$("#formNewData .phones").addClass("in"),$("#formNewData #province").val("").trigger("change"),$("#formNewData #location").attr("disabled",!0),$("#formNewData #type").val("").trigger("change"),$("#formNewData #post").val("").trigger("change"),clean("formNewData"),$("#modal-new-user #warning-message").empty()})),$("#modal-edit-user").on("hidden.bs.modal",(function(e){$("#formEditData input").val(""),$(".phones").html(""),$("#formEditData .phones").hasClass("in")||$("#formEditData .phones").addClass("in"),$("#formEditData #province").val("").trigger("change"),$("#formEditData #location").attr("disabled",!0),$("#formEditData #type").val("").trigger("change"),$("#formEditData #post").val("").trigger("change"),clean("formEditData"),$("#modal-edit-user #warning-message").empty()})),$("#downloadTemplate").click((function(){confirm("Recuerda que no puedes modificar la columna ID!")&&$.ajax({url:uri+"core/users/exportData.php",data:!1,type:"POST",async:!1,success:function(data){window.open(uri+"descargar-archivoExcel?file=configuration/users/template.csv","_blank")}})})),$("#goImportData").click((function(){var filelist=$("#importData")[0].files;if(0==filelist.length)$("#importDataMessage").html('<div class="alert alert-warning alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> Debe elegir un archivo para cargar</div>'),setTimeout((function(){$("#importDataMessage").empty()}),5e3);else if("csv"!=filelist[0].name.split(".")[filelist[0].name.split(".").length-1])$("#importDataMessage").html('<div class="alert alert-warning alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> Debe elegir un formato de archivo válido</div>'),setTimeout((function(){$("#importDataMessage").empty()}),5e3);else{$("#importDataMessage").html('<div class="alert alert-info alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> La importación puede tardar varios minutos</div>'),setTimeout((function(){$("#importDataMessage").empty()}),5e3);var data=new FormData;data.append("file",filelist[0]),$.ajax({url:uri+"core/users/importData.php",method:"POST",contentType:!1,data:data,dataType:"json",processData:!1,cache:!1,async:!0,success:function(data){0==data.length?(table.ajax.url(uri+"core/users/list.php").load(),$("#importData").val(""),$("#importDataMessage").html('<div class="alert alert-success alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> El fichero se ha cargado con éxito</div>')):(table.ajax.url(uri+"core/users/list.php").load(),$.each(data,(function(index,value){"Número de columnas incorrecto. Las columnas son: ID, Nombre de Usuario, Contraseña, Nombre, Apellidos, NIF, Dirección, Provincia, Localidad, Email, Teléfonos, Puesto, Tipo de Usuario"==value||"Se ha alcanzado el número máximo de usuarios permitidos."==value?$("#modal-import-errors #titleError").text("Los datos no se han importado por: "):$("#modal-import-errors #titleError").text("Se han importado los datos salvo las siguientes filas: "),$("#modal-import-errors #errors").append("<p> * "+value+"</p>")})),$("#modal-import-errors").modal("show"),$("#importData").val(""),$("#importDataMessage").html('<div class="alert alert-warning alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> El fichero se ha cargado con errores</div>'))},error:function(){$("#importDataMessage").html('<div class="alert alert-error alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> Se ha producido un error al cargar el fichero</div>'),setTimeout((function(){$("#importDataMessage").empty()}),5e3)}})}})),$("#modal-import-errors").on("hidden.bs.modal",(function(){$("#modal-import-errors #errors").empty()}))}));