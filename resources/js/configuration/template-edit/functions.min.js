var logs=[];$.fn.select2.defaults.set("width","100%"),$(".select2").select2({language:"es",placeholder:"--",allowClear:!0}),$(".infinitySelect").select2({language:"es",placeholder:"--",allowClear:!0,minimumResultsForSearch:1/0});var client,limit_page=10,langSelect2={inputTooShort:function(args){return"Escribir ..."},inputTooLong:function(args){return"Término demasiado largo"},errorLoading:function(){return"Sin resultados"},loadingMore:function(){return"Cargando más resultados"},noResults:function(){return"No hay resultados"},searching:function(){return"Buscando..."},maximumSelected:function(args){return"Sin resultados"}};function drawTemplate(client,templateID){templateID=templateID.templateID;var products=getProducts(client,templateID),products2=getProductsSupplied(client,templateID);if(null!=products2&&(products=products.concat(products2)),$("#datatable").append('<thead>   <tr>       <th class="index hide">index</th>       <th class="text-center"></th>       <th class="hide">Template</th>       <th class="productID hide">productID</th>       <th style="text-align: left;">Producto contratado</th>       <th class="text-center hiringMoney">Cantidad</th>       <th class="supplierID hide">proveedorID</th>       <th class="text-center">Proveedor</th>       <th class="modelID hide">modelID</th>       <th class="text-center">Modelo</th>       <th class="text-center">Almacén</th>       <th class="text-center hiringMoney">Precio</th>       <th>Textos</th>       <th class="text-center hiringMoney">Descuento</th>       <th class="hiringTotal">Total</th>       <th class="contable hide">contable</th>       <th class="hiringTexts texto hide">texto</th>       <th class="ehID hide">ehID</th>       <th class="text-center addModel">Añadir modelo</th></tr></thead><tbody></tbody>'),null!=products&&products.length>0){var productos=new Array,flagA=!0,flagB=!0,flagC=!0,flagD=!0,flagE=!0,flagF=!0,flagG=!0,flagH=!0,flagI=!0,flagJ=!0;products.forEach((function(prod,index){switch(prod.blockBelow){case"1":flagA&&($("#datatable tbody").append('<tr id="tr'+prod.product+'" class="info">   <td colspan="11"><h4><strong><i class="fa fa-eye-slash"></i>Servicio fúnebre</strong></h4></td></tr>'),flagA=!1);break;case"2":flagB&&($("#datatable tbody").append('<tr id="tr'+prod.product+'" class="info">   <td colspan="11"><h4><strong><i class="fa fa-eye-slash"></i>Inhumación</strong></h4></td></tr>'),flagB=!1);break;case"3":flagC&&($("#datatable tbody").append('<tr id="tr'+prod.product+'" class="info">   <td colspan="11"><h4><strong><i class="fa fa-eye-slash"></i>Flores</strong></h4></td></tr>'),flagC=!1);break;case"4":flagD&&($("#datatable tbody").append('<tr id="tr'+prod.product+'" class="info">   <td colspan="11"><h4><strong><i class="fa fa-eye-slash"></i>Transporte</strong></h4></td></tr>'),flagD=!1);break;case"5":flagE&&($("#datatable tbody").append('<tr id="tr'+prod.product+'" class="info">   <td colspan="11"><h4><strong><i class="fa fa-eye-slash"></i>Velación</strong></h4></td></tr>'),flagE=!1);break;case"6":flagF&&($("#datatable tbody").append('<tr id="tr'+prod.product+'" class="info">   <td colspan="11"><h4><strong><i class="fa fa-eye-slash"></i>Crematorio</strong></h4></td></tr>'),flagF=!1);break;case"7":flagG&&($("#datatable tbody").append('<tr id="tr'+prod.product+'" class="info">   <td colspan="11"><h4><strong><i class="fa fa-eye-slash"></i>Servicio judicial</strong></h4></td></tr>'),flagG=!1);break;case"8":flagH&&($("#datatable tbody").append('<tr id="tr'+prod.product+'" class="info">   <td colspan="11"><h4><strong><i class="fa fa-eye-slash"></i>Prensa</strong></h4></td></tr>'),flagH=!1);break;case"9":flagI&&($("#datatable tbody").append('<tr id="tr'+prod.product+'" class="info">   <td colspan="11"><h4><strong><i class="fa fa-eye-slash"></i>Suplidos</strong></h4></td></tr>'),flagI=!1);break;case"10":flagJ&&($("#datatable tbody").append('<tr id="tr'+prod.product+'" class="info">   <td colspan="11"><h4><strong><i class="fa fa-eye-slash"></i>Otros</strong></h4></td></tr>'),flagJ=!1)}if($("#datatable tbody").append('<tr id="'+prod.product+'" class="trProduct">  <td class="index hide">'+index+'</td>  <td class="text-center check"><input type="checkbox" id="check'+index+'"></td>  <td class="template hide">'+prod.template+'</td>  <td class="productID hide">'+prod.product+'</td>  <td class="prodName">'+prod.prodName+'</td>  <td class="text-center"><div class="amount'+index+'">      <input type="number" min="1" class="text-center hiringMoney form-control input-sm amount'+index+'" id="amount'+index+'" name="amount" value="'+prod.amount+'">  </div></td>  <td class="supplierID hide">'+prod.supplier+'</td>  <td class="text-center"><div>      <select id="supplier'+index+'" name="supplier" class="form-control supplier supplier'+index+'">  </div></td>  <td class="modelID hide">'+prod.model+'</td>  <td class="text-center"><div>      <select id="model'+index+'" name="model" class="form-control model model'+index+'">  </div></td>  <td class="text-center"><div id="warehouseDiv'+index+'">      <select id="warehouse'+index+'" name="warehouse" class="form-control warehouse warehouse'+index+'" disabled>  </div></td>  <td class="text-center price">     <input type="number" class="hiringMoney text-center form-control cost cost'+index+'" value="'+parseFloat(prod.priceNoIVA).toFixed(2)+'" disabled>  </td>  <td class="hiringTexts text-center">      <div class="withText'+index+'">          <div id="textsAmount'+index+'"></div>      </div>  </td>  <td class="text-center"><div class="discount'+index+'">      <input type="number" min="0" class="text-center hiringMoney form-control input-sm discount'+index+'" id="0discount'+index+'" value="'+prod.discount+'">  </div></td>  <td class="text-center total total'+index+'">0.00 €</td>  <td class="contable hide">'+prod.contable+'</td>  <td class="texto hide">'+prod.withText+'</td>  <td class="ehID hide">'+prod.ID+'</td>  <td class="text-center addModel"><ul class="actions-menu"><li class="enlace'+index+'"><a href="javascript:void(0)" class="btn-add'+index+'"  title="Añadir modelo"><i class="fa fa-plus" aria-hidden="true"></i></a></li></ul></td></tr>'),setTimeout((function(){if($("#warehouse"+index).select2({containerCssClass:"select2-mortuaries",language:langSelect2,placeholder:"--",allowClear:!1,ajax:{url:uri+"core/expedients/hiring/dataMortuaries.php",dataType:"json",delay:250,data:function(params){return{q:params.term||"",page_limit:limit_page,page:params.page}},processResults:function(data,params){return{results:$.map(data.items,(function(item){return{text:item.name,id:item.mortuaryID}})),pagination:{more:!1}}},cache:!1},escapeMarkup:function(markup){return markup},templateResult:formatData,templateSelection:formatData}),null!=prod.warehouse&&0!=prod.warehouse&&"0"!=prod.warehouse){var newOption=new Option(prod.warehouseName,prod.warehouse,!0,!0);$("#warehouse"+index).append(newOption).trigger("change")}2!=prod.type&&$("#warehouseDiv"+index).addClass("hide")}),100),"No proveedor"==prod.suppName&&$(".supplier"+index).parent().addClass("hide"),$.inArray(prod.product,productos)<0?productos.push(prod.product):($(".enlace"+index).empty(),$(".enlace"+index).append('<a href="javascript:void(0)" class="btn-del'+index+'"  title="Eliminar"><i class="fa fa-trash" aria-hidden="true"></i></a>')),0==prod.contable&&$(".amount"+index).addClass("hide"),0==prod.withText)$(".withText"+index).addClass("hide");else{$("div.discount"+index).empty();for(var i=0;i<prod.amount;i++)1==prod.check?($("#textsAmount"+index).append('<input type="text" id="'+index+"text"+i+'" class="hiringTexts form-control">'),$("div.discount"+index).append('<input type="number" id="'+i+"discount"+index+'" class="text-center hiringMoney form-control" value="0.00">')):($("#textsAmount"+index).append('<input type="text" id="'+index+"text"+i+'" class="hiringTexts form-control" disabled>'),$("div.discount"+index).append('<input type="number" id="'+i+"discount"+index+'" class="text-center hiringMoney form-control" value="0.00" disabled>'));$.ajax({url:uri+"core/templates/functions.php",method:"POST",data:{type:"getTexts",tp:prod.ID},async:!1,success:function(data){data=$.parseJSON(data),$.each(data,(function(i,elem){$("#textsAmount"+index+" #"+index+"text"+i).val(elem.value),$("#"+i+"discount"+index).val(elem.discount)}))},error:function(){}})}if(1==prod.check){$("#check"+index).prop("checked",!0),$("#texts"+index).prop("disabled",!1),$("#supplier"+index).prop("disabled",!1),$("#model"+index).prop("disabled",!1),$("#warehouse"+index).prop("disabled",!1),$(".cost"+index).prop("disabled",!0),$("#amount"+index).prop("disabled",!1),$("#0discount"+index).prop("disabled",!1),$(".btn-add"+index).prop("disabled",!1);var totalAmount=$("#amount"+index).val(),totalCost=$(".cost"+index).val();if(0==prod.withText)var discount=$("input#0discount"+index).val();else for(discount=[],i=0;i<totalAmount;i++)$("input#"+i+"discount"+index).prop("disabled",!1),discount.push($("input#"+i+"discount"+index).val());if("1"==prod.editPrice)if(Array.isArray(discount)){var total=0;for(i=0;i<totalAmount;i++)total+=parseFloat(totalCost)-parseFloat(totalCost)*discount[i]/100}else total=parseFloat(totalCost)*totalAmount-parseFloat(totalCost)*totalAmount*discount/100;else if(Array.isArray(discount))for(total=0,i=0;i<totalAmount;i++)total+=parseFloat(totalCost)-parseFloat(totalCost)*discount[i]/100;else total=parseFloat(totalCost)*totalAmount-parseFloat(totalCost)*totalAmount*discount/100;$("td.total"+index).text(parseFloat(total).toFixed(2)+" €"),$.ajax({url:uri+"core/suppliers/functions.php",data:{product:prod.product,type:"getSupplierByProducts"},type:"POST",async:!0,success:function(data){if(data=$.parseJSON(data),count=data.length,1==count){var newOption=new Option(data[0].name,data[0].supplierID,!0,!0);$("#supplier"+index).append(newOption).trigger("change"),parseInt(data[0].supplierID)==currentCompany&&$("#supplier"+index).closest("div").addClass("hide"),$("#supplier"+index).closest("tr").find(".supplierID").text(data[0].supplierID)}}});var newOption=new Option(prod.modelName,prod.model,!0,!0);$("#model"+index).append(newOption).trigger("change")}else $(".total"+index).text("0.00 €"),$("#texts"+index).prop("disabled",!0),$("#supplier"+index).prop("disabled",!0),$("#model"+index).prop("disabled",!0),$(".cost"+index).prop("disabled",!0),"No proveedor"!=prod.suppName&&$(".cost"+index).val("0.00"),$("#amount"+index).prop("disabled",!0),$(".btn-add"+index).prop("disabled",!0),$("#0discount"+index).prop("disabled",!0);if($("#check"+index).change((function(){var row=$(this).closest("tr"),product=(row.find("td.modelID").text(),row.find("td.prodName").text()),amount=row.find("input#amount"+index).val();if(1==$(this).prop("checked")?logs.push("Ha seleccionado el producto "+product):logs.push("Ha deseleccionado el producto "+product),0==prod.withText)var discount=$("input#0discount"+index).val();else{discount=[];for(var i=0;i<amount;i++)discount.push($("input#"+i+"discount"+index).val())}if(1==$("#check"+index).prop("checked")){$("#check"+index).prop("checked",!0),$("#texts"+index).prop("disabled",!1),$("#supplier"+index).prop("disabled",!1),$("#supplier"+index).val("").trigger("change"),$("#model"+index).prop("disabled",!1),$("#model"+index).val("").trigger("change"),$("#warehouse"+index).prop("disabled",!1),$(".cost"+index).prop("disabled",!0),$("#amount"+index).prop("disabled",!1);var numDiscounts=$(".discount"+index).find("input").length;for(i=0;i<numDiscounts;i++)$("#"+i+"discount"+index).prop("disabled",!1);$(".btn-add"+index).prop("disabled",!1);var numTexts=$("#textsAmount"+index).find("input").length;for(i=0;i<numTexts;i++)$("#"+index+"text"+i).attr("disabled",!1);""==$("#supplier"+index).text()&&"No proveedor"!=prod.suppName&&$(".total"+index).text("0.00 €"),$("#supplier"+index).parent().hasClass("hide")||row.find("td.supplierID").text(""),row.find("td.modelID").text(""),$.ajax({url:uri+"core/suppliers/functions.php",data:{product:prod.product,type:"getSupplierByProducts"},type:"POST",async:!0,success:function(data){if(data=$.parseJSON(data),count=data.length,1==count){var newOption=new Option(data[0].name,data[0].supplierID,!0,!0);$("#supplier"+index).append(newOption).trigger("change"),parseInt(data[0].supplierID)==currentCompany&&$("#supplier"+index).closest("div").addClass("hide"),row.find("td.supplierID").text(data[0].supplierID)}}})}else{$(".total"+index).text("0.00 €"),$("#texts"+index).prop("disabled",!0),$("#supplier"+index).prop("disabled",!0),$("#model"+index).prop("disabled",!0),$("#warehouse"+index).prop("disabled",!0),$("#warehouse"+index).val(null).trigger("change"),$(".cost"+index).prop("disabled",!0),$(".cost"+index).val("0.00"),$("#amount"+index).prop("disabled",!0);numDiscounts=$(".discount"+index).find("input").length;for(i=0;i<numDiscounts;i++)$("#"+i+"discount"+index).prop("disabled",!0),$("#"+i+"discount"+index).val(0);$(".btn-add"+index).prop("disabled",!0);for(numTexts=$("#textsAmount"+index).find("input").length,i=0;i<numTexts;i++)$("#"+index+"text"+i).attr("disabled",!0),$("#"+index+"text"+i).val("")}updateTotal()})),$(".supplier"+index).select2({containerCssClass:"hiringSelect",language:langSelect2,allowClear:!1,minimumResultsForSearch:1/0,initSelection:function(element,callback){callback({id:prod.supplier,text:prod.suppName})},ajax:{url:uri+"core/suppliers/data3.php",dataType:"json",delay:250,data:function(params){return{q:params.term||"",product:prod.product,page_limit:limit_page,page:params.page}},processResults:function(data,params){return{results:$.map(data.items,(function(item){return{text:item.name,id:item.supplierID}})),pagination:{more:!1}}},cache:!0},escapeMarkup:function(markup){return markup},templateResult:formatData,templateSelection:formatData}),$(".model"+index).select2({containerCssClass:"hiringSelect",allowClear:!1,minimumResultsForSearch:1/0,initSelection:function(element,callback){callback({id:prod.model,text:prod.modelName})},ajax:{url:uri+"core/products/dataModels2.php",dataType:"json",delay:250,data:function(params){return{q:params.term||"",page_limit:limit_page,page:params.page,product:prod.product,supplier:prod.supplier}},processResults:function(data,params){return{results:$.map(data.items,(function(item){return{text:item.name,id:item.productModelID,price:item.price}})),pagination:{more:!1}}},cache:!0},escapeMarkup:function(markup){return markup},templateResult:formatData,templateSelection:formatData}),$("#check"+index).prop("checked")||($(".supplier"+index).text(""),$(".model"+index).text("")),$(".supplier"+index).on("select2:select",(function(){var row=$(this).closest("tr"),supplierID=$(this).val(),productID=row.find("td.productID").text(),amount=row.find("input#amount"+index).val();if(0==prod.withText)var discount=row.find("input#0discount"+index).val();else{discount=[];for(var i=0;i<amount;i++)discount.push(row.find("input#"+i+"discount"+index).val())}if("No proveedor"==$(".supplier"+index+" option:selected").text().trim()?$(".model"+index).parent().addClass("hide"):($(".model"+index).parent().removeClass("hide"),$(".model"+index).select2({language:langSelect2,allowClear:!1,minimumResultsForSearch:1/0,ajax:{url:uri+"core/products/dataModels2.php",dataType:"json",delay:250,data:function(params){return{q:params.term||"",page_limit:limit_page,page:params.page,product:productID,supplier:supplierID}},processResults:function(data,params){return{results:$.map(data.items,(function(item){return{text:item.name,id:item.productModelID,price:item.price}})),pagination:{more:!1}}},cache:!0},escapeMarkup:function(markup){return markup},templateResult:formatData,templateSelection:formatData})),Array.isArray(discount)){var total=0;for(i=0;i<amount;i++)total+=0-0*discount[i]/100}else total=0*amount-0*amount*discount/100;row.find("td.supplierID").text(supplierID),0==prod.supplied&&row.find("td input.cost").val(parseFloat(0).toFixed(2)),1==$("#check"+index).prop("checked")?0==prod.supplied&&row.find("td.total").text(parseFloat(total).toFixed(2)+" €"):row.find("td.total").text("0.00 €"),$(".model"+index).val("").trigger("change"),row.find(".modelID").text(""),updateTotal()})),$(".model"+index).on("select2:select",(function(){var row=$(this).closest("tr"),modelID=$(this).val(),amount=(row.find("td.productID").text(),row.find("input#amount"+index).val());if(0==prod.withText)var discount=row.find("input#0discount"+index).val();else{discount=[];for(var i=0;i<amount;i++)discount.push(row.find("input#"+i+"discount"+index).val())}var price=0,priceNoIVA=0;if($.ajax({url:uri+"core/templates/functions.php",data:{type:"getPrice",client:client,model:modelID},type:"POST",async:!1,success:function(data){null==(data=$.parseJSON(data))?price=0:(price=data.price,priceNoIVA=data.priceNoIVA)}}),Array.isArray(discount))for(i=0;i<amount;i++)price-price*discount[i]/100;else;row.find("td.modelID").text(modelID),0!=prod.supplied&&1!=prod.supplied||row.find("td input.cost").val(parseFloat(priceNoIVA).toFixed(2)),1==$("#check"+index).prop("checked")?0!=prod.supplied&&1!=prod.supplied||row.find("td.total").text(parseFloat(amount*priceNoIVA).toFixed(2)+" €"):row.find("td.total").text("0.00 €"),updateTotal()})),$("input.cost"+index).change((function(){var row=$(this).closest("tr"),cost=$(this).val(),amount=row.find("input#amount"+index).val();if(0==prod.withText)var discount=row.find("input#0discount"+index).val();else{discount=[];for(var i=0;i<amount;i++)discount.push(row.find("input#"+i+"discount"+index).val())}if(Array.isArray(discount)){var total=0;for(i=0;i<amount;i++)total+=cost-cost*discount[i]/100}else total=cost*amount-cost*amount*discount/100;row.find("td.total").text(parseFloat(total).toFixed(2)+" €"),updateTotal()})),$(":input.amount"+index).bind("change",(function(){var row=$(this).closest("tr"),amount=$(this).val();if(1==prod.withText){var amountTexts=$("#textsAmount"+index).find("input").length;if(amount>amountTexts)for(var i=amountTexts;i<amount;i++){$("#textsAmount"+index).append('<input type="text" id="'+index+"text"+i+'" class="hiringTexts form-control">'),$("div.discount"+index).append('<input type="number" id="'+i+"discount"+index+'" class="text-center hiringMoney form-control" value="0.00">');for(var j=0;j<$("input.amount"+index).val();j++)$("input#"+j+"discount"+index).change((function(){for(var row=$(this).closest("tr"),price=(row.find("input#amount"+index).val(),row.find("td input.cost").val()),total=0,k=0;k<$("input.amount"+index).val();k++){total+=price-price*$("input#"+k+"discount"+index).val()/100}1==$("#check"+index).prop("checked")?row.find("td.total").text(parseFloat(total).toFixed(2)+" €"):row.find("td.total").text("0.00 €"),updateTotal()}))}else for(i=parseInt(amountTexts)-1;i>amount-1;i--)$("#"+index+"text"+i).remove(),$("#"+i+"discount"+index).remove()}if(0==prod.withText)var discount=row.find("input#0discount"+index).val();else for(discount=[],i=0;i<amount;i++)discount.push(row.find("input#"+i+"discount"+index).val());var price=row.find("td input.cost").val();if(Array.isArray(discount)){var total=0;for(i=0;i<amount;i++)total+=price-price*discount[i]/100}else total=price*amount-price*amount*discount/100;1==$("#check"+index).prop("checked")?row.find("td.total").text(parseFloat(total).toFixed(2)+" €"):row.find("td.total").text("0.00 €"),updateTotal(),""==$(this).val()&&$(this).val(1)})),0==prod.withText)$("input#0discount"+index).change((function(){var row=$(this).closest("tr"),discount=$(this).val(),amount=row.find("input#amount"+index).val(),price=row.find("td input.cost").val(),total=price*amount-price*amount*discount/100;1==$("#check"+index).prop("checked")?row.find("td.total").text(parseFloat(total).toFixed(2)+" €"):row.find("td.total").text("0.00 €"),updateTotal(),""==$(this).val()&&$(this).val(0)}));else for(i=0;i<$("input.amount"+index).val();i++)$("input#"+i+"discount"+index).change((function(){""==$(this).val()&&$(this).val(0);for(var row=$(this).closest("tr"),price=(row.find("input#amount"+index).val(),row.find("td input.cost").val()),total=0,i=0;i<$("input.amount"+index).val();i++){total+=price-price*$("input#"+i+"discount"+index).val()/100}1==$("#check"+index).prop("checked")?row.find("td.total").text(parseFloat(total).toFixed(2)+" €"):row.find("td.total").text("0.00 €"),updateTotal()}));$(".btn-del"+index).on("click",(function(){var row=$(this).closest("tr");removeProduct(row.find("td.ehID").text()),$(".btn-del"+index).tooltip("hide"),row.remove(),updateTotal()}));var indexCheck=index;$(".btn-add"+index).on("click",(function(){$(".btn-add"+index).tooltip("hide");var check=$("#check"+indexCheck).prop("checked"),lastIndex=0;$("#datatable tbody tr").each((function(){parseInt($(this).find("td.index").text())>lastIndex&&(lastIndex=$(this).find("td.index").text())}));var index=++lastIndex,row=$(this).closest("tr"),thisIndex=$(this).closest("tr").index(),template=row.find("td.template").text(),productID=row.find("td.productID").text(),prodName=row.find("td.prodName").text(),supplierID="",contable=(row.find("td.suppName").text(),row.find("td.modelName").text(),row.find("input#amount"+thisIndex).val(),row.find("textarea#texts").val(),row.find("input#discount"+thisIndex).val(),row.find("td.contable").text()),withText=row.find("td.texto").text();row.find("td.texto").text();if($("#datatable tbody").append('<tr id="'+productID+'"  class="trProduct">  <td class="index hide">'+index+'</td>  <td class="text-center check"><input type="checkbox" id="check'+index+'"></td>  <td class="template hide">'+template+'</td>  <td class="productID hide">'+productID+'</td>  <td class="prodName">'+prodName+'</td>  <td class="text-center"><div class="amount'+index+'">      <input type="number" min="0" class="text-center hiringMoney form-control input-sm amount'+index+'" id="amount'+index+'" name="amount" value="1">  </div></td>  <td class="supplierID hide">'+supplierID+'</td>  <td class="text-center"><div>      <select id="supplier'+index+'" name="supplier" class="text-center form-control supplier supplier'+index+'">  </div></td>  <td class="modelID hide"></td>  <td class="text-center"><div>      <select id="model'+index+'" name="model" class="text-center form-control model model'+index+'">  </div></td>  <td class="text-center"><div id="warehouseDiv'+index+'">      <select id="warehouse'+index+'" name="warehouse" class="text-center form-control warehouse warehouse'+index+'" disabled>  </div></td>  <td class="text-center price">     <input type="number" class="hiringMoney text-center form-control cost cost'+index+'" value="'+parseFloat("0.00").toFixed(2)+'" disabled>  </td>  <td>      <div class="withText'+index+'">          <div id="textsAmount'+index+'">              \x3c!--<button type="button" id="texts'+index+'" class="btn btn-xs btn-default">Ver textos</button>--\x3e          </div>      </div>  </td>  <td class="text-center"><div class="discount'+index+'">      <input type="number" min="0" class="text-center hiringMoney form-control input-sm discount'+index+'" id="0discount'+index+'" value="0.00">  </div></td>  <td class="text-center total total'+index+'">0.00 €</td>  <td class="contable hide">'+contable+'</td>  <td class="texto hide">'+withText+'</td>  <td class="ehID hide"></td>  <td class="addModel"><ul class="actions-menu"><li><a href="javascript:void(0)" class="btn-del'+index+'"  title="Eliminar"><i class="fa fa-trash" aria-hidden="true"></i></a></li></ul></td></tr>'),setTimeout((()=>{if($.ajax({url:uri+"core/suppliers/functions.php",data:{product:prod.product,type:"getSupplierByProducts"},type:"POST",async:!0,success:function(data){if(data=$.parseJSON(data),count=data.length,1==count){var newOption=new Option(data[0].name,data[0].supplierID,!0,!0);$("#supplier"+index).append(newOption).trigger("change"),supplierID=prod.supplier,parseInt(data[0].supplierID)==currentCompany&&$("#supplier"+index).closest("div").addClass("hide"),$("#supplier"+index).closest("tr").find(".supplierID").text(data[0].supplierID)}}}),$("#warehouse"+index).select2({containerCssClass:"select2-mortuaries",language:langSelect2,placeholder:"--",allowClear:!1,ajax:{url:uri+"core/expedients/hiring/dataMortuaries.php",dataType:"json",delay:250,data:function(params){return{q:params.term||"",page_limit:limit_page,page:params.page,mortuary:null}},processResults:function(data,params){return{results:$.map(data.items,(function(item){return{text:item.name,id:item.mortuaryID}})),pagination:{more:!1}}},cache:!1},escapeMarkup:function(markup){return markup},templateResult:formatData,templateSelection:formatData}),null!=prod.warehouse&&0!=prod.warehouse&&"0"!=prod.warehouse){var newOption=new Option(prod.warehouseName,prod.warehouse,!0,!0);$("#warehouse"+index).append(newOption).trigger("change")}2!=prod.type&&$("#warehouseDiv"+index).addClass("hide")}),100),"No proveedor"==prod.suppName?($(".supplier"+index).parent().addClass("hide"),supplierID=prod.supplier):$(".supplier"+index).parent().removeClass("hide"),"Modelo estándar"==prod.modelName?setTimeout((()=>{var newOption=new Option(prod.modelName,prod.model,!0,!0);$("#model"+index).append(newOption).trigger("change"),$("#model"+index).closest("tr").find("td.modelID").text(prod.model)}),300):$(".model"+index).parent().removeClass("hide"),0==contable&&$(".amount"+index).addClass("hide"),0==withText?$(".withText"+index).addClass("hide"):$("#textsAmount"+index).append('<input type="text" id="'+index+'text0" class="hiringTexts form-control" disabled>'),$("#check"+index).change((function(){var row=$(this).closest("tr"),amount=(row.find("td.modelID").text(),row.find("input#amount"+index).val());if(0==prod.withText)var discount=$("input#0discount"+index).val();else{discount=[];for(var i=0;i<amount;i++)discount.push($("input#"+i+"discount"+index).val())}if(1==$("#check"+index).prop("checked")){$("#check"+index).prop("checked",!0),$("#texts"+index).prop("disabled",!1),$("#supplier"+index).prop("disabled",!1),$("#supplier"+index).val("").trigger("change"),$("#model"+index).prop("disabled",!1),$("#model"+index).val("").trigger("change"),$("#warehouse"+index).prop("disabled",!1),$(".cost"+index).prop("disabled",!0),$("#amount"+index).prop("disabled",!1);var numDiscounts=$(".discount"+index).find("input").length;for(i=0;i<numDiscounts;i++)$("#"+i+"discount"+index).prop("disabled",!1);$(".btn-add"+index).prop("disabled",!1);var numTexts=$("#textsAmount"+index).find("input").length;for(i=0;i<numTexts;i++)$("#"+index+"text"+i).attr("disabled",!1);""==$("#supplier"+index).text()&&"No proveedor"!=prod.suppName&&$(".total"+index).text("0.00 €"),$("#supplier"+index).parent().hasClass("hide")||row.find("td.supplierID").text(""),row.find("td.modelID").text(""),$.ajax({url:uri+"core/suppliers/functions.php",data:{product:prod.product,type:"getSupplierByProducts"},type:"POST",async:!0,success:function(data){if(data=$.parseJSON(data),count=data.length,1==count){var newOption=new Option(data[0].name,data[0].supplierID,!0,!0);$("#supplier"+index).append(newOption).trigger("change"),parseInt(data[0].supplierID)==currentCompany&&($("#supplier"+index).closest("div").addClass("hide"),supplierID=data[0].supplierID),$("#supplier"+index).closest("tr").find(".supplierID").text(data[0].supplierID)}}})}else{$(".total"+index).text("0.00 €"),$("#texts"+index).prop("disabled",!0),$("#supplier"+index).prop("disabled",!0),$("#model"+index).prop("disabled",!0),$("#warehouse"+index).prop("disabled",!0),$(".cost"+index).prop("disabled",!0),$(".cost"+index).val("0.00"),$("#amount"+index).prop("disabled",!0);numDiscounts=$(".discount"+index).find("input").length;for(i=0;i<numDiscounts;i++)$("#"+i+"discount"+index).prop("disabled",!0);$(".btn-add"+index).prop("disabled",!0);for(numTexts=$("#textsAmount"+index).find("input").length,i=0;i<numTexts;i++)$("#"+index+"text"+i).attr("disabled",!0)}})),$(".supplier"+index).select2({containerCssClass:"hiringSelect",language:langSelect2,allowClear:!1,minimumResultsForSearch:1/0,initSelection:function(element,callback){callback({id:prod.supplier,text:prod.suppName})},ajax:{url:uri+"core/suppliers/data3.php",dataType:"json",delay:250,data:function(params){return{q:params.term||"",product:productID,page_limit:limit_page,page:params.page}},processResults:function(data,params){return{results:$.map(data.items,(function(item){return{text:item.name,id:item.supplierID}})),pagination:{more:!1}}},cache:!0},escapeMarkup:function(markup){return markup},templateResult:formatData,templateSelection:formatData}),$(".model"+index).select2({containerCssClass:"hiringSelect",language:langSelect2,allowClear:!1,minimumResultsForSearch:1/0,initSelection:function(element,callback){callback({id:prod.model,text:prod.modelName})},ajax:{url:uri+"core/products/dataModels2.php",dataType:"json",delay:250,data:function(params){return{q:params.term||"",page_limit:limit_page,page:params.page,product:productID,supplier:supplierID}},processResults:function(data,params){return{results:$.map(data.items,(function(item){return{text:item.name,id:item.productModelID,price:item.price}})),pagination:{more:!1}}},cache:!0},escapeMarkup:function(markup){return markup},templateResult:formatData,templateSelection:formatData}),$(".supplier"+index).on("select2:select",(function(){var row=$(this).closest("tr"),supplierID=$(this).val(),productID=row.find("td.productID").text(),amount=row.find("input#amount"+index).val();if(0==prod.withText)var discount=row.find("input#0discount"+index).val();else{discount=[];for(var i=0;i<amount;i++)discount.push(row.find("input#"+i+"discount"+index).val())}if("No proveedor"==$(".supplier"+index+" option:selected").text().trim()?$(".model"+index).parent().addClass("hide"):($(".model"+index).parent().removeClass("hide"),$(".model"+index).select2({language:langSelect2,allowClear:!1,minimumResultsForSearch:1/0,ajax:{url:uri+"core/products/dataModels2.php",dataType:"json",delay:250,data:function(params){return{q:params.term||"",page_limit:limit_page,page:params.page,product:productID,supplier:supplierID}},processResults:function(data,params){return{results:$.map(data.items,(function(item){return{text:item.name,id:item.productModelID,price:item.price}})),pagination:{more:!1}}},cache:!0},escapeMarkup:function(markup){return markup},templateResult:formatData,templateSelection:formatData})),Array.isArray(discount)){var total=0;for(i=0;i<amount;i++)total+=0-0*discount[i]/100}else total=0*amount-0*amount*discount/100;row.find("td.supplierID").text(supplierID),0==prod.supplied&&row.find("td input.cost").val(parseFloat(0).toFixed(2)),1==$("#check"+index).prop("checked")?0==prod.supplied&&row.find("td.total").text(parseFloat(total).toFixed(2)+" €"):row.find("td.total").text("0.00 €"),row.find(".model"+index).val("").trigger("change"),row.find(".modelID").text(""),updateTotal()})),$(".model"+index).on("select2:select",(function(){var row=$(this).closest("tr"),modelID=$(this).val(),amount=(row.find("td.productID").text(),row.find("input#amount"+index).val());if(0==prod.withText)var discount=row.find("input#0discount"+index).val();else{discount=[];for(var i=0;i<amount;i++)discount.push(row.find("input#"+i+"discount"+index).val())}var price=0,priceNoIVA=0;if($.ajax({url:uri+"core/templates/functions.php",data:{type:"getPrice",client:client,model:modelID},type:"POST",async:!1,success:function(data){null==(data=$.parseJSON(data))?price=0:(price=data.price,priceNoIVA=data.priceNoIVA)}}),Array.isArray(discount))for(i=0;i<amount;i++)price-price*discount[i]/100;else;row.find("td.modelID").text(modelID),0!=prod.supplied&&1!=prod.supplied||row.find("td input.cost").val(parseFloat(priceNoIVA).toFixed(2)),1==$("#check"+index).prop("checked")?0!=prod.supplied&&1!=prod.supplied||row.find("td.total").text(parseFloat(amount*priceNoIVA).toFixed(2)+" €"):row.find("td.total").text("0.00 €"),updateTotal()})),"Modelo estándar"!=$(".model"+index+" option:selected").text().trim()&&$(".model"+index+" option:selected").parent().removeClass("hide"),$("input.cost"+index).change((function(){var row=$(this).closest("tr"),cost=$(this).val(),amount=row.find("input#amount"+index).val();if(0==prod.withText)var discount=row.find("input#0discount"+index).val();else{discount=[];for(var i=0;i<amount;i++)discount.push(row.find("input#"+i+"discount"+index).val())}if(Array.isArray(discount)){var total=0;for(i=0;i<amount;i++)total+=cost-cost*discount[i]/100}else total=cost*amount-cost*amount*discount/100;row.find("td.total").text(parseFloat(total).toFixed(2)+" €"),updateTotal()})),$(":input.amount"+index).bind("change",(function(){var row=$(this).closest("tr"),amount=$(this).val();if(1==prod.withText){var amountTexts=$("#textsAmount"+index).find("input").length;if(amount>amountTexts)for(var i=amountTexts;i<amount;i++){$("#textsAmount"+index).append('<input type="text" id="'+index+"text"+i+'" class="hiringMoney form-control">'),$("div.discount"+index).append('<input type="number" id="'+i+"discount"+index+'" class="text-center hiringMoney form-control" value="0.00">');for(var j=0;j<$("input.amount"+index).val();j++)$("input#"+j+"discount"+index).change((function(){for(var row=$(this).closest("tr"),price=row.find("td input.cost").val(),total=0,k=0;k<$("input.amount"+index).val();k++){total+=price-price*$("input#"+k+"discount"+index).val()/100}1==$("#check"+index).prop("checked")?row.find("td.total").text(parseFloat(total).toFixed(2)+" €"):row.find("td.total").text("0.00 €"),updateTotal()}))}else for(i=parseInt(amountTexts)-1;i>amount-1;i--)$("#"+index+"text"+i).remove(),$("#"+i+"discount"+index).remove()}if(0==prod.withText)var discount=row.find("input#0discount"+index).val();else for(discount=[],i=0;i<amount;i++)discount.push(row.find("input#"+i+"discount"+index).val());var price=row.find("td input.cost").val();if(Array.isArray(discount)){var total=0;for(i=0;i<amount;i++)total+=price-price*discount[i]/100}else total=price*amount-price*amount*discount/100;1==$("#check"+index).prop("checked")?row.find("td.total").text(parseFloat(total).toFixed(2)+" €"):row.find("td.total").text("0.00 €"),updateTotal(),""==$(this).val()&&$(this).val(1)})),$("#texts"+index).click((function(){$("#texts").empty(),$("#texts").append('<div id="textsModal'+index+'"></div>');var modelID=$(this).closest("tr").find("td.modelID").text();$("#formNewText #textsIndex").val(index),$("#formNewText #textsExpedient").val(expedientID),$("#formNewText #textsModel").val(modelID);for(var i=0;i<$(":input.amount"+index).val();i++)$("#textsModal"+index).append('<div class="form-group col-lg-12 col-md-12 col-sm-12 col-xs-12">   <span>Ítem '+(i+1)+'</span>   <textarea class="form-control" id="text'+i+'" rows="3"></textarea></div>');$.ajax({url:uri+"core/expedients/hiring/functions.php",data:{type:"getTexts",expedientID:expedientID,modelID:modelID},type:"POST",async:!1,success:function(data){null!=(data=$.parseJSON(data))&&data.forEach((function(elem,index){$("#text"+index).text(elem.value)}))}})})),0==prod.withText)$("input#0discount"+index).change((function(){""==$(this).val()&&$(this).val(0);var row=$(this).closest("tr"),discount=$(this).val(),amount=row.find("input#amount"+index).val(),price=row.find("td input.cost").val(),total=price*amount-price*amount*discount/100;1==$("#check"+index).prop("checked")?row.find("td.total").text(parseFloat(total).toFixed(2)+" €"):row.find("td.total").text("0.00 €"),updateTotal()}));else for(var i=0;i<$("input.amount"+index).val();i++)$("input#"+i+"discount"+index).change((function(){for(var row=$(this).closest("tr"),price=row.find("td input.cost").val(),total=0,i=0;i<$("input.amount"+index).val();i++){total+=price-price*$("input#"+i+"discount"+index).val()/100}1==$("#check"+index).prop("checked")?row.find("td.total").text(parseFloat(total).toFixed(2)+" €"):row.find("td.total").text("0.00 €"),updateTotal(),""==$(this).val()&&$(this).val(0)}));$(".btn-del"+index).on("click",(function(){var row=$(this).closest("tr");$(".btn-del"+index).tooltip("hide"),row.remove(),updateTotal()})),1==check?($("#check"+index).prop("checked",!0).trigger("change"),$("#texts"+index).prop("disabled",!1),$("#supplier"+index).prop("disabled",!1),$("#supplier"+index).text(""),$("#model"+index).prop("disabled",!1),$("#warehouse"+index).prop("disabled",!1),$("#model"+index).text(""),$(".cost"+index).prop("disabled",!0),$("#amount"+index).prop("disabled",!1),$("#discount"+index).prop("disabled",!1),$("#"+index+"text0").attr("disabled",!1),$(".btn-add"+index).prop("disabled",!1)):($(".total"+index).text("0.00 €"),$("#texts"+index).prop("disabled",!0),$("#supplier"+index).prop("disabled",!0),$("#supplier"+index).text(""),$("#model"+index).prop("disabled",!0),$("#warehouse"+index).prop("disabled",!0),$("#model"+index).text(""),$(".cost"+index).prop("disabled",!0),$(".cost"+index).val("0.00"),$("#amount"+index).prop("disabled",!0),$("#"+index+"text0").attr("disabled",!0),$("#0discount"+index).attr("disabled",!0),$(".btn-add"+index).prop("disabled",!0),$("#discount"+index).prop("disabled",!0));var rows=$("#datatable tbody tr"),aux="",aux2="";for(i=0;i<rows.length;i++)""!=aux&&(aux2=rows[i],rows[i]=aux,aux=aux2),i==thisIndex&&(aux=rows[rows.length-1]);for(i=0;i<rows.length;i++)$("#datatable tbody").append(rows[i]);updateTotal()}))})),updateTotal()}}function getCurrentCompany(){var company;return $.ajax({url:uri+"core/suppliers/functions.php",data:{type:"getCurrentCompany"},type:"POST",async:!1,success:function(data){company=$.parseJSON(data)}}),company}function formatData(data){return data='<div id="'+data.id+'">'+data.text+"</div>"}function getPriceByTypeClient(clientType){var price;return $.ajax({url:uri+"core/products/functions.php",type:"POST",data:{type:"getPriceByTypeClient",clientType:clientType},async:!1,success:function(data){price=$.parseJSON(data)}}),price}function getTotal(amount,retail,discount){return(retail-retail*discount/100)*amount}function getTemplate(templateID,type){var template;return $.ajax({url:uri+"core/templates/functions.php",type:"POST",data:{templateID:templateID,type:type},async:!1,success:function(data){template=$.parseJSON(data)[0]}}),template}function getClientTypes(type){var clientTypes;return $.ajax({url:uri+"core/clients/functions.php",type:"POST",data:{type:type},async:!1,success:function(data){clientTypes=$.parseJSON(data)}}),clientTypes}function getProducts(client,template){var products;return $.ajax({url:uri+"core/templates/functions.php",data:{type:"getProducts",client:client,template:template},type:"POST",async:!1,success:function(data){products=$.parseJSON(data)}}),products}function getProductsSupplied(client,template){var products;return $.ajax({url:uri+"core/templates/functions.php",data:{type:"getProductsSupplied",client:client,template:template},type:"POST",async:!1,success:function(data){products=$.parseJSON(data)}}),products}function removeProduct(tpID){$.ajax({url:uri+"core/templates/functions.php",data:{ID:tpID,type:"removeProduct"},type:"POST",async:!1})}function decimalAdjust(type,value,exp){return void 0===exp||0==+exp?Math[type](value):(value=+value,exp=+exp,isNaN(value)||"number"!=typeof exp||exp%1!=0?NaN:(value=value.toString().split("e"),+((value=(value=Math[type](+(value[0]+"e"+(value[1]?+value[1]-exp:-exp)))).toString().split("e"))[0]+"e"+(value[1]?+value[1]+exp:exp))))}function roundLikePHP(num,dec){var num_sign=num>=0?1:-1;return parseFloat((Math.round(num*Math.pow(10,dec)+1e-4*num_sign)/Math.pow(10,dec)).toFixed(dec))}function updateTotal(){var acumulado=0;$("#datatable tbody tr.trProduct").each((function(index){var row=$(this).closest("tr"),thisIndex=row.find("td.index").text();if($("#check"+thisIndex).prop("checked")){var modelID=row.find("td.modelID").text();""!=modelID&&$.ajax({url:uri+"core/templates/functions.php",data:{model:modelID,client:client,type:"getPrice"},type:"POST",async:!1,success:function(data){data=$.parseJSON(data);var amount=parseFloat(row.find("#amount"+thisIndex).val()),texts=row.find("#textsAmount"+thisIndex).children();if(texts.length>0){var discount=[];$.each(texts,(function(index,elem){discount.push(row.find(".discount"+thisIndex).find("#"+index+"discount"+thisIndex).val())}))}else discount=parseFloat(row.find("#0discount"+thisIndex).val());if("0"==data.supplied&&"1"!=data.editPrice)if(Array.isArray(discount))for(var i=0;i<discount.length;i++)acumulado+=parseFloat(data.price)-parseFloat(data.price)*parseFloat(discount[i])/100;else acumulado+=(parseFloat(data.price)-parseFloat(data.price)*parseFloat(discount)/100)*amount;else if("1"==data.editPrice)if(Array.isArray(discount)){var subtotal=row.find(".cost"+thisIndex).val();for(i=0;i<discount.length;i++){var withDiscount=parseFloat(subtotal)-parseFloat(subtotal)*parseFloat(discount[i])/100;acumulado=acumulado+withDiscount+withDiscount*parseFloat(data.percentage)/100}}else{subtotal=row.find(".cost"+thisIndex).val(),withDiscount=parseFloat(subtotal)-parseFloat(subtotal)*parseFloat(discount)/100;acumulado+=(withDiscount+withDiscount*parseFloat(data.percentage)/100)*amount}else if(Array.isArray(discount))for(subtotal=row.find(".cost"+thisIndex).val(),i=0;i<discount.length;i++)acumulado+=parseFloat(subtotal)-parseFloat(subtotal)*parseFloat(discount[i])/100;else{subtotal=row.find(".cost"+thisIndex).val();acumulado+=parseFloat(subtotal)*amount}}})}})),$("#formEditTemplate #templateTotal").val(roundLikePHP(acumulado,2))}function getPrice(price,model,type){var pri=0;return $.ajax({url:uri+"core/products/functions.php",data:{price:price,model:model,type:type},type:"POST",async:!1,success:function(data){null!=(data=$.parseJSON(data))&&(pri=parseFloat(data.price).toFixed(2))}}),pri}function existsTemplate(template){var check;return $.ajax({url:uri+"core/templates/functions.php",method:"POST",data:{type:"existsTemplate",template:template},async:!1,success:function(data){try{check=$.parseJSON(data)}catch(e){check=!1}},error:function(){check=!1}}),check}Math.round10||(Math.round10=function(value,exp){return decimalAdjust("round",value,exp)}),Math.floor10||(Math.floor10=function(value,exp){return decimalAdjust("floor",value,exp)}),Math.ceil10||(Math.ceil10=function(value,exp){return decimalAdjust("ceil",value,exp)});var currentCompany=getCurrentCompany();function changeSpaceFooter(){var heightFooter=$(".footer-static-bottom").height();$(".content-wrapper").css("padding-bottom",heightFooter)}$(window).scroll((function(){changeSpaceFooter()})),$(window).resize((function(){changeSpaceFooter()})),$((function(){$(".footer-static-bottom .block-2 .btn-gotop").before('<button type="button" id="backLink" class="btn btn-default"><i class="fa fa-arrow-circle-left c-lile" aria-hidden="true"></i> Volver</button>'),$(".footer-static-bottom .block-2 .btn-gotop").before('<button type="button" id="cancelLink" class="btn btn-danger"><i class="fa fa-close" aria-hidden="true"></i> Cancelar</button>'),$(".footer-static-bottom .block-2 .btn-gotop").before('<button type="button" id="saveEditTemplate" name="saveEditTemplate" class="btn btn-primary"><i class="fa fa-floppy-o" aria-hidden="true"></i> Guardar</button>'),$(".footer-static-bottom .block-2 .btn-gotop").before('<button type="button" id="exportTemplate" name="exportTemplate" class="btn btn-success"><i class="fa fa-download" aria-hidden="true"></i> Exportar</button>'),changeSpaceFooter(),$("#cancelLink").click((function(event){event.preventDefault(),""==document.referrer||window.location.href==document.referrer?history.back(1):window.location.href=document.referrer})),$("#backLink").click((function(event){$("#saveEditTemplate").click(),event.preventDefault(),""==document.referrer||window.location.href==document.referrer?history.back(1):window.location.href=document.referrer})),$(".btn-gotop").click((function(){return $("html, body").animate({scrollTop:0},800),!1})),setWidthBottomToolbar(),$(window).resize((function(){setWidthBottomToolbar()}));var templateID=$("#formEditTemplate #templateID").val();if(!existsTemplate(templateID))return $("#existsTemplate").removeClass("hide"),void setTimeout((()=>{window.location.href=uri+"configuracion/plantillas"}),2500);$("#existsTemplate").remove();var template=getTemplate(templateID,"getTemplate");$("#formEditTemplate #templateName").val(template.name);var clients=getClientTypes("getClientTypes");clients.forEach((function(element){var optionsClientType=new Option(element.name,element.clientTypeID,!1,!0);$("#formEditTemplate #templateTypeClient").append(optionsClientType).trigger("change")})),$("#formEditTemplate #templateTypeClient").val(template.clientType).trigger("change"),client=template.price,$("#formEditTemplate #templatePrice").select2({language:{inputTooShort:function(args){return"Escribir ..."},inputTooLong:function(args){return"Término demasiado largo"},errorLoading:function(){return"Sin resultados"},loadingMore:function(){return"Cargando más resultados"},noResults:function(){return"No hay resultados"},searching:function(){return"Buscando..."},maximumSelected:function(args){return"Sin resultados"}},allowClear:!0,ajax:{url:uri+"core/prices/dataCompanies.php",dataType:"json",delay:250,data:function(params){return{q:params.term||"",page_limit:10,page:params.page}},processResults:function(data,params){return{results:$.map(data.items,(function(item){return{text:item.name,id:item.priceID}})),pagination:{more:!1}}},cache:!0},escapeMarkup:function(markup){return markup},templateResult:formatData,templateSelection:formatData});var optionPrice=new Option(template.priceName,template.price,!1,!0);$("#formEditTemplate #templatePrice").append(optionPrice).trigger("change"),$("#templatePrice").change((function(){$("#datatable").remove()})),drawTemplate(client,template),$("#saveEditTemplate").click((function(){var validate=0;isEmpty($("#formEditTemplate #templateName"))&&validate++,isEmpty($("#formEditTemplate #templateTypeClient"))&&validate++,$("#saveEditTemplate").prop("disabled",!0);var idAux,name=$("#formEditTemplate #templateName").val(),clientType=$("#formEditTemplate #templateTypeClient").val(),total=$("#formEditTemplate #templateTotal").val(),priceTmpl=$("#formEditTemplate #templatePrice").val(),prods=[],row="";$("#notes").val();if($("#datatable tbody tr.trProduct").each((function(){var validateAux1=validate;row=$(this),$(this).attr("style","background-color: none");var thisIndex=row.find("td.index").text(),check=0,texts=[];if($("#check"+thisIndex).prop("checked")){check=1;var groupTexts=$("#textsAmount"+thisIndex).find("input"),i=0;$.each(groupTexts,(function(index){texts.push([index,$(this).val(),$("#"+i+"discount"+thisIndex).val()]),i++}))}0==texts.length&&(texts=null);var productID=row.find("td.productID").text(),supplierID=row.find("td.supplierID").text(),modelID=row.find("td.modelID").text(),warehouse=row.find("td select.warehouse").val(),amount=row.find("input#amount"+thisIndex).val();""==amount&&(amount=1);var discount=row.find("input#0discount"+thisIndex).val();""==discount&&(discount=0);var total=row.find("td input.cost").val();""==total&&(total=0);row.find("td.contable").val(),row.find("td.texto").text();var ehID=row.find("td.ehID").text();""==productID&&validate++,1==check&&(""==modelID&&validate++,""==supplierID&&validate++),""==amount&&validate++,""==discount&&validate++,""!=warehouse&&null!=warehouse||(warehouse=0),prods.push([ehID,check,row.find("td.template").text(),productID,modelID,supplierID,amount,texts,discount,total,warehouse]),validateAux1!=validate&&($(this).attr("style","background-color: #f39c12!important"),idAux=$(this).attr("id"))})),0==validate){logs.filter((function(valor,indiceActual,arreglo){return indiceActual===arreglo.indexOf(valor)}));$.ajax({url:uri+"core/templates/update.php",method:"POST",data:{template:templateID,clientType:clientType,priceTmpl:priceTmpl,name:name,total:total,data:prods},success:function(data){$("#block-message").html('<div class="alert alert-success alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> La plantilla se ha actualizado con éxito.</div>'),$(".btn-gotop").click(),$("#saveEditTemplate").prop("disabled",!1),window.location.reload(),setTimeout((function(){$("#block-message").empty()}),5e3)},error:function(){$("#block-message").html('<div class="alert alert-error alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> Error mientras se procesaba su solicitud. Vuelva a intentarlo más tarde. Disculpe las molestias.</div>'),$("#saveEditTemplate").prop("disabled",!1),setTimeout((function(){$("#block-message").empty()}),5e3)}})}else $("#block-message").html('<div class="alert alert-warning alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> Faltan campos por cubrir o tienen un formato incorrecto</div>'),$("html, body").animate({scrollTop:$("#"+idAux).offset().top-150},70),setTimeout((function(){$("#block-message").empty()}),3500),$("#saveEditTemplate").attr("disabled",!1)})),$("#exportTemplate").click((function(){$("#saveEditTemplate").click(),$("#block-message").empty();var text,templateID=window.location.href.split("/")[window.location.href.split("/").length-1];$.ajax({url:uri+"core/libraries/pdfs/getPdfs.php",data:{templateID:templateID,doc:"templateHirings"},type:"POST",async:!1,success:function(data){text=data}}),$.ajax({url:uri+"core/libraries/pdfs/process.php",data:{doc:"templateHirings",text:text,radio:"",logo:1,expedientID:"",templateID:templateID,fileName:"plantilla_"+$("#templateName").val()},type:"POST",async:!1,success:function(data){$("#block-message").html('<div class="alert alert-success alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> El presupuesto ha sido creado con éxito.</div>'),setTimeout((function(){$("#block-message").empty()}),5e3)}}),window.open(uri+"descargar-archivo?file=templates/"+templateID+"/plantilla_"+$("#templateName").val()+".pdf","_blank")})),$("#datatable").stickyTableHeaders(),$("#datatable").stickyTableHeaders({fixedOffset:$(".main-header")}),$(window).trigger("resize.stickyTableHeaders"),$("#datatable tbody tr.info").click((function(){$(this).hasClass("closed")?($(this).find(".fa").removeClass("fa-eye").addClass("fa-eye-slash"),$(this).removeClass("closed"),$(this).nextUntil(".info").removeClass("hidden")):($(this).find(".fa").removeClass("fa-eye-slash").addClass("fa-eye"),$(this).addClass("closed"),$(this).nextUntil(".info").addClass("hidden"))}))}));