<?php
    require_once($_SESSION['basePath'] . "core/db/dbHandler.php");
    require_once($_SESSION['basePath'] . "core/tools/security.php");
    require_once($_SESSION['basePath'] . "core/tools/validations.php");

    /**
     * Almacena información de las plantillas para el módulo de estadísticas y obtiene la información una vez aplicados los filtros
     */
    class Statistics{

        /**
         * Obtiene las estadísticas de las confecciones
         * 
         * @param array $data Filtros
         * @return array Resultados
         */
        public function filterGasoil($data){
            $db = new DbHandler;

            $data['date'] = cleanStr($data['date']);
            $data['dateSince'] = cleanStr($data['dateSince']);
            $data['dateUntil'] = cleanStr($data['dateUntil']);

            $where = '';
            if($data['date'] == ''){
                if($data['dateSince'] != '' && $data['dateUntil'] != ''){
                    $where .= ' AND g.date BETWEEN "' . $data['dateSince'] . '" AND "' . $data['dateUntil'] . '"';
                }
            }else{
                $where .= ' AND g.date = "' . $data['date'] . '"';
            }

            if($data['supplier'] != ''){
                $where .= ' AND s.supplierID IN (';

                foreach($data['supplier'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                }
                $where = substr($where, 0, -1);

                $where .= ')';
            }

            $result = $db->query("  SELECT      g.date, g.litres, g.priceLitre, g.net, 
                                                it.name,
                                                g.total, (g.total - g.net) as totalIva 
                                    FROM        (Gasoil g)
                                    LEFT JOIN   Suppliers s ON g.supplier = s.supplierID
                                    LEFT JOIN   IVA_Types it ON g.ivaID = it.IVATypeID
                                    WHERE       g.leavingDate IS NULL $where
                                    ORDER BY    g.date ASC");

            return mysqli_num_rows($result) == 0 ? array() : $db->resultToArray($result);             
        }

        /**
         * Obtiene las estadísticas de las confecciones
         * 
         * @param array $data Filtros
         * @return array Resultados
         */
        public function filterGasoilByYear($data){
            $db = new DbHandler;

            $date = cleanStr($data['date']);

            $result = $db->query("  SELECT      MONTH(`start`) as mounth, COUNT(*) as total
                                    FROM        Events
                                    WHERE       cremation = 1 AND leavingDate IS NULL AND YEAR(`start`) = $date
                                    GROUP BY    MONTH(`start`)");

            $cremaciones = $db->resultToArray($result);

            $dateStart = $date . '-01-01';
            $dateStart = strtotime($dateStart);
            $dateEnd = $date . '-12-31';
            $dateEnd = strtotime($dateEnd);

            $result = $db->query("  SELECT      DATE_FORMAT(FROM_UNIXTIME(g.date), '%m') as mounth, SUM(litres) as litresTotal, SUM(total) as costTotal
                                    FROM        (Gasoil g)
                                    LEFT JOIN   Suppliers s ON g.supplier = s.supplierID
                                    LEFT JOIN   IVA_Types it ON g.ivaID = it.IVATypeID
                                    WHERE       g.leavingDate IS NULL AND g.date BETWEEN $dateStart AND  $dateEnd
                                    GROUP BY    DATE_FORMAT(FROM_UNIXTIME(g.date), '%M')
                                    ORDER BY    mounth");
          
            $gasoil = $db->resultToArray($result);

            return $result = ["cremaciones" => $cremaciones, "gasoil" => $gasoil]; 
        }

        /**
         * Obtiene las estadísticas de las confecciones
         * 
         * @param array $data Filtros
         * @return array Resultados
         */
        public function filterMaking($data){
            $db = new DbHandler;

            $data['requestDate'] = cleanStr($data['requestDate']);
            $data['requestDateSince'] = cleanStr($data['requestDateSince']);
            $data['requestDateUntil'] = cleanStr($data['requestDateUntil']);
            $data['birthdate'] = cleanStr($data['birthdate']);
            $data['birthdateSince'] = cleanStr($data['birthdateSince']);
            $data['birthdateUntil'] = cleanStr($data['birthdateUntil']);
            $data['deceasedDate'] = cleanStr($data['deceasedDate']);
            $data['deceasedDateSince'] = cleanStr($data['deceasedDateSince']);
            $data['deceasedDateUntil'] = cleanStr($data['deceasedDateUntil']);
            $data['tribunal'] = cleanStr($data['tribunal']);
            $data['deceasedRoom'] = cleanStr($data['deceasedRoom']);

            $where = '';
            if($data['requestDate'] == ''){
                if($data['requestDateSince'] != '' && $data['requestDateUntil'] != ''){
                    $where .= ' AND e.requestDate BETWEEN "' . $data['requestDateSince'] . '" AND "' . $data['requestDateUntil'] . '"';
                }
            }else{
                $where .= ' AND e.requestDate = "' . $data['requestDate'] . '"';
            }

            if($data['clientType'] != ''){
                $where .= ' AND e.clientType IN (';

                foreach($data['clientType'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                }
                $where = substr($where, 0, -1);

                $where .= ')';

                if($data['client'] != ''){
                    $where .= ' AND c.clientID IN (';

                    foreach($data['client'] as $elem){
                        $elem = cleanStr($elem);
                        $where .= $elem . ',';
                    }
                    $where = substr($where, 0, -1);

                    $where .= ')';
                }
            }

            if($data['birthdate'] == ''){
                if($data['birthdateSince'] != '' && $data['birthdateUntil'] != ''){
                    $where .= ' AND e.deceasedBirthday BETWEEN "' . $data['birthdateSince'] . '" AND "' . $data['birthdateUntil'] . '"';
                }
            }else{
                $where .= ' AND e.deceasedBirthday = "' . $data['birthdate'] . '"';
            }

            if($data['deceasedDate'] == ''){
                if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                    $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                }
            }else{
                $where .= ' AND e.deceasedDate = "' . $data['deceasedDate'] . '"';
            }

            if($data['expedientTypes'] != ''){
                $where .= ' AND e.type IN (';

                foreach($data['expedientTypes'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                }
                $where = substr($where, 0, -1);

                $where .= ')';
            }

            if($data['deceasedIn'] != ''){
                $where .= ' AND e.deceasedLocation IN (';

                foreach($data['deceasedIn'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                }
                $where = substr($where, 0, -1);

                $where .= ')';
            }

            if($data['doctor'] != ''){
                $where .= ' AND d.ID IN (';

                foreach($data['doctor'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                }
                $where = substr($where, 0, -1);

                $where .= ')';
            }

            if($data['tribunal'] != ''){
                $where .= ' AND e.deceasedTribunal = "' . $data['tribunal'] . '"';
            }

            if($data['mortuary'] != ''){
                $where .= ' AND m.mortuaryID IN (';

                foreach($data['mortuary'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                }
                $where = substr($where, 0, -1);

                $where .= ')';
            }

            if($data['deceasedRoom'] != ''){
                $where .= ' AND e.deceasedRoom = "' . $data['deceasedRoom'] . '"';
            }

            $result = $db->query("  SELECT      DISTINCT e.expedientID, e.number, e.requestDate, e.deceasedBirthday, e.deceasedDate, e.deceasedTime, e.deceasedTribunal, e.deceasedRoom,
                                                c.name as clientName, c.surname as clientSurname,
                                                di.name as deceasedInName,
                                                d.name as doctorName,
                                                m.name as mortuaryName
                                    FROM        (Expedients e)
                                    LEFT JOIN   Clients c ON e.client = c.clientID
                                    LEFT JOIN   DeceasedIn di ON e.deceasedLocation = di.deceasedInID
                                    LEFT JOIN   Doctors d ON e.deceasedDoctor = d.ID
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    WHERE       e.leavingDate IS NULL $where
                                    ORDER BY    e.requestDate DESC");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $expedients = $db->resultToArray($result);


                foreach($expedients as $index => $elem){

                    $result = $db->query("  SELECT      SUM(eh.amount * pr.purchasePrice) as purchasePrice,
                                                        (
                                                            SELECT      COALESCE(SUM(iniv.base), 0) AS base
                                                            FROM        Invoices i
                                                            JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                            WHERE       i.leavingDate IS NULL AND
                                                                        i.invoice_type != 3 AND
                                                                        (
                                                                            (
                                                                                i.ID = (
                                                                                    SELECT  MAX(i2.ID)
                                                                                    FROM    Invoices i2
                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                            i2.invoice_type != 3 AND
                                                                                            i2.expedient = i.expedient AND 
                                                                                            (
                                                                                                i2.rectified_type IS NULL OR 
                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                            )
                                                                                )
                                                                            ) OR
                                                                            (
                                                                                i.rectified_type = 2
                                                                            )
                                                                        ) AND
                                                                        i.expedient = e.expedientID
                                                        ) AS base
                                            FROM        Expedients e, Expedients_Hirings eh, Products_Retails pr
                                            WHERE       e.expedientID = " . $elem['expedientID'] . " AND
                                                        e.expedientID = eh.expedient AND
                                                        eh.num_hiring = (
                                                            SELECT  MAX(i2.num_hiring) 
                                                            FROM    Invoices i2 
                                                            WHERE   i2.expedient = e.expedientID AND
                                                                    i2.leavingDate IS NULL AND
                                                                    i2.invoice_type != 3
                                                        ) AND
                                                        eh.check = 1 AND
                                                        eh.model = pr.model AND
                                                        pr.year = YEAR(e.requestDate) 
                    ");

                    $expedients[$index]['purchasePrice'] = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['purchasePrice'];
                    $expedients[$index]['base'] = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['base'];
                }

                return $expedients;
            }
        }

        /**
         * Obtiene las estadísticas del destino final de los difuntos
         * 
         * @param array $data Filtros
         * @return array Resultados
         */
        public function filterDeceasedDestination($data){
            $db = new DbHandler;

            $data['deceasedDateSince'] = cleanStr($data['deceasedDateSince']);
            $data['deceasedDateUntil'] = cleanStr($data['deceasedDateUntil']);
            $data['gender'] = cleanStr($data['gender']);

            $where = '';

            if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                $where .= " AND e.deceasedDate BETWEEN '{$data['deceasedDateSince']}' AND '{$data['deceasedDateUntil']}'";
            }

            if($data['deceasedIn'] != ''){
                $where .= " AND (";
                foreach($data['deceasedIn'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= "e.deceasedLocation = $elem OR ";
                }
                $where = substr($where, 0, -4) . ")";
            }

            if($data['mortuary'] != ''){
                $where .= " AND (";
                foreach($data['mortuary'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= "e.deceasedMortuary = $elem OR ";
                }
                $where = substr($where, 0, -4) . ")";
            }

            if($data['church'] != ''){
                $where .= " AND (";
                foreach($data['church'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= "e.church = $elem OR ";
                }
                $where = substr($where, 0, -4) . ")";
            }

            if($data['cemetery'] != ''){
                $where .= " AND (";
                foreach($data['cemetery'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= "e.cemetery = $elem OR ";
                }
                $where = substr($where, 0, -4) . ")";
            }

            if($data['crematorium'] != ''){
                $where .= " AND (";
                foreach($data['crematorium'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= "e.crematorium = $elem OR ";
                }
                $where = substr($where, 0, -4) . ")";
            }

            if($data['clientType'] != ''){
                $where .= " AND (";
                foreach($data['clientType'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= "e.clientType = $elem OR ";
                }
                $where = substr($where, 0, -4) . ")";
            }

            if($data['client'] != ''){
                $where .= " AND (";
                foreach($data['client'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= "e.client = $elem OR ";
                }
                $where = substr($where, 0, -4) . ")";
            }

            if($data['gender'] != ''){
                switch($data['gender']){
                    case 'Hombre':
                        $where .= " AND e.deceasedGender = 'Hombre'";
                    break;
                    case 'Mujer':
                        $where .= " AND e.deceasedGender = 'Mujer'";
                    break;
                }
            }

            if($data['location'] != ''){
                $where .= " AND (";
                foreach($data['location'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= "(l1.locationID = {$elem} OR l2.locationID = {$elem} OR l3.locationID = {$elem}) OR ";
                }
                $where = substr($where, 0, -4) . ")";
            }

            $result = $db->query("  SELECT      e.client, cl.name as clientName,
                                                e.deceasedLocation, di.name as deceasedInName,
                                                e.deceasedMortuary, mo.name as mortuaryName,
                                                e.churchLabel, e.church, e.cemeteryLabel, e.cemetery, e.crematorium,
                                                e.deceasedBirthday, e.deceasedDate, e.deceasedGender,
                                                (
                                                    SELECT      COALESCE(SUM(iniv.base), 0)
                                                    FROM        Invoices i
                                                    JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                    WHERE       i.leavingDate IS NULL AND
                                                                i.invoice_type != 3 AND
                                                                (
                                                                    (
                                                                        i.ID = (
                                                                            SELECT  MAX(i2.ID)
                                                                            FROM    Invoices i2
                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                    i2.invoice_type != 3 AND
                                                                                    i2.expedient = i.expedient AND 
                                                                                    (
                                                                                        i2.rectified_type IS NULL OR 
                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                    )
                                                                        )
                                                                    ) OR
                                                                    (
                                                                        i.rectified_type = 2
                                                                    )
                                                                ) AND
                                                                i.expedient = e.expedientID
                                                ) AS base,
                                                (
                                                    SELECT      COALESCE(SUM(i.supplieds), 0)
                                                    FROM        Invoices i
                                                    WHERE       i.leavingDate IS NULL AND
                                                                i.invoice_type != 3 AND
                                                                (
                                                                    (
                                                                        i.ID = (
                                                                            SELECT  MAX(i2.ID)
                                                                            FROM    Invoices i2
                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                    i2.invoice_type != 3 AND
                                                                                    i2.expedient = i.expedient AND 
                                                                                    (
                                                                                        i2.rectified_type IS NULL OR 
                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                    )
                                                                        )
                                                                    ) OR
                                                                    (
                                                                        i.rectified_type = 2
                                                                    )
                                                                ) AND
                                                                i.expedient = e.expedientID
                                                ) AS supplieds,
                                                e.expedientID
                                    FROM        (Expedients e)
                                    LEFT JOIN   DeceasedIn di ON e.deceasedLocation = di.deceasedInID
                                    LEFT JOIN   Mortuaries mo ON e.deceasedMortuary = mo.mortuaryID
                                    LEFT JOIN   Churches ch ON e.church = ch.churchID
                                    LEFT JOIN   Cemeteries ce ON e.cemetery = ce.cemeteryID
                                    LEFT JOIN   Crematoriums cr ON e.crematorium = cr.crematoriumID
                                    LEFT JOIN   Clients_Types ct ON e.clientType = ct.clientTypeID
                                    LEFT JOIN   Clients cl ON e.client = cl.clientID
                                    LEFT JOIN   Locations l1 ON ch.location = l1.locationID
                                    LEFT JOIN   Locations l2 ON ce.location = l2.locationID
                                    LEFT JOIN   Locations l3 ON cr.location = l3.locationID
                                    WHERE       e.leavingDate IS NULL AND
                                                e.client IS NOT NULL AND
                                                e.type = 1 AND
                                                e.deceasedLocation IS NOT NULL AND
                                                e.deceasedMortuary IS NOT NULL
                                                $where
                                    ORDER BY    e.client, e.deceasedLocation, e.deceasedMortuary");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }

        /* **************** ASISTENCIAS **************** */
        /**
         * Crea una plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function assistancesCreate($data){
            $db = new DbHandler;

            $data['name'] = cleanStr($data['name']);
            $data['attendanceDate'] = cleanStr($data['attendanceDate']);
            $data['attendanceDateSince'] = cleanStr($data['attendanceDateSince']);
            $data['attendanceDateUntil'] = cleanStr($data['attendanceDateUntil']);
            $data['deceasedDate'] = cleanStr($data['deceasedDate']);
            $data['deceasedDateSince'] = cleanStr($data['deceasedDateSince']);
            $data['deceasedDateUntil'] = cleanStr($data['deceasedDateUntil']);
            $data['literalsPickDate'] = cleanStr($data['literalsPickDate']);
            $data['literalsPickDateSince'] = cleanStr($data['literalsPickDateSince']);
            $data['literalsPickDateUntil'] = cleanStr($data['literalsPickDateUntil']);
            $data['invoiceDeliveredDate'] = cleanStr($data['invoiceDeliveredDate']);
            $data['invoiceDeliveredDateSince'] = cleanStr($data['invoiceDeliveredDateSince']);
            $data['invoiceDeliveredDateUntil'] = cleanStr($data['invoiceDeliveredDateUntil']);
            $data['ssDate'] = cleanStr($data['ssDate']);
            $data['ssDateSince'] = cleanStr($data['ssDateSince']);
            $data['ssDateUntil'] = cleanStr($data['ssDateUntil']);
            $data['inssDate'] = cleanStr($data['inssDate']);
            $data['inssDateSince'] = cleanStr($data['inssDateSince']);
            $data['inssDateUntil'] = cleanStr($data['inssDateUntil']);
            $data['ismDate'] = cleanStr($data['ismDate']);
            $data['ismDateSince'] = cleanStr($data['ismDateSince']);
            $data['ismDateUntil'] = cleanStr($data['ismDateUntil']);
            $data['socialDate'] = cleanStr($data['socialDate']);
            $data['socialDateSince'] = cleanStr($data['socialDateSince']);
            $data['socialDateUntil'] = cleanStr($data['socialDateUntil']);
            $data['passiveDate'] = cleanStr($data['passiveDate']);
            $data['passiveDateSince'] = cleanStr($data['passiveDateSince']);
            $data['passiveDateUntil'] = cleanStr($data['passiveDateUntil']);
            $data['isfasDate'] = cleanStr($data['isfasDate']);
            $data['isfasDateSince'] = cleanStr($data['isfasDateSince']);
            $data['isfasDateUntil'] = cleanStr($data['isfasDateUntil']);
            $data['dniDateG'] = cleanStr($data['dniDateG']);
            $data['dniDateGSince'] = cleanStr($data['dniDateGSince']);
            $data['dniDateGUntil'] = cleanStr($data['dniDateGUntil']);
            $data['familyBookDateG'] = cleanStr($data['familyBookDateG']);
            $data['familyBookDateGSince'] = cleanStr($data['familyBookDateGSince']);
            $data['familyBookDateGUntil'] = cleanStr($data['familyBookDateGUntil']);
            $data['literalMarriageDateG'] = cleanStr($data['literalMarriageDateG']);
            $data['literalMarriageDateGSince'] = cleanStr($data['literalMarriageDateGSince']);
            $data['literalMarriageDateGUntil'] = cleanStr($data['literalMarriageDateGUntil']);
            $data['literalBirthdayDateG'] = cleanStr($data['literalBirthdayDateG']);
            $data['literalBirthdayDateGSince'] = cleanStr($data['literalBirthdayDateGSince']);
            $data['literalBirthdayDateGUntil'] = cleanStr($data['literalBirthdayDateGUntil']);
            $data['registrationDateG'] = cleanStr($data['registrationDateG']);
            $data['registrationDateGSince'] = cleanStr($data['registrationDateGSince']);
            $data['registrationDateGUntil'] = cleanStr($data['registrationDateGUntil']);
            $data['dniDateR'] = cleanStr($data['dniDateR']);
            $data['dniDateRSince'] = cleanStr($data['dniDateRSince']);
            $data['dniDateRUntil'] = cleanStr($data['dniDateRUntil']);
            $data['familyBookDateR'] = cleanStr($data['familyBookDateR']);
            $data['familyBookDateRSince'] = cleanStr($data['familyBookDateRSince']);
            $data['familyBookDateRUntil'] = cleanStr($data['familyBookDateRUntil']);
            $data['literalMarriageDateR'] = cleanStr($data['literalMarriageDateR']);
            $data['literalMarriageDateRSince'] = cleanStr($data['literalMarriageDateRSince']);
            $data['literalMarriageDateRUntil'] = cleanStr($data['literalMarriageDateRUntil']);
            $data['literalBirthdayDateR'] = cleanStr($data['literalBirthdayDateR']);
            $data['literalBirthdayDateRSince'] = cleanStr($data['literalBirthdayDateRSince']);
            $data['literalBirthdayDateRUntil'] = cleanStr($data['literalBirthdayDateRUntil']);
            $data['registrationDateR'] = cleanStr($data['registrationDateR']);
            $data['registrationDateRSince'] = cleanStr($data['registrationDateRSince']);
            $data['registrationDateRUntil'] = cleanStr($data['registrationDateRUntil']);
            $data['lastWishDate'] = cleanStr($data['lastWishDate']);
            $data['lastWishDateSince'] = cleanStr($data['lastWishDateSince']);
            $data['lastWishDateUntil'] = cleanStr($data['lastWishDateUntil']);

            if(!isset($data['assistancePlace'])){
                $data['assistancePlace'] = 'null';
            }else{
                $data['assistancePlace'] = cleanStr($data['assistancePlace']);
            }
            if(!isset($data['location'])){
                $data['location'] = 'null';
            }else{
                $data['location'] = cleanStr($data['location']);
            }
            if($data['attendanceDate'] == ''){
                $data['attendanceDate'] = 'null';
            }
            if($data['attendanceDateSince'] == ''){
                $data['attendanceDateSince'] = 'null';
            }
            if($data['attendanceDateUntil'] == ''){
                $data['attendanceDateUntil'] = 'null';
            }
            if($data['deceasedDate'] == ''){
                $data['deceasedDate'] = 'null';
            }
            if($data['deceasedDateSince'] == ''){
                $data['deceasedDateSince'] = 'null';
            }
            if($data['deceasedDateUntil'] == ''){
                $data['deceasedDateUntil'] = 'null';
            }
            if($data['literalsPickDate'] == ''){
                $data['literalsPickDate'] = 'null';
            }
            if($data['literalsPickDateSince'] == ''){
                $data['literalsPickDateSince'] = 'null';
            }
            if($data['literalsPickDateUntil'] == ''){
                $data['literalsPickDateUntil'] = 'null';
            }
            if($data['invoiceDeliveredDate'] == ''){
                $data['invoiceDeliveredDate'] = 'null';
            }
            if($data['invoiceDeliveredDateSince'] == ''){
                $data['invoiceDeliveredDateSince'] = 'null';
            }
            if($data['invoiceDeliveredDateUntil'] == ''){
                $data['invoiceDeliveredDateUntil'] = 'null';
            }
            if($data['ssDate'] == ''){
                $data['ssDate'] = 'null';
            }
            if($data['ssDateSince'] == ''){
                $data['ssDateSince'] = 'null';
            }
            if($data['ssDateUntil'] == ''){
                $data['ssDateUntil'] = 'null';
            }
            if($data['inssDate'] == ''){
                $data['inssDate'] = 'null';
            }
            if($data['inssDateSince'] == ''){
                $data['inssDateSince'] = 'null';
            }
            if($data['inssDateUntil'] == ''){
                $data['inssDateUntil'] = 'null';
            }
            if($data['ismDate'] == ''){
                $data['ismDate'] = 'null';
            }
            if($data['ismDateSince'] == ''){
                $data['ismDateSince'] = 'null';
            }
            if($data['ismDateUntil'] == ''){
                $data['ismDateUntil'] = 'null';
            }
            if($data['socialDate'] == ''){
                $data['socialDate'] = 'null';
            }
            if($data['socialDateSince'] == ''){
                $data['socialDateSince'] = 'null';
            }
            if($data['socialDateUntil'] == ''){
                $data['socialDateUntil'] = 'null';
            }
            if($data['passiveDate'] == ''){
                $data['passiveDate'] = 'null';
            }
            if($data['passiveDateSince'] == ''){
                $data['passiveDateSince'] = 'null';
            }
            if($data['passiveDateUntil'] == ''){
                $data['passiveDateUntil'] = 'null';
            }
            if($data['isfasDate'] == ''){
                $data['isfasDate'] = 'null';
            }
            if($data['isfasDateSince'] == ''){
                $data['isfasDateSince'] = 'null';
            }
            if($data['isfasDateUntil'] == ''){
                $data['isfasDateUntil'] = 'null';
            }
            if($data['dniDateG'] == ''){
                $data['dniDateG'] = 'null';
            }
            if($data['dniDateGSince'] == ''){
                $data['dniDateGSince'] = 'null';
            }
            if($data['dniDateGUntil'] == ''){
                $data['dniDateGUntil'] = 'null';
            }
            if($data['familyBookDateG'] == ''){
                $data['familyBookDateG'] = 'null';
            }
            if($data['familyBookDateGSince'] == ''){
                $data['familyBookDateGSince'] = 'null';
            }
            if($data['familyBookDateGUntil'] == ''){
                $data['familyBookDateGUntil'] = 'null';
            }
            if($data['literalMarriageDateG'] == ''){
                $data['literalMarriageDateG'] = 'null';
            }
            if($data['literalMarriageDateGSince'] == ''){
                $data['literalMarriageDateGSince'] = 'null';
            }
            if($data['literalMarriageDateGUntil'] == ''){
                $data['literalMarriageDateGUntil'] = 'null';
            }
            if($data['literalBirthdayDateG'] == ''){
                $data['literalBirthdayDateG'] = 'null';
            }
            if($data['literalBirthdayDateGSince'] == ''){
                $data['literalBirthdayDateGSince'] = 'null';
            }
            if($data['literalBirthdayDateGUntil'] == ''){
                $data['literalBirthdayDateGUntil'] = 'null';
            }
            if($data['registrationDateG'] == ''){
                $data['registrationDateG'] = 'null';
            }
            if($data['registrationDateGSince'] == ''){
                $data['registrationDateGSince'] = 'null';
            }
            if($data['registrationDateGUntil'] == ''){
                $data['registrationDateGUntil'] = 'null';
            }
            if($data['dniDateR'] == ''){
                $data['dniDateR'] = 'null';
            }
            if($data['dniDateRSince'] == ''){
                $data['dniDateRSince'] = 'null';
            }
            if($data['dniDateRUntil'] == ''){
                $data['dniDateRUntil'] = 'null';
            }
            if($data['familyBookDateR'] == ''){
                $data['familyBookDateR'] = 'null';
            }
            if($data['familyBookDateRSince'] == ''){
                $data['familyBookDateRSince'] = 'null';
            }
            if($data['familyBookDateRUntil'] == ''){
                $data['familyBookDateRUntil'] = 'null';
            }
            if($data['literalMarriageDateR'] == ''){
                $data['literalMarriageDateR'] = 'null';
            }
            if($data['literalMarriageDateRSince'] == ''){
                $data['literalMarriageDateRSince'] = 'null';
            }
            if($data['literalMarriageDateRUntil'] == ''){
                $data['literalMarriageDateRUntil'] = 'null';
            }
            if($data['literalBirthdayDateR'] == ''){
                $data['literalBirthdayDateR'] = 'null';
            }
            if($data['literalBirthdayDateRSince'] == ''){
                $data['literalBirthdayDateRSince'] = 'null';
            }
            if($data['literalBirthdayDateRUntil'] == ''){
                $data['literalBirthdayDateRUntil'] = 'null';
            }
            if($data['registrationDateR'] == ''){
                $data['registrationDateR'] = 'null';
            }
            if($data['registrationDateRSince'] == ''){
                $data['registrationDateRSince'] = 'null';
            }
            if($data['registrationDateRUntil'] == ''){
                $data['registrationDateRUntil'] = 'null';
            }
            if($data['lastWishDate'] == ''){
                $data['lastWishDate'] = 'null';
            }
            if($data['lastWishDateSince'] == ''){
                $data['lastWishDateSince'] = 'null';
            }
            if($data['lastWishDateUntil'] == ''){
                $data['lastWishDateUntil'] = 'null';
            }

            return $db->query(" INSERT INTO Statistics_Assistances( name, attendanceDateCheck, attendanceDate, attendanceDateCheckPeriod,
                                                                    attendanceDateSince, attendanceDateUntil, widowCheck, widow,
                                                                    assistancePlaceCheck, assistancePlace, locationPlaceCheck, locationPlace,
                                                                    deceasedDateCheck, deceasedDate, deceasedDateCheckPeriod,
                                                                    deceasedDateSince, deceasedDateUntil, literalsPickDateCheck,
                                                                    literalsPickDate, literalsPickDateCheckPeriod, literalsPickDateSince,
                                                                    literalsPickDateUntil, invoiceDeliveredDateCheck, invoiceDeliveredDate,
                                                                    invoiceDeliveredDateCheckPeriod, invoiceDeliveredDateSince,
                                                                    invoiceDeliveredDateUntil, ssDateCheck, ssDate, ssDateCheckPeriod,
                                                                    ssDateSince, ssDateUntil, pensionCheck, pension, inssDateCheck,
                                                                    inssDate, inssDateCheckPeriod, inssDateSince, inssDateUntil,
                                                                    ismDateCheck, ismDate, ismDateCheckPeriod, ismDateSince, ismDateUntil,
                                                                    socialDateCheck, socialDate, socialDateCheckPeriod, socialDateSince,
                                                                    socialDateUntil, passiveDateCheck, passiveDate, passiveDateCheckPeriod,
                                                                    passiveDateSince, passiveDateUntil, isfasDateCheck, isfasDate,
                                                                    isfasDateCheckPeriod, isfasDateSince, isfasDateUntil, dniDateGCheck,
                                                                    dniDateG, dniDateGCheckPeriod, dniDateGSince, dniDateGUntil,
                                                                    familyBookDateGCheck, familyBookDateG, familyBookDateGCheckPeriod,
                                                                    familyBookDateGSince, familyBookDateGUntil, literalMarriageDateGCheck,
                                                                    literalMarriageDateG, literalMarriageDateGCheckPeriod, literalMarriageDateGSince,
                                                                    literalMarriageDateGUntil, literalBirthdayDateGCheck, literalBirthdayDateG,
                                                                    literalBirthdayDateGCheckPeriod, literalBirthdayDateGSince, literalBirthdayDateGUntil,
                                                                    registrationDateGCheck, registrationDateG, registrationDateGCheckPeriod,
                                                                    registrationDateGSince, registrationDateGUntil, dniDateRCheck, dniDateR,
                                                                    dniDateRCheckPeriod, dniDateRSince, dniDateRUntil, familyBookDateRCheck,
                                                                    familyBookDateR, familyBookDateRCheckPeriod, familyBookDateRSince,
                                                                    familyBookDateRUntil, literalMarriageDateRCheck, literalMarriageDateR,
                                                                    literalMarriageDateRCheckPeriod, literalMarriageDateRSince,
                                                                    literalMarriageDateRUntil, literalBirthdayDateRCheck, literalBirthdayDateR,
                                                                    literalBirthdayDateRCheckPeriod, literalBirthdayDateRSince,
                                                                    literalBirthdayDateRUntil, registrationDateRCheck, registrationDateR,
                                                                    registrationDateRCheckPeriod, registrationDateRSince, registrationDateRUntil,
                                                                    lastWishDateCheck, lastWishDate, lastWishDateCheckPeriod, lastWishDateSince,
                                                                    lastWishDateUntil)
                                VALUES ('" . $data['name'] . "', 
                                        " . $data['attendanceDateCheck'] . ", " . $data['attendanceDate'] . ", 
                                        " . $data['attendanceDateCheckPeriod'] . ", " . $data['attendanceDateSince'] . ", 
                                        " . $data['attendanceDateUntil'] . ", " . $data['widowCheck'] . ", 
                                        " . $data['widow'] . ", " . $data['assistancePlaceCheck'] . ", 
                                        " . $data['assistancePlace'] . ", " . $data['locationCheck'] . ", 
                                        " . $data['location'] . ", " . $data['deceasedDateCheck'] . ", 
                                        " . $data['deceasedDate'] . ", " . $data['deceasedDateCheckPeriod'] . ", 
                                        " . $data['deceasedDateSince'] . ", " . $data['deceasedDateUntil'] . ", 
                                        " . $data['literalsPickDateCheck'] . ", " . $data['literalsPickDate'] . ", 
                                        " . $data['literalsPickDateCheckPeriod'] . ", " . $data['literalsPickDateSince'] . ", 
                                        " . $data['literalsPickDateUntil'] . ", " . $data['invoiceDeliveredDateCheck'] . ", 
                                        " . $data['invoiceDeliveredDate'] . ", " . $data['invoiceDeliveredDateCheckPeriod'] . ", 
                                        " . $data['invoiceDeliveredDateSince'] . ", " . $data['invoiceDeliveredDateUntil'] . ", 
                                        " . $data['ssDateCheck'] . ", " . $data['ssDate'] . ", 
                                        " . $data['ssDateCheckPeriod'] . ", " . $data['ssDateSince'] . ", 
                                        " . $data['ssDateUntil'] . ", " . $data['pensionCheck'] . ", 
                                        " . $data['pension'] . ", " . $data['inssDateCheck'] . ", 
                                        " . $data['inssDate'] . ", " . $data['inssDateCheckPeriod'] . ", 
                                        " . $data['inssDateSince'] . ", " . $data['inssDateUntil'] . ", 
                                        " . $data['ismDateCheck'] . ", " . $data['ismDate'] . ", 
                                        " . $data['ismDateCheckPeriod'] . ", " . $data['ismDateSince'] . ", 
                                        " . $data['ismDateUntil'] . ", " . $data['socialDateCheck'] . ", 
                                        " . $data['socialDate'] . ", " . $data['socialDateCheckPeriod'] . ", 
                                        " . $data['socialDateSince'] . ", " . $data['socialDateUntil'] . ", 
                                        " . $data['passiveDateCheck'] . ", " . $data['passiveDate'] . ", 
                                        " . $data['passiveDateCheckPeriod'] . ", " . $data['passiveDateSince'] . ", 
                                        " . $data['passiveDateUntil'] . ", " . $data['isfasDateCheck'] . ", 
                                        " . $data['isfasDate'] . ", " . $data['isfasDateCheckPeriod'] . ", 
                                        " . $data['isfasDateSince'] . ", " . $data['isfasDateUntil'] . ", 
                                        " . $data['dniDateGCheck'] . ", " . $data['dniDateG'] . ", 
                                        " . $data['dniDateGCheckPeriod'] . ", " . $data['dniDateGSince'] . ", 
                                        " . $data['dniDateGUntil'] . ", " . $data['familyBookDateGCheck'] . ", 
                                        " . $data['familyBookDateG'] . ", " . $data['familyBookDateGCheckPeriod'] . ", 
                                        " . $data['familyBookDateGSince'] . ", " . $data['familyBookDateGUntil'] . ", 
                                        " . $data['literalMarriageDateGCheck'] . ", " . $data['literalMarriageDateG'] . ", 
                                        " . $data['literalMarriageDateGCheckPeriod'] . ", " . $data['literalMarriageDateGSince'] . ", 
                                        " . $data['literalMarriageDateGUntil'] . ", " . $data['literalBirthdayDateGCheck'] . ",
                                        " . $data['literalBirthdayDateG'] . ", " . $data['literalBirthdayDateGCheckPeriod'] . ",
                                        " . $data['literalBirthdayDateGSince'] . ", " . $data['literalBirthdayDateGUntil'] . ",
                                        " . $data['registrationDateGCheck'] . ", " . $data['registrationDateG'] . ",
                                        " . $data['registrationDateGCheckPeriod'] . ", " . $data['registrationDateGSince'] . ",
                                        " . $data['registrationDateGUntil'] . ", " . $data['dniDateRCheck'] . ",
                                        " . $data['dniDateR'] . ", " . $data['dniDateRCheckPeriod'] . ",
                                        " . $data['dniDateRSince'] . ", " . $data['dniDateRUntil'] . ",
                                        " . $data['familyBookDateRCheck'] . ", " . $data['familyBookDateR'] . ",
                                        " . $data['familyBookDateRCheckPeriod'] . ", " . $data['familyBookDateRSince'] . ",
                                        " . $data['familyBookDateRUntil'] . ", " . $data['literalMarriageDateRCheck'] . ",
                                        " . $data['literalMarriageDateR'] . ", " . $data['literalMarriageDateRCheckPeriod'] . ",
                                        " . $data['literalMarriageDateRSince'] . ", " . $data['literalMarriageDateRUntil'] . ",
                                        " . $data['literalBirthdayDateRCheck'] . ", " . $data['literalBirthdayDateR'] . ",
                                        " . $data['literalBirthdayDateRCheckPeriod'] . ", " . $data['literalBirthdayDateRSince'] . ",
                                        " . $data['literalBirthdayDateRUntil'] . ", " . $data['registrationDateRCheck'] . ",
                                        " . $data['registrationDateR'] . ", " . $data['registrationDateRCheckPeriod'] . ",
                                        " . $data['registrationDateRSince'] . ", " . $data['registrationDateRUntil'] . ",
                                        " . $data['lastWishDateCheck'] . ", " . $data['lastWishDate'] . ",
                                        " . $data['lastWishDateCheckPeriod'] . ", " . $data['lastWishDateSince'] . ",
                                        " . $data['lastWishDateUntil'] . ")");
        }

        /**
         * Obtiene los datos de la plantilla
         * 
         * @param data $data ID de la plantilla
         * @return array Información de la plantilla
         */
        public function assistancesRead($data){
            $db = new DbHandler;

            $data['ID'] = cleanStr($data['ID']);

            $result = $db->query("  SELECT      sa.*,
                                                l.name as locationName, l.postalCode as locationPostalCode, l.province as locationProvince,
                                                m.name as assistancePlaceName
                                    FROM        (Statistics_Assistances sa)
                                    LEFT JOIN   Mortuaries m ON sa.assistancePlace = m.mortuaryID
                                    LEFT JOIN   Locations l ON sa.locationPlace = l.locationID
                                    WHERE       sa.ID = " . $data['ID']);

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0];
        }

        /**
         * Modifica los datos de la plantilla
         * 
         * @param array $data Información de la plantilla
         * @return bool
         */
        public function assistancesUpdate($data){
            $db = new DbHandler;
            
            $data['attendanceDate'] = cleanStr($data['attendanceDate']);
            $data['attendanceDateSince'] = cleanStr($data['attendanceDateSince']);
            $data['attendanceDateUntil'] = cleanStr($data['attendanceDateUntil']);
            $data['deceasedDate'] = cleanStr($data['deceasedDate']);
            $data['deceasedDateSince'] = cleanStr($data['deceasedDateSince']);
            $data['deceasedDateUntil'] = cleanStr($data['deceasedDateUntil']);
            $data['literalsPickDate'] = cleanStr($data['literalsPickDate']);
            $data['literalsPickDateSince'] = cleanStr($data['literalsPickDateSince']);
            $data['literalsPickDateUntil'] = cleanStr($data['literalsPickDateUntil']);
            $data['invoiceDeliveredDate'] = cleanStr($data['invoiceDeliveredDate']);
            $data['invoiceDeliveredDateSince'] = cleanStr($data['invoiceDeliveredDateSince']);
            $data['invoiceDeliveredDateUntil'] = cleanStr($data['invoiceDeliveredDateUntil']);
            $data['ssDate'] = cleanStr($data['ssDate']);
            $data['ssDateSince'] = cleanStr($data['ssDateSince']);
            $data['ssDateUntil'] = cleanStr($data['ssDateUntil']);
            $data['inssDate'] = cleanStr($data['inssDate']);
            $data['inssDateSince'] = cleanStr($data['inssDateSince']);
            $data['inssDateUntil'] = cleanStr($data['inssDateUntil']);
            $data['ismDate'] = cleanStr($data['ismDate']);
            $data['ismDateSince'] = cleanStr($data['ismDateSince']);
            $data['ismDateUntil'] = cleanStr($data['ismDateUntil']);
            $data['socialDate'] = cleanStr($data['socialDate']);
            $data['socialDateSince'] = cleanStr($data['socialDateSince']);
            $data['socialDateUntil'] = cleanStr($data['socialDateUntil']);
            $data['passiveDate'] = cleanStr($data['passiveDate']);
            $data['passiveDateSince'] = cleanStr($data['passiveDateSince']);
            $data['passiveDateUntil'] = cleanStr($data['passiveDateUntil']);
            $data['isfasDate'] = cleanStr($data['isfasDate']);
            $data['isfasDateSince'] = cleanStr($data['isfasDateSince']);
            $data['isfasDateUntil'] = cleanStr($data['isfasDateUntil']);
            $data['dniDateG'] = cleanStr($data['dniDateG']);
            $data['dniDateGSince'] = cleanStr($data['dniDateGSince']);
            $data['dniDateGUntil'] = cleanStr($data['dniDateGUntil']);
            $data['familyBookDateG'] = cleanStr($data['familyBookDateG']);
            $data['familyBookDateGSince'] = cleanStr($data['familyBookDateGSince']);
            $data['familyBookDateGUntil'] = cleanStr($data['familyBookDateGUntil']);
            $data['literalMarriageDateG'] = cleanStr($data['literalMarriageDateG']);
            $data['literalMarriageDateGSince'] = cleanStr($data['literalMarriageDateGSince']);
            $data['literalMarriageDateGUntil'] = cleanStr($data['literalMarriageDateGUntil']);
            $data['literalBirthdayDateG'] = cleanStr($data['literalBirthdayDateG']);
            $data['literalBirthdayDateGSince'] = cleanStr($data['literalBirthdayDateGSince']);
            $data['literalBirthdayDateGUntil'] = cleanStr($data['literalBirthdayDateGUntil']);
            $data['registrationDateG'] = cleanStr($data['registrationDateG']);
            $data['registrationDateGSince'] = cleanStr($data['registrationDateGSince']);
            $data['registrationDateGUntil'] = cleanStr($data['registrationDateGUntil']);
            $data['dniDateR'] = cleanStr($data['dniDateR']);
            $data['dniDateRSince'] = cleanStr($data['dniDateRSince']);
            $data['dniDateRUntil'] = cleanStr($data['dniDateRUntil']);
            $data['familyBookDateR'] = cleanStr($data['familyBookDateR']);
            $data['familyBookDateRSince'] = cleanStr($data['familyBookDateRSince']);
            $data['familyBookDateRUntil'] = cleanStr($data['familyBookDateRUntil']);
            $data['literalMarriageDateR'] = cleanStr($data['literalMarriageDateR']);
            $data['literalMarriageDateRSince'] = cleanStr($data['literalMarriageDateRSince']);
            $data['literalMarriageDateRUntil'] = cleanStr($data['literalMarriageDateRUntil']);
            $data['literalBirthdayDateR'] = cleanStr($data['literalBirthdayDateR']);
            $data['literalBirthdayDateRSince'] = cleanStr($data['literalBirthdayDateRSince']);
            $data['literalBirthdayDateRUntil'] = cleanStr($data['literalBirthdayDateRUntil']);
            $data['registrationDateR'] = cleanStr($data['registrationDateR']);
            $data['registrationDateRSince'] = cleanStr($data['registrationDateRSince']);
            $data['registrationDateRUntil'] = cleanStr($data['registrationDateRUntil']);
            $data['lastWishDate'] = cleanStr($data['lastWishDate']);
            $data['lastWishDateSince'] = cleanStr($data['lastWishDateSince']);
            $data['lastWishDateUntil'] = cleanStr($data['lastWishDateUntil']);
            $data['ID'] = cleanStr($data['ID']);

            if(!isset($data['assistancePlace'])){
                $data['assistancePlace'] = 'null';
            }else{
                $data['assistancePlace'] = cleanStr($data['assistancePlace']);
            }
            if(!isset($data['location'])){
                $data['location'] = 'null';
            }else{
                $data['location'] = cleanStr($data['location']);
            }
            if($data['attendanceDate'] == ''){
                $data['attendanceDate'] = 'null';
            }
            if($data['attendanceDateSince'] == ''){
                $data['attendanceDateSince'] = 'null';
            }
            if($data['attendanceDateUntil'] == ''){
                $data['attendanceDateUntil'] = 'null';
            }
            if($data['deceasedDate'] == ''){
                $data['deceasedDate'] = 'null';
            }
            if($data['deceasedDateSince'] == ''){
                $data['deceasedDateSince'] = 'null';
            }
            if($data['deceasedDateUntil'] == ''){
                $data['deceasedDateUntil'] = 'null';
            }
            if($data['literalsPickDate'] == ''){
                $data['literalsPickDate'] = 'null';
            }
            if($data['literalsPickDateSince'] == ''){
                $data['literalsPickDateSince'] = 'null';
            }
            if($data['literalsPickDateUntil'] == ''){
                $data['literalsPickDateUntil'] = 'null';
            }
            if($data['invoiceDeliveredDate'] == ''){
                $data['invoiceDeliveredDate'] = 'null';
            }
            if($data['invoiceDeliveredDateSince'] == ''){
                $data['invoiceDeliveredDateSince'] = 'null';
            }
            if($data['invoiceDeliveredDateUntil'] == ''){
                $data['invoiceDeliveredDateUntil'] = 'null';
            }
            if($data['ssDate'] == ''){
                $data['ssDate'] = 'null';
            }
            if($data['ssDateSince'] == ''){
                $data['ssDateSince'] = 'null';
            }
            if($data['ssDateUntil'] == ''){
                $data['ssDateUntil'] = 'null';
            }
            if($data['inssDate'] == ''){
                $data['inssDate'] = 'null';
            }
            if($data['inssDateSince'] == ''){
                $data['inssDateSince'] = 'null';
            }
            if($data['inssDateUntil'] == ''){
                $data['inssDateUntil'] = 'null';
            }
            if($data['ismDate'] == ''){
                $data['ismDate'] = 'null';
            }
            if($data['ismDateSince'] == ''){
                $data['ismDateSince'] = 'null';
            }
            if($data['ismDateUntil'] == ''){
                $data['ismDateUntil'] = 'null';
            }
            if($data['socialDate'] == ''){
                $data['socialDate'] = 'null';
            }
            if($data['socialDateSince'] == ''){
                $data['socialDateSince'] = 'null';
            }
            if($data['socialDateUntil'] == ''){
                $data['socialDateUntil'] = 'null';
            }
            if($data['passiveDate'] == ''){
                $data['passiveDate'] = 'null';
            }
            if($data['passiveDateSince'] == ''){
                $data['passiveDateSince'] = 'null';
            }
            if($data['passiveDateUntil'] == ''){
                $data['passiveDateUntil'] = 'null';
            }
            if($data['isfasDate'] == ''){
                $data['isfasDate'] = 'null';
            }
            if($data['isfasDateSince'] == ''){
                $data['isfasDateSince'] = 'null';
            }
            if($data['isfasDateUntil'] == ''){
                $data['isfasDateUntil'] = 'null';
            }
            if($data['dniDateG'] == ''){
                $data['dniDateG'] = 'null';
            }
            if($data['dniDateGSince'] == ''){
                $data['dniDateGSince'] = 'null';
            }
            if($data['dniDateGUntil'] == ''){
                $data['dniDateGUntil'] = 'null';
            }
            if($data['familyBookDateG'] == ''){
                $data['familyBookDateG'] = 'null';
            }
            if($data['familyBookDateGSince'] == ''){
                $data['familyBookDateGSince'] = 'null';
            }
            if($data['familyBookDateGUntil'] == ''){
                $data['familyBookDateGUntil'] = 'null';
            }
            if($data['literalMarriageDateG'] == ''){
                $data['literalMarriageDateG'] = 'null';
            }
            if($data['literalMarriageDateGSince'] == ''){
                $data['literalMarriageDateGSince'] = 'null';
            }
            if($data['literalMarriageDateGUntil'] == ''){
                $data['literalMarriageDateGUntil'] = 'null';
            }
            if($data['literalBirthdayDateG'] == ''){
                $data['literalBirthdayDateG'] = 'null';
            }
            if($data['literalBirthdayDateGSince'] == ''){
                $data['literalBirthdayDateGSince'] = 'null';
            }
            if($data['literalBirthdayDateGUntil'] == ''){
                $data['literalBirthdayDateGUntil'] = 'null';
            }
            if($data['registrationDateG'] == ''){
                $data['registrationDateG'] = 'null';
            }
            if($data['registrationDateGSince'] == ''){
                $data['registrationDateGSince'] = 'null';
            }
            if($data['registrationDateGUntil'] == ''){
                $data['registrationDateGUntil'] = 'null';
            }
            if($data['dniDateR'] == ''){
                $data['dniDateR'] = 'null';
            }
            if($data['dniDateRSince'] == ''){
                $data['dniDateRSince'] = 'null';
            }
            if($data['dniDateRUntil'] == ''){
                $data['dniDateRUntil'] = 'null';
            }
            if($data['familyBookDateR'] == ''){
                $data['familyBookDateR'] = 'null';
            }
            if($data['familyBookDateRSince'] == ''){
                $data['familyBookDateRSince'] = 'null';
            }
            if($data['familyBookDateRUntil'] == ''){
                $data['familyBookDateRUntil'] = 'null';
            }
            if($data['literalMarriageDateR'] == ''){
                $data['literalMarriageDateR'] = 'null';
            }
            if($data['literalMarriageDateRSince'] == ''){
                $data['literalMarriageDateRSince'] = 'null';
            }
            if($data['literalMarriageDateRUntil'] == ''){
                $data['literalMarriageDateRUntil'] = 'null';
            }
            if($data['literalBirthdayDateR'] == ''){
                $data['literalBirthdayDateR'] = 'null';
            }
            if($data['literalBirthdayDateRSince'] == ''){
                $data['literalBirthdayDateRSince'] = 'null';
            }
            if($data['literalBirthdayDateRUntil'] == ''){
                $data['literalBirthdayDateRUntil'] = 'null';
            }
            if($data['registrationDateR'] == ''){
                $data['registrationDateR'] = 'null';
            }
            if($data['registrationDateRSince'] == ''){
                $data['registrationDateRSince'] = 'null';
            }
            if($data['registrationDateRUntil'] == ''){
                $data['registrationDateRUntil'] = 'null';
            }
            if($data['lastWishDate'] == ''){
                $data['lastWishDate'] = 'null';
            }
            if($data['lastWishDateSince'] == ''){
                $data['lastWishDateSince'] = 'null';
            }
            if($data['lastWishDateUntil'] == ''){
                $data['lastWishDateUntil'] = 'null';
            }

            return $db->query(" UPDATE  Statistics_Assistances
                                SET     attendanceDateCheck = " . $data['attendanceDateCheck'] . ",
                                        attendanceDate = " . $data['attendanceDate'] . ",
                                        attendanceDateCheckPeriod = " . $data['attendanceDateCheckPeriod'] . ",
                                        attendanceDateSince = " . $data['attendanceDateSince'] . ",
                                        attendanceDateUntil = " . $data['attendanceDateUntil'] . ",
                                        widowCheck = " . $data['widowCheck'] . ",
                                        widow = " . $data['widow'] . ",
                                        assistancePlaceCheck = " . $data['assistancePlaceCheck'] . ",
                                        assistancePlace = " . $data['assistancePlace'] . ",
                                        locationCheck = " . $data['locationCheck'] . ",
                                        location = " . $data['location'] . ",
                                        deceasedDateCheck = " . $data['deceasedDateCheck'] . ",
                                        deceasedDate = " . $data['deceasedDate'] . ",
                                        deceasedDateCheckPeriod = " . $data['deceasedDateCheckPeriod'] . ",
                                        deceasedDateSince = " . $data['deceasedDateSince'] . ",
                                        deceasedDateUntil = " . $data['deceasedDateUntil'] . ",
                                        literalsPickDateCheck = " . $data['literalsPickDateCheck'] . ",
                                        literalsPickDate = " . $data['literalsPickDate'] . ",
                                        literalsPickDateCheckPeriod = " . $data['literalsPickDateCheckPeriod'] . ",
                                        literalsPickDateSince = " . $data['literalsPickDateSince'] . ",
                                        literalsPickDateUntil = " . $data['literalsPickDateUntil'] . ",
                                        invoiceDeliveredDateCheck = " . $data['invoiceDeliveredDateCheck'] . ",
                                        invoiceDeliveredDate = " . $data['invoiceDeliveredDate'] . ",
                                        invoiceDeliveredDateCheckPeriod = " . $data['invoiceDeliveredDateCheckPeriod'] . ",
                                        invoiceDeliveredDateSince = " . $data['invoiceDeliveredDateSince'] . ",
                                        invoiceDeliveredDateUntil = " . $data['invoiceDeliveredDateUntil'] . ",
                                        ssDateCheck = " . $data['ssDateCheck'] . ",
                                        ssDate = " . $data['ssDate'] . ",
                                        ssDateCheckPeriod = " . $data['ssDateCheckPeriod'] . ",
                                        ssDateSince = " . $data['ssDateSince'] . ",
                                        ssDateUntil = " . $data['ssDateUntil'] . ",
                                        pensionCheck = " . $data['pensionCheck'] . ",
                                        pension = " . $data['pension'] . ",
                                        inssDateCheck = " . $data['inssDateCheck'] . ",
                                        inssDate = " . $data['inssDate'] . ",
                                        inssDateCheckPeriod = " . $data['inssDateCheckPeriod'] . ",
                                        inssDateSince = " . $data['inssDateSince'] . ",
                                        inssDateUntil = " . $data['inssDateUntil'] . ",
                                        ismDateCheck = " . $data['ismDateCheck'] . ",
                                        ismDate = " . $data['ismDate'] . ",
                                        ismDateCheckPeriod = " . $data['ismDateCheckPeriod'] . ",
                                        ismDateSince = " . $data['ismDateSince'] . ",
                                        ismDateUntil = " . $data['ismDateUntil'] . ",
                                        socialDateCheck = " . $data['socialDateCheck'] . ",
                                        socialDate = " . $data['socialDate'] . ",
                                        socialDateCheckPeriod = " . $data['socialDateCheckPeriod'] . ",
                                        socialDateSince = " . $data['socialDateSince'] . ",
                                        socialDateUntil = " . $data['socialDateUntil'] . ",
                                        passiveDateCheck = " . $data['passiveDateCheck'] . ",
                                        passiveDate = " . $data['passiveDate'] . ",
                                        passiveDateCheckPeriod = " . $data['passiveDateCheckPeriod'] . ",
                                        passiveDateSince = " . $data['passiveDateSince'] . ",
                                        passiveDateUntil = " . $data['passiveDateUntil'] . ",
                                        isfasDateCheck = " . $data['isfasDateCheck'] . ",
                                        isfasDate = " . $data['isfasDate'] . ",
                                        isfasDateCheckPeriod = " . $data['isfasDateCheckPeriod'] . ",
                                        isfasDateSince = " . $data['isfasDateSince'] . ",
                                        isfasDateUntil = " . $data['isfasDateUntil'] . ",
                                        dniDateGCheck = " . $data['dniDateGCheck'] . ",
                                        dniDateG = " . $data['dniDateG'] . ",
                                        dniDateGCheckPeriod = " . $data['dniDateGCheckPeriod'] . ",
                                        dniDateGSince = " . $data['dniDateGSince'] . ",
                                        dniDateGUntil = " . $data['dniDateGUntil'] . ",
                                        familyBookDateGCheck = " . $data['familyBookDateGCheck'] . ",
                                        familyBookDateG = " . $data['familyBookDateG'] . ",
                                        familyBookDateGCheckPeriod = " . $data['familyBookDateGCheckPeriod'] . ",
                                        familyBookDateGSince = " . $data['familyBookDateGSince'] . ",
                                        familyBookDateGUntil = " . $data['familyBookDateGUntil'] . ",
                                        literalMarriageDateGCheck = " . $data['literalMarriageDateGCheck'] . ",
                                        literalMarriageDateG = " . $data['literalMarriageDateG'] . ",
                                        literalMarriageDateGCheckPeriod = " . $data['literalMarriageDateGCheckPeriod'] . ",
                                        literalMarriageDateGSince = " . $data['literalMarriageDateGSince'] . ",
                                        literalMarriageDateGUntil = " . $data['literalMarriageDateGUntil'] . ",
                                        literalBirthdayDateGCheck = " . $data['literalBirthdayDateGCheck'] . ",
                                        literalBirthdayDateG = " . $data['literalBirthdayDateG'] . ",
                                        literalBirthdayDateGCheckPeriod = " . $data['literalBirthdayDateGCheckPeriod'] . ",
                                        literalBirthdayDateGSince = " . $data['literalBirthdayDateGSince'] . ",
                                        literalBirthdayDateGUntil = " . $data['literalBirthdayDateGUntil'] . ",
                                        registrationDateGCheck = " . $data['registrationDateGCheck'] . ",
                                        registrationDateG = " . $data['registrationDateG'] . ",
                                        registrationDateGCheckPeriod = " . $data['registrationDateGCheckPeriod'] . ",
                                        registrationDateGSince = " . $data['registrationDateGSince'] . ",
                                        registrationDateGUntil = " . $data['registrationDateGUntil'] . ",
                                        dniDateRCheck = " . $data['dniDateRCheck'] . ",
                                        dniDateR = " . $data['dniDateR'] . ",
                                        dniDateRCheckPeriod = " . $data['dniDateRCheckPeriod'] . ",
                                        dniDateRSince = " . $data['dniDateRSince'] . ",
                                        dniDateRUntil = " . $data['dniDateRUntil'] . ",
                                        familyBookDateRCheck = " . $data['familyBookDateRCheck'] . ",
                                        familyBookDateR = " . $data['familyBookDateR'] . ",
                                        familyBookDateRCheckPeriod = " . $data['familyBookDateRCheckPeriod'] . ",
                                        familyBookDateRSince = " . $data['familyBookDateRSince'] . ",
                                        familyBookDateRUntil = " . $data['familyBookDateRUntil'] . ",
                                        literalMarriageDateRCheck = " . $data['literalMarriageDateRCheck'] . ",
                                        literalMarriageDateR = " . $data['literalMarriageDateR'] . ",
                                        literalMarriageDateRCheckPeriod = " . $data['literalMarriageDateRCheckPeriod'] . ",
                                        literalMarriageDateRSince = " . $data['literalMarriageDateRSince'] . ",
                                        literalMarriageDateRUntil = " . $data['literalMarriageDateRUntil'] . ",
                                        literalBirthdayDateRCheck = " . $data['literalBirthdayDateRCheck'] . ",
                                        literalBirthdayDateR = " . $data['literalBirthdayDateR'] . ",
                                        literalBirthdayDateRCheckPeriod = " . $data['literalBirthdayDateRCheckPeriod'] . ",
                                        literalBirthdayDateRSince = " . $data['literalBirthdayDateRSince'] . ",
                                        literalBirthdayDateRUntil = " . $data['literalBirthdayDateRUntil'] . ",
                                        registrationDateRCheck = " . $data['registrationDateRCheck'] . ",
                                        registrationDateR = " . $data['registrationDateR'] . ",
                                        registrationDateRCheckPeriod = " . $data['registrationDateRCheckPeriod'] . ",
                                        registrationDateRSince = " . $data['registrationDateRSince'] . ",
                                        registrationDateRUntil = " . $data['registrationDateRUntil'] . ",
                                        lastWishDateCheck = " . $data['lastWishDateCheck'] . ",
                                        lastWishDate = " . $data['lastWishDate'] . ",
                                        lastWishDateCheckPeriod = " . $data['lastWishDateCheckPeriod'] . ",
                                        lastWishDateSince = " . $data['lastWishDateSince'] . ",
                                        lastWishDateUntil = " . $data['lastWishDateUntil'] . "
                                WHERE   ID = " . $data['ID']);
        }

        /**
         * Elimina una plantilla
         * 
         * @param array $data ID de la plantilla
         * @return bool
         */
        public function assistancesDelete($data){
            $db = new DbHandler;

            $data['ID'] = cleanStr($data['ID']);

            return $db->query(" UPDATE  Statistics_Assistances
                                SET     leavingDate = " . time() . "
                                WHERE   ID = " . $data['ID']);
        }

        /**
         * Obtiene las plantillas de asistencias
         * 
         * @return array Plantillas
         */
        public function assistancesSearchTemplates(){
            $db = new DbHandler;

            $result = $db->query("  SELECT  ID, name
                                    FROM    Statistics_Assistances
                                    WHERE   leavingDate IS NULL");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }

        /* **************** TIEMPOS DE RESPUESTA **************** */
        /**
         * Crea una plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function timesCreate($data){
            $db = new DbHandler;

            $data['name'] = cleanStr($data['name']);
            $data['date'] = cleanStr($data['date']);
            $data['dateSince'] = cleanStr($data['dateSince']);
            $data['dateUntil'] = cleanStr($data['dateUntil']);
            $data['month'] = cleanStr($data['month']);
            $data['trimester'] = cleanStr($data['trimester']);
            $data['callTime'] = cleanStr($data['callTime']);
            $data['callTimeSince'] = cleanStr($data['callTimeSince']);
            $data['callTimeUntil'] = cleanStr($data['callTimeUntil']);
            $data['arriveTime'] = cleanStr($data['arriveTime']);
            $data['arriveTimeSince'] = cleanStr($data['arriveTimeSince']);
            $data['arriveTimeUntil'] = cleanStr($data['arriveTimeUntil']);
            $data['startDate'] = cleanStr($data['startDate']);
            $data['startDateSince'] = cleanStr($data['startDateSince']);
            $data['startDateUntil'] = cleanStr($data['startDateUntil']);
            $data['startTime'] = cleanStr($data['startTime']);
            $data['startTimeSince'] = cleanStr($data['startTimeSince']);
            $data['startTimeUntil'] = cleanStr($data['startTimeUntil']);
            $data['deceasedDate'] = cleanStr($data['deceasedDate']);
            $data['deceasedDateSince'] = cleanStr($data['deceasedDateSince']);
            $data['deceasedDateUntil'] = cleanStr($data['deceasedDateUntil']);
            $data['deceasedTime'] = cleanStr($data['deceasedTime']);
            $data['deceasedTimeSince'] = cleanStr($data['deceasedTimeSince']);
            $data['deceasedTimeUntil'] = cleanStr($data['deceasedTimeUntil']);
            $data['deceasedIn'] = cleanStr($data['deceasedIn']);
            $data['deceasedProvinces'] = cleanStr($data['deceasedProvinces']);
            $data['deceasedLocation'] = cleanStr($data['deceasedLocation']);
            $data['funeralDate'] = cleanStr($data['funeralDate']);
            $data['funeralDateSince'] = cleanStr($data['funeralDateSince']);
            $data['funeralDateUntil'] = cleanStr($data['funeralDateUntil']);
            $data['funeralTime'] = cleanStr($data['funeralTime']);
            $data['funeralTimeSince'] = cleanStr($data['funeralTimeSince']);
            $data['funeralTimeUntil'] = cleanStr($data['funeralTimeUntil']);
            $data['funeralHome'] = cleanStr($data['funeralHome']);

            $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

            $result = $db->query("  SELECT  * 
                                    FROM    Statistics_Times 
                                    WHERE   extraID = '$extraID'");

            while(mysqli_num_rows($result) > 0){
                $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

                $result = $db->query("  SELECT  * 
                                        FROM    Statistics_Times 
                                        WHERE   extraID = '$extraID'");
            }

            if($data['date'] == ''){
                $data['date'] = 'null';
            }

            if($data['dateSince'] == ''){
                $data['dateSince'] = 'null';
            }

            if($data['dateUntil'] == ''){
                $data['dateUntil'] = 'null';
            }

            if($data['month'] == ''){
                $data['month'] = 0;
            }

            if($data['trimester'] == ''){
                $data['trimester'] = 0;
            }

            if($data['callTime'] == ''){
                $data['callTime'] = 'null';
            }

            if($data['callTimeSince'] == ''){
                $data['callTimeSince'] = 'null';
            }

            if($data['callTimeUntil'] == ''){
                $data['callTimeUntil'] = 'null';
            }

            if($data['arriveTime'] == ''){
                $data['arriveTime'] = 'null';
            }

            if($data['arriveTimeSince'] == ''){
                $data['arriveTimeSince'] = 'null';
            }

            if($data['arriveTimeUntil'] == ''){
                $data['arriveTimeUntil'] = 'null';
            }

            if($data['startDate'] == ''){
                $data['startDate'] = 'null';
            }

            if($data['startDateSince'] == ''){
                $data['startDateSince'] = 'null';
            }

            if($data['startDateUntil'] == ''){
                $data['startDateUntil'] = 'null';
            }

            if($data['startTime'] == ''){
                $data['startTime'] = 'null';
            }

            if($data['startTimeSince'] == ''){
                $data['startTimeSince'] = 'null';
            }

            if($data['startTimeUntil'] == ''){
                $data['startTimeUntil'] = 'null';
            }

            if($data['deceasedDate'] == ''){
                $data['deceasedDate'] = 'null';
            }

            if($data['deceasedDateSince'] == ''){
                $data['deceasedDateSince'] = 'null';
            }

            if($data['deceasedDateUntil'] == ''){
                $data['deceasedDateUntil'] = 'null';
            }

            if($data['deceasedTime'] == ''){
                $data['deceasedTime'] = 'null';
            }

            if($data['deceasedTimeSince'] == ''){
                $data['deceasedTimeSince'] = 'null';
            }

            if($data['deceasedTimeUntil'] == ''){
                $data['deceasedTimeUntil'] = 'null';
            }

            if($data['deceasedIn'] == ''){
                $data['deceasedIn'] = 'null';
            }

            if($data['deceasedProvinces'] == ''){
                $data['deceasedProvinces'] = 'null';
            }

            if($data['deceasedLocation'] == ''){
                $data['deceasedLocation'] = 'null';
            }

            if($data['funeralDate'] == ''){
                $data['funeralDate'] = 'null';
            }

            if($data['funeralDateSince'] == ''){
                $data['funeralDateSince'] = 'null';
            }

            if($data['funeralDateUntil'] == ''){
                $data['funeralDateUntil'] = 'null';
            }

            if($data['funeralTime'] == ''){
                $data['funeralTime'] = 'null';
            }

            if($data['funeralTimeSince'] == ''){
                $data['funeralTimeSince'] = 'null';
            }

            if($data['funeralTimeUntil'] == ''){
                $data['funeralTimeUntil'] = 'null';
            }

            if($data['funeralHome'] == ''){
                $data['funeralHome'] = 'null';
            }

            $db->query("INSERT INTO Statistics_Times(   name, dateCheck, date, datePeriod, dateSince, dateUntil,
                                                        dateCheckLength, year, month, trimester, callTimeCheck,
                                                        callTime, callTimePeriod, callTimeSince, callTimeUntil,
                                                        arriveTimeCheck, arriveTime, arriveTimePeriod, arriveTimeSince,
                                                        arriveTimeUntil, startDateCheck, startDate, startDatePeriod,
                                                        startDateSince, startDateUntil, startTimeCheck, startTime,
                                                        startTimePeriod, startTimeSince, startTimeUntil,
                                                        deceasedDateCheck, deceasedDate, deceasedDatePeriod,
                                                        deceasedDateSince, deceasedDateUntil, deceasedTimeCheck,
                                                        deceasedTime, deceasedTimePeriod, deceasedTimeSince,
                                                        deceasedTimeUntil, deceasedInCheck, deceasedProvinceCheck,
                                                        deceasedLocationCheck, funeralDateCheck, funeralDate,
                                                        funeralDatePeriod, funeralDateSince, funeralDateUntil,
                                                        funeralTimeCheck, funeralTime, funeralTimePeriod,
                                                        funeralTimeSince, funeralTimeUntil, funeralHomeCheck, extraID)
                        VALUES ('" . $data['name'] . "', " . $data['dateCheck'] . ",
                                " . $data['date'] . ", " . $data['datePeriod'] . ",
                                " . $data['dateSince'] . ", " . $data['dateUntil'] . ",
                                " . $data['dateCheckLength'] . ", " . $data['year'] . ",
                                " . $data['month'] . ", " . $data['trimester'] . ",
                                " . $data['callTimeCheck'] . ", " . $data['callTime'] . ",
                                " . $data['callTimePeriod'] . ", " . $data['callTimeSince'] . ",
                                " . $data['callTimeUntil'] . ", " . $data['arriveTimeCheck'] . ",
                                " . $data['arriveTime'] . ", " . $data['arriveTimePeriod'] . ",
                                " . $data['arriveTimeSince'] . ", " . $data['arriveTimeUntil'] . ",
                                " . $data['startDateCheck'] . ", " . $data['startDate'] . ",
                                " . $data['startDatePeriod'] . ", " . $data['startDateSince'] . ",
                                " . $data['startDateUntil'] . ", " . $data['startTimeCheck'] . ",
                                " . $data['startTime'] . ", " . $data['startTimePeriod'] . ",
                                " . $data['startTimeSince'] . ", " . $data['startTimeUntil'] . ",
                                " . $data['deceasedDateCheck'] . ", " . $data['deceasedDate'] . ",
                                " . $data['deceasedDatePeriod'] . ", " . $data['deceasedDateSince'] . ",
                                " . $data['deceasedDateUntil'] . ", " . $data['deceasedTimeCheck'] . ",
                                " . $data['deceasedTime'] . ", " . $data['deceasedTimePeriod'] . ",
                                " . $data['deceasedTimeSince'] . ", " . $data['deceasedTimeUntil'] . ",
                                " . $data['deceasedInCheck'] . ", " . $data['deceasedProvinceCheck'] . ",
                                " . $data['deceasedLocationCheck'] . ", " . $data['funeralDateCheck'] . ",
                                " . $data['funeralDate'] . ", " . $data['funeralDatePeriod'] . ",
                                " . $data['funeralDateSince'] . ", " . $data['funeralDateUntil'] . ",
                                " . $data['funeralTimeCheck'] . ", " . $data['funeralTime'] . ",
                                " . $data['funeralTimePeriod'] . ", " . $data['funeralTimeSince'] . ",
                                " . $data['funeralTimeUntil'] . ", " . $data['funeralHomeCheck'] . ",
                                '$extraID')");

            $id = $this->timesGetIdByExtraId($extraID);
            if($id != null){
                if($data['deceasedIn']){
                    foreach($data['deceasedIn'] as $elem){
                        $elem = cleanStr($elem);

                        $db->query("INSERT INTO Statistics_Times_DeceasedIn(statisticsTimes, deceasedIn)
                                    VALUES ($id, $elem)");
                    }
                }
                
                if($data['deceasedProvinces'] != null){
                    foreach($data['deceasedProvinces'] as $elem){
                        $elem = cleanStr($elem);

                        $db->query("INSERT INTO Statistics_Times_DeceasedProvince(statisticsTimes, deceasedProvince)
                                    VALUES ($id, '$elem')");
                    }
                }

                if($data['deceasedLocation']){
                    foreach($data['deceasedLocation'] as $elem){
                        $elem = cleanStr($elem);

                        $db->query("INSERT INTO Statistics_Times_DeceasedLocation(statisticsTimes, deceasedLocation)
                                    VALUES ($id, $elem)");
                    }
                }

                if($data['funeralHome']){
                    foreach($data['funeralHome'] as $elem){
                        $elem = cleanStr($elem);

                        $db->query("INSERT INTO Statistics_Times_FuneralHome(statisticsTimes, funeralHome)
                                    VALUES ($id, $elem)");
                    }
                }
            }

            return true;
        }

        /**
         * Obtiene los datos de la plantilla
         * 
         * @param int $id Id de la plantilla
         * @return array
         */
        public function timesRead($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            $result = $db->query("  SELECT  *
                                    FROM    Statistics_Times
                                    WHERE   ID = $id");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $data = array();

                $times = $db->resultToArray($result)[0];
                $data['times'] = $times;

                $result = $db->query("  SELECT  di.deceasedInID as id, di.name
                                        FROM    Statistics_Times_DeceasedIn std, DeceasedIn di
                                        WHERE   std.deceasedIn = di.deceasedInID AND
                                                std.statisticsTimes = $id");

                if(mysqli_num_rows($result) == 0){
                    $deceasedIn = null;
                }else{
                    $deceasedIn = $db->resultToArray($result);
                }
                $data['deceasedIn'] = $deceasedIn;

                $result = $db->query("  SELECT  l.locationID as id, l.name, l.province
                                        FROM    Statistics_Times_DeceasedLocation std, Locations l
                                        WHERE   std.deceasedLocation = l.locationID AND
                                                statisticsTimes = $id");

                if(mysqli_num_rows($result) == 0){
                    $deceasedLocation = null;
                }else{
                    $deceasedLocation = $db->resultToArray($result);
                }
                $data['deceasedLocation'] = $deceasedLocation;

                $result = $db->query("  SELECT  deceasedProvince as name
                                        FROM    Statistics_Times_DeceasedProvince
                                        WHERE   statisticsTimes = $id");

                if(mysqli_num_rows($result) == 0){
                    $deceasedProvince = null;
                }else{
                    $deceasedProvince = $db->resultToArray($result);
                }
                $data['deceasedProvince'] = $deceasedProvince;

                $result = $db->query("  SELECT  fh.funeralHomeID as id, fh.name
                                        FROM    Statistics_Times_FuneralHome std, FuneralHomes fh
                                        WHERE   std.funeralHome = fh.funeralHomeID AND
                                                statisticsTimes = $id");

                if(mysqli_num_rows($result) == 0){
                    $funeralHome = null;
                }else{
                    $funeralHome = $db->resultToArray($result);
                }
                $data['funeralHome'] = $funeralHome;
            }

            return $data;
        }

        /**
         * Modifica los datos de la plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function timesUpdate($data){
            $db = new DbHandler;

            $data['name'] = cleanStr($data['name']);
            $data['date'] = cleanStr($data['date']);
            $data['dateSince'] = cleanStr($data['dateSince']);
            $data['dateUntil'] = cleanStr($data['dateUntil']);
            $data['month'] = cleanStr($data['month']);
            $data['trimester'] = cleanStr($data['trimester']);
            $data['callTime'] = cleanStr($data['callTime']);
            $data['callTimeSince'] = cleanStr($data['callTimeSince']);
            $data['callTimeUntil'] = cleanStr($data['callTimeUntil']);
            $data['arriveTime'] = cleanStr($data['arriveTime']);
            $data['arriveTimeSince'] = cleanStr($data['arriveTimeSince']);
            $data['arriveTimeUntil'] = cleanStr($data['arriveTimeUntil']);
            $data['startDate'] = cleanStr($data['startDate']);
            $data['startDateSince'] = cleanStr($data['startDateSince']);
            $data['startDateUntil'] = cleanStr($data['startDateUntil']);
            $data['startTime'] = cleanStr($data['startTime']);
            $data['startTimeSince'] = cleanStr($data['startTimeSince']);
            $data['startTimeUntil'] = cleanStr($data['startTimeUntil']);
            $data['deceasedDate'] = cleanStr($data['deceasedDate']);
            $data['deceasedDateSince'] = cleanStr($data['deceasedDateSince']);
            $data['deceasedDateUntil'] = cleanStr($data['deceasedDateUntil']);
            $data['deceasedTime'] = cleanStr($data['deceasedTime']);
            $data['deceasedTimeSince'] = cleanStr($data['deceasedTimeSince']);
            $data['deceasedTimeUntil'] = cleanStr($data['deceasedTimeUntil']);
            $data['deceasedIn'] = cleanStr($data['deceasedIn']);
            $data['deceasedProvinces'] = cleanStr($data['deceasedProvinces']);
            $data['deceasedLocation'] = cleanStr($data['deceasedLocation']);
            $data['funeralDate'] = cleanStr($data['funeralDate']);
            $data['funeralDateSince'] = cleanStr($data['funeralDateSince']);
            $data['funeralDateUntil'] = cleanStr($data['funeralDateUntil']);
            $data['funeralTime'] = cleanStr($data['funeralTime']);
            $data['funeralTimeSince'] = cleanStr($data['funeralTimeSince']);
            $data['funeralTimeUntil'] = cleanStr($data['funeralTimeUntil']);
            $data['funeralHome'] = cleanStr($data['funeralHome']);

            if($data['date'] == ''){
                $data['date'] = 'null';
            }

            if($data['dateSince'] == ''){
                $data['dateSince'] = 'null';
            }

            if($data['dateUntil'] == ''){
                $data['dateUntil'] = 'null';
            }

            if($data['month'] == ''){
                $data['month'] = 0;
            }

            if($data['trimester'] == ''){
                $data['trimester'] = 0;
            }

            if($data['callTime'] == ''){
                $data['callTime'] = 'null';
            }

            if($data['callTimeSince'] == ''){
                $data['callTimeSince'] = 'null';
            }

            if($data['callTimeUntil'] == ''){
                $data['callTimeUntil'] = 'null';
            }

            if($data['arriveTime'] == ''){
                $data['arriveTime'] = 'null';
            }

            if($data['arriveTimeSince'] == ''){
                $data['arriveTimeSince'] = 'null';
            }

            if($data['arriveTimeUntil'] == ''){
                $data['arriveTimeUntil'] = 'null';
            }

            if($data['startDate'] == ''){
                $data['startDate'] = 'null';
            }

            if($data['startDateSince'] == ''){
                $data['startDateSince'] = 'null';
            }

            if($data['startDateUntil'] == ''){
                $data['startDateUntil'] = 'null';
            }

            if($data['startTime'] == ''){
                $data['startTime'] = 'null';
            }

            if($data['startTimeSince'] == ''){
                $data['startTimeSince'] = 'null';
            }

            if($data['startTimeUntil'] == ''){
                $data['startTimeUntil'] = 'null';
            }

            if($data['deceasedDate'] == ''){
                $data['deceasedDate'] = 'null';
            }

            if($data['deceasedDateSince'] == ''){
                $data['deceasedDateSince'] = 'null';
            }

            if($data['deceasedDateUntil'] == ''){
                $data['deceasedDateUntil'] = 'null';
            }

            if($data['deceasedTime'] == ''){
                $data['deceasedTime'] = 'null';
            }

            if($data['deceasedTimeSince'] == ''){
                $data['deceasedTimeSince'] = 'null';
            }

            if($data['deceasedTimeUntil'] == ''){
                $data['deceasedTimeUntil'] = 'null';
            }

            if($data['deceasedIn'] == ''){
                $data['deceasedIn'] = 'null';
            }

            if($data['deceasedProvinces'] == ''){
                $data['deceasedProvinces'] = 'null';
            }

            if($data['deceasedLocation'] == ''){
                $data['deceasedLocation'] = 'null';
            }

            if($data['funeralDate'] == ''){
                $data['funeralDate'] = 'null';
            }

            if($data['funeralDateSince'] == ''){
                $data['funeralDateSince'] = 'null';
            }

            if($data['funeralDateUntil'] == ''){
                $data['funeralDateUntil'] = 'null';
            }

            if($data['funeralTime'] == ''){
                $data['funeralTime'] = 'null';
            }

            if($data['funeralTimeSince'] == ''){
                $data['funeralTimeSince'] = 'null';
            }

            if($data['funeralTimeUntil'] == ''){
                $data['funeralTimeUntil'] = 'null';
            }

            if($data['funeralHome'] == ''){
                $data['funeralHome'] = 'null';
            }

            $db->query("UPDATE  Statistics_Times
                        SET     name = '" . $data['name'] . "',
                                dateCheck = " . $data['dateCheck'] . ",
                                date = " . $data['date'] . ",
                                datePeriod = " . $data['datePeriod'] . ",
                                dateSince = " . $data['dateSince'] . ",
                                dateUntil = " . $data['dateUntil'] . ",
                                dateCheckLength = " . $data['dateCheckLength'] . ",
                                year = " . $data['year'] . ",
                                month = " . $data['month'] . ",
                                trimester = " . $data['trimester'] . ",
                                callTimeCheck = " . $data['callTimeCheck'] . ",
                                callTime = " . $data['callTime'] . ",
                                callTimePeriod = " . $data['callTimePeriod'] . ",
                                callTimeSince = " . $data['callTimeSince'] . ",
                                callTimeUntil = " . $data['callTimeUntil'] . ",
                                arriveTimeCheck = " . $data['arriveTimeCheck'] . ",
                                arriveTime = " . $data['arriveTime'] . ",
                                arriveTimePeriod = " . $data['arriveTimePeriod'] . ",
                                arriveTimeSince = " . $data['arriveTimeSince'] . ",
                                arriveTimeUntil = " . $data['arriveTimeUntil'] . ",
                                startDateCheck = " . $data['startDateCheck'] . ",
                                startDate = " . $data['startDate'] . ",
                                startDatePeriod = " . $data['startDatePeriod'] . ",
                                startDateSince = " . $data['startDateSince'] . ",
                                startDateUntil = " . $data['startDateUntil'] . ",
                                startTimeCheck = " . $data['startTimeCheck'] . ",
                                startTime = " . $data['startTime'] . ",
                                startTimePeriod = " . $data['startTimePeriod'] . ",
                                startTimeSince = " . $data['startTimeSince'] . ",
                                startTimeUntil = " . $data['startTimeUntil'] . ",
                                deceasedDateCheck = " . $data['deceasedDateCheck'] . ",
                                deceasedDate = " . $data['deceasedDate'] . ",
                                deceasedDatePeriod = " . $data['deceasedDatePeriod'] . ",
                                deceasedDateSince = " . $data['deceasedDateSince'] . ",
                                deceasedDateUntil = " . $data['deceasedDateUntil'] . ",
                                deceasedTimeCheck = " . $data['deceasedTimeCheck'] . ",
                                deceasedTime = " . $data['deceasedTime'] . ",
                                deceasedTimePeriod = " . $data['deceasedTimePeriod'] . ",
                                deceasedTimeSince = " . $data['deceasedTimeSince'] . ",
                                deceasedTimeUntil = " . $data['deceasedTimeUntil'] . ",
                                deceasedInCheck = " . $data['deceasedInCheck'] . ",
                                deceasedProvinceCheck = " . $data['deceasedProvinceCheck'] . ",
                                deceasedLocationCheck = " . $data['deceasedLocationCheck'] . ",
                                funeralDateCheck = " . $data['funeralDateCheck'] . ",
                                funeralDate = " . $data['funeralDate'] . ",
                                funeralDatePeriod = " . $data['funeralDatePeriod'] . ",
                                funeralDateSince = " . $data['funeralDateSince'] . ",
                                funeralDateUntil = " . $data['funeralDateUntil'] . ",
                                funeralTimeCheck = " . $data['funeralTimeCheck'] . ",
                                funeralTime = " . $data['funeralTime'] . ",
                                funeralTimePeriod = " . $data['funeralTimePeriod'] . ",
                                funeralTimeSince = " . $data['funeralTimeSince'] . ",
                                funeralTimeUntil = " . $data['funeralTimeUntil'] . ",
                                funeralHomeCheck = " . $data['funeralHomeCheck'] . "
                        WHERE   ID = " . $data['ID']);

            $db->query("DELETE FROM Statistics_Times_DeceasedIn
                        WHERE statisticsTimes = " . $data['ID']);
            
            if($data['deceasedIn'] != 'null'){
                foreach($data['deceasedIn'] as $elem){
                    $elem = cleanStr($elem);

                    $db->query("INSERT INTO Statistics_Times_DeceasedIn(statisticsTimes, deceasedIn)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_Times_DeceasedProvince
                        WHERE statisticsTimes = " . $data['ID']);

            if($data['deceasedProvinces'] != 'null'){
                foreach($data['deceasedProvinces'] as $elem){
                    $elem = cleanStr($elem);

                    $db->query("INSERT INTO Statistics_Times_DeceasedProvince(statisticsTimes, deceasedProvince)
                                VALUES (" . $data['ID'] . ", '$elem')");
                }
            }

            $db->query("DELETE FROM Statistics_Times_DeceasedLocation
                        WHERE statisticsTimes = " . $data['ID']);
            
            if($data['deceasedLocation'] != 'null'){
                foreach($data['deceasedLocation'] as $elem){
                    $elem = cleanStr($elem);

                    $db->query("INSERT INTO Statistics_Times_DeceasedLocation(statisticsTimes, deceasedLocation)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_Times_FuneralHome
                        WHERE statisticsTimes = " . $data['ID']);
            
            if($data['funeralHome'] != 'null'){
                foreach($data['funeralHome'] as $elem){
                    $elem = cleanStr($elem);

                    $db->query("INSERT INTO Statistics_Times_FuneralHome(statisticsTimes, funeralHome)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            return true;
        }

        /**
         * Elimina una plantilla
         * 
         * @param int $id Id de la plantilla
         * @return bool
         */
        public function timesDelete($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            return $db->query(" UPDATE  Statistics_Times
                                SET     leavingDate = " . time() . "
                                WHERE   ID = $id");
        }

        /**
         * Obtiene el ID dado el extraID
         * 
         * @param string $extraID ExtraID
         * @return int
         */
        public function timesGetIdByExtraId($extraID){
            $db = new DbHandler;

            $extraID = cleanStr($extraID);

            $result = $db->query("  SELECT  ID
                                    FROM    Statistics_Times
                                    WHERE   extraID = '$extraID'");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['ID'];
        }

        
        /**
         * Obtiene las plantillas de tiempos de respuesta
         * 
         * @return array Plantillas
         */
        public function timesSearchTemplates(){
            $db = new DbHandler;

            $result = $db->query("  SELECT  ID, name
                                    FROM    Statistics_Times
                                    WHERE   leavingDate IS NULL");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }

        /* **************** CREMACIONES **************** */
        /**
         * Crea una plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function cremationsCreate($data){
            $db = new DbHandler;

            $data['date'] = cleanStr($data['date']);
            $data['dateSince'] = cleanStr($data['dateSince']);
            $data['dateUntil'] = cleanStr($data['dateUntil']);
            $data['month'] = cleanStr($data['month']);
            $data['trimester'] = cleanStr($data['trimester']);
            $data['deceasedIn'] = cleanStr($data['deceasedIn']);
            $data['deceasedProvinces'] = cleanStr($data['deceasedProvinces']);
            $data['deceasedLocation'] = cleanStr($data['deceasedLocation']);
            $data['crematorium'] = cleanStr($data['crematorium']);
            $data['cremationDate'] = cleanStr($data['cremationDate']);
            $data['cremationDateSince'] = cleanStr($data['cremationDateSince']);
            $data['cremationDateUntil'] = cleanStr($data['cremationDateUntil']);
            $data['cremationTime'] = cleanStr($data['cremationTime']);
            $data['cremationTimeSince'] = cleanStr($data['cremationTimeSince']);
            $data['cremationTimeUntil'] = cleanStr($data['cremationTimeUntil']);

            $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

            $result = $db->query("  SELECT  * 
                                    FROM    Statistics_Cremations 
                                    WHERE   extraID = '$extraID'");

            while(mysqli_num_rows($result) > 0){
                $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

                $result = $db->query("  SELECT  * 
                                        FROM    Statistics_Cremations 
                                        WHERE   extraID = '$extraID'");
            }

            if($data['date'] == ''){
                $data['date'] = 'null';
            }
            if($data['dateSince'] == ''){
                $data['dateSince'] = 'null';
            }
            if($data['dateUntil'] == ''){
                $data['dateUntil'] = 'null';
            }
            if($data['month'] == ''){
                $data['month'] = 0;
            }
            if($data['trimester'] == ''){
                $data['trimester'] = 0;
            }
            if($data['deceasedIn'] == ''){
                $data['deceasedIn'] = null;
            }
            if($data['deceasedProvinces'] == ''){
                $data['deceasedProvinces'] = null;
            }
            if($data['deceasedLocation'] == ''){
                $data['deceasedLocation'] = null;
            }
            if($data['crematorium'] == ''){
                $data['crematorium'] = null;
            }
            if($data['cremationDate'] == ''){
                $data['cremationDate'] = 'null';
            }
            if($data['cremationDateSince'] == ''){
                $data['cremationDateSince'] = 'null';
            }
            if($data['cremationDateUntil'] == ''){
                $data['cremationDateUntil'] = 'null';
            }
            if($data['cremationTime'] == ''){
                $data['cremationTime'] = 'null';
            }
            if($data['cremationTimeSince'] == ''){
                $data['cremationTimeSince'] = 'null';
            }
            if($data['cremationTimeUntil'] == ''){
                $data['cremationTimeUntil'] = 'null';
            }
            if($data['client'] == ''){
                $data['client'] = null;
            }

            $db->query("INSERT INTO Statistics_Cremations(  name, dateCheck, date, datePeriod, dateSince, dateUntil, dateCheckLength,
                                                            year, month, trimester, deceasedInCheck, deceasedProvinceCheck,
                                                            deceasedLocationCheck, crematoriumCheck, cremationDateCheck,
                                                            cremationDate, cremationDatePeriod, cremationDateSince, cremationDateUntil,
                                                            cremationTimeCheck, cremationTime, cremationTimePeriod, cremationTimeSince,
                                                            cremationTimeUntil, clientCheck, introductionCheck, introduction,
                                                            waitOnRoomCheck, waitOnRoom, vaseBioCheck, vaseBio, extraID)
                        VALUES ('" . $data['name'] . "', " . $data['dateCheck'] . ",
                                " . $data['date'] . ", " . $data['datePeriod'] . ",
                                " . $data['dateSince'] . ", " . $data['dateUntil'] . ",
                                " . $data['dateCheckLength'] . ", " . $data['year'] . ",
                                " . $data['month'] . ", " . $data['trimester'] . ",
                                " . $data['deceasedInCheck'] . ", " . $data['deceasedProvinceCheck'] . ",
                                " . $data['deceasedLocationCheck'] . ", " . $data['crematoriumCheck'] . ",
                                " . $data['cremationDateCheck'] . ", " . $data['cremationDate'] . ",
                                " . $data['cremationDatePeriod'] . ", " . $data['cremationDateSince'] . ",
                                " . $data['cremationDateUntil'] . ", " . $data['cremationTimeCheck'] . ",
                                " . $data['cremationTime'] . ", " . $data['cremationTimePeriod'] . ",
                                " . $data['cremationTimeSince'] . ", " . $data['cremationTimeUntil'] . ",
                                " . $data['clientCheck'] . ", " . $data['introductionCheck'] . ",
                                " . $data['introduction'] . ", " . $data['waitOnRoomCheck'] . ",
                                " . $data['waitOnRoom'] . ", " . $data['vaseBioCheck'] . ",
                                " . $data['vaseBio'] . ", '$extraID')");

            $id = $this->cremationsGetIdByExtraId($extraID);

            if($data['deceasedIn'] != null){
                foreach($data['deceasedIn'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Cremations_DeceasedIn(statisticsCremations, deceasedIn)
                                VALUES ($id, $elem)");
                }
            }

            if($data['deceasedProvinces'] != null){
                foreach($data['deceasedProvinces'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Cremations_DeceasedProvince(statisticsCremations, deceasedProvince)
                                VALUES ($id, '$elem')");
                }
            }

            if($data['deceasedLocation'] != null){
                foreach($data['deceasedLocation'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Cremations_DeceasedLocation(statisticsCremations, deceasedLocation)
                                VALUES ($id, $elem)");
                }
            }

            if($data['crematorium'] != null){
                foreach($data['crematorium'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Cremations_Crematorium(statisticsCremations, crematorium)
                                VALUES ($id, $elem)");
                }
            }

            if($data['client'] != null){
                foreach($data['client'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Cremations_Client(statisticsCremations, client)
                                VALUES ($id, $elem)");
                }
            }

            return true;
        }

        /**
         * Obtiene los datos de la plantilla
         * 
         * @param int $id Id de la plantilla
         * @return array
         */
        public function cremationsRead($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            $result = $db->query("  SELECT  *
                                    FROM    Statistics_Cremations
                                    WHERE   ID = $id");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $data = array();

                $cremations = $db->resultToArray($result)[0];
                $data['cremations'] = $cremations;

                $result = $db->query("  SELECT  di.deceasedInID as id, di.name
                                        FROM    Statistics_Cremations_DeceasedIn scd, DeceasedIn di
                                        WHERE   scd.deceasedIn = di.deceasedInID AND
                                                scd.statisticsCremations = $id");

                if(mysqli_num_rows($result) == 0){
                    $deceasedIn = null;
                }else{
                    $deceasedIn = $db->resultToArray($result);
                }
                $data['deceasedIn'] = $deceasedIn;

                $result = $db->query("  SELECT  l.locationID as id, l.name, l.province
                                        FROM    Statistics_Cremations_DeceasedLocation scd, Locations l
                                        WHERE   scd.deceasedLocation = l.locationID AND
                                                scd.statisticsCremations = $id");

                if(mysqli_num_rows($result) == 0){
                    $deceasedLocation = null;
                }else{
                    $deceasedLocation = $db->resultToArray($result);
                }
                $data['deceasedLocation'] = $deceasedLocation;

                $result = $db->query("  SELECT  scd.deceasedProvince as name
                                        FROM    Statistics_Cremations_DeceasedProvince scd
                                        WHERE   scd.statisticsCremations = $id");

                if(mysqli_num_rows($result) == 0){
                    $deceasedProvince = null;
                }else{
                    $deceasedProvince = $db->resultToArray($result);
                }
                $data['deceasedProvince'] = $deceasedProvince;

                $result = $db->query("  SELECT  scc.crematorium, c.name as name
                                        FROM    Statistics_Cremations_Crematorium scc, Crematoriums c
                                        WHERE   scc.crematorium = c.crematoriumID AND
                                                scc.statisticsCremations = $id");

                if(mysqli_num_rows($result) == 0){
                    $crematoriums = null;
                }else{
                    $crematoriums = $db->resultToArray($result);
                }
                $data['crematoriums'] = $crematoriums;

                $result = $db->query("  SELECT  scc.client, c.name as name
                                        FROM    Statistics_Cremations_Client scc, Clients c
                                        WHERE   scc.client = c.clientID AND
                                                scc.statisticsCremations = $id");

                if(mysqli_num_rows($result) == 0){
                    $clients = null;
                }else{
                    $clients = $db->resultToArray($result);
                }
                $data['clients'] = $clients;
            }

            return $data;
        }

        /**
         * Modifica los datos de la plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function cremationsUpdate($data){
            $db = new DbHandler;

            $data['name'] = cleanStr($data['name']);
            $data['dateCheck'] = cleanStr($data['dateCheck']);
            $data['date'] = cleanStr($data['date']);
            $data['datePeriod'] = cleanStr($data['datePeriod']);
            $data['dateSince'] = cleanStr($data['dateSince']);
            $data['dateUntil'] = cleanStr($data['dateUntil']);
            $data['dateCheckLength'] = cleanStr($data['dateCheckLength']);
            $data['year'] = cleanStr($data['year']);
            $data['month'] = cleanStr($data['month']);
            $data['trimester'] = cleanStr($data['trimester']);
            $data['deceasedInCheck'] = cleanStr($data['deceasedInCheck']);
            $data['deceasedProvinceCheck'] = cleanStr($data['deceasedProvinceCheck']);
            $data['deceasedLocationCheck'] = cleanStr($data['deceasedLocationCheck']);
            $data['crematoriumCheck'] = cleanStr($data['crematoriumCheck']);
            $data['cremationDateCheck'] = cleanStr($data['cremationDateCheck']);
            $data['cremationDate'] = cleanStr($data['cremationDate']);
            $data['cremationDatePeriod'] = cleanStr($data['cremationDatePeriod']);
            $data['cremationDateSince'] = cleanStr($data['cremationDateSince']);
            $data['cremationDateUntil'] = cleanStr($data['cremationDateUntil']);
            $data['cremationTimeCheck'] = cleanStr($data['cremationTimeCheck']);
            $data['cremationTime'] = cleanStr($data['cremationTime']);
            $data['cremationTimePeriod'] = cleanStr($data['cremationTimePeriod']);
            $data['cremationTimeSince'] = cleanStr($data['cremationTimeSince']);
            $data['cremationTimeUntil'] = cleanStr($data['cremationTimeUntil']);
            $data['clientCheck'] = cleanStr($data['clientCheck']);
            $data['introductionCheck'] = cleanStr($data['introductionCheck']);
            $data['introduction'] = cleanStr($data['introduction']);
            $data['waitOnRoomCheck'] = cleanStr($data['waitOnRoomCheck']);
            $data['waitOnRoom'] = cleanStr($data['waitOnRoom']);
            $data['vaseBioCheck'] = cleanStr($data['vaseBioCheck']);
            $data['dateCheck'] = cleanStr($data['dateCheck']);
            $data['ID'] = cleanStr($data['ID']);

            if($data['date'] == ''){
                $data['date'] = 'null';
            }
            if($data['dateSince'] == ''){
                $data['dateSince'] = 'null';
            }
            if($data['dateUntil'] == ''){
                $data['dateUntil'] = 'null';
            }
            if($data['month'] == ''){
                $data['month'] = 0;
            }
            if($data['trimester'] == ''){
                $data['trimester'] = 0;
            }
            if($data['deceasedIn'] == ''){
                $data['deceasedIn'] = 'null';
            }
            if($data['deceasedProvinces'] == ''){
                $data['deceasedProvinces'] = 'null';
            }
            if($data['deceasedLocation'] == ''){
                $data['deceasedLocation'] = 'null';
            }
            if($data['crematorium'] == ''){
                $data['crematorium'] = 'null';
            }
            if($data['cremationDate'] == ''){
                $data['cremationDate'] = 'null';
            }
            if($data['cremationDateSince'] == ''){
                $data['cremationDateSince'] = 'null';
            }
            if($data['cremationDateUntil'] == ''){
                $data['cremationDateUntil'] = 'null';
            }
            if($data['cremationTime'] == ''){
                $data['cremationTime'] = 'null';
            }
            if($data['cremationTimeSince'] == ''){
                $data['cremationTimeSince'] = 'null';
            }
            if($data['cremationTimeUntil'] == ''){
                $data['cremationTimeUntil'] = 'null';
            }
            if($data['client'] == ''){
                $data['client'] = null;
            }

            $db->query("UPDATE  Statistics_Cremations
                        SET     name = '" . $data['name'] . "',
                                dateCheck = " . $data['dateCheck'] . ",
                                date = " . $data['date'] . ",
                                datePeriod = " . $data['datePeriod'] . ",
                                dateSince = " . $data['dateSince'] . ",
                                dateUntil = " . $data['dateUntil'] . ",
                                dateCheckLength = " . $data['dateCheckLength'] . ",
                                year = " . $data['year'] . ",
                                month = " . $data['month'] . ",
                                trimester = " . $data['trimester'] . ",
                                deceasedInCheck = " . $data['deceasedInCheck'] . ",
                                deceasedProvinceCheck = " . $data['deceasedProvinceCheck'] . ",
                                deceasedLocationCheck = " . $data['deceasedLocationCheck'] . ",
                                crematoriumCheck = " . $data['crematoriumCheck'] . ",
                                cremationDateCheck = " . $data['cremationDateCheck'] . ",
                                cremationDate = " . $data['cremationDate'] . ",
                                cremationDatePeriod = " . $data['cremationDatePeriod'] . ",
                                cremationDateSince = " . $data['cremationDateSince'] . ",
                                cremationDateUntil = " . $data['cremationDateUntil'] . ",
                                cremationTimeCheck = " . $data['cremationTimeCheck'] . ",
                                cremationTime = " . $data['cremationTime'] . ",
                                cremationTimePeriod = " . $data['cremationTimePeriod'] . ",
                                cremationTimeSince = " . $data['cremationTimeSince'] . ",
                                cremationTimeUntil = " . $data['cremationTimeUntil'] . ",
                                clientCheck = " . $data['clientCheck'] . ",
                                introductionCheck = " . $data['introductionCheck'] . ",
                                introduction = " . $data['introduction'] . ",
                                waitOnRoomCheck = " . $data['waitOnRoomCheck'] . ",
                                waitOnRoom = " . $data['waitOnRoom'] . ",
                                vaseBioCheck = " . $data['vaseBioCheck'] . ",
                                vaseBio = " . $data['dateCheck'] . "
                        WHERE   ID = " . $data['ID']);

            $db->query("DELETE FROM Statistics_Cremations_DeceasedIn
                        WHERE statisticsCremations = " . $data['ID']);
            
            if($data['deceasedIn'] != 'null'){
                foreach($data['deceasedIn'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Cremations_DeceasedIn(statisticsCremations, deceasedIn)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_Cremations_DeceasedProvince
                        WHERE statisticsCremations = " . $data['ID']);
            
            if($data['deceasedProvince'] != 'null'){
                foreach($data['deceasedProvince'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Cremations_DeceasedProvince(statisticsCremations, deceasedProvince)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_Cremations_DeceasedLocation
                        WHERE statisticsCremations = " . $data['ID']);
            
            if($data['deceasedLocation'] != 'null'){
                foreach($data['deceasedLocation'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Cremations_DeceasedLocation(statisticsCremations, deceasedLocation)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_Cremations_Crematorium
                        WHERE statisticsCremations = " . $data['ID']);
            
            if($data['crematorium'] != 'null'){
                foreach($data['crematorium'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Cremations_Crematorium(statisticsCremations, crematorium)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_Cremations_Client
                        WHERE statisticsCremations = " . $data['ID']);
            
            if($data['client'] != 'null'){
                foreach($data['client'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Cremations_Client(statisticsCremations, client)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            return true;
        }

        /**
         * Elimina una plantilla
         * 
         * @param int $id Id de la plantilla
         * @return bool
         */
        public function cremationsDelete($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            return $db->query(" UPDATE  Statistics_Cremations
                                SET     leavingDate = " . time() . "
                                WHERE   ID = $id");
        }

        /**
         * Obtiene el ID dado el extraID
         * 
         * @param string $extraID ExtraID
         * @return int
         */
        public function cremationsGetIdByExtraId($extraID){
            $db = new DbHandler;

            $extraID = cleanStr($extraID);

            $result = $db->query("  SELECT  ID
                                    FROM    Statistics_Cremations
                                    WHERE   extraID = '$extraID'");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['ID'];
        }

        /**
         * Obtiene las plantillas de asistencias
         * 
         * @return array Plantillas
         */
        public function cremationsSearchTemplates(){
            $db = new DbHandler;

            $result = $db->query("  SELECT  ID, name
                                    FROM    Statistics_Cremations
                                    WHERE   leavingDate IS NULL");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }

        /* **************** CREMACIONES **************** */
        /**
         * Crea una plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function literalsCreate($data){
            $db = new DbHandler;

            $data['name'] = cleanStr($data['name']);
            $data['dateCheck'] = cleanStr($data['dateCheck']);
            $data['date'] = cleanStr($data['date']);
            $data['datePeriod'] = cleanStr($data['datePeriod']);
            $data['dateCheckLength'] = cleanStr($data['dateCheckLength']);
            $data['year'] = cleanStr($data['year']);
            $data['month'] = cleanStr($data['month']);
            $data['trimester'] = cleanStr($data['trimester']);
            $data['clientTypeCheck'] = cleanStr($data['clientTypeCheck']);
            $data['clientCheck'] = cleanStr($data['clientCheck']);
            $data['registerCheck'] = cleanStr($data['registerCheck']);
            $data['mortuaryCheck'] = cleanStr($data['mortuaryCheck']);
            $data['cemeteryCheck'] = cleanStr($data['cemeteryCheck']);

            $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

            $result = $db->query("  SELECT  * 
                                    FROM    Statistics_Literals 
                                    WHERE   extraID = '$extraID'");

            while(mysqli_num_rows($result) > 0){
                $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

                $result = $db->query("  SELECT  * 
                                        FROM    Statistics_Literals 
                                        WHERE   extraID = '$extraID'");
            }

            if($data['date'] == ''){
                $data['date'] = 'null';
            }
            if($data['dateSince'] == ''){
                $data['dateSince'] = 'null';
            }
            if($data['dateUntil'] == ''){
                $data['dateUntil'] = 'null';
            }
            if($data['month'] == ''){
                $data['month'] = 0;
            }
            if($data['trimester'] == ''){
                $data['trimester'] = 0;
            }

            $db->query("INSERT INTO Statistics_Literals(name, dateCheck, date, datePeriod, dateSince, dateUntil,
                                                        dateCheckLength, year, month, trimester, clientTypeCheck,
                                                        clientCheck, registerCheck, mortuaryCheck, cemeteryCheck,
                                                        extraID)
                        VALUES ('" . $data['name'] . "', " . $data['dateCheck'] . ",
                                " . $data['date'] . ", " . $data['datePeriod'] . ",
                                " . $data['dateSince'] . ", " . $data['dateUntil'] . ",
                                " . $data['dateCheckLength'] . ", " . $data['year'] . ",
                                " . $data['month'] . ", " . $data['trimester'] . ",
                                " . $data['clientTypeCheck'] . ", " . $data['clientCheck'] . ",
                                " . $data['registerCheck'] . ", " . $data['mortuaryCheck'] . ",
                                " . $data['cemeteryCheck'] . ", '$extraID')");

            $id = $this->literalsGetIdByExtraId($extraID);

            if($data['clientType'] != null){
                foreach($data['clientType'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Literals_ClientsTypes(statisticsLiterals, clientType)
                                VALUES ($id, $elem)");
                }
            }

            if($data['client'] != null){
                foreach($data['client'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Literals_Clients(statisticsLiterals, client)
                                VALUES ($id, $elem)");
                }
            }

            if($data['register'] != null){
                foreach($data['register'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Literals_Registers(statisticsLiterals, register)
                                VALUES ($id, '$elem')");
                }
            }

            if($data['mortuary'] != null){
                foreach($data['mortuary'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Literals_Mortuaries(statisticsLiterals, mortuary)
                                VALUES ($id, $elem)");
                }
            }

            if($data['cemetery'] != null){
                foreach($data['cemetery'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Literals_Cemeteries(statisticsLiterals, cemetery)
                                VALUES ($id, $elem)");
                }
            }

            return true;
        }

        /**
        * Obtiene las plantillas de confecciones por nombre
        *
        * @param string $name
        *
        * @return array
        */
        public function searchMakingByName($name){
            $db = new DbHandler;

            $name = cleanStr($name);
            
            $result = $db->query("  SELECT  sm.ID, sm.name
                                    FROM    Statistics_Making sm
                                    WHERE   sm.leavingDate IS NULL AND
                                            sm.name LIKE '%$name%'");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result);
            }
        }

        /**
        * Obtiene las plantillas de confecciones por nombre
        *
        * @param string $name
        *
        * @return array
        */
        public function searchGeneralByName($name){
            $db = new DbHandler;

            $name = cleanStr($name);
            
            $result = $db->query("  SELECT  sg.ID, sg.name
                                    FROM    Statistics_General sg
                                    WHERE   sg.leavingDate IS NULL AND
                                            sg.name LIKE '%$name%'");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result);
            }
        }

        /**
        * Obtiene las plantillas de destino de difuntos por nombre
        *
        * @param string $name
        *
        * @return array
        */
        public function searchDeceasedDestinationByName($name){
            $db = new DbHandler;

            $name = cleanStr($name);
            
            $result = $db->query("  SELECT  sd.ID, sd.name
                                    FROM    Statistics_DeceasedDestination sd
                                    WHERE   sd.leavingDate IS NULL AND
                                            sd.name LIKE '%$name%'");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result);
            }
        }

        /**
        * Obtiene las plantillas de edad media por nombre
        *
        * @param string $name
        *
        * @return array
        */
        public function searchMiddleAgeByName($name){
            $db = new DbHandler;

            $name = cleanStr($name);
            
            $result = $db->query("  SELECT  sma.ID, sma.name
                                    FROM    Statistics_MiddleAge sma
                                    WHERE   sma.leavingDate IS NULL AND
                                            sma.name LIKE '%$name%'");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result);
            }
        }

        /**
        * Obtiene las plantillas de uso de tanatorio por nombre
        *
        * @param string $name
        *
        * @return array
        */
        public function searchMortuaryUseByName($name){
            $db = new DbHandler;

            $name = cleanStr($name);
            
            $result = $db->query("  SELECT  smu.ID, smu.name
                                    FROM    Statistics_MortuaryUse smu
                                    WHERE   smu.leavingDate IS NULL AND
                                            smu.name LIKE '%$name%'");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result);
            }
        }

        /**
        * Obtiene las plantillas de uso de tanatorio por nombre
        *
        * @param string $name
        *
        * @return array
        */
        public function searchGasoilYearsByName(){
            $db = new DbHandler;
            
            $result = $db->query("SELECT DISTINCT YEAR(`start`) as mounth 
                                  FROM Events WHERE cremation = 1 AND leavingDate IS NULL");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result);
            }
        }

        /**
        * Obtiene las plantillas de control de mando por nombre
        *
        * @param string $name
        *
        * @return array
        */
        public function searchControlPanelByName($name){
            $db = new DbHandler;

            $name = cleanStr($name);
            
            $result = $db->query("  SELECT  scp.ID, scp.name
                                    FROM    Statistics_ControlPanel scp
                                    WHERE   scp.leavingDate IS NULL AND
                                            scp.name LIKE '%$name%'");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result);
            }
        }

        /**
        * Obtiene las plantillas de control de mando por nombre
        *
        * @param string $name
        *
        * @return array
        */
        public function searchPollsByName($name){
            $db = new DbHandler;

            $name = cleanStr($name);
            
            $result = $db->query("  SELECT  scp.ID, scp.name
                                    FROM    Statistics_Polls scp
                                    WHERE   scp.leavingDate IS NULL AND
                                            scp.name LIKE '%$name%'");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result);
            }
        }

        /**
        * Obtiene las plantillas de rendimiento economico por nombre
        *
        * @param string $name
        *
        * @return array
        */
        public function searchEconomicPerformanceByName($name){
            $db = new DbHandler;

            $name = cleanStr($name);
            
            $result = $db->query("  SELECT  sep.ID, sep.name
                                    FROM    Statistics_EconomicPerformance sep
                                    WHERE   sep.leavingDate IS NULL AND
                                            sep.name LIKE '%$name%'");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result);
            }
        }

        /**
        * Obtiene las plantillas de horarios de servicios por nombre
        *
        * @param string $name
        *
        * @return array
        */
        public function searchServicesTimesByName($name){
            $db = new DbHandler;

            $name = cleanStr($name);
            
            $result = $db->query("  SELECT  sst.ID, sst.name
                                    FROM    Statistics_ServicesTimes sst
                                    WHERE   sst.leavingDate IS NULL AND
                                            sst.name LIKE '%$name%'");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result);
            }
        }

        /**
         * Crea una plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function makingCreate($data){
            $db = new DbHandler;
    
            $data['name'] = cleanStr($data['name']);
            $data['date'] = cleanStr($data['date']);
            $data['dateSince'] = cleanStr($data['dateSince']);
            $data['dateUntil'] = cleanStr($data['dateUntil']);
            $data['birthdateDate'] = cleanStr($data['birthdateDate']);
            $data['deceasedDate'] = cleanStr($data['deceasedDate']);
            $data['birthdateSince'] = cleanStr($data['birthdateSince']);
            $data['birthdateUntil'] = cleanStr($data['birthdateUntil']);
            $data['deathSince'] = cleanStr($data['deathSince']);
            $data['deathUntil'] = cleanStr($data['deathUntil']);
            $data['tribunal'] = cleanStr($data['tribunal']);
            $data['deceasedRoom'] = cleanStr($data['deceasedRoom']);

            $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

            $result = $db->query("  SELECT  * 
                                    FROM    Statistics_Making 
                                    WHERE   extraID = '$extraID'");

            while(mysqli_num_rows($result) > 0){
                $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

                $result = $db->query("  SELECT  * 
                                        FROM    Statistics_Making 
                                        WHERE   extraID = '$extraID'");
            }

            if($data['date'] == ''){
                $data['date'] = 'null';
                $dateCheck = '0';
            }else{
                $dateCheck = '1';
            }
        
            if($data['dateSince'] == ''){
                $data['dateSince'] = 'null';
                $datePeriod = '0';
            }else{
                $datePeriod = '1';
            }
            if($data['dateUntil'] == ''){
                $data['dateUntil'] = 'null';
            }

            if($data['birthdateDate'] == ''){
                $data['birthdateDate'] = 'null';
                $birthdayCheck = 0;
            }else{
                $birthdayCheck = 1;
            }
            if($data['birthdateSince'] == ''){
                $data['birthdateSince'] = 'null';
                $birthdayPeriod = 0;
            }else{
                $birthdayPeriod = 1;
            }
            if($data['birthdateUntil'] == ''){
                $data['birthdateUntil'] = 'null';
            }

            if($data['deceasedDate'] == ''){
                $data['deceasedDate'] = 'null';
                $deathCheck = 0;
            }else{
                $deathCheck = 1;
            }
   
            if($data['deathSince'] == ''){
                $data['deathSince'] = 'null';
                $deathPeriod = 0;
            }else{
                $deathPeriod = 1;
            }
            if($data['deathUntil'] == ''){
                $data['deathUntil'] = 'null';
            }
   
            if($data['tribunal'] == ''){
                $data['tribunal'] = 'null';
            }
    
            if($data['deceasedRoom'] == ''){
                $data['deceasedRoom'] = 'null';
            }
            
            $db->query("INSERT INTO Statistics_Making( `name`, `dateCheck`, `date`, `datePeriod`, `dateSince`, `dateUntil`, `birthdayCheck`, 
                                                        `birthdateDate`, `birthdayPeriod`, `birthdaySince`, `birthdayUntil`, `deathCheck`, 
                                                        `deceasedDate`, `deathPeriod`, `deathSince`, `deathUntil`, `tribunal`, `deceasedRoom`, `extraID`)
                        VALUES ('" . $data['name'] . "', " . $dateCheck .",
                                " . $data['date'] . ", " . $datePeriod . ",
                                " . $data['dateSince'] . ", " . $data['dateUntil'] . ",
                                " . $birthdayCheck . ", " . $data['birthdateDate'] . ",
                                " . $birthdayPeriod. ", " . $data['birthdateSince'] . ", " . $data['birthdateUntil'] . ", 
                                " . $deathCheck. ", " . $data['deceasedDate'] . ",  " . $deathPeriod. ", " . $data['deathSince'] . ", " . $data['deathUntil'] . ",
                                " . $data['tribunal'] . ",
                                " . $data['deceasedRoom'] . ", '" . $extraID . "')");

            $id = $this->makingGetIdByExtraId($extraID);

    
            if($data['clientType'] != ""){
                foreach($data['clientType'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Making_TypeClients(making, typeClient)
                                VALUES ($id, $elem)");
                }
            }

            if($data['client'] != ""){
                foreach($data['client'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Making_Clients(making, client)
                                VALUES ($id, $elem)");
                }
            }

            if($data['doctor'] != ""){
                foreach($data['doctor'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Making_Doctor(making, doctor)
                                VALUES ($id, $elem)");
                }
            }

            if($data['mortuary'] != ""){
                foreach($data['mortuary'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Making_Mortuary(making, mortuary)
                                VALUES ($id, $elem)");
                }
            }

            if($data['deathLocation'] != ""){
                foreach($data['deathLocation'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Making_DeathLocation (making, location)
                                VALUES ($id, $elem)");
                }
            }

            if($data['expedientTypes'] != ""){
                foreach($data['expedientTypes'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Making_Expedient_Type (making, type)
                                VALUES ($id, $elem)");
                }
            }

            return true;
        }

        /**
         * Crea una plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function deceasedDestinationCreate($data){
            $db = new DbHandler;
    
            $data['name'] = cleanStr($data['name']);
            $data['deceasedDateSince'] = cleanStr($data['deceasedDateSince']);
            $data['deceasedDateUntil'] = cleanStr($data['deceasedDateUntil']);
            $data['gender'] = cleanStr($data['gender']);

            $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

            $result = $db->query("  SELECT  * 
                                    FROM    Statistics_DeceasedDestination 
                                    WHERE   extraID = '$extraID'");

            while(mysqli_num_rows($result) > 0){
                $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

                $result = $db->query("  SELECT  * 
                                        FROM    Statistics_DeceasedDestination 
                                        WHERE   extraID = '$extraID'");
            }

            if($data['deceasedDateSince'] == ''){
                $data['deceasedDateSince'] = 'null';
                $dateCheck = '0';
            }else{
                $dateCheck = '1';
            }
            if($data['deceasedDateUntil'] == ''){
                $data['deceasedDateUntil'] = 'null';
            }

            if($data['gender'] == ''){
                $data['gender'] = 'null';
                $genderCheck = 0;
            }else{
                $genderCheck = 1;
            }
  
            $db->query("INSERT INTO Statistics_DeceasedDestination( `name`, `dateCheck`, `dateSince`, `dateUntil`, 
                                                        `sexCheck`, `sex`, `extraID`)
                        VALUES ('" . $data['name'] . "', " . $dateCheck .",
                                " .  $data['deceasedDateSince'] . ", " .  $data['deceasedDateUntil'] . ",
                                " . $genderCheck . ", '" . $data['gender'] . "', '" . $extraID . "')");

            $id = $this->deceasedDestinationGetIdByExtraId($extraID);

    
            if($data['clientType'] != ""){
                foreach($data['clientType'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_DeceasedDestination_ClientType(deceasedDestination, clientType)
                                VALUES ($id, $elem)");
                }
            }

            if($data['client'] != ""){
                foreach($data['client'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_DeceasedDestination_Client(deceasedDestination, client)
                                VALUES ($id, $elem)");
                }
            }

            if($data['church'] != ""){
                foreach($data['church'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_DeceasedDestination_Church(deceasedDestination, church)
                                VALUES ($id, $elem)");
                }
            }

            if($data['mortuary'] != ""){
                foreach($data['mortuary'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_DeceasedDestination_Mortuary(deceasedDestination, mortuary)
                                VALUES ($id, $elem)");
                }
            }

            if($data['crematorium'] != ""){
                foreach($data['crematorium'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_DeceasedDestination_Crematorium(deceasedDestination, crematorium)
                                VALUES ($id, $elem)");
                }
            }

            if($data['cemetery'] != ""){
                foreach($data['cemetery'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_DeceasedDestination_Cemetery(deceasedDestination, cemetery)
                                VALUES ($id, $elem)");
                }
            }

            if($data['deceasedIn'] != ""){
                foreach($data['deceasedIn'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_DeceasedDestination_DeceasedIn(deceasedDestination, deceasedIn)
                                VALUES ($id, $elem)");
                }
            }

            if($data['location'] != ""){
                foreach($data['location'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_DeceasedDestination_Location(deceasedDestination, `location`)
                                VALUES ($id, $elem)");
                }
            }
            return true;
        }

        /**
         * Crea una plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function middleAgeCreate($data){
            $db = new DbHandler;
    
            $data['name'] = cleanStr($data['name']);
            $data['deceasedDateSince'] = cleanStr($data['deceasedDateSince']);
            $data['deceasedDateUntil'] = cleanStr($data['deceasedDateUntil']);
            $data['dateParticularSince'] = cleanStr($data['dateParticularSince']);
            $data['dateParticularUntil'] = cleanStr($data['dateParticularUntil']);
            $data['dateSeguroSince'] = cleanStr($data['dateSeguroSince']);
            $data['dateSeguroUntil'] = cleanStr($data['dateSeguroUntil']);
            $data['dateEmpresaSince'] = cleanStr($data['dateEmpresaSince']);
            $data['dateEmpresaUntil'] = cleanStr($data['dateEmpresaUntil']);

            $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

            $result = $db->query("  SELECT  * 
                                    FROM    Statistics_MiddleAge 
                                    WHERE   extraID = '$extraID'");

            while(mysqli_num_rows($result) > 0){
                $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

                $result = $db->query("  SELECT  * 
                                        FROM    Statistics_MiddleAge 
                                        WHERE   extraID = '$extraID'");
            }

            if($data['deceasedDateSince'] == ''){
                $data['deceasedDateSince'] = 'null';
                $dateCheck = '0';
            }else{
                $dateCheck = '1';
            }
            if($data['deceasedDateUntil'] == ''){
                $data['deceasedDateUntil'] = 'null';
            }

            if($data['gender'] == ''){
                $data['gender'] = 'null';
                $genderCheck = 0;
            }else{
                $genderCheck = 1;
            }

            if($data['dateParticularSince'] == ''){
                $data['dateParticularSince'] = 'null';
                $periodParticularCheck = '0';
            }else{
                $periodParticularCheck = '1';
            }
            if($data['dateParticularUntil'] == ''){
                $data['dateParticularUntil'] = 'null';
            }

            if($data['dateSeguroSince'] == ''){
                $data['dateSeguroSince'] = 'null';
                $periodInsuranceCheck = '0';
            }else{
                $periodInsuranceCheck = '1';
            }
            if($data['dateSeguroUntil'] == ''){
                $data['dateSeguroUntil'] = 'null';
            }

            if($data['dateEmpresaSince'] == ''){
                $data['dateEmpresaSince'] = 'null';
                $periodCompanyCheck = '0';
            }else{
                $periodCompanyCheck = '1';
            }
            if($data['dateEmpresaUntil'] == ''){
                $data['dateEmpresaUntil'] = 'null';
            }
  
            $db->query("INSERT INTO Statistics_MiddleAge( `name`, `dateCheck`, `dateSince`, `dateUntil`, 
                                                        `genderCheck`, `gender`, `periodParticularCheck`, `periodParticularSince`, `periodParticularUntil`,
                                                        `periodInsuranceCheck`, `periodInsuranceSince`, `periodInsuranceUntil`, `periodCompanyCheck`, 
                                                        `periodCompanySince`, `periodCompanyUntil`, `extraID`)
                        VALUES ('" . $data['name'] . "', " . $dateCheck .",
                                " .  $data['deceasedDateSince'] . ", " .  $data['deceasedDateUntil'] . ",
                                " . $genderCheck . ", '" . $data['gender'] . "',
                                " . $periodParticularCheck ."," .  $data['dateParticularSince'] . ", " .  $data['dateParticularUntil'] . ",
                                " . $periodInsuranceCheck ."," .  $data['dateSeguroSince'] . ", " .  $data['dateSeguroUntil'] . ",
                                " . $periodCompanyCheck ."," .  $data['dateEmpresaSince'] . ", " .  $data['dateEmpresaUntil'] . ",
                                '" . $extraID . "')");

            $id = $this->middleAgeGetIdByExtraId($extraID);

    
            if($data['clientType'] != ""){
                foreach($data['clientType'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_MiddleAge_ClientType(middleAge, clientType)
                                VALUES ($id, $elem)");
                }
            }

            if($data['client'] != ""){
                foreach($data['client'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_MiddleAge_Client(middleAge, client)
                                VALUES ($id, $elem)");
                }
            }

            if($data['civilStatus'] != ""){
                foreach($data['civilStatus'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_MiddleAge_CivilStatus(middleAge, civilStatus)
                                VALUES ($id, '$elem')");
                }
            }

            return true;
        }


        /**
         * Crea una plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function generalCreate($data){
            $db = new DbHandler;
    
            $data['name'] = cleanStr($data['name']);
            $data['year'] = cleanStr($data['year']);
            $data['month'] = cleanStr($data['month']);
            $data['trimester'] = cleanStr($data['trimester']);
            $data['dateFrom'] = cleanStr($data['dateFrom']);
            $data['dateTo'] = cleanStr($data['dateTo']);
            $data['yearCompare'] = cleanStr($data['yearCompare']);
            $data['monthCompare'] = cleanStr($data['monthCompare']);
            $data['trimesterCompare'] = cleanStr($data['trimesterCompare']);
            $data['dateFromCompare'] = cleanStr($data['dateFromCompare']);
            $data['dateToCompare'] = cleanStr($data['dateToCompare']);

            if($data['year'] == null){
                $data['year'] = ' null';
            }
            if($data['month'] == null){
                $data['month'] = ' null';
            }
            if($data['trimester'] == null){
                $data['trimester'] = ' null';
            }
            if($data['dateFrom'] == null){
                $data['dateFrom'] = ' null';
            }
            if($data['dateTo'] == null){
                $data['dateTo'] = ' null';
            }
            if($data['yearCompare'] == null){
                $data['yearCompare'] = ' null';
            }
            if($data['monthCompare'] == null){
                $data['monthCompare'] = ' null';
            }
            if($data['trimesterCompare'] == null){
                $data['trimesterCompare'] = ' null';
            }
            if($data['dateFromCompare'] == null){
                $data['dateFromCompare'] = ' null';
            }
            if($data['dateToCompare'] == null){
                $data['dateToCompare'] = ' null';
            }
            
            $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

            $result = $db->query("  SELECT  * 
                                    FROM    Statistics_General 
                                    WHERE   extraID = '$extraID'");

            if($result != false){
                while(mysqli_num_rows($result) > 0){
                    $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

                    $result = $db->query("  SELECT  * 
                                            FROM    Statistics_General 
                                            WHERE   extraID = '$extraID'");
                }
            }

            $db->query("INSERT INTO Statistics_General( `name`, `year`, `month`, `trimester`, 
                                                        `dateFrom`, `dateUntil`, `yearCompare`, `monthCompare`, `trimesterCompare`, 
                                                        `dateFromCompare`, `dateUntilCompare`, `extraID`)
                        VALUES ('" . $data['name'] . "', " .  $data['year'] . ", " .  $data['month'] . ", " .  $data['trimester'] . ",
                                " .  $data['dateFrom'] . ",   " .  $data['dateTo'] . ",
                                " .  $data['yearCompare'] . ", " .  $data['monthCompare'] . ", " .  $data['trimesterCompare'] . ",
                                " .  $data['dateFromCompare'] . ",   " .  $data['dateToCompare'] . ",
                                '" . $extraID . "')");

            $id = $this->generalGetIdByExtraId($extraID);

    
            if($data['products'] != ""){
                foreach($data['products'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_General_Product(general, product)
                                VALUES ($id, $elem)");
                }
            }

            if($data['mortuaries'] != ""){
                foreach($data['mortuaries'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_General_Mortuary(general, mortuary)
                                VALUES ($id, $elem)");
                }
            }

            if($data['productsCompare'] != ""){
                foreach($data['productsCompare'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_GeneralCompare_Product(general, product)
                                VALUES ($id, $elem)");
                }
            }

            if($data['mortuariesCompare'] != ""){
                foreach($data['mortuariesCompare'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_GeneralCompare_Mortuary(general, mortuary)
                                VALUES ($id, $elem)");
                }
            }

            return true;
        }

        /**
         * Crea una plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function mortuaryUseCreate($data){
            $db = new DbHandler;
    
            $data['name'] = cleanStr($data['name']);
            $data['stayDateSince'] = cleanStr($data['stayDateSince']);
            $data['stayDateUntil'] = cleanStr($data['stayDateUntil']);
            $data['stayTimeSince'] = cleanStr($data['stayTimeSince']);
            $data['stayTimeUntil'] = cleanStr($data['stayTimeUntil']);
            $data['daySince'] = cleanStr($data['daySince']);
            $data['dayUntil'] = cleanStr($data['dayUntil']);
            $data['deceasedRoom'] = cleanStr($data['deceasedRoom']);
            $data['dateParticularSince'] = cleanStr($data['dateParticularSince']);
            $data['dateParticularUntil'] = cleanStr($data['dateParticularUntil']);
            $data['dateSeguroSince'] = cleanStr($data['dateSeguroSince']);
            $data['dateSeguroUntil'] = cleanStr($data['dateSeguroUntil']);
            $data['dateEmpresaSince'] = cleanStr($data['dateEmpresaSince']);
            $data['dateEmpresaUntil'] = cleanStr($data['dateEmpresaUntil']);
           
            $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

            $result = $db->query("  SELECT  * 
                                    FROM    Statistics_MortuaryUse
                                    WHERE   extraID = '$extraID'");

            while(mysqli_num_rows($result) > 0){
                $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

                $result = $db->query("  SELECT  * 
                                        FROM    Statistics_MortuaryUse 
                                        WHERE   extraID = '$extraID'");
            }

            if($data['stayDateSince'] == ''){
                $data['stayDateSince'] = 'null';
                $dateCheck = '0';
            }else{
                $dateCheck = '1';
            }
            if($data['stayDateUntil'] == ''){
                $data['stayDateUntil'] = 'null';
            }

            if($data['stayTimeSince'] == ''){
                $data['stayTimeSince'] = 'null';
                $timeCheck = '0';
            }else{
                $timeCheck = '1';
            }
            if($data['stayTimeUntil'] == ''){
                $data['stayTimeUntil'] = 'null';
            }

            if($data['daySince'] == ''){
                $data['daySince'] = 'null';
                $dayCheck = '0';
            }else{
                $dayCheck = '1';
            }
            if($data['dayUntil'] == ''){
                $data['dayUntil'] = 'null';
            }

            if($data['deceasedRoom'] == ''){
                $data['deceasedRoom'] = 'null';
                $deceasedRoomCheck = 0;
            }else{
                $deceasedRoomCheck = 1;
            }

            if($data['dateParticularSince'] == ''){
                $data['dateParticularSince'] = 'null';
                $periodParticularCheck = '0';
            }else{
                $periodParticularCheck = '1';
            }
            if($data['dateParticularUntil'] == ''){
                $data['dateParticularUntil'] = 'null';
            }

            if($data['dateSeguroSince'] == ''){
                $data['dateSeguroSince'] = 'null';
                $periodInsuranceCheck = '0';
            }else{
                $periodInsuranceCheck = '1';
            }
            if($data['dateSeguroUntil'] == ''){
                $data['dateSeguroUntil'] = 'null';
            }

            if($data['dateEmpresaSince'] == ''){
                $data['dateEmpresaSince'] = 'null';
                $periodCompanyCheck = '0';
            }else{
                $periodCompanyCheck = '1';
            }
            if($data['dateEmpresaUntil'] == ''){
                $data['dateEmpresaUntil'] = 'null';
            }
  
            $db->query("INSERT INTO Statistics_MortuaryUse( `name`, `dateCheck`, `dateSince`, `dateUntil`, `timeCheck`, `timeSince`, `timeUntil`,
                                                        `weekDayCheck`, `weekDaySince`, `weekDayUntil`,`salaCheck`, `sala`, `periodParticularCheck`, `periodParticularSince`, `periodParticularUntil`,
                                                        `periodInsuranceCheck`, `periodInsuranceSince`, `periodInsuranceUntil`, `periodCompanyCheck`, 
                                                        `periodCompanySince`, `periodCompanyUntil`, `extraID`)
                        VALUES ('" . $data['name'] . "', " . $dateCheck ."," .  $data['stayDateSince'] . ", " .  $data['stayDateUntil'] . ",
                                " . $timeCheck .", '" .  $data['stayTimeSince'] . "', '" .  $data['stayTimeUntil'] . "',
                                " . $dayCheck .",'" .  $data['daySince'] . "', '" .  $data['dayUntil'] . "',
                                " . $deceasedRoomCheck . ", " . $data['deceasedRoom'] . ",
                                " . $periodParticularCheck ."," .  $data['dateParticularSince'] . ", " .  $data['dateParticularUntil'] . ",
                                " . $periodInsuranceCheck ."," .  $data['dateSeguroSince'] . ", " .  $data['dateSeguroUntil'] . ",
                                " . $periodCompanyCheck ."," .  $data['dateEmpresaSince'] . ", " .  $data['dateEmpresaUntil'] . ",
                                '" . $extraID . "')");

            $id = $this->mortuaryUseGetIdByExtraId($extraID);

    
            if($data['clientType'] != ""){
                foreach($data['clientType'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_MortuaryUse_ClientType(mortuaryUse, clientType)
                                VALUES ($id, $elem)");
                }
            }

            if($data['client'] != ""){
                foreach($data['client'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_MortuaryUse_Client(mortuaryUse, client)
                                VALUES ($id, $elem)");
                }
            }

            if($data['mortuary'] != ""){
                foreach($data['mortuary'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_MortuaryUse_Mortuary(mortuaryUse, mortuary)
                                VALUES ($id, $elem)");
                }
            }

            return true;
        }

        /**
         * Crea una plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function controlPanelCreate($data){
            $db = new DbHandler;
    
            $data['name'] = cleanStr($data['name']);
            $data['date'] = cleanStr($data['date']);
            $data['dateSince'] = cleanStr($data['dateSince']);
            $data['dateUntil'] = cleanStr($data['dateUntil']);
    
           
            $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

            $result = $db->query("  SELECT  * 
                                    FROM    Statistics_ControlPanel
                                    WHERE   extraID = '$extraID'");

            while(mysqli_num_rows($result) > 0){
                $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

                $result = $db->query("  SELECT  * 
                                        FROM    Statistics_ControlPanel 
                                        WHERE   extraID = '$extraID'");
            }

            if($data['date'] == ''){
                $data['date'] = 'null';
                $dateCheck = '0';
            }else{
                $dateCheck = '1';
            }
          
            if($data['dateSince'] == ''){
                $data['dateSince'] = 'null';
                $datePeriod = '0';
            }else{
                $datePeriod = '1';
            }
            if($data['dateUntil'] == ''){
                $data['dateUntil'] = 'null';
            }
  
            $db->query("INSERT INTO Statistics_ControlPanel( `name`, `dateCheck`, `date`, `datePeriod`, `dateSince`, `dateUntil`, `extraID`)
                        VALUES ('" . $data['name'] . "', " . $dateCheck ."," .  $data['date'] . ", "  . $datePeriod ."," .  $data['dateSince'] . ", " .  $data['dateUntil'] . ",
                                '" . $extraID . "')");
            $id = $this->controlPanelGetIdByExtraId($extraID);
    
            if($data['clientType'] != ""){
                foreach($data['clientType'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_ControlPanel_ClientType(controlPanel, clientType)
                                VALUES ($id, $elem)");
                }
            }

            if($data['client'] != ""){
                foreach($data['client'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_ControlPanel_Client(controlPanel, client)
                                VALUES ($id, $elem)");
                }
            }

            if($data['mortuary'] != ""){
                foreach($data['mortuary'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_ControlPanel_Mortuary(controlPanel, mortuary)
                                VALUES ($id, $elem)");
                }
            }

            return true;
        }

        /**
         * Crea una plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function pollsCreate($data){
            $db = new DbHandler;
    
            $data['name'] = cleanStr($data['name']);
            $data['dateSince'] = cleanStr($data['dateSince']);
            $data['dateUntil'] = cleanStr($data['dateUntil']);
           
            $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

            $result = $db->query("  SELECT  * 
                                    FROM    Statistics_Polls
                                    WHERE   extraID = '$extraID'");

            while(mysqli_num_rows($result) > 0){
                $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

                $result = $db->query("  SELECT  * 
                                        FROM    Statistics_Polls 
                                        WHERE   extraID = '$extraID'");
            }
          
            if($data['dateSince'] == ''){
                $data['dateSince'] = 'null';
                $datePeriod = '0';
            }else{
                $datePeriod = '1';
            }
            if($data['dateUntil'] == ''){
                $data['dateUntil'] = 'null';
            }
  
            $db->query("INSERT INTO Statistics_Polls( `name`, `datePeriod`, `dateSince`, `dateUntil`, `extraID`)
                        VALUES ('" . $data['name'] . "', "  . $datePeriod ."," .  $data['dateSince'] . ", " .  $data['dateUntil'] . ",
                                '" . $extraID . "')");
            $id = $this->pollGetIdByExtraId($extraID);
    
            if($data['clientType'] != ""){
                foreach($data['clientType'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Polls_ClientType(poll, clientType)
                                VALUES ($id, $elem)");
                }
            }

            if($data['client'] != ""){
                foreach($data['client'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Polls_Client(poll, client)
                                VALUES ($id, $elem)");
                }
            }

            if($data['mortuary'] != ""){
                foreach($data['mortuary'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Polls_Mortuary(poll, mortuary)
                                VALUES ($id, $elem)");
                }
            }

            if($data['poll'] != ""){
                foreach($data['poll'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Polls_Poll(poll, poll_selected)
                                VALUES ($id, $elem)");
                }
            }

            return true;
        }

        /**
         * Crea una plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function economicPerformanceCreate($data){
            $db = new DbHandler;
    
            $data['name'] = cleanStr($data['name']);
            $data['date'] = cleanStr($data['date']);
            $data['dateSince'] = cleanStr($data['dateSince']);
            $data['dateUntil'] = cleanStr($data['dateUntil']);
    
           
            $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

            $result = $db->query("  SELECT  * 
                                    FROM    Statistics_EconomicPerformance
                                    WHERE   extraID = '$extraID'");

            while(mysqli_num_rows($result) > 0){
                $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

                $result = $db->query("  SELECT  * 
                                        FROM    Statistics_EconomicPerformance 
                                        WHERE   extraID = '$extraID'");
            }

            if($data['date'] == ''){
                $data['date'] = 'null';
                $dateCheck = '0';
            }else{
                $dateCheck = '1';
            }
          
            if($data['dateSince'] == ''){
                $data['dateSince'] = 'null';
                $datePeriod = '0';
            }else{
                $datePeriod = '1';
            }
            if($data['dateUntil'] == ''){
                $data['dateUntil'] = 'null';
            }
  
            $db->query("INSERT INTO Statistics_EconomicPerformance( `name`, `dateCheck`, `date`, `datePeriod`, `dateSince`, `dateUntil`, `extraID`)
                        VALUES ('" . $data['name'] . "', " . $dateCheck ."," .  $data['date'] . ", "  . $datePeriod ."," .  $data['dateSince'] . ", " .  $data['dateUntil'] . ",
                                '" . $extraID . "')");
           
            return true;
        }

        /**
         * Crea una plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function servicesTimesCreate($data){
            $db = new DbHandler;
    
            $data['name'] = cleanStr($data['name']);
            $data['dateSince'] = cleanStr($data['dateSince']);
            $data['dateUntil'] = cleanStr($data['dateUntil']);

           
            $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

            $result = $db->query("  SELECT  * 
                                    FROM    Statistics_ServicesTimes
                                    WHERE   extraID = '$extraID'");

            while(mysqli_num_rows($result) > 0){
                $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

                $result = $db->query("  SELECT  * 
                                        FROM    Statistics_ServicesTimes 
                                        WHERE   extraID = '$extraID'");
            }

            if($data['dateSince'] == ''){
                $data['dateSince'] = 'null';
                $datePeriod = '0';
            }else{
                $datePeriod = '1';
            }
            if($data['dateUntil'] == ''){
                $data['dateUntil'] = 'null';
            }
  
            $db->query("INSERT INTO Statistics_ServicesTimes( `name`, `datePeriod`, `dateSince`, `dateUntil`, `extraID`)
                        VALUES ('" . $data['name'] . "', ". $datePeriod ."," .  $data['dateSince'] . ", " .  $data['dateUntil'] . ",
                                '" . $extraID . "')");
            $id = $this->servicesTimesGetIdByExtraId($extraID);
    
            if($data['users'] != ""){
                foreach($data['users'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_ServicesTimes_Users(serviceTime, user)
                                VALUES ($id, $elem)");
                }
            }
            if($data['carriers'] != ""){
                foreach($data['carriers'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_ServicesTimes_Carriers(serviceTime, carrier)
                                VALUES ($id, $elem)");
                }
            }
            return true;
        }

        /**
         * Elimina una plantilla
         * 
         * @param int $id Id de la plantilla
         * @return bool
         */
        public function servicesTimesDelete($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            return $db->query(" UPDATE  Statistics_ServicesTimes
                                SET     leavingDate = " . time() . "
                                WHERE   ID = $id");
        }

        /**
         * Obtiene los datos de la plantilla
         * 
         * @param int $id Id de la plantilla
         * @return array $data Datos de la plantilla
         */
        public function literalsRead($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            $result = $db->query("  SELECT  *
                                    FROM    Statistics_Literals
                                    WHERE   ID = $id");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $data = array();

                $literals = $db->resultToArray($result)[0];
                $data['literals'] = $literals;

                $result = $db->query("  SELECT  ct.clientTypeID as id, ct.name
                                        FROM    Statistics_Literals_ClientsTypes slc, Clients_Types ct
                                        WHERE   slc.clientType = ct.clientTypeID AND
                                                slc.statisticsLiterals = $id");

                if(mysqli_num_rows($result) == 0){
                    $clientType = null;
                }else{
                    $clientType = $db->resultToArray($result);
                }
                $data['clientType'] = $clientType;

                $result = $db->query("  SELECT  c.clientID as id, c.name
                                        FROM    Statistics_Literals_Clients slc, Clients c
                                        WHERE   slc.client = c.clientID AND
                                                slc.statisticsLiterals = $id");

                if(mysqli_num_rows($result) == 0){
                    $client = null;
                }else{
                    $client = $db->resultToArray($result);
                }
                $data['client'] = $client;

                $result = $db->query("  SELECT  slr.register
                                        FROM    Statistics_Literals_Registers slr
                                        WHERE   slr.statisticsLiterals = $id");

                if(mysqli_num_rows($result) == 0){
                    $register = null;
                }else{
                    $register = $db->resultToArray($result);
                }
                $data['register'] = $register;

                $result = $db->query("  SELECT  m.mortuaryID as id, m.name
                                        FROM    Statistics_Literals_Mortuaries slm, Mortuaries m
                                        WHERE   slm.mortuary = m.mortuaryID AND
                                                slm.statisticsLiterals = $id");

                if(mysqli_num_rows($result) == 0){
                    $mortuary = null;
                }else{
                    $mortuary = $db->resultToArray($result);
                }
                $data['mortuary'] = $mortuary;

                $result = $db->query("  SELECT  c.cemeteryID as id, c.name
                                        FROM    Statistics_Literals_Cemeteries slc, Cemeteries c
                                        WHERE   slc.cemetery = c.cemeteryID AND
                                                slc.statisticsLiterals = $id");

                if(mysqli_num_rows($result) == 0){
                    $cemetery = null;
                }else{
                    $cemetery = $db->resultToArray($result);
                }
                $data['cemetery'] = $cemetery;
            }

            return $data;
        }

        /**
         * Obtiene los datos de la plantilla
         * 
         * @param int $id Id de la plantilla
         * @return array $data Datos de la plantilla
         */
        public function makingRead($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            $result = $db->query("  SELECT  *
                                    FROM    Statistics_Making
                                    WHERE   ID = $id");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $data = array();

                $making = $db->resultToArray($result)[0];
                $data['making'] = $making;

                $result = $db->query("  SELECT  ct.clientTypeID as id, ct.name
                                        FROM    Statistics_Making_TypeClients slc, Clients_Types ct
                                        WHERE   slc.typeClient = ct.clientTypeID AND
                                                slc.making = $id");

                if(mysqli_num_rows($result) == 0){
                    $clientType = null;
                }else{
                    $clientType = $db->resultToArray($result);
                }
                $data['clientType'] = $clientType;

                $result = $db->query("  SELECT  c.clientID as id, c.name
                                        FROM    Statistics_Making_Clients slc, Clients c
                                        WHERE   slc.client = c.clientID AND
                                                slc.making = $id");

                if(mysqli_num_rows($result) == 0){
                    $client = null;
                }else{
                    $client = $db->resultToArray($result);
                }
                $data['client'] = $client;

                $result = $db->query("  SELECT  d.ID as id, d.name
                                        FROM    Statistics_Making_Doctor slm, Doctors d
                                        WHERE   slm.doctor = d.ID AND
                                                slm.making = $id");

                if(mysqli_num_rows($result) == 0){
                    $doctor = null;
                }else{
                    $doctor = $db->resultToArray($result);
                }
                $data['doctor'] = $doctor;

                $result = $db->query("  SELECT  d.mortuaryID as id, d.name
                                        FROM    Statistics_Making_Mortuary slm, Mortuaries d
                                        WHERE   slm.mortuary = d.mortuaryID AND
                                                slm.making = $id");

                if(mysqli_num_rows($result) == 0){
                    $mortuary = null;
                }else{
                    $mortuary = $db->resultToArray($result);
                }
                $data['mortuary'] = $mortuary;


                $result = $db->query("  SELECT  d.deceasedInID as id, d.name
                                        FROM    Statistics_Making_DeathLocation slm, DeceasedIn d
                                        WHERE   slm.location = d.deceasedInID AND
                                                slm.making = $id");

                if(mysqli_num_rows($result) == 0){
                    $location = null;
                }else{
                    $location = $db->resultToArray($result);
                }
                $data['location'] = $location;


                $result = $db->query("  SELECT  et.expedientTypeID as id, et.name
                                        FROM    Statistics_Making_Expedient_Type smet, Expedients_Types et
                                        WHERE   smet.type = et.expedientTypeID AND
                                                smet.making = $id");

                if(mysqli_num_rows($result) == 0){
                    $expedientTypes = null;
                }else{
                    $expedientTypes = $db->resultToArray($result);
                }
                $data['expedientTypes'] = $expedientTypes;
            }

            return $data;
        }

        /**
         * Obtiene los datos de la plantilla
         * 
         * @param int $id Id de la plantilla
         * @return array $data Datos de la plantilla
         */
        public function deceseadedDestinationRead($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            $result = $db->query("  SELECT  *
                                    FROM    Statistics_DeceasedDestination
                                    WHERE   ID = $id");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $data = array();

                $deceasedDestination = $db->resultToArray($result)[0];
                $data['deceasedDestinationData'] = $deceasedDestination;

                $result = $db->query("  SELECT  d.deceasedInID as id, d.name
                                        FROM    Statistics_DeceasedDestination_DeceasedIn slm, DeceasedIn d
                                        WHERE   slm.deceasedIn = d.deceasedInID AND
                                                slm.deceasedDestination = $id");
                if(mysqli_num_rows($result) == 0){
                    $deceasedIn = null;
                }else{
                    $deceasedIn = $db->resultToArray($result);
                }
                $data['deceasedIn'] = $deceasedIn;


                $result = $db->query("  SELECT  d.mortuaryID as id, d.name
                                        FROM    Statistics_DeceasedDestination_Mortuary slm, Mortuaries d
                                        WHERE   slm.mortuary = d.mortuaryID AND
                                                slm.deceasedDestination = $id");

                if(mysqli_num_rows($result) == 0){
                    $mortuaries = null;
                }else{
                    $mortuaries = $db->resultToArray($result);
                }
                $data['mortuaries'] = $mortuaries;


                $result = $db->query("  SELECT  d.churchID as id, d.name
                                        FROM    Statistics_DeceasedDestination_Church slm, Churches d
                                        WHERE   slm.church = d.churchID AND
                                                slm.deceasedDestination = $id");

                if(mysqli_num_rows($result) == 0){
                    $churchs = null;
                }else{
                    $churchs = $db->resultToArray($result);
                }
                $data['churchs'] = $churchs;


                $result = $db->query("  SELECT  d.cemeteryID as id, d.name
                                        FROM    Statistics_DeceasedDestination_Cemetery slm, Cemeteries d
                                        WHERE   slm.cemetery = d.cemeteryID AND
                                                slm.deceasedDestination = $id");

                if(mysqli_num_rows($result) == 0){
                    $cemeteries = null;
                }else{
                    $cemeteries = $db->resultToArray($result);
                }
                $data['cemeteries'] = $cemeteries;

                $result = $db->query("  SELECT  d.crematoriumID as id, d.name
                                        FROM    Statistics_DeceasedDestination_Crematorium slm, Crematoriums d
                                        WHERE   slm.crematorium = d.crematoriumID AND
                                                slm.deceasedDestination = $id");

                if(mysqli_num_rows($result) == 0){
                    $crematoriums = null;
                }else{
                    $crematoriums = $db->resultToArray($result);
                }
                $data['crematoriums'] = $crematoriums;

                $result = $db->query("  SELECT  d.locationID as id, d.name
                                        FROM    Statistics_DeceasedDestination_Location slm, Locations d
                                        WHERE   slm.location = d.locationID AND
                                                slm.deceasedDestination = $id");

                if(mysqli_num_rows($result) == 0){
                    $locations = null;
                }else{
                    $locations = $db->resultToArray($result);
                }
                $data['locations'] = $locations;

                
                $result = $db->query("  SELECT  ct.clientTypeID as id, ct.name
                                        FROM    Statistics_DeceasedDestination_ClientType slc, Clients_Types ct
                                        WHERE   slc.clientType = ct.clientTypeID AND
                                                slc.deceasedDestination = $id");

                if(mysqli_num_rows($result) == 0){
                    $clientTypes = null;
                }else{
                    $clientTypes = $db->resultToArray($result);
                }
                $data['clientTypes'] = $clientTypes;

                
                $result = $db->query("  SELECT  c.clientID as id, c.name
                                        FROM    Statistics_DeceasedDestination_Client slc, Clients c
                                        WHERE   slc.client = c.clientID AND
                                                slc.deceasedDestination = $id");

                if(mysqli_num_rows($result) == 0){
                    $clients = null;
                }else{
                    $clients = $db->resultToArray($result);
                }
                $data['clients'] = $clients;
            }

            return $data;
        }

        /**
         * Obtiene los datos de la plantilla
         * 
         * @param int $id Id de la plantilla
         * @return array $data Datos de la plantilla
         */
        public function middleAgeRead($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            $result = $db->query("  SELECT  *
                                    FROM    Statistics_MiddleAge
                                    WHERE   ID = $id");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $data = array();

                $middleAge = $db->resultToArray($result)[0];
                $data['middleAgeData'] = $middleAge;

            
                $result = $db->query("  SELECT  ct.clientTypeID as id, ct.name
                                        FROM    Statistics_MiddleAge_ClientType slc, Clients_Types ct
                                        WHERE   slc.clientType = ct.clientTypeID AND
                                                slc.middleAge = $id");

                if(mysqli_num_rows($result) == 0){
                    $clientTypes = null;
                }else{
                    $clientTypes = $db->resultToArray($result);
                }
                $data['clientTypes'] = $clientTypes;

                
                $result = $db->query("  SELECT  c.clientID as id, c.name
                                        FROM    Statistics_MiddleAge_Client slc, Clients c
                                        WHERE   slc.client = c.clientID AND
                                                slc.middleAge = $id");

                if(mysqli_num_rows($result) == 0){
                    $clients = null;
                }else{
                    $clients = $db->resultToArray($result);
                }
                $data['clients'] = $clients;


                $result = $db->query("  SELECT  slc.civilStatus
                                        FROM    Statistics_MiddleAge_CivilStatus slc
                                        WHERE   slc.middleAge = $id");

                if(mysqli_num_rows($result) == 0){
                    $civilStatus = null;
                }else{
                    $civilStatus = $db->resultToArray($result);
                }
                $data['civilStatus'] = $civilStatus;
            }

            return $data;
        }


        /**
         * Obtiene los datos de la plantilla
         * 
         * @param int $id Id de la plantilla
         * @return array $data Datos de la plantilla
         */
        public function generalRead($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            $result = $db->query("  SELECT  *
                                    FROM    Statistics_General
                                    WHERE   ID = $id");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $data = array();

                $general = $db->resultToArray($result)[0];
                $data['generalData'] = $general;

            
                $result = $db->query("  SELECT  p.productID as id, p.name
                                        FROM    Statistics_General_Product sgp, Products p
                                        WHERE   sgp.product = p.productID AND
                                                sgp.general = $id");

                if(mysqli_num_rows($result) == 0){
                    $products = null;
                }else{
                    $products = $db->resultToArray($result);
                }
                $data['products'] = $products;

                
                $result = $db->query("  SELECT  m.mortuaryID as id, m.name
                                        FROM    Statistics_General_Mortuary sgp, Mortuaries m
                                        WHERE   sgp.mortuary = m.mortuaryID AND
                                                sgp.general = $id");

                if(mysqli_num_rows($result) == 0){
                    $mortuaries = null;
                }else{
                    $mortuaries = $db->resultToArray($result);
                }
                $data['mortuaries'] = $mortuaries;


                $result = $db->query("  SELECT  p.productID as id, p.name
                                        FROM    Statistics_GeneralCompare_Product sgp, Products p
                                        WHERE   sgp.product = p.productID AND
                                                sgp.general = $id");

                if(mysqli_num_rows($result) == 0){
                    $productsCompare = null;
                }else{
                    $productsCompare = $db->resultToArray($result);
                }
                $data['productsCompare'] = $productsCompare;


                $result = $db->query("  SELECT  m.mortuaryID as id, m.name
                                        FROM    Statistics_GeneralCompare_Mortuary sgp, Mortuaries m
                                        WHERE   sgp.mortuary = m.mortuaryID AND
                                                sgp.general = $id");

                if(mysqli_num_rows($result) == 0){
                    $mortuariesCompare = null;
                }else{
                    $mortuariesCompare = $db->resultToArray($result);
                }
                $data['mortuariesCompare'] = $mortuariesCompare;
            }

            return $data;
        }


         /**
         * Obtiene los datos de la plantilla
         * 
         * @param int $id Id de la plantilla
         * @return array $data Datos de la plantilla
         */
        public function mortuaryUseRead($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            $result = $db->query("  SELECT  *
                                    FROM    Statistics_MortuaryUse
                                    WHERE   ID = $id");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $data = array();

                $mortuaryUse = $db->resultToArray($result)[0];
                $data['mortuaryUseData'] = $mortuaryUse;

            
                $result = $db->query("  SELECT  ct.clientTypeID as id, ct.name
                                        FROM    Statistics_MortuaryUse_ClientType slc, Clients_Types ct
                                        WHERE   slc.clientType = ct.clientTypeID AND
                                                slc.mortuaryUse = $id");

                if(mysqli_num_rows($result) == 0){
                    $clientTypes = null;
                }else{
                    $clientTypes = $db->resultToArray($result);
                }
                $data['clientTypes'] = $clientTypes;

                
                $result = $db->query("  SELECT  c.clientID as id, c.name
                                        FROM    Statistics_MortuaryUse_Client slc, Clients c
                                        WHERE   slc.client = c.clientID AND
                                                slc.mortuaryUse = $id");

                if(mysqli_num_rows($result) == 0){
                    $clients = null;
                }else{
                    $clients = $db->resultToArray($result);
                }
                $data['clients'] = $clients;


                $result = $db->query("  SELECT  c.mortuaryID as id, c.name
                                        FROM    Statistics_MortuaryUse_Mortuary slc, Mortuaries c
                                        WHERE   slc.mortuary = c.mortuaryID AND
                                                slc.mortuaryUse = $id");
                if(mysqli_num_rows($result) == 0){
                    $mortuaries = null;
                }else{
                    $mortuaries = $db->resultToArray($result);
                }
                $data['mortuaries'] = $mortuaries;
            }

            return $data;
        }

        /**
         * Obtiene los datos de la plantilla
         * 
         * @param int $id Id de la plantilla
         * @return array $data Datos de la plantilla
         */
        public function controlPanelRead($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            $result = $db->query("  SELECT  *
                                    FROM    Statistics_ControlPanel
                                    WHERE   ID = $id");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $data = array();

                $controlPanel = $db->resultToArray($result)[0];
                $data['controlPanelData'] = $controlPanel;

            
                $result = $db->query("  SELECT  ct.clientTypeID as id, ct.name
                                        FROM    Statistics_ControlPanel_ClientType slc, Clients_Types ct
                                        WHERE   slc.clientType = ct.clientTypeID AND
                                                slc.controlPanel = $id");

                if(mysqli_num_rows($result) == 0){
                    $clientTypes = null;
                }else{
                    $clientTypes = $db->resultToArray($result);
                }
                $data['clientTypes'] = $clientTypes;

                
                $result = $db->query("  SELECT  c.clientID as id, c.name
                                        FROM    Statistics_ControlPanel_Client slc, Clients c
                                        WHERE   slc.client = c.clientID AND
                                                slc.controlPanel = $id");

                if(mysqli_num_rows($result) == 0){
                    $clients = null;
                }else{
                    $clients = $db->resultToArray($result);
                }
                $data['clients'] = $clients;


                $result = $db->query("  SELECT  c.mortuaryID as id, c.name
                                        FROM    Statistics_ControlPanel_Mortuary slc, Mortuaries c
                                        WHERE   slc.mortuary = c.mortuaryID AND
                                                slc.controlPanel = $id");
                if(mysqli_num_rows($result) == 0){
                    $mortuaries = null;
                }else{
                    $mortuaries = $db->resultToArray($result);
                }
                $data['mortuaries'] = $mortuaries;
            }

            return $data;
        }

        /**
         * Obtiene los datos de la plantilla
         * 
         * @param int $id Id de la plantilla
         * @return array $data Datos de la plantilla
         */
        public function pollsRead($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            $result = $db->query("  SELECT  *
                                    FROM    Statistics_Polls
                                    WHERE   ID = $id");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $data = array();

                $poll = $db->resultToArray($result)[0];
                $data['pollData'] = $poll;

            
                $result = $db->query("  SELECT  ct.clientTypeID as id, ct.name
                                        FROM    Statistics_Polls_ClientType spct, Clients_Types ct
                                        WHERE   spct.clientType = ct.clientTypeID AND
                                                spct.poll = $id");

                if(mysqli_num_rows($result) == 0){
                    $clientTypes = null;
                }else{
                    $clientTypes = $db->resultToArray($result);
                }
                $data['clientTypes'] = $clientTypes;
                
                $result = $db->query("  SELECT  c.clientID as id, c.name
                                        FROM    Statistics_Polls_Client spc, Clients c
                                        WHERE   spc.client = c.clientID AND
                                                spc.poll = $id");

                if(mysqli_num_rows($result) == 0){
                    $clients = null;
                }else{
                    $clients = $db->resultToArray($result);
                }
                $data['clients'] = $clients;

                $result = $db->query("  SELECT  c.mortuaryID as id, c.name
                                        FROM    Statistics_Polls_Mortuary spm, Mortuaries c
                                        WHERE   spm.mortuary = c.mortuaryID AND
                                                spm.poll = $id");
                if(mysqli_num_rows($result) == 0){
                    $mortuaries = null;
                }else{
                    $mortuaries = $db->resultToArray($result);
                }
                $data['mortuaries'] = $mortuaries;

                $result = $db->query("  SELECT  p.ID as id, p.title
                                        FROM    Statistics_Polls_Poll spp, Polls p
                                        WHERE   spp.poll_selected = p.ID AND
                                                spp.poll = $id");
                if(mysqli_num_rows($result) == 0){
                    $polls = null;
                }else{
                    $polls = $db->resultToArray($result);
                }
                $data['polls'] = $polls;
            }

            return $data;
        }

        /**
         * Obtiene los datos de la plantilla
         * 
         * @param int $id Id de la plantilla
         * @return array $data Datos de la plantilla
         */
        public function economicPerformanceRead($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            $result = $db->query("  SELECT  *
                                    FROM    Statistics_EconomicPerformance
                                    WHERE   ID = $id");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $data = $db->resultToArray($result)[0];
                return $data;
            }
        }

        /**
         * Obtiene los datos de la plantilla
         * 
         * @param int $id Id de la plantilla
         * @return array $data Datos de la plantilla
         */
        public function servicesTimesRead($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            $result = $db->query("  SELECT  *
                                    FROM    Statistics_ServicesTimes
                                    WHERE   ID = $id");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $data = array();

                $serviceTime = $db->resultToArray($result)[0];
                $data['serviceTimeData'] = $serviceTime;
    
                $result = $db->query("  SELECT  u.userID as id, u.name
                                        FROM    Statistics_ServicesTimes_Users slc, Users u
                                        WHERE   slc.user = u.userID AND
                                                slc.serviceTime = $id");

                if(mysqli_num_rows($result) == 0){
                    $users = null;
                }else{
                    $users = $db->resultToArray($result);
                }
                $data['users'] = $users;

                $result = $db->query("  SELECT  c.carrierID as id, c.name
                                        FROM    Statistics_ServicesTimes_Carriers slc, Carriers c
                                        WHERE   slc.carrier = c.carrierID AND
                                                slc.serviceTime = $id");
                if(mysqli_num_rows($result) == 0){
                    $carrriers = null;
                }else{
                    $carrriers = $db->resultToArray($result);
                }
                $data['carrriers'] = $carrriers;
            }

            return $data;
        }

        /**
         * Modifica los datos de la plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function literalsUpdate($data){
            $db = new DbHandler;

            $data['name'] = cleanStr($data['name']);
            $data['dateCheck'] = cleanStr($data['dateCheck']);
            $data['date'] = cleanStr($data['date']);
            $data['datePeriod'] = cleanStr($data['datePeriod']);
            $data['dateSince'] = cleanStr($data['dateSince']);
            $data['dateUntil'] = cleanStr($data['dateUntil']);
            $data['dateCheckLength'] = cleanStr($data['dateCheckLength']);
            $data['year'] = cleanStr($data['year']);
            $data['month'] = cleanStr($data['month']);
            $data['trimester'] = cleanStr($data['trimester']);
            $data['clientTypeCheck'] = cleanStr($data['clientTypeCheck']);
            $data['clientCheck'] = cleanStr($data['clientCheck']);
            $data['registerCheck'] = cleanStr($data['registerCheck']);
            $data['mortuaryCheck'] = cleanStr($data['mortuaryCheck']);
            $data['cemeteryCheck'] = cleanStr($data['cemeteryCheck']);
            $data['ID'] = cleanStr($data['ID']);

            if($data['date'] == ''){
                $data['date'] = 'null';
            }
            if($data['dateSince'] == ''){
                $data['dateSince'] = 'null';
            }
            if($data['dateUntil'] == ''){
                $data['dateUntil'] = 'null';
            }
            if($data['month'] == ''){
                $data['month'] = 0;
            }
            if($data['trimester'] == ''){
                $data['trimester'] = 0;
            }
            if($data['clientType'] == ''){
                $data['clientType'] = 'null';
            }
            if($data['client'] == ''){
                $data['client'] = 'null';
            }
            if($data['register'] == ''){
                $data['register'] = 'null';
            }
            if($data['mortuary'] == ''){
                $data['mortuary'] = 'null';
            }
            if($data['cemetery'] == ''){
                $data['cemetery'] = 'null';
            }

            $db->query("UPDATE  Statistics_Literals
                        SET     name = '" . $data['name'] . "',
                                dateCheck = " . $data['dateCheck'] . ",
                                date = " . $data['date'] . ",
                                datePeriod = " . $data['datePeriod'] . ",
                                dateSince = " . $data['dateSince'] . ",
                                dateUntil = " . $data['dateUntil'] . ",
                                dateCheckLength = " . $data['dateCheckLength'] . ",
                                year = " . $data['year'] . ",
                                month = " . $data['month'] . ",
                                trimester = " . $data['trimester'] . ",
                                clientTypeCheck = " . $data['clientTypeCheck'] . ",
                                clientCheck = " . $data['clientCheck'] . ",
                                registerCheck = " . $data['registerCheck'] . ",
                                mortuaryCheck = " . $data['mortuaryCheck'] . ",
                                cemeteryCheck = " . $data['cemeteryCheck'] . "
                        WHERE   ID = " . $data['ID']);

            $db->query("DELETE FROM Statistics_Literals_ClientsTypes
                        WHERE statisticsLiterals = " . $data['ID']);

            if($data['clientType'] != 'null'){
                foreach($data['clientType'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Literals_ClientsTypes(statisticsLiterals, clientType)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_Literals_Clients
                        WHERE statisticsLiterals = " . $data['ID']);

            if($data['client'] != 'null'){
                foreach($data['client'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Literals_Clients(statisticsLiterals, client)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_Literals_Registers
                        WHERE statisticsLiterals = " . $data['ID']);

            if($data['register'] != 'null'){
                foreach($data['register'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Literals_Registers(statisticsLiterals, register)
                                VALUES (" . $data['ID'] . ", '$elem')");
                }
            }

            $db->query("DELETE FROM Statistics_Literals_Mortuaries
                        WHERE statisticsLiterals = " . $data['ID']);

            if($data['mortuary'] != 'null'){
                foreach($data['mortuary'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Literals_Mortuaries(statisticsLiterals, mortuary)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_Literals_Cemeteries
                        WHERE statisticsLiterals = " . $data['ID']);

            if($data['cemetery'] != 'null'){
                foreach($data['cemetery'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Literals_Cemeteries(statisticsLiterals, cemetery)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            return true;
        }

        /**
         * Modifica los datos de la plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function makingUpdate($data){
            $db = new DbHandler;

            $data['name'] = cleanStr($data['name']);
            $data['date'] = cleanStr($data['date']);
            $data['dateSince'] = cleanStr($data['dateSince']);
            $data['dateUntil'] = cleanStr($data['dateUntil']);
            $data['birthdateDate'] = cleanStr($data['birthdateDate']);
            $data['deceasedDate'] = cleanStr($data['deceasedDate']);
            $data['birthdateSince'] = cleanStr($data['birthdateSince']);
            $data['birthdateUntil'] = cleanStr($data['birthdateUntil']);
            $data['deathSince'] = cleanStr($data['deathSince']);
            $data['deathUntil'] = cleanStr($data['deathUntil']);
            $data['tribunal'] = cleanStr($data['tribunal']);
            $data['deceasedRoom'] = cleanStr($data['deceasedRoom']);


            if($data['date'] == ''){
                $data['date'] = 'null';
                $dateCheck = '0';
            }else{
                $dateCheck = '1';
            }
        
            if($data['dateSince'] == ''){
                $data['dateSince'] = 'null';
                $datePeriod = '0';
            }else{
                $datePeriod = '1';
                $dateCheck = '1';
            }
            if($data['dateUntil'] == ''){
                $data['dateUntil'] = 'null';
            }

            if($data['birthdateDate'] == ''){
                $data['birthdateDate'] = 'null';
                $birthdayCheck = 0;
            }else{
                $birthdayCheck = 1;
            }
            if($data['birthdateSince'] == ''){
                $data['birthdateSince'] = 'null';
                $birthdayPeriod = 0;

            }else{
                $birthdayPeriod = 1;
                $birthdayCheck = 1;
            }
            if($data['birthdateUntil'] == ''){
                $data['birthdateUntil'] = 'null';
            }

            if($data['deceasedDate'] == ''){
                $data['deceasedDate'] = 'null';
                $deathCheck = 0;
            }else{
                $deathCheck = 1;
            }
   
            if($data['deathSince'] == ''){
                $data['deathSince'] = 'null';
                $deathPeriod = 0;
            }else{
                $deathPeriod = 1;
                $deathCheck = 1;
            }
            if($data['deathUntil'] == ''){
                $data['deathUntil'] = 'null';
            }
   
            if($data['tribunal'] == ''){
                $data['tribunal'] = 'null';
            }
    
            if($data['deceasedRoom'] == ''){
                $data['deceasedRoom'] = 'null';
            }

            $db->query("UPDATE  Statistics_Making
                        SET     name = '" . $data['name'] . "',
                                dateCheck = " . $dateCheck . ",
                                date = " . $data['date'] . ",
                                datePeriod = " . $datePeriod . ",
                                dateSince = " . $data['dateSince'] . ",
                                dateUntil = " . $data['dateUntil'] . ",
                                birthdayCheck = " . $birthdayCheck . ",
                                birthdateDate = " . $data['birthdateDate'] . ",
                                birthdayPeriod = " . $birthdayPeriod . ",
                                birthdaySince = " . $data['birthdateSince'] . ",
                                birthdayUntil = " . $data['birthdateUntil'] . ",
                                deathCheck = " . $deathCheck . ",
                                deceasedDate = " . $data['deceasedDate'] . ",
                                deathPeriod = " . $deathPeriod . ",
                                deathSince = " . $data['deathSince'] . ",
                                deathUntil = " . $data['deathUntil'] . ",
                                tribunal = " . $data['tribunal'] . ",
                                deceasedRoom = " . $data['deceasedRoom'] . "
                        WHERE   ID = " . $data['ID']);


            $db->query("DELETE FROM Statistics_Making_TypeClients
                        WHERE making = " . $data['ID']);
            if($data['clientType'] != 'null' && $data['clientType'] != ''){
                foreach($data['clientType'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Making_TypeClients(making, typeClient)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_Making_Clients
                        WHERE making = " . $data['ID']);
            if($data['client'] != 'null' && $data['client'] != ''){
                foreach($data['client'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Making_Clients(making, client)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_Making_Doctor
                        WHERE making = " . $data['ID']);

            if($data['doctor'] != 'null' && $data['doctor'] != ''){
                foreach($data['doctor'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Making_Doctor(making, doctor)
                                VALUES (" . $data['ID'] . ", '$elem')");
                }
            }

            $db->query("DELETE FROM Statistics_Making_Mortuary
                        WHERE making = " . $data['ID']);

            if($data['mortuary'] != 'null' && $data['mortuary'] != ''){
                foreach($data['mortuary'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Making_Mortuary(making, mortuary)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_Making_DeathLocation
                        WHERE making = " . $data['ID']);

            if($data['deathLocation'] != 'null'  && $data['deathLocation'] != ''){
                foreach($data['deathLocation'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Making_DeathLocation(making, location)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_Making_Expedient_Type
                        WHERE making = " . $data['ID']);

            if($data['expedientTypes'] != 'null'  && $data['expedientTypes'] != ''){
                foreach($data['expedientTypes'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Making_Expedient_Type(making, type)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }
            return true;
        }

        /**
         * Modifica los datos de la plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function deceasedDestinationUpdate($data){
            $db = new DbHandler;

            $data['name'] = cleanStr($data['name']);
            $data['deceasedDateSince'] = cleanStr($data['deceasedDateSince']);
            $data['deceasedDateUntil'] = cleanStr($data['deceasedDateUntil']);
            $data['gender'] = cleanStr($data['gender']);

            $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

            $result = $db->query("  SELECT  * 
                                    FROM    Statistics_DeceasedDestination 
                                    WHERE   extraID = '$extraID'");

            while(mysqli_num_rows($result) > 0){
                $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

                $result = $db->query("  SELECT  * 
                                        FROM    Statistics_DeceasedDestination 
                                        WHERE   extraID = '$extraID'");
            }

            if($data['deceasedDateSince'] == ''){
                $data['deceasedDateSince'] = 'null';
                $dateCheck = '0';
            }else{
                $dateCheck = '1';
            }
            if($data['deceasedDateUntil'] == ''){
                $data['deceasedDateUntil'] = 'null';
            }

            if($data['gender'] == ''){
                $data['gender'] = 'null';
                $genderCheck = 0;
            }else{
                $genderCheck = 1;
            }

            $db->query("UPDATE  Statistics_DeceasedDestination
                        SET     name = '" . $data['name'] . "',
                                dateCheck = " . $dateCheck . ",
                                dateSince = " . $data['deceasedDateSince'] . ",
                                dateUntil = " . $data['deceasedDateUntil'] . ",
                                sexCheck = " . $genderCheck . ",
                                sex = '" . $data['gender'] . "'
                        WHERE   ID = " . $data['ID']);


            $db->query("DELETE FROM Statistics_DeceasedDestination_ClientType
                        WHERE deceasedDestination = " . $data['ID']);
            if($data['clientType'] != 'null' && $data['clientType'] != ''){
                foreach($data['clientType'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_DeceasedDestination_ClientType(deceasedDestination, clientType)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_DeceasedDestination_Client
                        WHERE deceasedDestination = " . $data['ID']);
            if($data['client'] != 'null' && $data['client'] != ''){
                foreach($data['client'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_DeceasedDestination_Client(deceasedDestination, client)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_DeceasedDestination_Church
                        WHERE deceasedDestination = " . $data['ID']);

            if($data['church'] != 'null' && $data['church'] != ''){
                foreach($data['church'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_DeceasedDestination_Church(deceasedDestination, church)
                                VALUES (" . $data['ID'] . ", '$elem')");
                }
            }

            $db->query("DELETE FROM Statistics_DeceasedDestination_Mortuary
                        WHERE deceasedDestination = " . $data['ID']);

            if($data['mortuary'] != 'null' && $data['mortuary'] != ''){
                foreach($data['mortuary'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_DeceasedDestination_Mortuary(deceasedDestination, mortuary)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_DeceasedDestination_Crematorium
                        WHERE deceasedDestination = " . $data['ID']);

            if($data['crematorium'] != 'null'  && $data['crematorium'] != ''){
                foreach($data['crematorium'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_DeceasedDestination_Crematorium(deceasedDestination, crematorium)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_DeceasedDestination_Cemetery
                        WHERE deceasedDestination = " . $data['ID']);

            if($data['cemetery'] != 'null'  && $data['cemetery'] != ''){
                foreach($data['cemetery'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_DeceasedDestination_Cemetery(deceasedDestination, cemetery)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_DeceasedDestination_DeceasedIn
                        WHERE deceasedDestination = " . $data['ID']);

            if($data['deceasedIn'] != 'null'  && $data['deceasedIn'] != ''){
                foreach($data['deceasedIn'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_DeceasedDestination_DeceasedIn(deceasedDestination, deceasedIn)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_DeceasedDestination_Location
                        WHERE deceasedDestination = " . $data['ID']);

            if($data['location'] != 'null'  && $data['location'] != ''){
                foreach($data['location'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_DeceasedDestination_Location(deceasedDestination, location)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            return true;
        }

        /**
         * Modifica los datos de la plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function middleAgeUpdate($data){
            $db = new DbHandler;

            $data['name'] = cleanStr($data['name']);
            $data['deceasedDateSince'] = cleanStr($data['deceasedDateSince']);
            $data['deceasedDateUntil'] = cleanStr($data['deceasedDateUntil']);
            $data['dateParticularSince'] = cleanStr($data['dateParticularSince']);
            $data['dateParticularUntil'] = cleanStr($data['dateParticularUntil']);
            $data['dateSeguroSince'] = cleanStr($data['dateSeguroSince']);
            $data['dateSeguroUntil'] = cleanStr($data['dateSeguroUntil']);
            $data['dateEmpresaSince'] = cleanStr($data['dateEmpresaSince']);
            $data['dateEmpresaUntil'] = cleanStr($data['dateEmpresaUntil']);

            $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

            $result = $db->query("  SELECT  * 
                                    FROM    Statistics_MiddleAge 
                                    WHERE   extraID = '$extraID'");

            while(mysqli_num_rows($result) > 0){
                $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);

                $result = $db->query("  SELECT  * 
                                        FROM    Statistics_MiddleAge 
                                        WHERE   extraID = '$extraID'");
            }

            if($data['deceasedDateSince'] == ''){
                $data['deceasedDateSince'] = 'null';
                $dateCheck = '0';
            }else{
                $dateCheck = '1';
            }
            if($data['deceasedDateUntil'] == ''){
                $data['deceasedDateUntil'] = 'null';
            }

            if($data['gender'] == ''){
                $data['gender'] = 'null';
                $genderCheck = 0;
            }else{
                $genderCheck = 1;
            }

            if($data['dateParticularSince'] == ''){
                $data['dateParticularSince'] = 'null';
                $periodParticularCheck = '0';
            }else{
                $periodParticularCheck = '1';
            }
            if($data['dateParticularUntil'] == ''){
                $data['dateParticularUntil'] = 'null';
            }

            if($data['dateSeguroSince'] == ''){
                $data['dateSeguroSince'] = 'null';
                $periodInsuranceCheck = '0';
            }else{
                $periodInsuranceCheck = '1';
            }
            if($data['dateSeguroUntil'] == ''){
                $data['dateSeguroUntil'] = 'null';
            }

            if($data['dateEmpresaSince'] == ''){
                $data['dateEmpresaSince'] = 'null';
                $periodCompanyCheck = '0';
            }else{
                $periodCompanyCheck = '1';
            }
            if($data['dateEmpresaUntil'] == ''){
                $data['dateEmpresaUntil'] = 'null';
            }
         
            $db->query("UPDATE  Statistics_MiddleAge
                        SET     name = '" . $data['name'] . "',
                                dateCheck = " . $dateCheck . ",
                                dateSince = " . $data['deceasedDateSince'] . ",
                                dateUntil = " . $data['deceasedDateUntil'] . ",
                                genderCheck = " . $genderCheck . ",
                                gender = '" . $data['gender'] . "',
                                periodParticularCheck = '" . $periodParticularCheck . "',
                                periodParticularSince = '" . $data['dateParticularSince'] . "',
                                periodParticularUntil = '" . $data['dateParticularUntil'] . "',
                                periodInsuranceCheck = '" . $periodInsuranceCheck . "',
                                periodInsuranceSince = '" . $data['dateSeguroSince'] . "',
                                periodInsuranceUntil = '" . $data['dateSeguroUntil'] . "',
                                periodCompanyCheck = " . $periodCompanyCheck . ",
                                periodCompanySince = " . $data['dateEmpresaSince'] . ",
                                periodCompanyUntil = " . $data['dateEmpresaUntil'] . "
                                WHERE   ID = " . $data['ID']);


            $db->query("DELETE FROM Statistics_MiddleAge_ClientType
                        WHERE middleAge = " . $data['ID']);
            if($data['clientType'] != 'null' && $data['clientType'] != ''){
                foreach($data['clientType'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_MiddleAge_ClientType(middleAge, clientType)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_MiddleAge_Client
                        WHERE middleAge = " . $data['ID']);
            if($data['client'] != 'null' && $data['client'] != ''){
                foreach($data['client'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_MiddleAge_Client(middleAge, client)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_MiddleAge_CivilStatus
                        WHERE middleAge = " . $data['ID']);
            if($data['civilStatus'] != 'null' && $data['civilStatus'] != ''){
                foreach($data['civilStatus'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_MiddleAge_CivilStatus(middleAge, civilStatus)
                                VALUES (" . $data['ID'] . ", '$elem')");
                }
            }
            return true;
        }

        /**
         * Modifica los datos de la plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function generalUpdate($data){
            $db = new DbHandler;

        
            $data['name'] = cleanStr($data['name']);
            $data['year'] = cleanStr($data['year']);
            $data['month'] = cleanStr($data['month']);
            $data['trimester'] = cleanStr($data['trimester']);
            $data['dateFrom'] = cleanStr($data['dateFrom']);
            $data['dateTo'] = cleanStr($data['dateTo']);
            $data['yearCompare'] = cleanStr($data['yearCompare']);
            $data['monthCompare'] = cleanStr($data['monthCompare']);
            $data['trimesterCompare'] = cleanStr($data['trimesterCompare']);
            $data['dateFromCompare'] = cleanStr($data['dateFromCompare']);
            $data['dateToCompare'] = cleanStr($data['dateToCompare']);

            if($data['year'] == null){
                $data['year'] = ' null';
            }
            if($data['month'] == null){
                $data['month'] = ' null';
            }
            if($data['trimester'] == null){
                $data['trimester'] = ' null';
            }
            if($data['dateFrom'] == null){
                $data['dateFrom'] = ' null';
            }
            if($data['dateTo'] == null){
                $data['dateTo'] = ' null';
            }
            if($data['yearCompare'] == null){
                $data['yearCompare'] = ' null';
            }
            if($data['monthCompare'] == null){
                $data['monthCompare'] = ' null';
            }
            if($data['trimesterCompare'] == null){
                $data['trimesterCompare'] = ' null';
            }
            if($data['dateFromCompare'] == null){
                $data['dateFromCompare'] = ' null';
            }
            if($data['dateToCompare'] == null){
                $data['dateToCompare'] = ' null';
            }
        
            $db->query("UPDATE  Statistics_General
                        SET     name = '" . $data['name'] . "',
                                year = " . $data['year'] . ",
                                month = " . $data['month'] . ",
                                trimester = " . $data['trimester'] . ",
                                dateFrom = '" . $data['dateFrom'] . "',
                                dateUntil = '" . $data['dateTo'] . "',
                                yearCompare = " . $data['yearCompare'] . ",
                                monthCompare = " . $data['monthCompare'] . ",
                                trimesterCompare = " . $data['trimesterCompare'] . ",
                                dateFromCompare = '" . $data['dateFromCompare'] . "',
                                dateUntilCompare = '" . $data['dateToCompare'] . "'
                                WHERE   ID = " . $data['ID']);


            $db->query("DELETE FROM Statistics_General_Product
                        WHERE general = " . $data['ID']);
            if($data['products'] != 'null' && $data['products'] != ''){
                foreach($data['products'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_General_Product(general, product)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_General_Mortuary
                        WHERE general = " . $data['ID']);
            if($data['mortuaries'] != 'null' && $data['mortuaries'] != ''){
                foreach($data['mortuaries'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_General_Mortuary(general, mortuary)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_GeneralCompare_Product
                        WHERE general = " . $data['ID']);
            if($data['productsCompare'] != 'null' && $data['productsCompare'] != ''){
                foreach($data['productsCompare'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_GeneralCompare_Product(general, product)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_GeneralCompare_Mortuary
                        WHERE general = " . $data['ID']);
            if($data['mortuariesCompare'] != 'null' && $data['mortuariesCompare'] != ''){
                foreach($data['mortuariesCompare'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_GeneralCompare_Mortuary(general, mortuary)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            
            return true;
        }

        /**
         * Modifica los datos de la plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function mortuaryUseUpdate($data){
            $db = new DbHandler;

            $data['name'] = cleanStr($data['name']);
            $data['stayDateSince'] = cleanStr($data['stayDateSince']);
            $data['stayDateUntil'] = cleanStr($data['stayDateUntil']);
            $data['stayTimeSince'] = cleanStr($data['stayTimeSince']);
            $data['stayTimeUntil'] = cleanStr($data['stayTimeUntil']);
            $data['daySince'] = cleanStr($data['daySince']);
            $data['dayUntil'] = cleanStr($data['dayUntil']);
            $data['deceasedRoom'] = cleanStr($data['deceasedRoom']);
            $data['dateParticularSince'] = cleanStr($data['dateParticularSince']);
            $data['dateParticularUntil'] = cleanStr($data['dateParticularUntil']);
            $data['dateSeguroSince'] = cleanStr($data['dateSeguroSince']);
            $data['dateSeguroUntil'] = cleanStr($data['dateSeguroUntil']);
            $data['dateEmpresaSince'] = cleanStr($data['dateEmpresaSince']);
            $data['dateEmpresaUntil'] = cleanStr($data['dateEmpresaUntil']);

            if($data['stayDateSince'] == ''){
                $data['stayDateSince'] = 'null';
                $dateCheck = '0';
            }else{
                $dateCheck = '1';
            }
            if($data['stayDateUntil'] == ''){
                $data['stayDateUntil'] = 'null';
            }

            if($data['stayTimeSince'] == ''){
                $data['stayTimeSince'] = 'null';
                $timeCheck = '0';
            }else{
                $timeCheck = '1';
            }
            if($data['stayTimeUntil'] == ''){
                $data['stayTimeUntil'] = 'null';
            }

            if($data['daySince'] == ''){
                $data['daySince'] = 'null';
                $dayCheck = '0';
            }else{
                $dayCheck = '1';
            }
            if($data['dayUntil'] == ''){
                $data['dayUntil'] = 'null';
            }

            if($data['deceasedRoom'] == ''){
                $data['deceasedRoom'] = 'null';
                $deceasedRoomCheck = 0;
            }else{
                $deceasedRoomCheck = 1;
            }

            if($data['dateParticularSince'] == ''){
                $data['dateParticularSince'] = 'null';
                $periodParticularCheck = '0';
            }else{
                $periodParticularCheck = '1';
            }
            if($data['dateParticularUntil'] == ''){
                $data['dateParticularUntil'] = 'null';
            }

            if($data['dateSeguroSince'] == ''){
                $data['dateSeguroSince'] = 'null';
                $periodInsuranceCheck = '0';
            }else{
                $periodInsuranceCheck = '1';
            }
            if($data['dateSeguroUntil'] == ''){
                $data['dateSeguroUntil'] = 'null';
            }

            if($data['dateEmpresaSince'] == ''){
                $data['dateEmpresaSince'] = 'null';
                $periodCompanyCheck = '0';
            }else{
                $periodCompanyCheck = '1';
            }
            if($data['dateEmpresaUntil'] == ''){
                $data['dateEmpresaUntil'] = 'null';
            }
         
            $db->query("UPDATE  Statistics_MortuaryUse
                        SET     name = '" . $data['name'] . "',
                                dateCheck = " . $dateCheck . ",
                                dateSince = " . $data['stayDateSince'] . ",
                                dateUntil = " . $data['stayDateUntil'] . ",
                                timeCheck = " . $timeCheck . ",
                                timeSince = '" . $data['stayTimeSince'] . "',
                                timeUntil = '" . $data['stayTimeUntil'] . "',
                                weekDayCheck = '" . $dayCheck . "',
                                weekDaySince = '" . $data['daySince'] . "',
                                weekDayUntil = '" . $data['dayUntil'] . "',
                                salaCheck = '" . $deceasedRoomCheck . "',
                                sala = '" . $data['deceasedRoom'] . "',
                                periodParticularCheck = '" . $periodParticularCheck . "',
                                periodParticularSince = '" . $data['dateParticularSince'] . "',
                                periodParticularUntil = '" . $data['dateParticularUntil'] . "',
                                periodInsuranceCheck = '" . $periodInsuranceCheck . "',
                                periodInsuranceSince = '" . $data['dateSeguroSince'] . "',
                                periodInsuranceUntil = '" . $data['dateSeguroUntil'] . "',
                                periodCompanyCheck = '" . $periodCompanyCheck . "',
                                periodCompanySince = '" . $data['dateEmpresaSince'] . "',
                                periodCompanyUntil = '" . $data['dateEmpresaUntil'] . "'
                            WHERE   ID = " . $data['ID']);


            $db->query("DELETE FROM Statistics_MortuaryUse_ClientType
                        WHERE mortuaryUse = " . $data['ID']);
            if($data['clientType'] != 'null' && $data['clientType'] != ''){
                foreach($data['clientType'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_MortuaryUse_ClientType(mortuaryUse, clientType)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_MortuaryUse_Client
                        WHERE mortuaryUse = " . $data['ID']);
            if($data['client'] != 'null' && $data['client'] != ''){
                foreach($data['client'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_MortuaryUse_Client(mortuaryUse, client)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_MortuaryUse_Mortuary
                        WHERE mortuaryUse = " . $data['ID']);
            if($data['mortuary'] != 'null' && $data['mortuary'] != ''){
                foreach($data['mortuary'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_MortuaryUse_Mortuary(mortuaryUse, mortuary)
                                VALUES (" . $data['ID'] . ", '$elem')");
                }
            }
            return true;
        }

        /**
         * Modifica los datos de la plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function controlPanelUpdate($data){
            $db = new DbHandler;

            $data['ID'] = cleanStr($data['ID']);
            $data['name'] = cleanStr($data['name']);
            $data['date'] = cleanStr($data['date']);
            $data['dateSince'] = cleanStr($data['dateSince']);
            $data['dateUntil'] = cleanStr($data['dateUntil']);

            if($data['date'] == ''){
                $data['date'] = 'null';
                $dateCheck = '0';
            }else{
                $dateCheck = '1';
            }
          
            if($data['dateSince'] == ''){
                $data['dateSince'] = 'null';
                $datePeriod = '0';
            }else{
                $datePeriod = '1';
            }
            if($data['dateUntil'] == ''){
                $data['dateUntil'] = 'null';
            }
            $db->query("UPDATE  Statistics_ControlPanel
                        SET     name = '" . $data['name'] . "',
                                dateCheck = " . $dateCheck . ",
                                date = " . $data['date'] . ",
                                datePeriod = " . $datePeriod . ",
                                dateSince = " . $data['dateSince'] . ",
                                dateUntil = " . $data['dateUntil'] . "
                            WHERE   ID = " . $data['ID']);

            $db->query("DELETE FROM Statistics_ControlPanel_ClientType
                        WHERE controlPanel = " . $data['ID']);
            if($data['clientType'] != 'null' && $data['clientType'] != ''){
                foreach($data['clientType'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_ControlPanel_ClientType(controlPanel, clientType)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_ControlPanel_Client
                        WHERE controlPanel = " . $data['ID']);
            if($data['client'] != 'null' && $data['client'] != ''){
                foreach($data['client'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_ControlPanel_Client(controlPanel, client)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_ControlPanel_Mortuary
                        WHERE controlPanel = " . $data['ID']);
            if($data['mortuary'] != 'null' && $data['mortuary'] != ''){
                foreach($data['mortuary'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_ControlPanel_Mortuary(controlPanel, mortuary)
                                VALUES (" . $data['ID'] . ", '$elem')");
                }
            }
            return true;
        }

        /**
         * Modifica los datos de la plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function pollUpdate($data){
            $db = new DbHandler;

            $data['ID'] = cleanStr($data['ID']);
            $data['name'] = cleanStr($data['name']);
            $data['dateSince'] = cleanStr($data['dateSince']);
            $data['dateUntil'] = cleanStr($data['dateUntil']);

            if($data['dateSince'] == ''){
                $data['dateSince'] = 'null';
                $datePeriod = '0';
            }else{
                $datePeriod = '1';
            }
            if($data['dateUntil'] == ''){
                $data['dateUntil'] = 'null';
            }
            $db->query("UPDATE  Statistics_Polls
                        SET     name = '" . $data['name'] . "',
                                datePeriod = " . $datePeriod . ",
                                dateSince = " . $data['dateSince'] . ",
                                dateUntil = " . $data['dateUntil'] . "
                        WHERE   ID = " . $data['ID']);

            $db->query("DELETE FROM Statistics_Polls_ClientType WHERE poll = " . $data['ID']);
            if($data['clientType'] != 'null' && $data['clientType'] != ''){
                foreach($data['clientType'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Polls_ClientType(poll, clientType)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_Polls_Client WHERE poll = " . $data['ID']);
            if($data['client'] != 'null' && $data['client'] != ''){
                foreach($data['client'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Polls_Client(poll, client)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_Polls_Mortuary WHERE poll = " . $data['ID']);
            if($data['mortuary'] != 'null' && $data['mortuary'] != ''){
                foreach($data['mortuary'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Polls_Mortuary(poll, mortuary)
                                VALUES (" . $data['ID'] . ", '$elem')");
                }
            }

            $db->query("DELETE FROM Statistics_Polls_Poll WHERE poll = " . $data['ID']);
            if($data['poll'] != 'null' && $data['poll'] != ''){
                foreach($data['poll'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_Polls_Poll(poll, poll_selected)
                                VALUES (" . $data['ID'] . ", '$elem')");
                }
            }

            return true;
        }

        /**
         * Modifica los datos de la plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function economicPerformanceUpdate($data){
            $db = new DbHandler;

            $data['ID'] = cleanStr($data['ID']);
            $data['name'] = cleanStr($data['name']);
            $data['date'] = cleanStr($data['date']);
            $data['dateSince'] = cleanStr($data['dateSince']);
            $data['dateUntil'] = cleanStr($data['dateUntil']);

            if($data['date'] == ''){
                $data['date'] = 'null';
                $dateCheck = '0';
            }else{
                $dateCheck = '1';
            }
          
            if($data['dateSince'] == ''){
                $data['dateSince'] = 'null';
                $datePeriod = '0';
            }else{
                $datePeriod = '1';
            }
            if($data['dateUntil'] == ''){
                $data['dateUntil'] = 'null';
            }
            $db->query("UPDATE  Statistics_EconomicPerformance
                        SET     name = '" . $data['name'] . "',
                                dateCheck = " . $dateCheck . ",
                                date = " . $data['date'] . ",
                                datePeriod = " . $datePeriod . ",
                                dateSince = " . $data['dateSince'] . ",
                                dateUntil = " . $data['dateUntil'] . "
                            WHERE   ID = " . $data['ID']);
            return true;
        }

        /**
         * Modifica los datos de la plantilla
         * 
         * @param array $data Datos de la plantilla
         * @return bool
         */
        public function servicesTimesUpdate($data){
            $db = new DbHandler;

            $data['ID'] = cleanStr($data['ID']);
            $data['name'] = cleanStr($data['name']);
            $data['dateSince'] = cleanStr($data['dateSince']);
            $data['dateUntil'] = cleanStr($data['dateUntil']);

            if($data['dateSince'] == ''){
                $data['dateSince'] = 'null';
                $datePeriod = '0';
            }else{
                $datePeriod = '1';
            }
            if($data['dateUntil'] == ''){
                $data['dateUntil'] = 'null';
            }
            $db->query("UPDATE  Statistics_ServicesTimes
                        SET     name = '" . $data['name'] . "',
                                datePeriod = " . $datePeriod . ",
                                dateSince = " . $data['dateSince'] . ",
                                dateUntil = " . $data['dateUntil'] . "
                        WHERE   ID = " . $data['ID']);


            $db->query("DELETE FROM Statistics_ServicesTimes_Users
                        WHERE serviceTime = " . $data['ID']);
            if($data['users'] != 'null' && $data['users'] != ''){
                foreach($data['users'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_ServicesTimes_Users(serviceTime, user)
                                VALUES (" . $data['ID'] . ", $elem)");
                }
            }

            $db->query("DELETE FROM Statistics_ServicesTimes_Carriers
                        WHERE serviceTime = " . $data['ID']);
            if($data['carriers'] != 'null' && $data['carriers'] != ''){
                foreach($data['carriers'] as $elem){
                    $elem = cleanStr($elem);
                    $db->query("INSERT INTO Statistics_ServicesTimes_Carriers(serviceTime, carrier)
                                VALUES (" . $data['ID'] . ", '$elem')");
                }
            }
            return true;
        }

        /**
         * Elimina una plantilla
         * 
         * @param int $id Id de la plantilla
         * @return bool
         */
        public function literalsDelete($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            return $db->query(" UPDATE  Statistics_Literals
                                SET     leavingDate = " . time() . "
                                WHERE   ID = $id");
        }
        /**
         * Elimina una plantilla
         * 
         * @param int $id Id de la plantilla
         * @return bool
         */
        public function makingDelete($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            return $db->query(" UPDATE  Statistics_Making
                                SET     leavingDate = " . time() . "
                                WHERE   ID = $id");
        }

        /**
         * Elimina una plantilla
         * 
         * @param int $id Id de la plantilla
         * @return bool
         */
        public function deceasedDestinationDelete($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            return $db->query(" UPDATE  Statistics_DeceasedDestination
                                SET     leavingDate = " . time() . "
                                WHERE   ID = $id");
        }

        /**
         * Elimina una plantilla
         * 
         * @param int $id Id de la plantilla
         * @return bool
         */
        public function middleAgeDelete($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            return $db->query(" UPDATE  Statistics_MiddleAge
                                SET     leavingDate = " . time() . "
                                WHERE   ID = $id");
        }

        /**
         * Elimina una plantilla
         * 
         * @param int $id Id de la plantilla
         * @return bool
         */
        public function generalDelete($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            return $db->query(" UPDATE  Statistics_General
                                SET     leavingDate = " . time() . "
                                WHERE   ID = $id");
        }

        /**
         * Elimina una plantilla
         * 
         * @param int $id Id de la plantilla
         * @return bool
         */
        public function mortuaryUseDelete($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            return $db->query(" UPDATE  Statistics_MortuaryUse
                                SET     leavingDate = " . time() . "
                                WHERE   ID = $id");
        }

        /**
         * Elimina una plantilla
         * 
         * @param int $id Id de la plantilla
         * @return bool
         */
        public function controlPanelDelete($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            return $db->query(" UPDATE  Statistics_ControlPanel
                                SET     leavingDate = " . time() . "
                                WHERE   ID = $id");
        }

        /**
         * Elimina una plantilla
         * 
         * @param int $id Id de la plantilla
         * @return bool
         */
        public function pollDelete($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            return $db->query(" UPDATE  Statistics_Polls
                                SET     leavingDate = " . time() . "
                                WHERE   ID = $id");
        }

        /**
         * Elimina una plantilla
         * 
         * @param int $id Id de la plantilla
         * @return bool
         */
        public function economicPerformanceDelete($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            return $db->query(" UPDATE  Statistics_EconomicPerformance
                                SET     leavingDate = " . time() . "
                                WHERE   ID = $id");
        }

        /**
         * Obtiene el ID dado el extraID
         * 
         * @param string $extraID ExtraID
         * @return int
         */
        public function literalsGetIdByExtraId($extraID){
            $db = new DbHandler;

            $extraID = cleanStr($extraID);

            $result = $db->query("  SELECT  ID
                                    FROM    Statistics_Literals
                                    WHERE   extraID = '$extraID'");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['ID'];
        }

        /**
         * Obtiene el ID dado el extraID
         * 
         * @param string $extraID ExtraID
         * @return int
         */
        public function makingGetIdByExtraId($extraID){
            $db = new DbHandler;

            $extraID = cleanStr($extraID);

            $result = $db->query("  SELECT  ID
                                    FROM    Statistics_Making
                                    WHERE   extraID = '$extraID'");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['ID'];
        }

        /**
         * Obtiene el ID dado el extraID
         * 
         * @param string $extraID ExtraID
         * @return int
         */
        public function deceasedDestinationGetIdByExtraId($extraID){
            $db = new DbHandler;

            $extraID = cleanStr($extraID);

            $result = $db->query("  SELECT  ID
                                    FROM    Statistics_DeceasedDestination
                                    WHERE   extraID = '$extraID'");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['ID'];
        }

        /**
         * Obtiene el ID dado el extraID
         * 
         * @param string $extraID ExtraID
         * @return int
         */
        public function middleAgeGetIdByExtraId($extraID){
            $db = new DbHandler;

            $extraID = cleanStr($extraID);

            $result = $db->query("  SELECT  ID
                                    FROM    Statistics_MiddleAge
                                    WHERE   extraID = '$extraID'");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['ID'];
        }

        /**
         * Obtiene el ID dado el extraID
         * 
         * @param string $extraID ExtraID
         * @return int
         */
        public function generalGetIdByExtraId($extraID){
            $db = new DbHandler;

            $extraID = cleanStr($extraID);

            $result = $db->query("  SELECT  ID
                                    FROM    Statistics_General
                                    WHERE   extraID = '$extraID'");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['ID'];
        }

        /**
         * Obtiene el ID dado el extraID
         * 
         * @param string $extraID ExtraID
         * @return int
         */
        public function mortuaryUseGetIdByExtraId($extraID){
            $db = new DbHandler;

            $extraID = cleanStr($extraID);

            $result = $db->query("  SELECT  ID
                                    FROM    Statistics_MortuaryUse
                                    WHERE   extraID = '$extraID'");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['ID'];
        }

        /**
         * Obtiene el ID dado el extraID
         * 
         * @param string $extraID ExtraID
         * @return int
         */
        public function controlPanelGetIdByExtraId($extraID){
            $db = new DbHandler;

            $extraID = cleanStr($extraID);

            $result = $db->query("  SELECT  ID
                                    FROM    Statistics_ControlPanel
                                    WHERE   extraID = '$extraID'");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['ID'];
        }

        /**
         * Obtiene el ID dado el extraID
         * 
         * @param string $extraID ExtraID
         * @return int
         */
        public function pollGetIdByExtraId($extraID){
            $db = new DbHandler;

            $extraID = cleanStr($extraID);

            $result = $db->query("  SELECT  ID
                                    FROM    Statistics_Polls
                                    WHERE   extraID = '$extraID'");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['ID'];
        }

        /**
         * Obtiene el ID dado el extraID
         * 
         * @param string $extraID ExtraID
         * @return int
         */
        public function servicesTimesGetIdByExtraId($extraID){
            $db = new DbHandler;

            $extraID = cleanStr($extraID);

            $result = $db->query("  SELECT  ID
                                    FROM    Statistics_ServicesTimes
                                    WHERE   extraID = '$extraID'");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['ID'];
        }

        /**
         * Obtiene el ID dado el extraID
         * 
         * @param string $extraID ExtraID
         * @return int
         */
        public function economicPerformanceGetIdByExtraId($extraID){
            $db = new DbHandler;

            $extraID = cleanStr($extraID);

            $result = $db->query("  SELECT  ID
                                    FROM    Statistics_EconomicPeformance
                                    WHERE   extraID = '$extraID'");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['ID'];
        }

        /**
         * Obtiene las plantillas de asistencias
         * 
         * @return array Plantillas
         */
        public function literalsSearchTemplates(){
            $db = new DbHandler;

            $result = $db->query("  SELECT  ID, name
                                    FROM    Statistics_Literals
                                    WHERE   leavingDate IS NULL");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }
        /**********************************************************************************************************************************************************************/
        /**
         * Obtiene las estadisticas de  edad media
         * 
         * @return array Estadisticas
         */
        public function filterAge($data){
            $db = new DbHandler;

            // $data['clientType'] = cleanStr($data['clientType']);
            // $data['client'] = cleanStr($data['client']);
            $data['deceasedDateSince'] = cleanStr($data['deceasedDateSince']);
            $data['deceasedDateUntil'] = cleanStr($data['deceasedDateUntil']);
            $data['dateParticularSince'] = cleanStr($data['dateParticularSince']);
            $data['dateParticularUntil'] = cleanStr($data['dateParticularUntil']);
            $data['dateSeguroSince'] = cleanStr($data['dateSeguroSince']);
            $data['dateSeguroUntil'] = cleanStr($data['dateSeguroUntil']);
            $data['dateEmpresaSince'] = cleanStr($data['dateEmpresaSince']);
            $data['dateEmpresaUntil'] = cleanStr($data['dateEmpresaUntil']);
            $data['dateSeguroSince'] = cleanStr($data['dateSeguroSince']);
            $data['dateSeguroUntil'] = cleanStr($data['dateSeguroUntil']);

            $where = '';           
            //AND (e.clientType = 1 AND e.deceasedDate BETWEEN "2018-12-01" AND "2018-12-31" OR c.clientID = 1115 OR (e.clientType IN (3)))
            $flagDeceasedDate = true;
            if($data['clientType'] != ''){            

                //Obtener los datos del período de fechas para cada grupo de cliente                
                if(($data['dateParticularSince'] != '' && $data['dateParticularUntil'] != '') || ($data['dateSeguroSince'] != '' && $data['dateSeguroUntil'] != '' ) || ($data['dateEmpresaSince'] != '' && $data['dateEmpresaUntil'] != '')){
                    
                    //TODOS 
                    if($data['dateParticularSince'] != '' && $data['dateParticularUntil'] != '' && $data['dateSeguroSince'] != '' && $data['dateSeguroUntil'] != '' && $data['dateEmpresaSince'] != '' && $data['dateEmpresaUntil'] != ''){
                        
                        //Si hay clientes concretos seleccionados
                        if($data['client'] != ''){                            
                            $countP = 0;
                            $countS = 0;
                            $countE = 0;
                            $wherePart = '';
                            $whereSeg = '';
                            $whereEmpr = '';
                            
                            foreach($data['client'] as $elem){
                                $elem = cleanStr($elem);

                                //Para cada cliente buscar a que tipo pertenece
                                $type = $db->query("  SELECT      c.type                                                             
                                                        FROM        (Clients c)                                                                         
                                                        WHERE       c.clientID = $elem");
                                $ctype =  mysqli_num_rows($type) == 0 ? null : $db->resultToArray($type)[0]['type'];     
        
                                switch ($ctype) {
                                    case '1':
                                        $countP++;
                                        $wherePart .= $elem . ',';
                                        break;
                                    case '2':
                                        $countS++;
                                        $whereSeg .= $elem . ',';
                                        break;
                                    case '3':
                                        $countE++;
                                        $whereEmpr .= $elem . ',';
                                        break; 
                                } 
                            }
                                                       
                            $wherePart = substr($wherePart, 0, -1);
                            $wherePart .= ')';
                            $whereSeg = substr($whereSeg, 0, -1);
                            $whereSeg .= ')';
                            $whereEmpr = substr($whereEmpr, 0, -1);
                            $whereEmpr .= ')';

                            if($countP > 0){
                                $where .= ' AND (c.clientID IN ('. $wherePart . ' AND e.deceasedDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '"';
                            }
                            if($countS > 0){
                                if($countP > 0){
                                    $where .= ' OR c.clientID IN (';
                                }else{
                                    $where .= ' AND (c.clientID IN (';
                                }
                                $where .= $whereSeg . ' AND e.deceasedDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '"';
                            }
                            if($countE > 0){
                                if($countP == 0 && $countS == 0){
                                    $where .= ' AND (c.clientID IN (';
                                }else{
                                    $where .= ' OR c.clientID IN (';
                                }
                                $where .= $whereEmpr . ' AND e.deceasedDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '"';
                            }

                            if($countP == 0 && in_array(1,$data['clientType'])){
                                $where .= ' OR (e.clientType = 1 AND e.deceasedDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '") ';
                            }
                            if($countS == 0 && in_array(2,$data['clientType'])){
                                $where .= ' OR (e.clientType = 2 AND e.deceasedDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '")';
                            }
                            if($countE == 0 && in_array(3,$data['clientType'])){
                                $where .= ' OR (e.clientType = 3 AND e.deceasedDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '")';
                            }   
                            
                            $where .= ')';
                        }else{
                            $where .= ' AND ((e.clientType = 1 AND e.deceasedDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '")';
                            $where .= ' OR (e.clientType = 2 AND e.deceasedDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '")';
                            $where .= ' OR (e.clientType = 3 AND e.deceasedDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '"))';

                        }
                        //Para que no tenga en cuenta el filtro de fecha general y solo el de los periodos seleccionados
                        $flagDeceasedDate = false;
                           
                    }else{
                        //PARTICULARES Y SEGUROS
                        if(($data['dateParticularSince'] != '' && $data['dateParticularUntil'] != '') && ($data['dateSeguroSince'] != '' && $data['dateSeguroUntil'] != '' ) && ($data['dateEmpresaSince'] == '' && $data['dateEmpresaUntil'] == '')){
                                                        
                            //Si hay clientes concretos seleccionados
                            if($data['client'] != ''){                            
                                $countP = 0;
                                $countS = 0;
                                $countE = 0;
                                $wherePart = '';
                                $whereSeg = '';
                                $whereEmpr = '';
                                
                                foreach($data['client'] as $elem){
                                    $elem = cleanStr($elem);

                                    //Para cada cliente buscar a que tipo pertenece
                                    $type = $db->query("  SELECT      c.type                                                             
                                                            FROM        (Clients c)                                                                         
                                                            WHERE       c.clientID = $elem");
                                    $ctype =  mysqli_num_rows($type) == 0 ? null : $db->resultToArray($type)[0]['type'];     
            
                                    switch ($ctype) {
                                        case '1':
                                            $countP++;
                                            $wherePart .= $elem . ',';
                                            break;
                                        case '2':
                                            $countS++;
                                            $whereSeg .= $elem . ',';
                                            break;
                                        case '3':
                                            $countE++;
                                            $whereEmpr .= $elem . ',';
                                            break; 
                                    } 
                                }
                                                        
                                $wherePart = substr($wherePart, 0, -1);
                                $wherePart .= ')';
                                $whereSeg = substr($whereSeg, 0, -1);
                                $whereSeg .= ')';
                                $whereEmpr = substr($whereEmpr, 0, -1);
                                $whereEmpr .= ')';

                                if($countP > 0){
                                    $where .= ' AND (c.clientID IN ('. $wherePart . ' AND e.deceasedDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '"';
                                }
                                if($countS > 0){
                                    if($countP > 0){
                                        $where .= ' OR c.clientID IN (';
                                    }else{
                                        $where .= ' AND (c.clientID IN (';
                                    }
                                    $where .= $whereSeg . ' AND e.deceasedDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '"';
                                }
                                if($countE > 0){
                                    if($countP == 0 && $countS == 0){
                                        $where .= ' AND (c.clientID IN (';
                                    }else{
                                        $where .= ' OR c.clientID IN (';
                                    }
                                    $where .= $whereEmpr;
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    }  
                                    
                                }

                                if($countP == 0 && in_array(1,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 1 AND e.deceasedDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '") ';
                                }
                                if($countS == 0 && in_array(2,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 2 AND e.deceasedDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '")';
                                }
                                if($countE == 0 && in_array(3,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 3';
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    } 
                                    $where .= ')';
                                }   
                                
                                $where .= ')';
                                $flagDeceasedDate = false;
                            }else{
                               
                                $where .= ' AND ((e.clientType = 1 AND e.deceasedDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '")';
                                $where .= ' OR (e.clientType = 2 AND e.deceasedDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '")';
                               
                                if(count($data['clientType']) > 2){
                                    $where .= ' OR (e.clientType IN (';
                                    foreach($data['clientType'] as $elem){
                                        $elem = cleanStr($elem);
                                        if($elem != 2 && $elem != 1){
                                            $where .= $elem . ',';
                                        }
                                    }
                                    $where = substr($where, 0, -1);
                                    $where .= ')';
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    }  
                                    $where .= ')';
                                }
                                $where .= ')';   
                                $flagDeceasedDate = false;
                            }   
                        }
                        //PARTICULARES Y EMPRESAS
                        if(($data['dateParticularSince'] != '' && $data['dateParticularUntil'] != '') && ($data['dateSeguroSince'] == '' && $data['dateSeguroUntil'] == '' ) && ($data['dateEmpresaSince'] != '' && $data['dateEmpresaUntil'] != '')){
                            
                            //Si hay clientes concretos seleccionados
                            if($data['client'] != ''){                            
                                $countP = 0;
                                $countS = 0;
                                $countE = 0;
                                $wherePart = '';
                                $whereSeg = '';
                                $whereEmpr = '';
                                
                                foreach($data['client'] as $elem){
                                    $elem = cleanStr($elem);

                                    //Para cada cliente buscar a que tipo pertenece
                                    $type = $db->query("  SELECT      c.type                                                             
                                                            FROM        (Clients c)                                                                         
                                                            WHERE       c.clientID = $elem");
                                    $ctype =  mysqli_num_rows($type) == 0 ? null : $db->resultToArray($type)[0]['type'];     
            
                                    switch ($ctype) {
                                        case '1':
                                            $countP++;
                                            $wherePart .= $elem . ',';
                                            break;
                                        case '2':
                                            $countS++;
                                            $whereSeg .= $elem . ',';
                                            break;
                                        case '3':
                                            $countE++;
                                            $whereEmpr .= $elem . ',';
                                            break; 
                                    } 
                                }
                                                        
                                $wherePart = substr($wherePart, 0, -1);
                                $wherePart .= ')';
                                $whereSeg = substr($whereSeg, 0, -1);
                                $whereSeg .= ')';
                                $whereEmpr = substr($whereEmpr, 0, -1);
                                $whereEmpr .= ')';

                                if($countP > 0){
                                    $where .= ' AND (c.clientID IN ('. $wherePart . ' AND e.deceasedDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '"';
                                }
                                if($countS > 0){
                                    if($countP > 0){
                                        $where .= ' OR c.clientID IN (';
                                    }else{
                                        $where .= ' AND (c.clientID IN (';
                                    }
                                    $where .= $whereSeg;
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    }  
                                }
                                if($countE > 0){
                                    if($countP == 0 && $countS == 0){
                                        $where .= ' AND (c.clientID IN (';
                                    }else{
                                        $where .= ' OR c.clientID IN (';
                                    }
                                    $where .= $whereEmpr . ' AND e.deceasedDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '"';
                                }

                                if($countP == 0 && in_array(1,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 1 AND e.deceasedDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '") ';
                                }
                                if($countS == 0 && in_array(2,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 2';
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    } 
                                    $where .= ')';
                                }
                                if($countE == 0 && in_array(3,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 3 AND e.deceasedDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '")';
                                }   
                                
                                $where .= ')';
                                $flagDeceasedDate = false;
                            }else{
                                $where .= ' AND ((e.clientType = 1 AND e.deceasedDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '")';
                                $where .= ' OR (e.clientType = 3 AND e.deceasedDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '")';
                                
                                if(count($data['clientType']) > 2){
                                    $where .= ' OR (e.clientType IN (';
                                    foreach($data['clientType'] as $elem){
                                        $elem = cleanStr($elem);
                                        if($elem != 1 && $elem != 3){
                                            $where .= $elem . ',';
                                        }
                                    }
                                    $where = substr($where, 0, -1);
                                    $where .= ')';
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    }   
                                    $where .= ')';
                                } 
                                $where .= ')';  
                                $flagDeceasedDate = false;
                            }   
                        }

                        //SEGUROS Y EMPRESAS
                        if(($data['dateParticularSince'] == '' && $data['dateParticularUntil'] == '') && ($data['dateSeguroSince'] != '' && $data['dateSeguroUntil'] != '' ) && ($data['dateEmpresaSince'] != '' && $data['dateEmpresaUntil'] != '')){
                           //Si hay clientes concretos
                            if($data['client'] != ''){                            
                                $countP = 0;
                                $countS = 0;
                                $countE = 0;
                                $wherePart = '';
                                $whereSeg = '';
                                $whereEmpr = '';
                                
                                foreach($data['client'] as $elem){
                                    $elem = cleanStr($elem);

                                    //Para cada cliente buscar a que tipo pertenece
                                    $type = $db->query("  SELECT      c.type                                                             
                                                            FROM        (Clients c)                                                                         
                                                            WHERE       c.clientID = $elem");
                                    $ctype =  mysqli_num_rows($type) == 0 ? null : $db->resultToArray($type)[0]['type'];     
            
                                    switch ($ctype) {
                                        case '1':
                                            $countP++;
                                            $wherePart .= $elem . ',';
                                            break;
                                        case '2':
                                            $countS++;
                                            $whereSeg .= $elem . ',';
                                            break;
                                        case '3':
                                            $countE++;
                                            $whereEmpr .= $elem . ',';
                                            break; 
                                    } 
                                }
                                                        
                                $wherePart = substr($wherePart, 0, -1);
                                $wherePart .= ')';
                                $whereSeg = substr($whereSeg, 0, -1);
                                $whereSeg .= ')';
                                $whereEmpr = substr($whereEmpr, 0, -1);
                                $whereEmpr .= ')';
    
                                if($countP > 0){
                                    $where .= ' AND (c.clientID IN ('. $wherePart ;
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    }                                    
                                }
                                if($countS > 0){
                                    if($countP > 0){
                                        $where .= ' OR c.clientID IN (';
                                    }else{
                                        $where .= ' AND (c.clientID IN (';
                                    }
                                    $where .= $whereSeg . ' AND e.deceasedDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '"';
                                }
                                if($countE > 0){
                                    if($countP == 0 && $countS == 0){
                                        $where .= ' AND (c.clientID IN (';
                                    }else{
                                        $where .= ' OR c.clientID IN (';
                                    }
                                    $where .= $whereEmpr . ' AND e.deceasedDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '"';
                                }
    
                                if($countP == 0 && in_array(1,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 1';
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    } 
                                    $where .= ')';
                                }
                                if($countS == 0 && in_array(2,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 2 AND e.deceasedDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '")';
                                }
                                if($countE == 0 && in_array(3,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 3 AND e.deceasedDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '")';
                                }   
                                
                                $where .= ')';
                                $flagDeceasedDate = false;       

                            }else{
                                $where .= ' AND ((e.clientType = 2 AND e.deceasedDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '")';
                                $where .= ' OR (e.clientType = 3 AND e.deceasedDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '")';
                               
                                if(count($data['clientType']) > 2){
                                    $where .= ' OR (e.clientType IN (';
                                    foreach($data['clientType'] as $elem){
                                        $elem = cleanStr($elem);

                                        if($elem != 2 && $elem != 3){
                                            $where .= $elem . ',';
                                        }
                                    }
                                    $where = substr($where, 0, -1);
                                    $where .= ')';
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    }    
                                    $where .= ')';
                                }
                                $where .= ')';
                                $flagDeceasedDate = false;       
                            }
                        }
                        // SOLO PARTICULARES 
                        if(($data['dateParticularSince'] != '' && $data['dateParticularUntil'] != '') && ($data['dateSeguroSince'] == '' && $data['dateSeguroUntil'] == '' ) && ($data['dateEmpresaSince'] == '' && $data['dateEmpresaUntil'] == '')){
                            //Si hay clientes concretos seleccionados
                            if($data['client'] != ''){                            
                                $countP = 0;
                                $countS = 0;
                                $countE = 0;
                                $wherePart = '';
                                $whereSeg = '';
                                $whereEmpr = '';
                                
                                foreach($data['client'] as $elem){
                                    $elem = cleanStr($elem);

                                    //Para cada cliente buscar a que tipo pertenece
                                    $type = $db->query("  SELECT      c.type                                                             
                                                            FROM        (Clients c)                                                                         
                                                            WHERE       c.clientID = $elem");
                                    $ctype =  mysqli_num_rows($type) == 0 ? null : $db->resultToArray($type)[0]['type'];     
            
                                    switch ($ctype) {
                                        case '1':
                                            $countP++;
                                            $wherePart .= $elem . ',';
                                            break;
                                        case '2':
                                            $countS++;
                                            $whereSeg .= $elem . ',';
                                            break;
                                        case '3':
                                            $countE++;
                                            $whereEmpr .= $elem . ',';
                                            break; 
                                    } 
                                }
                                                        
                                $wherePart = substr($wherePart, 0, -1);
                                $wherePart .= ')';
                                $whereSeg = substr($whereSeg, 0, -1);
                                $whereSeg .= ')';
                                $whereEmpr = substr($whereEmpr, 0, -1);
                                $whereEmpr .= ')';

                                if($countP > 0){
                                    $where .= ' AND (c.clientID IN ('. $wherePart . ' AND e.deceasedDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '"';
                                }
                                if($countS > 0){
                                    if($countP > 0){
                                        $where .= ' OR c.clientID IN (';
                                    }else{
                                        $where .= ' AND (c.clientID IN (';
                                    }
                                    $where .= $whereSeg;
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    } 
                                }
                                if($countE > 0){
                                    if($countP == 0 && $countS == 0){
                                        $where .= ' AND (c.clientID IN (';
                                    }else{
                                        $where .= ' OR c.clientID IN (';
                                    }
                                    $where .= $whereEmpr;
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    } 
                                }

                                if($countP == 0 && in_array(1,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 1 AND e.deceasedDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '") ';
                                }
                                if($countS == 0 && in_array(2,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 2';
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    } 
                                    $where .= ')';
                                }
                                if($countE == 0 && in_array(3,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 3';
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    } 
                                    $where .= ')';
                                }                                   
                                $where .= ')';
                                $flagDeceasedDate = false;
                            }else{
                                
                                $where .= ' AND (e.clientType = 1 AND e.deceasedDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '"';                           
                                
                                if(count($data['clientType']) > 1){
                                    $where .= ' OR (e.clientType IN (';
                                    foreach($data['clientType'] as $elem){
                                        $elem = cleanStr($elem);

                                        if($elem != 1){
                                            $where .= $elem . ',';
                                        }
                                    }
                                    $where = substr($where, 0, -1);
                                    $where .= ')';
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    }  
                                    $where .= ')';
                                } 
                                $where .= ')'; 
                                $flagDeceasedDate = false;
                            }
                        }
                        //SOLO SEGUROS 
                        if(($data['dateParticularSince'] == '' && $data['dateParticularUntil'] == '') && ($data['dateSeguroSince'] != '' && $data['dateSeguroUntil'] != '' ) && ($data['dateEmpresaSince'] == '' && $data['dateEmpresaUntil'] == '')){
                            //Si hay clientes concretos seleccionados
                            if($data['client'] != ''){                            
                                $countP = 0;
                                $countS = 0;
                                $countE = 0;
                                $wherePart = '';
                                $whereSeg = '';
                                $whereEmpr = '';
                                
                                foreach($data['client'] as $elem){
                                    $elem = cleanStr($elem);

                                    //Para cada cliente buscar a que tipo pertenece
                                    $type = $db->query("  SELECT      c.type                                                             
                                                            FROM        (Clients c)                                                                         
                                                            WHERE       c.clientID = $elem");
                                    $ctype =  mysqli_num_rows($type) == 0 ? null : $db->resultToArray($type)[0]['type'];     
            
                                    switch ($ctype) {
                                        case '1':
                                            $countP++;
                                            $wherePart .= $elem . ',';
                                            break;
                                        case '2':
                                            $countS++;
                                            $whereSeg .= $elem . ',';
                                            break;
                                        case '3':
                                            $countE++;
                                            $whereEmpr .= $elem . ',';
                                            break; 
                                    } 
                                }
                                                        
                                $wherePart = substr($wherePart, 0, -1);
                                $wherePart .= ')';
                                $whereSeg = substr($whereSeg, 0, -1);
                                $whereSeg .= ')';
                                $whereEmpr = substr($whereEmpr, 0, -1);
                                $whereEmpr .= ')';

                                if($countP > 0){
                                    $where .= ' AND (c.clientID IN ('. $wherePart;
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    } 
                                }
                                if($countS > 0){
                                    if($countP > 0){
                                        $where .= ' OR c.clientID IN (';
                                    }else{
                                        $where .= ' AND (c.clientID IN (';
                                    }
                                    $where .= $whereSeg . ' AND e.deceasedDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '"';
                                }
                                if($countE > 0){
                                    if($countP == 0 && $countS == 0){
                                        $where .= ' AND (c.clientID IN (';
                                    }else{
                                        $where .= ' OR c.clientID IN (';
                                    }
                                    $where .= $whereEmpr;
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    }                                    
                                }

                                if($countP == 0 && in_array(1,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 1';
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    } 
                                    $where .= ')';
                                }
                                if($countS == 0 && in_array(2,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 2 AND e.deceasedDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '")';
                                }
                                if($countE == 0 && in_array(3,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 3';
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    } 
                                    $where .= ')';
                                }   
                                
                                $where .= ')';
                                $flagDeceasedDate = false;
                            }else{

                                $where .= ' AND (e.clientType = 2 AND e.deceasedDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '"';                           
                                   
                                if(count($data['clientType']) > 1){
                                    $where .= ' OR (e.clientType IN (';
                                    foreach($data['clientType'] as $elem){
                                        $elem = cleanStr($elem);

                                        if($elem != 2){
                                            $where .= $elem . ',';
                                        }
                                    }
                                    $where = substr($where, 0, -1);
                                    $where .= ')';
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    }   
                                    $where .= ')';
                                }
                                $where .= ')'; 
                                $flagDeceasedDate = false;

                            }
                        }
                        //SOLO EMPRESAS 
                        if(($data['dateParticularSince'] == '' && $data['dateParticularUntil'] == '') && ($data['dateSeguroSince'] == '' && $data['dateSeguroUntil'] == '' ) && ($data['dateEmpresaSince'] != '' && $data['dateEmpresaUntil'] != '')){
                            //Si hay clientes concretos seleccionados
                            if($data['client'] != ''){                            
                                $countP = 0;
                                $countS = 0;
                                $countE = 0;
                                $wherePart = '';
                                $whereSeg = '';
                                $whereEmpr = '';
                                
                                foreach($data['client'] as $elem){
                                    $elem = cleanStr($elem);

                                    //Para cada cliente buscar a que tipo pertenece
                                    $type = $db->query("  SELECT      c.type                                                             
                                                            FROM        (Clients c)                                                                         
                                                            WHERE       c.clientID = $elem");
                                    $ctype =  mysqli_num_rows($type) == 0 ? null : $db->resultToArray($type)[0]['type'];     
            
                                    switch ($ctype) {
                                        case '1':
                                            $countP++;
                                            $wherePart .= $elem . ',';
                                            break;
                                        case '2':
                                            $countS++;
                                            $whereSeg .= $elem . ',';
                                            break;
                                        case '3':
                                            $countE++;
                                            $whereEmpr .= $elem . ',';
                                            break; 
                                    } 
                                }
                                                        
                                $wherePart = substr($wherePart, 0, -1);
                                $wherePart .= ')';
                                $whereSeg = substr($whereSeg, 0, -1);
                                $whereSeg .= ')';
                                $whereEmpr = substr($whereEmpr, 0, -1);
                                $whereEmpr .= ')';

                                if($countP > 0){
                                    $where .= ' AND (c.clientID IN ('. $wherePart ;
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    }                                   
                                }
                                if($countS > 0){
                                    if($countP > 0){
                                        $where .= ' OR c.clientID IN (';
                                    }else{
                                        $where .= ' AND (c.clientID IN (';
                                    }
                                    $where .= $whereSeg;
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    }                                    
                                }
                                if($countE > 0){
                                    if($countP == 0 && $countS == 0){
                                        $where .= ' AND (c.clientID IN (';
                                    }else{
                                        $where .= ' OR c.clientID IN (';
                                    }
                                    $where .= $whereEmpr . ' AND e.deceasedDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '"';
                                }

                                if($countP == 0 && in_array(1,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 1';
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    } 
                                    $where .= ')';
                                }
                                if($countS == 0 && in_array(2,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 2';
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    } 
                                    $where .= ')';
                                }
                                if($countE == 0 && in_array(3,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 3 AND e.deceasedDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '")';
                                }   
                                
                                $where .= ')';
                            }else{

                                $where .= ' AND (e.clientType = 3 AND e.deceasedDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '"';                           
                                
                                if(count($data['clientType']) > 1){
                                    $where .= ' OR (e.clientType IN (';
                                    foreach($data['clientType'] as $elem){
                                        $elem = cleanStr($elem);

                                        if($elem != 3){
                                            $where .= $elem . ',';
                                        }
                                    }
                                    $where = substr($where, 0, -1);
                                    $where .= ')';
                                    if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                                        $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                                    }   
                                    $where .= ')'; 
                                }
                                $where .= ')'; 
                                $flagDeceasedDate = false;
                            }
                        }
                    }       
                }else{    
                    if($data['client'] != ''){
                        $where .= ' AND ( c.clientID IN (';
    
                        $countP = 0;
                        $countS = 0;
                        $countE = 0;
                        foreach($data['client'] as $elem){
                            $elem = cleanStr($elem);

                            //Para cada cliente buscar a que tipo pertenece
                            $type = $db->query("  SELECT      c.type                                                             
                                                    FROM        (Clients c)                                                                         
                                                    WHERE       c.clientID = $elem");
                            $ctype =  mysqli_num_rows($type) == 0 ? null : $db->resultToArray($type)[0]['type'];     
    
                            switch ($ctype) {
                                case '1':
                                    $countP++;
                                    break;
                                case '2':
                                    $countS++;
                                    break;
                                case '3':
                                    $countE++;
                                    break;   
                            } 
                            $where .= $elem . ',';
                        }
                        $where = substr($where, 0, -1);
    
                        $where .= ')';
                      
                        //No son clientes particulares
                        if($countP == 0 && in_array(1,$data['clientType'])){
                            $where .= ' OR e.clientType = 1';
                        }
                        if($countS == 0 && in_array(2,$data['clientType'])){
                            $where .= ' OR e.clientType = 2';
                        }
                        if($countE == 0 && in_array(3,$data['clientType'])){
                            $where .= ' OR e.clientType = 3';
                        }    
                        $where .= ')';           
                    }else{
                        $where .= ' AND e.clientType IN (';
                        foreach($data['clientType'] as $elem){
                            $elem = cleanStr($elem);

                            $where .= $elem . ',';
                        }
                        $where = substr($where, 0, -1);
                        $where .= ')';
                    }
                }
            }

            if($flagDeceasedDate){
                if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                    $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                }
            }

            if($data['gender'] != ''){
                switch ($data['gender']) {
                    case 'Hombre':
                        $where .= ' AND e.deceasedGender LIKE "Hombre"';
                        break;
                    case 'Mujer':
                        $where .= ' AND e.deceasedGender LIKE "Mujer"';
                        break;
                    case 'Todos':
                        $where .= ' AND e.deceasedGender IN ("Hombre", "Mujer")';
                        break;                    
                    default:
                        $where .= ' AND e.deceasedGender IN ("Hombre", "Mujer")';
                        break;
                }                
            }

            if($data['civilStatus'] != ''){
                $where .= ' AND e.deceasedMaritalStatus IN (';

                foreach($data['civilStatus'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= "'".$elem."'" . ',';
                }
                $where = substr($where, 0, -1);

                $where .= ')';
            }       
           
            $result = $db->query("  SELECT      e.deceasedGender, e.deceasedMaritalStatus, e.deceasedBirthday, e.deceasedDate, e.clientType,
                                                c.name as clientName, c.surname as clientSurname,  c.clientID     
                                    FROM        (Expedients e)
                                    LEFT JOIN   Clients c ON e.client = c.clientID                                    
                                    WHERE       e.leavingDate IS NULL AND e.type != 2
                                                $where
                                    ORDER BY    c.type, c.clientID
            ");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $expedients = $db->resultToArray($result);
                
                return $expedients;
            }
        }
        /***********************************************************************************************************************************************************************/
        /**
         * Obtiene las estadisticas del uso de tanatorio
         * 
         * @return array Estadisticas
         */
        public function filterMortuaryUse($data){
            $db = new DbHandler;

            // $data['clientType'] = cleanStr($data['clientType']);
            $data['dateParticularSince'] = cleanStr($data['dateParticularSince']);
            $data['dateParticularUntil'] = cleanStr($data['dateParticularUntil']);
            $data['dateSeguroSince'] = cleanStr($data['dateSeguroSince']);
            $data['dateSeguroUntil'] = cleanStr($data['dateSeguroUntil']);
            $data['dateEmpresaSince'] = cleanStr($data['dateEmpresaSince']);
            $data['dateEmpresaUntil'] = cleanStr($data['dateEmpresaUntil']);
            $data['stayDateSince'] = cleanStr($data['stayDateSince']);
            $data['stayDateUntil'] = cleanStr($data['stayDateUntil']);
            $data['stayTimeSince'] = cleanStr($data['stayTimeSince']);
            $data['stayTimeUntil'] = cleanStr($data['stayTimeUntil']);
            $data['deceasedRoom'] = cleanStr($data['deceasedRoom']);
            $data['daySince'] = cleanStr($data['daySince']);
            $data['dayUntil'] = cleanStr($data['dayUntil']);

            $where = '';   
            $flagDeceasedDate = true;        
            //Clientes
            if($data['clientType'] != ''){  
                
                //Obtener los datos del período de fechas para cada grupo de cliente                
                if(($data['dateParticularSince'] != '' && $data['dateParticularUntil'] != '') || ($data['dateSeguroSince'] != '' && $data['dateSeguroUntil'] != '' ) || ($data['dateEmpresaSince'] != '' && $data['dateEmpresaUntil'] != '')){
                    
                    //TODOS 
                    if($data['dateParticularSince'] != '' && $data['dateParticularUntil'] != '' && $data['dateSeguroSince'] != '' && $data['dateSeguroUntil'] != '' && $data['dateEmpresaSince'] != '' && $data['dateEmpresaUntil'] != ''){
                        
                        //Si hay clientes concretos seleccionados
                        if($data['client'] != ''){                            
                            $countP = 0;
                            $countS = 0;
                            $countE = 0;
                            $wherePart = '';
                            $whereSeg = '';
                            $whereEmpr = '';
                            
                            foreach($data['client'] as $elem){
                                $elem = cleanStr($elem);

                                //Para cada cliente buscar a que tipo pertenece
                                $type = $db->query("  SELECT      c.type                                                             
                                                        FROM        (Clients c)                                                                         
                                                        WHERE       c.clientID = $elem");
                                $ctype =  mysqli_num_rows($type) == 0 ? null : $db->resultToArray($type)[0]['type'];     
        
                                switch ($ctype) {
                                    case '1':
                                        $countP++;
                                        $wherePart .= $elem . ',';
                                        break;
                                    case '2':
                                        $countS++;
                                        $whereSeg .= $elem . ',';
                                        break;
                                    case '3':
                                        $countE++;
                                        $whereEmpr .= $elem . ',';
                                        break; 
                                } 
                            }
                                                       
                            $wherePart = substr($wherePart, 0, -1);
                            $wherePart .= ')';
                            $whereSeg = substr($whereSeg, 0, -1);
                            $whereSeg .= ')';
                            $whereEmpr = substr($whereEmpr, 0, -1);
                            $whereEmpr .= ')';

                            if($countP > 0){
                                $where .= ' AND (c.clientID IN ('. $wherePart . ' AND (e.funeralDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'].'")';
                            }
                            if($countS > 0){
                                if($countP > 0){
                                    $where .= ' OR c.clientID IN (';
                                }else{
                                    $where .= ' AND (c.clientID IN (';
                                }
                                $where .= $whereSeg . ' AND (e.funeralDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '")';
                            }
                            if($countE > 0){
                                if($countP == 0 && $countS == 0){
                                    $where .= ' AND (c.clientID IN (';
                                }else{
                                    $where .= ' OR c.clientID IN (';
                                }
                                $where .= $whereEmpr . ' AND (e.funeralDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '")';
                 
                            }

                            if($countP == 0 && in_array(1,$data['clientType'])){
                                $where .= ' OR (e.clientType = 1 AND (e.funeralDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '")) ';
                            }
                            if($countS == 0 && in_array(2,$data['clientType'])){
                                $where .= ' OR (e.clientType = 2 AND (e.funeralDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '"))';
                            }
                            if($countE == 0 && in_array(3,$data['clientType'])){
                                $where .= ' OR (e.clientType = 3 AND (e.funeralDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '"))';
                            }   
                            
                            $where .= ')';
                        }else{

                            $where .= ' AND ((e.clientType = 1 AND (e.funeralDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '"))';
                            $where .= ' OR (e.clientType = 2 AND (e.funeralDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '"))';
                            $where .= ' OR (e.clientType = 3 AND (e.funeralDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '")))';

                        }
                        //Para que no tenga en cuenta el filtro de fecha general y solo el de los periodos seleccionados
                        $flagDeceasedDate = false;
                           
                    }else{
                        //PARTICULARES Y SEGUROS
                        if(($data['dateParticularSince'] != '' && $data['dateParticularUntil'] != '') && ($data['dateSeguroSince'] != '' && $data['dateSeguroUntil'] != '' ) && ($data['dateEmpresaSince'] == '' && $data['dateEmpresaUntil'] == '')){
                                                        
                            //Si hay clientes concretos seleccionados
                            if($data['client'] != ''){                            
                                $countP = 0;
                                $countS = 0;
                                $countE = 0;
                                $wherePart = '';
                                $whereSeg = '';
                                $whereEmpr = '';
                                
                                foreach($data['client'] as $elem){
                                    $elem = cleanStr($elem);

                                    //Para cada cliente buscar a que tipo pertenece
                                    $type = $db->query("  SELECT      c.type                                                             
                                                            FROM        (Clients c)                                                                         
                                                            WHERE       c.clientID = $elem");
                                    $ctype =  mysqli_num_rows($type) == 0 ? null : $db->resultToArray($type)[0]['type'];     
            
                                    switch ($ctype) {
                                        case '1':
                                            $countP++;
                                            $wherePart .= $elem . ',';
                                            break;
                                        case '2':
                                            $countS++;
                                            $whereSeg .= $elem . ',';
                                            break;
                                        case '3':
                                            $countE++;
                                            $whereEmpr .= $elem . ',';
                                            break; 
                                    } 
                                }
                                                        
                                $wherePart = substr($wherePart, 0, -1);
                                $wherePart .= ')';
                                $whereSeg = substr($whereSeg, 0, -1);
                                $whereSeg .= ')';
                                $whereEmpr = substr($whereEmpr, 0, -1);
                                $whereEmpr .= ')';

                                if($countP > 0){
                                    $where .= ' AND (c.clientID IN ('. $wherePart . ' AND (e.funeralDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '")';
                                }
                                if($countS > 0){
                                    if($countP > 0){
                                        $where .= ' OR c.clientID IN (';
                                    }else{
                                        $where .= ' AND (c.clientID IN (';
                                    }
                                    $where .= $whereSeg . ' AND (e.funeralDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '")';
                                }
                                if($countE > 0){
                                    if($countP == 0 && $countS == 0){
                                        $where .= ' AND (c.clientID IN (';
                                    }else{
                                        $where .= ' OR c.clientID IN (';
                                    }
                                    $where .= $whereEmpr;                                    
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    } 
                                    
                                }

                                if($countP == 0 && in_array(1,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 1 AND (e.funeralDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '")) ';
                                }
                                if($countS == 0 && in_array(2,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 2 AND (e.funeralDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '"))';
                                }
                                if($countE == 0 && in_array(3,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 3';
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    } 
                                    $where .= ')';
                                }   
                                
                                $where .= ')';
                                $flagDeceasedDate = false;
                            }else{
                               
                                $where .= ' AND ((e.clientType = 1 AND (e.funeralDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '"))';
                                $where .= ' OR (e.clientType = 2 AND (e.funeralDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '" OR  e.funeralHomeEntryDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '"))';
                               
                                if(count($data['clientType']) > 2){
                                    $where .= ' OR (e.clientType IN (';
                                    foreach($data['clientType'] as $elem){
                                        if($elem != 2 && $elem != 1){
                                            $where .= $elem . ',';
                                        }
                                    }
                                    $where = substr($where, 0, -1);
                                    $where .= ')';
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    }  
                                    $where .= ')';
                                }
                                $where .= ')';   
                                $flagDeceasedDate = false;
                            }   
                        }
                        //PARTICULARES Y EMPRESAS
                        if(($data['dateParticularSince'] != '' && $data['dateParticularUntil'] != '') && ($data['dateSeguroSince'] == '' && $data['dateSeguroUntil'] == '' ) && ($data['dateEmpresaSince'] != '' && $data['dateEmpresaUntil'] != '')){
                            
                            //Si hay clientes concretos seleccionados
                            if($data['client'] != ''){                            
                                $countP = 0;
                                $countS = 0;
                                $countE = 0;
                                $wherePart = '';
                                $whereSeg = '';
                                $whereEmpr = '';
                                
                                foreach($data['client'] as $elem){
                                    $elem = cleanStr($elem);

                                    //Para cada cliente buscar a que tipo pertenece
                                    $type = $db->query("  SELECT      c.type                                                             
                                                            FROM        (Clients c)                                                                         
                                                            WHERE       c.clientID = $elem");
                                    $ctype =  mysqli_num_rows($type) == 0 ? null : $db->resultToArray($type)[0]['type'];     
            
                                    switch ($ctype) {
                                        case '1':
                                            $countP++;
                                            $wherePart .= $elem . ',';
                                            break;
                                        case '2':
                                            $countS++;
                                            $whereSeg .= $elem . ',';
                                            break;
                                        case '3':
                                            $countE++;
                                            $whereEmpr .= $elem . ',';
                                            break; 
                                    } 
                                }
                                                        
                                $wherePart = substr($wherePart, 0, -1);
                                $wherePart .= ')';
                                $whereSeg = substr($whereSeg, 0, -1);
                                $whereSeg .= ')';
                                $whereEmpr = substr($whereEmpr, 0, -1);
                                $whereEmpr .= ')';

                                if($countP > 0){
                                    $where .= ' AND (c.clientID IN ('. $wherePart . ' AND (e.funeralDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '")';
                                }
                                if($countS > 0){
                                    if($countP > 0){
                                        $where .= ' OR c.clientID IN (';
                                    }else{
                                        $where .= ' AND (c.clientID IN (';
                                    }
                                    $where .= $whereSeg;
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    }  
                                }
                                if($countE > 0){
                                    if($countP == 0 && $countS == 0){
                                        $where .= ' AND (c.clientID IN (';
                                    }else{
                                        $where .= ' OR c.clientID IN (';
                                    }
                                    $where .= $whereEmpr . ' AND (e.funeralDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '")';
                                }

                                if($countP == 0 && in_array(1,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 1 AND (e.funeralDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '")) ';
                                }
                                if($countS == 0 && in_array(2,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 2';
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    }  
                                    $where .= ')';
                                }
                                if($countE == 0 && in_array(3,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 3 AND (e.funeralDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '"))';
                                }   
                                
                                $where .= ')';
                                $flagDeceasedDate = false;
                            }else{
                                $where .= ' AND ((e.clientType = 1 AND (e.funeralDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '"))';
                                $where .= ' OR (e.clientType = 3 AND (e.funeralDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '"))';
                                
                                if(count($data['clientType']) > 2){
                                    $where .= ' OR (e.clientType IN (';
                                    foreach($data['clientType'] as $elem){
                                        $elem = cleanStr($elem);

                                        if($elem != 1 && $elem != 3){
                                            $where .= $elem . ',';
                                        }
                                    }
                                    $where = substr($where, 0, -1);
                                    $where .= ')';
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    }   
                                    $where .= ')';
                                } 
                                $where .= ')';  
                                $flagDeceasedDate = false;
                            }   
                        }

                        //SEGUROS Y EMPRESAS
                        if(($data['dateParticularSince'] == '' && $data['dateParticularUntil'] == '') && ($data['dateSeguroSince'] != '' && $data['dateSeguroUntil'] != '' ) && ($data['dateEmpresaSince'] != '' && $data['dateEmpresaUntil'] != '')){
                           
                           //Si hay clientes concretos
                            if($data['client'] != ''){                            
                                $countP = 0;
                                $countS = 0;
                                $countE = 0;
                                $wherePart = '';
                                $whereSeg = '';
                                $whereEmpr = '';
                                
                                foreach($data['client'] as $elem){
                                    $elem = cleanStr($elem);

                                    //Para cada cliente buscar a que tipo pertenece
                                    $type = $db->query("  SELECT      c.type                                                             
                                                            FROM        (Clients c)                                                                         
                                                            WHERE       c.clientID = $elem");
                                    $ctype = mysqli_num_rows($type) == 0 ? null : $db->resultToArray($type)[0]['type'];     
            
                                    switch ($ctype) {
                                        case '1':
                                            $countP++;
                                            $wherePart .= $elem . ',';
                                            break;
                                        case '2':
                                            $countS++;
                                            $whereSeg .= $elem . ',';
                                            break;
                                        case '3':
                                            $countE++;
                                            $whereEmpr .= $elem . ',';
                                            break; 
                                    } 
                                }
                                                        
                                $wherePart = substr($wherePart, 0, -1);
                                $wherePart .= ')';
                                $whereSeg = substr($whereSeg, 0, -1);
                                $whereSeg .= ')';
                                $whereEmpr = substr($whereEmpr, 0, -1);
                                $whereEmpr .= ')';
    
                                if($countP > 0){
                                    $where .= ' AND (c.clientID IN ('. $wherePart ;
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    }                                     
                                }
                                if($countS > 0){
                                    if($countP > 0){
                                        $where .= ' OR c.clientID IN (';
                                    }else{
                                        $where .= ' AND (c.clientID IN (';
                                    }
                                    $where .= $whereSeg . ' AND (e.funeralDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '")';
                                }
                                if($countE > 0){
                                    if($countP == 0 && $countS == 0){
                                        $where .= ' AND (c.clientID IN (';
                                    }else{
                                        $where .= ' OR c.clientID IN (';
                                    }
                                    $where .= $whereEmpr . ' AND (e.funeralDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '")';
                                }
    
                                if($countP == 0 && in_array(1,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 1';                                    
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    }
                                    $where .= ')';
                                }
                                if($countS == 0 && in_array(2,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 2 AND (e.funeralDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '"))';
                                }
                                if($countE == 0 && in_array(3,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 3 AND (e.funeralDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '"))';
                                }   
                                
                                $where .= ')';
                                $flagDeceasedDate = false;       

                            }else{
                                $where .= ' AND ((e.clientType = 2 AND (e.funeralDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '"))';
                                $where .= ' OR (e.clientType = 3 AND (e.funeralDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '"))';
                               
                                if(count($data['clientType']) > 2){
                                    $where .= ' OR (e.clientType IN (';
                                    foreach($data['clientType'] as $elem){
                                        $elem = cleanStr($elem);
                                        
                                        if($elem != 2 && $elem != 3){
                                            $where .= $elem . ',';
                                        }
                                    }
                                    $where = substr($where, 0, -1);
                                    $where .= ')';
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    }  
                                    $where .= ')';
                                }
                                $where .= ')';
                                $flagDeceasedDate = false;       
                            }
                        }
                        // SOLO PARTICULARES 
                        if(($data['dateParticularSince'] != '' && $data['dateParticularUntil'] != '') && ($data['dateSeguroSince'] == '' && $data['dateSeguroUntil'] == '' ) && ($data['dateEmpresaSince'] == '' && $data['dateEmpresaUntil'] == '')){
                            
                            //Si hay clientes concretos seleccionados
                            if($data['client'] != ''){                            
                                $countP = 0;
                                $countS = 0;
                                $countE = 0;
                                $wherePart = '';
                                $whereSeg = '';
                                $whereEmpr = '';
                                
                                foreach($data['client'] as $elem){
                                    $elem = cleanStr($elem);

                                    //Para cada cliente buscar a que tipo pertenece
                                    $type = $db->query("  SELECT      c.type                                                             
                                                            FROM        (Clients c)                                                                         
                                                            WHERE       c.clientID = $elem");
                                    $ctype =  mysqli_num_rows($type) == 0 ? null : $db->resultToArray($type)[0]['type'];     
            
                                    switch ($ctype) {
                                        case '1':
                                            $countP++;
                                            $wherePart .= $elem . ',';
                                            break;
                                        case '2':
                                            $countS++;
                                            $whereSeg .= $elem . ',';
                                            break;
                                        case '3':
                                            $countE++;
                                            $whereEmpr .= $elem . ',';
                                            break; 
                                    } 
                                }
                                                        
                                $wherePart = substr($wherePart, 0, -1);
                                $wherePart .= ')';
                                $whereSeg = substr($whereSeg, 0, -1);
                                $whereSeg .= ')';
                                $whereEmpr = substr($whereEmpr, 0, -1);
                                $whereEmpr .= ')';

                                if($countP > 0){
                                    $where .= ' AND (c.clientID IN ('. $wherePart . ' AND (e.funeralDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '")';
                                }
                                if($countS > 0){
                                    if($countP > 0){
                                        $where .= ' OR c.clientID IN (';
                                    }else{
                                        $where .= ' AND (c.clientID IN (';
                                    }
                                    $where .= $whereSeg;
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    }
                                }
                                if($countE > 0){
                                    if($countP == 0 && $countS == 0){
                                        $where .= ' AND (c.clientID IN (';
                                    }else{
                                        $where .= ' OR c.clientID IN (';
                                    }
                                    $where .= $whereEmpr;
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    }
                                }

                                if($countP == 0 && in_array(1,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 1 AND (e.funeralDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '")) ';
                                }
                                if($countS == 0 && in_array(2,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 2';
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    }
                                    $where .= ')';
                                }
                                if($countE == 0 && in_array(3,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 3';
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    }
                                    $where .= ')';
                                }                                   
                                $where .= ')';
                                $flagDeceasedDate = false;
                            }else{
                                $where .= ' AND (e.clientType = 1 AND (e.funeralDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateParticularSince'] . '" AND "' . $data['dateParticularUntil'] . '")';                           
                                
                                if(count($data['clientType']) > 1){
                                    $where .= ' OR (e.clientType IN (';
                                    foreach($data['clientType'] as $elem){
                                        $elem = cleanStr($elem);

                                        if($elem != 1){
                                            $where .= $elem . ',';
                                        }
                                    }
                                    $where = substr($where, 0, -1);
                                    $where .= ')';
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    } 
                                    $where .= ')';
                                } 
                                $where .= ')'; 
                                $flagDeceasedDate = false;

                            }
                        }
                        //SOLO SEGUROS 
                        if(($data['dateParticularSince'] == '' && $data['dateParticularUntil'] == '') && ($data['dateSeguroSince'] != '' && $data['dateSeguroUntil'] != '' ) && ($data['dateEmpresaSince'] == '' && $data['dateEmpresaUntil'] == '')){
                            //Si hay clientes concretos seleccionados
                            if($data['client'] != ''){                            
                                $countP = 0;
                                $countS = 0;
                                $countE = 0;
                                $wherePart = '';
                                $whereSeg = '';
                                $whereEmpr = '';
                                
                                foreach($data['client'] as $elem){
                                    $elem = cleanStr($elem);

                                    //Para cada cliente buscar a que tipo pertenece
                                    $type = $db->query("  SELECT      c.type                                                             
                                                            FROM        (Clients c)                                                                         
                                                            WHERE       c.clientID = $elem");
                                    $ctype =  mysqli_num_rows($type) == 0 ? null : $db->resultToArray($type)[0]['type'];     
            
                                    switch ($ctype) {
                                        case '1':
                                            $countP++;
                                            $wherePart .= $elem . ',';
                                            break;
                                        case '2':
                                            $countS++;
                                            $whereSeg .= $elem . ',';
                                            break;
                                        case '3':
                                            $countE++;
                                            $whereEmpr .= $elem . ',';
                                            break; 
                                    } 
                                }
                                                        
                                $wherePart = substr($wherePart, 0, -1);
                                $wherePart .= ')';
                                $whereSeg = substr($whereSeg, 0, -1);
                                $whereSeg .= ')';
                                $whereEmpr = substr($whereEmpr, 0, -1);
                                $whereEmpr .= ')';

                                if($countP > 0){
                                    $where .= ' AND (c.clientID IN ('. $wherePart;
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    }
                                }
                                if($countS > 0){
                                    if($countP > 0){
                                        $where .= ' OR c.clientID IN (';
                                    }else{
                                        $where .= ' AND (c.clientID IN (';
                                    }
                                    $where .= $whereSeg . ' AND (e.funeralDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '")';
                                }
                                if($countE > 0){
                                    if($countP == 0 && $countS == 0){
                                        $where .= ' AND (c.clientID IN (';
                                    }else{
                                        $where .= ' OR c.clientID IN (';
                                    }
                                    $where .= $whereEmpr;
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    }                                   
                                }

                                if($countP == 0 && in_array(1,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 1';
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    }
                                    $where .= ')';
                                }
                                if($countS == 0 && in_array(2,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 2 AND (e.funeralDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '"))';
                                }
                                if($countE == 0 && in_array(3,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 3';
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    } 
                                    $where .= ')';
                                }   
                                
                                $where .= ')';
                                $flagDeceasedDate = false;
                            }else{

                                $where .= ' AND (e.clientType = 2 AND (e.funeralDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateSeguroSince'] . '" AND "' . $data['dateSeguroUntil'] . '")';                           
                                   
                                if(count($data['clientType']) > 1){
                                    $where .= ' OR (e.clientType IN (';
                                    foreach($data['clientType'] as $elem){
                                        $elem = cleanStr($elem);
                                        
                                        if($elem != 2){
                                            $where .= $elem . ',';
                                        }
                                    }
                                    $where = substr($where, 0, -1);
                                    $where .= ')';
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    }    
                                    $where .= ')';
                                }
                                $where .= ')'; 
                                $flagDeceasedDate = false;

                            }
                        }
                        //SOLO EMPRESAS 
                        if(($data['dateParticularSince'] == '' && $data['dateParticularUntil'] == '') && ($data['dateSeguroSince'] == '' && $data['dateSeguroUntil'] == '' ) && ($data['dateEmpresaSince'] != '' && $data['dateEmpresaUntil'] != '')){
                            //Si hay clientes concretos seleccionados
                            if($data['client'] != ''){                            
                                $countP = 0;
                                $countS = 0;
                                $countE = 0;
                                $wherePart = '';
                                $whereSeg = '';
                                $whereEmpr = '';
                                
                                foreach($data['client'] as $elem){
                                    $elem = cleanStr($elem);

                                    //Para cada cliente buscar a que tipo pertenece
                                    $type = $db->query("  SELECT      c.type                                                             
                                                            FROM        (Clients c)                                                                         
                                                            WHERE       c.clientID = $elem");
                                    $ctype =  mysqli_num_rows($type) == 0 ? null : $db->resultToArray($type)[0]['type'];     
            
                                    switch ($ctype) {
                                        case '1':
                                            $countP++;
                                            $wherePart .= $elem . ',';
                                            break;
                                        case '2':
                                            $countS++;
                                            $whereSeg .= $elem . ',';
                                            break;
                                        case '3':
                                            $countE++;
                                            $whereEmpr .= $elem . ',';
                                            break; 
                                    } 
                                }
                                                        
                                $wherePart = substr($wherePart, 0, -1);
                                $wherePart .= ')';
                                $whereSeg = substr($whereSeg, 0, -1);
                                $whereSeg .= ')';
                                $whereEmpr = substr($whereEmpr, 0, -1);
                                $whereEmpr .= ')';

                                if($countP > 0){
                                    $where .= ' AND (c.clientID IN ('. $wherePart ;
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    }                                   
                                }
                                if($countS > 0){
                                    if($countP > 0){
                                        $where .= ' OR c.clientID IN (';
                                    }else{
                                        $where .= ' AND (c.clientID IN (';
                                    }
                                    $where .= $whereSeg;
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    }                                     
                                }
                                if($countE > 0){
                                    if($countP == 0 && $countS == 0){
                                        $where .= ' AND (c.clientID IN (';
                                    }else{
                                        $where .= ' OR c.clientID IN (';
                                    }
                                    $where .= $whereEmpr . ' AND (e.funeralDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '")';
                                }

                                if($countP == 0 && in_array(1,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 1';
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    } 
                                    $where .= ')';
                                }
                                if($countS == 0 && in_array(2,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 2';
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    }  
                                    $where .= ')';
                                }
                                if($countE == 0 && in_array(3,$data['clientType'])){
                                    $where .= ' OR (e.clientType = 3 AND (e.funeralDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '"))';
                                }   
                                
                                $where .= ')';
                            }else{

                                $where .= ' AND (e.clientType = 3 AND (e.funeralDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['dateEmpresaSince'] . '" AND "' . $data['dateEmpresaUntil'] . '")';                           
                                
                                if(count($data['clientType']) > 1){
                                    $where .= ' OR (e.clientType IN (';
                                    foreach($data['clientType'] as $elem){
                                        $elem = cleanStr($elem);

                                        if($elem != 3){
                                            $where .= $elem . ',';
                                        }
                                    }
                                    $where = substr($where, 0, -1);
                                    $where .= ')';
                                    if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                                        $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                                    }   
                                    $where .= ')'; 
                                }
                                $where .= ')'; 
                                $flagDeceasedDate = false;
                            }
                        }
                    }       
                }else{    
                    if($data['client'] != ''){
                        $where .= ' AND ( c.clientID IN (';
    
                        $countP = 0;
                        $countS = 0;
                        $countE = 0;
                        foreach($data['client'] as $elem){
                            $elem = cleanStr($elem);

                            //Para cada cliente buscar a que tipo pertenece
                            $type = $db->query("  SELECT      c.type                                                             
                                                FROM        (Clients c)                                                                         
                                                WHERE       c.clientID = $elem");
                            $ctype =  mysqli_num_rows($type) == 0 ? null : $db->resultToArray($type)[0]['type'];     
    
                            switch ($ctype) {
                                case '1':
                                    $countP++;
                                    break;
                                case '2':
                                    $countS++;
                                    break;
                                case '3':
                                    $countE++;
                                    break;   
                            } 
                            $where .= $elem . ',';
                        }
                        $where = substr($where, 0, -1);
    
                        $where .= ')';
                      
                        //No son clientes particulares
                        if($countP == 0 && in_array(1,$data['clientType'])){
                            $where .= ' OR e.clientType = 1';
                        }
                        if($countS == 0 && in_array(2,$data['clientType'])){
                            $where .= ' OR e.clientType = 2';
                        }
                        if($countE == 0 && in_array(3,$data['clientType'])){
                            $where .= ' OR e.clientType = 3';
                        }    
                        $where .= ')';           
                    }else{

                        $where .= ' AND e.clientType IN (';
                        foreach($data['clientType'] as $elem){
                            $elem = cleanStr($elem);

                            $where .= $elem . ',';
                        }
                        $where = substr($where, 0, -1);
                        $where .= ')';
                    }
                }
            }
            //Fecha de estancia: la fecha de entrada al tanatorio o la fecha del funeral (salida del tanatorio), está en el rango de fechas seleccionadas
            if($flagDeceasedDate){
                if($data['stayDateSince'] != '' && $data['stayDateUntil'] != ''){
                    $where .= ' AND (e.funeralDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '" OR e.funeralHomeEntryDate BETWEEN "' . $data['stayDateSince'] . '" AND "' . $data['stayDateUntil'] . '")';
                }
            }
            //Hora de estancia: la fecha de entrada al tanatorio o la fecha del funeral (salida del tanatorio), está en el rango de fechas seleccionadas
            if($data['stayTimeSince'] != '' && $data['stayTimeUntil'] != ''){
                $where .= ' AND (e.funeralTime BETWEEN "' . $data['stayTimeSince'] . '" AND "' . $data['stayTimeUntil'] . '" OR e.funeralHomeEntryTime BETWEEN "' . $data['stayTimeSince'] . '" AND "' . $data['stayTimeUntil'] . '")';
            }
            //Sala
            if($data['deceasedRoom'] != '' ){
                $where .= ' AND e.deceasedRoom = "' . $data['deceasedRoom'] . '" ' ;
            }
            //Casa mortuoria
            if($data['mortuary'] != ''){
                $where .= ' AND e.deceasedMortuary IN (';
                foreach($data['mortuary'] as $elem){
                    $elem = cleanStr($elem);

                    $where .= "'".$elem."'" . ',';
                }
                $where = substr($where, 0, -1);
                $where .= ')';
            }   
            //Rango de días 
            if($data['daySince'] != '' && $data['dayUntil'] != ''){               
                $where .= ' AND (DAYOFWEEK(e.funeralDate) BETWEEN "' . $data['daySince'] . '" AND "' . $data['dayUntil'] . '" OR DAYOFWEEK(e.funeralHomeEntryDate) BETWEEN "' . $data['daySince'] . '" AND "' . $data['dayUntil'] . '")';
            }

            $result = $db->query("      SELECT      e.expedientID, e.clientType, e.deceasedMortuary, eh.model, e.priceExp, pp.priceNoIVA, eh.check, e.funeralHomeEntryDate, e.funeralDate,
                                                    m.name as mortuaryName,
                                                    c.name as clientName, c.surname as clientSurname,  c.clientID     
                                        FROM        (Expedients_Hirings eh, Expedients e)
                                        LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                        LEFT JOIN   Products p ON eh.product = p.productID
                                        LEFT JOIN 	Products_Prices pp ON eh.model = pp.model  AND pp.price = e.priceExp
                                        LEFT JOIN   Clients c ON e.client = c.clientID
                                        WHERE       eh.num_hiring = (SELECT MAX(eh2.num_hiring) FROM Expedients_Hirings eh2 WHERE eh2.expedient = e.expedientID) AND
                                                    eh.expedient = e.expedientID AND 
                                                    p.name LIKE '%sala%' AND 
                                                    e.type != 2 AND 
                                                    e.leavingDate IS NULL AND 
                                                    eh.check = 1 
                                                    $where
                                        GROUP BY    e.expedientID
                                        ORDER BY    e.deceasedMortuary DESC
            ");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{

                $expedients = $db->resultToArray($result);
                $currentMortuary = '';
                $array_rooms = array();
                //Obtener los servicios por salsa por cada tantorio
                foreach ($expedients as $key => $value) {
                  
                    if($currentMortuary != $value['deceasedMortuary']){
                        $mortuary = $value['deceasedMortuary'];

                        $whereSubQuery = str_replace('e.', 'e2.', $where);
                        $whereSubQuery = str_replace('m.', 'm2.', $whereSubQuery);
                        $whereSubQuery = str_replace('c.', 'c2.', $whereSubQuery);
                        $whereSubQuery = str_replace('pp.', 'pp2.', $whereSubQuery);
                        $rooms = $db->query("   SELECT      e.deceasedRoom, 
                                                            (
                                                                SELECT      COUNT( DISTINCT e2.expedientID)
                                                                FROM        (Expedients_Hirings eh2, Expedients e2)
                                                                LEFT JOIN   Mortuaries m2 ON e2.deceasedMortuary = m2.mortuaryID                                
                                                                LEFT JOIN   Products p2 ON eh2.product = p2.productID
                                                                LEFT JOIN   Clients c2 ON e2.client = c2.clientID
                                                                WHERE       eh2.expedient = e2.expedientID AND
                                                                            e2.leavingDate IS NULL AND 
                                                                            p2.name LIKE '%sala%' AND
                                                                            e2.deceasedMortuary = '$mortuary' AND 
                                                                            eh2.check = 1  AND 
                                                                            e2.deceasedRoom = e.deceasedRoom $whereSubQuery
                                                            ) as numServices,
                                                            AVG(pp.priceNoIVA * eh.amount - pp.priceNoIVA * eh.amount * eh.discount / 100) as avgPrice
                                                FROM        (Expedients_Hirings eh, Expedients e)                               
                                                LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID    
                                                LEFT JOIN   Products p ON eh.product = p.productID 
                                                LEFT JOIN 	Products_Prices pp ON eh.model = pp.model  AND pp.price = e.priceExp
                                                LEFT JOIN   Clients c ON e.client = c.clientID
                                                WHERE       eh.expedient = e.expedientID AND
                                                            e.leavingDate IS NULL AND 
                                                            p.name LIKE '%sala%' AND
                                                            e.deceasedMortuary = '$mortuary' AND 
                                                            eh.check = 1 AND
                                                            e.type != 2
                                                            $where
                                                GROUP BY    e.deceasedRoom");

                        $room =  mysqli_num_rows($rooms) == 0 ? null : $db->resultToArray($rooms); 
                        if($value['deceasedMortuary'] == ''){
                            $array_rooms['vacio'] = $room;
                        }else{
                            $array_rooms[$value['deceasedMortuary']] = $room;
                        }
                        $currentMortuary = $value['deceasedMortuary'];
                    }
                }
                $expedients['rooms'] =  $array_rooms;   

                //Obtener el día mas concurrido
                $currentMortuary = '';
                $concurrentDay = '';
                $concurrentDayArray = array();               
                foreach ($expedients as $key => $value) {
                    
                    if(strval($key) != 'rooms'){
                        $array_fechas = array();
                        
                        if($currentMortuary != $value['deceasedMortuary']){
                            $mortuary = $value['deceasedMortuary'];
                            if($mortuary != null){
                                $days = $db->query("SELECT      e.expedientID, e.deceasedMortuary, e.funeralHomeEntryDate, 
                                                                DAYOFWEEK(e.funeralHomeEntryDate) as funerEntryDayOfWeek, 
                                                                e.funeralDate, 
                                                                DAYOFWEEK(e.funeralDate) as funerExitDayofWeek, 
                                                                DATEDIFF(e.funeralDate, e.funeralHomeEntryDate) as difDays                                                                                
                                                    FROM        (Expedients_Hirings eh, Expedients e)
                                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                                    LEFT JOIN   Products p ON eh.product = p.productID
                                                    LEFT JOIN 	Products_Prices pp ON eh.model = pp.model AND pp.price = e.priceExp
                                                    LEFT JOIN   Clients c ON e.client = c.clientID
                                                    WHERE       num_hiring = (SELECT MAX(eh2.num_hiring) FROM Expedients_Hirings eh2 WHERE eh2.expedient = e.expedientID) AND 
                                                                eh.expedient = e.expedientID AND 
                                                                p.name LIKE '%sala%' AND 
                                                                e.leavingDate IS NULL AND 
                                                                e.type != 2 AND 
                                                                eh.check = 1 AND 
                                                                e.deceasedMortuary = $mortuary 
                                                                $where
                                                    GROUP BY    e.expedientID
                                ");
    
                                $days =  mysqli_num_rows($days) == 0 ? null : $db->resultToArray($days); 
                                
                                if($days != null){
                                    foreach ($days as $k => $v) {
                                        //Dia de entrada al tanatorio
                                        if($v['funeralHomeEntryDate'] != null){
                                            //Comprobar si la fecha existe en la array                                         
                                            if(array_key_exists ($v['funerEntryDayOfWeek'], $array_fechas)){                                            
                                                $array_fechas[$v['funerEntryDayOfWeek']] = intVal($array_fechas[$v['funerEntryDayOfWeek']]) + 1;                                            
                                            }else{                                            
                                                $array_fechas[$v['funerEntryDayOfWeek']] = 1;
                                            }                                       
                                        }
                                        //Días de estancia
                                        if($v['difDays'] != null){                                        
                                            $dia_actual = $v['funerEntryDayOfWeek'];                                        
                                            for ($i=1; $i < $v['difDays']; $i++) { 
                                                //sumo 1 día  
                                                $dia_actual++;  
                                                if($dia_actual == 8){
                                                    $dia_actual = 1;
                                                }                                  
                                                if(array_key_exists ($dia_actual, $array_fechas)){                                                                                                
                                                    $array_fechas[$dia_actual] = intVal($array_fechas[$dia_actual]) + 1;
                                                }else{                                            
                                                    $array_fechas[$dia_actual] = 1;
                                                }
                                            }                                    
                                        } 
                                        //Día de salida del tanatorio
                                        if($v['funeralDate'] != null){
                                            //Comprobar si la fecha existe en la array                                        
                                            if(array_key_exists ($v['funerExitDayofWeek'], $array_fechas)){                                            
                                                $array_fechas[$v['funerExitDayofWeek']] = intVal($array_fechas[$v['funerExitDayofWeek']]) + 1;
                                            }else{                                            
                                                $array_fechas[$v['funerExitDayofWeek']] = 1;
                                            }                                        
                                        }
                                    }
                                    //Obtener los días más concurridos
                                    //$concurrentDay = max($array_fechas).'/';
                                    $concurrentDay ='';                                
                                    foreach ($array_fechas as $dia => $val) {                                    
                                        if($val == max($array_fechas)){                                        
                                            if($data['daySince'] != '' && $data['dayUntil'] != ''){               
                                               if($dia >= $data['daySince'] && $dia <= $data['dayUntil']){                                               
                                                   $concurrentDay .= $dia.' ';
                                               }
                                            }else{
                                                $concurrentDay .= $dia.' ';
                                            }                             
                                            
                                        }                                    
                                    }  
                                }                            
                                $concurrentDayArray[$mortuary] = $concurrentDay;                              
                                $currentMortuary = $value['deceasedMortuary'];
                            }
                        }
                    }
                }
                $expedients['days'] =  $concurrentDayArray;
                
                return $expedients;
            }
        }

        /**
         * Obtiene información de los servicios para un cliente, un lugar de fallecimiento y un tanatorio en concreto
         * 
         * @param int $client Cliente
         * @param int $deceasedLocation Lugar de fallecimiento
         * @param int $mortuary Tanatorio
         * @param string $destination Tipo
         * @return array
         */
        public function getServicesInfoDestination($data){
            $db = new DbHandler;

            $client = cleanStr($data['client']);
            $deceasedLocation = cleanStr($data['deceasedLocation']);
            $mortuary = cleanStr($data['mortuary']);
            $destination = cleanStr($data['destination']);
            $deceasedDateSince = cleanStr($data['deceasedDateSince']);
            $deceasedDateUntil = cleanStr($data['deceasedDateUntil']);

            $where = '';
            switch($destination){
                case 'chcr':
                    $where .= "(e.churchLabel LIKE '%iglesia parroquial%' AND e.church IS NOT NULL) AND e.cemetery IS NULL AND e.crematorium IS NOT NULL";
                break;
                case 'chce':
                    $where .= "(e.churchLabel LIKE '%iglesia parroquial%' AND e.church IS NOT NULL) AND (e.cemeteryLabel LIKE '%cementerio%' AND e.cemetery IS NOT NULL) AND e.crematorium IS NULL";
                break;
                case 'chcecr':
                    $where .= "(e.churchLabel LIKE '%iglesia parroquial%' AND e.church IS NOT NULL) AND (e.cemeteryLabel LIKE '%cementerio%' AND e.cemetery IS NOT NULL) AND e.crematorium IS NOT NULL";
                break;
                case 'cr':
                    $where .= "e.church IS NULL AND e.cemetery IS NULL AND e.crematorium IS NOT NULL";
                break;
                case 'ce':
                    $where .= "e.church IS NULL AND (e.cemeteryLabel LIKE '%cementerio%' AND e.cemetery IS NOT NULL) AND e.crematorium IS NULL";
                break;
                case 'cccr':
                    $where .= "e.cemeteryLabel LIKE '%ceremonia civil%' AND e.cemetery IS NULL AND e.crematorium IS NOT NULL";
                break;
                case 'cccecr':
                    $where .= "e.cemeteryLabel LIKE '%ceremonia civil%' AND (e.cemeteryLabel LIKE '%cementerio%' AND e.cemetery IS NOT NULL) AND e.crematorium IS NOT NULL";
                break;
                default:
                    $where .= "e.churchLabel LIKE '%otro%' OR e.cemeteryLabel LIKE '%otro%'";
                break;
            }

            if($deceasedDateSince != '' && $deceasedDateUntil != ''){
                $where .= " AND e.deceasedDate BETWEEN '$deceasedDateSince' AND '$deceasedDateUntil'";
            }

            if($data['church'] != ''){
                $where .= " AND (";
                foreach($data['church'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= "e.church = $elem OR ";
                }
                $where = substr($where, 0, -4) . ")";
            }
            if($data['cemetery'] != ''){
                $where .= " AND (";
                foreach($data['cemetery'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= "e.cemetery = $elem OR ";
                }
                $where = substr($where, 0, -4) . ")";
            }
            if($data['crematorium'] != ''){
                $where .= " AND (";
                foreach($data['crematorium'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= "e.crematorium = $elem OR ";
                }
                $where = substr($where, 0, -4) . ")";
            }
            if($data['locationDestination'] != ''){
                $where .= " AND (";
                foreach($data['locationDestination'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= "(l1.locationID = {$elem} OR l2.locationID = {$elem} OR l3.locationID = {$elem}) OR ";
                }
                $where = substr($where, 0, -4) . ")";
            }
            if($data['gender'] != ''){
                switch($data['gender']){
                    case 'Hombre':
                        $where .= " AND e.deceasedGender = 'Hombre'";
                    break;
                    case 'Mujer':
                        $where .= " AND e.deceasedGender = 'Mujer'";
                    break;
                }
            }

            $result = $db->query("  SELECT      e.expedientID, e.deceasedGender as gender, e.number,
                                                ch.name as church,
                                                cr.name as crematorium,
                                                ce.name as cemetery,
                                                cl.name as clientName,
                                                di.name as deceasedInName,
                                                mo.name as mortuaryName
                                    FROM        Expedients e
                                    LEFT JOIN   DeceasedIn di ON e.deceasedLocation = di.deceasedInID
                                    LEFT JOIN   Mortuaries mo ON e.deceasedMortuary = mo.mortuaryID
                                    LEFT JOIN   Clients cl ON e.client = cl.clientID
                                    LEFT JOIN   Churches ch ON e.church = ch.churchID
                                    LEFT JOIN   Crematoriums cr ON e.crematorium = cr.crematoriumID
                                    LEFT JOIN   Cemeteries ce ON e.cemetery = ce.cemeteryID
                                    LEFT JOIN   Locations l1 ON ch.location = l1.locationID
                                    LEFT JOIN   Locations l2 ON ce.location = l2.locationID
                                    LEFT JOIN   Locations l3 ON cr.location = l3.locationID
                                    WHERE       $where AND
                                                e.client = $client AND
                                                e.type = 1 AND
                                                e.deceasedLocation = $deceasedLocation AND
                                                e.deceasedMortuary = $mortuary AND
                                                e.leavingDate IS NULL
                                    ORDER BY    e.church, e.crematorium, e.cemetery, e.expedientID");
                                                
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $expedients = $db->resultToArray($result);

                foreach($expedients as $index => $elem){
                    $expedient = $elem['expedientID'];

                    $result = $db->query("  SELECT  SUM(pr.purchasePrice) as total
                                            FROM    Expedients_Hirings eh, Products_Retails pr, Expedients e
                                            WHERE   eh.expedient = $expedient AND
                                                    eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = e.expedientID AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    ) AND
                                                    eh.model = pr.model AND
                                                    eh.check = 1 AND
                                                    eh.expedient = e.expedientID AND
                                                    pr.year = YEAR(e.entryDate)");

                    if(mysqli_num_rows($result) > 0){
                        $expedients[$index]['cost'] = $db->resultToArray($result)[0]['total'];
                    }
                }

                return $expedients;
            }
        }

        /**
         * Generales - Totales
         * 
         * @param int $year Año
         * @return array
         */
        public function getTotals($year, $covid){
            $db = new DbHandler;

            $year = cleanStr($year);
            $covid = cleanStr($covid);

            $where = $year == null ? '' : "AND YEAR(e.requestDate) = $year";
            switch($covid){
                case '-':
                    $where2 = "";
                break;
                case '0':
                    $where2 = "AND (e.covid = 0 OR e.covid IS NULL)";
                break;
                case '1':
                    $where2 = "AND e.covid = 1";
                break;
                default:
                    $where2 = "";
                break;
            }

            $result = $db->query("  SELECT      e.number, e.requestDate, MONTH(e.requestDate), YEAR(e.requestDate), DAYOFWEEK(e.requestDate), DAYNAME(e.requestDate),
                                                e.requestTime, null, null, es.arriveTime, e.funeralHomeEntryTime, e.deceasedName, e.deceasedSurname, e.deceasedNIF,
                                                e.deceasedGender, e.deceasedNationality, e.deceasedBirthday, l.name, e.deceasedDate, c.name, c.surname, c.brandName
                                    FROM        (Expedients e)
                                    LEFT JOIN   Expedients_Services es ON es.expedient = e.expedientID
                                    LEFT JOIN   Locations l ON l.locationID = e.deceasedBirthdayLocation
                                    LEFT JOIN   Clients c ON c.clientID = e.client
                                    WHERE       e.leavingDate IS NULL AND e.type != 2 $where $where2
                                    ORDER BY    e.requestDate DESC");

            return mysqli_num_rows($result) == 0 ? [] : $db->resultToArrayValue($result);
        }

        /**
         * Obtiene los distintos años de las fechas de entrada de los expedientes
         * 
         * @return array
         */
        public function getYearsTotal(){
            $db = new DbHandler;

            $result = $db->query("  SELECT      DISTINCT(YEAR(e.requestDate)) as year
                                    FROM        Expedients e
                                    WHERE       e.leavingDate IS NULL AND e.type != 2
                                    ORDER BY    year");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }

        /**
         * Obtiene el resumen de la estadística general
         * 
         * @param int $year Año
         * @return array
         */
        public function getSummaryGeneral($year){
            $db = new DbHandler;

            $year = cleanStr($year);

            $where = $year == null ? '' : "AND YEAR(e.requestDate) = $year";

            // Lunes
            $result = $db->query("  SELECT		e.requestTime
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 2 AND
                                                e.type = 1
                                                $where");

            $dayMonday = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);

            // Martes
            $result = $db->query("  SELECT		e.requestTime
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 3 AND
                                                e.type = 1
                                                $where");

            $dayTuesday = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);

            // Miércoles
            $result = $db->query("  SELECT		e.requestTime
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 4 AND
                                                e.type = 1
                                                $where");

            $dayWednesday = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);

            // Jueves
            $result = $db->query("  SELECT		e.requestTime
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 5 AND
                                                e.type = 1
                                                $where");

            $dayThursday = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);

            // Viernes
            $result = $db->query("  SELECT		e.requestTime
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 6 AND
                                                e.type = 1
                                                $where");

            $dayFriday = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);

            // Sábado
            $result = $db->query("  SELECT		e.requestTime
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 7 AND
                                                e.type = 1
                                                $where");

            $daySaturday = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);

            // Domingo
            $result = $db->query("  SELECT		e.requestTime
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 1 AND
                                                e.type = 1
                                                $where");

            $daySunday = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);

            // Lunes covid
            $result = $db->query("  SELECT		e.requestTime, e.number
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 2 AND
                                                e.type = 1 AND
                                                e.covid = 1
                                                $where");

            $covidMonday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);

            // Martes covid
            $result = $db->query("  SELECT		e.requestTime, e.number
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 3 AND
                                                e.type = 1 AND
                                                e.covid = 1
                                                $where");

            $covidTuesday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);

            // Miércoles covid
            $result = $db->query("  SELECT		e.requestTime, e.number
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 4 AND
                                                e.type = 1 AND
                                                e.covid = 1
                                                $where");

            $covidWednesday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);

            // Jueves covid
            $result = $db->query("  SELECT		e.requestTime, e.number
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 5 AND
                                                e.type = 1 AND
                                                e.covid = 1
                                                $where");

            $covidThursday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);

            // Viernes covid
            $result = $db->query("  SELECT		e.requestTime, e.number
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 6 AND
                                                e.type = 1 AND
                                                e.covid = 1
                                                $where");

            $covidFriday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);

            // Sábado covid
            $result = $db->query("  SELECT		e.requestTime, e.number
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 7 AND
                                                e.type = 1 AND
                                                e.covid = 1
                                                $where");

            $covidSaturday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);

            // Domingo covid
            $result = $db->query("  SELECT		e.requestTime, e.number
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 1 AND
                                                e.type = 1 AND
                                                e.covid = 1
                                                $where");

            $covidSunday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);

            $covid = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);

            return array(
                'monday' => $dayMonday,
                'tuesday' => $dayTuesday,
                'wednesday' => $dayWednesday,
                'thursday' => $dayThursday,
                'friday' => $dayFriday,
                'saturday' => $daySaturday,
                'sunday' => $daySunday,
                'covidMonday' => $covidMonday,
                'covidTuesday' => $covidTuesday,
                'covidWednesday' => $covidWednesday,
                'covidThursday' => $covidThursday,
                'covidFriday' => $covidFriday,
                'covidSaturday' => $covidSaturday,
                'covidSunday' => $covidSunday,
            );
        }

        /**
         * Obtiene el resumen de la estadística general
         * 
         * @param int $year Año
         * @return array
         */
        public function getGeneralStatistics($dateStart, $dateEnd, $products, $mortuaries){
            $db = new DbHandler;

            $from = '';
            $where = '';
            
            $dateStart = cleanStr($dateStart);
            $dateEnd = cleanStr($dateEnd);
        
            if($dateStart != null && $dateEnd != null){
                $where .= " AND e.entryDate BETWEEN '$dateStart' AND '$dateEnd' ";
            }

            $whereCC = '';
            if($mortuaries != ''){
                $where .= " AND e.deceasedMortuary = cc.mortuary AND cc.ID IN (";
                $whereCC .= " AND e.deceasedMortuary = cc.mortuary AND cc.ID IN (";
                foreach($mortuaries as $elem){
                    $elem = cleanStr($elem);
                    
                    $where .= " $elem,";
                    $whereCC .= " $elem,";
                }
                
                $from = ', Cost_Center cc';
                $where = substr($where, 0, -1);
                $where .= ")";

                $whereCC = substr($where, 0, -1);
                $whereCC .= ")";
            }

            $where2 = '';
            $where3 = '';
            if($products != ''){
                $where2 .= ' AND p.productID IN (';
                $where3 .= ' OR p.productID IN (';

                foreach($products as $elem){
                    $elem = cleanStr($elem);
                    $where2 .= $elem . ',';
                    $where3 .= $elem . ',';
                }
                $where2 = substr($where2, 0, -1);
                $where3 = substr($where3, 0, -1);

                $where2 .= ')';
                $where3 .= ')';
            }

            //Obtenemos todos los clientes que son seguros y están en algun expediente
            $result = $db->query("  SELECT DISTINCT c.clientID
                                    FROM Expedients e, Clients c $from
                                    WHERE e.clientType = 2 
                                        AND e.client = c.clientID 
                                        AND e.leavingDate IS NULL
                                        AND c.leavingDate IS NULL
                                        AND e.type != 2 
                                        $whereCC
            ");

            $clientsInsurance = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);
            
            $expedientes = array();
            $coronas = array();
            $ramos = array();
            $cremaciones = array();
            $numHombres = array();
            $edadMediaHombres = array();
            $numMujeres = array();
            $edadMediaMujeres = array();
            $baseImponibleMedia = array();
            $margenBruto = array();
            $iva = array();
            $totalFacturado = array();
            $tiempoCobro = array();
            $tiempoRespuesta = array();

            if(count($clientsInsurance) > 0){
                foreach($clientsInsurance as $client){
        
                    $id = $client["clientID"];

                    //Num de Expedientes
                    if($where2 != ''){
                        $result = $db->query("  SELECT  c.clientID, c.name, COUNT(DISTINCT e.expedientID) as expedients
                                                FROM    Expedients e, Clients c, Expedients_Hirings eh, Products p $from
                                                WHERE   e.client = $id
                                                    AND e.expedientID = eh.expedient
                                                    AND eh.check = 1
                                                    AND eh.product = p.productID
                                                    AND c.clientID = e.client
                                                    AND e.leavingDate IS NULL  
                                                    AND e.type != 2
                                                    AND eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = e.expedientID AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    )
                                                    AND (
                                                        SELECT  COUNT(*)
                                                        FROM    Invoices inv
                                                        WHERE   inv.expedient = e.expedientID AND
                                                                inv.leavingDate IS NULL
                                                    ) > 0
                                                    $where
                                                    $where2
                        ");
                    }else{
                      
                        $result = $db->query("  SELECT  c.clientID, c.name,
                                                        (	SELECT	COUNT(*)
                                                            FROM 	Expedients e $from
                                                            WHERE	c.clientID = e.client
                                                                AND e.leavingDate IS NULL  
                                                                AND e.type != 2
                                                                $where
                                                        ) as expedients
                                                FROM	Clients c
                                                WHERE   c.clientID = $id
                        ");
                    }
                    $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                    array_push($expedientes, $info);

                    //Buscamos los productos 'Coronas' dentro de los expedientes
                    if($where2 != ''){
                        //Con IVA
                        $result = $db->query("  SELECT  COUNT(*) * eh.amount as coronas, SUM(eh.amount * eh.total) as importeFacturadoCoronas, 
                                                        SUM(pr.purchasePrice * eh.amount) as precioCosteCoronas, SUM(eh.amount * eh.total) - SUM(pr.purchasePrice * eh.amount) as margenSinIvaCoronas
                                                FROM    Products p, Expedients e, Expedients_Hirings eh, Products_Retails pr $from
                                                WHERE   e.expedientID = eh.expedient
                                                    AND eh.product = p.productID
                                                    AND p.name LIKE '%Corona%'
                                                    AND eh.check = 1 
                                                    AND e.client = $id
                                                    AND eh.model = pr.model
                                                    AND pr.year = YEAR(e.requestDate)
                                                    AND e.leavingDate IS NULL 
                                                    AND e.type != 2
                                                    AND eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = e.expedientID AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    ) AND
                                                    (
                                                        SELECT  COUNT(*)
                                                        FROM    Invoices inv
                                                        WHERE   inv.expedient = e.expedientID AND
                                                                inv.leavingDate IS NULL
                                                    ) > 0
                                                    $where
                                                    $where2
                        ");
                    }else{
                        $result = $db->query("  SELECT COUNT(*) * eh.amount as coronas, SUM(eh.amount * eh.total) as importeFacturadoCoronas, 
                                                        SUM(pr.purchasePrice * eh.amount) as precioCosteCoronas, SUM(eh.amount * eh.total) - SUM(pr.purchasePrice * eh.amount) as margenSinIvaCoronas
                                                    FROM Products p, Expedients e, Expedients_Hirings eh, Products_Retails pr  $from
                                                    WHERE e.expedientID = eh.expedient
                                                        AND eh.product = p.productID
                                                        AND p.name LIKE '%Corona%'
                                                        AND eh.check = 1 
                                                        AND e.client = $id
                                                        AND eh.model = pr.model
                                                        AND pr.year = YEAR(e.requestDate)
                                                        AND e.leavingDate IS NULL 
                                                        AND e.type != 2
                                                        AND eh.num_hiring = (
                                                            SELECT  MAX(i2.num_hiring) 
                                                            FROM    Invoices i2 
                                                            WHERE   i2.expedient = e.expedientID AND
                                                                    i2.leavingDate IS NULL AND
                                                                    i2.invoice_type != 3
                                                        ) AND
                                                        (
                                                            SELECT  COUNT(*)
                                                            FROM    Invoices inv
                                                            WHERE   inv.expedient = e.expedientID AND
                                                                    inv.leavingDate IS NULL
                                                        ) > 0
                                                        $where
                        ");
                    }
                    $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                    array_push($coronas, $info);

                    //Buscamos los productos 'Centros' dentro de los expedientes
                    if($where2 != ''){
                        //Con IVA
                        $result = $db->query("  SELECT COUNT(*) * eh.amount as ramos, SUM(eh.amount * eh.total) as importeFacturadoRamos, 
                                                        SUM(pr.purchasePrice * eh.amount) as precioCosteRamos, SUM(eh.amount * eh.total) - SUM(pr.purchasePrice * eh.amount) as margenSinIvaRamos
                                                    FROM Products p, Expedients e, Expedients_Hirings eh, Products_Retails pr $from
                                                    WHERE e.expedientID = eh.expedient
                                                        AND eh.product = p.productID
                                                        AND p.name LIKE '%Centros%' 
                                                        AND eh.check = 1 
                                                        AND e.client = $id
                                                        AND eh.model = pr.model
                                                        AND pr.year = YEAR(e.requestDate)
                                                        AND e.leavingDate IS NULL 
                                                        AND e.type != 2
                                                        AND eh.num_hiring = (
                                                            SELECT  MAX(i2.num_hiring) 
                                                            FROM    Invoices i2 
                                                            WHERE   i2.expedient = e.expedientID AND
                                                                    i2.leavingDate IS NULL AND
                                                                    i2.invoice_type != 3
                                                        ) AND
                                                        (
                                                            SELECT  COUNT(*)
                                                            FROM    Invoices inv
                                                            WHERE   inv.expedient = e.expedientID AND
                                                                    inv.leavingDate IS NULL
                                                        ) > 0
                                                        $where 
                                                        $where2
                        ");
                    }else{
                        $result = $db->query("  SELECT COUNT(e.expedientID) as expedients, COUNT(*) * eh.amount as ramos, SUM(eh.amount * eh.total) as importeFacturadoRamos, 
                                                        SUM(pr.purchasePrice * eh.amount) as precioCosteRamos, SUM(eh.amount * eh.total) - SUM(pr.purchasePrice * eh.amount) as margenSinIvaRamos
                                                FROM Products p, Expedients e, Expedients_Hirings eh, Products_Retails pr $from
                                                WHERE e.expedientID = eh.expedient
                                                    AND eh.product = p.productID
                                                    AND p.name LIKE '%Centros%' 
                                                    AND eh.check = 1 
                                                    AND e.client = $id
                                                    AND eh.model = pr.model
                                                    AND pr.year = YEAR(e.requestDate)
                                                    AND e.leavingDate IS NULL 
                                                    AND e.type != 2
                                                    AND eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = e.expedientID AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    ) AND
                                                    (
                                                        SELECT  COUNT(*)
                                                        FROM    Invoices inv
                                                        WHERE   inv.expedient = e.expedientID AND
                                                                inv.leavingDate IS NULL
                                                    ) > 0
                                                    $where
                        ");
                    }
                    $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                    array_push($ramos, $info);

                    //Buscamos los productos 'Cremaciones' dentro de los expedientes
                    if($where2 != ''){
                        //Con IVA
                        $result = $db->query("  SELECT COUNT(e.expedientID) as expedients, COUNT(*) * eh.amount as cremaciones, SUM(eh.amount * eh.total) as importeFacturadoCremaciones, 
                                                        SUM(pr.purchasePrice * eh.amount) as precioCosteCremaciones, SUM(eh.amount * eh.total) - SUM(pr.purchasePrice * eh.amount) as margenSinIvaCremaciones
                                                FROM Products p, Expedients e, Expedients_Hirings eh, Products_Retails pr $from
                                                WHERE e.expedientID = eh.expedient
                                                    AND eh.product = p.productID
                                                    AND p.name LIKE '%Cremación%'
                                                    AND eh.check = 1 
                                                    AND e.client = $id
                                                    AND eh.model = pr.model
                                                    AND pr.year = YEAR(e.requestDate)
                                                    AND e.leavingDate IS NULL 
                                                    AND e.type != 2
                                                    AND eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = e.expedientID AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    ) AND
                                                    (
                                                        SELECT  COUNT(*)
                                                        FROM    Invoices inv
                                                        WHERE   inv.expedient = e.expedientID AND
                                                                inv.leavingDate IS NULL
                                                    ) > 0
                                                    $where
                                                    $where2
                        ");
                    }else{
                        //Con IVA
                        $result = $db->query("  SELECT COUNT(e.expedientID) as expedients, COUNT(*) * eh.amount as cremaciones, SUM(eh.amount * eh.total) as importeFacturadoCremaciones, 
                                                        SUM(pr.purchasePrice * eh.amount) as precioCosteCremaciones, SUM(eh.amount * eh.total) - SUM(pr.purchasePrice * eh.amount) as margenSinIvaCremaciones
                                                FROM Products p, Expedients e, Expedients_Hirings eh, Products_Retails pr $from
                                                WHERE e.expedientID = eh.expedient
                                                    AND eh.product = p.productID
                                                    AND p.name LIKE '%Cremación%' 
                                                    AND eh.check = 1 
                                                    AND e.client = $id
                                                    AND eh.model = pr.model
                                                    AND pr.year = YEAR(e.requestDate)
                                                    AND e.leavingDate IS NULL 
                                                    AND e.type != 2
                                                    AND eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = e.expedientID AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    ) AND
                                                    (
                                                        SELECT  COUNT(*)
                                                        FROM    Invoices inv
                                                        WHERE   inv.expedient = e.expedientID AND
                                                                inv.leavingDate IS NULL
                                                    ) > 0
                                                    $where
                        ");
                    }
                    $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                    array_push($cremaciones, $info);

                    //NUM DE HOMBRES Y EDAD MEDIA DE LOS HOMBRES
                    if($where2 != ''){
                        $result = $db->query("  SELECT COUNT(DISTINCT (e.expedientID)) as num
                                                FROM Expedients e, Expedients_Hirings eh, Products p $from
                                                WHERE e.client = $id
                                                    AND e.expedientID = eh.expedient
                                                    AND eh.check = 1
                                                    AND eh.product = p.productID
                                                    AND e.leavingDate IS NULL 
                                                    AND e.deceasedGender = 'Hombre'
                                                    AND e.type != 2
                                                    AND eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = e.expedientID AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    ) AND
                                                    (
                                                        SELECT  COUNT(*)
                                                        FROM    Invoices inv
                                                        WHERE   inv.expedient = e.expedientID AND
                                                                inv.leavingDate IS NULL
                                                    ) > 0
                                                    $where
                                                    $where2
                        ");

                        $numExpedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]["num"];
                        array_push($numHombres, $numExpedients);
                    
                        $result = $db->query("  SELECT DISTINCT (e.expedientID)
                                                FROM Expedients e, Expedients_Hirings eh, Products p $from
                                                WHERE e.client = $id
                                                    AND e.expedientID = eh.expedient
                                                    AND eh.product = p.productID
                                                    AND eh.check = 1
                                                    AND e.leavingDate IS NULL 
                                                    AND e.deceasedGender = 'Hombre'
                                                    AND e.deceasedBirthday IS NOT NULL 
                                                    AND e.deceasedDate IS NOT NULL 
                                                    AND e.type != 2
                                                    AND eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = e.expedientID AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    ) AND
                                                    (
                                                        SELECT  COUNT(*)
                                                        FROM    Invoices inv
                                                        WHERE   inv.expedient = e.expedientID AND
                                                                inv.leavingDate IS NULL
                                                    ) > 0
                                                    $where
                                                    $where2
                                            ");
                        $expedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);
        
                    }else{
                        $result = $db->query("  SELECT  COUNT(DISTINCT (e.expedientID)) as num
                                                FROM    Expedients e $from
                                                WHERE   e.client = $id
                                                    AND e.leavingDate IS NULL 
                                                    AND e.deceasedGender = 'Hombre'
                                                    AND e.type != 2 AND
                                                    (
                                                        SELECT  COUNT(*)
                                                        FROM    Invoices inv
                                                        WHERE   inv.expedient = e.expedientID AND
                                                                inv.leavingDate IS NULL
                                                    ) > 0
                                                    $where");
        
                        $numExpedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]["num"];
                        array_push($numHombres, $numExpedients);
        
                        $result = $db->query("  SELECT  DISTINCT (e.expedientID)
                                                FROM    Expedients e $from
                                                WHERE   e.client = $id
                                                    AND e.leavingDate IS NULL 
                                                    AND e.deceasedGender = 'Hombre'
                                                    AND e.deceasedBirthday IS NOT NULL 
                                                    AND e.deceasedDate IS NOT NULL 
                                                    AND e.type != 2 AND
                                                    (
                                                        SELECT  COUNT(*)
                                                        FROM    Invoices inv
                                                        WHERE   inv.expedient = e.expedientID AND
                                                                inv.leavingDate IS NULL
                                                    ) > 0
                                                    $where");
        
                        $expedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);
                    }

                    $edadMedia = 0;
                    if($expedients != 0 && count($expedients) > 0){
                        $edadMedia = 0;
                        $item = 0;
                        foreach($expedients as $expedient){
                            $expedientID = $expedient["expedientID"];
                            $result = $db->query("  SELECT  SUM(YEAR(e.deceasedDate) - YEAR(e.deceasedBirthday)) AS edadMedia
                                                    FROM    Expedients e
                                                    WHERE   e.expedientID = $expedientID");
                            
                            $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]["edadMedia"];
                            $edadMedia += $info;
                            $item++;
                        }
                        if($item != 0){
                            $edadMedia = $edadMedia / $item;
                        }
                    }
                    array_push($edadMediaHombres, $edadMedia);
                    
                    //NUM DE MUJERES Y EDAD MEDIA DE LAS MUJERES
                    if($where2 != ''){
                        $result = $db->query("  SELECT COUNT(DISTINCT (e.expedientID)) as num
                                                FROM Expedients e, Expedients_Hirings eh, Products p $from
                                                WHERE e.client = $id
                                                    AND e.expedientID = eh.expedient
                                                    AND eh.check = 1
                                                    AND eh.product = p.productID
                                                    AND e.leavingDate IS NULL 
                                                    AND e.deceasedGender = 'Mujer'
                                                    AND e.type != 2
                                                    AND eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = e.expedientID AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    ) AND
                                                    (
                                                        SELECT  COUNT(*)
                                                        FROM    Invoices inv
                                                        WHERE   inv.expedient = e.expedientID AND
                                                                inv.leavingDate IS NULL
                                                    ) > 0
                                                    $where
                                                    $where2
                        ");
                        $numExpedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]["num"];
                        array_push($numMujeres, $numExpedients);
                    
                        $result = $db->query("  SELECT DISTINCT (e.expedientID)
                                                FROM Expedients e, Expedients_Hirings eh, Products p $from
                                                WHERE e.client = $id
                                                    AND e.expedientID = eh.expedient
                                                    AND eh.product = p.productID
                                                    AND eh.check = 1
                                                    AND e.leavingDate IS NULL 
                                                    AND e.deceasedGender = 'Mujer'
                                                    AND e.deceasedBirthday IS NOT NULL 
                                                    AND e.deceasedDate IS NOT NULL 
                                                    AND e.type != 2
                                                    AND eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = e.expedientID AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    ) AND
                                                    (
                                                        SELECT  COUNT(*)
                                                        FROM    Invoices inv
                                                        WHERE   inv.expedient = e.expedientID AND
                                                                inv.leavingDate IS NULL
                                                    ) > 0
                                                    $where
                                                    $where2
                                            ");
                        $expedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);
        
                    }else{
                        $result = $db->query("  SELECT  COUNT(DISTINCT (e.expedientID)) as num
                                                FROM    Expedients e $from
                                                WHERE   e.client = $id
                                                    AND e.leavingDate IS NULL 
                                                    AND e.deceasedGender = 'Mujer'
                                                    AND e.type != 2 AND
                                                    (
                                                        SELECT  COUNT(*)
                                                        FROM    Invoices inv
                                                        WHERE   inv.expedient = e.expedientID AND
                                                                inv.leavingDate IS NULL
                                                    ) > 0
                                                    $where
                        ");
        
                        $numExpedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]["num"];
                        array_push($numMujeres, $numExpedients);
        
                        $result = $db->query("  SELECT  DISTINCT (e.expedientID)
                                                FROM    Expedients e $from
                                                WHERE   e.client = $id
                                                    AND e.leavingDate IS NULL 
                                                    AND e.deceasedGender = 'Mujer'
                                                    AND e.deceasedBirthday IS NOT NULL 
                                                    AND e.deceasedDate IS NOT NULL 
                                                    AND e.type != 2 AND
                                                    (
                                                        SELECT  COUNT(*)
                                                        FROM    Invoices inv
                                                        WHERE   inv.expedient = e.expedientID AND
                                                                inv.leavingDate IS NULL
                                                    ) > 0
                                                    $where
                        ");
        
                        $expedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);
                    }

                    $edadMedia = 0;
                    if($expedients != 0 && count($expedients) > 0){
                        $item = 0;
                        foreach($expedients as $expedient){
                            $expedientID = $expedient["expedientID"];
                            $result = $db->query("  SELECT  SUM(YEAR(e.deceasedDate) - YEAR(e.deceasedBirthday)) AS edadMedia
                                                    FROM    Expedients e
                                                    WHERE   e.expedientID = $expedientID AND e.type != 2");
                            
                            $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]["edadMedia"];
                            $edadMedia += $info;
                            $item++;
                        }
                        if($item != 0){
                            $edadMedia = $edadMedia / $item;
                        }
                    }
                    array_push($edadMediaMujeres, $edadMedia);

                    //BASE IMPONIBLE DEL PRODUCTO
                    if($where2 == ''){
                        $result = $db->query("  SELECT  SUM(
                                                                (
                                                                SELECT      COALESCE(SUM(iniv.base), 0) AS base
                                                                FROM        Invoices i
                                                                JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = e.expedientID
                                                            )
                                                        ) AS baseImponible
                                                FROM    Expedients e, Clients c $from
                                                WHERE   e.client = c.clientID AND
                                                        e.leavingDate IS NULL AND
                                                        e.type != 2 AND
                                                        e.client = $id
                                                        $where
                        ");

                        $info = mysqli_num_rows($result) == 0 ? array('baseImponible' => 0) : $db->resultToArray($result)[0];
                        array_push($baseImponibleMedia, $info);
                    }else{
                        $result = $db->query("  SELECT  (
                                                            SELECT      COALESCE(SUM(iniv.base), 0) AS base
                                                            FROM        Invoices i
                                                            JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                            WHERE       i.leavingDate IS NULL AND
                                                                        i.invoice_type != 3 AND
                                                                        (
                                                                            (
                                                                                i.ID = (
                                                                                    SELECT  MAX(i2.ID)
                                                                                    FROM    Invoices i2
                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                            i2.invoice_type != 3 AND
                                                                                            i2.expedient = i.expedient AND 
                                                                                            (
                                                                                                i2.rectified_type IS NULL OR 
                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                            )
                                                                                )
                                                                            ) OR
                                                                            (
                                                                                i.rectified_type = 2
                                                                            )
                                                                        ) AND
                                                                        i.expedient = e.expedientID
                                                        ) AS baseImponible,
                                                        e.expedientID
                                                FROM    Expedients e, Clients c $from
                                                WHERE   e.client = c.clientID AND
                                                        e.leavingDate IS NULL AND
                                                        e.type != 2 AND
                                                        e.client = $id
                                                        $where
                        ");

                        $info = mysqli_num_rows($result) == 0 ? array() : $db->resultToArray($result);

                        $totalFound = 0;
                        foreach($info as $ie){
                            $result = $db->query("  SELECT  COUNT(*) AS products
                                                    FROM    Expedients_Hirings eh, Products p
                                                    WHERE   eh.expedient = {$ie['expedientID']} AND
                                                            eh.num_hiring = (
                                                                SELECT  MAX(i2.num_hiring) 
                                                                FROM    Invoices i2 
                                                                WHERE   i2.expedient = {$ie['expedientID']} AND
                                                                        i2.leavingDate IS NULL AND
                                                                        i2.invoice_type != 3
                                                            ) AND
                                                            eh.check = 1 AND
                                                            eh.product = p.productID
                                                            $where2
                            ");

                            $found = mysqli_num_rows($result) == 0 ? 0 : intval($db->resultToArray($result)[0]['products']);
                            if($found > 0){
                                $totalFound += $ie['baseImponible'];
                            }
                        }
                        
                        array_push($baseImponibleMedia, array('baseImponible' => $totalFound));
                    }

                    //MARGEN BRUTO DEL PRODUCTO
                    $result = $db->query("      SELECT  SUM(eh.amount * eh.total) - SUM(pr.purchasePrice * eh.amount) as margenBruto
                                                FROM    Expedients e, Expedients_Hirings eh, Products_Retails pr, Products p $from
                                                WHERE   e.expedientID = eh.expedient
                                                    AND eh.check = 1 
                                                    AND e.client = $id
                                                    AND eh.product = p.productID
                                                    AND eh.model = pr.model
                                                    AND pr.year = YEAR(e.requestDate)
                                                    AND e.leavingDate IS NULL 
                                                    AND e.type != 2
                                                    AND eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = e.expedientID AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    )
                                                    $where
                                                    $where2
                    ");
                    $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                    array_push($margenBruto, $info);

                    //TOTAL IVA
                    if($where2 == ''){
                        $result = $db->query("  SELECT  SUM(
                                                            (
                                                                SELECT      COALESCE(SUM(iniv.iva), 0)
                                                                FROM        Invoices i
                                                                JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = e.expedientID
                                                            )
                                                        ) AS totalIVA
                                                FROM    Expedients e, Clients c $from
                                                WHERE   e.client = c.clientID AND
                                                        e.leavingDate IS NULL AND
                                                        e.type != 2 AND
                                                        e.client = $id
                                                        $where
                        ");

                        $info = mysqli_num_rows($result) == 0 ? array('totalIVA' => 0) : $db->resultToArray($result)[0];
                        array_push($iva, $info);
                    }else{
                        $result = $db->query("  SELECT  (
                                                            SELECT      COALESCE(SUM(iniv.iva), 0)
                                                            FROM        Invoices i
                                                            JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                            WHERE       i.leavingDate IS NULL AND
                                                                        i.invoice_type != 3 AND
                                                                        (
                                                                            (
                                                                                i.ID = (
                                                                                    SELECT  MAX(i2.ID)
                                                                                    FROM    Invoices i2
                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                            i2.invoice_type != 3 AND
                                                                                            i2.expedient = i.expedient AND 
                                                                                            (
                                                                                                i2.rectified_type IS NULL OR 
                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                            )
                                                                                )
                                                                            ) OR
                                                                            (
                                                                                i.rectified_type = 2
                                                                            )
                                                                        ) AND
                                                                        i.expedient = e.expedientID
                                                        ) AS totalIVA,
                                                        e.expedientID
                                                FROM    Expedients e, Clients c $from
                                                WHERE   e.client = c.clientID AND
                                                        e.leavingDate IS NULL AND
                                                        e.type != 2 AND
                                                        e.client = $id
                                                        $where
                        ");

                        $info = mysqli_num_rows($result) == 0 ? array() : $db->resultToArray($result);

                        $totalFound = 0;
                        foreach($info as $ie){
                            $result = $db->query("  SELECT  COUNT(*) AS products
                                                    FROM    Expedients_Hirings eh, Products p
                                                    WHERE   eh.expedient = {$ie['expedientID']} AND
                                                            eh.check = 1 AND
                                                            eh.product = p.productID AND
                                                            eh.num_hiring = (
                                                                SELECT  MAX(i2.num_hiring) 
                                                                FROM    Invoices i2 
                                                                WHERE   i2.expedient = {$ie['expedientID']} AND
                                                                        i2.leavingDate IS NULL AND
                                                                        i2.invoice_type != 3
                                                            )
                                                            $where2
                            ");

                            $found = mysqli_num_rows($result) == 0 ? 0 : intval($db->resultToArray($result)[0]['products']);
                            if($found > 0){
                                $totalFound += $ie['totalIVA'];
                            }
                        }

                        array_push($iva, array('totalIVA' => $totalFound));
                    }

                    //TOTAL FACTURADO DEL PRODUCTO
                    if($where2 == ''){
                        $result = $db->query("  SELECT  SUM(
                                                            (
                                                                SELECT      COALESCE(SUM(i.total), 0)
                                                                FROM        Invoices i
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = e.expedientID
                                                            )
                                                        ) AS totalFacturado
                                                FROM    Expedients e, Clients c $from
                                                WHERE   e.client = c.clientID AND
                                                        e.leavingDate IS NULL AND
                                                        e.type != 2 AND
                                                        e.client = $id
                                                        $where
                        ");

                        $info = mysqli_num_rows($result) == 0 ? array('totalFacturado' => 0) : $db->resultToArray($result)[0];
                        array_push($totalFacturado, $info);
                    }else{
                        $result = $db->query("  SELECT  (
                                                            SELECT      COALESCE(SUM(i.total), 0)
                                                            FROM        Invoices i
                                                            WHERE       i.leavingDate IS NULL AND
                                                                        i.invoice_type != 3 AND
                                                                        (
                                                                            (
                                                                                i.ID = (
                                                                                    SELECT  MAX(i2.ID)
                                                                                    FROM    Invoices i2
                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                            i2.invoice_type != 3 AND
                                                                                            i2.expedient = i.expedient AND 
                                                                                            (
                                                                                                i2.rectified_type IS NULL OR 
                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                            )
                                                                                )
                                                                            ) OR
                                                                            (
                                                                                i.rectified_type = 2
                                                                            )
                                                                        ) AND
                                                                        i.expedient = e.expedientID
                                                        ) as total, 
                                                        e.expedientID
                                                FROM    Expedients e, Clients c $from
                                                WHERE   e.client = c.clientID AND
                                                        e.leavingDate IS NULL AND
                                                        e.type != 2 AND
                                                        e.client = $id
                                                        $where
                        ");

                        $info = mysqli_num_rows($result) == 0 ? array() : $db->resultToArray($result);

                        $totalFound = 0;
                        foreach($info as $ie){
                            $result = $db->query("  SELECT  COUNT(*) AS products
                                                    FROM    Expedients_Hirings eh, Products p
                                                    WHERE   eh.expedient = {$ie['expedientID']} AND
                                                            eh.check = 1 AND
                                                            eh.product = p.productID and
                                                            eh.num_hiring = (
                                                                SELECT  MAX(i2.num_hiring) 
                                                                FROM    Invoices i2 
                                                                WHERE   i2.expedient = {$ie['expedientID']} AND
                                                                        i2.leavingDate IS NULL AND
                                                                        i2.invoice_type != 3
                                                            )
                                                            $where2
                            ");

                            $found = mysqli_num_rows($result) == 0 ? 0 : intval($db->resultToArray($result)[0]['products']);
                            if($found > 0){
                                $totalFound += ($ie['total']);
                            }
                        }

                        array_push($totalFacturado, array('totalFacturado' => $totalFound));
                    }

                    //TIEMPO DE COBRO
                    if($where2 != ''){
                        $result = $db->query("  SELECT  AVG(
                                                            DATEDIFF(
                                                                DATE_FORMAT(FROM_UNIXTIME(i.paymentDate), '%Y-%m-%d'), 
                                                                DATE_FORMAT(FROM_UNIXTIME(i.creationDate), '%Y-%m-%d')
                                                            )
                                                        ) as tiempoCobro
                                                FROM    Invoices i, Expedients e, Expedients_Hirings eh, Products p $from
                                                WHERE   i.expedient = e.expedientID 
                                                    AND e.expedientID = eh.expedient
                                                    AND eh.product = p.productID
                                                    AND eh.check = 1
                                                    AND i.paymentState = 1
                                                    AND e.client = $id
                                                    AND e.leavingDate IS NULL
                                                    AND i.leavingDate IS NULL
                                                    AND i.paymentDate IS NOT NULL 
                                                    AND e.type != 2
                                                    $where
                                                    $where2
                        ");
                    }else{
                        $result = $db->query("  SELECT  AVG(
                                                            DATEDIFF(
                                                                DATE_FORMAT(FROM_UNIXTIME(i.paymentDate), '%Y-%m-%d'), 
                                                                DATE_FORMAT(FROM_UNIXTIME(i.creationDate), '%Y-%m-%d')
                                                            )
                                                        ) as tiempoCobro
                                                FROM    Invoices i, Expedients e $from
                                                WHERE   i.expedient = e.expedientID 
                                                    AND i.paymentState = 1
                                                    AND e.client = $id
                                                    AND e.leavingDate IS NULL
                                                    AND i.leavingDate IS NULL
                                                    AND i.paymentDate IS NOT NULL 
                                                    AND e.type != 2 
                                                    $where
                        ");
                    }
                    $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                    array_push($tiempoCobro, $info);

                    //TIEMPO DE RESPUESTA
                    if($where2 != ''){
                        $result = $db->query("      SELECT  es.arriveDate, es.arriveTime, e.requestDate, e.requestTime
                                                    FROM    Expedients e, Expedients_Services es, Expedients_Hirings eh, Products p $from
                                                    WHERE   e.client = $id
                                                        AND es.expedient = e.expedientID
                                                        AND e.leavingDate IS NULL
                                                        AND es.arriveDate IS NOT NULL
                                                        AND es.arriveTime IS NOT NULL
                                                        AND e.requestDate IS NOT NULL
                                                        AND e.requestTime IS NOT NULL
                                                        AND e.expedientID = eh.expedient
                                                        AND eh.product = p.productID
                                                        AND eh.check = 1
                                                        AND e.type = 1
                                                        AND e.room = 0
                                                        AND eh.num_hiring = (
                                                            SELECT  MAX(i2.num_hiring) 
                                                            FROM    Invoices i2 
                                                            WHERE   i2.expedient = e.expedientID AND
                                                                    i2.leavingDate IS NULL AND
                                                                    i2.invoice_type != 3
                                                        )
                                                    $where 
                                                    $where2
                        ");
                    }else{
                        $result = $db->query("  SELECT  es.arriveDate, es.arriveTime, e.requestDate, e.requestTime
                                                FROM    Expedients e, Expedients_Services es $from
                                                WHERE   e.client = $id
                                                    AND es.expedient = e.expedientID
                                                    AND e.leavingDate IS NULL
                                                    AND es.arriveDate IS NOT NULL
                                                    AND es.arriveTime IS NOT NULL
                                                    AND e.requestDate IS NOT NULL
                                                    AND e.requestTime IS NOT NULL
                                                    AND e.room = 0
                                                    AND e.type = 1
                                                $where 
                        ");
                    }
                    $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);
                    array_push($tiempoRespuesta, $info);
                }
            }

            $particularesExpedientes = array();
            $particularesCoronas = array();
            $particularesRamos = array();
            $particularesCremaciones = array();
            $particularesNumHombres = array();
            $particularesEdadMediaHombres = array();
            $particularesNumMujeres = array();
            $particularesEdadMediaMujeres = array();
            $particularesBaseImponible = array();
            $particularesIva = array();
            $particularesMargenBruto = array();
            $particularesTotalFacturado = array();
            $particularesTiempoCobro = array();
            $particularesTiempoRespuesta = array();

            //NUM EXPEDIENTES PARTICULARES
            if($where2 != ''){
                $result = $db->query("  SELECT  c.clientID, c.name, e.expedientID as expedients
                                        FROM    Expedients e, Clients c, Expedients_Hirings eh, Products p $from
                                        WHERE   e.clientType = 1
                                            AND c.clientID = e.client
                                            AND e.expedientID = eh.expedient
                                            AND eh.check = 1
                                            AND eh.product = p.productID
                                            AND e.leavingDate IS NULL  
                                            AND e.type != 2
                                            AND eh.num_hiring = (
                                                SELECT  MAX(i2.num_hiring) 
                                                FROM    Invoices i2 
                                                WHERE   i2.expedient = e.expedientID AND
                                                        i2.leavingDate IS NULL AND
                                                        i2.invoice_type != 3
                                            ) AND
                                            AND (
                                                SELECT  COUNT(*)
                                                FROM    Invoices inv
                                                WHERE   inv.expedient = e.expedientID AND
                                                        inv.leavingDate IS NULL
                                            ) > 0
                                            $where
                                            $where2
                ");
            }else{
                $result = $db->query("  SELECT  c.clientID, c.name, COUNT(e.expedientID) as expedients
                                        FROM    Expedients e, Clients c $from
                                        WHERE   e.clientType = 1
                                            AND c.clientID = e.client
                                            AND e.leavingDate IS NULL 
                                            AND e.type != 2 AND
                                            (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                            $where");
            }
            $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
            array_push($particularesExpedientes, $info);

            //Buscamos los productos 'Coronas' dentro de los expedientes para pariculares
            $result = $db->query("  SELECT  COUNT(t.expedientID) * t.amount as coronas, 
                                            SUM(t.amount * t.total) as importeFacturadoCremaciones, 
                                            SUM(t.amount * t.total) as importeFacturadoCoronas, 
                                            SUM(t.purchasePrice * t.amount) as precioCosteCoronas, 
                                            SUM(t.amount * t.total) - SUM(t.purchasePrice * t.amount) as margenSinIvaCoronas
                                    FROM(
                                        SELECT  e.expedientID, eh.amount, eh.total, pr.purchasePrice
                                        FROM    Products p, Expedients e, Expedients_Hirings eh, Products_Retails pr $from
                                        WHERE   e.expedientID = eh.expedient
                                            AND eh.product = p.productID
                                            AND p.name LIKE '%Corona%' 
                                            AND eh.check = 1 
                                            AND e.clientType = 1
                                            AND eh.model = pr.model
                                            AND pr.year = YEAR(e.requestDate)
                                            AND e.leavingDate IS NULL 
                                            AND e.type != 2
                                            AND eh.num_hiring = (
                                                SELECT  MAX(i2.num_hiring) 
                                                FROM    Invoices i2 
                                                WHERE   i2.expedient = e.expedientID AND
                                                        i2.leavingDate IS NULL AND
                                                        i2.invoice_type != 3
                                            )
                                            AND (
                                                SELECT  COUNT(*)
                                                FROM    Invoices inv
                                                WHERE   inv.expedient = e.expedientID AND
                                                        inv.leavingDate IS NULL
                                            ) > 0
                                            $where
                                            $where2
                                    ) t
            ");
            $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
            array_push($particularesCoronas, $info);

            //Buscamos los productos 'Centros' dentro de los expedientes para Particulares
            $result = $db->query("  SELECT  COUNT(t.expedientID) as expedients, 
                                            COUNT(*) * t.amount as ramos, 
                                            SUM(t.amount * t.total) as importeFacturadoRamos, 
                                            SUM(t.purchasePrice * t.amount) as precioCosteRamos, 
                                            SUM(t.amount * t.total) - SUM(t.purchasePrice * t.amount) as margenSinIvaRamos
                                    FROM(
                                            SELECT  e.expedientID, eh.amount, pr.purchasePrice, eh.total
                                            FROM    Products p, Expedients e, Expedients_Hirings eh, Products_Retails pr $from
                                            WHERE   e.expedientID = eh.expedient
                                                AND eh.product = p.productID
                                                AND p.name LIKE '%Centros%' 
                                                AND eh.check = 1 
                                                AND e.clientType = 1
                                                AND eh.model = pr.model
                                                AND pr.year = YEAR(e.requestDate)
                                                AND e.leavingDate IS NULL 
                                                AND e.type != 2
                                                AND eh.num_hiring = (
                                                    SELECT  MAX(i2.num_hiring) 
                                                    FROM    Invoices i2 
                                                    WHERE   i2.expedient = e.expedientID AND
                                                            i2.leavingDate IS NULL AND
                                                            i2.invoice_type != 3
                                                ) AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                                $where 
                                                $where2
                                    ) t
            ");
            $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
            array_push($particularesRamos, $info);

           //Buscamos los productos 'Cremaciones' dentro de los expedientes para Particulares
            $result = $db->query("  SELECT  COUNT(t.expedientID) as expedients, 
                                            COUNT(*) * t.amount as cremaciones, 
                                            SUM(t.amount * t.total) as importeFacturadoCremaciones, 
                                            SUM(t.purchasePrice * t.amount) as precioCosteCremaciones, 
                                            SUM(t.amount * t.total) - SUM(t.purchasePrice * t.amount) as margenSinIvaCremaciones
                                    FROM(
                                            SELECT  e.expedientID, eh.amount, pr.purchasePrice, eh.total
                                            FROM    Products p, Expedients e, Expedients_Hirings eh, Products_Retails pr $from
                                            WHERE   e.expedientID = eh.expedient
                                                AND eh.product = p.productID
                                                AND p.name LIKE '%Cremación%' 
                                                AND eh.check = 1 
                                                AND e.clientType = 1
                                                AND eh.model = pr.model
                                                AND pr.year = YEAR(e.requestDate)
                                                AND e.leavingDate IS NULL 
                                                AND e.type != 2
                                                AND eh.num_hiring = (
                                                    SELECT  MAX(i2.num_hiring) 
                                                    FROM    Invoices i2 
                                                    WHERE   i2.expedient = e.expedientID AND
                                                            i2.leavingDate IS NULL AND
                                                            i2.invoice_type != 3
                                                ) AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                                $where 
                                                $where2
                                    ) t
            ");
            $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
            array_push($particularesCremaciones, $info);

            //NUM DE HOMBRES Y EDAD MEDIA DE LOS HOMBRES
            if($where2 != ''){
                $result = $db->query("  SELECT  COUNT(DISTINCT (t.expedientID)) as num
                                        FROM (
                                            SELECT  e.expedientID
                                            FROM    Expedients e, Expedients_Hirings eh, Products p $from
                                            WHERE   e.clientType = 1
                                                AND e.expedientID = eh.expedient
                                                AND eh.check = 1
                                                AND eh.product = p.productID
                                                AND e.leavingDate IS NULL 
                                                AND e.deceasedGender = 'Hombre'
                                                AND e.type != 2
                                                AND eh.num_hiring = (
                                                    SELECT  MAX(i2.num_hiring) 
                                                    FROM    Invoices i2 
                                                    WHERE   i2.expedient = e.expedientID AND
                                                            i2.leavingDate IS NULL AND
                                                            i2.invoice_type != 3
                                                ) AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                                $where
                                                $where2
                                        ) t");

                $numExpedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]["num"];
                array_push($particularesNumHombres, $numExpedients);
                
                $result = $db->query("  SELECT      DISTINCT (t.expedientID)
                                        FROM(
                                            SELECT  DISTINCT (e.expedientID) as expedientID
                                            FROM    Expedients e, Expedients_Hirings eh, Products p $from
                                            WHERE   e.clientType = 1
                                                AND e.expedientID = eh.expedient
                                                AND eh.product = p.productID
                                                AND eh.check = 1
                                                AND e.leavingDate IS NULL 
                                                AND e.deceasedGender = 'Hombre'
                                                AND e.deceasedBirthday IS NOT NULL 
                                                AND e.deceasedDate IS NOT NULL 
                                                AND e.type != 2
                                                AND eh.num_hiring = (
                                                    SELECT  MAX(i2.num_hiring) 
                                                    FROM    Invoices i2 
                                                    WHERE   i2.expedient = e.expedientID AND
                                                            i2.leavingDate IS NULL AND
                                                            i2.invoice_type != 3
                                                ) AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                                $where
                                                $where2
                                        ) t");
                $expedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);

            }else{
                $result = $db->query("  SELECT  COUNT(DISTINCT (e.expedientID)) as num
                                        FROM    Expedients e $from
                                        WHERE   e.clientType = 1
                                            AND e.leavingDate IS NULL 
                                            AND e.deceasedGender = 'Hombre'
                                            AND e.type != 2
                                            AND (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                            $where");

                $numExpedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]["num"];
                array_push($particularesNumHombres, $numExpedients);

                $result = $db->query("  SELECT  DISTINCT (e.expedientID)
                                        FROM    Expedients e $from
                                        WHERE   e.clientType = 1
                                            AND e.leavingDate IS NULL 
                                            AND e.deceasedGender = 'Hombre'
                                            AND e.deceasedBirthday IS NOT NULL 
                                            AND e.deceasedDate IS NOT NULL 
                                            AND e.type != 2 AND
                                            (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                            $where");

                $expedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);
            }

            $edadMedia = 0;
            if($expedients != 0 && count($expedients) > 0){
                $edadMedia = 0;
                $item = 0;
                foreach($expedients as $expedient){
                    $expedientID = $expedient["expedientID"];
                    $result = $db->query("  SELECT  SUM(YEAR(e.deceasedDate) - YEAR(e.deceasedBirthday)) AS edadMedia
                                            FROM    Expedients e
                                            WHERE   e.expedientID = $expedientID AND e.type != 2");
                    
                    $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]["edadMedia"];
                    $edadMedia += $info;
                    $item++;
                }
                if($item != 0){
                    $edadMedia = $edadMedia / $item;
                }
            }
            array_push($particularesEdadMediaHombres, $edadMedia);

            //NUM DE MUJERES Y EDAD MEDIA DE LAS MUJERES
            if($where2 != ''){
                $result = $db->query("  SELECT   COUNT(DISTINCT (t.expedientID)) as num
                                        FROM(
                                            SELECT  DISTINCT (e.expedientID) as expedientID
                                            FROM    Expedients e, Expedients_Hirings eh, Products p $from
                                            WHERE   e.clientType = 1
                                                AND e.expedientID = eh.expedient
                                                AND eh.check = 1
                                                AND eh.product = p.productID
                                                AND e.leavingDate IS NULL 
                                                AND e.deceasedGender = 'Mujer'
                                                AND e.type != 2
                                                AND eh.num_hiring = (
                                                    SELECT  MAX(i2.num_hiring) 
                                                    FROM    Invoices i2 
                                                    WHERE   i2.expedient = e.expedientID AND
                                                            i2.leavingDate IS NULL AND
                                                            i2.invoice_type != 3
                                                ) AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                                $where
                                                $where2
                                        ) t");
                $numExpedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]["num"];
                array_push($particularesNumMujeres, $numExpedients);
               
                $result = $db->query("  SELECT      DISTINCT (t.expedientID)
                                        FROM(
                                            SELECT  DISTINCT (e.expedientID)
                                            FROM    Expedients e, Expedients_Hirings eh, Products p $from
                                            WHERE   e.clientType = 1
                                                AND e.expedientID = eh.expedient
                                                AND eh.product = p.productID
                                                AND eh.check = 1
                                                AND e.leavingDate IS NULL 
                                                AND e.deceasedGender = 'Mujer'
                                                AND e.deceasedBirthday IS NOT NULL 
                                                AND e.deceasedDate IS NOT NULL 
                                                AND e.type != 2
                                                AND eh.num_hiring = (
                                                    SELECT  MAX(i2.num_hiring) 
                                                    FROM    Invoices i2 
                                                    WHERE   i2.expedient = e.expedientID AND
                                                            i2.leavingDate IS NULL AND
                                                            i2.invoice_type != 3
                                                ) AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                                $where
                                                $where2
                                        ) t");
                $expedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);

            }else{
                $result = $db->query(" SELECT   COUNT(DISTINCT (e.expedientID)) as num
                                        FROM    Expedients e $from
                                        WHERE   e.clientType = 1
                                            AND e.leavingDate IS NULL 
                                            AND e.deceasedGender = 'Mujer'
                                            AND e.type != 2 AND
                                            (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                            $where");

                $numExpedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]["num"];
                array_push($particularesNumMujeres, $numExpedients);

                $result = $db->query(" SELECT   DISTINCT (e.expedientID)
                                        FROM    Expedients e $from
                                        WHERE   e.clientType = 1
                                            AND e.leavingDate IS NULL 
                                            AND e.deceasedGender = 'Mujer'
                                            AND e.deceasedBirthday IS NOT NULL 
                                            AND e.deceasedDate IS NOT NULL 
                                            AND e.type != 2 AND
                                            (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                            $where");

                $expedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);
            }

            $edadMedia = 0;
            if($expedients != 0 && count($expedients) > 0){
                $item = 0;
                foreach($expedients as $expedient){
                    $expedientID = $expedient["expedientID"];
                    $result = $db->query("  SELECT  SUM(YEAR(e.deceasedDate) - YEAR(e.deceasedBirthday)) AS edadMedia
                                            FROM    Expedients e
                                            WHERE   e.expedientID = $expedientID AND e.type != 2");
                    
                    $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]["edadMedia"];
                    $edadMedia += $info;
                    $item++;
                }
                if($item != 0){
                    $edadMedia = $edadMedia / $item;
                }
            }
            array_push($particularesEdadMediaMujeres, $edadMedia);

            //BASE IMPONIBLE DEL PRODUCTO
            if($where2 == ''){
                $result = $db->query("  SELECT  SUM(
                                                    (
                                                        SELECT      COALESCE(SUM(iniv.base), 0)
                                                        FROM        Invoices i
                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as baseImponible
                                        FROM    Expedients e, Clients c $from
                                        WHERE   e.client = c.clientID AND
                                                e.leavingDate IS NULL AND
                                                e.type != 2 AND
                                                e.clientType = 1
                                                $where
                ");
    
                $info = mysqli_num_rows($result) == 0 ? array('baseImponible' => 0) : $db->resultToArray($result)[0];
                array_push($particularesBaseImponible, $info);
            }else{
                $result = $db->query("  SELECT (
                                                    SELECT      COALESCE(SUM(iniv.base), 0)
                                                    FROM        Invoices i
                                                    JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                    WHERE       i.leavingDate IS NULL AND
                                                                i.invoice_type != 3 AND
                                                                (
                                                                    (
                                                                        i.ID = (
                                                                            SELECT  MAX(i2.ID)
                                                                            FROM    Invoices i2
                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                    i2.invoice_type != 3 AND
                                                                                    i2.expedient = i.expedient AND 
                                                                                    (
                                                                                        i2.rectified_type IS NULL OR 
                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                    )
                                                                        )
                                                                    ) OR
                                                                    (
                                                                        i.rectified_type = 2
                                                                    )
                                                                ) AND
                                                                i.expedient = e.expedientID
                                                ) as baseImponible, 
                                                e.expedientID
                                        FROM    Expedients e, Clients c $from
                                        WHERE   e.client = c.clientID AND
                                                e.leavingDate IS NULL AND
                                                e.type != 2 AND
                                                e.clientType = 1
                                                $where
                ");

                $info = mysqli_num_rows($result) == 0 ? array() : $db->resultToArray($result);

                $totalFound = 0;
                foreach($info as $ie){
                    $result = $db->query("  SELECT  COUNT(*) AS products
                                            FROM    Expedients_Hirings eh, Products p $from
                                            WHERE   eh.expedient = {$ie['expedientID']} AND
                                                    eh.check = 1 AND
                                                    eh.product = p.productID AND
                                                    eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = {$ie['expedientID']} AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    )
                                                    $where2
                    ");

                    $found = mysqli_num_rows($result) == 0 ? 0 : intval($db->resultToArray($result)[0]['products']);
                    if($found > 0){
                        $totalFound += $ie['baseImponible'];
                    }
                }

                array_push($particularesBaseImponible, array('baseImponible' => $totalFound));
            }

            //MARGEN BRUTO DEL PRODUCTO
            $result = $db->query("  SELECT  SUM(t.amount * t.total) - SUM(t.purchasePrice * t.amount) as margenBruto
                                    FROM (
                                        SELECT  eh.amount, eh.total, pr.purchasePrice
                                        FROM    Expedients e, Expedients_Hirings eh, Products_Retails pr, Products p $from
                                        WHERE   e.expedientID = eh.expedient
                                            AND eh.check = 1 
                                            AND e.clientType = 1
                                            AND eh.product = p.productID
                                            AND eh.model = pr.model
                                            AND pr.year = YEAR(e.requestDate)
                                            AND e.leavingDate IS NULL 
                                            AND e.type != 2
                                            AND eh.num_hiring = (
                                                SELECT  MAX(i2.num_hiring) 
                                                FROM    Invoices i2 
                                                WHERE   i2.expedient = e.expedientID AND
                                                        i2.leavingDate IS NULL AND
                                                        i2.invoice_type != 3
                                            )
                                            $where
                                            $where2
                                    ) t");
            $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
            array_push($particularesMargenBruto, $info);

            //TOTAL IVA
            if($where2 == ''){
                $result = $db->query("  SELECT  SUM(
                                                    (
                                                        SELECT      COALESCE(SUM(iniv.iva), 0)
                                                        FROM        Invoices i
                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as totalIVA
                                        FROM    Expedients e, Clients c $from
                                        WHERE   e.client = c.clientID AND
                                                e.leavingDate IS NULL AND
                                                e.type != 2 AND
                                                e.clientType = 1
                                                $where
                ");

                $info = mysqli_num_rows($result) == 0 ? array('totalIVA' => 0) : $db->resultToArray($result)[0];
                array_push($particularesIva, $info);
            }else{
                $result = $db->query("  SELECT  (
                                                    SELECT      COALESCE(SUM(iniv.iva), 0)
                                                    FROM        Invoices i
                                                    JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                    WHERE       i.leavingDate IS NULL AND
                                                                i.invoice_type != 3 AND
                                                                (
                                                                    (
                                                                        i.ID = (
                                                                            SELECT  MAX(i2.ID)
                                                                            FROM    Invoices i2
                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                    i2.invoice_type != 3 AND
                                                                                    i2.expedient = i.expedient AND 
                                                                                    (
                                                                                        i2.rectified_type IS NULL OR 
                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                    )
                                                                        )
                                                                    ) OR
                                                                    (
                                                                        i.rectified_type = 2
                                                                    )
                                                                ) AND
                                                                i.expedient = e.expedientID
                                                ) as totalIVA, 
                                                e.expedientID
                                        FROM    Expedients e, Clients c $from
                                        WHERE   e.client = c.clientID AND
                                                e.leavingDate IS NULL AND
                                                e.type != 2 AND
                                                e.clientType = 1
                                                $where
                ");

                $info = mysqli_num_rows($result) == 0 ? array() : $db->resultToArray($result);

                $totalFound = 0;
                foreach($info as $ie){
                    $result = $db->query("  SELECT  COUNT(*) AS products
                                            FROM    Expedients_Hirings eh, Products p
                                            WHERE   eh.expedient = {$ie['expedientID']} AND
                                                    eh.check = 1 AND
                                                    eh.product = p.productID AND
                                                    eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = {$ie['expedientID']} AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    )
                                                    $where2
                    ");

                    $found = mysqli_num_rows($result) == 0 ? 0 : intval($db->resultToArray($result)[0]['products']);
                    if($found > 0){
                        $totalFound += ($ie['totalIVA']);
                    }
                }

                array_push($particularesIva, array('totalIVA' => $totalFound));
            }
            
            //TOTAL FACTURADO DEL PRODUCTO
            if($where2 == ''){
                $result = $db->query("  SELECT  SUM(
                                                    (
                                                        SELECT      COALESCE(SUM(i.total), 0)
                                                        FROM        Invoices i
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as totalFacturado
                                        FROM    Expedients e, Clients c $from
                                        WHERE   e.client = c.clientID AND
                                                e.leavingDate IS NULL AND
                                                e.type != 2 AND
                                                e.clientType = 1
                                                $where
                ");

                $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                array_push($particularesTotalFacturado, $info);
            }else{
                $result = $db->query("  SELECT  (
                                                    SELECT      COALESCE(SUM(i.total), 0)
                                                    FROM        Invoices i
                                                    WHERE       i.leavingDate IS NULL AND
                                                                i.invoice_type != 3 AND
                                                                (
                                                                    (
                                                                        i.ID = (
                                                                            SELECT  MAX(i2.ID)
                                                                            FROM    Invoices i2
                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                    i2.invoice_type != 3 AND
                                                                                    i2.expedient = i.expedient AND 
                                                                                    (
                                                                                        i2.rectified_type IS NULL OR 
                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                    )
                                                                        )
                                                                    ) OR
                                                                    (
                                                                        i.rectified_type = 2
                                                                    )
                                                                ) AND
                                                                i.expedient = e.expedientID
                                                ) as total, 
                                                e.expedientID
                                        FROM    Expedients e, Clients c $from
                                        WHERE   e.client = c.clientID AND
                                                e.leavingDate IS NULL AND
                                                e.type != 2 AND
                                                e.clientType = 1
                                                $where
                ");

                $info = mysqli_num_rows($result) == 0 ? array() : $db->resultToArray($result);

                $totalFound = 0;
                foreach($info as $ie){
                    $result = $db->query("  SELECT  COUNT(*) AS products
                                            FROM    Expedients_Hirings eh, Products p
                                            WHERE   eh.expedient = {$ie['expedientID']} AND
                                                    eh.check = 1 AND
                                                    eh.product = p.productID AND
                                                    eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = {$ie['expedientID']} AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    )
                                                    $where2
                    ");

                    $found = mysqli_num_rows($result) == 0 ? 0 : intval($db->resultToArray($result)[0]['products']);
                    if($found > 0){
                        $totalFound += ($ie['total']);
                    }
                }

                array_push($particularesTotalFacturado, array('totalFacturado' => $totalFound));
            }

            //TIEMPO DE COBRO
            if($where2 != ''){
                $result = $db->query("  SELECT  AVG(DATEDIFF(DATE_FORMAT(FROM_UNIXTIME(i.paymentDate), '%Y-%m-%d'),
                                                DATE_FORMAT(FROM_UNIXTIME(i.creationDate), '%Y-%m-%d'))) as tiempoCobro
                                        FROM    Invoices i, Expedients e, Expedients_Hirings eh, Products p $from
                                        WHERE   i.expedient = e.expedientID 
                                            AND e.expedientID = eh.expedient
                                            AND eh.product = p.productID
                                            AND eh.check = 1
                                            AND i.paymentState = 1
                                            AND e.clientType = 1
                                            AND e.leavingDate IS NULL
                                            AND i.leavingDate IS NULL
                                            AND i.paymentDate IS NOT NULL 
                                            AND e.type != 2
                                            $where
                                            $where2
                ");
            }else{
                $result = $db->query("  SELECT  AVG(DATEDIFF(DATE_FORMAT(FROM_UNIXTIME(i.paymentDate), '%Y-%m-%d'), 
                                                DATE_FORMAT(FROM_UNIXTIME(i.creationDate), '%Y-%m-%d'))) as tiempoCobro
                                        FROM    Invoices i, Expedients e $from
                                        WHERE   i.expedient = e.expedientID 
                                            AND i.paymentState = 1
                                            AND e.clientType = 1
                                            AND e.leavingDate IS NULL
                                            AND i.leavingDate IS NULL
                                            AND i.paymentDate IS NOT NULL 
                                            AND e.type != 2
                                            $where
                ");
            }
            $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
            array_push($particularesTiempoCobro, $info);

            //TIEMPO DE RESPUESTA
            if($where2 != ''){
                $result = $db->query("  SELECT      t.arriveDate, t.arriveTime, t.requestDate, t.requestTime  
                                        FROM(
                                            SELECT  es.arriveDate, es.arriveTime, e.requestDate, e.requestTime
                                            FROM    Expedients e, Expedients_Services es, Expedients_Hirings eh, Products p $from
                                            WHERE   e.clientType = 1
                                                AND es.expedient = e.expedientID
                                                AND e.leavingDate IS NULL
                                                AND es.arriveDate IS NOT NULL
                                                AND es.arriveTime IS NOT NULL
                                                AND e.requestDate IS NOT NULL
                                                AND e.requestTime IS NOT NULL
                                                AND e.expedientID = eh.expedient
                                                AND eh.product = p.productID
                                                AND eh.check = 1
                                                AND e.type = 1
                                                AND e.room = 0
                                                AND eh.num_hiring = (
                                                    SELECT  MAX(i2.num_hiring) 
                                                    FROM    Invoices i2 
                                                    WHERE   i2.expedient = e.expedientID AND
                                                            i2.leavingDate IS NULL AND
                                                            i2.invoice_type != 3
                                                )
                                            $where 
                                            $where2
                                        ) t");
            }else{
                $result = $db->query("  SELECT  es.arriveDate, es.arriveTime, e.requestDate, e.requestTime
                                        FROM    Expedients e, Expedients_Services es $from
                                        WHERE   e.clientType = 1
                                            AND es.expedient = e.expedientID
                                            AND e.leavingDate IS NULL
                                            AND es.arriveDate IS NOT NULL
                                            AND es.arriveTime IS NOT NULL
                                            AND e.requestDate IS NOT NULL
                                            AND e.requestTime IS NOT NULL
                                            AND e.type = 1
                                            AND e.room = 0
                                        $where");
            }
            $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);
            array_push($particularesTiempoRespuesta, $info);

            $empresasExpedientes = array();
            $empresasCoronas = array();
            $empresasRamos = array();
            $empresasCremaciones = array();
            $empresasNumHombres = array();
            $empresasEdadMediaHombres = array();
            $empresasNumMujeres = array();
            $empresasEdadMediaMujeres = array();
            $empresasBaseImponible = array();
            $empresasIva = array();
            $empresasMargenBruto = array();
            $empresasTotalFacturado = array();
            $empresasTiempoCobro = array();
            $empresasTiempoRespuesta = array();

            //NUM EXPEDIENTES EMPRESAS
            if($where2 != ''){
                
                $result = $db->query("  SELECT  t.clientID, t.name, COUNT(DISTINCT t.expedients) as expedients
                                        FROM (
                                            SELECT  c.clientID, c.name, e.expedientID as expedients
                                            FROM    Expedients e, Clients c, Expedients_Hirings eh, Products p $from
                                            WHERE   e.clientType = 3
                                                AND c.clientID = e.client
                                                AND e.expedientID = eh.expedient
                                                AND eh.check = 1
                                                AND eh.product = p.productID
                                                AND e.leavingDate IS NULL  
                                                AND e.type != 2
                                                AND eh.num_hiring = (
                                                    SELECT  MAX(i2.num_hiring) 
                                                    FROM    Invoices i2 
                                                    WHERE   i2.expedient = e.expedientID AND
                                                            i2.leavingDate IS NULL AND
                                                            i2.invoice_type != 3
                                                )
                                                AND (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                                $where
                                                $where2
                                        ) t");
            }else{
                $result = $db->query(" SELECT   c.clientID, c.name, COUNT(e.expedientID) as expedients
                                        FROM    Expedients e, Clients c $from
                                        WHERE   e.clientType = 3
                                            AND c.clientID = e.client
                                            AND e.leavingDate IS NULL
                                            AND e.type != 2
                                            AND (
                                                SELECT  COUNT(*)
                                                FROM    Invoices inv
                                                WHERE   inv.expedient = e.expedientID AND
                                                        inv.leavingDate IS NULL
                                            ) > 0
                                            $where"); 
            }
            $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
            array_push($empresasExpedientes, $info);

            //Buscamos los productos 'Coronas' dentro de los expedientes para empresas
            $result = $db->query("  SELECT  COUNT(t.expedientID) * t.amount as coronas, 
                                            SUM(t.amount * t.total) as importeFacturadoCremaciones, 
                                            SUM(t.amount * t.total) as importeFacturadoCoronas, 
                                            SUM(t.purchasePrice * t.amount) as precioCosteCoronas, 
                                            SUM(t.amount * t.total) - SUM(t.purchasePrice * t.amount) as margenSinIvaCoronas
                                    FROM(
                                        SELECT  e.expedientID, eh.amount, eh.total, pr.purchasePrice
                                        FROM    Products p, Expedients e, Expedients_Hirings eh, Products_Retails pr $from
                                        WHERE   e.expedientID = eh.expedient
                                            AND eh.product = p.productID
                                            AND p.name LIKE '%Corona%' 
                                            AND eh.check = 1 
                                            AND e.clientType = 3
                                            AND eh.model = pr.model
                                            AND pr.year = YEAR(e.requestDate)
                                            AND e.leavingDate IS NULL 
                                            AND e.type != 2
                                            AND eh.num_hiring = (
                                                SELECT  MAX(i2.num_hiring) 
                                                FROM    Invoices i2 
                                                WHERE   i2.expedient = e.expedientID AND
                                                        i2.leavingDate IS NULL AND
                                                        i2.invoice_type != 3
                                            ) 
                                            AND (
                                                SELECT  COUNT(*)
                                                FROM    Invoices inv
                                                WHERE   inv.expedient = e.expedientID AND
                                                        inv.leavingDate IS NULL
                                            ) > 0
                                            $where
                                            $where2
                                    ) t");
            $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
            array_push($empresasCoronas, $info);

            //Buscamos los productos 'Centros' dentro de los expedientes para empresas
            $result = $db->query("  SELECT  COUNT(t.expedientID) as expedients, 
                                            COUNT(*) * t.amount as ramos, 
                                            SUM(t.amount * t.total) as importeFacturadoRamos, 
                                            SUM(t.purchasePrice * t.amount) as precioCosteRamos, 
                                            SUM(t.amount * t.total) - SUM(t.purchasePrice * t.amount) as margenSinIvaRamos
                                    FROM(
                                            SELECT  e.expedientID, eh.amount, pr.purchasePrice, eh.total
                                            FROM    Products p, Expedients e, Expedients_Hirings eh, Products_Retails pr $from
                                            WHERE   e.expedientID = eh.expedient
                                                AND eh.product = p.productID
                                                AND p.name LIKE '%Centros%' 
                                                AND eh.check = 1 
                                                AND e.clientType = 3
                                                AND eh.model = pr.model
                                                AND pr.year = YEAR(e.requestDate)
                                                AND e.leavingDate IS NULL 
                                                AND e.type != 2
                                                AND eh.num_hiring = (
                                                    SELECT  MAX(i2.num_hiring) 
                                                    FROM    Invoices i2 
                                                    WHERE   i2.expedient = e.expedientID AND
                                                            i2.leavingDate IS NULL AND
                                                            i2.invoice_type != 3
                                                ) 
                                                AND (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                                $where 
                                                $where2
                                    ) t");
            $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
            array_push($empresasRamos, $info);

            //Buscamos los productos 'Cremaciones' dentro de los expedientes para empresas
            $result = $db->query("  SELECT  COUNT(t.expedientID) as expedients, 
                                            COUNT(*) * t.amount as cremaciones, 
                                            SUM(t.amount * t.total) as importeFacturadoCremaciones, 
                                            SUM(t.purchasePrice * t.amount) as precioCosteCremaciones, 
                                            SUM(t.amount * t.total) - SUM(t.purchasePrice * t.amount) as margenSinIvaCremaciones
                                    FROM(
                                            SELECT  e.expedientID, eh.amount, pr.purchasePrice, eh.total
                                            FROM    Products p, Expedients e, Expedients_Hirings eh, Products_Retails pr $from
                                            WHERE   e.expedientID = eh.expedient
                                                AND eh.product = p.productID
                                                AND p.name LIKE '%Cremación%' 
                                                AND eh.check = 1 
                                                AND e.clientType = 3
                                                AND eh.model = pr.model
                                                AND pr.year = YEAR(e.requestDate)
                                                AND e.leavingDate IS NULL 
                                                AND e.type != 2
                                                AND eh.num_hiring = (
                                                    SELECT  MAX(i2.num_hiring) 
                                                    FROM    Invoices i2 
                                                    WHERE   i2.expedient = e.expedientID AND
                                                            i2.leavingDate IS NULL AND
                                                            i2.invoice_type != 3
                                                )
                                                AND (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                                $where 
                                                $where2
                                    ) t");
            $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
            array_push($empresasCremaciones, $info);

            //NUM DE HOMBRES Y EDAD MEDIA (EMPRESAS)
            if($where2 != ''){
                $result = $db->query("  SELECT  COUNT(DISTINCT (t.expedientID)) as num
                                        FROM (
                                            SELECT  e.expedientID
                                            FROM    Expedients e, Expedients_Hirings eh, Products p $from
                                            WHERE   e.clientType = 3
                                                AND e.expedientID = eh.expedient
                                                AND eh.check = 1
                                                AND eh.product = p.productID
                                                AND e.leavingDate IS NULL 
                                                AND e.deceasedGender = 'Hombre'
                                                AND e.type != 2
                                                AND eh.num_hiring = (
                                                    SELECT  MAX(i2.num_hiring) 
                                                    FROM    Invoices i2 
                                                    WHERE   i2.expedient = e.expedientID AND
                                                            i2.leavingDate IS NULL AND
                                                            i2.invoice_type != 3
                                                )
                                                AND (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                                $where
                                                $where2
                                        ) t");

                $numExpedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]["num"];
                array_push($empresasNumHombres, $numExpedients);
                
                $result = $db->query("  SELECT  DISTINCT (t.expedientID)
                                        FROM(
                                            SELECT  DISTINCT (e.expedientID) as expedientID
                                            FROM    Expedients e, Expedients_Hirings eh, Products p $from
                                            WHERE   e.clientType = 3
                                                AND e.expedientID = eh.expedient
                                                AND eh.product = p.productID
                                                AND eh.check = 1
                                                AND e.leavingDate IS NULL 
                                                AND e.deceasedGender = 'Hombre'
                                                AND e.deceasedBirthday IS NOT NULL 
                                                AND e.deceasedDate IS NOT NULL 
                                                AND e.type != 2
                                                AND eh.num_hiring = (
                                                    SELECT  MAX(i2.num_hiring) 
                                                    FROM    Invoices i2 
                                                    WHERE   i2.expedient = e.expedientID AND
                                                            i2.leavingDate IS NULL AND
                                                            i2.invoice_type != 3
                                                ) 
                                                AND (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                                $where
                                                $where2
                                        ) t");
                $expedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);

            }else{
                $result = $db->query(" SELECT   COUNT(DISTINCT (e.expedientID)) as num
                                        FROM    Expedients e $from
                                        WHERE   e.clientType = 3
                                            AND e.leavingDate IS NULL 
                                            AND e.deceasedGender = 'Hombre'
                                            AND e.type != 2
                                            AND (
                                                SELECT  COUNT(*)
                                                FROM    Invoices inv
                                                WHERE   inv.expedient = e.expedientID AND
                                                        inv.leavingDate IS NULL
                                            ) > 0
                                            $where");

                $numExpedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]["num"];
                array_push($empresasNumHombres, $numExpedients);

                $result = $db->query(" SELECT   DISTINCT (e.expedientID)
                                        FROM    Expedients e $from
                                        WHERE   e.clientType = 3
                                            AND e.leavingDate IS NULL 
                                            AND e.deceasedGender = 'Hombre'
                                            AND e.deceasedBirthday IS NOT NULL 
                                            AND e.deceasedDate IS NOT NULL 
                                            AND e.type != 2
                                            AND (
                                                SELECT  COUNT(*)
                                                FROM    Invoices inv
                                                WHERE   inv.expedient = e.expedientID AND
                                                        inv.leavingDate IS NULL
                                            ) > 0
                                            $where");

                $expedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);
            }

            $edadMediaEmpresas = 0;
            if($expedients != 0 && count($expedients) > 0){
                $item = 0;
                foreach($expedients as $expedient){
                    $expedientID = $expedient["expedientID"];
                    $result = $db->query("  SELECT  SUM(YEAR(e.deceasedDate) - YEAR(e.deceasedBirthday)) AS edadMedia
                                            FROM    Expedients e
                                            WHERE   e.expedientID = $expedientID AND e.type != 2");
                    
                    $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]["edadMedia"];
                    $edadMediaEmpresas += $info;
                    $item++;
                }
                if($item != 0){
                    $edadMediaEmpresas = $edadMediaEmpresas / $item;
                }
            }
            array_push($empresasEdadMediaHombres, $edadMediaEmpresas);

            //NUM MUJERES Y EDAD MEDIA PARA EMPRESAS
            if($where2 != ''){
                $result = $db->query("  SELECT   COUNT(DISTINCT (t.expedientID)) as num
                                        FROM(
                                            SELECT  DISTINCT (e.expedientID) as expedientID
                                            FROM    Expedients e, Expedients_Hirings eh, Products p $from
                                            WHERE   e.clientType = 3
                                                AND e.expedientID = eh.expedient
                                                AND eh.check = 1
                                                AND eh.product = p.productID
                                                AND e.leavingDate IS NULL 
                                                AND e.deceasedGender = 'Mujer'
                                                AND e.type != 2
                                                AND eh.num_hiring = (
                                                    SELECT  MAX(i2.num_hiring) 
                                                    FROM    Invoices i2 
                                                    WHERE   i2.expedient = e.expedientID AND
                                                            i2.leavingDate IS NULL AND
                                                            i2.invoice_type != 3
                                                )
                                                AND (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                                $where
                                                $where2
                                        ) t");
                $numExpedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]["num"];
                array_push($empresasNumMujeres, $numExpedients);
               
                $result = $db->query("  SELECT      DISTINCT (t.expedientID)
                                        FROM(
                                            SELECT  DISTINCT (e.expedientID)
                                            FROM    Expedients e, Expedients_Hirings eh, Products p $from
                                            WHERE   e.clientType = 3
                                                AND e.expedientID = eh.expedient
                                                AND eh.product = p.productID
                                                AND eh.check = 1
                                                AND e.leavingDate IS NULL 
                                                AND e.deceasedGender = 'Mujer'
                                                AND e.deceasedBirthday IS NOT NULL 
                                                AND e.deceasedDate IS NOT NULL 
                                                AND e.type != 2
                                                AND eh.num_hiring = (
                                                    SELECT  MAX(i2.num_hiring) 
                                                    FROM    Invoices i2 
                                                    WHERE   i2.expedient = e.expedientID AND
                                                            i2.leavingDate IS NULL AND
                                                            i2.invoice_type != 3
                                                )
                                                AND (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                                $where
                                                $where2
                                        ) t");
                $expedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);

            }else{
                $result = $db->query(" SELECT   COUNT(DISTINCT (e.expedientID)) as num
                                        FROM    Expedients e $from
                                        WHERE   e.clientType = 3
                                            AND e.leavingDate IS NULL 
                                            AND e.deceasedGender = 'Mujer'
                                            AND e.type != 2
                                            AND (
                                                SELECT  COUNT(*)
                                                FROM    Invoices inv
                                                WHERE   inv.expedient = e.expedientID AND
                                                        inv.leavingDate IS NULL
                                            ) > 0
                                            $where");

                $numExpedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]["num"];
                array_push($empresasNumMujeres, $numExpedients);

                $result = $db->query(" SELECT   DISTINCT (e.expedientID)
                                        FROM    Expedients e $from
                                        WHERE   e.clientType = 3
                                            AND e.leavingDate IS NULL 
                                            AND e.deceasedGender = 'Mujer'
                                            AND e.deceasedBirthday IS NOT NULL 
                                            AND e.deceasedDate IS NOT NULL 
                                            AND e.type != 2 
                                            AND (
                                                SELECT  COUNT(*)
                                                FROM    Invoices inv
                                                WHERE   inv.expedient = e.expedientID AND
                                                        inv.leavingDate IS NULL
                                            ) > 0
                                            $where");

                $expedients = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);
            }

            $edadMediaEmpresas = 0;
            if($expedients != 0 && count($expedients) > 0){
                $item = 0;
                foreach($expedients as $expedient){
                    $expedientID = $expedient["expedientID"];
                    $result = $db->query("  SELECT  SUM(YEAR(e.deceasedDate) - YEAR(e.deceasedBirthday)) AS edadMedia
                                            FROM    Expedients e
                                            WHERE   e.expedientID = $expedientID AND e.type != 2");
                    
                    $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]["edadMedia"];
                    $edadMediaEmpresas += $info;
                    $item++;
                }
                if($item != 0){
                    $edadMediaEmpresas = $edadMediaEmpresas / $item;
                }
            }
            array_push($empresasEdadMediaMujeres, $edadMediaEmpresas);
           
            //BASE IMPONIBLE DEL PRODUCTO PARA EMPRESAS
            if($where2 == ''){
                $result = $db->query("  SELECT  SUM(
                                                    (
                                                        SELECT      COALESCE(SUM(iniv.base), 0)
                                                        FROM        Invoices i
                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as baseImponible
                                        FROM    Expedients e, Clients c $from
                                        WHERE   e.client = c.clientID AND
                                                e.leavingDate IS NULL AND
                                                e.type != 2 AND
                                                e.clientType = 3
                                                $where
                ");

                $info = mysqli_num_rows($result) == 0 ? array('baseImponible' => 0) : $db->resultToArray($result)[0];
                array_push($empresasBaseImponible, $info);
            }else{
                $result = $db->query("  SELECT  (
                                                    SELECT      COALESCE(SUM(iniv.base), 0)
                                                    FROM        Invoices i
                                                    JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                    WHERE       i.leavingDate IS NULL AND
                                                                i.invoice_type != 3 AND
                                                                (
                                                                    (
                                                                        i.ID = (
                                                                            SELECT  MAX(i2.ID)
                                                                            FROM    Invoices i2
                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                    i2.invoice_type != 3 AND
                                                                                    i2.expedient = i.expedient AND 
                                                                                    (
                                                                                        i2.rectified_type IS NULL OR 
                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                    )
                                                                        )
                                                                    ) OR
                                                                    (
                                                                        i.rectified_type = 2
                                                                    )
                                                                ) AND
                                                                i.expedient = e.expedientID
                                                ) as baseImponible, 
                                                e.expedientID
                                        FROM    Expedients e, Clients c $from
                                        WHERE   e.client = c.clientID AND
                                                e.leavingDate IS NULL AND
                                                e.type != 2 AND
                                                e.clientType = 3 AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                                $where
                ");

                $info = mysqli_num_rows($result) == 0 ? array() : $db->resultToArray($result);

                $totalFound = 0;
                foreach($info as $ie){
                    $result = $db->query("  SELECT  COUNT(*) AS products
                                            FROM    Expedients_Hirings eh, Products p
                                            WHERE   eh.expedient = {$ie['expedientID']} AND
                                                    eh.check = 1 AND
                                                    eh.product = p.productID AND
                                                    eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = {$ie['expedientID']} AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    )
                                                    AND (
                                                        SELECT  COUNT(*)
                                                        FROM    Invoices inv
                                                        WHERE   inv.expedient = e.expedientID AND
                                                                inv.leavingDate IS NULL
                                                    ) > 0
                                                    $where2
                    ");

                    $found = mysqli_num_rows($result) == 0 ? 0 : intval($db->resultToArray($result)[0]['products']);
                    if($found > 0){
                        $totalFound += $ie['baseImponible'];
                    }
                }

                array_push($empresasBaseImponible, array('baseImponible' => $totalFound));
            }

            //MARGEN BRUTO EMPRESAS
            $result = $db->query("  SELECT      SUM(t.amount * t.total) - SUM(t.purchasePrice * t.amount) as margenBruto
                                    FROM (
                                        SELECT  eh.amount, eh.total, pr.purchasePrice
                                        FROM    Expedients e, Expedients_Hirings eh, Products_Retails pr, Products p $from
                                        WHERE   e.expedientID = eh.expedient
                                            AND eh.check = 1 
                                            AND e.clientType = 3
                                            AND eh.product = p.productID
                                            AND eh.model = pr.model
                                            AND pr.year = YEAR(e.requestDate)
                                            AND e.leavingDate IS NULL 
                                            AND e.type != 2
                                            AND eh.num_hiring = (
                                                SELECT  MAX(i2.num_hiring) 
                                                FROM    Invoices i2 
                                                WHERE   i2.expedient = e.expedientID AND
                                                        i2.leavingDate IS NULL AND
                                                        i2.invoice_type != 3
                                            )
                                            AND (
                                                SELECT  COUNT(*)
                                                FROM    Invoices inv
                                                WHERE   inv.expedient = e.expedientID AND
                                                        inv.leavingDate IS NULL
                                            ) > 0
                                            $where
                                            $where2
                                    ) t");
            $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
            array_push($empresasMargenBruto, $info);

            //TOTAL IVA
            if($where2 == ''){
                $result = $db->query("  SELECT  SUM(
                                                    (
                                                        SELECT      COALESCE(SUM(iniv.iva), 0)
                                                        FROM        Invoices i
                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as totalIVA
                                        FROM    Expedients e, Clients c $from
                                        WHERE   e.client = c.clientID AND
                                                e.leavingDate IS NULL AND
                                                e.type != 2 AND
                                                e.clientType = 3 AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                                $where
                ");

                $info = mysqli_num_rows($result) == 0 ? array('totalIVA' => 0) : $db->resultToArray($result)[0];
                array_push($empresasIva, $info);
            }else{
                $result = $db->query("  SELECT  (
                                                    SELECT      COALESCE(SUM(iniv.base), 0)
                                                    FROM        Invoices i
                                                    JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                    WHERE       i.leavingDate IS NULL AND
                                                                i.invoice_type != 3 AND
                                                                (
                                                                    (
                                                                        i.ID = (
                                                                            SELECT  MAX(i2.ID)
                                                                            FROM    Invoices i2
                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                    i2.invoice_type != 3 AND
                                                                                    i2.expedient = i.expedient AND 
                                                                                    (
                                                                                        i2.rectified_type IS NULL OR 
                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                    )
                                                                        )
                                                                    ) OR
                                                                    (
                                                                        i.rectified_type = 2
                                                                    )
                                                                ) AND
                                                                i.expedient = e.expedientID
                                                ) as totalIVA, 
                                                e.expedientID
                                        FROM    Expedients e, Clients c $from
                                        WHERE   e.client = c.clientID AND
                                                e.leavingDate IS NULL AND
                                                e.type != 2 AND
                                                e.clientType = 3 AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                                $where
                ");

                $info = mysqli_num_rows($result) == 0 ? array() : $db->resultToArray($result);

                $totalFound = 0;
                foreach($info as $ie){
                    $result = $db->query("  SELECT  COUNT(*) AS products
                                            FROM    Expedients_Hirings eh, Products p
                                            WHERE   eh.expedient = {$ie['expedientID']} AND
                                                    eh.check = 1 AND
                                                    eh.product = p.productID AND
                                                    eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = {$ie['expedientID']} AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    ) AND
                                                    (
                                                        SELECT  COUNT(*)
                                                        FROM    Invoices inv
                                                        WHERE   inv.expedient = e.expedientID AND
                                                                inv.leavingDate IS NULL
                                                    ) > 0
                                                    $where2
                    ");

                    $found = mysqli_num_rows($result) == 0 ? 0 : intval($db->resultToArray($result)[0]['products']);
                    if($found > 0){
                        $totalFound += ($ie['totalIVA']);
                    }
                }

                array_push($empresasIva, array('totalIVA' => $totalFound));
            }            

            //TOTAL FACTURADO EMPRESAS
            if($where2 == ''){
                $result = $db->query("  SELECT  SUM(
                                                    (
                                                        SELECT      COALESCE(SUM(i.total), 0)
                                                        FROM        Invoices i
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as totalFacturado
                                        FROM    Expedients e, Clients c $from
                                        WHERE   e.client = c.clientID AND
                                                e.leavingDate IS NULL AND
                                                e.type != 2 AND
                                                e.clientType = 3 AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                                $where
                ");

                $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                array_push($empresasTotalFacturado, $info);
            }else{
                $result = $db->query("  SELECT  (
                                                    SELECT      COALESCE(SUM(i.total), 0)
                                                    FROM        Invoices i
                                                    WHERE       i.leavingDate IS NULL AND
                                                                i.invoice_type != 3 AND
                                                                (
                                                                    (
                                                                        i.ID = (
                                                                            SELECT  MAX(i2.ID)
                                                                            FROM    Invoices i2
                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                    i2.invoice_type != 3 AND
                                                                                    i2.expedient = i.expedient AND 
                                                                                    (
                                                                                        i2.rectified_type IS NULL OR 
                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                    )
                                                                        )
                                                                    ) OR
                                                                    (
                                                                        i.rectified_type = 2
                                                                    )
                                                                ) AND
                                                                i.expedient = e.expedientID
                                                ) as total, 
                                                e.expedientID
                                        FROM    Expedients e, Clients c $from
                                        WHERE   e.client = c.clientID AND
                                                e.leavingDate IS NULL AND
                                                e.type != 2 AND
                                                e.clientType = 3 AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                                $where
                ");

                $info = mysqli_num_rows($result) == 0 ? array() : $db->resultToArray($result);

                $totalFound = 0;
                foreach($info as $ie){
                    $result = $db->query("  SELECT  COUNT(*) AS products
                                            FROM    Expedients_Hirings eh, Products p
                                            WHERE   eh.expedient = {$ie['expedientID']} AND
                                                    eh.check = 1 AND
                                                    eh.product = p.productID AND
                                                    eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = {$ie['expedientID']} AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    ) AND
                                                    (
                                                        SELECT  COUNT(*)
                                                        FROM    Invoices inv
                                                        WHERE   inv.expedient = e.expedientID AND
                                                                inv.leavingDate IS NULL
                                                    ) > 0
                                                    $where2
                    ");

                    $found = mysqli_num_rows($result) == 0 ? 0 : intval($db->resultToArray($result)[0]['products']);
                    if($found > 0){
                        $totalFound += ($ie['total']);
                    }
                }

                array_push($empresasTotalFacturado, array('totalFacturado' => $totalFound));
            }
            
            //TIEMPO DE COBRO
            if($where2 != ''){
                $result = $db->query("  SELECT  AVG(DATEDIFF(DATE_FORMAT(FROM_UNIXTIME(i.paymentDate), '%Y-%m-%d'),
                                                DATE_FORMAT(FROM_UNIXTIME(i.creationDate), '%Y-%m-%d'))) as tiempoCobro
                                        FROM    Invoices i, Expedients e, Expedients_Hirings eh, Products p $from
                                        WHERE   i.expedient = e.expedientID 
                                            AND e.expedientID = eh.expedient
                                            AND eh.product = p.productID
                                            AND eh.check = 1
                                            AND i.paymentState = 1
                                            AND e.clientType = 3
                                            AND e.leavingDate IS NULL
                                            AND i.leavingDate IS NULL
                                            AND i.paymentDate IS NOT NULL 
                                            AND e.type != 2
                                            $where
                                            $where2
                ");
            }else{
                $result = $db->query("  SELECT  AVG(DATEDIFF(DATE_FORMAT(FROM_UNIXTIME(i.paymentDate), '%Y-%m-%d'), 
                                                DATE_FORMAT(FROM_UNIXTIME(i.creationDate), '%Y-%m-%d'))) as tiempoCobro
                                        FROM    Invoices i, Expedients e $from
                                        WHERE   i.expedient = e.expedientID 
                                            AND i.paymentState = 1
                                            AND e.clientType = 3
                                            AND e.leavingDate IS NULL
                                            AND i.leavingDate IS NULL
                                            AND i.paymentDate IS NOT NULL 
                                            AND e.type != 2 AND
                                            (
                                                SELECT  COUNT(*)
                                                FROM    Invoices inv
                                                WHERE   inv.expedient = e.expedientID AND
                                                        inv.leavingDate IS NULL
                                            ) > 0
                                            $where
                ");
            }  
            $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
            array_push($empresasTiempoCobro, $info);

            //TIEMPO DE RESPUESTA
            if($where2 != ''){
                $result = $db->query("  SELECT      t.arriveDate, t.arriveTime, t.requestTime, t.requestDate 
                                        FROM(
                                            SELECT  es.arriveDate, es.arriveTime, e.requestDate, e.requestTime
                                            FROM    Expedients e, Expedients_Services es, Expedients_Hirings eh, Products p $from
                                            WHERE   e.clientType = 3
                                                AND es.expedient = e.expedientID
                                                AND e.leavingDate IS NULL
                                                AND es.arriveDate IS NOT NULL
                                                AND es.arriveTime IS NOT NULL
                                                AND e.requestDate IS NOT NULL
                                                AND e.requestTime IS NOT NULL
                                                AND e.expedientID = eh.expedient
                                                AND eh.product = p.productID
                                                AND eh.check = 1
                                                AND e.type = 1
                                                AND e.room = 0
                                                AND eh.num_hiring = (
                                                    SELECT  MAX(i2.num_hiring) 
                                                    FROM    Invoices i2 
                                                    WHERE   i2.expedient = e.expedientID AND
                                                            i2.leavingDate IS NULL AND
                                                            i2.invoice_type != 3
                                                ) AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                            $where 
                                            $where2
                                        ) t");
            }else{
                $result = $db->query("  SELECT  es.arriveDate, es.arriveTime, e.requestDate, e.requestTime 
                                        FROM    Expedients e, Expedients_Services es $from
                                        WHERE   e.clientType = 3
                                            AND es.expedient = e.expedientID
                                            AND e.leavingDate IS NULL
                                            AND es.arriveDate IS NOT NULL
                                            AND es.arriveTime IS NOT NULL
                                            AND e.requestDate IS NOT NULL
                                            AND e.requestTime IS NOT NULL
                                            AND e.type = 1
                                            AND e.room = 0 AND
                                            (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                        $where");
            }
            $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);
            array_push($empresasTiempoRespuesta, $info);

            $data =[
                    "baseImponible" => $baseImponibleMedia,
                    "coronas" => $coronas,
                    "cremaciones" => $cremaciones,
                    "edadMediaHombres" => $edadMediaHombres,
                    "edadMediaMujeres" => $edadMediaMujeres,
                    "empresasExpedientes" => $empresasExpedientes,
                    "empresasCoronas" => $empresasCoronas,
                    "empresasRamos" => $empresasRamos,
                    "empresasCremaciones" => $empresasCremaciones,
                    "empresasNumHombres" => $empresasNumHombres,
                    "empresasEdadMediaHombres" => $empresasEdadMediaHombres,
                    "empresasNumMujeres" => $empresasNumMujeres,
                    "empresasEdadMediaMujeres" => $empresasEdadMediaMujeres,
                    "empresasBaseImponible" => $empresasBaseImponible,
                    "empresasMargenBruto" => $empresasMargenBruto,
                    "empresasIva" => $empresasIva,
                    "empresasTotalFacturado" => $empresasTotalFacturado,
                    "empresasTiempoCobro" => $empresasTiempoCobro,
                    "empresasTiempoRespuesta" => $empresasTiempoRespuesta,
                    "expedientes" => $expedientes,
                    "iva" => $iva,
                    "margenBruto" => $margenBruto,
                    "numHombres" => $numHombres,
                    "numMujeres" => $numMujeres,
                    "particularesExpedientes" => $particularesExpedientes,
                    "particularesCoronas" => $particularesCoronas,
                    "particularesRamos" => $particularesRamos,
                    "particularesCremaciones" => $particularesCremaciones,
                    "particularesNumHombres" => $particularesNumHombres,
                    "particularesEdadMediaHombres" => $particularesEdadMediaHombres,
                    "particularesNumMujeres" => $particularesNumMujeres,
                    "particularesEdadMediaMujeres" => $particularesEdadMediaMujeres,
                    "particularesBaseImponible" => $particularesBaseImponible,
                    "particularesMargenBruto" => $particularesMargenBruto,
                    "particularesIva" => $particularesIva,
                    "particularesTotalFacturado" => $particularesTotalFacturado,
                    "particularesTiempoCobro" => $particularesTiempoCobro,
                    "particularesTiempoRespuesta" => $particularesTiempoRespuesta,
                    "ramos" => $ramos,
                    "tiempoCobro" => $tiempoCobro,
                    "tiempoRespuesta" => $tiempoRespuesta,
                    "totalFacturado" => $totalFacturado,
                ];
            return $data;
        }

        /**
         * Obtiene el resumen de la estadística general para los clientes SEGUROS
         * 
         * @param int $year Año
         * @return array
         */
        public function getGeneralStatisticsClientInsurance($id, $dateStart, $dateEnd, $products, $mortuaries){
            $db = new DbHandler;

            $from = '';
            $where = '';

            $id = cleanStr($id);
            $dateStart = cleanStr($dateStart);
            $dateEnd = cleanStr($dateEnd);
        
            if($dateStart != null && $dateEnd != null){
                $where .= " AND e.entryDate BETWEEN '$dateStart' AND '$dateEnd' ";
            }

            if($mortuaries != ''){
                $where .= " AND e.deceasedMortuary = cc.mortuary AND cc.ID IN (";
                foreach($mortuaries as $elem){
                    $elem = cleanStr($elem);
                    
                    $where .= " $elem,";
                }
                
                $from = ', Cost_Center cc';
                $where = substr($where, 0, -1);
                $where .= ")";
            }

            $where2 = '';
            if($products != ''){
                $where2 .= ' AND p.productID IN (';

                foreach($products as $elem){
                    $elem = cleanStr($elem);
                    $where2 .= $elem . ',';
                }
                $where2 = substr($where2, 0, -1);

                $where2 .= ')';
            }

            if($where2 != ''){
                $result = $db->query("  SELECT  DISTINCT e.expedientID
                                        FROM    Expedients e, Expedients_Hirings eh, Products p $from
                                        WHERE   e.client = $id  
                                            AND e.expedientID = eh.expedient
                                            AND e.type != 2
                                            AND eh.check = 1
                                            AND eh.product = p.productID
                                            AND e.leavingDate IS NULL 
                                            AND eh.num_hiring = (
                                                SELECT  MAX(i2.num_hiring) 
                                                FROM    Invoices i2 
                                                WHERE   i2.expedient = e.expedientID AND
                                                        i2.leavingDate IS NULL AND
                                                        i2.invoice_type != 3
                                            ) AND
                                            (
                                                SELECT  COUNT(*)
                                                FROM    Invoices inv
                                                WHERE   inv.expedient = e.expedientID AND
                                                        inv.leavingDate IS NULL
                                            ) > 0
                                            $where
                                            $where2
                ");
            }else{
                $result = $db->query("  SELECT  DISTINCT e.expedientID
                                        FROM    Expedients e $from
                                        WHERE   e.client = $id
                                            AND e.type != 2 
                                            AND e.leavingDate IS NULL
                                            AND (
                                                SELECT  COUNT(*)
                                                FROM    Invoices inv
                                                WHERE   inv.expedient = e.expedientID AND
                                                        inv.leavingDate IS NULL
                                            ) > 0
                                            $where
                ");
            }        
            $expedients = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);


            $baseImponible = array();
            $suplidos = array();
            $totalFacturacion = array();
            $factura = array();
            $margenBruto = array();
            $tiempoCobro = array();
            $tiempoRespuesta = array();
            foreach($expedients as $expedient){
      
                $id = $expedient["expedientID"];

                //BASE IMPONIBLE
                $result = $db->query("  SELECT  c.name, e.number, 
                                                SUM(
                                                    (
                                                        SELECT      COALESCE(SUM(iniv.base), 0)
                                                        FROM        Invoices i
                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as baseImponible
                                        FROM    Expedients e, Clients c
                                        WHERE   e.client = c.clientID AND 
                                                e.expedientID = $id  
                ");
                $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                array_push($baseImponible, $info);

                //SUPLIDOS
                $result = $db->query("  SELECT  SUM(
                                                    (
                                                        SELECT      COALESCE(SUM(i.supplieds), 0)
                                                        FROM        Invoices i
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as suplidos
                                        FROM    Expedients e
                                        WHERE   e.expedientID = $id  
                ");
                $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                array_push($suplidos, $info);

                //TOTAL FACTURACIÓN (BASE IMPONIBLE + IVA) FALTARÍA SUMARLE LOS SUPLIDOS
                $result = $db->query("  SELECT  c.name, e.number, 
                                                SUM(
                                                    (
                                                        SELECT      COALESCE(SUM(i.total), 0)
                                                        FROM        Invoices i
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as total
                                        FROM    Expedients e, Clients c
                                        WHERE   e.client = c.clientID AND 
                                                e.expedientID = $id  
                ");
                $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                array_push($totalFacturacion, $info);

                //FACTURA (NUM.FACTURA - ESTADO FACTURA - CANTIDAD PAGADA - CANTIDAD PEDIENTE)
                $result = $db->query("  SELECT  i.numInvoice as num, 
                                                i.paymentState as estado, 
                                                i.pay as pagado, 
                                                i.total - i.pay as pendiente
                                        FROM    Invoices i
                                        WHERE   i.expedient = $id AND
                                                i.leavingDate IS NULL AND
                                                i.invoice_type != 3 AND
                                                (
                                                    (
                                                        i.ID = (
                                                            SELECT  MAX(i2.ID)
                                                            FROM    Invoices i2
                                                            WHERE   i2.leavingDate IS NULL AND
                                                                    i2.invoice_type != 3 AND
                                                                    i2.expedient = i.expedient AND 
                                                                    (
                                                                        i2.rectified_type IS NULL OR 
                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                    )
                                                        )
                                                    ) OR
                                                    (
                                                        i.rectified_type = 2
                                                    )
                                                )
                ");

                $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);
                $factura = array_merge($factura, $info);

                //MARGEN BRUTO DEL PRODUCTO
                $result = $db->query("  SELECT  SUM(eh.amount * eh.total)  - SUM(pr.purchasePrice * eh.amount) as margenBruto
                                        FROM    Expedients e, Expedients_Hirings eh, Products_Retails pr, Products p
                                        WHERE   e.expedientID = eh.expedient
                                            AND e.type != 2 
                                            AND eh.check = 1
                                            AND e.expedientID = $id
                                            AND eh.num_hiring = (
                                                SELECT  MAX(i2.num_hiring) 
                                                FROM    Invoices i2 
                                                WHERE   i2.expedient = e.expedientID AND
                                                        i2.leavingDate IS NULL AND
                                                        i2.invoice_type != 3
                                            )
                                            AND eh.product = p.productID
                                            AND eh.model = pr.model
                                            AND pr.year = YEAR(e.requestDate)
                                            AND e.leavingDate IS NULL
                ");
                $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                array_push($margenBruto, $info);

                //TIEMPO COBRO
                $result = $db->query(" SELECT   AVG(DATEDIFF(DATE_FORMAT(FROM_UNIXTIME(i.paymentDate), '%Y-%m-%d'), 
                                                DATE_FORMAT(FROM_UNIXTIME(i.creationDate), '%Y-%m-%d'))) as tiempoCobro
                                        FROM    Invoices i, Expedients e
                                        WHERE   i.expedient = e.expedientID 
                                            AND e.type != 2 
                                            AND i.paymentState = 1
                                            AND e.expedientID = $id
                                            AND e.leavingDate IS NULL
                                            AND i.leavingDate IS NULL
                                            AND i.paymentDate IS NOT NULL
                ");
                $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                array_push($tiempoCobro, $info);

                //TIEMPO RESPUESTA
                $result = $db->query("  SELECT  es.arriveDate, es.arriveTime, e.requestDate, e.requestTime
                                        FROM    Expedients e, Expedients_Services es
                                        WHERE   e.expedientID = $id
                                            AND e.type = 1
                                            AND e.room = 0
                                            AND es.expedient = e.expedientID
                                            AND e.leavingDate IS NULL
                                            AND es.arriveDate IS NOT NULL
                                            AND es.arriveTime IS NOT NULL
                                            AND e.requestDate IS NOT NULL
                                            AND e.requestTime IS NOT NULL
                ");
                $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                array_push($tiempoRespuesta, $info);
            }

            return [
                "baseImponible" => $baseImponible,
                "suplidos" => $suplidos,
                "totalFacturacion" => $totalFacturacion,
                "margenBruto" => $margenBruto,
                "factura" => $factura,
                "tiempoCobro" => $tiempoCobro,
                "tiempoRespuesta" => $tiempoRespuesta
            ];
        }

        /**
         * Obtiene el resumen de la estadística general para los clientes PARTICULARES y EMPRESAS
         * 
         * @param int $year Año
         * @return array
         */
        public function getGeneralStatisticsClientType($clientType, $dateStart, $dateEnd, $products, $mortuaries){
            $db = new DbHandler;

            $where = '';
            $clientType = cleanStr($clientType);
            $dateStart = cleanStr($dateStart);
            $dateEnd = cleanStr($dateEnd);
        
            if($dateStart != null && $dateEnd != null){
                $where .= " AND e.entryDate BETWEEN '$dateStart' AND '$dateEnd' ";
            }

            if($mortuaries != ''){
                $where .= ' AND e.deceasedMortuary IN (';

                foreach($mortuaries as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                }
                $where = substr($where, 0, -1);

                $where .= ')';
            }

            $where2 = '';
            if($products != ''){
                $where2 .= ' AND p.productID IN (';

                foreach($products as $elem){
                    $elem = cleanStr($elem);
                    $where2 .= $elem . ',';
                }
                $where2 = substr($where2, 0, -1);

                $where2 .= ')';
            }

           if($where2 != ''){
                $result = $db->query("  SELECT  DISTINCT e.expedientID, c.name, c.surname
                                        FROM    Expedients e, Expedients_Hirings eh, Products p, Clients c
                                        WHERE   e.clientType = $clientType 
                                            AND e.type != 2 
                                            AND e.expedientID = eh.expedient
                                            AND eh.check = 1
                                            AND eh.product = p.productID
                                            AND e.leavingDate IS NULL
                                            AND (
                                                SELECT  COUNT(*)
                                                FROM    Invoices inv
                                                WHERE   inv.expedient = e.expedientID AND
                                                        inv.leavingDate IS NULL
                                            ) > 0
                                            AND eh.num_hiring = (SELECT MAX(eh2.num_hiring) FROM Expedients_Hirings eh2 WHERE eh2.expedient = e.expedientID)
                                            AND e.client = c.clientID
                                            $where
                                            $where2
                ");
           }else{
                $result = $db->query("  SELECT  DISTINCT e.expedientID, c.name, c.surname
                                        FROM    Expedients e, Clients c
                                        WHERE   e.clientType = $clientType 
                                            AND e.type != 2 
                                            AND e.leavingDate IS NULL
                                            AND e.client = c.clientID
                                            AND (
                                                SELECT  COUNT(*)
                                                FROM    Invoices inv
                                                WHERE   inv.expedient = e.expedientID AND
                                                        inv.leavingDate IS NULL
                                            ) > 0
                                            $where
                ");
           }        
            $expedients = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);

            $baseImponible = array();
            $suplidos = array();
            $totalFacturacion = array();
            $factura = array();
            $margenBruto = array();
            $tiempoCobro = array();
            $tiempoRespuesta = array();
            $expedientNumber = "";
            if(count($expedients) > 0){
                foreach($expedients as $expedient){
        
                    $id = $expedient["expedientID"];

                    //BASE IMPONIBLE
                    $result = $db->query(" SELECT   c.name, c.surname, e.number,
                                                    (
                                                        (
                                                            SELECT      COALESCE(SUM(iniv.base), 0)
                                                            FROM        Invoices i
                                                            JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                            WHERE       i.leavingDate IS NULL AND
                                                                        i.invoice_type != 3 AND
                                                                        (
                                                                            (
                                                                                i.ID = (
                                                                                    SELECT  MAX(i2.ID)
                                                                                    FROM    Invoices i2
                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                            i2.invoice_type != 3 AND
                                                                                            i2.expedient = i.expedient AND 
                                                                                            (
                                                                                                i2.rectified_type IS NULL OR 
                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                            )
                                                                                )
                                                                            ) OR
                                                                            (
                                                                                i.rectified_type = 2
                                                                            )
                                                                        ) AND
                                                                        i.expedient = e.expedientID
                                                        )
                                                    ) as baseImponible
                                            FROM    (Expedients e, Clients c)
                                            WHERE   e.expedientID = $id  
                                                AND e.type != 2 
                                                AND e.client = c.clientID 
                                                AND e.leavingDate IS NULL
                    ");
                    $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                    
                    // Client name
                    $info['name'] = $expedient["name"];
                    $info['surname'] = $expedient["surname"];

                    if($info['number'] == null){
                        //NUMBER
                        $result = $db->query("  SELECT  e.number
                                                FROM    Expedients e
                                                WHERE   e.expedientID = $id AND e.type != 2");
                        $info['number'] = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['number'];
                    }

                    array_push($baseImponible, $info);

                    //SUPLIDOS
                    $result = $db->query("  SELECT  (
                                                        (
                                                            SELECT      COALESCE(SUM(i.supplieds), 0)
                                                            FROM        Invoices i
                                                            WHERE       i.leavingDate IS NULL AND
                                                                        i.invoice_type != 3 AND
                                                                        (
                                                                            (
                                                                                i.ID = (
                                                                                    SELECT  MAX(i2.ID)
                                                                                    FROM    Invoices i2
                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                            i2.invoice_type != 3 AND
                                                                                            i2.expedient = i.expedient AND 
                                                                                            (
                                                                                                i2.rectified_type IS NULL OR 
                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                            )
                                                                                )
                                                                            ) OR
                                                                            (
                                                                                i.rectified_type = 2
                                                                            )
                                                                        ) AND
                                                                        i.expedient = e.expedientID
                                                        )
                                                    ) as suplidos
                                            FROM    Expedients e
                                            WHERE   e.type != 2 
                                                AND e.expedientID = $id
                                                AND e.leavingDate IS NULL 
                    ");
                    $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                    array_push($suplidos, $info);

                    //TOTAL FACTURACIÓN (BASE IMPONIBLE + IVA) FALTARÍA SUMARLE LOS SUPLIDOS
                    $result = $db->query("  SELECT  c.name, e.number,
                                                    (
                                                        (
                                                            SELECT      COALESCE(SUM(i.total), 0)
                                                            FROM        Invoices i
                                                            WHERE       i.leavingDate IS NULL AND
                                                                        i.invoice_type != 3 AND
                                                                        (
                                                                            (
                                                                                i.ID = (
                                                                                    SELECT  MAX(i2.ID)
                                                                                    FROM    Invoices i2
                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                            i2.invoice_type != 3 AND
                                                                                            i2.expedient = i.expedient AND 
                                                                                            (
                                                                                                i2.rectified_type IS NULL OR 
                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                            )
                                                                                )
                                                                            ) OR
                                                                            (
                                                                                i.rectified_type = 2
                                                                            )
                                                                        ) AND
                                                                        i.expedient = e.expedientID
                                                        )
                                                    ) as total
                                            FROM    Expedients e, Clients c
                                            WHERE e.expedientID = $id 
                                                AND e.type != 2 
                                                AND e.client = c.clientID 
                                                AND e.leavingDate IS NULL 
                    ");
                    $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                    array_push($totalFacturacion, $info);

                   //FACTURA (NUM.FACTURA - ESTADO FACTURA - CANTIDAD PAGADA - CANTIDAD PEDIENTE)
                    $result = $db->query("  SELECT  '' as num, 
                                                    '' as estado, 
                                                    (
                                                        (
                                                            SELECT      COALESCE(SUM(ip.amount), 0)
                                                            FROM        Invoices i
                                                            JOIN        Invoices_Payments ip ON ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                            WHERE       i.leavingDate IS NULL AND
                                                                        i.invoice_type != 3 AND
                                                                        (
                                                                            (
                                                                                i.ID = (
                                                                                    SELECT  MAX(i2.ID)
                                                                                    FROM    Invoices i2
                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                            i2.invoice_type != 3 AND
                                                                                            i2.expedient = i.expedient AND 
                                                                                            (
                                                                                                i2.rectified_type IS NULL OR 
                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                            )
                                                                                )
                                                                            ) OR
                                                                            (
                                                                                i.rectified_type = 2
                                                                            )
                                                                        ) AND
                                                                        i.expedient = e.expedientID
                                                        )
                                                    ) as pagado,
                                                    (
                                                        (
                                                            (
                                                                (
                                                                    SELECT      COALESCE(SUM(i.total), 0)
                                                                    FROM        Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = e.expedientID
                                                                )
                                                            )
                                                        )
                                                        -
                                                        COALESCE((
                                                            SELECT      SUM(ip.amount)
                                                            FROM        Invoices i
                                                            JOIN        Invoices_Payments ip ON ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                            WHERE       i.leavingDate IS NULL AND
                                                                        i.invoice_type != 3 AND
                                                                        (
                                                                            (
                                                                                i.ID = (
                                                                                    SELECT  MAX(i2.ID)
                                                                                    FROM    Invoices i2
                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                            i2.invoice_type != 3 AND
                                                                                            i2.expedient = i.expedient AND 
                                                                                            (
                                                                                                i2.rectified_type IS NULL OR 
                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                            )
                                                                                )
                                                                            ) OR
                                                                            (
                                                                                i.rectified_type = 2
                                                                            )
                                                                        ) AND
                                                                        i.expedient = e.expedientID
                                                        ), 0)
                                                    ) as pendiente
                                            FROM    Expedients e
                                            WHERE   e.expedientID = $id
                    ");

                    $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result);
                    $factura = array_merge($factura, $info);

                    //MARGEN BRUTO DEL PRODUCTO
                    $result = $db->query(" SELECT   SUM(eh.amount * eh.total)  - SUM(pr.purchasePrice * eh.amount) as margenBruto
                                            FROM    Expedients e, Expedients_Hirings eh, Products_Retails pr, Products p
                                            WHERE   e.expedientID = eh.expedient
                                                AND e.type != 2 
                                                AND eh.check = 1
                                                AND e.expedientID = $id
                                                AND eh.num_hiring = (
                                                    SELECT  MAX(i2.num_hiring) 
                                                    FROM    Invoices i2 
                                                    WHERE   i2.expedient = e.expedientID AND
                                                            i2.leavingDate IS NULL AND
                                                            i2.invoice_type != 3
                                                )
                                                AND eh.product = p.productID
                                                AND eh.model = pr.model
                                                AND pr.year = YEAR(e.requestDate)
                                                AND e.leavingDate IS NULL
                    ");
                    $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                    array_push($margenBruto, $info);

                    //TIEMPO COBRO
                    $result = $db->query(" SELECT   AVG(DATEDIFF(DATE_FORMAT(FROM_UNIXTIME(i.paymentDate), '%Y-%m-%d'), 
                                                    DATE_FORMAT(FROM_UNIXTIME(i.creationDate), '%Y-%m-%d'))) as tiempoCobro
                                            FROM    Invoices i, Expedients e
                                            WHERE   i.expedient = e.expedientID 
                                                AND e.type != 2 
                                                AND i.paymentState = 1
                                                AND e.expedientID = $id
                                                AND e.leavingDate IS NULL
                                                AND i.leavingDate IS NULL
                                                AND i.paymentDate IS NOT NULL
                    ");
                    $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                    array_push($tiempoCobro, $info);

                    //TIEMPO RESPUESTA
                    $result = $db->query("  SELECT  es.arriveDate, es.arriveTime, e.requestDate, e.requestTime
                                            FROM    Expedients e, Expedients_Services es
                                            WHERE   e.expedientID = $id
                                                AND e.type = 1
                                                AND e.room = 0
                                                AND es.expedient = e.expedientID
                                                AND e.leavingDate IS NULL
                                                AND es.arriveDate IS NOT NULL
                                                AND es.arriveTime IS NOT NULL
                                                AND e.requestDate IS NOT NULL
                                                AND e.requestTime IS NOT NULL
                    ");
                    $info = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0];
                    array_push($tiempoRespuesta, $info);
                }
            }

            return [
                "baseImponible" => $baseImponible,
                "suplidos" => $suplidos,
                "totalFacturacion" => $totalFacturacion,
                "margenBruto" => $margenBruto,
                "factura" => $factura,
                "tiempoCobro" => $tiempoCobro,
                "tiempoRespuesta" => $tiempoRespuesta
            ];
        }

        /**
         * Generales - Cremaciones
         * 
         * @param int $year Año
         * @return array
         */
        public function getCremations($year){
            $db = new DbHandler;

            $year = cleanStr($year);

            $where = $year == null ? '' : "AND YEAR(ev.start) = $year";

            $result = $db->query("  SELECT      e.requestDate, e.number, CONCAT(e.deceasedName, ' ', e.deceasedSurname), c.name, ev.start
                                    FROM        Expedients e, Crematoriums c, Events ev
                                    WHERE       e.leavingDate IS NULL AND
                                                e.crematorium = c.crematoriumID AND
                                                ev.ID = e.crematoriumEvent AND
                                                e.type != 2
                                                $where
                                    ORDER BY    e.requestDate DESC");

            return mysqli_num_rows($result) == 0 ? array() : $db->resultToArrayValue($result);
        }

        /**
         * Obtiene las defunciones totales de la estadística general
         * 
         * @param int $since Desde
         * @param int $until Hasta
         * @return array
         */
        public function getTotalDeceased($since, $until){
            $db = new DbHandler;

            $since = cleanStr($since);
            $until = cleanStr($until);

            $where = $since == '' || $until == '' ? '' : "AND UNIX_TIMESTAMP(e.requestDate) >= $since AND UNIX_TIMESTAMP(e.requestDate) <= $until";

            // Lunes
            $result = $db->query("  SELECT		e.requestTime
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 1 AND
                                                (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))
                                                $where");

            $dayMonday = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);

            // Martes
            $result = $db->query("  SELECT		e.requestTime
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 2 AND
                                                (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))
                                                $where");

            $dayTuesday = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);

            // Miércoles
            $result = $db->query("  SELECT		e.requestTime
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 3 AND
                                                (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))
                                                $where");

            $dayWednesday = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);

            // Jueves
            $result = $db->query("  SELECT		e.requestTime
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 4 AND
                                                (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))
                                                $where");

            $dayThursday = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);

            // Viernes
            $result = $db->query("  SELECT		e.requestTime
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 5 AND
                                                (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))
                                                $where");

            $dayFriday = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);

            // Sábado
            $result = $db->query("  SELECT		e.requestTime
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 6 AND
                                                (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))
                                                $where");

            $daySaturday = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);

            // Domingo
            $result = $db->query("  SELECT		e.requestTime
                                    FROM		Expedients e
                                    WHERE		e.leavingDate IS NULL AND
                                                DAYOFWEEK(e.requestDate) = 7 AND
                                                (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))
                                                $where");

            $daySunday = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);

            return array(
                'monday' => $dayMonday,
                'tuesday' => $dayTuesday,
                'wednesday' => $dayWednesday,
                'thursday' => $dayThursday,
                'friday' => $dayFriday,
                'saturday' => $daySaturday,
                'sunday' => $daySunday
            );
        }

        /**
         * Obtiene las defunciones por año de la estadística general
         * 
         * @return array
         */
        public function getDeceasedByYear(){
            $db = new DbHandler;

            $result = $db->query("  SELECT  DISTINCT(YEAR(e.requestDate)) as year
                                    FROM    Expedients e
                                    WHERE   e.leavingDate IS NULL");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $years = $db->resultToArray($result);

                $data = array();
                $data['d'] = array();
                $data['c'] = array();
                $data['s'] = array();

                foreach($years as $year){
                    // d -> expediente defunción sin cremación ni sala
                    $line = array();

                    array_push($line, $year['year']);

                    // Lunes
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 1 AND
                                                    (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $monday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $monday);

                    // Martes
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 2 AND
                                                    (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $tuesday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $tuesday);

                    // Miércoles
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 3 AND
                                                    (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $wednesday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $wednesday);

                    // Jueves
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 4 AND
                                                    (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $thursday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $thursday);

                    // Viernes
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 5 AND
                                                    (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $friday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $friday);

                    // Sábado
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 6 AND
                                                    (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $saturday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $saturday);

                    // Domingo
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 7 AND
                                                    (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $sunday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $sunday);

                    // Total
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $total = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $total);

                    array_push($data['d'], $line);

                    // c -> cremación
                    $line = array();

                    array_push($line, $year['year']);

                    // Lunes
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 1 AND
                                                    e.type != 2 AND
                                                    e.cremation = 1");

                    $monday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $monday);

                    // Martes
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 2 AND
                                                    e.type != 2 AND
                                                    e.cremation = 1");

                    $tuesday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $tuesday);

                    // Miércoles
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 3 AND
                                                    e.type != 2 AND
                                                    e.cremation = 1");

                    $wednesday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $wednesday);

                    // Jueves
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 4 AND
                                                    e.type != 2 AND
                                                    e.cremation = 1");

                    $thursday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $thursday);

                    // Viernes
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 5 AND
                                                    e.type != 2 AND
                                                    e.cremation = 1");

                    $friday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $friday);

                    // Sábado
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 6 AND
                                                    e.type != 2 AND
                                                    e.cremation = 1");

                    $saturday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $saturday);

                    // Domingo
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 7 AND
                                                    e.type != 2 AND
                                                    e.cremation = 1");

                    $sunday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $sunday);

                    // Total
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    e.type != 2 AND
                                                    e.cremation = 1");

                    $total = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $total);

                    array_push($data['c'], $line);

                    // S -> sala
                    $line = array();

                    array_push($line, $year['year']);

                    // Lunes
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 1 AND
                                                    e.type != 2 AND
                                                    e.room = 1");

                    $monday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $monday);

                    // Martes
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 2 AND
                                                    e.type != 2 AND
                                                    e.room = 1");

                    $tuesday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $tuesday);

                    // Miércoles
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 3 AND
                                                    e.type != 2 AND
                                                    e.room = 1");

                    $wednesday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $wednesday);

                    // Jueves
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 4 AND
                                                    e.type != 2 AND
                                                    e.room = 1");

                    $thursday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $thursday);

                    // Viernes
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 5 AND
                                                    e.type != 2 AND
                                                    e.room = 1");

                    $friday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $friday);

                    // Sábado
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 6 AND
                                                    e.type != 2 AND
                                                    e.room = 1");

                    $saturday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $saturday);

                    // Domingo
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    DAYOFWEEK(e.requestDate) = 7 AND
                                                    e.type != 2 AND
                                                    e.room = 1");

                    $sunday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $sunday);

                    // Total
                    $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    YEAR(e.requestDate) = {$year['year']} AND
                                                    e.type != 2 AND
                                                    e.room = 1");

                    $total = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                    array_push($line, $total);

                    array_push($data['s'], $line);
                }

                return $data;
            }
        }

        /**
         * Obtiene las defunciones por año (día) de la estadística general
         * 
         * @return array
         */
        public function deceasedByYearDay(){
            $db = new DbHandler;

            $result = $db->query("  SELECT  DISTINCT(YEAR(e.requestDate)) as year
                                    FROM    Expedients e
                                    WHERE   e.leavingDate IS NULL AND
                                            (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $years = $db->resultToArray($result);

                $data = array();

                foreach($years as $year){
                    // Lunes
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 1 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayMonday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Martes
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 2 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayTuesday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Miércoles
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 3 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayWednesday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Jueves
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 4 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayThursday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Viernes
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 5 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayFriday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Sábado
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 6 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $daySaturday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Domingo
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 7 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $daySunday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    $data[$year['year']] = array(
                        'monday' => $dayMonday,
                        'tuesday' => $dayTuesday,
                        'wednesday' => $dayWednesday,
                        'thursday' => $dayThursday,
                        'friday' => $dayFriday,
                        'saturday' => $daySaturday,
                        'sunday' => $daySunday
                    );
                }
            }

            return $data;
        }

        /**
         * Obtiene las defunciones por año (noche) de la estadística general
         * 
         * @return array
         */
        public function deceasedByYearNight(){
            $db = new DbHandler;

            $result = $db->query("  SELECT  DISTINCT(YEAR(e.requestDate)) as year
                                    FROM    Expedients e
                                    WHERE   e.leavingDate IS NULL AND
                                            (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $years = $db->resultToArray($result);

                $data = array();

                foreach($years as $year){
                    // Lunes
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 1 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayMonday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Martes
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 2 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayTuesday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Miércoles
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 3 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayWednesday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Jueves
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 4 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayThursday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Viernes
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 5 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayFriday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Sábado
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 6 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $daySaturday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Domingo
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 7 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $daySunday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    $data[$year['year']] = array(
                        'monday' => $dayMonday,
                        'tuesday' => $dayTuesday,
                        'wednesday' => $dayWednesday,
                        'thursday' => $dayThursday,
                        'friday' => $dayFriday,
                        'saturday' => $daySaturday,
                        'sunday' => $daySunday
                    );
                }
            }

            return $data;
        }

        /**
         * Obtiene las defunciones por año (día vs noche) de la estadística general
         * 
         * @return array
         */
        public function dayvsnight(){
            $db = new DbHandler;

            $result = $db->query("  SELECT  DISTINCT(YEAR(e.requestDate)) as year
                                    FROM    Expedients e
                                    WHERE   e.leavingDate IS NULL AND
                                            (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $years = $db->resultToArray($result);

                $data = array();

                foreach($years as $year){
                    // Lunes
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 2 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayMonday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Martes
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 3 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayTuesday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Miércoles
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 4 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayWednesday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Jueves
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 5 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayThursday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Viernes
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 6 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayFriday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Sábado
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 7 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $daySaturday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Domingo
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 1 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $daySunday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    $data[$year['year']] = array(
                        'monday' => $dayMonday,
                        'tuesday' => $dayTuesday,
                        'wednesday' => $dayWednesday,
                        'thursday' => $dayThursday,
                        'friday' => $dayFriday,
                        'saturday' => $daySaturday,
                        'sunday' => $daySunday
                    );
                }
            }

            return $data;
        }

        /**
         * Obtiene las defunciones por año (noche vs día) de la estadística general
         * 
         * @return array
         */
        public function nightvsday(){
            $db = new DbHandler;

            $result = $db->query("  SELECT  DISTINCT(YEAR(e.requestDate)) as year
                                    FROM    Expedients e
                                    WHERE   e.leavingDate IS NULL AND
                                            (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $years = $db->resultToArray($result);

                $data = array();

                foreach($years as $year){
                    // Lunes
                    $result = $db->query("  SELECT		e.requestTime, e.requestDate
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 2 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayMonday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Martes
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 3 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayTuesday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Miércoles
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 4 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayWednesday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Jueves
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 5 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayThursday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Viernes
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 6 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $dayFriday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Sábado
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 7 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $daySaturday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    // Domingo
                    $result = $db->query("  SELECT		e.requestTime
                                            FROM		Expedients e
                                            WHERE		e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        DAYOFWEEK(e.requestDate) = 1 AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

                    $daySunday = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

                    $data[$year['year']] = array(
                        'monday' => $dayMonday,
                        'tuesday' => $dayTuesday,
                        'wednesday' => $dayWednesday,
                        'thursday' => $dayThursday,
                        'friday' => $dayFriday,
                        'saturday' => $daySaturday,
                        'sunday' => $daySunday
                    );
                }
            }

            return $data;
        }

        /**
         * Obtiene los datos de los crematorios de la estadística general
         * 
         * @return array
         */
        public function getCrematoriums($crematoriumID = null){
            $db = new DbHandler;

            $result = $db->query("  SELECT  DISTINCT(YEAR(e.requestDate)) as year
                                    FROM    Expedients e
                                    WHERE   e.leavingDate IS NULL AND
                                            (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1)))");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $years = $db->resultToArray($result);

                $data = array();

                $where = '';
                if($crematoriumID != null){
                    $where = " AND c.crematoriumID = $crematoriumID";
                }

                foreach($years as $year){
                    $result = $db->query("  SELECT      COUNT(e.expedientID) as deceased
                                            FROM        Expedients e
                                            WHERE       e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1 OR (e.room = 1 AND e.cremation = 1))))");

                    $deceased = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['deceased'];

                    $result = $db->query("  SELECT      COUNT(e.expedientID) as cremations
                                            FROM        Expedients e, Crematoriums c, Events ev
                                            WHERE       e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        e.crematorium = c.crematoriumID AND
                                                        (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1 OR (e.room = 1 AND e.cremation = 1)))) AND
                                                        e.expedientID = ev.expedient AND
                                                        ev.leavingDate IS NULL $where");

                    $cremations = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result)[0]['cremations'];

                    array_push($data, array($year['year'], $deceased, $cremations));
                }

                return $data;
            }
        }

        /**
         * Obtiene los datos de los crematorios de la estadística general
         * 
         * @return array
         */
        public function getCrematoriumOwnService($crematoriumID = null){
            $db = new DbHandler;

            $result = $db->query("  SELECT  DISTINCT(YEAR(e.requestDate)) as year
                                    FROM    Expedients e
                                    WHERE   e.leavingDate IS NULL AND
                                            e.type = 1");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $years = $db->resultToArray($result);

                $data = array();

                $where = '';
                if($crematoriumID != null){
                    $where = " AND c.crematoriumID = $crematoriumID";
                }

                foreach($years as $year){
                    $result = $db->query("  SELECT      COUNT(e.expedientID) as deceased
                                            FROM        Expedients e
                                            WHERE       e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        e.type = 1 AND e.room = 0");

                    $deceased = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['deceased'];

                    $result = $db->query("  SELECT      COUNT(e.expedientID) as cremations
                                            FROM        Expedients e, Crematoriums c, Events ev
                                            WHERE       e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        e.crematorium = c.crematoriumID AND
                                                        c.isYourOwn = 1 AND
                                                        e.type = 1 AND e.room = 0 AND e.cremation = 1 AND
                                                        e.expedientID = ev.expedient AND
                                                        ev.leavingDate IS NULL $where");

                    $cremations = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result)[0]['cremations'];

                    array_push($data, array($year['year'], $deceased, $cremations));
                }

                return $data;
            }
        }

        /**
         * Obtiene los datos de los crematorios de la estadística general
         * 
         * @return array
         */
        public function getCrematoriumOutService($crematoriumID){
            $db = new DbHandler;

            $result = $db->query("  SELECT  DISTINCT(YEAR(e.requestDate)) as year
                                    FROM    Expedients e
                                    WHERE   e.leavingDate IS NULL AND
                                            e.type = 1");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $years = $db->resultToArray($result);

                $data = array();

                $where = '';
                if($crematoriumID != null){
                    $where = " AND c.crematoriumID = $crematoriumID";
                }

                foreach($years as $year){
                    $result = $db->query("  SELECT      COUNT(e.expedientID) as deceased
                                            FROM        Expedients e
                                            WHERE       e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        ((e.type = 1 AND e.room = 1) 
                                                            OR 
                                                        (e.type = 1 AND e.room = 1 AND e.cremation = 1)
                                                            OR
                                                        (e.type = 3 AND e.room = 1)
                                                            OR 
                                                        (e.type = 3 AND e.room = 1 AND e.cremation = 1)
                                                            OR 
                                                        (e.type = 3 AND e.cremation = 1))"); 

                    $deceased = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['deceased'];

                    $result = $db->query("  SELECT      COUNT(e.expedientID) as cremations
                                            FROM        Expedients e, Crematoriums c, Events ev
                                            WHERE       e.leavingDate IS NULL AND
                                                        YEAR(e.requestDate) = {$year['year']} AND
                                                        e.crematorium = c.crematoriumID AND
                                                        c.isYourOwn = 1 AND
                                                        e.expedientID = ev.expedient AND
                                                        ev.leavingDate IS NULL AND
                                                        (((e.type = 1 AND e.room = 1) 
                                                            OR 
                                                        (e.type = 1 AND e.room = 1 AND e.cremation = 1)
                                                            OR
                                                        (e.type = 3 AND e.room = 1)
                                                            OR 
                                                        (e.type = 3 AND e.room = 1 AND e.cremation = 1)
                                                            OR 
                                                        (e.type = 3 AND e.cremation = 1)) AND
                                                        e.cremation = 1) $where");

                    $cremations = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result)[0]['cremations'];

                    array_push($data, array($year['year'], $deceased, $cremations));
                }

                return $data;
            }
        }

        /**
         * Obtiene los datos de los crematorios de la estadística general
         * 
         * @return array
         */
        public function getCrematoriumsMonthsDays($year, $month = null){
            $db = new DbHandler;
           
            $whereMonth = '';
            if($month != null){
                $whereMonth = " AND MONTH(ev.start) = $month ";
            }

            $result = $db->query("  SELECT      ev.start as date
                                    FROM        Expedients e, Crematoriums c, Events ev
                                    WHERE       e.leavingDate IS NULL AND
                                                YEAR(e.requestDate) = $year AND
                                                e.crematorium = c.crematoriumID AND
                                                c.isYourOwn = 1 AND
                                                (e.type = 1 OR (e.type = 3 AND (e.room = 1 OR e.cremation = 1))) AND
                                                e.expedientID = ev.expedient AND
                                                ev.leavingDate IS NULL $whereMonth
                                    ORDER BY ev.start");

            $data = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

            return $data;
        }

        /**
         * Obtiene los datos de las judiciales de la estadística general
         * 
         * @return array
         */
        public function getJudicialesMonthsDays($year, $month = null, $departure = null, $return = null){
            $db = new DbHandler;
           
            $whereMonth = '';
            if($month != null){
                $whereMonth = " AND MONTH(e.requestDate) = $month ";
            }

            $whereChecks = '';
            if($departure != null && intval($departure) == 1){
                $whereChecks = " AND e.moveTraslado = $departure ";
            }

            if($return != null && intval($return) == 1){
                $whereChecks = " AND e.moveDevolucion = $return ";
            }

            $result = $db->query("  SELECT      CONCAT(e.requestDate, ' ', e.requestTime) as date
                                    FROM        Expedients e
                                    WHERE       e.leavingDate IS NULL AND
                                                e.move = 1 AND
                                                e.moveJudicial = 1 AND
                                                YEAR(e.requestDate) = $year $whereMonth $whereChecks
                                    ORDER BY e.requestDate");

            $data = mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);

            return $data;
        }

        /**
         * Obtiene los datos del resumen de facturación para el cuadro de mando
         * 
         * @param int $date Fecha
         * @param int $dateSince Fecha desde
         * @param int $dateUntil Fecha hasta
         * @param int $mortuary Centro de coste
         * @param int $clientType Tipos de cliente
         * @param int $client Clientes
         * @return array
         */
        public function getControlPanelSummary($date, $dateSince, $dateUntil, $mortuary, $clientType, $client){
            $db = new DbHandler;

            $date = cleanStr($date);
            $dateSince = cleanStr($dateSince);
            $dateUntil = cleanStr($dateUntil);

            $where = '';
            $whereCC = '';
            if($date == ''){
                if($dateSince != '' && $dateUntil != ''){
                    $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                }
            }else{
                $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
            }

            if($mortuary != ''){
                $whereCC .= " AND (";
                foreach($mortuary as $elem){
                    $elem = cleanStr($elem);
                    $whereCC .= " cc.ID = $elem OR";
                }
                $whereCC = substr($whereCC, 0, -3);
                $whereCC .= ")";
            }else{
                $whereCC .= " AND cc.mortuary != 0";
            }

            $showParticular = false;
            $showEmpresa = false;
            $showSeguro = false;
            if($clientType != ''){
                $where .= ' AND e.clientType IN (';
                foreach($clientType as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';

                    if($elem == 1){
                        $showParticular = true;
                    }
                    if($elem == 2){
                        $showSeguro = true;
                    }
                    if($elem == 3){
                        $showEmpresa = true;
                    }
                }
                $where = substr($where, 0, -1);
                $where .= ')';
            }

            if($client != ''){
                $where .= ' AND c.clientID NOT IN (';
                foreach($client as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                }
                $where = substr($where, 0, -1);
                $where .= ')';
            }

            $resultFinal = [];

            // Get iva types
            $ivaTypes = [];
            $result = $db->query("  SELECT      it.percentage,
                                                0 as total
                                    FROM        IVA_Types it
                                    WHERE       it.leavingDate IS NULL AND
                                                (it.type IS NULL OR it.type = 1)
                                    ORDER BY    it.percentage ASC 
            ");
            if(mysqli_num_rows($result) > 0){
                $ivaTypes = $db->resultToArray($result);
            }

            $result = $db->query("  SELECT  *
                                    FROM    Cost_Center cc
                                    WHERE   cc.leavingDate IS NULL   
                                            $whereCC");

            if(mysqli_num_rows($result) > 0){
                $costcenters = $db->resultToArray($result);
                foreach($costcenters as $index => $elem){
                    $resultTanatorio = [];
                    $ccID = $elem['ID'];
                    $costName = $elem['name'];

                    $whereCC = ' AND cc.ID = ' . $ccID; 

                    $result = $db->query("  SELECT      e.expedientID, 
                                                        e.requestDate, YEAR(e.requestDate) as year, 
                                                        e.type, 
                                                        e.clientType as clientType,
                                                        c.clientID, 
                                                        c.name, 
                                                        c.surname, 
                                                        c.price,
                                                        (
                                                            (
                                                                SELECT      COALESCE(SUM(iniv.base), 0)
                                                                FROM        Invoices i
                                                                JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = e.expedientID
                                                            )
                                                        ) as bi,
                                                        (
                                                            (
                                                                SELECT      COALESCE(SUM(i.supplieds), 0)
                                                                FROM        Invoices i
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = e.expedientID
                                                            )
                                                        ) as su,
                                                        (
                                                            (
                                                                SELECT      COALESCE(SUM(iniv.base), 0)
                                                                FROM        Invoices i
                                                                JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = e.expedientID
                                                            )
                                                        ) as fact,
                                                        '' as iva1, 
                                                        '' as iva2, 
                                                        (
                                                            (
                                                                SELECT      COALESCE(SUM(iniv.iva), 0)
                                                                FROM        Invoices i
                                                                JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = e.expedientID
                                                            )
                                                        ) as totalIva,
                                                        (
                                                            (
                                                                SELECT      COALESCE(SUM(i.total), 0)
                                                                FROM        Invoices i
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = e.expedientID
                                                            )
                                                        ) as factTotal,
                                                        (
                                                            (
                                                                SELECT      COALESCE(SUM(ip.amount), 0)
                                                                FROM        Invoices i
                                                                JOIN        Invoices_Payments ip ON ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = e.expedientID
                                                            )
                                                        ) as paid,
                                                        (
                                                            (
                                                                (
                                                                    (
                                                                        SELECT      COALESCE(SUM(i.total), 0)
                                                                        FROM        Invoices i
                                                                        WHERE       i.leavingDate IS NULL AND
                                                                                    i.invoice_type != 3 AND
                                                                                    (
                                                                                        (
                                                                                            i.ID = (
                                                                                                SELECT  MAX(i2.ID)
                                                                                                FROM    Invoices i2
                                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                                        i2.invoice_type != 3 AND
                                                                                                        i2.expedient = i.expedient AND 
                                                                                                        (
                                                                                                            i2.rectified_type IS NULL OR 
                                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                        )
                                                                                            )
                                                                                        ) OR
                                                                                        (
                                                                                            i.rectified_type = 2
                                                                                        )
                                                                                    ) AND
                                                                                    i.expedient = e.expedientID
                                                                    )
                                                                )
                                                            )
                                                            -
                                                            COALESCE((
                                                                SELECT      SUM(ip.amount)
                                                                FROM        Invoices i
                                                                JOIN        Invoices_Payments ip ON ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = e.expedientID
                                                           ), 0)
                                                        ) as pending,
                                                        (
                                                            SELECT      COALESCE(SUM(i.paymentDate), 0)
                                                            FROM        Invoices i
                                                            WHERE       i.leavingDate IS NULL AND 
                                                                        i.invoice_type != 3 AND
                                                                        i.expedient = e.expedientID AND 
                                                                        (
                                                                            SELECT  COUNT(*)
                                                                            FROM    Invoices_Payments ip
                                                                            WHERE   ip.leavingDate IS NULL AND
                                                                                    ip.invoice = i.ID
                                                                        ) > 0
                                                        ) as paymentDate,
                                                        (
                                                            SELECT      COALESCE(SUM(i.creationDate), 0)
                                                            FROM        Invoices i
                                                            WHERE       i.leavingDate IS NULL AND 
                                                                        i.invoice_type != 3 AND
                                                                        i.expedient = e.expedientID AND 
                                                                        (
                                                                            SELECT  COUNT(*)
                                                                            FROM    Invoices_Payments ip
                                                                            WHERE   ip.leavingDate IS NULL AND
                                                                                    ip.invoice = i.ID
                                                                        ) > 0
                                                        ) as creationDate,
                                                        (
                                                            (
                                                                SELECT      COALESCE(SUM(i.total), 0)
                                                                FROM        Invoices i
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = e.expedientID
                                                            )
                                                        ) as invoiceTotal, 
                                                        (
                                                            SELECT      COUNT(*)
                                                            FROM        Invoices i
                                                            WHERE       i.leavingDate IS NULL AND 
                                                                        i.invoice_type != 3 AND
                                                                        i.expedient = e.expedientID AND 
                                                                        (
                                                                            SELECT  COUNT(*)
                                                                            FROM    Invoices_Payments ip
                                                                            WHERE   ip.leavingDate IS NULL AND
                                                                                    ip.invoice = i.ID
                                                                        ) > 0
                                                        ) as totalInvoicesPaid,
                                                        e.number as expedientNumber,
                                                        '' as invoiceID
                                            FROM        Expedients e, Clients c, Cost_Center cc
                                            WHERE       e.client = c.clientID AND
                                                        e.leavingDate IS NULL AND
                                                        e.deceasedMortuary = cc.mortuary AND
                                                        (
                                                            SELECT  COUNT(*)
                                                            FROM    Invoices inv
                                                            WHERE   inv.expedient = e.expedientID AND
                                                                    inv.leavingDate IS NULL
                                                        ) > 0
                                                        $where
                                                        $whereCC
                                            ORDER BY    c.clientID
                    ");

                    if(mysqli_num_rows($result) == 0){
                        $particularDEF = array(1,'Particulares - Defunción',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'PD','');
                        $empresaDEF = array(2,'Empresas - Defunción',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'ED','');
                        $seguroDEF = array(3,'Seguros - Defunción',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'SD','');
                        $particularVAR = array(4,'Particulares - Varios',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'PV','');
                        $empresaVAR = array(5,'Empresas - Varios',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'EV','');
                        $seguroVAR = array(6,'Seguros - Varios',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'SV','');

                        if($clientType != ''){
                            if($showParticular && $showEmpresa && $showSeguro){ //000
                                array_push($resultTanatorio, $particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR);
                            }else if($showParticular && $showEmpresa && !$showSeguro){ //001
                                array_push($resultTanatorio, $particularDEF, $empresaDEF, $particularVAR, $empresaVAR);
                            }else if($showParticular && !$showEmpresa && $showSeguro){ //010
                                array_push($resultTanatorio, $particularDEF, $seguroDEF, $particularVAR, $seguroVAR);
                            }else if($showParticular && !$showEmpresa && !$showSeguro){ //011
                                array_push($resultTanatorio, $particularDEF, $particularVAR);
                            }else if(!$showParticular && $showEmpresa && $showSeguro){ //100
                                array_push($resultTanatorio, $empresaDEF, $seguroDEF, $empresaVAR, $seguroVAR);
                            }else if(!$showParticular && $showEmpresa && !$showSeguro){ //101
                                array_push($resultTanatorio, $empresaDEF, $empresaVAR);
                            }else if(!$showParticular && !$showEmpresa && $showSeguro){ //110
                                array_push($resultTanatorio, $seguroDEF, $seguroVAR);
                            }
                        }else{
                            array_push($resultTanatorio, $particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR);
                        }
                    }else{
                        $exps = $db->resultToArray($result);

                        $particularDEF = array(1,'Particulares - Defunción',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'PD','');
                        $empresaDEF = array(2,'Empresas - Defunción',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'ED','');
                        $seguroDEF = array(3,'Seguros - Defunción',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'SD','');
                        $particularVAR = array(4,'Particulares - Varios',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'PV','');
                        $empresaVAR = array(5,'Empresas - Varios',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'EV','');
                        $seguroVAR = array(6,'Seguros - Varios',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'SV','');

                        //var aux
                        $numGrossMarginParticularDEF = 0;
                        $numPaymentParticularDEF = 0;
                        $numGrossMarginEmpresaDEF = 0;
                        $numPaymentEmpresaDEF = 0;
                        $numGrossMarginSeguroDEF = 0;
                        $numPaymentSeguroDEF = 0;

                        $numGrossMarginParticularVAR = 0;
                        $numPaymentParticularVAR = 0;
                        $numGrossMarginEmpresaVAR = 0;
                        $numPaymentEmpresaVAR = 0;
                        $numGrossMarginSeguroVAR = 0;
                        $numPaymentSeguroVAR = 0;

                        $numInvoicesParticularDEF = 0;
                        $numInvoicesEmpresaDEF = 0;
                        $numInvoicesSeguroDEF = 0;
                        $numInvoicesParticularVAR = 0;
                        $numInvoicesEmpresaVAR = 0;
                        $numInvoicesSeguroVAR = 0;

                        foreach($exps as $index => $elem){

                            // Tarifa para el año y el cliente del expediente
                            $purchasePriceParticularDEF = 0;
                            $purchasePriceEmpresaDEF = 0;
                            $purchasePriceSeguroDEF = 0;
                            $purchasePriceParticularVAR = 0;
                            $purchasePriceEmpresaVAR = 0;
                            $purchasePriceSeguroVAR = 0;

                            $priceNoIVAParticularDEF = 0;
                            $priceNoIVAEmpresaDEF = 0;
                            $priceNoIVASeguroDEF = 0;
                            $priceNoIVAParticularVAR = 0;
                            $priceNoIVAEmpresaVAR = 0;
                            $priceNoIVASeguroVAR = 0;

                            $grossMarginParticularDEF = 0;
                            $grossMarginEmpresaDEF = 0;
                            $grossMarginSeguroDEF = 0;
                            $grossMarginParticularVAR = 0;
                            $grossMarginEmpresaVAR = 0;
                            $grossMarginSeguroVAR = 0;
                            
                            $result = $db->query("  SELECT  p.name
                                                    FROM    Prices p
                                                    WHERE   p.priceID = {$elem['price']}");

                            if(mysqli_num_rows($result) == 0){
                                continue;
                            }else{
                                $priceName = $db->resultToArray($result)[0]['name'];

                                $result = $db->query("  SELECT  p.priceID
                                                        FROM    Prices p
                                                        WHERE   p.name LIKE '%$priceName%' AND
                                                                p.leavingDate IS NULL AND
                                                                p.year = {$elem['year']}");

                                if(mysqli_num_rows($result) == 0){
                                    continue;
                                }else{

                                    $price = $db->resultToArray($result)[0]['priceID'];
                                    $result = $db->query("  SELECT  SUM(pr.purchasePrice) as purchasePrice, 
                                                                    SUM(pp.priceNoIVA - (pp.priceNoIVA * eh.discount/100)) as priceNoIVA, 
                                                                    eh.model
                                                            FROM    Expedients_Hirings eh, Products_Retails pr, Products_Prices pp, Prices p
                                                            WHERE   eh.expedient = {$elem['expedientID']} AND
                                                                    eh.num_hiring = (
                                                                    SELECT  MAX(i2.num_hiring) 
                                                                    FROM    Invoices i2 
                                                                    WHERE   i2.expedient = {$elem['expedientID']} AND
                                                                            i2.leavingDate IS NULL AND
                                                                            i2.invoice_type != 3
                                                                    ) AND
                                                                    eh.check = 1 AND
                                                                    p.year = {$elem['year']} AND
                                                                    pr.model = eh.model AND
                                                                    pr.year = {$elem['year']} AND
                                                                    pp.model = eh.model AND
                                                                    pp.price = $price AND 
                                                                    p.priceID = pp.price AND 
                                                                    p.leavingDate IS NULL");
                                                                    
                                    if(mysqli_num_rows($result) > 0){
                                        $prices = $db->resultToArray($result);
                                        foreach($prices as $price){
                                            if($elem['type'] == 1 && $elem['clientType'] == 1){
                                                $purchasePriceParticularDEF = floatval($price['purchasePrice']);
                                                $priceNoIVAParticularDEF = floatval($price['priceNoIVA']);
                                                $grossMarginParticularDEF = (floatval($priceNoIVAParticularDEF) - floatval($purchasePriceParticularDEF));
                                            }else if($elem['type'] == 1 && $elem['clientType'] == 3){
                                                $purchasePriceEmpresaDEF = floatval($price['purchasePrice']);
                                                $priceNoIVAEmpresaDEF = floatval($price['priceNoIVA']);
                                                $grossMarginEmpresaDEF = (floatval($priceNoIVAEmpresaDEF) - floatval($purchasePriceEmpresaDEF));
                                            }else if($elem['type'] == 1 && $elem['clientType'] == 2){
                                                $purchasePriceSeguroDEF = floatval($price['purchasePrice']);
                                                $priceNoIVASeguroDEF = floatval($price['priceNoIVA']);
                                                $grossMarginSeguroDEF = (floatval($priceNoIVASeguroDEF) - floatval($purchasePriceSeguroDEF));
                                            }else if($elem['type'] == 3 && $elem['clientType'] == 1){ 
                                                $purchasePriceParticularVAR = floatval($price['purchasePrice']);
                                                $priceNoIVAParticularVAR = floatval($price['priceNoIVA']);
                                                $grossMarginParticularVAR = (floatval($priceNoIVAParticularVAR) - floatval($purchasePriceParticularVAR));
                                            }else if($elem['type'] == 3 && $elem['clientType'] == 3){
                                                $purchasePriceEmpresaVAR = floatval($price['purchasePrice']);
                                                $priceNoIVAEmpresaVAR = floatval($price['priceNoIVA']);
                                                $grossMarginEmpresaVAR = (floatval($priceNoIVAEmpresaVAR) - floatval($purchasePriceEmpresaVAR));
                                            }else if($elem['type'] == 3 && $elem['clientType'] == 2){
                                                $purchasePriceSeguroVAR = floatval($price['purchasePrice']);
                                                $priceNoIVASeguroVAR = floatval($price['priceNoIVA']);
                                                $grossMarginSeguroVAR = (floatval($priceNoIVASeguroVAR) - floatval($purchasePriceSeguroVAR));
                                            }
                                        }
                                    }
                                }
                            }
                            
                            //Suplidos
                            $suplidosParticularDEF = 0;
                            $suplidosEmpresaDEF = 0;
                            $suplidosSeguroDEF = 0;
                            $suplidosParticularVAR = 0;
                            $suplidosEmpresaVAR = 0;
                            $suplidosSeguroVAR = 0;

                            $facturacionParticularDEF = 0;
                            $facturacionEmpresaDEF = 0;
                            $facturacionSeguroDEF = 0;
                            $facturacionParticularVAR = 0;
                            $facturacionEmpresaVAR = 0;
                            $facturacionSeguroVAR = 0;

                            $facturacionTotalParticularDEF = 0;
                            $facturacionTotalEmpresaDEF = 0;
                            $facturacionTotalSeguroDEF = 0;
                            $facturacionTotalParticularVAR = 0;
                            $facturacionTotalEmpresaVAR = 0;
                            $facturacionTotalSeguroVAR = 0;
                          
                            $expedientID = $elem['expedientID'];

                            $result = $db->query("  SELECT      SUM(eh.total) as cost
                                                    FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                                    LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                                    WHERE       eh.expedient = $expedientID AND 
                                                                eh.num_hiring = (
                                                                    SELECT  MAX(i2.num_hiring) 
                                                                    FROM    Invoices i2 
                                                                    WHERE   i2.expedient = e.expedientID AND
                                                                            i2.leavingDate IS NULL AND
                                                                            i2.invoice_type != 3
                                                                ) AND
                                                                eh.check = 1 AND 
                                                                eh.expedient = e.expedientID AND
                                                                eh.model = pm.productModelID AND
                                                                eh.product = pr.productID AND
                                                                pr.IVA = it.IVATypeID AND
                                                                pr.leavingDate IS NULL AND
                                                                pr.supplied = 1 AND
                                                                pr.isInvoiced = 0
                            ");
                            if(mysqli_num_rows($result) > 0){
                                $supplieds = $db->resultToArray($result)[0]['cost']; 
                                
                                if($elem['type'] == 1 && $elem['clientType'] == 1){
                                    $suplidosParticularDEF = $supplieds;
                                    $facturacionParticularDEF =  floatval($elem['fact']) + floatval($supplieds);
                                    $facturacionTotalParticularDEF = floatval($elem['factTotal']);
                                }else if($elem['type'] == 1 && $elem['clientType'] == 3){
                                    $suplidosEmpresaDEF = $supplieds;
                                    $facturacionEmpresaDEF =  floatval($elem['fact']) + floatval($supplieds);
                                    $facturacionTotalEmpresaDEF = floatval($elem['factTotal']);
                                   
                                }else if($elem['type'] == 1 && $elem['clientType'] == 2){
                                    $suplidosSeguroDEF = $supplieds;
                                    $facturacionSeguroDEF =  floatval($elem['fact']) + floatval($supplieds);
                                    $facturacionTotalSeguroDEF = floatval($elem['factTotal']);
                                    
                                }else if($elem['type'] == 3 && $elem['clientType'] == 1){ 
                                    $suplidosParticularVAR = $supplieds;
                                    $facturacionParticularVAR =  floatval($elem['fact']) + floatval($supplieds);
                                    $facturacionTotalParticularVAR = floatval($elem['factTotal']);
                                   
                                }else if($elem['type'] == 3 && $elem['clientType'] == 3){
                                    $suplidosEmpresaVAR = $supplieds;
                                    $facturacionEmpresaVAR =  floatval($elem['fact']) + floatval($supplieds);
                                    $facturacionTotalEmpresaVAR = floatval($elem['factTotal']);
                                }else if($elem['type'] == 3 && $elem['clientType'] == 2){
                                    $suplidosSeguroVAR = $supplieds;
                                    $facturacionSeguroVAR =  floatval($elem['fact']) + floatval($supplieds);
                                    $facturacionTotalSeguroVAR = floatval($elem['factTotal']);
                                }
                            } 

                            if($elem['type'] == 1 && $elem['clientType'] == 1){  //DEFUNCION PARTICULARES
                                $particularDEF[2]++;
                                $particularDEF[3]+= floatval($elem['bi']);
                                $particularDEF[4]+= floatval($suplidosParticularDEF);
                                $particularDEF[5]+= floatval($facturacionParticularDEF); 

                                // Get invoice ivas
                                $resultInvoiceIvas = $db->query("   SELECT      iniv.typeIva, iniv.iva
                                                                    FROM        Invoices_Ivas iniv, Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = $expedientID AND
                                                                                iniv.invoice = i.ID AND
                                                                                iniv.deleteDate IS NULL
                                ");
                                if(mysqli_num_rows($resultInvoiceIvas) > 0){
                                    $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                                    foreach($invoiceIvas as $invoiceIv){
                                        $keys = array_column($particularDEF[7], 'percentage');
                                        $indexAux = array_search($invoiceIv['typeIva'], $keys);
    
                                        if($indexAux !== false) {
                                            $particularDEF[7][$indexAux]['total'] += floatval($invoiceIv['iva']);
                                        }
                                    }
                                }

                                $particularDEF[8]+= floatval($elem['totalIva']);
                                $particularDEF[9]+= floatval($facturacionTotalParticularDEF);
                                $particularDEF[10]+= floatval($elem['paid']);
                                $particularDEF[11]+= floatval($elem['pending']);
                                if($grossMarginParticularDEF != null && $grossMarginParticularDEF != ''){
                                    $particularDEF[12]+= $grossMarginParticularDEF;
                                    $numGrossMarginParticularDEF++;
                                }

                                if($elem['paymentDate'] != null && $elem['paymentDate'] != 0){
                                    $datefrom = DateTime::createFromFormat('d/m/Y H:i:s', date('d/m/Y H:i:s', $elem['creationDate']));
                                    $dateto = DateTime::createFromFormat('d/m/Y H:i:s', date('d/m/Y H:i:s', $elem['paymentDate']));
                                    $interval = $datefrom->diff($dateto);
                                    $week_total = $interval->format('%a');
                                    $particularDEF[13]+= $week_total;
                                    $numPaymentParticularDEF++;
                                }

                                $particularDEF[15] += intval($elem['totalInvoicesPaid']);
                            }else if($elem['type'] == 1 && $elem['clientType'] == 3){ //DEFUNCIÓN EMPRESAS
                                $empresaDEF[2]++;
                                $empresaDEF[3]+= floatval($elem['bi']);
                                $empresaDEF[4]+= floatval($suplidosEmpresaDEF);
                                $empresaDEF[5]+= floatval($facturacionEmpresaDEF); 

                                // Get invoice ivas
                                $resultInvoiceIvas = $db->query("   SELECT      iniv.typeIva, iniv.iva
                                                                    FROM        Invoices_Ivas iniv, Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = $expedientID AND
                                                                                iniv.invoice = i.ID AND
                                                                                iniv.deleteDate IS NULL
                                ");
                                if(mysqli_num_rows($resultInvoiceIvas) > 0){
                                    $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                                    foreach($invoiceIvas as $invoiceIv){
                                        $keys = array_column($empresaDEF[7], 'percentage');
                                        $indexAux = array_search($invoiceIv['typeIva'], $keys);
    
                                        if($indexAux !== false) {
                                            $empresaDEF[7][$indexAux]['total'] += floatval($invoiceIv['iva']);
                                        }
                                    }
                                }

                                $empresaDEF[8]+= floatval($elem['totalIva']);
                                $empresaDEF[9]+= floatval($facturacionTotalEmpresaDEF);
                                $empresaDEF[10]+= floatval($elem['paid']);
                                $empresaDEF[11]+= floatval($elem['pending']);
                                if($grossMarginEmpresaDEF != null && $grossMarginEmpresaDEF != ''){
                                    $empresaDEF[12]+= (floatval($grossMarginEmpresaDEF));
                                    $numGrossMarginEmpresaDEF++;
                                }

                                if($elem['paymentDate'] != null && $elem['paymentDate'] != 0){
                                    $datefrom = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['creationDate']));
                                    $dateto = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['paymentDate']));
                                    $interval = $datefrom->diff($dateto);
                                    $week_total = $interval->format('%a');
                                    $empresaDEF[13]+= $week_total;
                                    $numPaymentEmpresaDEF++;
                                }

                                $empresaDEF[15] += intval($elem['totalInvoicesPaid']);
                            }else if($elem['type'] == 1 && $elem['clientType'] == 2){ //DEFUNCIÓN SEGUROS
                                $seguroDEF[2]++;
                                $seguroDEF[3]+= floatval($elem['bi']);
                                $seguroDEF[4]+= floatval($suplidosSeguroDEF);
                                $seguroDEF[5]+= floatval($facturacionSeguroDEF); 

                                // Get invoice ivas
                                $resultInvoiceIvas = $db->query("   SELECT      iniv.typeIva, iniv.iva
                                                                    FROM        Invoices_Ivas iniv, Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = $expedientID AND
                                                                                iniv.invoice = i.ID AND
                                                                                iniv.deleteDate IS NULL
                                ");
                                if(mysqli_num_rows($resultInvoiceIvas) > 0){
                                    $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                                    foreach($invoiceIvas as $invoiceIv){
                                        $keys = array_column($seguroDEF[7], 'percentage');
                                        $indexAux = array_search($invoiceIv['typeIva'], $keys);
    
                                        if($indexAux !== false) {
                                            $seguroDEF[7][$indexAux]['total'] += floatval($invoiceIv['iva']);
                                        }
                                    }
                                }

                                $seguroDEF[8]+= floatval($elem['totalIva']);
                                $seguroDEF[9]+= floatval($facturacionTotalSeguroDEF);
                                $seguroDEF[10]+= floatval($elem['paid']);
                                $seguroDEF[11]+= floatval($elem['pending']);
                                if($grossMarginSeguroDEF != null && $grossMarginSeguroDEF != ''){
                                    $seguroDEF[12]+= (floatval($grossMarginSeguroDEF));
                                    $numGrossMarginSeguroDEF++;
                                }

                                if($elem['paymentDate'] != null && $elem['paymentDate'] != 0){
                                    $datefrom = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['creationDate']));
                                    $dateto = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['paymentDate']));
                                    $interval = $datefrom->diff($dateto);
                                    $week_total = $interval->format('%a');
                                    $seguroDEF[13]+= $week_total;
                                    $numPaymentSeguroDEF++;
                                }

                                $seguroDEF[15] += intval($elem['totalInvoicesPaid']);
                            }else if($elem['type'] == 3 && $elem['clientType'] == 1){  //VARIOS PARTICULARES
                                $particularVAR[2]++; //Num Defunciones 
                                $particularVAR[3]+= floatval($elem['bi']);
                                $particularVAR[4]+= floatval($suplidosParticularVAR);
                                $particularVAR[5]+= floatval($facturacionParticularVAR); 

                                // Get invoice ivas
                                $resultInvoiceIvas = $db->query("   SELECT      iniv.typeIva, iniv.iva
                                                                    FROM        Invoices_Ivas iniv, Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = $expedientID AND
                                                                                iniv.invoice = i.ID AND
                                                                                iniv.deleteDate IS NULL
                                ");
                                if(mysqli_num_rows($resultInvoiceIvas) > 0){
                                    $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                                    foreach($invoiceIvas as $invoiceIv){
                                        $keys = array_column($particularVAR[7], 'percentage');
                                        $indexAux = array_search($invoiceIv['typeIva'], $keys);
    
                                        if($indexAux !== false) {
                                            $particularVAR[7][$indexAux]['total'] += floatval($invoiceIv['iva']);
                                        }
                                    }
                                }

                                $particularVAR[8]+= floatval($elem['totalIva']);
                                $particularVAR[9]+= floatval($facturacionTotalParticularVAR);
                                $particularVAR[10]+= floatval($elem['paid']);
                                $particularVAR[11]+= floatval($elem['pending']);
                                if($grossMarginParticularVAR != null && $grossMarginParticularVAR != ''){
                                    $particularVAR[12]+= (floatval($grossMarginParticularVAR));
                                    $numGrossMarginParticularVAR ++;
                                }
                                if($elem['paymentDate'] != null && $elem['paymentDate'] != 0){
                                    $datefrom = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['creationDate']));
                                    $dateto = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['paymentDate']));
                                    $interval = $datefrom->diff($dateto);
                                    $week_total = $interval->format('%a');
                                    $particularVAR[13]+= $week_total;
                                    $numPaymentParticularVAR++;
                                }

                                $particularVAR[15] += intval($elem['totalInvoicesPaid']);
                            }else if($elem['type'] == 3 && $elem['clientType'] == 3){ //VARIOS EMPRESAS
                                $empresaVAR[2]++;
                                $empresaVAR[3]+= floatval($elem['bi']);
                                $empresaVAR[4]+= floatval($suplidosEmpresaVAR); 
                                $empresaVAR[5]+= floatval($facturacionEmpresaVAR); 

                                // Get invoice ivas
                                $resultInvoiceIvas = $db->query("   SELECT      iniv.typeIva, iniv.iva
                                                                    FROM        Invoices_Ivas iniv, Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = $expedientID AND
                                                                                iniv.invoice = i.ID AND
                                                                                iniv.deleteDate IS NULL
                                ");
                                if(mysqli_num_rows($resultInvoiceIvas) > 0){
                                    $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                                    foreach($invoiceIvas as $invoiceIv){
                                        $keys = array_column($empresaVAR[7], 'percentage');
                                        $indexAux = array_search($invoiceIv['typeIva'], $keys);
    
                                        if($indexAux !== false) {
                                            $empresaVAR[7][$indexAux]['total'] += floatval($invoiceIv['iva']);
                                        }
                                    }
                                }
                                $empresaVAR[8]+= floatval($elem['totalIva']);
                                $empresaVAR[9]+= floatval($facturacionTotalEmpresaVAR);
                                $empresaVAR[10]+= floatval($elem['paid']);
                                $empresaVAR[11]+= floatval($elem['pending']);
                                if($grossMarginEmpresaVAR != null && $grossMarginEmpresaVAR != ''){
                                    $empresaVAR[12]+= (floatval($grossMarginEmpresaVAR));
                                    $numGrossMarginEmpresaVAR++;
                                }
                                if($elem['paymentDate'] != null && $elem['paymentDate'] != 0){
                                    $datefrom = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['creationDate']));
                                    $dateto = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['paymentDate']));
                                    $interval = $datefrom->diff($dateto);
                                    $week_total = $interval->format('%a');
                                    $empresaVAR[13]+= $week_total;
                                    $numPaymentEmpresaVAR++;
                                }

                                $empresaVAR[15] += intval($elem['totalInvoicesPaid']);
                            }else if($elem['type'] == 3 && $elem['clientType'] == 2){ //VARIOS SEGUROS
                                $seguroVAR[2]++;
                                $seguroVAR[3]+= floatval($elem['bi']);
                                $seguroVAR[4]+= floatval($suplidosSeguroVAR); 
                                $seguroVAR[5]+= floatval($facturacionSeguroVAR); 

                                // Get invoice ivas
                                $resultInvoiceIvas = $db->query("   SELECT      iniv.typeIva, iniv.iva
                                                                    FROM        Invoices_Ivas iniv, Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = $expedientID AND
                                                                                iniv.invoice = i.ID AND
                                                                                iniv.deleteDate IS NULL
                                ");
                                if(mysqli_num_rows($resultInvoiceIvas) > 0){
                                    $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                                    foreach($invoiceIvas as $invoiceIv){
                                        $keys = array_column($seguroVAR[7], 'percentage');
                                        $indexAux = array_search($invoiceIv['typeIva'], $keys);
    
                                        if($indexAux !== false) {
                                            $seguroVAR[7][$indexAux]['total'] += floatval($invoiceIv['iva']);
                                        }
                                    }
                                }

                                $seguroVAR[8]+= floatval($elem['totalIva']);
                                $seguroVAR[9]+= floatval($facturacionTotalSeguroVAR);
                                $seguroVAR[10]+= floatval($elem['paid']);
                                $seguroVAR[11]+= floatval($elem['pending']);
                                if($grossMarginSeguroVAR != null && $grossMarginSeguroVAR != ''){
                                    $seguroVAR[12]+= (floatval($grossMarginSeguroVAR));
                                    $numGrossMarginSeguroVAR++;
                                }

                                if($elem['paymentDate'] != null && $elem['paymentDate'] != 0){
                                    $datefrom = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['creationDate']));
                                    $dateto = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['paymentDate']));
                                    $interval = $datefrom->diff($dateto);
                                    $week_total = $interval->format('%a');
                                    $seguroVAR[13]+= $week_total;
                                    $numPaymentSeguroVAR++;
                                }

                                $seguroVAR[15] += intval($elem['totalInvoicesPaid']);
                            }
                        }

                        if($particularDEF[12] > 0){
                            $particularDEF[14] = floatval($particularDEF[12]/$particularDEF[3]) * 100;
                        }
                        if($particularDEF[15] > 0){
                            $particularDEF[13] = floatval($particularDEF[13]/$particularDEF[15]);
                        }

                        if($empresaDEF[12] > 0){
                            $empresaDEF[14] = floatval($empresaDEF[12]/$empresaDEF[3]) * 100;
                        }
                        if($empresaDEF[15] > 0){
                            $empresaDEF[13] = floatval($empresaDEF[13]/$empresaDEF[15]);
                        }

                        if($seguroDEF[12] > 0){
                            $seguroDEF[14] = floatval($seguroDEF[12]/$seguroDEF[3]) * 100;
                        }
                        if($seguroDEF[15] > 0){
                            $seguroDEF[13] = floatval($seguroDEF[13]/$seguroDEF[15]);
                        }

                        if($particularVAR[12] > 0){
                            $particularVAR[14] = floatval($particularVAR[12]/$particularVAR[3]) * 100;
                        }
                        if($particularVAR[15] > 0){
                            $particularVAR[13] = floatval($particularVAR[13]/$particularVAR[15]);
                        }

                        if($empresaVAR[12] > 0){
                            $empresaVAR[14] = floatval($empresaVAR[12]/$empresaVAR[3]) * 100;
                        }
                        if($empresaVAR[15] > 0){
                            $empresaVAR[13] = floatval($empresaVAR[13]/$empresaVAR[15]);
                        }

                        if($seguroVAR[12] > 0){
                            $seguroVAR[14] = floatval($seguroVAR[12]/$seguroVAR[3]) * 100;
                        }
                        if($seguroVAR[15] > 0){
                            $seguroVAR[13] = floatval($seguroVAR[13]/$seguroVAR[15]);
                        }

                        if($clientType != ''){
                            if($showParticular && $showEmpresa && $showSeguro){ //000
                                array_push($resultTanatorio, $particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR);
                            }else if($showParticular && $showEmpresa && !$showSeguro){ //001
                                array_push($resultTanatorio, $particularDEF, $empresaDEF, $particularVAR, $empresaVAR);
                            }else if($showParticular && !$showEmpresa && $showSeguro){ //010
                                array_push($resultTanatorio, $particularDEF, $seguroDEF, $particularVAR, $seguroVAR);
                            }else if($showParticular && !$showEmpresa && !$showSeguro){ //011
                                array_push($resultTanatorio, $particularDEF, $particularVAR);
                            }else if(!$showParticular && $showEmpresa && $showSeguro){ //100
                                array_push($resultTanatorio, $empresaDEF, $seguroDEF, $empresaVAR, $seguroVAR);
                            }else if(!$showParticular && $showEmpresa && !$showSeguro){ //101
                                array_push($resultTanatorio, $empresaDEF, $empresaVAR);
                            }else if(!$showParticular && !$showEmpresa && $showSeguro){ //110
                                array_push($resultTanatorio, $seguroDEF, $seguroVAR);
                            }
                        }else{
                            array_push($resultTanatorio, $particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR);
                        }
                    }

                    if($client != ''){
                        foreach($client as $elemClient){
                            $whereAux = '';
                            if($date == ''){
                                if($dateSince != '' && $dateUntil != ''){
                                    $whereAux .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                                }
                            }else{
                                $whereAux .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
                            }

                            if($clientType != ''){
                                $whereAux .= ' AND e.clientType IN (';
                                foreach($clientType as $elem){
                                    $elem = cleanStr($elem);
                                    $whereAux .= $elem . ',';
                                }
                                $whereAux = substr($whereAux, 0, -1);
                                $whereAux .= ')';
                            }
                            
                            $whereAux .= " AND c.clientID =  $elemClient";
                            $clientResult = $this->getControlPanelSummaryClient($whereAux, $whereCC, $elemClient, 1);
                            array_push($resultTanatorio, $clientResult);
                            $clientResult = $this->getControlPanelSummaryClient($whereAux, $whereCC, $elemClient, 3);
                            array_push($resultTanatorio, $clientResult);
                        }
                    }
                    array_push($resultFinal, [$ccID, $costName, $resultTanatorio]);
                }
            }


            $resultTanatorio = [];
            $ccID = 0;
            $costName = 'Otras instalaciones';

            $result = $db->query("  SELECT      e.expedientID, 
                                                e.requestDate, YEAR(e.requestDate) as year, 
                                                e.type, 
                                                e.clientType as clientType,
                                                c.clientID, 
                                                c.name, 
                                                c.surname, 
                                                c.price,
                                                (
                                                    (
                                                        SELECT      COALESCE(SUM(iniv.base), 0)
                                                        FROM        Invoices i
                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as bi,
                                                (
                                                    (
                                                        SELECT      COALESCE(SUM(i.supplieds), 0)
                                                        FROM        Invoices i
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as su,
                                                (
                                                    (
                                                        SELECT      COALESCE(SUM(iniv.base), 0)
                                                        FROM        Invoices i
                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as fact,
                                                '' as iva1, 
                                                '' as iva2, 
                                                (
                                                    (
                                                        SELECT      COALESCE(SUM(iniv.iva), 0)
                                                        FROM        Invoices i
                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as totalIva,
                                                (
                                                    (
                                                        SELECT      COALESCE(SUM(i.total), 0)
                                                        FROM        Invoices i
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as factTotal,
                                                (
                                                    (
                                                        SELECT      COALESCE(SUM(ip.amount), 0)
                                                        FROM        Invoices i
                                                        JOIN        Invoices_Payments ip ON ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as paid,
                                                (
                                                    (
                                                        (
                                                            (
                                                                SELECT      COALESCE(SUM(i.total), 0)
                                                                FROM        Invoices i
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = e.expedientID
                                                            )
                                                        )
                                                    )
                                                    -
                                                    (
                                                        (
                                                            (
                                                                SELECT      COALESCE(SUM(ip.amount), 0)
                                                                FROM        Invoices i
                                                                JOIN        Invoices_Payments ip ON ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = e.expedientID
                                                            )
                                                        )
                                                    )
                                                ) as pending,
                                                (
                                                    SELECT      COALESCE(SUM(i.paymentDate), 0)
                                                    FROM        Invoices i
                                                    WHERE       i.leavingDate IS NULL AND 
                                                                i.invoice_type != 3 AND
                                                                i.expedient = e.expedientID AND 
                                                                (
                                                                    SELECT  COUNT(*)
                                                                    FROM    Invoices_Payments ip
                                                                    WHERE   ip.leavingDate IS NULL AND
                                                                            ip.invoice = i.ID
                                                                ) > 0
                                                ) as paymentDate,
                                                (
                                                    SELECT      COALESCE(SUM(i.creationDate), 0)
                                                    FROM        Invoices i
                                                    WHERE       i.leavingDate IS NULL AND 
                                                                i.invoice_type != 3 AND
                                                                i.expedient = e.expedientID AND 
                                                                (
                                                                    SELECT  COUNT(*)
                                                                    FROM    Invoices_Payments ip
                                                                    WHERE   ip.leavingDate IS NULL AND
                                                                            ip.invoice = i.ID
                                                                ) > 0
                                                ) as creationDate,
                                                (
                                                    (
                                                        SELECT      COALESCE(SUM(i.total), 0)
                                                        FROM        Invoices i
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as invoiceTotal, 
                                                (
                                                    SELECT      COUNT(*)
                                                    FROM        Invoices i
                                                    WHERE       i.leavingDate IS NULL AND 
                                                                i.invoice_type != 3 AND
                                                                i.expedient = e.expedientID AND 
                                                                (
                                                                    SELECT  COUNT(*)
                                                                    FROM    Invoices_Payments ip
                                                                    WHERE   ip.leavingDate IS NULL AND
                                                                            ip.invoice = i.ID
                                                                ) > 0
                                                ) as totalInvoicesPaid,
                                                e.number as expedientNumber,
                                                '' as invoiceID
                                    FROM        (Expedients e, Clients c)
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    WHERE       e.client = c.clientID AND
                                                e.leavingDate IS NULL AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0 AND
                                                (SELECT COUNT(*) FROM Cost_Center cc WHERE cc.mortuary = m.mortuaryID) = 0
                                                $where
                                    ORDER BY    c.clientID
            ");

            if(mysqli_num_rows($result) > 0){
                $exps = $db->resultToArray($result);

                $particularDEF = array(1,'Particulares - Defunción',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'PD','');
                $empresaDEF = array(2,'Empresas - Defunción',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'ED','');
                $seguroDEF = array(3,'Seguros - Defunción',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'SD','');
                $particularVAR = array(4,'Particulares - Varios',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'PV','');
                $empresaVAR = array(5,'Empresas - Varios',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'EV','');
                $seguroVAR = array(6,'Seguros - Varios',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'SV','');

                //var aux
                $numGrossMarginParticularDEF = 0;
                $numPaymentParticularDEF = 0;
                $numGrossMarginEmpresaDEF = 0;
                $numPaymentEmpresaDEF = 0;
                $numGrossMarginSeguroDEF = 0;
                $numPaymentSeguroDEF = 0;

                $numGrossMarginParticularVAR = 0;
                $numPaymentParticularVAR = 0;
                $numGrossMarginEmpresaVAR = 0;
                $numPaymentEmpresaVAR = 0;
                $numGrossMarginSeguroVAR = 0;
                $numPaymentSeguroVAR = 0;

                foreach($exps as $index => $elem){
                    // Tarifa para el año y el cliente del expediente
                    $purchasePriceParticularDEF = 0;
                    $purchasePriceEmpresaDEF = 0;
                    $purchasePriceSeguroDEF = 0;
                    $purchasePriceParticularVAR = 0;
                    $purchasePriceEmpresaVAR = 0;
                    $purchasePriceSeguroVAR = 0;

                    $priceNoIVAParticularDEF = 0;
                    $priceNoIVAEmpresaDEF = 0;
                    $priceNoIVASeguroDEF = 0;
                    $priceNoIVAParticularVAR = 0;
                    $priceNoIVAEmpresaVAR = 0;
                    $priceNoIVASeguroVAR = 0;

                    $grossMarginParticularDEF = 0;
                    $grossMarginEmpresaDEF = 0;
                    $grossMarginSeguroDEF = 0;
                    $grossMarginParticularVAR = 0;
                    $grossMarginEmpresaVAR = 0;
                    $grossMarginSeguroVAR = 0;

                    $numInvoicesParticularDEF = 0;
                    $numInvoicesEmpresaDEF = 0;
                    $numInvoicesSeguroDEF = 0;
                    $numInvoicesParticularVAR = 0;
                    $numInvoicesEmpresaVAR = 0;
                    $numInvoicesSeguroVAR = 0;
                    
                    $result = $db->query("  SELECT  p.name
                                            FROM    Prices p
                                            WHERE   p.priceID = {$elem['price']}");

                    if(mysqli_num_rows($result) == 0){
                        continue;
                    }else{
                        $priceName = $db->resultToArray($result)[0]['name'];

                        $result = $db->query("  SELECT  p.priceID
                                                FROM    Prices p
                                                WHERE   p.name LIKE '%$priceName%' AND
                                                        p.leavingDate IS NULL AND
                                                        p.year = {$elem['year']}");

                        if(mysqli_num_rows($result) == 0){
                            continue;
                        }else{

                            $price = $db->resultToArray($result)[0]['priceID'];
                            $result = $db->query("  SELECT  SUM(pr.purchasePrice) as purchasePrice, 
                                                            SUM(pp.priceNoIVA - (pp.priceNoIVA * eh.discount/100)) as priceNoIVA, 
                                                            eh.model
                                                    FROM    Expedients_Hirings eh, Products_Retails pr, Products_Prices pp, Prices p
                                                    WHERE   eh.expedient = {$elem['expedientID']} AND
                                                            eh.check = 1 AND
                                                            eh.num_hiring = (
                                                                SELECT  MAX(i2.num_hiring) 
                                                                FROM    Invoices i2 
                                                                WHERE   i2.expedient = {$elem['expedientID']} AND
                                                                        i2.leavingDate IS NULL AND
                                                                        i2.invoice_type != 3
                                                            ) AND
                                                            p.year = {$elem['year']} AND
                                                            pr.model = eh.model AND
                                                            pr.year = {$elem['year']} AND
                                                            pp.model = eh.model AND
                                                            pp.price = $price AND 
                                                            p.priceID = pp.price AND 
                                                            p.leavingDate IS NULL
                            ");
                                                            
                            if(mysqli_num_rows($result) > 0){
                                $prices = $db->resultToArray($result);
                                foreach($prices as $price){
                                    if($elem['type'] == 1 && $elem['clientType'] == 1){
                                        $purchasePriceParticularDEF = floatval($price['purchasePrice']);
                                        $priceNoIVAParticularDEF = floatval($price['priceNoIVA']);
                                        $grossMarginParticularDEF = (floatval($priceNoIVAParticularDEF) - floatval($purchasePriceParticularDEF));
                                    }else if($elem['type'] == 1 && $elem['clientType'] == 3){
                                        $purchasePriceEmpresaDEF = floatval($price['purchasePrice']);
                                        $priceNoIVAEmpresaDEF = floatval($price['priceNoIVA']);
                                        $grossMarginEmpresaDEF = (floatval($priceNoIVAEmpresaDEF) - floatval($purchasePriceEmpresaDEF));
                                    }else if($elem['type'] == 1 && $elem['clientType'] == 2){
                                        $purchasePriceSeguroDEF = floatval($price['purchasePrice']);
                                        $priceNoIVASeguroDEF = floatval($price['priceNoIVA']);
                                        $grossMarginSeguroDEF = (floatval($priceNoIVASeguroDEF) - floatval($purchasePriceSeguroDEF));
                                    }else if($elem['type'] == 3 && $elem['clientType'] == 1){ 
                                        $purchasePriceParticularVAR = floatval($price['purchasePrice']);
                                        $priceNoIVAParticularVAR = floatval($price['priceNoIVA']);
                                        $grossMarginParticularVAR = (floatval($priceNoIVAParticularVAR) - floatval($purchasePriceParticularVAR));
                                    }else if($elem['type'] == 3 && $elem['clientType'] == 3){
                                        $purchasePriceEmpresaVAR = floatval($price['purchasePrice']);
                                        $priceNoIVAEmpresaVAR = floatval($price['priceNoIVA']);
                                        $grossMarginEmpresaVAR = (floatval($priceNoIVAEmpresaVAR) - floatval($purchasePriceEmpresaVAR));
                                    }else if($elem['type'] == 3 && $elem['clientType'] == 2){
                                        $purchasePriceSeguroVAR = floatval($price['purchasePrice']);
                                        $priceNoIVASeguroVAR = floatval($price['priceNoIVA']);
                                        $grossMarginSeguroVAR = (floatval($priceNoIVASeguroVAR) - floatval($purchasePriceSeguroVAR));
                                    }
                                }
                            }
                        }
                    }
                    
                    //Suplidos
                    $suplidosParticularDEF = 0;
                    $suplidosEmpresaDEF = 0;
                    $suplidosSeguroDEF = 0;
                    $suplidosParticularVAR = 0;
                    $suplidosEmpresaVAR = 0;
                    $suplidosSeguroVAR = 0;

                    $facturacionParticularDEF = 0;
                    $facturacionEmpresaDEF = 0;
                    $facturacionSeguroDEF = 0;
                    $facturacionParticularVAR = 0;
                    $facturacionEmpresaVAR = 0;
                    $facturacionSeguroVAR = 0;

                    $facturacionTotalParticularDEF = 0;
                    $facturacionTotalEmpresaDEF = 0;
                    $facturacionTotalSeguroDEF = 0;
                    $facturacionTotalParticularVAR = 0;
                    $facturacionTotalEmpresaVAR = 0;
                    $facturacionTotalSeguroVAR = 0;
                    
                    $expedientID = $elem['expedientID'];

                    $result = $db->query("  SELECT      SUM(eh.total) as cost
                                            FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                            LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                            WHERE       eh.expedient = $expedientID AND 
                                                        eh.check = 1 AND 
                                                        eh.num_hiring = (
                                                            SELECT  MAX(i2.num_hiring) 
                                                            FROM    Invoices i2 
                                                            WHERE   i2.expedient = e.expedientID AND
                                                                    i2.leavingDate IS NULL AND
                                                                    i2.invoice_type != 3
                                                        ) AND
                                                        eh.expedient = e.expedientID AND
                                                        eh.model = pm.productModelID AND
                                                        eh.product = pr.productID AND
                                                        pr.IVA = it.IVATypeID AND
                                                        pr.leavingDate IS NULL AND
                                                        pr.supplied = 1 AND
                                                        pr.isInvoiced = 0");
                    if(mysqli_num_rows($result) > 0){
                        $supplieds = $db->resultToArray($result)[0]['cost']; 
                        
                        if($elem['type'] == 1 && $elem['clientType'] == 1){
                            $suplidosParticularDEF = $supplieds;
                            $facturacionParticularDEF =  floatval($elem['fact']) + floatval($supplieds);
                            $facturacionTotalParticularDEF = floatval($elem['factTotal']) ;
                        }else if($elem['type'] == 1 && $elem['clientType'] == 3){
                            $suplidosEmpresaDEF = $supplieds;
                            $facturacionEmpresaDEF =  floatval($elem['fact']) + floatval($supplieds);
                            $facturacionTotalEmpresaDEF = floatval($elem['factTotal']) ;
                            
                        }else if($elem['type'] == 1 && $elem['clientType'] == 2){
                            $suplidosSeguroDEF = $supplieds;
                            $facturacionSeguroDEF =  floatval($elem['fact']) + floatval($supplieds);
                            $facturacionTotalSeguroDEF = floatval($elem['factTotal']) ;
                            
                        }else if($elem['type'] == 3 && $elem['clientType'] == 1){ 
                            $suplidosParticularVAR = $supplieds;
                            $facturacionParticularVAR =  floatval($elem['fact']) + floatval($supplieds);
                            $facturacionTotalParticularVAR = floatval($elem['factTotal']);
                            
                        }else if($elem['type'] == 3 && $elem['clientType'] == 3){
                            $suplidosEmpresaVAR = $supplieds;
                            $facturacionEmpresaVAR =  floatval($elem['fact']) + floatval($supplieds);
                            $facturacionTotalEmpresaVAR = floatval($elem['factTotal']);
                        }else if($elem['type'] == 3 && $elem['clientType'] == 2){
                            $suplidosSeguroVAR = $supplieds;
                            $facturacionSeguroVAR =  floatval($elem['fact']) + floatval($supplieds);
                            $facturacionTotalSeguroVAR = floatval($elem['factTotal']);
                        }
                    } 

                    if($elem['type'] == 1 && $elem['clientType'] == 1){  //DEFUNCION PARTICULARES
                        $particularDEF[2]++;
                        $particularDEF[3]+= floatval($elem['bi']);
                        $particularDEF[4]+= floatval($suplidosParticularDEF);
                        $particularDEF[5]+= floatval($facturacionParticularDEF);

                        // Get invoice ivas
                        $resultInvoiceIvas = $db->query("   SELECT      iniv.typeIva, iniv.iva
                                                            FROM        Invoices_Ivas iniv, Invoices i
                                                            WHERE       i.leavingDate IS NULL AND
                                                                        i.invoice_type != 3 AND
                                                                        (
                                                                            (
                                                                                i.ID = (
                                                                                    SELECT  MAX(i2.ID)
                                                                                    FROM    Invoices i2
                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                            i2.invoice_type != 3 AND
                                                                                            i2.expedient = i.expedient AND 
                                                                                            (
                                                                                                i2.rectified_type IS NULL OR 
                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                            )
                                                                                )
                                                                            ) OR
                                                                            (
                                                                                i.rectified_type = 2
                                                                            )
                                                                        ) AND
                                                                        i.expedient = $expedientID AND
                                                                        iniv.invoice = i.ID AND
                                                                        iniv.deleteDate IS NULL
                        ");
                        if(mysqli_num_rows($resultInvoiceIvas) > 0){
                            $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                            foreach($invoiceIvas as $invoiceIv){
                                $keys = array_column($particularDEF[7], 'percentage');
                                $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                if($indexAux !== false) {
                                    $particularDEF[7][$indexAux]['total'] += floatval($invoiceIv['iva']);
                                }
                            }
                        }

                        $particularDEF[8]+= floatval($elem['totalIva']);
                        $particularDEF[9]+= floatval($facturacionTotalParticularDEF);
                        $particularDEF[10]+= floatval($elem['paid']);
                        $particularDEF[11]+= floatval($elem['pending']);
                        if($grossMarginParticularDEF != null && $grossMarginParticularDEF != ''){
                            $particularDEF[12]+= $grossMarginParticularDEF;
                            $numGrossMarginParticularDEF++;
                        }

                        if($elem['paymentDate'] != null && $elem['paymentDate'] != 0){
                            $datefrom = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['creationDate']));
                            $dateto = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['paymentDate']));
                            $interval = $datefrom->diff($dateto);
                            $week_total = $interval->format('%a');
                            $particularDEF[13]+= $week_total;
                            $numPaymentParticularDEF++;
                        }

                        $particularDEF[15]+= intval($elem['totalInvoicesPaid']);

                    }else if($elem['type'] == 1 && $elem['clientType'] == 3){ //DEFUNCIÓN EMPRESAS
                        $empresaDEF[2]++;
                        $empresaDEF[3]+= floatval($elem['bi']);
                        $empresaDEF[4]+= floatval($suplidosEmpresaDEF);
                        $empresaDEF[5]+= floatval($facturacionEmpresaDEF); 

                        // Get invoice ivas
                        $resultInvoiceIvas = $db->query("   SELECT      iniv.typeIva, iniv.iva
                                                            FROM        Invoices_Ivas iniv, Invoices i
                                                            WHERE       i.leavingDate IS NULL AND
                                                                        i.invoice_type != 3 AND
                                                                        (
                                                                            (
                                                                                i.ID = (
                                                                                    SELECT  MAX(i2.ID)
                                                                                    FROM    Invoices i2
                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                            i2.invoice_type != 3 AND
                                                                                            i2.expedient = i.expedient AND 
                                                                                            (
                                                                                                i2.rectified_type IS NULL OR 
                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                            )
                                                                                )
                                                                            ) OR
                                                                            (
                                                                                i.rectified_type = 2
                                                                            )
                                                                        ) AND
                                                                        i.expedient = $expedientID AND
                                                                        iniv.invoice = i.ID AND
                                                                        iniv.deleteDate IS NULL
                        ");
                        if(mysqli_num_rows($resultInvoiceIvas) > 0){
                            $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                            foreach($invoiceIvas as $invoiceIv){
                                $keys = array_column($empresaDEF[7], 'percentage');
                                $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                if($indexAux !== false) {
                                    $empresaDEF[7][$indexAux]['total'] += floatval($invoiceIv['iva']);
                                }
                            }
                        }

                        $empresaDEF[8]+= floatval($elem['totalIva']);
                        $empresaDEF[9]+= floatval($facturacionTotalEmpresaDEF);
                        $empresaDEF[10]+= floatval($elem['paid']);
                        $empresaDEF[11]+= floatval($elem['pending']);
                        if($grossMarginEmpresaDEF != null && $grossMarginEmpresaDEF != ''){
                            $empresaDEF[12]+= (floatval($grossMarginEmpresaDEF));
                            $numGrossMarginEmpresaDEF++;
                        }

                        if($elem['paymentDate'] != null && $elem['paymentDate'] != 0){
                            $datefrom = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['creationDate']));
                            $dateto = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['paymentDate']));
                            $interval = $datefrom->diff($dateto);
                            $week_total = $interval->format('%a');
                            $empresaDEF[13]+= $week_total;
                            $numPaymentEmpresaDEF++;
                        }

                        $empresaDEF[15]+= intval($elem['totalInvoicesPaid']);
                    }else if($elem['type'] == 1 && $elem['clientType'] == 2){ //DEFUNCIÓN SEGUROS
                        $seguroDEF[2]++;
                        $seguroDEF[3]+= floatval($elem['bi']);
                        $seguroDEF[4]+= floatval($suplidosSeguroDEF);
                        $seguroDEF[5]+= floatval($facturacionSeguroDEF); 

                        // Get invoice ivas
                       $resultInvoiceIvas = $db->query("   SELECT      iniv.typeIva, iniv.iva
                                                            FROM        Invoices_Ivas iniv, Invoices i
                                                            WHERE       i.leavingDate IS NULL AND
                                                                        i.invoice_type != 3 AND
                                                                        (
                                                                            (
                                                                                i.ID = (
                                                                                    SELECT  MAX(i2.ID)
                                                                                    FROM    Invoices i2
                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                            i2.invoice_type != 3 AND
                                                                                            i2.expedient = i.expedient AND 
                                                                                            (
                                                                                                i2.rectified_type IS NULL OR 
                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                            )
                                                                                )
                                                                            ) OR
                                                                            (
                                                                                i.rectified_type = 2
                                                                            )
                                                                        ) AND
                                                                        i.expedient = $expedientID AND
                                                                        iniv.invoice = i.ID AND
                                                                        iniv.deleteDate IS NULL
                        ");
                        if(mysqli_num_rows($resultInvoiceIvas) > 0){
                            $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                            foreach($invoiceIvas as $invoiceIv){
                                $keys = array_column($seguroDEF[7], 'percentage');
                                $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                if($indexAux !== false) {
                                    $seguroDEF[7][$indexAux]['total'] += floatval($invoiceIv['iva']);
                                }
                            }
                        }

                        $seguroDEF[8]+= floatval($elem['totalIva']);
                        $seguroDEF[9]+= floatval($facturacionTotalSeguroDEF);
                        $seguroDEF[10]+= floatval($elem['paid']);
                        $seguroDEF[11]+= floatval($elem['pending']);
                        if($grossMarginSeguroDEF != null && $grossMarginSeguroDEF != ''){
                            $seguroDEF[12]+= (floatval($grossMarginSeguroDEF));
                            $numGrossMarginSeguroDEF++;
                        }

                        if($elem['paymentDate'] != null && $elem['paymentDate'] != 0){
                            $datefrom = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['creationDate']));
                            $dateto = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['paymentDate']));
                            $interval = $datefrom->diff($dateto);
                            $week_total = $interval->format('%a');
                            $seguroDEF[13]+= $week_total;
                            $numPaymentSeguroDEF++;
                        }

                        $seguroDEF[15]+= intval($elem['totalInvoicesPaid']);
                    }else if($elem['type'] == 3 && $elem['clientType'] == 1){  //VARIOS PARTICULARES
                        $particularVAR[2]++; //Num Defunciones 
                        $particularVAR[3]+= floatval($elem['bi']);
                        $particularVAR[4]+= floatval($suplidosParticularVAR);
                        $particularVAR[5]+= floatval($facturacionParticularVAR); 

                        // Get invoice ivas
                        $resultInvoiceIvas = $db->query("   SELECT      iniv.typeIva, iniv.iva
                                                            FROM        Invoices_Ivas iniv, Invoices i
                                                            WHERE       i.leavingDate IS NULL AND
                                                                        i.invoice_type != 3 AND
                                                                        (
                                                                            (
                                                                                i.ID = (
                                                                                    SELECT  MAX(i2.ID)
                                                                                    FROM    Invoices i2
                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                            i2.invoice_type != 3 AND
                                                                                            i2.expedient = i.expedient AND 
                                                                                            (
                                                                                                i2.rectified_type IS NULL OR 
                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                            )
                                                                                )
                                                                            ) OR
                                                                            (
                                                                                i.rectified_type = 2
                                                                            )
                                                                        ) AND
                                                                        i.expedient = $expedientID AND
                                                                        iniv.invoice = i.ID AND
                                                                        iniv.deleteDate IS NULL
                        ");
                        if(mysqli_num_rows($resultInvoiceIvas) > 0){
                            $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                            foreach($invoiceIvas as $invoiceIv){
                                $keys = array_column($particularVAR[7], 'percentage');
                                $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                if($indexAux !== false) {
                                    $particularVAR[7][$indexAux]['total'] += floatval($invoiceIv['iva']);
                                }
                            }
                        }

                        $particularVAR[8]+= floatval($elem['totalIva']);
                        $particularVAR[9]+= floatval($facturacionTotalParticularVAR);
                        $particularVAR[10]+= floatval($elem['paid']);
                        $particularVAR[11]+= floatval($elem['pending']);
                        if($grossMarginParticularVAR != null && $grossMarginParticularVAR != ''){
                            $particularVAR[12]+= (floatval($grossMarginParticularVAR));
                            $numGrossMarginParticularVAR ++;
                        }
                        if($elem['paymentDate'] != null && $elem['paymentDate'] != 0){
                            $datefrom = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['creationDate']));
                            $dateto = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['paymentDate']));
                            $interval = $datefrom->diff($dateto);
                            $week_total = $interval->format('%a');
                            $particularVAR[13]+= $week_total;
                            $numPaymentParticularVAR++;
                        }

                        $particularVAR[15]+= intval($elem['totalInvoicesPaid']);
                    }else if($elem['type'] == 3 && $elem['clientType'] == 3){ //VARIOS EMPRESAS
                        $empresaVAR[2]++;
                        $empresaVAR[3]+= floatval($elem['bi']);
                        $empresaVAR[4]+= floatval($suplidosEmpresaVAR); 
                        $empresaVAR[5]+= floatval($facturacionEmpresaVAR); 

                        // Get invoice ivas
                        $resultInvoiceIvas = $db->query("   SELECT      iniv.typeIva, iniv.iva
                                                            FROM        Invoices_Ivas iniv, Invoices i
                                                            WHERE       i.leavingDate IS NULL AND
                                                                        i.invoice_type != 3 AND
                                                                        (
                                                                            (
                                                                                i.ID = (
                                                                                    SELECT  MAX(i2.ID)
                                                                                    FROM    Invoices i2
                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                            i2.invoice_type != 3 AND
                                                                                            i2.expedient = i.expedient AND 
                                                                                            (
                                                                                                i2.rectified_type IS NULL OR 
                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                            )
                                                                                )
                                                                            ) OR
                                                                            (
                                                                                i.rectified_type = 2
                                                                            )
                                                                        ) AND
                                                                        i.expedient = $expedientID AND
                                                                        iniv.invoice = i.ID AND
                                                                        iniv.deleteDate IS NULL
                        ");
                        if(mysqli_num_rows($resultInvoiceIvas) > 0){
                            $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                            foreach($invoiceIvas as $invoiceIv){
                                $keys = array_column($empresaVAR[7], 'percentage');
                                $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                if($indexAux !== false) {
                                    $empresaVAR[7][$indexAux]['total'] += floatval($invoiceIv['iva']);
                                }
                            }
                        }

                        $empresaVAR[8]+= floatval($elem['totalIva']);
                        $empresaVAR[9]+= floatval($facturacionTotalEmpresaVAR);
                        $empresaVAR[10]+= floatval($elem['paid']);
                        $empresaVAR[11]+= floatval($elem['pending']);
                        if($grossMarginEmpresaVAR != null && $grossMarginEmpresaVAR != ''){
                            $empresaVAR[12]+= (floatval($grossMarginEmpresaVAR));
                            $numGrossMarginEmpresaVAR++;
                        }
                        if($elem['paymentDate'] != null && $elem['paymentDate'] != 0){
                            $datefrom = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['creationDate']));
                            $dateto = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['paymentDate']));
                            $interval = $datefrom->diff($dateto);
                            $week_total = $interval->format('%a');
                            $empresaVAR[13]+= $week_total;
                            $numPaymentEmpresaVAR++;
                        }

                        $empresaVAR[15]+= intval($elem['totalInvoicesPaid']);
                    }else if($elem['type'] == 3 && $elem['clientType'] == 2){ //VARIOS SEGUROS
                        $seguroVAR[2]++;
                        $seguroVAR[3]+= floatval($elem['bi']);
                        $seguroVAR[4]+= floatval($suplidosSeguroVAR); 
                        $seguroVAR[5]+= floatval($facturacionSeguroVAR); 

                        // Get invoice ivas
                        $resultInvoiceIvas = $db->query("   SELECT      iniv.typeIva, iniv.iva
                                                            FROM        Invoices_Ivas iniv, Invoices i
                                                            WHERE       i.leavingDate IS NULL AND
                                                                        i.invoice_type != 3 AND
                                                                        (
                                                                            (
                                                                                i.ID = (
                                                                                    SELECT  MAX(i2.ID)
                                                                                    FROM    Invoices i2
                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                            i2.invoice_type != 3 AND
                                                                                            i2.expedient = i.expedient AND 
                                                                                            (
                                                                                                i2.rectified_type IS NULL OR 
                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                            )
                                                                                )
                                                                            ) OR
                                                                            (
                                                                                i.rectified_type = 2
                                                                            )
                                                                        ) AND
                                                                        i.expedient = $expedientID AND
                                                                        iniv.invoice = i.ID AND
                                                                        iniv.deleteDate IS NULL
                        ");
                        if(mysqli_num_rows($resultInvoiceIvas) > 0){
                            $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                            foreach($invoiceIvas as $invoiceIv){
                                $keys = array_column($seguroVAR[7], 'percentage');
                                $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                if($indexAux !== false) {
                                    $seguroVAR[7][$indexAux]['total'] += floatval($invoiceIv['iva']);
                                }
                            }
                        }

                        $seguroVAR[8]+= floatval($elem['totalIva']);
                        $seguroVAR[9]+= floatval($facturacionTotalSeguroVAR);
                        $seguroVAR[10]+= floatval($elem['paid']);
                        $seguroVAR[11]+= floatval($elem['pending']);
                        if($grossMarginSeguroVAR != null && $grossMarginSeguroVAR != ''){
                            $seguroVAR[12]+= (floatval($grossMarginSeguroVAR));
                            $numGrossMarginSeguroVAR++;
                        }

                        if($elem['paymentDate'] != null && $elem['paymentDate'] != 0){
                            $datefrom = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['creationDate']));
                            $dateto = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['paymentDate']));
                            $interval = $datefrom->diff($dateto);
                            $week_total = $interval->format('%a');
                            $seguroVAR[13]+= $week_total;
                            $numPaymentSeguroVAR++;
                        }

                        $seguroVAR[15]+= intval($elem['totalInvoicesPaid']);
                    }
                }

                if($particularDEF[12] > 0){
                    $particularDEF[14] = floatval($particularDEF[12]/$particularDEF[3]) * 100;
                }
                if($particularDEF[15] > 0){
                    $particularDEF[13] = floatval($particularDEF[13]/$particularDEF[15]);
                }

                if($empresaDEF[12] > 0){
                    $empresaDEF[14] = floatval($empresaDEF[12]/$empresaDEF[3]) * 100;
                }
                if($empresaDEF[15] > 0){
                    $empresaDEF[13] = floatval($empresaDEF[13]/$empresaDEF[15]);
                }

                if($seguroDEF[12] > 0){
                    $seguroDEF[14] = floatval($seguroDEF[12]/$seguroDEF[3]) * 100;
                }
                if($seguroDEF[15] > 0){
                    $seguroDEF[13] = floatval($seguroDEF[13]/$seguroDEF[15]);
                }

                if($particularVAR[12] > 0){
                    $particularVAR[14] = floatval($particularVAR[12]/$particularVAR[3]) * 100;
                }
                if($particularVAR[15] > 0){
                    $particularVAR[13] = floatval($particularVAR[13]/$particularVAR[15]);
                }

                if($empresaVAR[12] > 0){
                    $empresaVAR[14] = floatval($empresaVAR[12]/$empresaVAR[3]) * 100;
                }
                if($empresaVAR[15] > 0){
                    $empresaVAR[13] = floatval($empresaVAR[13]/$empresaVAR[15]);
                }

                if($seguroVAR[12] > 0){
                    $seguroVAR[14] = floatval($seguroVAR[12]/$seguroVAR[3]) * 100;
                }
                if($seguroVAR[15] > 0){
                    $seguroVAR[13] = floatval($seguroVAR[13]/$seguroVAR[15]);
                }

                if($clientType != ''){
                    if($showParticular && $showEmpresa && $showSeguro){ //000
                        array_push($resultTanatorio, $particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR);
                    }else if($showParticular && $showEmpresa && !$showSeguro){ //001
                        array_push($resultTanatorio, $particularDEF, $empresaDEF, $particularVAR, $empresaVAR);
                    }else if($showParticular && !$showEmpresa && $showSeguro){ //010
                        array_push($resultTanatorio, $particularDEF, $seguroDEF, $particularVAR, $seguroVAR);
                    }else if($showParticular && !$showEmpresa && !$showSeguro){ //011
                        array_push($resultTanatorio, $particularDEF, $particularVAR);
                    }else if(!$showParticular && $showEmpresa && $showSeguro){ //100
                        array_push($resultTanatorio, $empresaDEF, $seguroDEF, $empresaVAR, $seguroVAR);
                    }else if(!$showParticular && $showEmpresa && !$showSeguro){ //101
                        array_push($resultTanatorio, $empresaDEF, $empresaVAR);
                    }else if(!$showParticular && !$showEmpresa && $showSeguro){ //110
                        array_push($resultTanatorio, $seguroDEF, $seguroVAR);
                    }
                }else{
                    array_push($resultTanatorio, $particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR);
                }
            }else{
                $particularDEF = array(1,'Particulares - Defunción',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'PD','');
                $empresaDEF = array(2,'Empresas - Defunción',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'ED','');
                $seguroDEF = array(3,'Seguros - Defunción',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'SD','');
                $particularVAR = array(4,'Particulares - Varios',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'PV','');
                $empresaVAR = array(5,'Empresas - Varios',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'EV','');
                $seguroVAR = array(6,'Seguros - Varios',0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'SV','');

                if($clientType != ''){
                    if($showParticular && $showEmpresa && $showSeguro){ //000
                        array_push($resultTanatorio, $particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR);
                    }else if($showParticular && $showEmpresa && !$showSeguro){ //001
                        array_push($resultTanatorio, $particularDEF, $empresaDEF, $particularVAR, $empresaVAR);
                    }else if($showParticular && !$showEmpresa && $showSeguro){ //010
                        array_push($resultTanatorio, $particularDEF, $seguroDEF, $particularVAR, $seguroVAR);
                    }else if($showParticular && !$showEmpresa && !$showSeguro){ //011
                        array_push($resultTanatorio, $particularDEF, $particularVAR);
                    }else if(!$showParticular && $showEmpresa && $showSeguro){ //100
                        array_push($resultTanatorio, $empresaDEF, $seguroDEF, $empresaVAR, $seguroVAR);
                    }else if(!$showParticular && $showEmpresa && !$showSeguro){ //101
                        array_push($resultTanatorio, $empresaDEF, $empresaVAR);
                    }else if(!$showParticular && !$showEmpresa && $showSeguro){ //110
                        array_push($resultTanatorio, $seguroDEF, $seguroVAR);
                    }
                }else{
                    array_push($resultTanatorio, $particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR);
                }
            }

            if($client != ''){
                foreach($client as $elemClient){
                    $whereAux = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereAux .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereAux .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
                    }

                    if($clientType != ''){
                        $whereAux .= ' AND e.clientType IN (';
                        foreach($clientType as $elem){
                            $elem = cleanStr($elem);
                            $whereAux .= $elem . ',';
                        }
                        $whereAux = substr($whereAux, 0, -1);
                        $whereAux .= ')';
                    }
                    
                    $whereAux .= " AND c.clientID =  $elemClient";
                    $clientResult = $this->getControlPanelSummaryClientOthers($whereAux, $elemClient, 1);
                    array_push($resultTanatorio, $clientResult);
                    $clientResult = $this->getControlPanelSummaryClientOthers($whereAux, $elemClient, 3);
                    array_push($resultTanatorio, $clientResult);
                }
            }
            array_push($resultFinal, [$ccID, $costName, $resultTanatorio]);
            return $resultFinal;
        }

        /**
         * Obtiene los datos del resumen de facturación para el cuadro de mando
         * 
         * @param int $date Fecha
         * @param int $dateSince Fecha desde
         * @param int $dateUntil Fecha hasta
         * @param int $mortuary Centro de coste
         * @param int $clientType Tipos de cliente
         * @param int $client Clientes
         * @return array
         */
        public function getControlPanelSummaryClient($where, $whereCC, $clientID, $expedientType){
            $db = new DbHandler;

            if($expedientType == 1){
                $name = ' - Defunción';
            }else{
                $name = ' - Varios';
            }

            // Get iva types
            $ivaTypes = [];
            $result = $db->query("  SELECT      it.percentage,
                                                0 as total
                                    FROM        IVA_Types it
                                    WHERE       it.leavingDate IS NULL AND
                                                (it.type IS NULL OR it.type = 1)
                                    ORDER BY    it.percentage ASC 
            ");
            if(mysqli_num_rows($result) > 0){
                $ivaTypes = $db->resultToArray($result);
            }

            $resultC = $db->query(" SELECT  CONCAT(c.name, ' ', c.surname, '$name') as nameP, c.brandName as nameE
                                    FROM    Clients c
                                    WHERE   c.clientID = $clientID");

            $client = $db->resultToArray($resultC);

            $result = $db->query("  SELECT      e.expedientID, 
                                                YEAR(e.requestDate) AS year, 
                                                e.requestDate, 
                                                e.type, 
                                                e.clientType as clientType, 
                                                CONCAT(c.name, ' ', c.surname) as nameP, 
                                                c.brandName as nameE,
                                                c.clientID, 
                                                c.name, 
                                                c.surname, 
                                                c.price,
                                                (
                                                    (
                                                        SELECT      COALESCE(SUM(iniv.base), 0)
                                                        FROM        Invoices i
                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as bi,
                                                (
                                                    (
                                                        SELECT      COALESCE(SUM(i.supplieds), 0)
                                                        FROM        Invoices i
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as su,
                                                (
                                                    (
                                                        SELECT      COALESCE(SUM(iniv.base), 0)
                                                        FROM        Invoices i
                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as fact,
                                                '' as iva1, 
                                                '' as iva2, 
                                                (
                                                    (
                                                        SELECT      COALESCE(SUM(iniv.iva), 0)
                                                        FROM        Invoices i
                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as totalIva,
                                               (
                                                    (
                                                        SELECT      COALESCE(SUM(i.total), 0)
                                                        FROM        Invoices i
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as factTotal,
                                                (
                                                    (
                                                        SELECT      COALESCE(SUM(ip.amount), 0)
                                                        FROM        Invoices i
                                                        JOIN        Invoices_Payments ip ON ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as paid,
                                                (
                                                    (
                                                        (
                                                            (
                                                                SELECT      COALESCE(SUM(i.total), 0)
                                                                FROM        Invoices i
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = e.expedientID
                                                            )
                                                        )
                                                    )
                                                    -
                                                    (
                                                        (
                                                            (
                                                                SELECT      COALESCE(SUM(ip.amount), 0)
                                                                FROM        Invoices i
                                                                JOIN        Invoices_Payments ip ON ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = e.expedientID
                                                            )
                                                        )
                                                    )
                                                ) as pending,
                                                (
                                                    SELECT      COALESCE(SUM(i.paymentDate), 0)
                                                    FROM        Invoices i
                                                    WHERE       i.leavingDate IS NULL AND 
                                                                i.invoice_type != 3 AND
                                                                i.expedient = e.expedientID AND 
                                                                (
                                                                    SELECT  COUNT(*)
                                                                    FROM    Invoices_Payments ip
                                                                    WHERE   ip.leavingDate IS NULL AND
                                                                            ip.invoice = i.ID
                                                                ) > 0
                                                ) as paymentDate,
                                                (
                                                    SELECT      COALESCE(SUM(i.creationDate), 0)
                                                    FROM        Invoices i
                                                    WHERE       i.leavingDate IS NULL AND 
                                                                i.invoice_type != 3 AND
                                                                i.expedient = e.expedientID AND 
                                                                (
                                                                    SELECT  COUNT(*)
                                                                    FROM    Invoices_Payments ip
                                                                    WHERE   ip.leavingDate IS NULL AND
                                                                            ip.invoice = i.ID
                                                                ) > 0
                                                ) as creationDate,
                                                '' as invoiceID,
                                                (
                                                    SELECT      COUNT(*)
                                                    FROM        Invoices i
                                                    WHERE       i.leavingDate IS NULL AND 
                                                                i.invoice_type != 3 AND
                                                                i.expedient = e.expedientID AND 
                                                                (
                                                                    SELECT  COUNT(*)
                                                                    FROM    Invoices_Payments ip
                                                                    WHERE   ip.leavingDate IS NULL AND
                                                                            ip.invoice = i.ID
                                                                ) > 0
                                                ) as totalInvoicesPaid
                                    FROM        Expedients e, Clients c, Cost_Center cc
                                    WHERE       e.client = c.clientID AND
                                                e.leavingDate IS NULL AND
                                                e.deceasedMortuary = cc.mortuary AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0 AND
                                                e.type = $expedientType
                                                $where
                                                $whereCC
                                    ORDER BY    c.clientID");

                $exps = $db->resultToArray($result);

                if($client[0]['nameP'] == '' || $client[0]['nameP'] == null){
                    $userName = $client[0]['nameE'];
                }else{
                    $userName = $client[0]['nameP'];
                }

                $clientResult = array('-',$userName,0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'OTROS', $clientID);

                //var aux
                $numGrossMarginParticularDEF = 0;
                $numPaymentParticularDEF = 0;
                foreach($exps as $index => $elem){

                    // Tarifa para el año y el cliente del expediente
                    $purchasePriceParticularDEF = 0;
                    $priceNoIVAParticularDEF = 0;
                    $grossMarginParticularDEF = 0;

                    $result = $db->query("  SELECT  p.name
                                            FROM    Prices p
                                            WHERE   p.priceID = {$elem['price']}");

                    if(mysqli_num_rows($result) == 0){
                        continue;
                    }else{
                        $priceName = $db->resultToArray($result)[0]['name'];

                        $result = $db->query("  SELECT  p.priceID
                                                FROM    Prices p
                                                WHERE   p.name LIKE '%$priceName%' AND
                                                        p.leavingDate IS NULL AND
                                                        p.year = {$elem['year']}");

                        if(mysqli_num_rows($result) == 0){
                            continue;
                        }else{

                            $price = $db->resultToArray($result)[0]['priceID'];
                            $result = $db->query("  SELECT  SUM(pr.purchasePrice) as purchasePrice, 
                                                            SUM(pp.priceNoIVA - (pp.priceNoIVA * eh.discount/100)) as priceNoIVA, 
                                                            eh.model
                                                    FROM    Expedients_Hirings eh, Products_Retails pr, Products_Prices pp, Prices p
                                                    WHERE   eh.expedient = {$elem['expedientID']} AND
                                                            eh.check = 1 AND
                                                            eh.num_hiring = (
                                                                SELECT  MAX(i2.num_hiring) 
                                                                FROM    Invoices i2 
                                                                WHERE   i2.expedient = {$elem['expedientID']} AND
                                                                        i2.leavingDate IS NULL AND
                                                                        i2.invoice_type != 3
                                                            ) AND
                                                            p.year = {$elem['year']} AND
                                                            pr.model = eh.model AND
                                                            pr.year = {$elem['year']} AND
                                                            pp.model = eh.model AND
                                                            pp.price = $price AND 
                                                            p.priceID = pp.price AND 
                                                            p.leavingDate IS NULL");
                            if(mysqli_num_rows($result) > 0){
                                $prices = $db->resultToArray($result);
                                foreach($prices as $price){
                                    $purchasePriceParticularDEF = floatval($price['purchasePrice']);
                                    $priceNoIVAParticularDEF = floatval($price['priceNoIVA']);
                                    $grossMarginParticularDEF = (floatval($priceNoIVAParticularDEF) - floatval($purchasePriceParticularDEF));
                                }
                            }
                        }
                    }
                    
                    //Suplidos
                    $suplidosParticularDEF = 0;
                    $facturacionParticularDEF = 0;
                    $facturacionTotalParticularDEF = 0;
                   
                    $expedientID = $elem['expedientID'];

                    $result = $db->query("  SELECT      SUM(eh.total) as cost
                                            FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                            LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                            WHERE       eh.expedient = $expedientID AND 
                                                        eh.num_hiring = (
                                                            SELECT  MAX(i2.num_hiring) 
                                                            FROM    Invoices i2 
                                                            WHERE   i2.expedient = e.expedientID AND
                                                                    i2.leavingDate IS NULL AND
                                                                    i2.invoice_type != 3
                                                        ) AND
                                                        eh.check = 1 AND 
                                                        eh.expedient = e.expedientID AND
                                                        eh.model = pm.productModelID AND
                                                        eh.product = pr.productID AND
                                                        pr.IVA = it.IVATypeID AND
                                                        pr.leavingDate IS NULL AND
                                                        pr.supplied = 1 AND
                                                        pr.isInvoiced = 0");
                    if(mysqli_num_rows($result) > 0){
                        $supplieds = $db->resultToArray($result)[0]['cost']; 
                        $suplidosParticularDEF = $supplieds;
                        $facturacionParticularDEF =  floatval($elem['fact']) + floatval($supplieds);
                        $facturacionTotalParticularDEF = floatval($elem['factTotal']) + floatval($supplieds);
                    } 

                    $clientResult[2]++;
                    $clientResult[3]+= floatval($elem['bi']);
                    $clientResult[4]+= floatval($suplidosParticularDEF);
                    $clientResult[5]+= floatval($facturacionParticularDEF); 

                    // Get invoice ivas
                    $resultInvoiceIvas = $db->query("   SELECT      iniv.typeIva, iniv.iva
                                                        FROM        Invoices_Ivas iniv, Invoices i
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = $expedientID AND
                                                                    iniv.invoice = i.ID AND
                                                                    iniv.deleteDate IS NULL
                    ");
                    if(mysqli_num_rows($resultInvoiceIvas) > 0){
                        $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                        foreach($invoiceIvas as $invoiceIv){
                            $keys = array_column($clientResult[7], 'percentage');
                            $indexAux = array_search($invoiceIv['typeIva'], $keys);

                            if($indexAux !== false) {
                                $clientResult[7][$indexAux]['total'] += floatval($invoiceIv['iva']);
                            }
                        }
                    }
                    
                    $clientResult[8]+= floatval($elem['totalIva']);
                    $clientResult[9]+= floatval($facturacionTotalParticularDEF);
                    $clientResult[10]+= floatval($elem['paid']);
                    $clientResult[11]+= floatval($elem['pending']);
                    if($grossMarginParticularDEF != null && $grossMarginParticularDEF != ''){
                        $clientResult[12]+= $grossMarginParticularDEF;
                        $numGrossMarginParticularDEF++;
                    }

                    if($elem['paymentDate'] != null && $elem['paymentDate'] != 0){
                        $datefrom = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['creationDate']));
                        $dateto = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['paymentDate']));
                        $interval = $datefrom->diff($dateto);
                        $week_total = $interval->format('%a');
                        $clientResult[13]+= $week_total;
                        $numPaymentParticularDEF++;
                    }

                    $clientResult[15]+= intval($elem['totalInvoicesPaid']); 
                }

                if($clientResult[12] > 0){
                    $clientResult[14] = floatval($clientResult[12]/$clientResult[3]) * 100;
                }
                if($clientResult[15] > 0){
                    $clientResult[13] = floatval($clientResult[13]/$clientResult[15]);
                }

            return $clientResult;
        }

        /**
         * Obtiene los datos del resumen de facturación para el cuadro de mando
         * 
         * @param int $date Fecha
         * @param int $dateSince Fecha desde
         * @param int $dateUntil Fecha hasta
         * @param int $mortuary Centro de coste
         * @param int $clientType Tipos de cliente
         * @param int $client Clientes
         * @return array
         */
        public function getControlPanelSummaryClientOthers($where, $clientID, $expedientType){
            $db = new DbHandler;

            if($expedientType == 1){
                $name = ' - Defunción';
            }else{
                $name = ' - Varios';
            }

            // Get iva types
            $ivaTypes = [];
            $result = $db->query("  SELECT      it.percentage,
                                                0 as total
                                    FROM        IVA_Types it
                                    WHERE       it.leavingDate IS NULL AND
                                                (it.type IS NULL OR it.type = 1)
                                    ORDER BY    it.percentage ASC 
            ");
            if(mysqli_num_rows($result) > 0){
                $ivaTypes = $db->resultToArray($result);
            }

            $resultC = $db->query(" SELECT      CONCAT(c.name, ' ', c.surname, '$name') as nameP, c.brandName as nameE
                                    FROM        Clients c
                                    WHERE       c.clientID = $clientID");

            $client = $db->resultToArray($resultC);

            $result = $db->query("  SELECT      e.expedientID, 
                                                YEAR(e.requestDate) AS year, 
                                                e.requestDate, 
                                                e.type, 
                                                e.clientType as clientType, 
                                                CONCAT(c.name, ' ', c.surname) as nameP, 
                                                c.brandName as nameE,
                                                c.clientID, 
                                                c.name, 
                                                c.surname, 
                                                c.price,
                                                (
                                                    (
                                                        SELECT      COALESCE(SUM(iniv.base), 0)
                                                        FROM        Invoices i
                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as bi,
                                                (
                                                    (
                                                        SELECT      COALESCE(SUM(i.supplieds), 0)
                                                        FROM        Invoices i
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as su,
                                                (
                                                    (
                                                        SELECT      COALESCE(SUM(iniv.base), 0)
                                                        FROM        Invoices i
                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as fact,
                                                '' as iva1, 
                                                '' as iva2, 
                                                (
                                                    (
                                                        SELECT      COALESCE(SUM(iniv.iva), 0)
                                                        FROM        Invoices i
                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as totalIva,
                                               (
                                                    (
                                                        SELECT      COALESCE(SUM(i.total), 0)
                                                        FROM        Invoices i
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as factTotal,
                                                (
                                                    (
                                                        SELECT      COALESCE(SUM(ip.amount), 0)
                                                        FROM        Invoices i
                                                        JOIN        Invoices_Payments ip ON ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = e.expedientID
                                                    )
                                                ) as paid,
                                                (
                                                    (
                                                        (
                                                            (
                                                                SELECT      COALESCE(SUM(i.total), 0)
                                                                FROM        Invoices i
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = e.expedientID
                                                            )
                                                        )
                                                    )
                                                    -
                                                    (
                                                        (
                                                            (
                                                                SELECT      COALESCE(SUM(ip.amount), 0)
                                                                FROM        Invoices i
                                                                JOIN        Invoices_Payments ip ON ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = e.expedientID
                                                            )
                                                        )
                                                    )
                                                ) as pending,
                                                (
                                                    SELECT      COALESCE(SUM(i.paymentDate), 0)
                                                    FROM        Invoices i
                                                    WHERE       i.leavingDate IS NULL AND 
                                                                i.invoice_type != 3 AND
                                                                i.expedient = e.expedientID AND 
                                                                (
                                                                    SELECT  COUNT(*)
                                                                    FROM    Invoices_Payments ip
                                                                    WHERE   ip.leavingDate IS NULL AND
                                                                            ip.invoice = i.ID
                                                                ) > 0
                                                ) as paymentDate,
                                                (
                                                    SELECT      COALESCE(SUM(i.creationDate), 0)
                                                    FROM        Invoices i
                                                    WHERE       i.leavingDate IS NULL AND 
                                                                i.invoice_type != 3 AND
                                                                i.expedient = e.expedientID AND 
                                                                (
                                                                    SELECT  COUNT(*)
                                                                    FROM    Invoices_Payments ip
                                                                    WHERE   ip.leavingDate IS NULL AND
                                                                            ip.invoice = i.ID
                                                                ) > 0
                                                ) as creationDate,
                                                (
                                                    SELECT      COUNT(*)
                                                    FROM        Invoices i
                                                    WHERE       i.leavingDate IS NULL AND 
                                                                i.invoice_type != 3 AND
                                                                i.expedient = e.expedientID AND 
                                                                (
                                                                    SELECT  COUNT(*)
                                                                    FROM    Invoices_Payments ip
                                                                    WHERE   ip.leavingDate IS NULL AND
                                                                            ip.invoice = i.ID
                                                                ) > 0
                                                ) as totalInvoicesPaid,
                                                '' as invoiceID
                                    FROM        (Expedients e, Clients c)
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    WHERE       e.client = c.clientID AND
                                                e.leavingDate IS NULL AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0 AND
                                                (SELECT COUNT(*) FROM Cost_Center cc WHERE cc.mortuary = m.mortuaryID) = 0 AND
                                                e.type = $expedientType
                                                $where
                                    ORDER BY    c.clientID");


                $exps = $db->resultToArray($result);

                if($client[0]['nameP'] == '' || $client[0]['nameP'] == null){
                    $userName = $client[0]['nameE'];
                }else{
                    $userName = $client[0]['nameP'];
                }

                $clientResult = array('-',$userName,0,0,0,0,null,$ivaTypes,0,0,0,0,0,0,0,0,'OTROS', $clientID);

                //var aux
                $numGrossMarginParticularDEF = 0;
                $numPaymentParticularDEF = 0;
                foreach($exps as $index => $elem){

                    // Tarifa para el año y el cliente del expediente
                    $purchasePriceParticularDEF = 0;
                    $priceNoIVAParticularDEF = 0;
                    $grossMarginParticularDEF = 0;

                    $result = $db->query("  SELECT  p.name
                                            FROM    Prices p
                                            WHERE   p.priceID = {$elem['price']}");

                    if(mysqli_num_rows($result) == 0){
                        continue;
                    }else{
                        $priceName = $db->resultToArray($result)[0]['name'];

                        $result = $db->query("  SELECT  p.priceID
                                                FROM    Prices p
                                                WHERE   p.name LIKE '%$priceName%' AND
                                                        p.leavingDate IS NULL AND
                                                        p.year = {$elem['year']}");

                        if(mysqli_num_rows($result) == 0){
                            continue;
                        }else{
                            $price = $db->resultToArray($result)[0]['priceID'];
                            $result = $db->query("  SELECT  SUM(pr.purchasePrice) as purchasePrice, 
                                                            SUM(pp.priceNoIVA - (pp.priceNoIVA * eh.discount/100)) as priceNoIVA, 
                                                            eh.model
                                                    FROM    Expedients_Hirings eh, Products_Retails pr, Products_Prices pp, Prices p
                                                    WHERE   eh.expedient = {$elem['expedientID']} AND
                                                            eh.num_hiring = (
                                                                SELECT  MAX(i2.num_hiring) 
                                                                FROM    Invoices i2 
                                                                WHERE   i2.expedient = {$elem['expedientID']} AND
                                                                        i2.leavingDate IS NULL AND
                                                                        i2.invoice_type != 3
                                                            ) AND
                                                            eh.check = 1 AND
                                                            p.year = {$elem['year']} AND
                                                            pr.model = eh.model AND
                                                            pr.year = {$elem['year']} AND
                                                            pp.model = eh.model AND
                                                            pp.price = $price AND 
                                                            p.priceID = pp.price AND 
                                                            p.leavingDate IS NULL");
                            if(mysqli_num_rows($result) > 0){
                                $prices = $db->resultToArray($result);
                                foreach($prices as $price){
                                    $purchasePriceParticularDEF = floatval($price['purchasePrice']);
                                    $priceNoIVAParticularDEF = floatval($price['priceNoIVA']);
                                    $grossMarginParticularDEF = (floatval($priceNoIVAParticularDEF) - floatval($purchasePriceParticularDEF));
                                }
                            }
                        }
                    }
                    
                    //Suplidos
                    $suplidosParticularDEF = 0;
                    $facturacionParticularDEF = 0;
                    $facturacionTotalParticularDEF = 0;
                   
                    $expedientID = $elem['expedientID'];

                    $result = $db->query("  SELECT      SUM(eh.total) as cost
                                            FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                            LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                            WHERE       eh.expedient = $expedientID AND 
                                                        eh.num_hiring = (
                                                            SELECT  MAX(i2.num_hiring) 
                                                            FROM    Invoices i2 
                                                            WHERE   i2.expedient = e.expedientID AND
                                                                    i2.leavingDate IS NULL AND
                                                                    i2.invoice_type != 3
                                                        ) AND
                                                        eh.check = 1 AND 
                                                        eh.expedient = e.expedientID AND
                                                        eh.model = pm.productModelID AND
                                                        eh.product = pr.productID AND
                                                        pr.IVA = it.IVATypeID AND
                                                        pr.leavingDate IS NULL AND
                                                        pr.supplied = 1 AND
                                                        pr.isInvoiced = 0");
                    if(mysqli_num_rows($result) > 0){
                        $supplieds = $db->resultToArray($result)[0]['cost']; 
                        $suplidosParticularDEF = $supplieds;
                        $facturacionParticularDEF =  floatval($elem['fact']) + floatval($supplieds);
                        $facturacionTotalParticularDEF = floatval($elem['factTotal']);
                    } 

                    $clientResult[2]++;
                    $clientResult[3]+= floatval($elem['bi']);
                    $clientResult[4]+= floatval($suplidosParticularDEF);
                    $clientResult[5]+= floatval($facturacionParticularDEF); 

                    // Get invoice ivas
                    $resultInvoiceIvas = $db->query("   SELECT      iniv.typeIva, iniv.iva
                                                        FROM        Invoices_Ivas iniv, Invoices i
                                                        WHERE       i.leavingDate IS NULL AND
                                                                    i.invoice_type != 3 AND
                                                                    (
                                                                        (
                                                                            i.ID = (
                                                                                SELECT  MAX(i2.ID)
                                                                                FROM    Invoices i2
                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                        i2.invoice_type != 3 AND
                                                                                        i2.expedient = i.expedient AND 
                                                                                        (
                                                                                            i2.rectified_type IS NULL OR 
                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                        )
                                                                            )
                                                                        ) OR
                                                                        (
                                                                            i.rectified_type = 2
                                                                        )
                                                                    ) AND
                                                                    i.expedient = $expedientID AND
                                                                    iniv.invoice = i.ID AND
                                                                    iniv.deleteDate IS NULL
                    ");
                    if(mysqli_num_rows($resultInvoiceIvas) > 0){
                        $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                        foreach($invoiceIvas as $invoiceIv){
                            $keys = array_column($clientResult[7], 'percentage');
                            $indexAux = array_search($invoiceIv['typeIva'], $keys);

                            if($indexAux !== false) {
                                $clientResult[7][$indexAux]['total'] += floatval($invoiceIv['iva']);
                            }
                        }
                    }

                    $clientResult[8]+= floatval($elem['totalIva']);
                    $clientResult[9]+= floatval($facturacionTotalParticularDEF);
                    $clientResult[10]+= floatval($elem['paid']);
                    $clientResult[11]+= floatval($elem['pending']);
                    if($grossMarginParticularDEF != null && $grossMarginParticularDEF != ''){
                        $clientResult[12]+= $grossMarginParticularDEF;
                        $numGrossMarginParticularDEF++;
                    }

                    if($elem['paymentDate'] != null && $elem['paymentDate'] != 0){
                        $datefrom = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['creationDate']));
                        $dateto = DateTime::createFromFormat('d/m/Y H:i:s',date('d/m/Y H:i:s', $elem['paymentDate']));
                        $interval = $datefrom->diff($dateto);
                        $week_total = $interval->format('%a');
                        $clientResult[13]+= $week_total;
                        $numPaymentParticularDEF++;
                    }

                    $clientResult[15]+= floatval($elem['totalInvoicesPaid']);
                }

                if($clientResult[12] > 0){
                    $clientResult[14] = floatval($clientResult[12]/$clientResult[3]) * 100;
                }
                if($clientResult[15] > 0){
                    $clientResult[13] = floatval($clientResult[13]/$clientResult[15]);
                }

            return $clientResult;
        }

        /**
         * Obtiene los datos del resumen de facturación para el cuadro de mando
         * 
         * @param int $date Fecha
         * @param int $dateSince Fecha desde
         * @param int $dateUntil Fecha hasta
         * @param int $mortuary Centro de coste
         * @param int $clientType Tipos de cliente
         * @param int $client Clientes
         * @return array
         */
        public function getControlPanelGrafico($date, $dateSince, $dateUntil, $mortuary, $clientType, $client){
            $db = new DbHandler;

            $date = cleanStr($date);
            $dateSince = cleanStr($dateSince);
            $dateUntil = cleanStr($dateUntil);

            $where = '';
            $whereCC = '';
            if($date == ''){
                if($dateSince != '' && $dateUntil != ''){
                    $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                    
                }
            }else{
                $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
            }

            if($mortuary != ''){
                $whereCC .= " AND (";
                foreach($mortuary as $elem){
                    $elem = cleanStr($elem);
                    $whereCC .= " cc.ID = $elem OR";
                }
                $whereCC = substr($whereCC, 0, -3);
                $whereCC .= ")";
            }else{
                $whereCC .= " AND cc.mortuary != 0"; 
            }

            $showParticular = false;
            $showEmpresa = false;
            $showSeguro = false;
            if($clientType != ''){
                $where .= ' AND e.clientType IN (';
                foreach($clientType as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                    if($elem == 1){
                        $showParticular = true;
                    }
                    if($elem == 2){
                        $showSeguro = true;
                    }
                    if($elem == 3){
                        $showEmpresa = true;
                    }
                }
                $where = substr($where, 0, -1);
                $where .= ')';
            }
            
            $resultFinal = [];
            $result = $db->query("  SELECT   *
                                    FROM     Cost_Center cc
                                    WHERE    cc.leavingDate IS NULL
                                             $whereCC");

            $resultTanatorio = [];
            if(mysqli_num_rows($result) == 0){
            }else{
                $costcenters = $db->resultToArray($result);
                foreach($costcenters as $indexCC => $elem){
                    $ccID = $elem['ID'];
                    $costName = $elem['name'];

                    if($mortuary == ''){
                        $whereCC = ' AND cc.ID = ' . $ccID; 
                    }else{
                        $whereCC = '';
                    }

                    $result = $db->query("  SELECT      COUNT(*) as total, e.client
                                            FROM        Expedients e, Clients c, Cost_Center cc
                                            WHERE       e.client = c.clientID AND
                                                        e.leavingDate IS NULL AND
                                                        e.deceasedMortuary = cc.mortuary AND
                                                        (
                                                            SELECT  COUNT(*)
                                                            FROM    Invoices inv
                                                            WHERE   inv.expedient = e.expedientID AND
                                                                    inv.leavingDate IS NULL
                                                        ) > 0
                                                        $whereCC
                                                        $where
                                            ORDER BY    e.client");

                    $totalGlobal = $db->resultToArray($result)[0]['total'];

                    $whereClient = '';
                    if($client != ''){
                        $whereClient .= ' AND c.clientID NOT IN (';
                        foreach($client as $elem){
                            $elem = cleanStr($elem);
                            $whereClient .= $elem . ',';
                        }
                        $whereClient = substr($whereClient, 0, -1);
                        $whereClient .= ')';
                    }

                    $resultExp = $db->query("   SELECT      e.expedientID, e.type, e.client, e.clientType as clientType
                                                FROM        Expedients e, Clients c, Cost_Center cc
                                                WHERE       e.client = c.clientID AND
                                                            e.leavingDate IS NULL AND
                                                            e.deceasedMortuary = cc.mortuary
                                                            $whereCC
                                                            $where
                                                            $whereClient
                                                ORDER BY    e.client");

                    $countPD = 0;
                    $countED = 0;
                    $insuranceD = 0;
                    $countPV = 0;
                    $countEV = 0;
                    $insuranceV = 0;

                    $particularDEF = [];
                    $empresaDEF = [];
                    $seguroDEF = [];
                    $particularVAR = [];
                    $empresaVAR = [];
                    $seguroVAR = [];

                    if(mysqli_num_rows($resultExp) > 0){
                        $expedients = $db->resultToArray($resultExp); 

                        foreach($expedients as $index => $elemv2){
                            if($elemv2['type'] == 1 && $elemv2['clientType'] == 1){
                                $countPD++;
                            }else if($elemv2['type'] == 1 && $elemv2['clientType'] == 3){
                                $countED++;
                            }else if($elemv2['type'] == 1 && $elemv2['clientType'] == 2){
                                $insuranceD++;
                            }else if($elemv2['type'] == 3 && $elemv2['clientType'] == 1){ 
                                $countPV++;
                            }else if($elemv2['type'] == 3 && $elemv2['clientType'] == 3){
                                $countEV++;
                            }else if($elemv2['type'] == 3 && $elemv2['clientType'] == 2){
                                $insuranceV++;
                            }
                        }
                    }

                    $particularDEF['name'] = 'Particulares - Defunción';
                    if($totalGlobal > 0){
                        $percentagePD = $countPD * 100 / $totalGlobal;
                        $particularDEF['total'] = $percentagePD;
                    }else{
                        $particularDEF['total'] = 0;
                    }

                    $empresaDEF['name'] = 'Empresas - Defunción';
                    if($totalGlobal > 0){
                        $percentageED = $countED * 100 / $totalGlobal;
                        $empresaDEF['total'] = $percentageED;
                    }else{
                        $empresaDEF['total'] = 0;
                    }

                    $seguroDEF['name'] = 'Seguros - Defunción';
                    if($totalGlobal > 0){
                        $percentageInsuranceD = $insuranceD * 100 / $totalGlobal;
                        $seguroDEF['total'] = $percentageInsuranceD;
                    }else{
                        $seguroDEF['total'] = 0;
                    }

                    $particularVAR['name'] = 'Particulares - Varios';
                    if($totalGlobal > 0){
                        $percentagePV = $countPV * 100 / $totalGlobal;
                        $particularVAR['total'] = $percentagePV;
                    }else{
                        $particularVAR['total'] = 0;
                    }

                    $empresaVAR['name'] = 'Empresas - Varios';
                    if($totalGlobal > 0){
                        $percentageEV = $countEV * 100 / $totalGlobal;
                        $empresaVAR['total'] = $percentageEV;
                    }else{
                        $empresaVAR['total'] = 0;
                    }

                    $seguroVAR['name'] = 'Seguros - Varios';
                    if($totalGlobal > 0){
                        $percentageInsuranceV = $insuranceV * 100 / $totalGlobal;
                        $seguroVAR['total'] = $percentageInsuranceV;
                    }else{
                        $seguroVAR['total'] = 0;
                    }

                    if($clientType != ''){
                        if($showParticular && $showEmpresa && $showSeguro){ //000
                            array_push($resultTanatorio, [$costName, [$particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR]]);
                        }else if($showParticular && $showEmpresa && !$showSeguro){ //001
                            array_push($resultTanatorio, [$costName, [$particularDEF, $empresaDEF, $particularVAR, $empresaVAR]]);
                        }else if($showParticular && !$showEmpresa && $showSeguro){ //010
                            array_push($resultTanatorio, [$costName, [$particularDEF, $seguroDEF, $particularVAR, $seguroVAR]]);
                        }else if($showParticular && !$showEmpresa && !$showSeguro){ //011
                            array_push($resultTanatorio, [$costName, [$particularDEF, $particularVAR]]);
                        }else if(!$showParticular && $showEmpresa && $showSeguro){ //100
                            array_push($resultTanatorio, [$costName, [$empresaDEF, $seguroDEF, $empresaVAR, $seguroVAR]]);
                        }else if(!$showParticular && $showEmpresa && !$showSeguro){ //101
                            array_push($resultTanatorio, [$costName, [$empresaDEF, $empresaVAR]]);
                        }else if(!$showParticular && !$showEmpresa && $showSeguro){ //110
                            array_push($resultTanatorio, [$costName, [$seguroDEF, $seguroVAR]]);
                        }
                    }else{
                        array_push($resultTanatorio, [$costName, [$particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR]]);
                    }

                    if($client != ''){
                        foreach($client as $elemClient){
                            $whereAux = '';
                            $whereAuxCC = '';
                            if($date == ''){
                                if($dateSince != '' && $dateUntil != ''){
                                    $whereAux .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                                }
                            }else{
                                $whereAux .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
                            }

                            if($mortuary != ''){
                                $whereAuxCC .= " AND (";
                                foreach($mortuary as $elem){
                                    $elem = cleanStr($elem);
                                    $whereAuxCC .= " cc.ID = $elem OR";
                                }
                                $whereAuxCC = substr($whereAuxCC, 0, -3);
                                $whereAuxCC .= ")";
                            }else{
                                $whereAuxCC .= " AND cc.mortuary != 0"; 
                            }

                            if($clientType != ''){
                                $whereAux .= ' AND e.clientType IN (';
                                foreach($clientType as $elem){
                                    $elem = cleanStr($elem);
                                    $whereAux .= $elem . ',';
                                }
                                $whereAux = substr($whereAux, 0, -1);
                                $whereAux .= ')';
                            }

                            if($mortuary == ''){
                                $whereAuxCC = ' AND cc.ID = ' . $ccID; 
                            }else{
                                $whereAuxCC = '';
                            }
                          
                            $whereAux .= " AND c.clientID = $elemClient";

                            $clientGraff = $this->getControlPanelGraficoCliente($whereAux, $whereAuxCC, $totalGlobal,$elemClient);
                            array_push($resultTanatorio[$indexCC][1], $clientGraff);
                        }
                    }
                }
            }
     
            //OTRAS INSTALACIONES
            $ccID = 0;
            $costName = 'Otras instalaciones';

            $result = $db->query("  SELECT      COUNT(*) as total, e.client
                                    FROM        (Expedients e, Clients c)
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    WHERE       e.client = c.clientID AND
                                                e.leavingDate IS NULL AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0 AND
                                                (SELECT COUNT(*) FROM Cost_Center cc WHERE cc.mortuary = m.mortuaryID) = 0
                                                $where
                                    ORDER BY    e.client");

            $totalGlobal = $db->resultToArray($result)[0]['total'];

            $whereClient = '';
            if($client != ''){
                $whereClient .= ' AND c.clientID NOT IN (';
                foreach($client as $elem){
                    $elem = cleanStr($elem);
                    $whereClient .= $elem . ',';
                }
                $whereClient = substr($whereClient, 0, -1);
                $whereClient .= ')';
            }

            $resultExp = $db->query("   SELECT      e.expedientID, e.type, e.client, e.clientType as clientType
                                        FROM        (Expedients e, Clients c)
                                        LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                        WHERE       e.client = c.clientID AND
                                                    e.leavingDate IS NULL AND
                                                    (SELECT COUNT(*) FROM Cost_Center cc WHERE cc.mortuary = m.mortuaryID) = 0
                                                    $where
                                                    $whereClient
                                        ORDER BY    e.client");

            $countPD = 0;
            $countED = 0;
            $insuranceD = 0;
            $countPV = 0;
            $countEV = 0;
            $insuranceV = 0;

            $particularDEF = [];
            $empresaDEF = [];
            $seguroDEF = [];
            $particularVAR = [];
            $empresaVAR = [];
            $seguroVAR = [];

            if(mysqli_num_rows($resultExp) > 0){
                $expedients = $db->resultToArray($resultExp); 

                foreach($expedients as $index => $elemv2){
                    if($elemv2['type'] == 1 && $elemv2['clientType'] == 1){
                        $countPD++;
                    }else if($elemv2['type'] == 1 && $elemv2['clientType'] == 3){
                        $countED++;
                    }else if($elemv2['type'] == 1 && $elemv2['clientType'] == 2){
                        $insuranceD++;
                    }else if($elemv2['type'] == 3 && $elemv2['clientType'] == 1){ 
                        $countPV++;
                    }else if($elemv2['type'] == 3 && $elemv2['clientType'] == 3){
                        $countEV++;
                    }else if($elemv2['type'] == 3 && $elemv2['clientType'] == 2){
                        $insuranceV++;
                    }
                }
            }

            $particularDEF['name'] = 'Particulares - Defunción';
            if($totalGlobal > 0){
                $percentagePD = $countPD * 100 / $totalGlobal;
                $particularDEF['total'] = $percentagePD;
            }else{
                $particularDEF['total'] = 0;
            }

            $empresaDEF['name'] = 'Empresas - Defunción';
            if($totalGlobal > 0){
                $percentageED = $countED * 100 / $totalGlobal;
                $empresaDEF['total'] = $percentageED;
            }else{
                $empresaDEF['total'] = 0;
            }

            $seguroDEF['name'] = 'Seguros - Defunción';
            if($totalGlobal > 0){
                $percentageInsuranceD = $insuranceD * 100 / $totalGlobal;
                $seguroDEF['total'] = $percentageInsuranceD;
            }else{
                $seguroDEF['total'] = 0;
            }

            $particularVAR['name'] = 'Particulares - Varios';
            if($totalGlobal > 0){
                $percentagePV = $countPV * 100 / $totalGlobal;
                $particularVAR['total'] = $percentagePV;
            }else{
                $particularVAR['total'] = 0;
            }

            $empresaVAR['name'] = 'Empresas - Varios';
            if($totalGlobal > 0){
                $percentageEV = $countEV * 100 / $totalGlobal;
                $empresaVAR['total'] = $percentageEV;
            }else{
                $empresaVAR['total'] = 0;
            }

            $seguroVAR['name'] = 'Seguros - Varios';
            if($totalGlobal > 0){
                $percentageInsuranceV = $insuranceV * 100 / $totalGlobal;
                $seguroVAR['total'] = $percentageInsuranceV;
            }else{
                $seguroVAR['total'] = 0;
            }

            if($clientType != ''){
                if($showParticular && $showEmpresa && $showSeguro){ //000
                    array_push($resultTanatorio, [$costName, [$particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR]]);
                }else if($showParticular && $showEmpresa && !$showSeguro){ //001
                    array_push($resultTanatorio, [$costName, [$particularDEF, $empresaDEF, $particularVAR, $empresaVAR]]);
                }else if($showParticular && !$showEmpresa && $showSeguro){ //010
                    array_push($resultTanatorio, [$costName, [$particularDEF, $seguroDEF, $particularVAR, $seguroVAR]]);
                }else if($showParticular && !$showEmpresa && !$showSeguro){ //011
                    array_push($resultTanatorio, [$costName, [$particularDEF, $particularVAR]]);
                }else if(!$showParticular && $showEmpresa && $showSeguro){ //100
                    array_push($resultTanatorio, [$costName, [$empresaDEF, $seguroDEF, $empresaVAR, $seguroVAR]]);
                }else if(!$showParticular && $showEmpresa && !$showSeguro){ //101
                    array_push($resultTanatorio, [$costName, [$empresaDEF, $empresaVAR]]);
                }else if(!$showParticular && !$showEmpresa && $showSeguro){ //110
                    array_push($resultTanatorio, [$costName, [$seguroDEF, $seguroVAR]]);
                }
            }else{
                array_push($resultTanatorio, [$costName, [$particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR]]);
            }

            if($client != ''){
                foreach($client as $elemClient){
                    $whereAux = '';
                    $whereAuxCC = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereAux .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereAux .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
                    }

                    if($mortuary != ''){
                        $whereAuxCC .= " AND (";
                        foreach($mortuary as $elem){
                            $elem = cleanStr($elem);
                            $whereAuxCC .= " cc.ID = $elem OR";
                        }
                        $whereAuxCC = substr($whereAuxCC, 0, -3);
                        $whereAuxCC .= ")";
                    }else{
                        $whereAuxCC .= " AND cc.mortuary != 0"; 
                    }

                    if($clientType != ''){
                        $whereAux .= ' AND e.clientType IN (';
                        foreach($clientType as $elem){
                            $elem = cleanStr($elem);
                            $whereAux .= $elem . ',';
                        }
                        $whereAux = substr($whereAux, 0, -1);
                        $whereAux .= ')';
                    }

                    if($mortuary == ''){
                        $whereAuxCC = ' AND cc.ID = ' . $ccID; 
                    }else{
                        $whereAuxCC = '';
                    }
                    
                    $whereAux .= " AND c.clientID = $elemClient";

                    $clientGraff = $this->getControlPanelGraficoClienteOthers($whereAux, $totalGlobal,$elemClient);
                    array_push($resultTanatorio[$indexCC][1], $clientGraff);
                }
            }

            return $resultTanatorio;
        }

        /**
         * Obtiene los datos del resumen de facturación para el cuadro de mando
         * 
         * @param int $date Fecha
         * @param int $dateSince Fecha desde
         * @param int $dateUntil Fecha hasta
         * @param int $mortuary Centro de coste
         * @param int $clientType Tipos de cliente
         * @param int $client Clientes
         * @return array
         */
        public function getControlPanelGraficoCliente($where, $whereCC, $totalGlobal, $clientID){
            $db = new DbHandler;

            $clientResult = [];
            $resultC = $db->query("  SELECT     CONCAT(c.name, ' ', c.surname) as nameP, c.brandName as nameE
                                     FROM       Clients c
                                     WHERE      c.clientID = $clientID");
            $client = $db->resultToArray($resultC);
            
            $userName = '';
            if($client[0]['nameP'] != '' && $client[0]['nameP'] != null){
                $userName = $client[0]['nameP'];
            }else{
                $userName = $client[0]['nameE'];
            }
           
            $clientResult['name'] = $userName;
            $clientResult['total'] = 0;

            $resultExp = $db->query("   SELECT      e.expedientID, e.type, e.client, e.clientType as clientType, CONCAT(c.name, ' ', c.surname) as nameP, c.brandName as nameE
                                        FROM        Expedients e, Clients c, Cost_Center cc
                                        WHERE       e.client = c.clientID AND
                                                    e.leavingDate IS NULL AND
                                                    e.deceasedMortuary = cc.mortuary AND
                                                    (
                                                        SELECT  COUNT(*)
                                                        FROM    Invoices inv
                                                        WHERE   inv.expedient = e.expedientID AND
                                                                inv.leavingDate IS NULL
                                                    ) > 0
                                                    $whereCC
                                                    $where
                                        ORDER BY    e.client");
           
            if(mysqli_num_rows($resultExp) > 0){
                $expedients = $db->resultToArray($resultExp); 

                $userName = '';
                if($expedients[0]['nameP'] != '' && $expedients[0]['nameP'] != null){
                    $userName = $expedients[0]['nameP'];
                }else{
                    $userName = $expedients[0]['nameE'];
                }

                $clientResult['name'] = $userName;
                if($totalGlobal > 0){
                    $percentageClient = count($expedients) * 100 / $totalGlobal;
                    $clientResult['total'] = $percentageClient;
                }else{
                    $clientResult['total'] = 0;
                }
            }

            return $clientResult;
        }

        /**
         * Obtiene los datos del resumen de facturación para el cuadro de mando
         * 
         * @param int $date Fecha
         * @param int $dateSince Fecha desde
         * @param int $dateUntil Fecha hasta
         * @param int $mortuary Centro de coste
         * @param int $clientType Tipos de cliente
         * @param int $client Clientes
         * @return array
         */
        public function getControlPanelGraficoClienteOthers($where, $totalGlobal, $clientID){
            $db = new DbHandler;

            $clientResult = [];
            $resultC = $db->query("  SELECT     CONCAT(c.name, ' ', c.surname) as nameP, c.brandName as nameE
                                     FROM       Clients c
                                     WHERE      c.clientID = $clientID");
            $client = $db->resultToArray($resultC);
            
            $userName = '';
            if($client[0]['nameP'] != '' && $client[0]['nameP'] != null){
                $userName = $client[0]['nameP'];
            }else{
                $userName = $client[0]['nameE'];
            }
           
            $clientResult['name'] = $userName;
            $clientResult['total'] = 0;

            $resultExp = $db->query("   SELECT      e.expedientID, e.type, e.client, e.clientType as clientType, CONCAT(c.name, ' ', c.surname) as nameP, c.brandName as nameE
                                        FROM        (Expedients e, Clients c)
                                        LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                        WHERE       e.client = c.clientID AND
                                                    e.leavingDate IS NULL AND
                                                    (
                                                        SELECT  COUNT(*)
                                                        FROM    Invoices inv
                                                        WHERE   inv.expedient = e.expedientID AND
                                                                inv.leavingDate IS NULL
                                                    ) > 0 AND
                                                    (SELECT COUNT(*) FROM Cost_Center cc WHERE cc.mortuary = m.mortuaryID) = 0
                                                    $where
                                        ORDER BY    e.client");
           
            if(mysqli_num_rows($resultExp) > 0){
                $expedients = $db->resultToArray($resultExp); 

                $userName = '';
                if($expedients[0]['nameP'] != '' && $expedients[0]['nameP'] != null){
                    $userName = $expedients[0]['nameP'];
                }else{
                    $userName = $expedients[0]['nameE'];
                }

                $clientResult['name'] = $userName;
                if($totalGlobal > 0){
                    $percentageClient = count($expedients) * 100 / $totalGlobal;
                    $clientResult['total'] = $percentageClient;
                }else{
                    $clientResult['total'] = 0;
                }
            }

            return $clientResult;
        }

        /**
         * Obtiene los datos del resumen de facturación para el cuadro de mando
         * 
         * @return array
         */
        public function getControlPanelExpedients($client, $type, $costcenter, $date, $dateSince, $dateUntil, $cremation, $clientTypeFilter, $clientFilter, $expedientType, $isTotals){
            $db = new DbHandler;

            $client = cleanStr($client);
            $type = cleanStr($type);
            $date = cleanStr($date);
            $dateSince = cleanStr($dateSince);
            $dateUntil = cleanStr($dateUntil);
            $cremation = cleanStr($cremation);

            $whereCC = '';
            $where = '';
            if($date == ''){
                if($dateSince != '' && $dateUntil != ''){
                    $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                    
                }
            }else{
                $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
            }

            //Cost center filter
            if($costcenter != ''){
                if(is_array($costcenter)){
                    $whereCC .= ' AND cc.ID IN (';
                    foreach($costcenter as $elem){
                        $elem = cleanStr($elem);
                        $whereCC .= $elem . ',';
                    }
                    $whereCC = substr($whereCC, 0, -1);
                    $whereCC .= ')';
                }else{
                    $whereCC .= " AND cc.ID = $costcenter";
                }
            }

            if($client != null && $client != ''){
                $where .= "  AND c.clientID = $client";
            }else{
                if($type != ''){
                    switch($type){
                        case 'PD':
                            $where .= '  AND e.clientType = 1 AND et.expedientTypeID = 1';
                        break;
                        case 'ED':
                            $where .= '  AND e.clientType = 3 AND et.expedientTypeID = 1';
                        break;
                        case 'SD':
                            $where .= '  AND e.clientType = 2 AND et.expedientTypeID = 1';
                        break;
                        case 'PV':
                            $where .= '  AND e.clientType = 1 AND et.expedientTypeID = 3';
                        break;
                        case 'EV':
                            $where .= '  AND e.clientType = 3 AND et.expedientTypeID = 3';
                        break;
                        case 'SV':
                            $where .= '  AND e.clientType = 2 AND et.expedientTypeID = 3';
                        break;
                    }
                }
            }

            if($cremation == 1){
                $where .= ' AND e.cremation = 1 AND e.crematoriumEvent IS NOT NULL';
            }

            if($type != ''){
                if($clientFilter != 0){
                    $where .= ' AND c.clientID NOT IN (';
                    foreach($clientFilter as $elem){
                        $elem = cleanStr($elem);
                        $where .= $elem . ',';
                    }
                    $where = substr($where, 0, -1);
                    $where .= ')';
                }
            }

            // Si el cost_center == 0 => Obtenemos el resto de tanatorios que no son centros de coste
            if($costcenter == '0'){ //OTRAS INSTALACIONES
                $result = $db->query(
                    "   SELECT      e.expedientID, 
                                    et.name as expedientType, 
                                    ct.name as clientType, 
                                    e.number, 
                                    e.requestDate, 
                                    e.deceasedName, 
                                    e.deceasedSurname, 
                                    c.name as clientName, 
                                    c.surname as clientSurname, 
                                    e.tpv
                        FROM        (Expedients e, Clients c, Expedients_Types et, Clients_Types ct)
                        LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                        WHERE       e.client = c.clientID AND
                                    et.expedientTypeID = e.type AND
                                    e.clientType = ct.clientTypeID AND
                                    e.leavingDate IS NULL AND
                                    e.type = $expedientType AND
                                    (
                                        SELECT  COUNT(*)
                                        FROM    Invoices inv
                                        WHERE   inv.expedient = e.expedientID AND
                                                inv.leavingDate IS NULL
                                    ) > 0 AND
                                    (SELECT COUNT(*) FROM Cost_Center cc WHERE cc.mortuary = m.mortuaryID) = 0
                                    $where
                        ");
            }else{
                
                if($costcenter == ''){ //TOTALES
                    $result = $db->query(
                        "       SELECT      e.expedientID, et.name as expedientType, ct.name as clientType, e.number, e.requestDate, e.deceasedName, e.deceasedSurname, c.name as clientName, c.surname as clientSurname, e.tpv
                                FROM        Expedients e, Clients c, Expedients_Types et, Clients_Types ct
                                WHERE       e.client = c.clientID AND
                                            et.expedientTypeID = e.type AND
                                            e.clientType = ct.clientTypeID AND
                                            e.leavingDate IS NULL AND
                                            (
                                                SELECT  COUNT(*)
                                                FROM    Invoices inv
                                                WHERE   inv.expedient = e.expedientID AND
                                                        inv.leavingDate IS NULL
                                            ) > 0 AND
                                            e.type = $expedientType
                                            $where
                    ");

                }else{ // POR CENTRO DE COSTE

                    if($isTotals == 1){
                        $result = $db->query(
                            "   SELECT          t.expedientID, t.expedientType, t.clientType, t.number, t.requestDate, t.deceasedName, t.deceasedSurname, 
                                                t.clientName, t.clientSurname, t.tpv
                                FROM (
                            
                                    SELECT      e.expedientID, et.name as expedientType, ct.name as clientType, e.number, e.requestDate, e.deceasedName, e.deceasedSurname, c.name as clientName, c.surname as clientSurname, e.tpv
                                    FROM        Expedients e, Clients c, Expedients_Types et, Clients_Types ct, Cost_Center cc
                                    WHERE       e.client = c.clientID AND
                                                et.expedientTypeID = e.type AND
                                                e.clientType = ct.clientTypeID AND
                                                e.leavingDate IS NULL AND
                                                e.deceasedMortuary = cc.mortuary AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0 AND
                                                e.type = $expedientType
                                                $where
                                                $whereCC
                                    UNION ALL
                                    SELECT      e.expedientID, et.name as expedientType, ct.name as clientType, e.number, e.requestDate, e.deceasedName, e.deceasedSurname, c.name as clientName, c.surname as clientSurname, e.tpv
                                    FROM        (Expedients e, Clients c, Expedients_Types et, Clients_Types ct)
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    WHERE       e.client = c.clientID AND
                                                et.expedientTypeID = e.type AND
                                                e.clientType = ct.clientTypeID AND
                                                e.leavingDate IS NULL AND
                                                e.type = $expedientType AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0 AND
                                                (SELECT COUNT(*) FROM Cost_Center cc WHERE cc.mortuary = m.mortuaryID) = 0
                                                $where
                                ) as t
                                ORDER BY    t.expedientID
                        ");

                    }else{
                        $result = $db->query(
                            "   SELECT      e.expedientID, et.name as expedientType, ct.name as clientType, e.number, e.requestDate, e.deceasedName, e.deceasedSurname, c.name as clientName, c.surname as clientSurname, e.tpv
                                FROM        Expedients e, Clients c, Expedients_Types et, Clients_Types ct, Cost_Center cc
                                WHERE       e.client = c.clientID AND
                                            et.expedientTypeID = e.type AND
                                            e.clientType = ct.clientTypeID AND
                                            e.leavingDate IS NULL AND
                                            e.deceasedMortuary = cc.mortuary AND
                                            (
                                                SELECT  COUNT(*)
                                                FROM    Invoices inv
                                                WHERE   inv.expedient = e.expedientID AND
                                                        inv.leavingDate IS NULL
                                            ) > 0 AND
                                            e.type = $expedientType
                                            $where
                                            $whereCC
                        ");
                    }
                }
            }

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }

        /**
         * Obtiene los datos del resumen de facturación para el cuadro de mando
         * 
         * @param int $client Cliente
         * @param int $date Fecha
         * @param int $dateSince Fecha desde
         * @param int $dateUntil Fecha hasta
         * @param int $mortuary Centro de coste
         * @return array
         */
        public function getControlPanelFacturacion($client, $type, $costcenter, $date, $dateSince, $dateUntil, $mortuary, $cremation, $clientTypeFilter, $clientFilter, $expedientType, $isTotals){
            $db = new DbHandler;

            $client = cleanStr($client);
            $type = cleanStr($type);
            $date = cleanStr($date);
            $dateSince = cleanStr($dateSince);
            $dateUntil = cleanStr($dateUntil);
            $cremation = cleanStr($cremation);

            $where = '';
            //Date filter
            if($date == ''){
                if($dateSince != '' && $dateUntil != ''){
                    $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                    
                }
            }else{
                $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
            }

            //Cost center filter
            $whereCC = '';
            if($costcenter != ''){
                if(is_array($costcenter)){
                    $whereCC .= ' AND cc.ID IN (';
                    foreach($costcenter as $elem){
                        $elem = cleanStr($elem);
                        $whereCC .= $elem . ',';
                    }
                    $whereCC = substr($whereCC, 0, -1);
                    $whereCC .= ')';
                }else{
                    $whereCC .= " AND cc.ID = $costcenter";
                }
            }

            //Client filter
            if($client != null && $client != ''){
                $where .= "  AND c.clientID = $client";
            }else{
                if($type != ''){
                    switch($type){
                        case 'PD':
                            $where .= '  AND e.clientType = 1 AND et.expedientTypeID = 1';
                        break;
                        case 'ED':
                            $where .= '  AND e.clientType = 3 AND et.expedientTypeID = 1';
                        break;
                        case 'SD':
                            $where .= '  AND e.clientType = 2 AND et.expedientTypeID = 1';
                        break;
                        case 'PV':
                            $where .= '  AND e.clientType = 1 AND et.expedientTypeID = 3';
                        break;
                        case 'EV':
                            $where .= '  AND e.clientType = 3 AND et.expedientTypeID = 3';
                        break;
                        case 'SV':
                            $where .= '  AND e.clientType = 2 AND et.expedientTypeID = 3';
                        break;
                    }
                }
            }

            if($cremation == 1){
                $where .= ' AND e.cremation = 1 AND e.crematoriumEvent IS NOT NULL';
            }

            if($clientFilter != 0){
                if($type != ''){
                    $where .= ' AND c.clientID NOT IN (';
                    foreach($clientFilter as $elem){
                        $elem = cleanStr($elem);
                        $where .= $elem . ',';
                    }
                    $where = substr($where, 0, -1);
                    $where .= ')';
                }
            }

            // Get iva types
            $ivaTypes = [];
            $result = $db->query("  SELECT      it.percentage,
                                                0 as total
                                    FROM        IVA_Types it
                                    WHERE       it.leavingDate IS NULL AND
                                                (it.type IS NULL OR it.type = 1)
                                    ORDER BY    it.percentage ASC 
            ");
            if(mysqli_num_rows($result) > 0){
                $ivaTypes = $db->resultToArray($result);
            }

            if($costcenter == ''){ //TOTALES

                $result = $db->query(
                    "   SELECT      e.expedientID
                        FROM        Expedients e, Clients c, Expedients_Types et, Clients_Types ct
                        WHERE       e.client = c.clientID AND
                                    e.leavingDate IS NULL AND
                                    et.expedientTypeID = e.type AND
                                    e.clientType = ct.clientTypeID
                                    $where 
                        ORDER BY    e.expedientID
                ");
                
                if(mysqli_num_rows($result) > 0){
                    $expedients = $db->resultToArray($result); 
                    $resultFinal = [];
                    foreach($expedients as $index => $elem){
                        $id = $elem['expedientID'];

                        $result = $db->query("  SELECT      e.expedientID, 
                                                            e.number, 
                                                            YEAR(e.requestDate) as year, 
                                                            c.name as clientName, 
                                                            c.surname as clientSurname, 
                                                            e.tpv,
                                                            c.clientID, 
                                                            c.name, 
                                                            c.surname, 
                                                            c.price,
                                                            '' as bases, 
                                                            '' as ivas, 
                                                            (
                                                                (
                                                                    SELECT      COALESCE(SUM(iniv.base), 0)
                                                                    FROM        Invoices i
                                                                    JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = e.expedientID
                                                                )
                                                            ) as bi, 
                                                            (
                                                                (
                                                                    SELECT      COALESCE(SUM(i.supplieds), 0)
                                                                    FROM        Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = e.expedientID
                                                                )
                                                            ) as su,
                                                            (
                                                                (
                                                                    SELECT      COALESCE(SUM(iniv.base), 0)
                                                                    FROM        Invoices i
                                                                    JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = e.expedientID
                                                                )
                                                            ) as fact,
                                                            (
                                                                (
                                                                    SELECT      COALESCE(SUM(iniv.iva), 0)
                                                                    FROM        Invoices i
                                                                    JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = e.expedientID
                                                                )
                                                            ) as totalIva,
                                                            (
                                                                (
                                                                    SELECT      COALESCE(SUM(i.total), 0)
                                                                    FROM        Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = e.expedientID
                                                                )
                                                            ) as factTotal,
                                                            (
                                                                (
                                                                    SELECT      COALESCE(SUM(ip.amount), 0)
                                                                    FROM        Invoices i
                                                                    JOIN        Invoices_Payments ip ON ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = e.expedientID
                                                                )
                                                            ) as paid,
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            SELECT      COALESCE(SUM(i.total), 0)
                                                                            FROM        Invoices i
                                                                            WHERE       i.leavingDate IS NULL AND
                                                                                        i.invoice_type != 3 AND
                                                                                        (
                                                                                            (
                                                                                                i.ID = (
                                                                                                    SELECT  MAX(i2.ID)
                                                                                                    FROM    Invoices i2
                                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                                            i2.invoice_type != 3 AND
                                                                                                            i2.expedient = i.expedient AND 
                                                                                                            (
                                                                                                                i2.rectified_type IS NULL OR 
                                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                            )
                                                                                                )
                                                                                            ) OR
                                                                                            (
                                                                                                i.rectified_type = 2
                                                                                            )
                                                                                        ) AND
                                                                                        i.expedient = e.expedientID
                                                                        )
                                                                    )
                                                                )
                                                                -
                                                                (
                                                                    (
                                                                        (
                                                                            SELECT      COALESCE(SUM(ip.amount), 0)
                                                                            FROM        Invoices i
                                                                            JOIN        Invoices_Payments ip ON ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                                            WHERE       i.leavingDate IS NULL AND
                                                                                        i.invoice_type != 3 AND
                                                                                        (
                                                                                            (
                                                                                                i.ID = (
                                                                                                    SELECT  MAX(i2.ID)
                                                                                                    FROM    Invoices i2
                                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                                            i2.invoice_type != 3 AND
                                                                                                            i2.expedient = i.expedient AND 
                                                                                                            (
                                                                                                                i2.rectified_type IS NULL OR 
                                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                            )
                                                                                                )
                                                                                            ) OR
                                                                                            (
                                                                                                i.rectified_type = 2
                                                                                            )
                                                                                        ) AND
                                                                                        i.expedient = e.expedientID
                                                                        )
                                                                    )
                                                                )
                                                            ) as pending,
                                                            (
                                                                SELECT      i.paymentDate
                                                                FROM        Invoices i
                                                                WHERE       i.leavingDate IS NULL AND 
                                                                            i.invoice_type != 3
                                                                ORDER BY    i.ID DESC
                                                                LIMIT       1
                                                            ) as paymentDate,
                                                            (
                                                                SELECT      i.creationDate
                                                                FROM        Invoices i
                                                                WHERE       i.leavingDate IS NULL AND 
                                                                            i.invoice_type != 3
                                                                ORDER BY    i.ID DESC
                                                                LIMIT       1
                                                            ) as creationDate,
                                                            CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceasedName,
                                                            '' as invoiceID 
                                                FROM        Expedients e, Clients c, Expedients_Types et
                                                WHERE       e.client = c.clientID AND
                                                            e.expedientID = $id AND
                                                            e.leavingDate IS NULL AND
                                                            (
                                                                SELECT  COUNT(*)
                                                                FROM    Invoices inv
                                                                WHERE   inv.expedient = e.expedientID AND
                                                                        inv.leavingDate IS NULL
                                                            ) > 0
                                                            $where
                                                ORDER BY    e.expedientID");

                        if(mysqli_num_rows($result) > 0){
                            $dataAux = $db->resultToArray($result);
                            $resultFinal[$index] = $dataAux;

                            $result = $db->query("  SELECT      SUM(eh.total) as cost
                                                    FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                                    LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                                    WHERE       eh.expedient = $id AND 
                                                                eh.num_hiring = (
                                                                    SELECT  MAX(i2.num_hiring) 
                                                                    FROM    Invoices i2 
                                                                    WHERE   i2.expedient = e.expedientID AND
                                                                            i2.leavingDate IS NULL AND
                                                                            i2.invoice_type != 3
                                                                ) AND
                                                                eh.check = 1 AND 
                                                                eh.expedient = e.expedientID AND
                                                                eh.model = pm.productModelID AND
                                                                eh.product = pr.productID AND
                                                                pr.IVA = it.IVATypeID AND
                                                                pr.leavingDate IS NULL AND
                                                                pr.supplied = 1 AND
                                                                pr.isInvoiced = 0");
                            if(mysqli_num_rows($result) > 0){
                                $supplieds = $db->resultToArray($result)[0]['cost']; 
                                if($supplieds == null){
                                    $supplieds = '0.00';
                                }
                                $resultFinal[$index][0]['su'] =  $supplieds;
                                $resultFinal[$index][0]['fact'] =  floatval($resultFinal[$index][0]['fact']) + floatval($supplieds);
                                $resultFinal[$index][0]['factTotal'] = floatval($resultFinal[$index][0]['factTotal']);
                            }

                            $resultFinal[$index][0]['bases'] = $ivaTypes;
                            $resultFinal[$index][0]['ivas'] = $ivaTypes;

                            $expedientID = $resultFinal[$index][0]['expedientID'];

                            // Get invoices bases
                            $resultInvoiceBases = $db->query("  SELECT      iniv.typeIva, iniv.base
                                                                FROM        Invoices_Ivas iniv, Invoices i
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = $expedientID AND
                                                                            iniv.invoice = i.ID AND
                                                                            iniv.deleteDate IS NULL
                            ");

                            if(mysqli_num_rows($resultInvoiceBases) > 0){
                                $invoiceBases = $db->resultToArray($resultInvoiceBases);
                                foreach($invoiceBases as $invoiceIv){
                                    $keys = array_column($resultFinal[$index][0]['bases'], 'percentage');
                                    $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                    if($indexAux !== false) {
                                        $resultFinal[$index][0]['bases'][$indexAux]['total'] += floatval($invoiceIv['base']);
                                    }
                                }
                            }

                            // Get invoices iva
                            $resultInvoiceIvas = $db->query("   SELECT      iniv.typeIva, iniv.iva
                                                                FROM        Invoices_Ivas iniv, Invoices i
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = $expedientID AND
                                                                            iniv.invoice = i.ID AND
                                                                            iniv.deleteDate IS NULL
                            ");
                            if(mysqli_num_rows($resultInvoiceIvas) > 0){
                                $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                                foreach($invoiceIvas as $invoiceIv){
                                    $keys = array_column($resultFinal[$index][0]['ivas'], 'percentage');
                                    $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                    if($indexAux !== false) {
                                        $resultFinal[$index][0]['ivas'][$indexAux]['total'] += floatval($invoiceIv['iva']);
                                    }
                                }
                            }
                        }
                    }
                }else{
                    return null;
                }  

            }else if($costcenter == '0'){ //OTRAS INSTALACIONES
                $result = $db->query(
                    "   SELECT      e.expedientID
                        FROM        (Expedients e, Clients c, Expedients_Types et, Clients_Types ct) 
                        LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                        WHERE       e.client = c.clientID AND
                                    e.leavingDate IS NULL AND
                                    et.expedientTypeID = e.type AND
                                    e.clientType = ct.clientTypeID AND 
                                    (
                                        SELECT  COUNT(*)
                                        FROM    Invoices inv
                                        WHERE   inv.expedient = e.expedientID AND
                                                inv.leavingDate IS NULL
                                    ) > 0 AND
                                    (SELECT COUNT(*) FROM Cost_Center cc WHERE cc.mortuary = m.mortuaryID) = 0
                                    $where
                        ORDER BY    e.expedientID");

                if(mysqli_num_rows($result) > 0){
                    $expedients = $db->resultToArray($result); 
                    $resultFinal = [];
                    foreach($expedients as $index => $elem){
                        $id = $elem['expedientID'];

                        $result = $db->query("  SELECT      '' as ID, 
                                                            e.expedientID, 
                                                            e.number, 
                                                            e.requestDate, 
                                                            c.name as clientName, 
                                                            c.surname as clientSurname, 
                                                            e.tpv,
                                                            c.clientID, 
                                                            c.name, 
                                                            c.surname, 
                                                            c.price,
                                                            '' as bases, 
                                                            '' as ivas, 
                                                            (
                                                                (
                                                                    SELECT      COALESCE(SUM(iniv.base), 0)
                                                                    FROM        Invoices i
                                                                    JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = e.expedientID
                                                                )
                                                            ) as bi,
                                                            (
                                                                (
                                                                    SELECT      COALESCE(SUM(i.supplieds), 0)
                                                                    FROM        Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = e.expedientID
                                                                )
                                                            ) as su,
                                                            (
                                                                (
                                                                    SELECT      COALESCE(SUM(iniv.base), 0)
                                                                    FROM        Invoices i
                                                                    JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = e.expedientID
                                                                )
                                                            ) as fact,
                                                            (
                                                                (
                                                                    SELECT      COALESCE(SUM(iniv.iva), 0)
                                                                    FROM        Invoices i
                                                                    JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = e.expedientID
                                                                )
                                                            ) as totalIva,
                                                            (
                                                                (
                                                                    SELECT      COALESCE(SUM(i.total), 0)
                                                                    FROM        Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = e.expedientID
                                                                )
                                                            ) as factTotal,
                                                            (
                                                                (
                                                                    SELECT      COALESCE(SUM(ip.amount), 0)
                                                                    FROM        Invoices i
                                                                    JOIN        Invoices_Payments ip ON ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = e.expedientID
                                                                )
                                                            ) as paid,
                                                            (
                                                                (
                                                                    (
                                                                        (
                                                                            SELECT      COALESCE(SUM(i.total), 0)
                                                                            FROM        Invoices i
                                                                            WHERE       i.leavingDate IS NULL AND
                                                                                        i.invoice_type != 3 AND
                                                                                        (
                                                                                            (
                                                                                                i.ID = (
                                                                                                    SELECT  MAX(i2.ID)
                                                                                                    FROM    Invoices i2
                                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                                            i2.invoice_type != 3 AND
                                                                                                            i2.expedient = i.expedient AND 
                                                                                                            (
                                                                                                                i2.rectified_type IS NULL OR 
                                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                            )
                                                                                                )
                                                                                            ) OR
                                                                                            (
                                                                                                i.rectified_type = 2
                                                                                            )
                                                                                        ) AND
                                                                                        i.expedient = e.expedientID
                                                                        )
                                                                    )
                                                                )
                                                                -
                                                                (
                                                                    (
                                                                        (
                                                                            SELECT      COALESCE(SUM(ip.amount), 0)
                                                                            FROM        Invoices i
                                                                            JOIN        Invoices_Payments ip ON ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                                            WHERE       i.leavingDate IS NULL AND
                                                                                        i.invoice_type != 3 AND
                                                                                        (
                                                                                            (
                                                                                                i.ID = (
                                                                                                    SELECT  MAX(i2.ID)
                                                                                                    FROM    Invoices i2
                                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                                            i2.invoice_type != 3 AND
                                                                                                            i2.expedient = i.expedient AND 
                                                                                                            (
                                                                                                                i2.rectified_type IS NULL OR 
                                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                            )
                                                                                                )
                                                                                            ) OR
                                                                                            (
                                                                                                i.rectified_type = 2
                                                                                            )
                                                                                        ) AND
                                                                                        i.expedient = e.expedientID
                                                                        )
                                                                    )
                                                                )
                                                            ) as pending,
                                                            (
                                                                SELECT      i.paymentDate
                                                                FROM        Invoices i
                                                                WHERE       i.leavingDate IS NULL AND 
                                                                            i.invoice_type != 3
                                                                ORDER BY    i.ID DESC
                                                                LIMIT       1
                                                            ) as paymentDate,
                                                            (
                                                                SELECT      i.creationDate
                                                                FROM        Invoices i
                                                                WHERE       i.leavingDate IS NULL AND 
                                                                            i.invoice_type != 3
                                                                ORDER BY    i.ID DESC
                                                                LIMIT       1
                                                            ) as creationDate,
                                                            CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceasedName,
                                                            '' as invoiceID 
                                                FROM        Expedients e, Clients c, Expedients_Types et
                                                WHERE       e.client = c.clientID AND
                                                            e.expedientID = $id AND
                                                            e.leavingDate IS NULL AND
                                                            (
                                                                SELECT  COUNT(*)
                                                                FROM    Invoices inv
                                                                WHERE   inv.expedient = e.expedientID AND
                                                                        inv.leavingDate IS NULL
                                                            ) > 0
                                                            $where
                                                ORDER BY    e.expedientID");

                        if(mysqli_num_rows($result) > 0){
                            $dataAux = $db->resultToArray($result);
                            $resultFinal[$index] = $dataAux;

                            $result = $db->query("  SELECT      SUM(eh.total) as cost
                                                    FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                                    LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                                    WHERE       eh.expedient = $id AND 
                                                                eh.num_hiring = (
                                                                    SELECT  MAX(i2.num_hiring) 
                                                                    FROM    Invoices i2 
                                                                    WHERE   i2.expedient = e.expedientID AND
                                                                            i2.leavingDate IS NULL AND
                                                                            i2.invoice_type != 3
                                                                ) AND
                                                                eh.check = 1 AND 
                                                                eh.expedient = e.expedientID AND
                                                                eh.model = pm.productModelID AND
                                                                eh.product = pr.productID AND
                                                                pr.IVA = it.IVATypeID AND
                                                                pr.leavingDate IS NULL AND
                                                                pr.supplied = 1 AND
                                                                pr.isInvoiced = 0");
                            if(mysqli_num_rows($result) > 0){
                                $supplieds = $db->resultToArray($result)[0]['cost']; 
                                if($supplieds == null){
                                    $supplieds = '0.00';
                                }
                                $resultFinal[$index][0]['su'] =  $supplieds;
                                $resultFinal[$index][0]['fact'] =  floatval($resultFinal[$index][0]['fact']) + floatval($supplieds);
                                $resultFinal[$index][0]['factTotal'] = floatval($resultFinal[$index][0]['factTotal']);
                            }

                            $resultFinal[$index][0]['bases'] = $ivaTypes;
                            $resultFinal[$index][0]['ivas'] = $ivaTypes;

                            $expedientID = $resultFinal[$index][0]['expedientID'];

                            // Get invoices bases
                            $resultInvoiceBases = $db->query("   SELECT      iniv.typeIva, iniv.base
                                                                FROM        Invoices_Ivas iniv, Invoices i
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = $expedientID AND
                                                                            iniv.invoice = i.ID AND
                                                                            iniv.deleteDate IS NULL
                            ");

                            if(mysqli_num_rows($resultInvoiceBases) > 0){
                                $invoiceBases = $db->resultToArray($resultInvoiceBases);
                                foreach($invoiceBases as $invoiceIv){
                                    $keys = array_column($resultFinal[$index][0]['bases'], 'percentage');
                                    $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                    if($indexAux !== false) {
                                        $resultFinal[$index][0]['bases'][$indexAux]['total'] += floatval($invoiceIv['base']);
                                    }
                                }
                            }

                            // Get invoices ivas
                            $resultInvoiceIvas = $db->query("   SELECT      iniv.typeIva, iniv.iva
                                                                FROM        Invoices_Ivas iniv, Invoices i
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = $expedientID AND
                                                                            iniv.invoice = i.ID AND
                                                                            iniv.deleteDate IS NULL
                            ");
                            if(mysqli_num_rows($resultInvoiceIvas) > 0){
                                $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                                foreach($invoiceIvas as $invoiceIv){
                                    $keys = array_column($resultFinal[$index][0]['ivas'], 'percentage');
                                    $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                    if($indexAux !== false) {
                                        $resultFinal[$index][0]['ivas'][$indexAux]['total'] += floatval($invoiceIv['iva']);
                                    }
                                }
                            }

                        }
                    }
                }else{
                    return null;
                }  

            }else{ //POR CENTRO DE COSTE

                if($isTotals == 1){

                    $result = $db->query(
                        "   SELECT      t.expedientID
                            FROM (
                                    SELECT      e.expedientID
                                    FROM        Expedients e, Clients c, Expedients_Types et, Clients_Types ct, Cost_Center cc
                                    WHERE       e.client = c.clientID AND
                                                e.leavingDate IS NULL AND
                                                et.expedientTypeID = e.type AND
                                                e.clientType = ct.clientTypeID AND 
                                                e.deceasedMortuary = cc.mortuary
                                                $where 
                                                $whereCC
                                    UNION
                                    SELECT      e.expedientID
                                    FROM        Expedients e, Clients c, Expedients_Types et, Clients_Types ct
                                    WHERE       e.client = c.clientID AND
                                                e.leavingDate IS NULL AND
                                                et.expedientTypeID = e.type AND
                                                e.clientType = ct.clientTypeID
                                                $where 
                                    ) t
                            ORDER BY    t.expedientID
                    ");

                    if(mysqli_num_rows($result) > 0){
                        $expedients = $db->resultToArray($result); 
                        $resultFinal = [];
                        foreach($expedients as $index => $elem){
                            $id = $elem['expedientID'];

                            $result = $db->query("  SELECT      e.expedientID, 
                                                                e.number, 
                                                                YEAR(e.requestDate) as year, 
                                                                c.name as clientName, 
                                                                c.surname as clientSurname, 
                                                                e.tpv,
                                                                c.clientID, 
                                                                c.name, 
                                                                c.surname, 
                                                                c.price,
                                                                '' as bases, 
                                                                '' as ivas, 
                                                                (
                                                                    (
                                                                        SELECT      COALESCE(SUM(iniv.base), 0)
                                                                        FROM        Invoices i
                                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                        WHERE       i.leavingDate IS NULL AND
                                                                                    i.invoice_type != 3 AND
                                                                                    (
                                                                                        (
                                                                                            i.ID = (
                                                                                                SELECT  MAX(i2.ID)
                                                                                                FROM    Invoices i2
                                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                                        i2.invoice_type != 3 AND
                                                                                                        i2.expedient = i.expedient AND 
                                                                                                        (
                                                                                                            i2.rectified_type IS NULL OR 
                                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                        )
                                                                                            )
                                                                                        ) OR
                                                                                        (
                                                                                            i.rectified_type = 2
                                                                                        )
                                                                                    ) AND
                                                                                    i.expedient = e.expedientID
                                                                    )
                                                                ) as bi, 
                                                                (
                                                                    (
                                                                        SELECT      COALESCE(SUM(i.supplieds), 0)
                                                                        FROM        Invoices i
                                                                        WHERE       i.leavingDate IS NULL AND
                                                                                    i.invoice_type != 3 AND
                                                                                    (
                                                                                        (
                                                                                            i.ID = (
                                                                                                SELECT  MAX(i2.ID)
                                                                                                FROM    Invoices i2
                                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                                        i2.invoice_type != 3 AND
                                                                                                        i2.expedient = i.expedient AND 
                                                                                                        (
                                                                                                            i2.rectified_type IS NULL OR 
                                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                        )
                                                                                            )
                                                                                        ) OR
                                                                                        (
                                                                                            i.rectified_type = 2
                                                                                        )
                                                                                    ) AND
                                                                                    i.expedient = e.expedientID
                                                                    )
                                                                ) as su,
                                                                (
                                                                    (
                                                                        SELECT      COALESCE(SUM(iniv.base), 0)
                                                                        FROM        Invoices i
                                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                        WHERE       i.leavingDate IS NULL AND
                                                                                    i.invoice_type != 3 AND
                                                                                    (
                                                                                        (
                                                                                            i.ID = (
                                                                                                SELECT  MAX(i2.ID)
                                                                                                FROM    Invoices i2
                                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                                        i2.invoice_type != 3 AND
                                                                                                        i2.expedient = i.expedient AND 
                                                                                                        (
                                                                                                            i2.rectified_type IS NULL OR 
                                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                        )
                                                                                            )
                                                                                        ) OR
                                                                                        (
                                                                                            i.rectified_type = 2
                                                                                        )
                                                                                    ) AND
                                                                                    i.expedient = e.expedientID
                                                                    )
                                                                ) as fact,
                                                                (
                                                                    (
                                                                        SELECT      COALESCE(SUM(iniv.iva), 0)
                                                                        FROM        Invoices i
                                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                        WHERE       i.leavingDate IS NULL AND
                                                                                    i.invoice_type != 3 AND
                                                                                    (
                                                                                        (
                                                                                            i.ID = (
                                                                                                SELECT  MAX(i2.ID)
                                                                                                FROM    Invoices i2
                                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                                        i2.invoice_type != 3 AND
                                                                                                        i2.expedient = i.expedient AND 
                                                                                                        (
                                                                                                            i2.rectified_type IS NULL OR 
                                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                        )
                                                                                            )
                                                                                        ) OR
                                                                                        (
                                                                                            i.rectified_type = 2
                                                                                        )
                                                                                    ) AND
                                                                                    i.expedient = e.expedientID
                                                                    )
                                                                ) as totalIva,
                                                                (
                                                                    (
                                                                        SELECT      COALESCE(SUM(i.total), 0)
                                                                        FROM        Invoices i
                                                                        WHERE       i.leavingDate IS NULL AND
                                                                                    i.invoice_type != 3 AND
                                                                                    (
                                                                                        (
                                                                                            i.ID = (
                                                                                                SELECT  MAX(i2.ID)
                                                                                                FROM    Invoices i2
                                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                                        i2.invoice_type != 3 AND
                                                                                                        i2.expedient = i.expedient AND 
                                                                                                        (
                                                                                                            i2.rectified_type IS NULL OR 
                                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                        )
                                                                                            )
                                                                                        ) OR
                                                                                        (
                                                                                            i.rectified_type = 2
                                                                                        )
                                                                                    ) AND
                                                                                    i.expedient = e.expedientID
                                                                    )
                                                                ) as factTotal,
                                                                (
                                                                    (
                                                                        SELECT      COALESCE(SUM(ip.amount), 0)
                                                                        FROM        Invoices i
                                                                        JOIN        Invoices_Payments ip ON ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                                        WHERE       i.leavingDate IS NULL AND
                                                                                    i.invoice_type != 3 AND
                                                                                    (
                                                                                        (
                                                                                            i.ID = (
                                                                                                SELECT  MAX(i2.ID)
                                                                                                FROM    Invoices i2
                                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                                        i2.invoice_type != 3 AND
                                                                                                        i2.expedient = i.expedient AND 
                                                                                                        (
                                                                                                            i2.rectified_type IS NULL OR 
                                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                        )
                                                                                            )
                                                                                        ) OR
                                                                                        (
                                                                                            i.rectified_type = 2
                                                                                        )
                                                                                    ) AND
                                                                                    i.expedient = e.expedientID
                                                                    )
                                                                ) as paid,
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                SELECT      COALESCE(SUM(i.total), 0)
                                                                                FROM        Invoices i
                                                                                WHERE       i.leavingDate IS NULL AND
                                                                                            i.invoice_type != 3 AND
                                                                                            (
                                                                                                (
                                                                                                    i.ID = (
                                                                                                        SELECT  MAX(i2.ID)
                                                                                                        FROM    Invoices i2
                                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                                i2.invoice_type != 3 AND
                                                                                                                i2.expedient = i.expedient AND 
                                                                                                                (
                                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                                )
                                                                                                    )
                                                                                                ) OR
                                                                                                (
                                                                                                    i.rectified_type = 2
                                                                                                )
                                                                                            ) AND
                                                                                            i.expedient = e.expedientID
                                                                            )
                                                                        )
                                                                    )
                                                                    -
                                                                    (
                                                                        (
                                                                            (
                                                                                SELECT      COALESCE(SUM(ip.amount), 0)
                                                                                FROM        Invoices i
                                                                                JOIN        Invoices_Payments ip ON ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                                                WHERE       i.leavingDate IS NULL AND
                                                                                            i.invoice_type != 3 AND
                                                                                            (
                                                                                                (
                                                                                                    i.ID = (
                                                                                                        SELECT  MAX(i2.ID)
                                                                                                        FROM    Invoices i2
                                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                                i2.invoice_type != 3 AND
                                                                                                                i2.expedient = i.expedient AND 
                                                                                                                (
                                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                                )
                                                                                                    )
                                                                                                ) OR
                                                                                                (
                                                                                                    i.rectified_type = 2
                                                                                                )
                                                                                            ) AND
                                                                                            i.expedient = e.expedientID
                                                                            )
                                                                        )
                                                                    )
                                                                ) as pending,
                                                                (
                                                                    SELECT      i.paymentDate
                                                                    FROM        Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND 
                                                                                i.invoice_type != 3
                                                                    ORDER BY    i.ID DESC
                                                                    LIMIT       1
                                                                ) as paymentDate,
                                                                (
                                                                    SELECT      i.creationDate
                                                                    FROM        Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND 
                                                                                i.invoice_type != 3
                                                                    ORDER BY    i.ID DESC
                                                                    LIMIT       1
                                                                ) as creationDate,
                                                                CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceasedName,
                                                                '' as invoiceID 
                                                    FROM        Expedients e, Clients c, Expedients_Types et
                                                    WHERE       e.client = c.clientID AND
                                                                e.expedientID = $id AND
                                                                e.leavingDate IS NULL AND
                                                                (
                                                                    SELECT  COUNT(*)
                                                                    FROM    Invoices inv
                                                                    WHERE   inv.expedient = e.expedientID AND
                                                                            inv.leavingDate IS NULL
                                                                ) > 0
                                                                $where
                                                    ORDER BY    e.expedientID");

                            if(mysqli_num_rows($result) > 0){
                                $dataAux = $db->resultToArray($result);
                                $resultFinal[$index] = $dataAux;

                                $result = $db->query("  SELECT      SUM(eh.total) as cost
                                                        FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                                        LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                                        WHERE       eh.expedient = $id AND 
                                                                    eh.num_hiring = (
                                                                        SELECT  MAX(i2.num_hiring) 
                                                                        FROM    Invoices i2 
                                                                        WHERE   i2.expedient = e.expedientID AND
                                                                                i2.leavingDate IS NULL AND
                                                                                i2.invoice_type != 3
                                                                    ) AND
                                                                    eh.check = 1 AND 
                                                                    eh.expedient = e.expedientID AND
                                                                    eh.model = pm.productModelID AND
                                                                    eh.product = pr.productID AND
                                                                    pr.IVA = it.IVATypeID AND
                                                                    pr.leavingDate IS NULL AND
                                                                    pr.supplied = 1 AND
                                                                    pr.isInvoiced = 0");
                                if(mysqli_num_rows($result) > 0){
                                    $supplieds = $db->resultToArray($result)[0]['cost']; 
                                    if($supplieds == null){
                                        $supplieds = '0.00';
                                    }
                                    $resultFinal[$index][0]['su'] =  $supplieds;
                                    $resultFinal[$index][0]['fact'] =  floatval($resultFinal[$index][0]['fact']) + floatval($supplieds);
                                    $resultFinal[$index][0]['factTotal'] = floatval($resultFinal[$index][0]['factTotal']);
                                }

                                $resultFinal[$index][0]['bases'] = $ivaTypes;
                                $resultFinal[$index][0]['ivas'] = $ivaTypes;

                                $expedientID = $resultFinal[$index][0]['expedientID'];

                                // Get invoices bases
                                $resultInvoiceBases = $db->query("  SELECT      iniv.typeIva, iniv.base
                                                                    FROM        Invoices_Ivas iniv, Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = $expedientID AND
                                                                                iniv.invoice = i.ID AND
                                                                                iniv.deleteDate IS NULL
                                ");

                                if(mysqli_num_rows($resultInvoiceBases) > 0){
                                    $invoiceBases = $db->resultToArray($resultInvoiceBases);
                                    foreach($invoiceBases as $invoiceIv){
                                        $keys = array_column($resultFinal[$index][0]['bases'], 'percentage');
                                        $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                        if($indexAux !== false) {
                                            $resultFinal[$index][0]['bases'][$indexAux]['total'] += floatval($invoiceIv['base']);
                                        }
                                    }
                                }

                                // Get invoices iva
                                $resultInvoiceIvas = $db->query("   SELECT      iniv.typeIva, iniv.iva
                                                                    FROM        Invoices_Ivas iniv, Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = $expedientID AND
                                                                                iniv.invoice = i.ID AND
                                                                                iniv.deleteDate IS NULL
                                ");
                                if(mysqli_num_rows($resultInvoiceIvas) > 0){
                                    $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                                    foreach($invoiceIvas as $invoiceIv){
                                        $keys = array_column($resultFinal[$index][0]['ivas'], 'percentage');
                                        $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                        if($indexAux !== false) {
                                            $resultFinal[$index][0]['ivas'][$indexAux]['total'] += floatval($invoiceIv['iva']);
                                        }
                                    }
                                }
                            }
                        }
                    }else{
                        return null;
                    }  
                }else{
                    $result = $db->query(
                        "   SELECT      e.expedientID
                            FROM        Expedients e, Clients c, Expedients_Types et, Clients_Types ct, Cost_Center cc
                            WHERE       e.client = c.clientID AND
                                        e.leavingDate IS NULL AND
                                        et.expedientTypeID = e.type AND
                                        e.clientType = ct.clientTypeID AND 
                                        e.deceasedMortuary = cc.mortuary AND
                                        (
                                            SELECT  COUNT(*)
                                            FROM    Invoices inv
                                            WHERE   inv.expedient = e.expedientID AND
                                                    inv.leavingDate IS NULL
                                        ) > 0
                                        $where
                                        $whereCC
                            ORDER BY    e.expedientID");

                    if(mysqli_num_rows($result) > 0){
                        $expedients = $db->resultToArray($result); 
                        $resultFinal = [];
                        foreach($expedients as $index => $elem){
                            $id = $elem['expedientID'];
                            
                            $result = $db->query("  SELECT      e.expedientID, e.number, YEAR(e.requestDate) as year, c.name as clientName, c.surname as clientSurname, e.tpv,
                                                                c.clientID, c.name, c.surname, c.price,
                                                                '' as bases, 
                                                                '' as ivas, 
                                                                (
                                                                    (
                                                                        SELECT      COALESCE(SUM(iniv.base), 0)
                                                                        FROM        Invoices i
                                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                        WHERE       i.leavingDate IS NULL AND
                                                                                    i.invoice_type != 3 AND
                                                                                    (
                                                                                        (
                                                                                            i.ID = (
                                                                                                SELECT  MAX(i2.ID)
                                                                                                FROM    Invoices i2
                                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                                        i2.invoice_type != 3 AND
                                                                                                        i2.expedient = i.expedient AND 
                                                                                                        (
                                                                                                            i2.rectified_type IS NULL OR 
                                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                        )
                                                                                            )
                                                                                        ) OR
                                                                                        (
                                                                                            i.rectified_type = 2
                                                                                        )
                                                                                    ) AND
                                                                                    i.expedient = e.expedientID
                                                                    )
                                                                ) as bi,
                                                                (
                                                                    (
                                                                        SELECT      COALESCE(SUM(i.supplieds), 0)
                                                                        FROM        Invoices i
                                                                        WHERE       i.leavingDate IS NULL AND
                                                                                    i.invoice_type != 3 AND
                                                                                    (
                                                                                        (
                                                                                            i.ID = (
                                                                                                SELECT  MAX(i2.ID)
                                                                                                FROM    Invoices i2
                                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                                        i2.invoice_type != 3 AND
                                                                                                        i2.expedient = i.expedient AND 
                                                                                                        (
                                                                                                            i2.rectified_type IS NULL OR 
                                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                        )
                                                                                            )
                                                                                        ) OR
                                                                                        (
                                                                                            i.rectified_type = 2
                                                                                        )
                                                                                    ) AND
                                                                                    i.expedient = e.expedientID
                                                                    )
                                                                ) as su,
                                                                (
                                                                    (
                                                                        SELECT      COALESCE(SUM(iniv.base), 0)
                                                                        FROM        Invoices i
                                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                        WHERE       i.leavingDate IS NULL AND
                                                                                    i.invoice_type != 3 AND
                                                                                    (
                                                                                        (
                                                                                            i.ID = (
                                                                                                SELECT  MAX(i2.ID)
                                                                                                FROM    Invoices i2
                                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                                        i2.invoice_type != 3 AND
                                                                                                        i2.expedient = i.expedient AND 
                                                                                                        (
                                                                                                            i2.rectified_type IS NULL OR 
                                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                        )
                                                                                            )
                                                                                        ) OR
                                                                                        (
                                                                                            i.rectified_type = 2
                                                                                        )
                                                                                    ) AND
                                                                                    i.expedient = e.expedientID
                                                                    )
                                                                ) as fact,
                                                                (
                                                                    (
                                                                        SELECT      COALESCE(SUM(iniv.iva), 0)
                                                                        FROM        Invoices i
                                                                        JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                        WHERE       i.leavingDate IS NULL AND
                                                                                    i.invoice_type != 3 AND
                                                                                    (
                                                                                        (
                                                                                            i.ID = (
                                                                                                SELECT  MAX(i2.ID)
                                                                                                FROM    Invoices i2
                                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                                        i2.invoice_type != 3 AND
                                                                                                        i2.expedient = i.expedient AND 
                                                                                                        (
                                                                                                            i2.rectified_type IS NULL OR 
                                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                        )
                                                                                            )
                                                                                        ) OR
                                                                                        (
                                                                                            i.rectified_type = 2
                                                                                        )
                                                                                    ) AND
                                                                                    i.expedient = e.expedientID
                                                                    )
                                                                ) as totalIva,
                                                                (
                                                                    (
                                                                        SELECT      COALESCE(SUM(i.total), 0)
                                                                        FROM        Invoices i
                                                                        WHERE       i.leavingDate IS NULL AND
                                                                                    i.invoice_type != 3 AND
                                                                                    (
                                                                                        (
                                                                                            i.ID = (
                                                                                                SELECT  MAX(i2.ID)
                                                                                                FROM    Invoices i2
                                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                                        i2.invoice_type != 3 AND
                                                                                                        i2.expedient = i.expedient AND 
                                                                                                        (
                                                                                                            i2.rectified_type IS NULL OR 
                                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                        )
                                                                                            )
                                                                                        ) OR
                                                                                        (
                                                                                            i.rectified_type = 2
                                                                                        )
                                                                                    ) AND
                                                                                    i.expedient = e.expedientID
                                                                    )
                                                                ) as factTotal,
                                                                (
                                                                    (
                                                                        SELECT      COALESCE(SUM(ip.amount), 0)
                                                                        FROM        Invoices i
                                                                        JOIN        Invoices_Payments ip ON ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                                        WHERE       i.leavingDate IS NULL AND
                                                                                    i.invoice_type != 3 AND
                                                                                    (
                                                                                        (
                                                                                            i.ID = (
                                                                                                SELECT  MAX(i2.ID)
                                                                                                FROM    Invoices i2
                                                                                                WHERE   i2.leavingDate IS NULL AND
                                                                                                        i2.invoice_type != 3 AND
                                                                                                        i2.expedient = i.expedient AND 
                                                                                                        (
                                                                                                            i2.rectified_type IS NULL OR 
                                                                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                        )
                                                                                            )
                                                                                        ) OR
                                                                                        (
                                                                                            i.rectified_type = 2
                                                                                        )
                                                                                    ) AND
                                                                                    i.expedient = e.expedientID
                                                                    )
                                                                ) as paid,
                                                                (
                                                                    (
                                                                        (
                                                                            (
                                                                                SELECT      COALESCE(SUM(i.total), 0)
                                                                                FROM        Invoices i
                                                                                WHERE       i.leavingDate IS NULL AND
                                                                                            i.invoice_type != 3 AND
                                                                                            (
                                                                                                (
                                                                                                    i.ID = (
                                                                                                        SELECT  MAX(i2.ID)
                                                                                                        FROM    Invoices i2
                                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                                i2.invoice_type != 3 AND
                                                                                                                i2.expedient = i.expedient AND 
                                                                                                                (
                                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                                )
                                                                                                    )
                                                                                                ) OR
                                                                                                (
                                                                                                    i.rectified_type = 2
                                                                                                )
                                                                                            ) AND
                                                                                            i.expedient = e.expedientID
                                                                            )
                                                                        )
                                                                    )
                                                                    -
                                                                    (
                                                                        (
                                                                            (
                                                                                SELECT      COALESCE(SUM(ip.amount), 0)
                                                                                FROM        Invoices i
                                                                                JOIN        Invoices_Payments ip ON ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                                                WHERE       i.leavingDate IS NULL AND
                                                                                            i.invoice_type != 3 AND
                                                                                            (
                                                                                                (
                                                                                                    i.ID = (
                                                                                                        SELECT  MAX(i2.ID)
                                                                                                        FROM    Invoices i2
                                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                                i2.invoice_type != 3 AND
                                                                                                                i2.expedient = i.expedient AND 
                                                                                                                (
                                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                                )
                                                                                                    )
                                                                                                ) OR
                                                                                                (
                                                                                                    i.rectified_type = 2
                                                                                                )
                                                                                            ) AND
                                                                                            i.expedient = e.expedientID
                                                                            )
                                                                        )
                                                                    )
                                                                ) as pending,
                                                                (
                                                                    SELECT      i.paymentDate
                                                                    FROM        Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND 
                                                                                i.invoice_type != 3
                                                                    ORDER BY    i.ID DESC
                                                                    LIMIT       1
                                                                ) as paymentDate,
                                                                (
                                                                    SELECT      i.creationDate
                                                                    FROM        Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND 
                                                                                i.invoice_type != 3
                                                                    ORDER BY    i.ID DESC
                                                                    LIMIT       1
                                                                ) as creationDate,
                                                                CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceasedName,
                                                                '' as invoiceID 
                                                    FROM        Expedients e, Clients c, Expedients_Types et, Cost_Center cc
                                                    WHERE       e.client = c.clientID AND
                                                                e.expedientID = $id AND
                                                                e.leavingDate IS NULL AND
                                                                e.deceasedMortuary = cc.mortuary AND
                                                                (
                                                                    SELECT  COUNT(*)
                                                                    FROM    Invoices inv
                                                                    WHERE   inv.expedient = e.expedientID AND
                                                                            inv.leavingDate IS NULL
                                                                ) > 0
                                                                $where
                                                                $whereCC
                                                    ORDER BY    e.expedientID");

                            if(mysqli_num_rows($result) > 0){
                                $dataAux = $db->resultToArray($result);
                                $resultFinal[$index] = $dataAux;

                                $result = $db->query("  SELECT      SUM(eh.total) as cost
                                                        FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                                        LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                                        WHERE       eh.expedient = $id AND 
                                                                    eh.num_hiring = (
                                                                        SELECT  MAX(i2.num_hiring) 
                                                                        FROM    Invoices i2 
                                                                        WHERE   i2.expedient = e.expedientID AND
                                                                                i2.leavingDate IS NULL AND
                                                                                i2.invoice_type != 3
                                                                    ) AND
                                                                    eh.check = 1 AND 
                                                                    eh.expedient = e.expedientID AND
                                                                    eh.model = pm.productModelID AND
                                                                    eh.product = pr.productID AND
                                                                    pr.IVA = it.IVATypeID AND
                                                                    pr.leavingDate IS NULL AND
                                                                    pr.supplied = 1 AND
                                                                    pr.isInvoiced = 0");
                                if(mysqli_num_rows($result) > 0){
                                    $supplieds = $db->resultToArray($result)[0]['cost']; 
                                    if($supplieds == null){
                                        $supplieds = '0.00';
                                    }
                                    $resultFinal[$index][0]['su'] =  $supplieds;
                                    $resultFinal[$index][0]['fact'] =  floatval($resultFinal[$index][0]['fact']) + floatval($supplieds);
                                    $resultFinal[$index][0]['factTotal'] = floatval($resultFinal[$index][0]['factTotal']);
                                }

                                $resultFinal[$index][0]['bases'] = $ivaTypes;
                                $resultFinal[$index][0]['ivas'] = $ivaTypes;

                                $expedientID = $resultFinal[$index][0]['expedientID'];

                                // Get invoices bases
                                $resultInvoiceBases = $db->query("  SELECT      iniv.typeIva, iniv.base
                                                                    FROM        Invoices_Ivas iniv, Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = $expedientID AND
                                                                                iniv.invoice = i.ID AND
                                                                                iniv.deleteDate IS NULL
                                ");

                                if(mysqli_num_rows($resultInvoiceBases) > 0){
                                    $invoiceBases = $db->resultToArray($resultInvoiceBases);
                                    foreach($invoiceBases as $invoiceIv){
                                        $keys = array_column($resultFinal[$index][0]['bases'], 'percentage');
                                        $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                        if($indexAux !== false) {
                                            $resultFinal[$index][0]['bases'][$indexAux]['total'] += floatval($invoiceIv['base']);
                                        }
                                    }
                                }

                                // Get invoices ivas
                                $resultInvoiceIvas = $db->query("   SELECT      iniv.typeIva, iniv.iva
                                                                    FROM        Invoices_Ivas iniv, Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = $expedientID AND
                                                                                iniv.invoice = i.ID AND
                                                                                iniv.deleteDate IS NULL
                                ");
                                if(mysqli_num_rows($resultInvoiceIvas) > 0){
                                    $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                                    foreach($invoiceIvas as $invoiceIv){
                                        $keys = array_column($resultFinal[$index][0]['ivas'], 'percentage');
                                        $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                        if($indexAux !== false) {
                                            $resultFinal[$index][0]['ivas'][$indexAux]['total'] += floatval($invoiceIv['iva']);
                                        }
                                    }
                                }
                            }
                        }
                    }else{
                        return null;
                    }  
                }
            }

            return  $resultFinal;
        }

        /**
         * Obtiene los datos del resumen de facturación para el cuadro de mando
         * 
         * @param int $client Cliente
         * @param int $date Fecha
         * @param int $dateSince Fecha desde
         * @param int $dateUntil Fecha hasta
         * @param int $mortuary Centro de coste
         * @return array
         */
        public function getControlPanelPayInvoices($client, $type, $costcenter, $date, $dateSince, $dateUntil, $mortuary, $paid, $clientTypeFilter, $clientFilter, $expedientType){
            $db = new DbHandler;

            $client = cleanStr($client);
            $type = cleanStr($type);
            $date = cleanStr($date);
            $dateSince = cleanStr($dateSince);
            $dateUntil = cleanStr($dateUntil);
            $paid = cleanStr($paid);

            $where = '';
             if($date == ''){
                if($dateSince != '' && $dateUntil != ''){
                    $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                    
                }
            }else{
                $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
            }

            //Cost center filter
            $whereCC = '';
            if($costcenter != ''){
                if(is_array($costcenter)){
                    $whereCC .= ' AND cc.ID IN (';
                    foreach($costcenter as $elem){
                        $elem = cleanStr($elem);
                        $whereCC .= $elem . ',';
                    }
                    $whereCC = substr($whereCC, 0, -1);
                    $whereCC .= ')';
                }else{
                    $whereCC .= " AND cc.ID = $costcenter";
                }
            }

            if($client != null && $client != ''){
                $where .= "  AND c.clientID = $client";
            }else{
                if($type != ''){
                    switch($type){
                        case 'PD':
                            $where .= '  AND e.clientType = 1 AND et.expedientTypeID = 1';
                        break;
                        case 'ED':
                            $where .= '  AND e.clientType = 3 AND et.expedientTypeID = 1';
                        break;
                        case 'SD':
                            $where .= '  AND e.clientType = 2 AND et.expedientTypeID = 1';
                        break;
                        case 'PV':
                            $where .= '  AND e.clientType = 1 AND et.expedientTypeID = 3';
                        break;
                        case 'EV':
                            $where .= '  AND e.clientType = 3 AND et.expedientTypeID = 3';
                        break;
                        case 'SV':
                            $where .= '  AND e.clientType = 2 AND et.expedientTypeID = 3';
                        break;
                    }
                }
            }

            if($type != ''){
                if($clientFilter != 0){
                    $where .= ' AND c.clientID NOT IN (';
                    foreach($clientFilter as $elem){
                        $elem = cleanStr($elem);
                        $where .= $elem . ',';
                    }
                    $where = substr($where, 0, -1);
                    $where .= ')';
                }
            }

            if($paid == 0){ // Pendiente de cobro
                $where .= " 
                    AND (
                            (
                                (
                                    SELECT  COALESCE(SUM(ip.amount), 0) as total
                                    FROM    Invoices_Payments ip
                                    WHERE   ip.invoice = i.ID AND ip.leavingDate IS NULL
                                ) >= 0 
                                AND
                                ABS(ROUND(i.total, 2)) > 
                                ABS(
                                    (
                                        SELECT  COALESCE(SUM(ip.amount), 0) as total
                                        FROM    Invoices_Payments ip
                                        WHERE   ip.invoice = i.ID AND ip.leavingDate IS NULL
                                    )
                                )
                            )
                            OR
                            (
                                (
                                    SELECT  COALESCE(SUM(ip.amount), 0) as total
                                    FROM    Invoices_Payments ip
                                    WHERE   ip.invoice = i.ID AND ip.leavingDate IS NULL
                                ) <= 0
                                AND
                                ABS(
                                    (
                                        SELECT  COALESCE(SUM(ip.amount), 0) as total
                                        FROM    Invoices_Payments ip
                                        WHERE   ip.invoice = i.ID AND ip.leavingDate IS NULL
                                    )
                                ) > 
                                ABS(ROUND(i.total, 2))
                            )
                        )
                    ";
            }else{ // Cobradas o parcialmente cobradas
                $where .= " 
                    AND (
                        SELECT ABS(COALESCE(SUM(ip.amount), 0))
                        FROM Invoices_Payments ip
                        WHERE ip.invoice = i.ID AND ip.leavingDate IS NULL
                    ) > 0
                ";
            }

            // Get iva types
            $ivaTypes = [];
            $result = $db->query("  SELECT      it.percentage,
                                                0 as total
                                    FROM        IVA_Types it
                                    WHERE       it.leavingDate IS NULL AND
                                                (it.type IS NULL OR it.type = 1)
                                    ORDER BY    it.percentage ASC 
            ");
            if(mysqli_num_rows($result) > 0){
                $ivaTypes = $db->resultToArray($result);
            }

            if($costcenter == ''){ //TOTALES
                $result = $db->query(
                    "       SELECT      e.expedientID, i.ID as invoiceID
                            FROM        Invoices i, Expedients e, Clients c, Expedients_Types et
                            WHERE       i.expedient = e.expedientID AND
                                        i.leavingDate IS NULL AND 
                                        e.client = c.clientID AND
                                        e.leavingDate IS NULL AND
                                        et.expedientTypeID = e.type AND
                                        e.type = $expedientType AND
                                        i.invoice_type != 3 AND
                                        (
                                            (
                                                i.ID = (
                                                    SELECT  MAX(i2.ID)
                                                    FROM    Invoices i2
                                                    WHERE   i2.leavingDate IS NULL AND
                                                            i2.invoice_type != 3 AND
                                                            i2.expedient = i.expedient AND 
                                                            (
                                                                i2.rectified_type IS NULL OR 
                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                            )
                                                )
                                            ) OR
                                            (
                                                i.rectified_type = 2
                                            )
                                        )
                                        $where
                            ORDER BY    e.expedientID
                ");

                if(mysqli_num_rows($result) > 0){
                    $expedients = $db->resultToArray($result); 
                    $resultFinal = [];

                    foreach($expedients as $index => $elem){
                        $id = $elem['expedientID'];
                        $invoiceID = $elem['invoiceID'];
                        
                        $result = $db->query("  SELECT      e.expedientID, 
                                                            e.number, YEAR(e.requestDate) as year, 
                                                            c.name as clientName, 
                                                            c.surname as clientSurname, 
                                                            e.tpv,
                                                            c.clientID, 
                                                            c.name, 
                                                            c.surname, 
                                                            c.price,
                                                            '' as bases, 
                                                            '' as ivas, 
                                                            (
                                                                SELECT  COALESCE(SUM(iniv.base), 0)
                                                                FROM    Invoices_Ivas iniv
                                                                WHERE   iniv.invoice = i.ID AND
                                                                        iniv.deleteDate IS NULL
                                                            ) as bi, 
                                                            i.supplieds as su, 
                                                            (
                                                                SELECT  COALESCE(SUM(iniv.base), 0)
                                                                FROM    Invoices_Ivas iniv
                                                                WHERE   iniv.invoice = i.ID AND
                                                                        iniv.deleteDate IS NULL
                                                            ) as fact,
                                                            (
                                                                SELECT  COALESCE(SUM(iniv.iva), 0)
                                                                FROM    Invoices_Ivas iniv
                                                                WHERE   iniv.invoice = i.ID AND
                                                                        iniv.deleteDate IS NULL
                                                            ) as totalIva, 
                                                            i.total as factTotal,
                                                            i.total as totalInvoice, 
                                                            (
                                                                SELECT  COALESCE(SUM(ip.amount), 0) as total
                                                                FROM    Invoices_Payments ip
                                                                WHERE   ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                            ) as paid,
                                                            i.total - i.pay as pending, 
                                                            i.paymentDate, 
                                                            i.creationDate, 
                                                            i.generatedInvoiceNumber, 
                                                            i.paymentDate,
                                                            i.ID as invoiceID
                                                FROM        Invoices i, Expedients e, Clients c, Expedients_Types et
                                                WHERE       i.expedient = e.expedientID AND
                                                            e.client = c.clientID AND
                                                            e.type = et.expedientTypeID AND
                                                            e.expedientID = $id AND
                                                            i.ID = $invoiceID AND
                                                            e.leavingDate IS NULL AND
                                                            i.leavingDate IS NULL
                                                            $where
                                                ORDER BY    e.expedientID");
                        if(mysqli_num_rows($result) > 0){
                            $dataAux = $db->resultToArray($result);
                            $resultFinal[$index] = $dataAux;

                            $result = $db->query("  SELECT      SUM(eh.total) as cost
                                                    FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                                    LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                                    WHERE       eh.expedient = $id AND 
                                                                eh.num_hiring = (
                                                                    SELECT  MAX(i2.num_hiring) 
                                                                    FROM    Invoices i2 
                                                                    WHERE   i2.expedient = e.expedientID AND
                                                                            i2.leavingDate IS NULL AND
                                                                            i2.invoice_type != 3
                                                                ) AND
                                                                eh.check = 1 AND 
                                                                eh.expedient = e.expedientID AND
                                                                eh.model = pm.productModelID AND
                                                                eh.product = pr.productID AND
                                                                pr.IVA = it.IVATypeID AND
                                                                pr.leavingDate IS NULL AND
                                                                pr.supplied = 1 AND
                                                                pr.isInvoiced = 0");
                            if(mysqli_num_rows($result) > 0){
                                $supplieds = $db->resultToArray($result)[0]['cost']; 
                                if($supplieds == null){
                                    $supplieds = '0.00';
                                }
                                $resultFinal[$index][0]['su'] =  $supplieds;
                                $resultFinal[$index][0]['fact'] =  floatval($resultFinal[$index][0]['fact']) + floatval($supplieds);
                                $resultFinal[$index][0]['factTotal'] = floatval($resultFinal[$index][0]['totalInvoice']);
                            }
                            
                            $resultFinal[$index][0]['bases'] = $ivaTypes;
                            $resultFinal[$index][0]['ivas'] = $ivaTypes;

                            $expedientID = $resultFinal[$index][0]['expedientID'];

                            // Get invoices bases
                            $resultInvoiceBases = $db->query("   SELECT     iniv.typeIva,
                                                                            iniv.base
                                                                FROM        Invoices_Ivas iniv
                                                                WHERE       iniv.deleteDate IS NULL AND
                                                                            iniv.invoice = $invoiceID
                            ");

                            if(mysqli_num_rows($resultInvoiceBases) > 0){
                                $invoiceBases = $db->resultToArray($resultInvoiceBases);
                                foreach($invoiceBases as $invoiceIv){
                                    $keys = array_column($resultFinal[$index][0]['bases'], 'percentage');
                                    $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                    if($indexAux !== false) {
                                        $resultFinal[$index][0]['bases'][$indexAux]['total'] += floatval($invoiceIv['base']);
                                    }
                                }
                            }

                            // Get invoices ivas
                            $resultInvoiceIvas = $db->query("   SELECT     iniv.typeIva,
                                                                            iniv.iva
                                                                FROM        Invoices_Ivas iniv
                                                                WHERE       iniv.deleteDate IS NULL AND
                                                                            iniv.invoice = $invoiceID
                            ");
                            if(mysqli_num_rows($resultInvoiceIvas) > 0){
                                $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                                foreach($invoiceIvas as $invoiceIv){
                                    $keys = array_column($resultFinal[$index][0]['ivas'], 'percentage');
                                    $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                    if($indexAux !== false) {
                                        $resultFinal[$index][0]['ivas'][$indexAux]['total'] += floatval($invoiceIv['iva']);
                                    }
                                }
                            }
                        }
                    }
                }else{
                    return null;
                }  

            }else if($costcenter == '0'){ //OTRAS INSTALACIONES

                $result = $db->query(
                    "   SELECT      e.expedientID, i.ID as invoiceID
                        FROM        (Invoices i, Expedients e, Clients c, Expedients_Types et, Clients_Types ct)
                        LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                        WHERE       i.expedient = e.expedientID AND
                                    e.client = c.clientID AND
                                    e.leavingDate IS NULL AND
                                    i.leavingDate IS NULL AND 
                                    et.expedientTypeID = e.type AND
                                    e.clientType = ct.clientTypeID AND
                                    e.type = $expedientType AND
                                    (SELECT COUNT(*) FROM Cost_Center cc WHERE cc.mortuary = m.mortuaryID) = 0 AND
                                    i.invoice_type != 3 AND
                                    (
                                        (
                                            i.ID = (
                                                SELECT  MAX(i2.ID)
                                                FROM    Invoices i2
                                                WHERE   i2.leavingDate IS NULL AND
                                                        i2.invoice_type != 3 AND
                                                        i2.expedient = i.expedient AND 
                                                        (
                                                            i2.rectified_type IS NULL OR 
                                                            (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                        )
                                            )
                                        ) OR
                                        (
                                            i.rectified_type = 2
                                        )
                                    )
                                    $where
                        ORDER BY    e.expedientID
                ");

                if(mysqli_num_rows($result) > 0){
                    $expedients = $db->resultToArray($result); 
                    $resultFinal = [];

                    foreach($expedients as $index => $elem){
                        $id = $elem['expedientID'];
                        $invoiceID = $elem['invoiceID'];

                        $result = $db->query("  SELECT      e.expedientID, 
                                                            e.number, 
                                                            YEAR(e.requestDate) as year, 
                                                            c.name as clientName, 
                                                            c.surname as clientSurname, 
                                                            e.tpv,
                                                            c.clientID, 
                                                            c.name, 
                                                            c.surname, 
                                                            c.price,
                                                            '' as bases,
                                                            '' as ivas,
                                                            (
                                                                SELECT  COALESCE(SUM(iniv.base), 0)
                                                                FROM    Invoices_Ivas iniv
                                                                WHERE   iniv.invoice = i.ID AND
                                                                        iniv.deleteDate IS NULL
                                                            ) as bi, 
                                                            i.supplieds as su, 
                                                            (
                                                                SELECT  COALESCE(SUM(iniv.base), 0)
                                                                FROM    Invoices_Ivas iniv
                                                                WHERE   iniv.invoice = i.ID AND
                                                                        iniv.deleteDate IS NULL
                                                            ) as fact,
                                                            (
                                                                SELECT  COALESCE(SUM(iniv.iva), 0)
                                                                FROM    Invoices_Ivas iniv
                                                                WHERE   iniv.invoice = i.ID AND
                                                                        iniv.deleteDate IS NULL
                                                            ) as totalIva, 
                                                            i.total as factTotal,
                                                            i.total as totalInvoice, 
                                                            (
                                                                SELECT  COALESCE(SUM(ip.amount), 0) as total
                                                                FROM    Invoices_Payments ip
                                                                WHERE   ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                            ) as paid,
                                                            i.total - i.pay as pending, 
                                                            i.paymentDate, 
                                                            i.creationDate, 
                                                            i.generatedInvoiceNumber, 
                                                            i.paymentDate,
                                                            i.ID as invoiceID
                                                FROM        (Invoices i, Expedients e, Clients c, Expedients_Types et)
                                                LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                                WHERE       i.expedient = e.expedientID AND
                                                            e.client = c.clientID AND
                                                            e.type = et.expedientTypeID AND
                                                            e.expedientID = $id AND
                                                            i.ID = $invoiceID AND
                                                            e.leavingDate IS NULL AND
                                                            i.leavingDate IS NULL
                                                            $where
                                                ORDER BY    e.expedientID");

                        if(mysqli_num_rows($result) > 0){
                            $dataAux = $db->resultToArray($result);
                            $resultFinal[$index] = $dataAux;

                            $result = $db->query("  SELECT      SUM(eh.total) as cost
                                                    FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                                    LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                                    WHERE       eh.expedient = $id AND 
                                                                eh.num_hiring = (
                                                                    SELECT  MAX(i2.num_hiring) 
                                                                    FROM    Invoices i2 
                                                                    WHERE   i2.expedient = e.expedientID AND
                                                                            i2.leavingDate IS NULL AND
                                                                            i2.invoice_type != 3
                                                                ) AND
                                                                eh.check = 1 AND 
                                                                eh.expedient = e.expedientID AND
                                                                eh.model = pm.productModelID AND
                                                                eh.product = pr.productID AND
                                                                pr.IVA = it.IVATypeID AND
                                                                pr.leavingDate IS NULL AND
                                                                pr.supplied = 1 AND
                                                                pr.isInvoiced = 0");
                            if(mysqli_num_rows($result) > 0){
                                $supplieds = $db->resultToArray($result)[0]['cost']; 
                                if($supplieds == null){
                                    $supplieds = '0.00';
                                }
                                $resultFinal[$index][0]['su'] =  $supplieds;
                                $resultFinal[$index][0]['fact'] =  floatval($resultFinal[$index][0]['fact']) + floatval($supplieds);
                                $resultFinal[$index][0]['factTotal'] = floatval($resultFinal[$index][0]['totalInvoice']);
                            }

                            $resultFinal[$index][0]['bases'] = $ivaTypes;
                            $resultFinal[$index][0]['ivas'] = $ivaTypes;

                            $invoiceID = $resultFinal[$index][0]['invoiceID'];

                            // Get invoices bases
                            $resultInvoiceBases = $db->query("   SELECT     iniv.typeIva,
                                                                            iniv.base
                                                                FROM        Invoices_Ivas iniv
                                                                WHERE       iniv.deleteDate IS NULL AND
                                                                            iniv.invoice = $invoiceID
                            ");
                            
                            if(mysqli_num_rows($resultInvoiceBases) > 0){
                                $invoiceBases = $db->resultToArray($resultInvoiceBases);
                                foreach($invoiceBases as $invoiceIv){
                                    $keys = array_column($resultFinal[$index][0]['bases'], 'percentage');
                                    $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                    if($indexAux !== false) {
                                        $resultFinal[$index][0]['bases'][$indexAux]['total'] += floatval($invoiceIv['base']);
                                    }
                                }
                            }

                            // Get invoices ivas
                            $resultInvoiceIvas = $db->query("   SELECT     iniv.typeIva,
                                                                            iniv.iva
                                                                FROM        Invoices_Ivas iniv
                                                                WHERE       iniv.deleteDate IS NULL AND
                                                                            iniv.invoice = $invoiceID
                            ");
                            if(mysqli_num_rows($resultInvoiceIvas) > 0){
                                $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                                foreach($invoiceIvas as $invoiceIv){
                                    $keys = array_column($resultFinal[$index][0]['ivas'], 'percentage');
                                    $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                    if($indexAux !== false) {
                                        $resultFinal[$index][0]['ivas'][$indexAux]['total'] += floatval($invoiceIv['iva']);
                                    }
                                }
                            }
                        }
                    }
                }else{
                    return null;
                }  

            }else{ // POR CENTRO DE COSTE
                $result = $db->query(
                    "       SELECT      e.expedientID, i.ID as invoiceID
                            FROM        Invoices i, Expedients e, Clients c, Expedients_Types et, Clients_Types ct, Cost_Center cc
                            WHERE       i.expedient = e.expedientID AND
                                        i.leavingDate IS NULL AND 
                                        e.client = c.clientID AND
                                        e.leavingDate IS NULL AND
                                        et.expedientTypeID = e.type AND
                                        e.clientType = ct.clientTypeID AND
                                        e.deceasedMortuary = cc.mortuary AND
                                        e.type = $expedientType AND
                                        i.invoice_type != 3 AND
                                        (
                                            (
                                                i.ID = (
                                                    SELECT  MAX(i2.ID)
                                                    FROM    Invoices i2
                                                    WHERE   i2.leavingDate IS NULL AND
                                                            i2.invoice_type != 3 AND
                                                            i2.expedient = i.expedient AND 
                                                            (
                                                                i2.rectified_type IS NULL OR 
                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                            )
                                                )
                                            ) OR
                                            (
                                                i.rectified_type = 2
                                            )
                                        )
                                        $where
                                        $whereCC
                            ORDER BY    e.expedientID
                ");

                if(mysqli_num_rows($result) > 0){
                    $expedients = $db->resultToArray($result); 
                    $resultFinal = [];

                    foreach($expedients as $index => $elem){
                        $id = $elem['expedientID'];
                        $invoiceID = $elem['invoiceID'];

                        $result = $db->query("  SELECT      e.expedientID, e.number, YEAR(e.requestDate) as year, c.name as clientName, c.surname as clientSurname, e.tpv,
                                                            c.clientID, c.name, c.surname, c.price,
                                                            '' as bases,
                                                            '' as ivas,
                                                            (
                                                                SELECT  COALESCE(SUM(iniv.base), 0)
                                                                FROM    Invoices_Ivas iniv
                                                                WHERE   iniv.invoice = i.ID AND
                                                                        iniv.deleteDate IS NULL
                                                            ) as bi, 
                                                            i.supplieds as su, 
                                                            (
                                                                SELECT  COALESCE(SUM(iniv.base), 0)
                                                                FROM    Invoices_Ivas iniv
                                                                WHERE   iniv.invoice = i.ID AND
                                                                        iniv.deleteDate IS NULL
                                                            ) as fact,
                                                            (
                                                                SELECT  COALESCE(SUM(iniv.iva), 0)
                                                                FROM    Invoices_Ivas iniv
                                                                WHERE   iniv.invoice = i.ID AND
                                                                        iniv.deleteDate IS NULL
                                                            ) as totalIva, 
                                                            i.total as factTotal,
                                                            i.total as totalInvoice, 
                                                            (
                                                                SELECT  COALESCE(SUM(ip.amount), 0) as total
                                                                FROM    Invoices_Payments ip
                                                                WHERE   ip.invoice = i.ID AND ip.leavingDate IS NULL
                                                            ) as paid,
                                                            i.total - i.pay as pending, i.paymentDate, i.creationDate, i.generatedInvoiceNumber, i.paymentDate
                                                FROM        Invoices i, Expedients e, Clients c, Expedients_Types et, Cost_Center cc
                                                WHERE       i.expedient = e.expedientID AND
                                                            e.client = c.clientID AND
                                                            e.type = et.expedientTypeID AND
                                                            e.expedientID = $id AND
                                                            i.ID = $invoiceID AND
                                                            e.leavingDate IS NULL AND
                                                            i.leavingDate IS NULL AND
                                                            e.deceasedMortuary = cc.mortuary
                                                            $where
                                                            $whereCC
                                                ORDER BY    e.expedientID");
                        if(mysqli_num_rows($result) > 0){
                            $dataAux = $db->resultToArray($result);
                            $resultFinal[$index] = $dataAux;

                            $result = $db->query("  SELECT      SUM(eh.total) as cost
                                                    FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                                    LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                                    WHERE       eh.expedient = $id AND 
                                                                eh.num_hiring = (
                                                                    SELECT  MAX(i2.num_hiring) 
                                                                    FROM    Invoices i2 
                                                                    WHERE   i2.expedient = e.expedientID AND
                                                                            i2.leavingDate IS NULL AND
                                                                            i2.invoice_type != 3
                                                                ) AND
                                                                eh.check = 1 AND 
                                                                eh.expedient = e.expedientID AND
                                                                eh.model = pm.productModelID AND
                                                                eh.product = pr.productID AND
                                                                pr.IVA = it.IVATypeID AND
                                                                pr.leavingDate IS NULL AND
                                                                pr.supplied = 1 AND
                                                                pr.isInvoiced = 0");
                            if(mysqli_num_rows($result) > 0){
                                $supplieds = $db->resultToArray($result)[0]['cost']; 
                                if($supplieds == null){
                                    $supplieds = '0.00';
                                }
                                $resultFinal[$index][0]['su'] =  $supplieds;
                                $resultFinal[$index][0]['fact'] =  floatval($resultFinal[$index][0]['fact']) + floatval($supplieds);
                                $resultFinal[$index][0]['factTotal'] = floatval($resultFinal[$index][0]['totalInvoice']);
                            }

                            $resultFinal[$index][0]['bases'] = $ivaTypes;
                            $resultFinal[$index][0]['ivas'] = $ivaTypes;

                            $expedientID = $resultFinal[$index][0]['expedientID'];

                            // Get invoices bases
                            $resultInvoiceBases = $db->query("   SELECT     iniv.typeIva,
                                                                            iniv.base
                                                                FROM        Invoices_Ivas iniv
                                                                WHERE       iniv.deleteDate IS NULL AND
                                                                            iniv.invoice = $invoiceID
                            ");
                                                        
                            if(mysqli_num_rows($resultInvoiceBases) > 0){
                                $invoiceBases = $db->resultToArray($resultInvoiceBases);
                                foreach($invoiceBases as $invoiceIv){
                                    $keys = array_column($resultFinal[$index][0]['bases'], 'percentage');
                                    $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                    if($indexAux !== false) {
                                        $resultFinal[$index][0]['bases'][$indexAux]['total'] += floatval($invoiceIv['base']);
                                    }
                                }
                            }

                            // Get invoices ivas
                            $resultInvoiceIvas = $db->query("   SELECT      iniv.typeIva,
                                                                            iniv.iva
                                                                FROM        Invoices_Ivas iniv
                                                                WHERE       iniv.deleteDate IS NULL AND
                                                                            iniv.invoice = $invoiceID
                            ");

                            if(mysqli_num_rows($resultInvoiceIvas) > 0){
                                $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                                foreach($invoiceIvas as $invoiceIv){
                                    $keys = array_column($resultFinal[$index][0]['ivas'], 'percentage');
                                    $indexAux = array_search($invoiceIv['typeIva'], $keys);

                                    if($indexAux !== false) {
                                        $resultFinal[$index][0]['ivas'][$indexAux]['total'] += floatval($invoiceIv['iva']);
                                    }
                                }
                            }
                        }
                    }
                }else{
                    return null;
                }  
            }
           
            return  $resultFinal;
        }

        /**
         * Obtiene los datos del cremaciones para el cuadro de mando
         * 
         * @param int $date Fecha
         * @param int $dateSince Fecha desde
         * @param int $dateUntil Fecha hasta
         * @param int $mortuary Centro de coste
         * @param int $clientType Tipos de cliente
         * @param int $client Clientes
         * @return array
         */
        public function getControlPanelCremations($date, $dateSince, $dateUntil, $mortuary, $clientType, $client){
            $db = new DbHandler;

            $date = cleanStr($date);
            $dateSince = cleanStr($dateSince);
            $dateUntil = cleanStr($dateUntil);

            $where = '';
            $whereCC = '';
            if($date == ''){
                if($dateSince != '' && $dateUntil != ''){
                    $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                }
            }else{
                $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
            }

            if($mortuary != ''){
                $whereCC .= " AND (";
                foreach($mortuary as $elem){
                    $elem = cleanStr($elem);
                    $whereCC .= " cc.ID = $elem OR";
                }
                $whereCC = substr($whereCC, 0, -3);
                $whereCC .= ")";
            }else{
                $whereCC .= " AND cc.mortuary != 0";
            }

            $showParticular = false;
            $showEmpresa = false;
            $showSeguro = false;
            if($clientType != ''){
                $where .= ' AND e.clientType IN (';
                foreach($clientType as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                    if($elem == 1){
                        $showParticular = true;
                    }
                    if($elem == 2){
                        $showSeguro = true;
                    }
                    if($elem == 3){
                        $showEmpresa = true;
                    }
                }
                $where = substr($where, 0, -1);
                $where .= ')';
            }

            if($client != ''){
                $where .= ' AND c.clientID NOT IN (';
                foreach($client as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                }
                $where = substr($where, 0, -1);
                $where .= ')';
            }
            
            $resultFinal = [];
            $result = $db->query("  SELECT      *
                                    FROM        Cost_Center cc
                                    WHERE       cc.leavingDate IS NULL
                                                $whereCC");


            if(mysqli_num_rows($result) == 0){
                
            }else{
                $costcenters = $db->resultToArray($result);

                foreach($costcenters as $index => $elem){
                    $resultTanatorio = [];
                    $ccID = $elem['ID'];
                    $costName = $elem['name'];

                    $whereCC = ' AND cc.ID = ' . $ccID; 

                    $result = $db->query(
                        "       SELECT      e.expedientID, e.type as expedientType, 
                                            e.clientType as clientType, 
                                            c.clientID, 
                                            c.name, 
                                            c.surname, 
                                            c.price, 
                                            pr.name as priceName, 
                                            YEAR(e.requestDate) as year
                                FROM        (Expedients e, Clients c, Prices pr, Cost_Center cc)
                                LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                WHERE       e.cremation = 1 AND e.crematoriumEvent IS NOT NULL AND
                                            e.client = c.clientID AND
                                            c.price = pr.priceID AND
                                            e.leavingDate IS NULL AND
                                            e.deceasedMortuary = cc.mortuary AND
                                            (
                                                SELECT  COUNT(*)
                                                FROM    Invoices inv
                                                WHERE   inv.expedient = e.expedientID AND
                                                        inv.leavingDate IS NULL
                                            ) > 0
                                            $where
                                            $whereCC
                    ");

                    if(mysqli_num_rows($result) == 0){
                        $particularDEF = array(1,'Particulares - Defunción',0,0,0,0,'PD','');
                        $empresaDEF = array(2,'Empresas - Defunción',0,0,0,0,'ED','');
                        $seguroDEF = array(3,'Seguros - Defunción',0,0,0,0,'SD','');
                        $particularVAR = array(4,'Particulares - Varios',0,0,0,0,'PV','');
                        $empresaVAR = array(5,'Empresas - Varios',0,0,0,0,'EV','');
                        $seguroVAR = array(6,'Seguros - Varios',0,0,0,0,'SV','');

                        if($clientType != ''){
                            if($showParticular && $showEmpresa && $showSeguro){ //000
                                array_push($resultTanatorio, $particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR);
                            }else if($showParticular && $showEmpresa && !$showSeguro){ //001
                                array_push($resultTanatorio, $particularDEF, $empresaDEF, $particularVAR, $empresaVAR);
                            }else if($showParticular && !$showEmpresa && $showSeguro){ //010
                                array_push($resultTanatorio, $particularDEF, $seguroDEF, $particularVAR, $seguroVAR);
                            }else if($showParticular && !$showEmpresa && !$showSeguro){ //011
                                array_push($resultTanatorio, $particularDEF, $particularVAR);
                            }else if(!$showParticular && $showEmpresa && $showSeguro){ //100
                                array_push($resultTanatorio, $empresaDEF, $seguroDEF, $empresaVAR, $seguroVAR);
                            }else if(!$showParticular && $showEmpresa && !$showSeguro){ //101
                                array_push($resultTanatorio, $empresaDEF, $empresaVAR);
                            }else if(!$showParticular && !$showEmpresa && $showSeguro){ //110
                                array_push($resultTanatorio, $seguroDEF, $seguroVAR);
                            }
                        }else{
                            array_push($resultTanatorio, $particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR);
                        }

                        if($client != ''){
                            foreach($client as $elemClient){
    
                                $whereAux = '';
                                $whereAuxCC = '';
                                if($date == ''){
                                    if($dateSince != '' && $dateUntil != ''){
                                        $whereAux .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                                    }
                                }else{
                                    $whereAux .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
                                }
    
                                if($mortuary != ''){
                                    $whereAuxCC .= " AND (";
                                    foreach($mortuary as $elem){
                                        $elem = cleanStr($elem);
                                        $whereAuxCC .= " cc.ID = $elem OR";
                                    }
                                    $whereAuxCC = substr($whereAuxCC, 0, -3);
                                    $whereAuxCC .= ")";
                                }else{
                                    $whereAuxCC .= " AND cc.mortuary != 0";
                                }
    
                                if($clientType != ''){
                                    $whereAux .= ' AND e.clientType IN (';
                                    foreach($clientType as $elem){
                                        $elem = cleanStr($elem);
                                        $whereAux .= $elem . ',';
                                    }
                                    $whereAux = substr($whereAux, 0, -1);
                                    $whereAux .= ')';
                                }
    
                                $whereAux .= " AND c.clientID =  $elemClient";
                                $whereAuxCC = ' AND cc.ID = ' . $ccID; 

                                $clientResult = $this->getControlPanelCremationsClient($whereAux, $whereAuxCC, $elemClient, 1);
                                array_push($resultTanatorio, $clientResult);
                                $clientResult = $this->getControlPanelCremationsClient($whereAux, $whereAuxCC, $elemClient, 3);
                                array_push($resultTanatorio, $clientResult);
                            }
                        }
                        
                        array_push($resultFinal, [$ccID, $costName, $resultTanatorio]);

                    }else{
                        $data = $db->resultToArray($result);

                        $particularDEF = array(1,'Particulares - Defunción',0,0,0,0,'PD','');
                        $empresaDEF = array(2,'Empresas - Defunción',0,0,0,0,'ED','');
                        $seguroDEF = array(3,'Seguros - Defunción',0,0,0,0,'SD','');
                        $particularVAR = array(4,'Particulares - Varios',0,0,0,0,'PV','');
                        $empresaVAR = array(5,'Empresas - Varios',0,0,0,0,'EV','');
                        $seguroVAR = array(6,'Seguros - Varios',0,0,0,0,'SV','');

                        foreach($data as $index => $elem){



                            $id = $elem['expedientID'];
                            $price = $elem['price'];
                            $priceName = $elem['priceName'];
                            $year = $elem['year'];
                            $clientTypeExp = $elem['clientType'];
                            $expedientType = $elem['expedientType'];
                            
                            // Tarifa para el año y el cliente del expediente
                            $purchasePriceParticularDEF = 0;
                            $purchasePriceEmpresaDEF = 0;
                            $purchasePriceSeguroDEF = 0;
                            $purchasePriceParticularVAR = 0;
                            $purchasePriceEmpresaVAR = 0;
                            $purchasePriceSeguroVAR = 0;

                            $priceNoIVAParticularDEF = 0;
                            $priceNoIVAEmpresaDEF = 0;
                            $priceNoIVASeguroDEF = 0;
                            $priceNoIVAParticularVAR = 0;
                            $priceNoIVAEmpresaVAR = 0;
                            $priceNoIVASeguroVAR = 0;

                            $grossMarginParticularDEF = 0;
                            $grossMarginEmpresaDEF = 0;
                            $grossMarginSeguroDEF = 0;
                            $grossMarginParticularVAR = 0;
                            $grossMarginEmpresaVAR = 0;
                            $grossMarginSeguroVAR = 0;

                            $result = $db->query("  SELECT  SUM((pp.priceNoIVA * it.percentage / 100 + pp.priceNoIVA) * eh.amount - ((pp.priceNoIVA * it.percentage / 100 + pp.priceNoIVA) * eh.discount / 100) * eh.amount) as fact,
                                                            SUM(eh.amount * (pp.priceNoIVA - pp.priceNoIva * eh.discount / 100)) as bi
                                                    FROM    Expedients e, Expedients_Hirings eh, Products p, Products_Prices pp, Products_Models pm, IVA_Types it, Prices pr
                                                    WHERE   e.expedientID = eh.expedient  
                                                            AND eh.product = p.productID
                                                            AND eh.model = pm.productModelID
                                                            AND pm.product = p.productID
                                                            AND pm.productModelID = pp.model
                                                            AND pp.price = pr.priceID
                                                            AND p.IVA = it.IVATypeID
                                                            AND p.blockBelow = 6
                                                            AND eh.check = 1 
                                                            AND pr.year = YEAR(e.requestDate)
                                                            AND pr.name LIKE '%$priceName%'
                                                            AND e.leavingDate IS NULL
                                                            AND e.expedientID = $id 
                                                            AND eh.num_hiring = (
                                                                SELECT  MAX(i2.num_hiring) 
                                                                FROM    Invoices i2 
                                                                WHERE   i2.expedient = e.expedientID AND
                                                                        i2.leavingDate IS NULL AND
                                                                        i2.invoice_type != 3
                                                            )
                            ");

                            if(mysqli_num_rows($result) == 0){
                                continue;
                            }else{
                                $resultAux = $db->resultToArray($result)[0];
                                $fact = $resultAux['fact'];
                                $bi = $resultAux['bi'];

                                if($expedientType == 1 && $clientTypeExp == 1){
                                    $particularDEF[2]++;
                                    $particularDEF[3] += $fact;
                                    $particularDEF[4] += $bi;
                                }else if($expedientType == 1 && $clientTypeExp == 3){
                                    $empresaDEF[2]++;
                                    $empresaDEF[3]+=$fact;
                                    $empresaDEF[4]+=$bi;
                                }else if($expedientType == 1 && $clientTypeExp == 2){
                                    $seguroDEF[2]++;
                                    $seguroDEF[3]+=$fact;
                                    $seguroDEF[4]+=$bi;
                                }else if($expedientType == 3 && $clientTypeExp == 1){ 
                                    $particularVAR[2]++;
                                    $particularVAR[3]+=$fact;
                                    $particularVAR[4]+=$bi;
                                }else if($expedientType == 3 && $clientTypeExp == 3){
                                    $empresaVAR[2]++;
                                    $empresaVAR[3]+=$fact;
                                    $empresaVAR[4]+=$bi;
                                }else if($expedientType == 3 && $clientTypeExp == 2){
                                    $seguroVAR[2]++;
                                    $seguroVAR[3]+=$fact;
                                    $seguroVAR[4]+=$bi;
                                }

                                $result = $db->query("  SELECT  SUM(pr.purchasePrice) as purchasePrice, 
                                                                SUM(pp.priceNoIVA - (pp.priceNoIVA * eh.discount/100)) as priceNoIVA
                                                        FROM    Expedients_Hirings eh, Products_Retails pr, Products_Prices pp, Products p
                                                        WHERE   eh.expedient = $id AND
                                                                eh.check = 1 AND
                                                                eh.product = p.productID AND
                                                                p.blockBelow = 6 AND
                                                                pr.model = eh.model AND
                                                                pr.year =  $year AND
                                                                pp.model = eh.model AND
                                                                pp.price = $price AND
                                                                eh.num_hiring = (
                                                                    SELECT  MAX(i2.num_hiring) 
                                                                    FROM    Invoices i2 
                                                                    WHERE   i2.expedient = $id AND
                                                                            i2.leavingDate IS NULL AND
                                                                            i2.invoice_type != 3
                                                                )
                                ");

                                if(mysqli_num_rows($result) > 0){
                                    $prices = $db->resultToArray($result);
                                    foreach($prices as $price){
                                        if($expedientType == 1 && $clientTypeExp == 1){
                                            $purchasePriceParticularDEF+=floatval($price['purchasePrice']);
                                            $priceNoIVAParticularDEF+=floatval($price['priceNoIVA']);
                                            $particularDEF[5]+=(floatval($priceNoIVAParticularDEF) - floatval($purchasePriceParticularDEF));
                                        }else if($expedientType == 1 && $clientTypeExp == 3){
                                            $purchasePriceEmpresaDEF+=floatval($price['purchasePrice']);
                                            $priceNoIVAEmpresaDEF+=floatval($price['priceNoIVA']);
                                            $empresaDEF[5]+=(floatval($priceNoIVAEmpresaDEF) - floatval($purchasePriceEmpresaDEF));
                                        }else if($expedientType == 1 && $clientTypeExp == 2){
                                            $purchasePriceSeguroDEF+=floatval($price['purchasePrice']);
                                            $priceNoIVASeguroDEF+=floatval($price['priceNoIVA']);
                                            $seguroDEF[5]+=(floatval($priceNoIVASeguroDEF) - floatval($purchasePriceSeguroDEF));
                                        }else if($expedientType == 3 && $clientTypeExp == 1){ 
                                            $purchasePriceParticularVAR+=floatval($price['purchasePrice']);
                                            $priceNoIVAParticularVAR+=floatval($price['priceNoIVA']);
                                            $particularVAR[5]+=(floatval($priceNoIVAParticularVAR) - floatval($purchasePriceParticularVAR));
                                        }else if($expedientType == 3 && $clientTypeExp == 3){
                                            $purchasePriceEmpresaVAR+=floatval($price['purchasePrice']);
                                            $priceNoIVAEmpresaVAR+=floatval($price['priceNoIVA']);
                                            $empresaVAR[5]+=(floatval($priceNoIVAEmpresaVAR) - floatval($purchasePriceEmpresaVAR));
                                        }else if($expedientType == 3 && $clientTypeExp == 2){
                                            $purchasePriceSeguroVAR+=floatval($price['purchasePrice']);
                                            $priceNoIVASeguroVAR+=floatval($price['priceNoIVA']);
                                            $seguroVAR[5]+=(floatval($priceNoIVASeguroVAR) - floatval($purchasePriceSeguroVAR));
                                        }
                                    }
                                }
                            }
                        }

                        if($clientType != ''){
                            if($showParticular && $showEmpresa && $showSeguro){ //000
                                array_push($resultTanatorio, $particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR);
                            }else if($showParticular && $showEmpresa && !$showSeguro){ //001
                                array_push($resultTanatorio, $particularDEF, $empresaDEF, $particularVAR, $empresaVAR);
                            }else if($showParticular && !$showEmpresa && $showSeguro){ //010
                                array_push($resultTanatorio, $particularDEF, $seguroDEF, $particularVAR, $seguroVAR);
                            }else if($showParticular && !$showEmpresa && !$showSeguro){ //011
                                array_push($resultTanatorio, $particularDEF, $particularVAR);
                            }else if(!$showParticular && $showEmpresa && $showSeguro){ //100
                                array_push($resultTanatorio, $empresaDEF, $seguroDEF, $empresaVAR, $seguroVAR);
                            }else if(!$showParticular && $showEmpresa && !$showSeguro){ //101
                                array_push($resultTanatorio, $empresaDEF, $empresaVAR);
                            }else if(!$showParticular && !$showEmpresa && $showSeguro){ //110
                                array_push($resultTanatorio, $seguroDEF, $seguroVAR);
                            }
                        }else{
                            array_push($resultTanatorio, $particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR);
                        }

                        if($client != ''){
                            foreach($client as $elemClient){
    
                                $whereAux = '';
                                $whereAuxCC = '';
                                if($date == ''){
                                    if($dateSince != '' && $dateUntil != ''){
                                        $whereAux .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                                    }
                                }else{
                                    $whereAux .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
                                }
    
                                if($mortuary != ''){
                                    $whereAuxCC .= " AND (";
                                    foreach($mortuary as $elem){
                                        $elem = cleanStr($elem);
                                        $whereAuxCC .= " cc.ID = $elem OR";
                                    }
                                    $whereAuxCC = substr($whereAuxCC, 0, -3);
                                    $whereAuxCC .= ")";
                                }else{
                                    $whereAuxCC .= " AND cc.mortuary != 0";
                                }
    
                                if($clientType != ''){
                                    $whereAux .= ' AND e.clientType IN (';
                                    foreach($clientType as $elem){
                                        $elem = cleanStr($elem);
                                        $whereAux .= $elem . ',';
                                    }
                                    $whereAux = substr($whereAux, 0, -1);
                                    $whereAux .= ')';
                                }
    
                                $whereAux .= " AND c.clientID =  $elemClient";
                                $whereAuxCC = ' AND cc.ID = ' . $ccID;

                                $clientResult = $this->getControlPanelCremationsClient($whereAux, $whereAuxCC, $elemClient,1);
                                array_push($resultTanatorio, $clientResult);
                                $clientResult = $this->getControlPanelCremationsClient($whereAux, $whereAuxCC, $elemClient,3);
                                array_push($resultTanatorio, $clientResult);
                            }
                        }
                        array_push($resultFinal, [$ccID, $costName, $resultTanatorio]);
                    }
                }
            }

            $resultTanatorio = [];
            $ccID = 0;
            $costName = 'Otras instalaciones';

            $result = $db->query(
                "       SELECT      e.expedientID, e.type as expedientType, e.clientType as clientType, c.clientID, c.name, c.surname, c.price, pr.name as priceName, YEAR(e.requestDate) as year
                        FROM        (Expedients e, Clients c, Prices pr)
                        LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                        WHERE       e.cremation = 1 AND e.crematoriumEvent IS NOT NULL AND
                                    e.client = c.clientID AND
                                    c.price = pr.priceID AND
                                    e.leavingDate IS NULL AND
                                    (
                                        SELECT  COUNT(*)
                                        FROM    Invoices inv
                                        WHERE   inv.expedient = e.expedientID AND
                                                inv.leavingDate IS NULL
                                    ) > 0 AND
                                    (SELECT COUNT(*) FROM Cost_Center cc WHERE cc.mortuary = m.mortuaryID) = 0
                                    $where
            ");


            if(mysqli_num_rows($result) == 0){
                $particularDEF = array(1,'Particulares - Defunción',0,0,0,0,'PD','');
                $empresaDEF = array(2,'Empresas - Defunción',0,0,0,0,'ED','');
                $seguroDEF = array(3,'Seguros - Defunción',0,0,0,0,'SD','');
                $particularVAR = array(4,'Particulares - Varios',0,0,0,0,'PV','');
                $empresaVAR = array(5,'Empresas - Varios',0,0,0,0,'EV','');
                $seguroVAR = array(6,'Seguros - Varios',0,0,0,0,'SV','');

                if($clientType != ''){
                    if($showParticular && $showEmpresa && $showSeguro){ //000
                        array_push($resultTanatorio, $particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR);
                    }else if($showParticular && $showEmpresa && !$showSeguro){ //001
                        array_push($resultTanatorio, $particularDEF, $empresaDEF, $particularVAR, $empresaVAR);
                    }else if($showParticular && !$showEmpresa && $showSeguro){ //010
                        array_push($resultTanatorio, $particularDEF, $seguroDEF, $particularVAR, $seguroVAR);
                    }else if($showParticular && !$showEmpresa && !$showSeguro){ //011
                        array_push($resultTanatorio, $particularDEF, $particularVAR);
                    }else if(!$showParticular && $showEmpresa && $showSeguro){ //100
                        array_push($resultTanatorio, $empresaDEF, $seguroDEF, $empresaVAR, $seguroVAR);
                    }else if(!$showParticular && $showEmpresa && !$showSeguro){ //101
                        array_push($resultTanatorio, $empresaDEF, $empresaVAR);
                    }else if(!$showParticular && !$showEmpresa && $showSeguro){ //110
                        array_push($resultTanatorio, $seguroDEF, $seguroVAR);
                    }
                }else{
                    array_push($resultTanatorio, $particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR);
                }

                if($client != ''){
                    foreach($client as $elemClient){

                        $whereAux = '';
                        $whereAuxCC = '';
                        if($date == ''){
                            if($dateSince != '' && $dateUntil != ''){
                                $whereAux .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                            }
                        }else{
                            $whereAux .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
                        }

                        if($mortuary != ''){
                            $whereAuxCC .= " AND (";
                            foreach($mortuary as $elem){
                                $elem = cleanStr($elem);
                                $whereAuxCC .= " cc.ID = $elem OR";
                            }
                            $whereAuxCC = substr($whereAuxCC, 0, -3);
                            $whereAuxCC .= ")";
                        }else{
                            $whereAuxCC .= " AND cc.mortuary != 0";
                        }

                        if($clientType != ''){
                            $whereAux .= ' AND e.clientType IN (';
                            foreach($clientType as $elem){
                                $elem = cleanStr($elem);
                                $whereAux .= $elem . ',';
                            }
                            $whereAux = substr($whereAux, 0, -1);
                            $whereAux .= ')';
                        }

                        $whereAux .= " AND c.clientID =  $elemClient";
                        $whereAuxCC = ' AND cc.ID = ' . $ccID; 
                        
                        $clientResult = $this->getControlPanelCremationsClientOthers($whereAux, $elemClient,1);
                        array_push($resultTanatorio, $clientResult);
                        $clientResult = $this->getControlPanelCremationsClientOthers($whereAux, $elemClient,3);
                        array_push($resultTanatorio, $clientResult);
                    }
                }

            }else{
                $data = $db->resultToArray($result);

                $particularDEF = array(1,'Particulares - Defunción',0,0,0,0,'PD','');
                $empresaDEF = array(2,'Empresas - Defunción',0,0,0,0,'ED','');
                $seguroDEF = array(3,'Seguros - Defunción',0,0,0,0,'SD','');
                $particularVAR = array(4,'Particulares - Varios',0,0,0,0,'PV','');
                $empresaVAR = array(5,'Empresas - Varios',0,0,0,0,'EV','');
                $seguroVAR = array(6,'Seguros - Varios',0,0,0,0,'SV','');

                foreach($data as $index => $elem){
                    $id = $elem['expedientID'];
                    $price = $elem['price'];
                    $priceName = $elem['priceName'];
                    $year = $elem['year'];
                    $clientTypeExp = $elem['clientType'];
                    $expedientType = $elem['expedientType'];
                    
                    // Tarifa para el año y el cliente del expediente
                    $purchasePriceParticularDEF = 0;
                    $purchasePriceEmpresaDEF = 0;
                    $purchasePriceSeguroDEF = 0;
                    $purchasePriceParticularVAR = 0;
                    $purchasePriceEmpresaVAR = 0;
                    $purchasePriceSeguroVAR = 0;

                    $priceNoIVAParticularDEF = 0;
                    $priceNoIVAEmpresaDEF = 0;
                    $priceNoIVASeguroDEF = 0;
                    $priceNoIVAParticularVAR = 0;
                    $priceNoIVAEmpresaVAR = 0;
                    $priceNoIVASeguroVAR = 0;

                    $grossMarginParticularDEF = 0;
                    $grossMarginEmpresaDEF = 0;
                    $grossMarginSeguroDEF = 0;
                    $grossMarginParticularVAR = 0;
                    $grossMarginEmpresaVAR = 0;
                    $grossMarginSeguroVAR = 0;

                    $result = $db->query("  SELECT  SUM((pp.priceNoIVA * it.percentage / 100 + pp.priceNoIVA) * eh.amount - ((pp.priceNoIVA * it.percentage / 100 + pp.priceNoIVA) * eh.discount / 100) * eh.amount) as fact,
                                                    SUM(eh.amount * (pp.priceNoIVA - pp.priceNoIva * eh.discount / 100)) as bi
                                            FROM    Expedients e, Expedients_Hirings eh, Products p, Products_Prices pp, Products_Models pm, IVA_Types it, Prices pr
                                            WHERE   e.expedientID = eh.expedient  
                                                    AND eh.product = p.productID
                                                    AND eh.model = pm.productModelID
                                                    AND pm.product = p.productID
                                                    AND pm.productModelID = pp.model
                                                    AND pp.price = pr.priceID
                                                    AND p.IVA = it.IVATypeID
                                                    AND p.blockBelow = 6
                                                    AND eh.check = 1 
                                                    AND pr.year = YEAR(e.requestDate)
                                                    AND pr.name LIKE '%$priceName%'
                                                    AND e.leavingDate IS NULL
                                                    AND e.expedientID = $id
                                                    AND eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = e.expedientID AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    )
                    ");

                    if(mysqli_num_rows($result) == 0){
                        continue;
                    }else{
                        $resultAux = $db->resultToArray($result)[0];
                        $fact = $resultAux['fact'];
                        $bi = $resultAux['bi'];

                        if($expedientType == 1 && $clientTypeExp == 1){
                            $particularDEF[2]++;
                            $particularDEF[3] += $fact;
                            $particularDEF[4] += $bi;
                        }else if($expedientType == 1 && $clientTypeExp == 3){
                            $empresaDEF[2]++;
                            $empresaDEF[3]+=$fact;
                            $empresaDEF[4]+=$bi;
                        }else if($expedientType == 1 && $clientTypeExp == 2){
                            $seguroDEF[2]++;
                            $seguroDEF[3]+=$fact;
                            $seguroDEF[4]+=$bi;
                        }else if($expedientType == 3 && $clientTypeExp == 1){ 
                            $particularVAR[2]++;
                            $particularVAR[3]+=$fact;
                            $particularVAR[4]+=$bi;
                        }else if($expedientType == 3 && $clientTypeExp == 3){
                            $empresaVAR[2]++;
                            $empresaVAR[3]+=$fact;
                            $empresaVAR[4]+=$bi;
                        }else if($expedientType == 3 && $clientTypeExp == 2){
                            $seguroVAR[2]++;
                            $seguroVAR[3]+=$fact;
                            $seguroVAR[4]+=$bi;
                        }

                        $result = $db->query("  SELECT  SUM(pr.purchasePrice) as purchasePrice, 
                                                        SUM(pp.priceNoIVA - (pp.priceNoIVA * eh.discount/100)) as priceNoIVA
                                                FROM    Expedients_Hirings eh, Products_Retails pr, Products_Prices pp, Products p
                                                WHERE   eh.expedient = $id AND
                                                        eh.check = 1 AND
                                                        eh.product = p.productID AND
                                                        p.blockBelow = 6 AND
                                                        pr.model = eh.model AND
                                                        pr.year =  $year AND
                                                        pp.model = eh.model AND
                                                        pp.price = $price AND
                                                        eh.num_hiring = (
                                                            SELECT  MAX(i2.num_hiring) 
                                                            FROM    Invoices i2 
                                                            WHERE   i2.expedient = $id AND
                                                                    i2.leavingDate IS NULL AND
                                                                    i2.invoice_type != 3
                                                        )
                        ");

                        if(mysqli_num_rows($result) > 0){
                            $prices = $db->resultToArray($result);
                            foreach($prices as $price){
                                if($expedientType == 1 && $clientTypeExp == 1){
                                    $purchasePriceParticularDEF+=floatval($price['purchasePrice']);
                                    $priceNoIVAParticularDEF+=floatval($price['priceNoIVA']);
                                    $particularDEF[5]+=(floatval($priceNoIVAParticularDEF) - floatval($purchasePriceParticularDEF));
                                }else if($expedientType == 1 && $clientTypeExp == 3){
                                    $purchasePriceEmpresaDEF+=floatval($price['purchasePrice']);
                                    $priceNoIVAEmpresaDEF+=floatval($price['priceNoIVA']);
                                    $empresaDEF[5]+=(floatval($priceNoIVAEmpresaDEF) - floatval($purchasePriceEmpresaDEF));
                                }else if($expedientType == 1 && $clientTypeExp == 2){
                                    $purchasePriceSeguroDEF+=floatval($price['purchasePrice']);
                                    $priceNoIVASeguroDEF+=floatval($price['priceNoIVA']);
                                    $seguroDEF[5]+=(floatval($priceNoIVASeguroDEF) - floatval($purchasePriceSeguroDEF));
                                }else if($expedientType == 3 && $clientTypeExp == 1){ 
                                    $purchasePriceParticularVAR+=floatval($price['purchasePrice']);
                                    $priceNoIVAParticularVAR+=floatval($price['priceNoIVA']);
                                    $particularVAR[5]+=(floatval($priceNoIVAParticularVAR) - floatval($purchasePriceParticularVAR));
                                }else if($expedientType == 3 && $clientTypeExp == 3){
                                    $purchasePriceEmpresaVAR+=floatval($price['purchasePrice']);
                                    $priceNoIVAEmpresaVAR+=floatval($price['priceNoIVA']);
                                    $empresaVAR[5]+=(floatval($priceNoIVAEmpresaVAR) - floatval($purchasePriceEmpresaVAR));
                                }else if($expedientType == 3 && $clientTypeExp == 2){
                                    $purchasePriceSeguroVAR+=floatval($price['purchasePrice']);
                                    $priceNoIVASeguroVAR+=floatval($price['priceNoIVA']);
                                    $seguroVAR[5]+=(floatval($priceNoIVASeguroVAR) - floatval($purchasePriceSeguroVAR));
                                }
                            }
                        }
                    }
                }

                if($clientType != ''){
                    if($showParticular && $showEmpresa && $showSeguro){ //000
                        array_push($resultTanatorio, $particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR);
                    }else if($showParticular && $showEmpresa && !$showSeguro){ //001
                        array_push($resultTanatorio, $particularDEF, $empresaDEF, $particularVAR, $empresaVAR);
                    }else if($showParticular && !$showEmpresa && $showSeguro){ //010
                        array_push($resultTanatorio, $particularDEF, $seguroDEF, $particularVAR, $seguroVAR);
                    }else if($showParticular && !$showEmpresa && !$showSeguro){ //011
                        array_push($resultTanatorio, $particularDEF, $particularVAR);
                    }else if(!$showParticular && $showEmpresa && $showSeguro){ //100
                        array_push($resultTanatorio, $empresaDEF, $seguroDEF, $empresaVAR, $seguroVAR);
                    }else if(!$showParticular && $showEmpresa && !$showSeguro){ //101
                        array_push($resultTanatorio, $empresaDEF, $empresaVAR);
                    }else if(!$showParticular && !$showEmpresa && $showSeguro){ //110
                        array_push($resultTanatorio, $seguroDEF, $seguroVAR);
                    }
                }else{
                    array_push($resultTanatorio, $particularDEF, $empresaDEF, $seguroDEF, $particularVAR, $empresaVAR, $seguroVAR);
                }

                if($client != ''){
                    foreach($client as $elemClient){
    
                        $whereAux = '';
                        $whereAuxCC = '';
                        if($date == ''){
                            if($dateSince != '' && $dateUntil != ''){
                                $whereAux .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                            }
                        }else{
                            $whereAux .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
                        }
    
                        if($mortuary != ''){
                            $whereAuxCC .= " AND (";
                            foreach($mortuary as $elem){
                                $elem = cleanStr($elem);
                                $whereAuxCC .= " cc.ID = $elem OR";
                            }
                            $whereAuxCC = substr($whereAuxCC, 0, -3);
                            $whereAuxCC .= ")";
                        }else{
                            $whereAuxCC .= " AND cc.mortuary != 0";
                        }
    
                        if($clientType != ''){
                            $whereAux .= ' AND e.clientType IN (';
                            foreach($clientType as $elem){
                                $elem = cleanStr($elem);
                                $whereAux .= $elem . ',';
                            }
                            $whereAux = substr($whereAux, 0, -1);
                            $whereAux .= ')';
                        }
    
                        $whereAux .= " AND c.clientID =  $elemClient";
                        $whereAuxCC = ' AND cc.ID = ' . $ccID; 
                        
                        $clientResult = $this->getControlPanelCremationsClientOthers($whereAux, $elemClient, 1);
                        array_push($resultTanatorio, $clientResult);
                        $clientResult = $this->getControlPanelCremationsClientOthers($whereAux, $elemClient, 3);
                        array_push($resultTanatorio, $clientResult);
                    }
                }
            }
            array_push($resultFinal, [$ccID, $costName, $resultTanatorio]);

            return $resultFinal;
        }
        
        public function getControlPanelCremationsClient($where, $whereCC, $clientID, $expedientType){
            $db = new DbHandler;

            if($expedientType == 1){
                $name = ' - Defunción';
            }else{
                $name = ' - Varios';
            }

            $resultTanatorio = [];

            $resultC = $db->query("     SELECT      CONCAT(c.name, ' ', c.surname, '$name') as nameP, c.brandName as nameE
                                        FROM        Clients c
                                        WHERE       c.clientID = $clientID");
            $client = $db->resultToArray($resultC);

            if($client[0]['nameP'] == '' || $client[0]['nameP'] == null){
                $userName = $client[0]['nameE'];
            }else{
                $userName = $client[0]['nameP'];
            }

            $clientResult = array('-',$userName,0,0,0,0,'OTROS', $clientID);

            $result = $db->query("  SELECT      e.expedientID, 
                                                e.type as expedientType, 
                                                e.clientType as clientType, 
                                                c.clientID, 
                                                c.name, 
                                                c.surname, 
                                                c.price, 
                                                pr.name as priceName, 
                                                YEAR(e.requestDate) as year, 
                                                CONCAT(c.name, '', c.surname) as nameP, 
                                                c.brandName as nameE
                                    FROM        Expedients e, Clients c, Prices pr,  Cost_Center cc
                                    WHERE       e.cremation = 1 AND
                                                e.crematoriumEvent IS NOT NULL AND
                                                e.leavingDate IS NULL AND
                                                e.client = c.clientID AND 
                                                c.price = pr.priceID AND
                                                e.type = $expedientType AND
                                                e.deceasedMortuary = cc.mortuary AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0
                                                $where
                                                $whereCC
                                    ORDER BY    e.client");

            if(mysqli_num_rows($result) == 0){
            }else{

                $exps = $db->resultToArray($result);
                foreach($exps as $index => $elem){

                    $id = $elem['expedientID'];
                    $price = $elem['price'];
                    $priceName = $elem['priceName'];
                    $year = $elem['year'];
                    $clientTypeExp = $elem['clientType'];
                    $expedientType = $elem['expedientType'];
                
                    $clientResult[2]++;

                    // Tarifa para el año y el cliente del expediente
                    $purchasePriceClient = 0;
                    $priceNoIVAClient = 0;
                    $grossMarginClient = 0;

                    $result = $db->query("  SELECT  SUM((pp.priceNoIVA * it.percentage / 100 + pp.priceNoIVA) * eh.amount - ((pp.priceNoIVA * it.percentage / 100 + pp.priceNoIVA) * eh.discount / 100) * eh.amount) as fact,
                                                    SUM(eh.amount * (pp.priceNoIVA - pp.priceNoIva * eh.discount / 100)) as bi
                                            FROM    Expedients e, Expedients_Hirings eh, Products p, Products_Prices pp, Products_Models pm, IVA_Types it, Prices pr
                                            WHERE   e.expedientID = eh.expedient  
                                                    AND eh.product = p.productID
                                                    AND eh.model = pm.productModelID
                                                    AND pm.product = p.productID
                                                    AND pm.productModelID = pp.model
                                                    AND pp.price = pr.priceID
                                                    AND p.IVA = it.IVATypeID
                                                    AND p.blockBelow = 6
                                                    AND eh.check = 1 
                                                    AND pr.year = YEAR(e.requestDate)
                                                    AND pr.name LIKE '%$priceName%'
                                                    AND e.leavingDate IS NULL
                                                    AND e.expedientID = $id 
                                                    AND eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = e.expedientID AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    )
                    ");

                    if(mysqli_num_rows($result) == 0){
                        continue;
                    }else{
                        $resultAux = $db->resultToArray($result)[0];
                        $fact = $resultAux['fact'];
                        $bi = $resultAux['bi'];

                        $clientResult[3] += $fact;
                        $clientResult[4] += $bi;

                        $result = $db->query("  SELECT  SUM(pr.purchasePrice) as purchasePrice, SUM(pp.priceNoIVA - (pp.priceNoIVA * eh.discount/100)) as priceNoIVA
                                                FROM    Expedients_Hirings eh, Products_Retails pr, Products_Prices pp, Products p
                                                WHERE   eh.expedient = $id AND
                                                        eh.check = 1 AND
                                                        eh.product = p.productID AND
                                                        p.blockBelow = 6 AND
                                                        pr.model = eh.model AND
                                                        pr.year =  $year AND
                                                        pp.model = eh.model AND
                                                        pp.price = $price AND
                                                        eh.num_hiring = (
                                                            SELECT  MAX(i2.num_hiring) 
                                                            FROM    Invoices i2 
                                                            WHERE   i2.expedient = $id AND
                                                                    i2.leavingDate IS NULL AND
                                                                    i2.invoice_type != 3
                                                        )
                        ");

                        if(mysqli_num_rows($result) > 0){
                            $prices = $db->resultToArray($result);
                            foreach($prices as $price){
                                $purchasePriceClient+=floatval($price['purchasePrice']);
                                $priceNoIVAClient+=floatval($price['priceNoIVA']);
                                $clientResult[5]+=(floatval($priceNoIVAClient) - floatval($purchasePriceClient));
                            }
                        }
                    }
                }
            }
            return $clientResult;
        }

        public function getControlPanelCremationsClientOthers($where, $clientID, $expedientType){
            $db = new DbHandler;

            if($expedientType == 1){
                $name = ' - Defunción';
            }else{
                $name = ' - Varios';
            }

            $resultTanatorio = [];

            $resultC = $db->query("     SELECT      CONCAT(c.name, ' ', c.surname, '$name') as nameP, c.brandName as nameE
                                        FROM        Clients c
                                        WHERE       c.clientID = $clientID");
            $client = $db->resultToArray($resultC);

            if($client[0]['nameP'] == '' || $client[0]['nameP'] == null){
                $userName = $client[0]['nameE'];
            }else{
                $userName = $client[0]['nameP'];
            }

            $clientResult = array('-',$userName,0,0,0,0,'OTROS', $clientID);

            $result = $db->query("  SELECT      e.expedientID, e.type as expedientType, e.clientType as clientType, c.clientID, c.name, c.surname, c.price, pr.name as priceName, YEAR(e.requestDate) as year, CONCAT(c.name, '', c.surname) as nameP, c.brandName as nameE
                                    FROM        (Prices pr, Expedients e, Clients c)
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    WHERE       e.cremation = 1 AND
                                                e.crematoriumEvent IS NOT NULL AND
                                                e.leavingDate IS NULL AND
                                                e.client = c.clientID AND 
                                                c.price = pr.priceID AND
                                                e.type = $expedientType AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices inv
                                                    WHERE   inv.expedient = e.expedientID AND
                                                            inv.leavingDate IS NULL
                                                ) > 0 AND
                                                (SELECT COUNT(*) FROM Cost_Center cc WHERE cc.mortuary = m.mortuaryID) = 0
                                                $where
                                    ORDER BY    e.client");

            if(mysqli_num_rows($result) == 0){  
            }else{

                $exps = $db->resultToArray($result);
                foreach($exps as $index => $elem){

                    $id = $elem['expedientID'];
                    $price = $elem['price'];
                    $priceName = $elem['priceName'];
                    $year = $elem['year'];
                    $clientTypeExp = $elem['clientType'];
                    $expedientType = $elem['expedientType'];
                
                    $clientResult[2]++;

                    // Tarifa para el año y el cliente del expediente
                    $purchasePriceClient = 0;
                    $priceNoIVAClient = 0;
                    $grossMarginClient = 0;

                    $result = $db->query("  SELECT  SUM((pp.priceNoIVA * it.percentage / 100 + pp.priceNoIVA) * eh.amount - ((pp.priceNoIVA * it.percentage / 100 + pp.priceNoIVA) * eh.discount / 100) * eh.amount) as fact,
                                                    SUM(eh.amount * (pp.priceNoIVA - pp.priceNoIva * eh.discount / 100)) as bi
                                            FROM    Expedients e, Expedients_Hirings eh, Products p, Products_Prices pp, Products_Models pm, IVA_Types it, Prices pr
                                            WHERE   e.expedientID = eh.expedient  
                                                    AND eh.product = p.productID
                                                    AND eh.model = pm.productModelID
                                                    AND pm.product = p.productID
                                                    AND pm.productModelID = pp.model
                                                    AND pp.price = pr.priceID
                                                    AND p.IVA = it.IVATypeID
                                                    AND p.blockBelow = 6
                                                    AND eh.check = 1 
                                                    AND pr.year = YEAR(e.requestDate)
                                                    AND pr.name LIKE '%$priceName%'
                                                    AND e.leavingDate IS NULL
                                                    AND e.expedientID = $id
                                                    AND eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = e.expedientID AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    )           
                    ");

                    if(mysqli_num_rows($result) == 0){
                        continue;
                    }else{
                        $resultAux = $db->resultToArray($result)[0];
                        $fact = $resultAux['fact'];
                        $bi = $resultAux['bi'];

                        $clientResult[3] += $fact;
                        $clientResult[4] += $bi;

                        $result = $db->query("  SELECT  SUM(pr.purchasePrice) as purchasePrice, SUM(pp.priceNoIVA - (pp.priceNoIVA * eh.discount/100)) as priceNoIVA
                                                FROM    Expedients_Hirings eh, Products_Retails pr, Products_Prices pp, Products p
                                                WHERE   eh.expedient = $id AND
                                                        eh.check = 1 AND
                                                        eh.product = p.productID AND
                                                        p.blockBelow = 6 AND
                                                        pr.model = eh.model AND
                                                        pr.year =  $year AND
                                                        pp.model = eh.model AND
                                                        pp.price = $price AND
                                                        eh.num_hiring = (
                                                            SELECT  MAX(i2.num_hiring) 
                                                            FROM    Invoices i2 
                                                            WHERE   i2.expedient = $id AND
                                                                    i2.leavingDate IS NULL AND
                                                                    i2.invoice_type != 3
                                                        )
                        ");

                        if(mysqli_num_rows($result) > 0){
                            $prices = $db->resultToArray($result);
                            foreach($prices as $price){
                                $purchasePriceClient+=floatval($price['purchasePrice']);
                                $priceNoIVAClient+=floatval($price['priceNoIVA']);
                                $clientResult[5]+=(floatval($priceNoIVAClient) - floatval($purchasePriceClient));
                            }
                        }
                    }
                }
            }
            return $clientResult;
        }

        /**
         * Obtiene los datos del cash flow para el cuadro de mando
         * 
         * @param int $date Fecha
         * @param int $dateSince Fecha desde
         * @param int $dateUntil Fecha hasta
         * @param int $client Clientes
         * @return array
         */
        public function getControlPanelCashFlow($date, $dateSince, $dateUntil, $mortuary){
            $db = new DbHandler;

            $date = cleanStr($date);
            $dateSince = cleanStr($dateSince);
            $dateUntil = cleanStr($dateUntil);

            $data = array(
                'earned' => 0,
                'expensesFixed' => 0,
                'expensesVariable' => 0,
                'supplieds' => 0,
                'salaries' => 0,
                'financingInterests' => 0,
                'financingAmortizations' => 0
            );

            $where = '';
            $whereCC = '';
            if($date == ''){
                if($dateSince != '' && $dateUntil != ''){
                    $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                }
            }else{
                $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
            }

            if($mortuary != ''){
                $where .= " AND (";
                foreach($mortuary as $elem){
                    $elem = cleanStr($elem);
                    
                    $where .= " e.deceasedMortuary = cc.mortuary AND cc.ID = $elem OR";
                }
                $from = ', Cost_Center cc';
                $where = substr($where, 0, -3);
                $where .= ")";

                $whereCC .= " AND (";
                foreach($mortuary as $elem){
                    $elem = cleanStr($elem);
                    
                    $whereCC .= " cc.ID = $elem OR";
                }
                $from = ', Cost_Center cc';
                $whereCC = substr($whereCC, 0, -3);
                $whereCC .= ")";
            }else{
                $from = '';
            }

            $result = $db->query("  SELECT      *
                                    FROM        Cost_Center cc
                                    WHERE       cc.leavingDate IS NULL
                                                $whereCC
            ");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $resultFinal = [];
                $costcenters = $db->resultToArray($result);

                $costCentersIds = array();
                foreach($costcenters as $index => $elem){
                    if($elem['mortuary'] != null){
                        array_push($costCentersIds, $elem['mortuary']);
                    }

                    $resultFinal[$elem['ID']]['name'] = $elem['name'];

                    $whereCostCenter = " AND e.deceasedMortuary = cc.mortuary AND cc.ID = {$elem['ID']}";
                    $whereCostCenter2 = " AND cc.ID = {$elem['ID']}";
                    $from = ', Cost_Center cc';

                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
                    }
                    
                    // Cobrado
                    $result = $db->query("  SELECT  (
                                                        (
                                                            SELECT      COALESCE(SUM(i.pay), 0)
                                                            FROM        Invoices i
                                                            WHERE       i.leavingDate IS NULL AND
                                                                        i.invoice_type != 3 AND
                                                                        (
                                                                            (
                                                                                i.ID = (
                                                                                    SELECT  MAX(i2.ID)
                                                                                    FROM    Invoices i2
                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                            i2.invoice_type != 3 AND
                                                                                            i2.expedient = i.expedient AND 
                                                                                            (
                                                                                                i2.rectified_type IS NULL OR 
                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                            )
                                                                                )
                                                                            ) OR
                                                                            (
                                                                                i.rectified_type = 2
                                                                            )
                                                                        ) AND
                                                                        i.expedient = e.expedientID
                                                        )
                                                    ) as earned
                                            FROM    Expedients e $from
                                            WHERE   e.leavingDate IS NULL AND
                                                    e.deceasedMortuary IS NOT NULL AND
                                                    e.type != 2
                                                    $whereCostCenter
                                                    $whereDates
                    ");
        
                    $earned = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['earned'];
                    $resultFinal[$elem['ID']]['earned'] = $earned == null ? 0 : $earned;
                    
                    // Gastos fijos pagados
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND rip.date BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND DAY(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND MONTH(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND YEAR(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                    }
                    
                    $result = $db->query("  SELECT  SUM(rip.amount) as total
                                            FROM    Received_Invoices_Payments rip, Received_Invoices ri, Cost_Center cc
                                            WHERE   rip.invoice = ri.ID AND
                                                    ri.leavingDate IS NULL AND
                                                    ri.expenseFixed IS NOT NULL AND
                                                    rip.leavingDate IS NULL AND
                                                    ri.costCenter = cc.ID
                                                    $whereDates
                                                    $whereCostCenter2");
        
                    $fixedExpenses = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal[$elem['ID']]['expensesFixed'] = $fixedExpenses == null ? 0 : $fixedExpenses;
        
                    // Gastos variables pagados
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND rip.date BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND DAY(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND MONTH(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND YEAR(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                    }
                    
                    $result = $db->query("  SELECT  SUM(rip.amount) as total
                                            FROM    Received_Invoices_Payments rip, Received_Invoices ri, Cost_Center cc
                                            WHERE   rip.invoice = ri.ID AND
                                                    ri.leavingDate IS NULL AND
                                                    ri.expenseVariable IS NOT NULL AND
                                                    rip.leavingDate IS NULL AND
                                                    ri.costCenter = cc.ID
                                                    $whereDates
                                                    $whereCostCenter2");
        
                    $fixedVariable = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal[$elem['ID']]['expensesVariable'] = $fixedVariable == null ? 0 : $fixedVariable;
        
                    // Suplidos pagados
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND rip.date BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND DAY(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND MONTH(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND YEAR(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                    }
        
                    $result = $db->query("  SELECT  SUM(rip.amount) as total
                                            FROM    Received_Invoices_Payments rip, Received_Invoices ri, Cost_Center cc
                                            WHERE   rip.invoice = ri.ID AND
                                                    ri.leavingDate IS NULL AND
                                                    ri.supplied IS NOT NULL AND ri.supplied > 0 AND
                                                    rip.leavingDate IS NULL AND
                                                    ri.costCenter = cc.ID
                                                    $whereDates
                                                    $whereCostCenter2");
        
                    $supplieds = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal[$elem['ID']]['supplieds'] = $supplieds == null ? 0 : $supplieds;
        
                    // Salarios pagados
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND s.date BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND MONTH(FROM_UNIXTIME(s.date, '%Y-%c-%e')) BETWEEN MONTH(FROM_UNIXTIME($date, '%Y-%c-%e')) AND MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                    }
        
                    $result = $db->query("  SELECT  SUM(s.companyCost) as total
                                            FROM    Salaries s, Staff st
                                            WHERE   s.staff = st.ID AND
                                                    st.leavingDate IS NULL
                                                    $whereDates");
        
                    $salaries = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal[$elem['ID']]['salaries'] = $salaries == null ? 0 : $salaries;
        
                    // Intereses pagados
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND fc.startDate BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND fc.startDate = $date";
                    }
                    
                    $result = $db->query("  SELECT  SUM(ABS(fc.interest)) as total
                                            FROM    Financing_Cuotas fc, Financing f, Cost_Center cc
                                            WHERE   fc.payDate IS NOT NULL AND
                                                    fc.financing = f.ID AND
                                                    f.leavingDate IS NULL AND
                                                    f.financeCenter = cc.ID
                                                    $whereDates
                                                    $whereCostCenter2");
        
                    $financingInterests = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal[$elem['ID']]['financingInterests'] = $financingInterests == null ? 0 : $financingInterests;
        
                    // Amortización capital pagado
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND fc.startDate BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND fc.startDate = $date";
                    }
                    
                    $result = $db->query("  SELECT  SUM(ABS(fc.amortization)) as total
                                            FROM    Financing_Cuotas fc, Financing f, Cost_Center cc
                                            WHERE   fc.payDate IS NOT NULL AND
                                                    fc.financing = f.ID AND
                                                    f.leavingDate IS NULL AND
                                                    f.financeCenter = cc.ID
                                                    $whereDates
                                                    $whereCostCenter2");
        
                    $financingAmortizations = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal[$elem['ID']]['financingAmortizations'] = $financingAmortizations == null ? 0 : $financingAmortizations;
                }

                // Otros
                if($mortuary == ''){
                    $resultFinal['Otros']['name'] = 'Otras instalaciones';
                    $mortuariesAlreadyChecked = implode(',', $costCentersIds);

                    $whereCosteCenter = '';
                    if($mortuariesAlreadyChecked != ''){
                        $whereCosteCenter = " AND cc.ID NOT IN ($mortuariesAlreadyChecked)";
                    }
    
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
                    }
    
                    // Cobrado
                    $result = $db->query("  SELECT  SUM(t.pay) as earned
                                            FROM (
                                                SELECT      (
                                                                (
                                                                    SELECT      COALESCE(SUM(i.pay), 0)
                                                                    FROM        Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = e.expedientID
                                                                )
                                                            ) as pay
                                                FROM        Expedients e
                                                WHERE       e.leavingDate IS NULL AND
                                                            e.deceasedMortuary IS NULL AND
                                                            e.type != 2
                                                            $whereDates
                                                UNION ALL
                                                SELECT      (
                                                                (
                                                                    SELECT      COALESCE(SUM(i.pay), 0)
                                                                    FROM        Invoices i
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = e.expedientID
                                                                )
                                                            ) as pay
                                                FROM        Expedients e
                                                WHERE       e.leavingDate IS NULL AND
                                                            e.deceasedMortuary IS NOT NULL AND
                                                            (
                                                                SELECT  COUNT(*)
                                                                FROM    Cost_Center cc
                                                                WHERE   e.deceasedMortuary = cc.mortuary AND cc.leavingDate IS NULL
                                                            ) = 0 AND
                                                            e.type != 2
                                                            $whereDates
                                            ) AS t
                    ");
    
                    $earned = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['earned'];
                    $resultFinal['Otros']['earned'] = $earned == null ? 0 : floatval($earned);
    
                    // Gastos fijos pagados
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND rip.date BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND DAY(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND MONTH(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND YEAR(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                    }
                    
                    $result = $db->query("  SELECT  SUM(rip.amount) as total
                                            FROM    Received_Invoices_Payments rip, Received_Invoices ri, Cost_Center cc
                                            WHERE   rip.invoice = ri.ID AND
                                                    ri.leavingDate IS NULL AND
                                                    ri.expenseFixed IS NOT NULL AND
                                                    rip.leavingDate IS NULL AND
                                                    ri.costCenter = cc.ID
                                                    $whereCosteCenter
                                                    $whereDates
                    ");
        
                    $fixedExpenses = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal['Otros']['expensesFixed'] = $fixedExpenses == null ? 0 : $fixedExpenses;
    
                    // Gastos variables pagados
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND rip.date BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND DAY(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND MONTH(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND YEAR(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                    }
                    
                    $result = $db->query("  SELECT  SUM(rip.amount) as total
                                            FROM    Received_Invoices_Payments rip, Received_Invoices ri, Cost_Center cc
                                            WHERE   rip.invoice = ri.ID AND
                                                    ri.leavingDate IS NULL AND
                                                    ri.expenseVariable IS NOT NULL AND
                                                    rip.leavingDate IS NULL AND
                                                    ri.costCenter = cc.ID
                                                    $whereCosteCenter
                                                    $whereDates
                    ");
        
                    $fixedVariable = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal['Otros']['expensesVariable'] = $fixedVariable == null ? 0 : $fixedVariable;
    
                    // Suplidos pagados
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND rip.date BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND DAY(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND MONTH(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND YEAR(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                    }
        
                    $result = $db->query("  SELECT  SUM(rip.amount) as total
                                            FROM    Received_Invoices_Payments rip, Received_Invoices ri, Cost_Center cc
                                            WHERE   rip.invoice = ri.ID AND
                                                    ri.leavingDate IS NULL AND
                                                    ri.supplied IS NOT NULL AND ri.supplied > 0 AND
                                                    rip.leavingDate IS NULL AND
                                                    ri.costCenter = cc.ID
                                                    $whereCosteCenter
                                                    $whereDates
                    ");
        
                    $supplieds = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal['Otros']['supplieds'] = $supplieds == null ? 0 : $supplieds;
    
                    // Salarios pagados
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND s.date BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND MONTH(FROM_UNIXTIME(s.date, '%Y-%c-%e')) BETWEEN MONTH(FROM_UNIXTIME($date, '%Y-%c-%e')) AND MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                    }
        
                    $result = $db->query("  SELECT  SUM(s.companyCost) as total
                                            FROM    Salaries s, Staff st
                                            WHERE   s.staff = st.ID AND
                                                    st.leavingDate IS NULL
                                                    $whereDates");
        
                    $salaries = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal['Otros']['salaries'] = $salaries == null ? 0 : $salaries;
    
                    // Intereses pagados
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND fc.startDate BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND fc.startDate = $date";
                    }
                    
                    $result = $db->query("  SELECT  SUM(ABS(fc.interest)) as total
                                            FROM    Financing_Cuotas fc, Financing f, Cost_Center cc
                                            WHERE   fc.payDate IS NOT NULL AND
                                                    fc.financing = f.ID AND
                                                    f.leavingDate IS NULL AND
                                                    f.financeCenter = cc.ID
                                                    $whereCosteCenter
                                                    $whereDates");
        
                    $financingInterests = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal['Otros']['financingInterests'] = $financingInterests == null ? 0 : $financingInterests;
    
                    // Amortización capital pagado
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND fc.startDate BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND fc.startDate = $date";
                    }
                    
                    $result = $db->query("  SELECT  SUM(ABS(fc.amortization)) as total
                                            FROM    Financing_Cuotas fc, Financing f, Cost_Center cc
                                            WHERE   fc.payDate IS NOT NULL AND
                                                    fc.financing = f.ID AND
                                                    f.leavingDate IS NULL AND
                                                    f.financeCenter = cc.ID
                                                    $whereCosteCenter
                                                    $whereDates");
        
                    $financingAmortizations = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal['Otros']['financingAmortizations'] = $financingAmortizations == null ? 0 : $financingAmortizations;

                }

                // Total
                $resultFinal['total']['name'] = 'Total';

                // Cobrado
                $result = $db->query("  SELECT      (
                                                        (
                                                            SELECT      COALESCE(SUM(i.pay), 0)
                                                            FROM        Invoices i
                                                            WHERE       i.leavingDate IS NULL AND
                                                                        i.invoice_type != 3 AND
                                                                        (
                                                                            (
                                                                                i.ID = (
                                                                                    SELECT  MAX(i2.ID)
                                                                                    FROM    Invoices i2
                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                            i2.invoice_type != 3 AND
                                                                                            i2.expedient = i.expedient AND 
                                                                                            (
                                                                                                i2.rectified_type IS NULL OR 
                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                            )
                                                                                )
                                                                            ) OR
                                                                            (
                                                                                i.rectified_type = 2
                                                                            )
                                                                        ) AND
                                                                        i.expedient = e.expedientID
                                                        )
                                                    ) as earned
                                        FROM        Expedients e
                                        LEFT JOIN   Cost_Center cc ON e.deceasedMortuary = cc.mortuary
                                        WHERE       e.leavingDate IS NULL AND
                                                    e.type != 2
                                                    $where
                ");
    
                $earned = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['earned'];
                $resultFinal['total']['earned'] = $earned == null ? 0 : $earned;
                
                // Gastos fijos pagados
                $where = '';
                if($date == ''){
                    if($dateSince != '' && $dateUntil != ''){
                        $where .= " AND rip.date BETWEEN $dateSince AND $dateUntil";
                    }
                }else{
                    $where .= " AND DAY(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                AND MONTH(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                AND YEAR(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                }
    
                if($mortuary != ''){
                    $where .= " AND (";
                    foreach($mortuary as $elem){
                        $elem = cleanStr($elem);
                        $where .= " ri.costCenter = cc.ID AND cc.ID = $elem OR";
                    }
                    $where = substr($where, 0, -3);
                    $where .= ")";
                }
                
                $result = $db->query("  SELECT  SUM(rip.amount) as total
                                        FROM    Received_Invoices_Payments rip, Received_Invoices ri, Cost_Center cc
                                        WHERE   rip.invoice = ri.ID AND
                                                ri.leavingDate IS NULL AND
                                                ri.expenseFixed IS NOT NULL AND
                                                rip.leavingDate IS NULL AND
                                                ri.costCenter = cc.ID
                                                $where
                ");
    
                $fixedExpenses = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                $resultFinal['total']['expensesFixed'] = $fixedExpenses == null ? 0 : $fixedExpenses;
    
                // Gastos variables pagados
                $where = '';
                if($date == ''){
                    if($dateSince != '' && $dateUntil != ''){
                        $where .= " AND rip.date BETWEEN $dateSince AND $dateUntil";
                    }
                }else{
                    $where .= " AND DAY(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                AND MONTH(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                AND YEAR(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                }
    
                if($mortuary != ''){
                    $where .= " AND (";
                    foreach($mortuary as $elem){
                        $elem = cleanStr($elem);
                        
                        $where .= " ri.costCenter = cc.ID AND cc.ID = $elem OR";
                    }
                    $where = substr($where, 0, -3);
                    $where .= ")";
                }
                
                $result = $db->query("  SELECT  SUM(rip.amount) as total
                                        FROM    Received_Invoices_Payments rip, Received_Invoices ri, Cost_Center cc
                                        WHERE   rip.invoice = ri.ID AND
                                                ri.leavingDate IS NULL AND
                                                ri.expenseVariable IS NOT NULL AND
                                                rip.leavingDate IS NULL AND
                                                ri.costCenter = cc.ID
                                                $where
                ");
    
                $fixedVariable = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                $resultFinal['total']['expensesVariable'] = $fixedVariable == null ? 0 : $fixedVariable;
    
                // Suplidos pagados
                $where = '';
                if($date == ''){
                    if($dateSince != '' && $dateUntil != ''){
                        $where .= " AND rip.date BETWEEN $dateSince AND $dateUntil";
                    }
                }else{
                    $where .= " AND DAY(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                AND MONTH(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                AND YEAR(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                }
    
                if($mortuary != ''){
                    $where .= " AND (";
                    foreach($mortuary as $elem){
                        $elem = cleanStr($elem);
                        
                        $where .= " ri.costCenter = cc.ID AND cc.ID = $elem OR";
                    }
                    $where = substr($where, 0, -3);
                    $where .= ")";
                }
    
                $result = $db->query("  SELECT  SUM(rip.amount) as total
                                        FROM    Received_Invoices_Payments rip, Received_Invoices ri, Cost_Center cc
                                        WHERE   rip.invoice = ri.ID AND
                                                ri.leavingDate IS NULL AND
                                                ri.supplied IS NOT NULL AND ri.supplied > 0 AND
                                                rip.leavingDate IS NULL AND
                                                ri.costCenter = cc.ID
                                                $where
                ");
    
                $supplieds = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                $resultFinal['total']['supplieds'] = $supplieds == null ? 0 : $supplieds;
    
                // Salarios pagados
                $where = '';
                if($date == ''){
                    if($dateSince != '' && $dateUntil != ''){
                        $where .= " AND s.date BETWEEN $dateSince AND $dateUntil";
                    }
                }else{
                    $where .= " AND MONTH(FROM_UNIXTIME(s.date, '%Y-%c-%e')) BETWEEN MONTH(FROM_UNIXTIME($date, '%Y-%c-%e')) AND MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                }
    
                $result = $db->query("  SELECT  SUM(s.companyCost) as total
                                        FROM    Salaries s, Staff st
                                        WHERE   s.staff = st.ID AND
                                                st.leavingDate IS NULL
                                                $where
                ");
    
                $salaries = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                $resultFinal['total']['salaries'] = $salaries == null ? 0 : $salaries;
    
                // Intereses pagados
                $where = '';
                if($date == ''){
                    if($dateSince != '' && $dateUntil != ''){
                        $where .= " AND fc.startDate BETWEEN $dateSince AND $dateUntil";
                    }
                }else{
                    $where .= " AND fc.startDate = $date";
                }
    
                if($mortuary != ''){
                    $where .= " AND (";
                    foreach($mortuary as $elem){
                        $elem = cleanStr($elem);
                        
                        $where .= "  f.financeCenter = cc.ID AND cc.ID = $elem OR";
                    }
                    $where = substr($where, 0, -3);
                    $where .= ")";
                }
                
                $result = $db->query("  SELECT  SUM(ABS(fc.interest)) as total
                                        FROM    Financing_Cuotas fc, Financing f, Cost_Center cc
                                        WHERE   fc.payDate IS NOT NULL AND
                                                fc.financing = f.ID AND
                                                f.leavingDate IS NULL AND
                                                f.financeCenter = cc.ID
                                                $where
                ");
    
                $financingInterests = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                $resultFinal['total']['financingInterests'] = $financingInterests == null ? 0 : $financingInterests;
    
                // Amortización capital pagado
                $where = '';
                if($date == ''){
                    if($dateSince != '' && $dateUntil != ''){
                        $where .= " AND fc.startDate BETWEEN $dateSince AND $dateUntil";
                    }
                }else{
                    $where .= " AND fc.startDate = $date";
                }
    
                if($mortuary != ''){
                    $where .= " AND (";
                    foreach($mortuary as $elem){
                        $elem = cleanStr($elem);
                        
                        $where .= "  f.financeCenter = cc.ID AND cc.ID = $elem OR";
                    }
                    $where = substr($where, 0, -3);
                    $where .= ")";
                }
                
                $result = $db->query("  SELECT  SUM(ABS(fc.amortization)) as total
                                        FROM    Financing_Cuotas fc, Financing f, Cost_Center cc
                                        WHERE   fc.payDate IS NOT NULL AND
                                                fc.financing = f.ID AND
                                                f.leavingDate IS NULL AND
                                                f.financeCenter = cc.ID
                                                $where
                ");
    
                $financingAmortizations = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                $resultFinal['total']['financingAmortizations'] = $financingAmortizations == null ? 0 : $financingAmortizations;
            }

            return $resultFinal;
        }
        
        /**
         * Obtiene los datos del cash flow para el cuadro de mando
         * 
         * @param int $date Fecha
         * @param int $dateSince Fecha desde
         * @param int $dateUntil Fecha hasta
         * @param int $client Clientes
         * @return array
         */
        public function getControlPanelProvisional($date, $dateSince, $dateUntil, $mortuary){
            $db = new DbHandler;

            $date = cleanStr($date);
            $dateSince = cleanStr($dateSince);
            $dateUntil = cleanStr($dateUntil);

            $where = '';
            $whereCC = '';
            if($date == ''){
                if($dateSince != '' && $dateUntil != ''){
                    $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                }
            }else{
                $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
            }

            if($mortuary != ''){
                $whereCC .= " AND (";
                foreach($mortuary as $elem){
                    $elem = cleanStr($elem);
                    
                    $whereCC .= " cc.ID = $elem OR";
                }
                $from = ', Cost_Center cc';
                $whereCC = substr($whereCC, 0, -3);
                $whereCC .= ")";
            }else{
                $from = '';
            }

            $result = $db->query("  SELECT      *
                                    FROM        Cost_Center cc
                                    WHERE       cc.leavingDate IS NULL
                                                $whereCC");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $resultFinal = [];
                $costcenters = $db->resultToArray($result);

                $costCentersIds = array();
                $mortuariesIds = array();
                foreach($costcenters as $index => $elem){
                    array_push($costCentersIds, $elem['ID']);
                    if($elem['mortuary'] != null){
                        array_push($mortuariesIds, $elem['mortuary']);
                    }

                    $resultFinal[$elem['ID']]['name'] = $elem['name'];

                    $whereCostCenter = " AND e.deceasedMortuary = cc.mortuary AND cc.ID = {$elem['ID']}";
                    $whereCostCenter2 = " AND cc.ID = {$elem['ID']}";
                    $from = ', Cost_Center cc';

                    // Facturado
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
                    }

                    $result = $db->query("  SELECT      e.expedientID, 
                                                        (
                                                            (
                                                                SELECT      COALESCE(SUM(iniv.base), 0)
                                                                FROM        Invoices i
                                                                JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = e.expedientID
                                                            )
                                                        ) as earned,
                                                        e.client
                                            FROM        Expedients e, Clients c $from
                                            WHERE       e.client = c.clientID AND
                                                        e.leavingDate IS NULL AND
                                                        e.type != 2
                                                        $whereDates
                                                        $whereCostCenter
                                            ORDER BY    e.client");

                    if(mysqli_num_rows($result) > 0){
                        $earned =  $db->resultToArray($result);

                        $total = 0;
                        foreach($earned as $index => $expedient){
                            $id = $expedient['expedientID'];

                            $result = $db->query("  SELECT      SUM(eh.total) as cost
                                                    FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                                    LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                                    WHERE       eh.expedient = $id AND 
                                                                eh.check = 1 AND 
                                                                eh.expedient = e.expedientID AND
                                                                eh.model = pm.productModelID AND
                                                                eh.product = pr.productID AND
                                                                pr.IVA = it.IVATypeID AND
                                                                pr.leavingDate IS NULL AND
                                                                pr.supplied = 1 AND
                                                                pr.isInvoiced = 0 AND
                                                                eh.num_hiring = (
                                                                    SELECT  MAX(i2.num_hiring) 
                                                                    FROM    Invoices i2 
                                                                    WHERE   i2.expedient = e.expedientID AND
                                                                            i2.leavingDate IS NULL AND
                                                                            i2.invoice_type != 3
                                                                )
                            ");

                            if(mysqli_num_rows($result) > 0){
                                $supplieds = $db->resultToArray($result)[0]['cost']; 
                                if($supplieds == null){
                                    $supplieds = '0.00';
                                }
                                $total +=  floatval($expedient['earned']) + floatval($supplieds);
                            } 
                        }
                    }else{
                        $total = null;
                    }

                    $resultFinal[$elem['ID']]['invoice'] = $total == null ? 0 : $total;

                    // Gastos fijos
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND rip.date BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND DAY(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND MONTH(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND YEAR(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                    }

                    $result = $db->query("  SELECT  SUM(rip.amount) as total
                                            FROM    Received_Invoices_Payments rip, Received_Invoices ri $from
                                            WHERE   rip.invoice = ri.ID AND
                                                    ri.leavingDate IS NULL AND
                                                    ri.expenseFixed IS NOT NULL AND
                                                    rip.leavingDate IS NULL AND
                                                    ri.costCenter = cc.ID
                                                    $whereDates
                                                    $whereCostCenter2");

                    $fixedExpenses = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal[$elem['ID']]['expensesFixed'] = $fixedExpenses == null ? 0 : $fixedExpenses;

                    // Gastos variables
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND rip.date BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND DAY(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND MONTH(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND YEAR(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                    }
                    
                    $result = $db->query("  SELECT  SUM(rip.amount) as total
                                            FROM    Received_Invoices_Payments rip, Received_Invoices ri $from
                                            WHERE   rip.invoice = ri.ID AND
                                                    ri.leavingDate IS NULL AND
                                                    ri.expenseVariable IS NOT NULL AND
                                                    ri.costCenter = cc.ID AND
                                                    rip.leavingDate IS NULL
                                                    $whereDates
                                                    $whereCostCenter2");

                    $fixedVariable = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal[$elem['ID']]['expensesVariable'] = $fixedVariable == null ? 0 : $fixedVariable;

                    // Salarios
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND MONTH(FROM_UNIXTIME(s.date, '%Y-%c-%e')) BETWEEN MONTH(FROM_UNIXTIME($dateSince, '%Y-%c-%e')) AND MONTH(FROM_UNIXTIME($dateUntil, '%Y-%c-%e'))";
                        }
                    }else{
                        $whereDates .= " AND MONTH(FROM_UNIXTIME(s.date, '%Y-%c-%e')) BETWEEN MONTH(FROM_UNIXTIME($date, '%Y-%c-%e')) AND MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                    }

                    $result = $db->query("  SELECT  SUM(s.companyCost) as total
                                            FROM    Salaries s, Staff st
                                            WHERE   s.staff = st.ID AND
                                                    st.leavingDate IS NULL
                                                    $whereDates");

                    $salaries = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal[$elem['ID']]['salaries'] = $salaries == null ? 0 : $salaries;

                    // Intereses
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND fc.startDate BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND fc.startDate = $date";
                    }
                    
                    $result = $db->query("  SELECT  SUM(ABS(fc.interest)) as total
                                            FROM    Financing_Cuotas fc, Financing f $from
                                            WHERE   fc.payDate IS NOT NULL AND
                                                    fc.financing = f.ID AND
                                                    f.financeCenter = cc.ID AND
                                                    f.leavingDate IS NULL
                                                    $whereDates
                                                    $whereCostCenter2");

                    $financingInterest = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal[$elem['ID']]['interest'] = $financingInterest == null ? 0 : $financingInterest;

                    // Tasas e impuestos
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND t.creationDate BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND DAY(FROM_UNIXTIME(i.creationDate, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND MONTH(FROM_UNIXTIME(i.creationDate, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND YEAR(FROM_UNIXTIME(i.creationDate, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                    }

                    $result = $db->query("  SELECT  SUM(t.taxBase) as total
                                            FROM    Taxes t $from
                                            WHERE   t.leavingDate IS NULL AND
                                                    t.costCenter = cc.ID
                                                    $whereDates
                                                    $whereCostCenter2
                    ");

                    $taxes = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal[$elem['ID']]['taxes'] = $taxes == null ? 0 : $taxes;
                }

                if($mortuary == ''){
                    // Otros
                    $costCentersAlreadyChecked = implode(',', $costCentersIds);
                    $mortuariesAlreadyChecked = implode(',', $mortuariesIds);

                    $whereCostCenter = '';
                    if($mortuariesAlreadyChecked != ''){
                        $whereCostCenter = " AND cc.ID NOT IN ($mortuariesAlreadyChecked)";
                    }
    
                    $resultFinal['Otros']['name'] = 'Otras instalaciones';
    
                    $from = ', Cost_Center cc';
    
                    // Facturado
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
                    }
    
                    $result = $db->query("  SELECT      e.expedientID, 
                                                        (
                                                            (
                                                                SELECT      COALESCE(SUM(iniv.base), 0)
                                                                FROM        Invoices i
                                                                JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                WHERE       i.leavingDate IS NULL AND
                                                                            i.invoice_type != 3 AND
                                                                            (
                                                                                (
                                                                                    i.ID = (
                                                                                        SELECT  MAX(i2.ID)
                                                                                        FROM    Invoices i2
                                                                                        WHERE   i2.leavingDate IS NULL AND
                                                                                                i2.invoice_type != 3 AND
                                                                                                i2.expedient = i.expedient AND 
                                                                                                (
                                                                                                    i2.rectified_type IS NULL OR 
                                                                                                    (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                )
                                                                                    )
                                                                                ) OR
                                                                                (
                                                                                    i.rectified_type = 2
                                                                                )
                                                                            ) AND
                                                                            i.expedient = e.expedientID
                                                            )
                                                        ) as earned,
                                                        e.client
                                            FROM        Expedients e, Clients c, Cost_Center cc
                                            WHERE       e.client = c.clientID AND
                                                        e.leavingDate IS NULL AND
                                                        e.type != 2 AND
                                                        (
                                                            e.deceasedMortuary IS NULL OR
                                                            (
                                                                e.deceasedMortuary IS NOT NULL AND
                                                                e.deceasedMortuary = cc.mortuary
                                                                $whereCostCenter
                                                            )
                                                        )
                                                        $whereDates
                                            GROUP BY    e.expedientID
                                            ORDER BY    e.client
                    ");
    
                    if(mysqli_num_rows($result) > 0){
                        $earned =  $db->resultToArray($result);
    
                        $total = 0;
                        foreach($earned as $index => $expedient){
                            $id = $expedient['expedientID'];
    
                            $result = $db->query("  SELECT      SUM(eh.total) as cost
                                                    FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                                    LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                                    WHERE       eh.expedient = $id AND 
                                                                eh.check = 1 AND 
                                                                eh.expedient = e.expedientID AND
                                                                eh.model = pm.productModelID AND
                                                                eh.product = pr.productID AND
                                                                pr.IVA = it.IVATypeID AND
                                                                pr.leavingDate IS NULL AND
                                                                pr.supplied = 1 AND
                                                                pr.isInvoiced = 0 AND
                                                                eh.num_hiring = (
                                                                    SELECT  MAX(i2.num_hiring) 
                                                                    FROM    Invoices i2 
                                                                    WHERE   i2.expedient = e.expedientID AND
                                                                            i2.leavingDate IS NULL AND
                                                                            i2.invoice_type != 3
                                                                )
                            ");
    
                            if(mysqli_num_rows($result) > 0){
                                $supplieds = $db->resultToArray($result)[0]['cost']; 
                                if($supplieds == null){
                                    $supplieds = '0.00';
                                }
                                $total +=  floatval($expedient['earned']) + floatval($supplieds);
                            } 
                        }
                    }else{
                        $total = null;
                    }
    
                    $resultFinal['Otros']['invoice'] = $total == null ? 0 : $total;
    
                    // Gastos fijos
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND rip.date BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND DAY(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND MONTH(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND YEAR(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                    }
    
                    $result = $db->query("  SELECT  SUM(rip.amount) as total
                                            FROM    Received_Invoices_Payments rip, Received_Invoices ri, Cost_Center cc
                                            WHERE   rip.invoice = ri.ID AND
                                                    ri.leavingDate IS NULL AND
                                                    ri.expenseFixed IS NOT NULL AND
                                                    rip.leavingDate IS NULL AND
                                                    ri.costCenter = cc.ID
                                                    $whereCostCenter
                                                    $whereDates
                    ");
    
                    $fixedExpenses = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal['Otros']['expensesFixed'] = $fixedExpenses == null ? 0 : $fixedExpenses;
    
                    // Gastos variables
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND rip.date BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND DAY(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND MONTH(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND YEAR(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                    }
                    
                    $result = $db->query("  SELECT  SUM(rip.amount) as total
                                            FROM    Received_Invoices_Payments rip, Received_Invoices ri, Cost_Center cc
                                            WHERE   rip.invoice = ri.ID AND
                                                    ri.leavingDate IS NULL AND
                                                    ri.expenseVariable IS NOT NULL AND
                                                    ri.costCenter = cc.ID AND
                                                    rip.leavingDate IS NULL 
                                                    $whereCostCenter
                                                    $whereDates");
    
                    $fixedVariable = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal['Otros']['expensesVariable'] = $fixedVariable == null ? 0 : $fixedVariable;
    
                    // Salarios
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND MONTH(FROM_UNIXTIME(s.date, '%Y-%c-%e')) BETWEEN MONTH(FROM_UNIXTIME($dateSince, '%Y-%c-%e')) AND MONTH(FROM_UNIXTIME($dateUntil, '%Y-%c-%e'))";
                        }
                    }else{
                        $whereDates .= " AND MONTH(FROM_UNIXTIME(s.date, '%Y-%c-%e')) BETWEEN MONTH(FROM_UNIXTIME($date, '%Y-%c-%e')) AND MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                    }
    
                    $result = $db->query("  SELECT  SUM(s.companyCost) as total
                                            FROM    Salaries s, Staff st
                                            WHERE   s.staff = st.ID AND
                                                    st.leavingDate IS NULL
                                                    $whereDates");
    
                    $salaries = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal['Otros']['salaries'] = $salaries == null ? 0 : $salaries;
    
                    // Intereses
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND fc.startDate BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND fc.startDate = $date";
                    }
                    
                    $result = $db->query("  SELECT  SUM(ABS(fc.interest)) as total
                                            FROM    Financing_Cuotas fc, Financing f, Cost_Center cc
                                            WHERE   fc.payDate IS NOT NULL AND
                                                    fc.financing = f.ID AND
                                                    f.financeCenter = cc.ID AND
                                                    f.leavingDate IS NULL 
                                                    $whereCostCenter
                                                    $whereDates
                    ");
    
                    $financingInterest = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal['Otros']['interest'] = $financingInterest == null ? 0 : $financingInterest;
    
                    // Tasas e impuestos
                    $whereDates = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $whereDates .= " AND t.creationDate BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $whereDates .= " AND DAY(FROM_UNIXTIME(i.creationDate, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND MONTH(FROM_UNIXTIME(i.creationDate, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND YEAR(FROM_UNIXTIME(i.creationDate, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                    }
    
                    $result = $db->query("  SELECT  SUM(t.taxBase) as total
                                            FROM    Taxes t, Cost_Center cc
                                            WHERE   t.leavingDate IS NULL AND
                                                    t.costCenter = cc.ID 
                                                    $whereCostCenter
                                                    $whereDates
                    ");
    
                    $taxes = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                    $resultFinal['Otros']['taxes'] = $taxes == null ? 0 : $taxes;
                }

                // Total
                $resultFinal['total']['name'] = 'Total';

                $result = $db->query("  SELECT      e.expedientID, 
                                                    (
                                                        (
                                                            SELECT      COALESCE(SUM(iniv.base), 0)
                                                            FROM        Invoices i
                                                            JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                            WHERE       i.leavingDate IS NULL AND
                                                                        i.invoice_type != 3 AND
                                                                        (
                                                                            (
                                                                                i.ID = (
                                                                                    SELECT  MAX(i2.ID)
                                                                                    FROM    Invoices i2
                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                            i2.invoice_type != 3 AND
                                                                                            i2.expedient = i.expedient AND 
                                                                                            (
                                                                                                i2.rectified_type IS NULL OR 
                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                            )
                                                                                )
                                                                            ) OR
                                                                            (
                                                                                i.rectified_type = 2
                                                                            )
                                                                        ) AND
                                                                        i.expedient = e.expedientID
                                                        )
                                                    ) as earned, 
                                                    e.client
                                        FROM        Expedients e
                                        LEFT JOIN   Cost_Center cc ON e.deceasedMortuary = cc.mortuary
                                        WHERE       e.leavingDate IS NULL AND
                                                    e.type != 2
                                                    $where
                                                    $whereCC
                                        ORDER BY    e.client
                ");

                if(mysqli_num_rows($result) > 0){
                    $earned =  $db->resultToArray($result);

                    $total = 0;
                    foreach($earned as $index => $expedient){
                        $id = $expedient['expedientID'];

                        $result = $db->query("  SELECT      SUM(eh.total) as cost
                                                FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                                LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                                WHERE       eh.expedient = $id AND 
                                                            eh.check = 1 AND 
                                                            eh.expedient = e.expedientID AND
                                                            eh.model = pm.productModelID AND
                                                            eh.product = pr.productID AND
                                                            pr.IVA = it.IVATypeID AND
                                                            pr.leavingDate IS NULL AND
                                                            pr.supplied = 1 AND
                                                            pr.isInvoiced = 0 AND
                                                            eh.num_hiring = (
                                                                SELECT  MAX(i2.num_hiring) 
                                                                FROM    Invoices i2 
                                                                WHERE   i2.expedient = e.expedientID AND
                                                                        i2.leavingDate IS NULL AND
                                                                        i2.invoice_type != 3
                                                            )
                        ");

                        if(mysqli_num_rows($result) > 0){
                            $supplieds = $db->resultToArray($result)[0]['cost']; 
                            if($supplieds == null){
                                $supplieds = '0.00';
                            }
                            $total +=  floatval($expedient['earned']) + floatval($supplieds);
                        } 
                    }
                }else{
                    $total = null;
                }

                $resultFinal['total']['invoice'] = $total == null ? 0 : $total;

                // Gastos fijos
                $where = '';
                if($date == ''){
                    if($dateSince != '' && $dateUntil != ''){
                        $where .= " AND rip.date BETWEEN $dateSince AND $dateUntil";
                    }
                }else{
                    $where .= " AND DAY(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                AND MONTH(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                AND YEAR(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                }

                if($mortuary != ''){
                    $where .= " AND (";
                    foreach($mortuary as $elem){
                        $elem = cleanStr($elem);
                        
                        $where .= " ri.costCenter = cc.ID AND cc.ID = $elem OR";
                    }
                    $from = ', Cost_Center cc';
                    $where = substr($where, 0, -3);
                    $where .= ")";
                }else{
                    $from = '';
                }
                
                $result = $db->query("  SELECT  SUM(rip.amount) as total
                                        FROM    Received_Invoices_Payments rip, Received_Invoices ri $from
                                        WHERE   rip.invoice = ri.ID AND
                                                ri.leavingDate IS NULL AND
                                                ri.expenseFixed IS NOT NULL AND
                                                rip.leavingDate IS NULL
                                                $where");

                $fixedExpenses = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                $resultFinal['total']['expensesFixed'] = $fixedExpenses == null ? 0 : $fixedExpenses;

                // Gastos variables
                $where = '';
                if($date == ''){
                    if($dateSince != '' && $dateUntil != ''){
                        $where .= " AND rip.date BETWEEN $dateSince AND $dateUntil";
                    }
                }else{
                    $where .= " AND DAY(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                AND MONTH(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                AND YEAR(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                }

                if($mortuary != ''){
                    $where .= " AND (";
                    foreach($mortuary as $elem){
                        $elem = cleanStr($elem);
                        
                        $where .= " ri.costCenter = cc.ID AND cc.ID = $elem OR";
                    }
                    $from = ', Cost_Center cc';
                    $where = substr($where, 0, -3);
                    $where .= ")";
                }else{
                    $from = '';
                }
                
                $result = $db->query("  SELECT  SUM(rip.amount) as total
                                        FROM    Received_Invoices_Payments rip, Received_Invoices ri $from
                                        WHERE   rip.invoice = ri.ID AND
                                                ri.leavingDate IS NULL AND
                                                ri.expenseVariable IS NOT NULL AND
                                                rip.leavingDate IS NULL
                                                $where
                ");

                $fixedVariable = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                $resultFinal['total']['expensesVariable'] = $fixedVariable == null ? 0 : $fixedVariable;

                // Salarios
                $where = '';
                if($date == ''){
                    if($dateSince != '' && $dateUntil != ''){
                        $where .= "
                            AND MONTH(FROM_UNIXTIME(s.date, '%Y-%c-%e')) BETWEEN MONTH(FROM_UNIXTIME($dateSince, '%Y-%c-%e')) AND MONTH(FROM_UNIXTIME($dateUntil, '%Y-%c-%e'))
                            AND YEAR(FROM_UNIXTIME(s.date, '%Y-%c-%e')) BETWEEN YEAR(FROM_UNIXTIME($dateSince, '%Y-%c-%e')) AND YEAR(FROM_UNIXTIME($dateUntil, '%Y-%c-%e'))
                        ";
                    }
                }else{
                    $where .= "
                        AND MONTH(FROM_UNIXTIME(s.date, '%Y-%c-%e')) BETWEEN MONTH(FROM_UNIXTIME($date, '%Y-%c-%e')) AND MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                        AND YEAR(FROM_UNIXTIME(s.date, '%Y-%c-%e')) BETWEEN YEAR(FROM_UNIXTIME($date, '%Y-%c-%e')) AND YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))
                    ";
                }

                $result = $db->query("  SELECT  SUM(s.companyCost) as total
                                        FROM    Salaries s, Staff st
                                        WHERE   s.staff = st.ID AND
                                                st.leavingDate IS NULL
                                                $where
                ");

                $salaries = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                $resultFinal['total']['salaries'] = $salaries == null ? 0 : $salaries;

                // Intereses
                $where = '';
                if($date == ''){
                    if($dateSince != '' && $dateUntil != ''){
                        $where .= " AND fc.startDate BETWEEN $dateSince AND $dateUntil";
                    }
                }else{
                    $where .= " AND fc.startDate = $date";
                }

                if($mortuary != ''){
                    $where .= " AND (";
                    foreach($mortuary as $elem){
                        $elem = cleanStr($elem);
                        
                        $where .= " f.financeCenter = cc.ID AND cc.ID = $elem OR";
                    }
                    $from = ', Cost_Center cc';
                    $where = substr($where, 0, -3);
                    $where .= ")";
                }else{
                    $from = '';
                }
                
                $result = $db->query("  SELECT  SUM(ABS(fc.interest)) as total
                                        FROM    Financing_Cuotas fc, Financing f $from
                                        WHERE   fc.payDate IS NOT NULL AND
                                                fc.financing = f.ID AND
                                                f.leavingDate IS NULL
                                                $where
                ");

                $financingInterest = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                $resultFinal['total']['interest'] = $financingInterest == null ? 0 : $financingInterest;

                // Tasas e impuestos
                $where = '';
                if($date == ''){
                    if($dateSince != '' && $dateUntil != ''){
                        $where .= " AND t.creationDate BETWEEN $dateSince AND $dateUntil";
                    }
                }else{
                    $where .= " AND DAY(FROM_UNIXTIME(i.creationDate, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                AND MONTH(FROM_UNIXTIME(i.creationDate, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                AND YEAR(FROM_UNIXTIME(i.creationDate, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                }

                if($mortuary != ''){
                    $where .= " AND (";
                    foreach($mortuary as $elem){
                        $elem = cleanStr($elem);
                        
                        $where .= " t.costCenter = cc.ID AND cc.ID = $elem OR";
                    }
                    $from = ', Cost_Center cc';
                    $where = substr($where, 0, -3);
                    $where .= ")";
                }else{
                    $from = '';
                }

                $result = $db->query("  SELECT  SUM(t.taxBase) as total
                                        FROM    Taxes t $from
                                        WHERE   t.leavingDate IS NULL
                                                $where
                ");

                $taxes = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['total'];
                $resultFinal['total']['taxes'] = $taxes == null ? 0 : $taxes;
                
                return $resultFinal;
            }
        }

        /**
         * Obtiene los datos de la estadística Rendimiento económico
         * 
         * @param int $date Fecha
         * @param int $dateSince Fecha desde
         * @param int $dateUntil Fecha hasta
         * @return array
         */
        public function getEconomicPerformance($date, $dateSince, $dateUntil){
            $db = new DbHandler;

            $date = cleanStr($date);
            $dateSince = cleanStr($dateSince);
            $dateUntil = cleanStr($dateUntil);

            // Tanatorios propios
            $result = $db->query("  SELECT  cc.ID, cc.name, cc.mortuary
                                    FROM    Cost_Center cc
                                    WHERE   cc.leavingDate IS NULL");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $mortuaries = $db->resultToArray($result);

                $data = array();

                $mortuariesNames = array();
                $invoiced = array();
                $fixedExpenses = array();
                $totalFixedExpenses = array();
                $variableExpenses = array();
                $totalVariableExpenses = array();
                $interests = array();
                $salaries = array();

                // Listado de gastos fijos
                $fixedItems = array();
                $result = $db->query("  SELECT  ef.ID, ef.name
                                        FROM    Expenses_Fixed ef
                                        WHERE   ef.leavingDate IS NULL");

                if(mysqli_num_rows($result) > 0){
                    $fixedItems = $db->resultToArray($result);
                }

                // Listado de gastos variables
                $variableItems = array();
                $result = $db->query("  SELECT  ev.ID, ev.name
                                        FROM    Expenses_Variable ev
                                        WHERE   ev.leavingDate IS NULL");

                if(mysqli_num_rows($result) > 0){
                    $variableItems = $db->resultToArray($result);
                }

                $mortuariesIds = array();
                foreach($mortuaries as $index => $mortuary){
                    if($mortuary['mortuary'] != null){
                        array_push($mortuariesIds, $mortuary['mortuary']);
                    }

                    // Tanatorios
                    $mortuariesNames[$index] = $mortuary['name'];

                    // Facturado
                    $where = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
                    }

                    if($mortuary['mortuary'] != null){
                        $result = $db->query("  SELECT      e.expedientID, 
                                                            (
                                                                (
                                                                    SELECT      COALESCE(SUM(iniv.base), 0)
                                                                    FROM        Invoices i
                                                                    JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                                    WHERE       i.leavingDate IS NULL AND
                                                                                i.invoice_type != 3 AND
                                                                                (
                                                                                    (
                                                                                        i.ID = (
                                                                                            SELECT  MAX(i2.ID)
                                                                                            FROM    Invoices i2
                                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                                    i2.invoice_type != 3 AND
                                                                                                    i2.expedient = i.expedient AND 
                                                                                                    (
                                                                                                        i2.rectified_type IS NULL OR 
                                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                                    )
                                                                                        )
                                                                                    ) OR
                                                                                    (
                                                                                        i.rectified_type = 2
                                                                                    )
                                                                                ) AND
                                                                                i.expedient = e.expedientID
                                                                )
                                                            ) as earned, 
                                                            e.client
                                                FROM        Expedients e, Clients c, Cost_Center cc
                                                WHERE       e.client = c.clientID AND
                                                            e.leavingDate IS NULL AND
                                                            e.type != 2 AND
                                                            e.deceasedMortuary = cc.mortuary AND
                                                            cc.ID = {$mortuary['ID']}
                                                            $where
                                                ORDER BY    e.client
                        ");

                        if(mysqli_num_rows($result) == 0){
                            $invoiced[$index] = 0;
                        }else{
                            $earned = $db->resultToArray($result);

                            $total = 0;
                            foreach($earned as $expedient){
                                $id = $expedient['expedientID'];

                                $result = $db->query("  SELECT      SUM(eh.total) as cost
                                                        FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                                        LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                                        WHERE       eh.expedient = $id AND 
                                                                    eh.check = 1 AND 
                                                                    eh.expedient = e.expedientID AND
                                                                    eh.model = pm.productModelID AND
                                                                    eh.product = pr.productID AND
                                                                    pr.IVA = it.IVATypeID AND
                                                                    pr.leavingDate IS NULL AND
                                                                    pr.supplied = 1 AND
                                                                    pr.isInvoiced = 0 AND
                                                                    eh.num_hiring = (
                                                                        SELECT  MAX(i2.num_hiring) 
                                                                        FROM    Invoices i2 
                                                                        WHERE   i2.expedient = e.expedientID AND
                                                                                i2.leavingDate IS NULL AND
                                                                                i2.invoice_type != 3
                                                                    )
                                ");

                                $supplieds = 0;
                                if(mysqli_num_rows($result) > 0){
                                    $supplieds = $db->resultToArray($result)[0]['cost']; 
                                    if($supplieds == null){
                                        $supplieds = 0;
                                    }
                                }
                                $total += (floatval($expedient['earned']) + floatval($supplieds));
                            }

                            $invoiced[$index] = $total;
                        }
                    }else{
                        $invoiced[$index] = 0;
                    }

                    // Gastos fijos
                    $where = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $where .= " AND rip.date BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $where .= " AND DAY(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND MONTH(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND YEAR(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                    }

                    foreach($fixedItems as $i => $item){
                        $result = $db->query("  SELECT  SUM(rip.amount) as total
                                                FROM    Received_Invoices_Payments rip, Received_Invoices ri, Cost_Center cc
                                                WHERE   rip.invoice = ri.ID AND
                                                        ri.leavingDate IS NULL AND
                                                        ri.expenseFixed IS NOT NULL AND
                                                        rip.leavingDate IS NULL AND
                                                        ri.costCenter = cc.ID AND
                                                        cc.ID = {$mortuary['ID']} AND
                                                        ri.expenseFixed = {$item['ID']}
                                                        $where
                        ");

                        if(mysqli_num_rows($result) == 0){
                            $fixedExpenses[$index][$i] = 0;
                        }else{
                            $amount = $db->resultToArray($result)[0]['total'];
                            $total = $amount == null ? 0 : $amount;
                            $fixedExpenses[$index][$i] = $total;
                            
                            // Total gastos fijos
                            if(isset($totalFixedExpenses[$index])){
                                $totalFixedExpenses[$index] += $total;
                            }else{
                                $totalFixedExpenses[$index] = $total;
                            }
                        }
                    }

                    // Gastos variables
                    $where = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $where .= " AND rip.date BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $where .= " AND DAY(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND MONTH(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                                    AND YEAR(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
                    }

                    foreach($variableItems as $i => $item){
                        $result = $db->query("  SELECT  SUM(rip.amount) as total
                                                FROM    Received_Invoices_Payments rip, Received_Invoices ri, Cost_Center cc
                                                WHERE   rip.invoice = ri.ID AND
                                                        ri.leavingDate IS NULL AND
                                                        ri.expenseVariable IS NOT NULL AND
                                                        rip.leavingDate IS NULL AND
                                                        ri.costCenter = cc.ID AND
                                                        cc.ID = {$mortuary['ID']} AND
                                                        ri.expenseVariable = {$item['ID']}
                                                        $where
                        ");

                        if(mysqli_num_rows($result) == 0){
                            $variableExpenses[$index][$i] = 0;
                        }else{
                            $amount = $db->resultToArray($result)[0]['total'];
                            $total = $amount == null ? 0 : $amount;
                            $variableExpenses[$index][$i] = $total;

                            // Total variables fijos
                            if(isset($totalVariableExpenses[$index])){
                                $totalVariableExpenses[$index] += $total;
                            }else{
                                $totalVariableExpenses[$index] = $total;
                            }
                        }
                    }

                    // Gastos financieros
                    $where = '';
                    if($date == ''){
                        if($dateSince != '' && $dateUntil != ''){
                            $where .= " AND fc.startDate BETWEEN $dateSince AND $dateUntil";
                        }
                    }else{
                        $where .= " AND fc.startDate = $date";
                    }
                    
                    $result = $db->query("  SELECT  SUM(ABS(fc.interest)) as total
                                            FROM    Financing_Cuotas fc, Financing f
                                            WHERE   f.financeCenter = {$mortuary['ID']} AND
                                                    fc.payDate IS NOT NULL AND
                                                    fc.financing = f.ID AND
                                                    f.leavingDate IS NULL
                                                    $where
                    ");

                    if(mysqli_num_rows($result) == 0){
                        $interests[$index] = 0;
                    }else{
                        $amount = $db->resultToArray($result)[0]['total'];
                        $interests[$index] = $amount == null ? 0 : $amount;
                    }

                    // Sueldos y salarios
                    $salaries[$index] = 0;
                }

                // Otras instalaciones
                $index++;
                $mortuariesAlreadyChecked = implode(',', $mortuariesIds);

                $whereCostCenter = '';
                if($mortuariesAlreadyChecked != ''){
                    $whereCostCenter = " AND cc.ID NOT IN ($mortuariesAlreadyChecked)";
                }

                $mortuariesNames[$index] = 'Otras instalaciones';

                // Facturado
                $where = '';
                if($date == ''){
                    if($dateSince != '' && $dateUntil != ''){
                        $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $dateSince AND $dateUntil";
                    }
                }else{
                    $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) = $date";
                }
                
                $result = $db->query("  SELECT      e.expedientID, 
                                                    (
                                                        (
                                                            SELECT      COALESCE(SUM(iniv.base), 0)
                                                            FROM        Invoices i
                                                            JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                            WHERE       i.leavingDate IS NULL AND
                                                                        i.invoice_type != 3 AND
                                                                        (
                                                                            (
                                                                                i.ID = (
                                                                                    SELECT  MAX(i2.ID)
                                                                                    FROM    Invoices i2
                                                                                    WHERE   i2.leavingDate IS NULL AND
                                                                                            i2.invoice_type != 3 AND
                                                                                            i2.expedient = i.expedient AND 
                                                                                            (
                                                                                                i2.rectified_type IS NULL OR 
                                                                                                (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                            )
                                                                                )
                                                                            ) OR
                                                                            (
                                                                                i.rectified_type = 2
                                                                            )
                                                                        ) AND
                                                                        i.expedient = e.expedientID
                                                        )
                                                    ) as earned,
                                                    e.client
                                        FROM        Expedients e, Clients c, Cost_Center cc
                                        WHERE       e.client = c.clientID AND
                                                    e.leavingDate IS NULL AND
                                                    e.type != 2 AND
                                                    (
                                                        e.deceasedMortuary IS NULL OR
                                                        (
                                                            e.deceasedMortuary IS NOT NULL AND
                                                            e.deceasedMortuary = cc.mortuary
                                                            $whereCostCenter
                                                        )
                                                    )
                                                    $where
                                        ORDER BY    e.client
                ");

                $total = 0;
                if(mysqli_num_rows($result) > 0){
                    $earned =  $db->resultToArray($result);

                    foreach($earned as $expedient){
                        $id = $expedient['expedientID'];

                        $result = $db->query("  SELECT      SUM(eh.total) as cost
                                                FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                                LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                                WHERE       eh.expedient = $id AND 
                                                            eh.check = 1 AND 
                                                            eh.expedient = e.expedientID AND
                                                            eh.model = pm.productModelID AND
                                                            eh.product = pr.productID AND
                                                            pr.IVA = it.IVATypeID AND
                                                            pr.leavingDate IS NULL AND
                                                            pr.supplied = 1 AND
                                                            pr.isInvoiced = 0 AND
                                                            eh.num_hiring = (
                                                                SELECT  MAX(i2.num_hiring) 
                                                                FROM    Invoices i2 
                                                                WHERE   i2.expedient = e.expedientID AND
                                                                        i2.leavingDate IS NULL AND
                                                                        i2.invoice_type != 3
                                                            )
                        ");

                        $supplieds = 0;
                        if(mysqli_num_rows($result) > 0){
                            $supplieds = $db->resultToArray($result)[0]['cost']; 
                            if($supplieds == null){
                                $supplieds = 0;
                            }
                        }
                        $total += floatval($expedient['earned']) + floatval($supplieds);
                    }

                    $invoiced[$index] = $total;
                }else{
                    $invoiced[$index] = $total;
                }

                foreach($fixedItems as $i => $item){
                    $fixedExpenses[$index][$i] = 0;
                    $totalFixedExpenses[$index] = 0;
                }
                foreach($variableItems as $i => $item){
                    $variableExpenses[$index][$i] = 0;
                    $totalVariableExpenses[$index] = 0;
                }
                $interests[$index] = 0;
                $salaries[$index] = 0;

                $data['mortuaries'] = $mortuariesNames;
                $data['invoiced'] = $invoiced;
                $data['fixedExpensesItems'] = $fixedItems;
                $data['fixedExpenses'] = $fixedExpenses;
                $data['totalFixedExpenses'] = $totalFixedExpenses;
                $data['variableExpensesItems'] = $variableItems;
                $data['variableExpenses'] = $variableExpenses;
                $data['totalVariableExpenses'] = $totalVariableExpenses;
                $data['interests'] = $interests;
                $data['salaries'] = $salaries;

                return $data;
            }
        }

        /**
         * Obtiene los datos de la estadística Rendimiento económico
         * 
         * @param int $mortuary Tanatorio
         * @param int $concept Concepto
         * @param int $expense Gasto
         * @return array
         */
        public function getEconomicPerformanceInvoices($date, $dateSince, $dateUntil, $mortuary, $concept, $expense){
            $db = new DbHandler;

            $date = cleanStr($date);
            $dateSince = cleanStr($dateSince);
            $dateUntil = cleanStr($dateUntil);
            $mortuary = cleanStr($mortuary);
            $concept = cleanStr($concept);
            $expense = cleanStr($expense);
            
            // Facturas recibidas
            $where = '';
            $whereDates = '';
            $from = '';
            if($date == ''){
                if($dateSince != '' && $dateUntil != ''){
                    $where .= " AND rip.date BETWEEN $dateSince AND $dateUntil";
                    $whereDates .= " AND rip2.date BETWEEN $dateSince AND $dateUntil";
                }
            }else{
                $where .= " AND DAY(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                            AND MONTH(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                            AND YEAR(FROM_UNIXTIME(rip.date, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";

                $whereDates .= " AND DAY(FROM_UNIXTIME(rip2.date, '%Y-%c-%e')) = DAY(FROM_UNIXTIME($date, '%Y-%c-%e'))
                            AND MONTH(FROM_UNIXTIME(rip2.date, '%Y-%c-%e')) = MONTH(FROM_UNIXTIME($date, '%Y-%c-%e'))
                            AND YEAR(FROM_UNIXTIME(rip2.date, '%Y-%c-%e')) = YEAR(FROM_UNIXTIME($date, '%Y-%c-%e'))";
            }
            if($mortuary != ''){
                $where .= " AND ri.costCenter = cc.ID AND cc.name = '$mortuary'";
                $from .= ", Cost_Center cc";
            }
            if($concept != ''){
                switch($expense){
                    case '1':
                        $where .= " AND ri.expenseFixed = ef.ID AND ef.name = '$concept'";
                        $from .= ", Expenses_Fixed ef";
                    break;
                    case '2':
                        $where .= " AND ri.expenseVariable = ev.ID AND ev.name = '$concept'";
                        $from .= ", Expenses_Variable ev";
                    break;
                }
            }else{
                switch($expense){
                    case '1':
                        $where .= " AND ri.expenseFixed = ef.ID";
                        $from .= ", Expenses_Fixed ef";
                    break;
                    case '2':
                        $where .= " AND ri.expenseVariable = ev.ID";
                        $from .= ", Expenses_Variable ev";
                    break;
                }
            }

            // IVA_Types
            $ivasBD = [];
            $ivasColumns = '';
            $result = $db->query("  SELECT      *
                                    FROM        IVA_Types it
                                    WHERE       it.leavingDate IS NULL AND
                                                it.type = 2
                                    ORDER BY    it.percentage ASC
            ");
            if(mysqli_num_rows($result) > 0){
                $ivasAux = $db->resultToArray($result);
                $ivasColumns = '';
                foreach($ivasAux as $index=>$it){
                    array_push(
                        $ivasBD,
                        array(
                            'percentage' => $it['percentage'],
                            'total' => 0
                        )
                    );

                    $ivasColumns .= "0 as taxBase$index,";
                }
            }
            
            $result = $db->query("  SELECT      ri.ID, 
                                                ri.invoiceNumber, 
                                                ri.date, 
                                                s.nif, 
                                                IF(ri.supplier IS NULL, ri.shipper, s.name) as name, 
                                                $ivasColumns
                                                ri.withholding, 
                                                ri.supplied, 
                                                ri.total, 
                                                (
                                                    SELECT  SUM(rip2.amount)
                                                    FROM    Received_Invoices_Payments rip2
                                                    WHERE   rip2.invoice = ri.ID AND
                                                            rip2.leavingDate IS NULL 
                                                            $whereDates
                                                ) as total_paid,
                                                (
                                                    IF(
                                                        (
                                                            SELECT  SUM(rip2.amount)
                                                            FROM    Received_Invoices_Payments rip2
                                                            WHERE   rip2.invoice = ri.ID AND
                                                                    rip2.leavingDate IS NULL
                                                        ) >= ri.total,
                                                        '<strong>SI</strong>',
                                                        IF(
                                                            (
                                                                SELECT  SUM(rip2.amount)
                                                                FROM    Received_Invoices_Payments rip2
                                                                WHERE   rip2.invoice = ri.ID AND
                                                                        rip2.leavingDate IS NULL
                                                            ) = 0,
                                                            '<strong>NO</strong>',
                                                            '<strong>Pago Parcial</strong>'
                                                        )
                                                    )
                                                ) as paid
                                    FROM        (Received_Invoices ri, Received_Invoices_Payments rip$from)
                                    LEFT JOIN   Suppliers s ON ri.supplier = s.supplierID
                                    WHERE       ri.leavingDate IS NULL AND
                                                rip.invoice = ri.ID AND
                                                rip.leavingDate IS NULL
                                                $where
                                    GROUP BY    ri.ID
                                    ORDER BY    ri.ID DESC
            ");

            $dataInvoice = $db->resultToArrayValue($result);
            $index = 0;
            foreach($dataInvoice as $elem){
                if($elem[5] != null){
                    $invoiceID = $elem[0];

                    $ivasItem = $ivasBD;

                    // Get invoice ivas
                    $resultInvoiceIvas = $db->query("SELECT     iniv.typeIva,
                                                                iniv.base,
                                                                iniv.iva
                                                    FROM        Received_Invoices_Ivas iniv
                                                    WHERE       iniv.deleteDate IS NULL AND
                                                                iniv.received_invoice  = $invoiceID
                    ");
                    if(mysqli_num_rows($resultInvoiceIvas) > 0){
                        $invoiceIvas = $db->resultToArray($resultInvoiceIvas);
                        foreach($invoiceIvas as $invoiceIv){
                            $found = array_search($invoiceIv["typeIva"], array_column($ivasItem, 'percentage'));
                            if($found !== false){
                                $newIndex = 5 + $found;
                                $dataInvoice[$index][$newIndex] += $invoiceIv["base"];
                            }
                        }
                    }
                }

                $dataInvoice[$index][17] = null;
                if(is_dir($_SESSION['basePath'] . "resources/files/{$_SESSION['company']}/receivedInvoices/{$dataInvoice[$index][0]}/")){
                    $scan = scandir($_SESSION['basePath'] . "resources/files/{$_SESSION['company']}/receivedInvoices/{$dataInvoice[$index][0]}/");
                    array_shift($scan);
                    array_shift($scan);
                    
                    $items = array();
                    foreach($scan as $elem){
                        if(is_file($_SESSION['basePath'] . "resources/files/{$_SESSION['company']}/receivedInvoices/{$dataInvoice[$index][0]}/$elem")){
                            $dataInvoice[$index][17] = $elem;
                        }
                    }
                }
                
                $index++;
            }
            return $dataInvoice;
        }

        /**
         * Obtiene los datos de la estadística Rendimiento económico
         * 
         * @param int $mortuary Tanatorio
         * @param int $concept Concepto
         * @param int $expense Gasto
         * @return array
         */
        public function getEconomicPerformanceFinancing($date, $dateSince, $dateUntil, $mortuary){
            $db = new DbHandler;

            $date = cleanStr($date);
            $dateSince = cleanStr($dateSince);
            $dateUntil = cleanStr($dateUntil);
            $mortuary = cleanStr($mortuary);
            
            // Facturas recibidas
            $where = '';
            $from = '';
            if($date == ''){
                if($dateSince != '' && $dateUntil != ''){
                    $where .= " AND fi.startDate BETWEEN $dateSince AND $dateUntil";
                }
            }else{
                $where .= " AND fi.startDate = $dateSince";
            }
            if($mortuary != ''){
                $where .= " AND ri.costCenter = cc.ID AND cc.mortuary = m.mortuaryID AND m.name = '$mortuary'";
                $from .= ", Cost_Center cc, Mortuaries m";
            }
            
            $result = $db->query("  SELECT      f.ID, f.name, f.providerEntity, fd.name, f.startDate, f.endDate, f.term, f.pendingFee, f.amortization, f.initialCapital, f.amortizedCapital, f.pendingCapital, fm.name, m.name
                                    FROM        Financing f
                                    LEFT JOIN   Financing_Destinations fd ON f.destination = fd.ID
                                    LEFT JOIN   Financing_Methods fm ON f.payMethod = fm.ID
                                    LEFT JOIN   Mortuaries m ON f.financeCenter = m.mortuaryID
                                    WHERE       f.leavingDate IS NULL");

            if(mysqli_num_rows($result) == 0){
                return array();
            }else{
                return $db->resultToArrayValue($result);
            }
        }

        /**
         * Obtiene los datos para mostrar en la estadísticas Horarios de servicios
         * 
         * @param array $staff Personal
         * @param array $carriers Porteadores
         * @param int $sinceDate Fecha desde
         * @param int $untilDate Fecha hasta
         * @return array
         */
        public function getServicesTimes($staff, $carriers, $sinceDate, $untilDate){
            $db = new DbHandler;
         
            if($staff != ''){
                foreach($staff as $index => $elem){
                    $staff[$index]["staff"] = cleanStr($elem["staff"]);
                    $staff[$index]["user"] = cleanStr($elem["user"]);
                }
            }
            if($carriers != ''){
                foreach($carriers as $index => $elem){
                    $carriers[$index] = cleanStr($elem);
                }
            }
            $sinceDate = cleanStr($sinceDate);
            $untilDate = cleanStr($untilDate);

            // Staff result (0 => staff, 1 => user, 2 => carrier)
            $staffResult = array();

            if($staff != '' || ($staff == '' && $carriers == '')){
                $where = '';
                if($staff != ''){
                    $where .= " AND (";
                    foreach($staff as $elem){
                        $where .= "s.ID = {$elem['staff']} OR ";
                    }
                    $where = substr($where, 0, -4);
                    $where .= ")";
                }

                // Staff
                $result = $db->query("  SELECT      s.ID, s.user, CONCAT(s.name, ' ', s.surname) as staff_name, CONCAT(u.name, '', u.surname) as user_name
                                        FROM        Staff s
                                        LEFT JOIN   Users u ON s.user = u.userID
                                        WHERE       s.leavingDate IS NULL
                                                    $where
                                        ORDER BY    s.name, s.surname");

                if(mysqli_num_rows($result) > 0){
                    $result = $db->resultToArray($result);

                    foreach($result as $elem){
                        $userData = null;

                        if($elem['user'] != ''){
                            $userData = array(
                                'id' => $elem['user'],
                                'name' => $elem['user_name']
                            );
                        }

                        array_push(
                            $staffResult,
                            array(
                                array(
                                    'id' => $elem['ID'],
                                    'name' => $elem['staff_name']
                                ),
                                $userData,
                                null
                            )
                        );
                    }
                }
            }

            if($carriers != '' || ($staff == '' && $carriers == '')){
                $where = '';
                if($carriers != ''){
                    $where .= " AND (";
                    foreach($carriers as $elem){
                        $where .= "c.carrierID = {$elem} OR ";
                    }
                    $where = substr($where, 0, -4);
                    $where .= ")";
                }

                // Carriers
                $result = $db->query("  SELECT      c.carrierID, CONCAT(c.name, ' ', c.surname) as carrier_name
                                        FROM        Carriers c
                                        WHERE       c.leavingDate IS NULL
                                                    $where
                                        ORDER BY    c.name, c.surname
                ");

                if(mysqli_num_rows($result) > 0){
                    $result = $db->resultToArray($result);

                    foreach($result as $elem){
                        array_push(
                            $staffResult,
                            array(
                                null,
                                null,
                                array(
                                    'id' => $elem['carrierID'],
                                    'name' => $elem['carrier_name']
                                ),
                            )
                        );
                    }
                }
            }

            $filter = array();

            foreach($staffResult as $elem){
                $data = array();

                if($elem[2] != null){
                    $where = '';
                    if($sinceDate != '' && $untilDate != ''){
                        $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $sinceDate AND $untilDate";
                    }
                    
                    // Name
                    $data['name'] = $elem[2]['name'];

                    // Recogida del Cadáver
                    $data['corpseCollection'] = '-';

                    // Atención familia
                    $data['familyAssistance'] = '-';

                    // Creación de documentos
                    $data['makeDocuments'] = '-';

                    // Visualización de documentos
                    $data['viewDocuments'] = '-';

                    // Servicios diurnos
                    $result = $db->query("  SELECT  DISTINCT COUNT(*) as amount 
                                            FROM    Services_Carriers sc, Expedients e, Expedients_Services es
                                            WHERE   sc.carrier = {$elem[2]['id']} AND
                                                    sc.service = e.expedientID AND
                                                    e.leavingDate IS NULL AND
                                                    e.expedientID = es.expedient AND
                                                    es.carriersTime IS NOT NULL AND
                                                    e.type != 2 AND
                                                    e.requestTime BETWEEN '08:00:00' AND '21:59:59'
                                                    $where");

                    $data['dailyService'] = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                    // Servicios nocturnos
                    $result = $db->query("  SELECT  DISTINCT COUNT(*) as amount 
                                            FROM    Services_Carriers sc, Expedients e, Expedients_Services es
                                            WHERE   sc.carrier = {$elem[2]['id']} AND
                                                    sc.service = e.expedientID AND
                                                    e.leavingDate IS NULL AND
                                                    e.expedientID = es.expedient AND
                                                    es.carriersTime IS NOT NULL AND
                                                    e.type != 2 AND
                                                    (
                                                        (e.requestTime BETWEEN '22:00:00' AND '23:59:59') OR
                                                        (e.requestTime BETWEEN '00:00:00' AND '07:59:59')
                                                    )
                                                    $where");

                    $data['nightlyService'] = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                    // Reparto de esquelas
                    $data['obituariesDeliver'] = '-';

                    // Juzgado
                    $data['tribunal'] = '-';

                    // Certificado médico
                    $data['doctor'] = '-';

                    // Eventos de taller
                    $data['garageEvents'] = '-';

                    // Eventos de mantenimiento
                    $data['upkeepEvents'] = '-';

                    // Tiempo medio de respuesta
                    $data['responseTime'] = '-';

                    // Expediente lunes
                    $where = '';
                    if($sinceDate != '' && $untilDate != ''){
                        $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.funeralDate, '%Y-%c-%e')) BETWEEN $sinceDate AND $untilDate";
                    }

                    $result = $db->query("  SELECT  COUNT(*) as amount
                                            FROM    Services_Carriers sc, Expedients e
                                            WHERE   sc.carrier = {$elem[2]['id']} AND
                                                    sc.service = e.expedientID AND
                                                    DAYNAME(e.funeralDate) = 'Monday' AND
                                                    e.leavingDate IS NULL AND
                                                    e.type != 2
                                                    $where
                    ");   

                    $monday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                    $data['monday'] = $monday;

                    // Expediente martes
                    $result = $db->query("  SELECT  COUNT(*) as amount
                                            FROM    Services_Carriers sc, Expedients e
                                            WHERE   sc.carrier = {$elem[2]['id']} AND
                                                    sc.service = e.expedientID AND
                                                    DAYNAME(e.funeralDate) = 'Tuesday' AND
                                                    e.leavingDate IS NULL AND
                                                    e.type != 2
                                                    $where
                    ");   

                    $tuesday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                    $data['tuesday'] = $tuesday;

                    // Expediente miércoles
                    $result = $db->query("  SELECT  COUNT(*) as amount
                                            FROM    Services_Carriers sc, Expedients e
                                            WHERE   sc.carrier = {$elem[2]['id']} AND
                                                    sc.service = e.expedientID AND
                                                    DAYNAME(e.funeralDate) = 'Wednesday' AND
                                                    e.leavingDate IS NULL AND
                                                    e.type != 2
                                                    $where
                    ");   

                    $wednesday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                    $data['wednesday'] = $wednesday;

                    // Expediente jueves
                    $result = $db->query("  SELECT  COUNT(*) as amount
                                            FROM    Services_Carriers sc, Expedients e
                                            WHERE   sc.carrier = {$elem[2]['id']} AND
                                                    sc.service = e.expedientID AND
                                                    DAYNAME(e.funeralDate) = 'Thursday' AND
                                                    e.leavingDate IS NULL AND
                                                    e.type != 2
                                                    $where
                    ");   

                    $thursday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                    $data['thursday'] = $thursday;

                    // Expediente viernes
                    $result = $db->query("  SELECT  COUNT(*) as amount
                                            FROM    Services_Carriers sc, Expedients e
                                            WHERE   sc.carrier = {$elem[2]['id']} AND
                                                    sc.service = e.expedientID AND
                                                    DAYNAME(e.funeralDate) = 'Friday' AND
                                                    e.leavingDate IS NULL AND
                                                    e.type != 2
                                                    $where
                    ");   

                    $friday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                    $data['friday'] = $friday;

                    // Expediente sábado
                    $result = $db->query("  SELECT  COUNT(*) as amount
                                            FROM    Services_Carriers sc, Expedients e
                                            WHERE   sc.carrier = {$elem[2]['id']} AND
                                                    sc.service = e.expedientID AND
                                                    DAYNAME(e.funeralDate) = 'Saturday' AND
                                                    e.leavingDate IS NULL AND
                                                    e.type != 2
                                                    $where
                    ");   

                    $saturday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                    $data['saturday'] = $saturday;

                    // Expediente domingo
                    $result = $db->query("  SELECT  COUNT(*) as amount
                                            FROM    Services_Carriers sc, Expedients e
                                            WHERE   sc.carrier = {$elem[2]['id']} AND
                                                    sc.service = e.expedientID AND
                                                    DAYNAME(e.funeralDate) = 'Sunday' AND
                                                    e.leavingDate IS NULL AND
                                                    e.type != 2
                                                    $where
                    ");   

                    $sunday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                    $data['sunday'] = $sunday;

                    // Servicios de porteo
                    $result = $db->query("  SELECT  COUNT(*) amount 
                                            FROM    Services_Carriers sc, Expedients e 
                                            WHERE   sc.carrier = {$elem[2]['id']} AND
                                                    sc.service = e.expedientID AND
                                                    e.leavingDate IS NULL
                                                    $where
                    ");

                    $carrierService = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                    $data['carriers'] = $carrierService;
                }else{
                    // Name
                    if($elem[0] == null){
                        $data['name'] = $elem[1]['name'];
                    }else{
                        $data['name'] = $elem[0]['name'];
                    }

                    // Recogida del Cadáver
                    if($elem[0] == null){
                        $data['corpseCollection'] = '-';
                    }else{
                        $where = '';
                        if($sinceDate != '' && $untilDate != ''){
                            $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $sinceDate AND $untilDate";
                        }
    
                        $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                                FROM    Expedients_Services es, Expedients e
                                                WHERE   es.expedient = e.expedientID AND
                                                        e.leavingDate IS NULL AND
                                                        e.type != 2 AND
                                                        (
                                                            es.corpseCollection1 = {$elem[0]['id']} OR
                                                            es.corpseCollection2 = {$elem[0]['id']}
                                                        )
                                                        $where");
        
                        $corpseCollection = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
        
                        $data['corpseCollection'] = $corpseCollection;
                    }

                    // Atención familia
                    if($elem[0] == null){
                        $data['familyAssistance'] = '-';
                    }else{
                        $where = '';
                        if($sinceDate != '' && $untilDate != ''){
                            $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $sinceDate AND $untilDate";
                        }
    
                        $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                                FROM    Expedients_Services es, Expedients e
                                                WHERE   es.expedient = e.expedientID AND
                                                        e.leavingDate IS NULL AND
                                                        e.type != 2 AND
                                                        es.familyAssistance = {$elem[0]['id']}
                                                        $where");
        
                        $familyAssistance = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
        
                        $data['familyAssistance'] = $familyAssistance;
                    }

                    // Creación de documentos
                    if($elem[1] == null){
                        $data['makeDocuments'] = '-';
                    }else{
                        $where = '';
                        if($sinceDate != '' && $untilDate != ''){
                            $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $sinceDate AND $untilDate";
                        }
        
                        $result = $db->query("  SELECT  DISTINCT COUNT(e.expedientID) as amount
                                                FROM    Expedients e, Expedients_Documents ed
                                                WHERE   e.expedientID = ed.expedient AND
                                                        e.type != 2 AND
                                                        e.leavingDate IS NULL AND
                                                        ed.user = {$elem[1]['id']}
                                                        $where");
        
                        $documents = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
        
                        $data['makeDocuments'] = $documents;
                    }

                    // Visualización de documentos
                    if($elem[1] == null){
                        $data['viewDocuments'] = '-';
                    }else{
                        $where = '';
                        if($sinceDate != '' && $untilDate != ''){
                            $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $sinceDate AND $untilDate";
                        }
        
                        $result = $db->query("  SELECT  DISTINCT COUNT(*) as amount
                                                FROM    Logs l, Expedients e
                                                WHERE   l.action = 'Expedientes - C. Servicio - Consulta' AND
                                                        l.user = {$elem[1]['id']} AND
                                                        l.expedient = e.expedientID AND
                                                        e.leavingDate IS NULL AND
                                                        e.type != 2
                                                        $where");
        
                        $documents = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
        
                        $data['viewDocuments'] = $documents;
                    }

                    // Servicios diurnos
                    if($elem[0] == null){
                        $data['dailyService'] = '-';
                    }else{
                        $where = '';
                        if($sinceDate != '' && $untilDate != ''){
                            $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $sinceDate AND $untilDate";
                        }
    
                        $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                                FROM    Expedients_Services es, Expedients e
                                                WHERE   es.expedient = e.expedientID AND
                                                        e.leavingDate IS NULL AND
                                                        e.type != 2 AND
                                                        (
                                                            es.corpseCollection1 = {$elem[0]['id']} OR
                                                            es.corpseCollection2 = {$elem[0]['id']} OR
                                                            es.familyAssistance = {$elem[0]['id']}
                                                        ) AND
                                                        e.requestTime BETWEEN '08:00:00' AND '21:59:59'
                                                        $where");
        
                        $dailyService = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
        
                        $data['dailyService'] = $dailyService;
                    }

                    // Servicios nocturnos
                    if($elem[0] == null){
                        $data['nightlyService'] = '-';
                    }else{
                        $where = '';
                        if($sinceDate != '' && $untilDate != ''){
                            $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $sinceDate AND $untilDate";
                        }
    
                        $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                                FROM    Expedients_Services es, Expedients e
                                                WHERE   es.expedient = e.expedientID AND
                                                        e.leavingDate IS NULL AND
                                                        e.type != 2 AND
                                                        (
                                                            es.corpseCollection1 = {$elem[0]['id']} OR
                                                            es.corpseCollection2 = {$elem[0]['id']} OR
                                                            es.familyAssistance = {$elem[0]['id']}
                                                        ) AND
                                                        (
                                                            (e.requestTime BETWEEN '22:00:00' AND '23:59:59') OR
                                                            (e.requestTime BETWEEN '00:00:00' AND '07:59:59')
                                                        )
                                                        $where");
        
                        $nightlyService = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
        
                        $data['nightlyService'] = $nightlyService;
                    }

                    // Reparto de esquelas
                    if($elem[0] == null){
                        $data['obituariesDeliver'] = '-';
                    }else{
                        $where = '';
                        if($sinceDate != '' && $untilDate != ''){
                            $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $sinceDate AND $untilDate";
                        }
        
                        $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                                FROM    Services_Auto sa, Expedients e, Products_Models pm, Products p
                                                WHERE   sa.service = e.expedientID AND
                                                        sa.value = {$elem[0]['id']} AND
                                                        sa.model = pm.productModelID AND
                                                        pm.product = p.productID AND
                                                        p.name LIKE '%esquelas murales%' AND
                                                        e.type != 2 AND
                                                        e.leavingDate IS NULL
                                                        $where
                        ");
        
                        $obituariesDeliver = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                        
                        $data['obituariesDeliver'] = $obituariesDeliver;
                    }

                    // Juzgado
                    if($elem[0] == null){
                        $data['tribunal'] = '-';
                    }else{
                        $where = '';
                        if($sinceDate != '' && $untilDate != ''){
                            $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $sinceDate AND $untilDate";
                        }
        
                        $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                                FROM    Expedients_Services es, Expedients e
                                                WHERE   es.expedient = e.expedientID AND
                                                        es.tribunalUser = {$elem[0]['id']} AND
                                                        e.type != 2 AND
                                                        e.leavingDate IS NULL
                                                        $where
                        ");
        
                        $tribunal = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
        
                        $data['tribunal'] = $tribunal;
                    }

                    // Certificado médico
                    if($elem[0] == null){
                        $data['doctor'] = '-';
                    }else{
                        $where = '';
                        if($sinceDate != '' && $untilDate != ''){
                            $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $sinceDate AND $untilDate";
                        }
        
                        $result = $db->query("  SELECT  COUNT(e.expedientID) as amount
                                                FROM    Expedients_Services es, Expedients e
                                                WHERE   es.expedient = e.expedientID AND
                                                        es.doctorDeliver = {$elem[0]['id']} AND
                                                        e.type != 2 AND
                                                        e.leavingDate IS NULL
                                                        $where
                        ");
        
                        $doctor = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
        
                        $data['doctor'] = $doctor;
                    }

                    // Eventos de taller
                    if($elem[1] == null){
                        $data['garageEvents'] = '-';
                    }else{
                        $where = '';
                        if($sinceDate != '' && $untilDate != ''){
                            $where .= " AND e.dischargeDay BETWEEN $sinceDate AND $untilDate";
                        }
    
                        $result = $db->query("  SELECT  COUNT(e.ID) as amount
                                                FROM    Events e
                                                WHERE   e.user = {$elem[1]['id']} AND
                                                        e.type IN (9, 8, 7, 6) AND
                                                        e.leavingDate IS NULL
                                                        $where
                        ");
    
                        $garageEvents = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
    
                        $data['garageEvents'] = $garageEvents;
                    }

                    // Eventos de mantenimiento
                    if($elem[1] == null){
                        $data['upkeepEvents'] = '-';
                    }else{
                        $where = '';
                        if($sinceDate != '' && $untilDate != ''){
                            $where .= " AND e.dischargeDay BETWEEN $sinceDate AND $untilDate";
                        }

                        $result = $db->query("  SELECT  COUNT(e.ID) as amount
                                                FROM    Events e
                                                WHERE   e.user = {$elem[1]['id']} AND
                                                        e.type = 2 AND
                                                        e.leavingDate IS NULL
                                                        $where
                        ");

                        $upkeepEvents = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                        $data['upkeepEvents'] = $upkeepEvents;
                    }

                    // Tiempo medio de respuesta
                    if($elem[0] == null){
                        $data['responseTime'] = '-';
                    }else{
                        $where = '';
                        if($sinceDate != '' && $untilDate != ''){
                            $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $sinceDate AND $untilDate";
                        }
    
                        $result = $db->query("  SELECT  UNIX_TIMESTAMP(STR_TO_DATE(CONCAT(es.arriveDate, ' ', es.arriveTime), '%Y-%m-%d %H:%i:%s')) - UNIX_TIMESTAMP(STR_TO_DATE(CONCAT(e.requestDate, ' ', e.requestTime), '%Y-%m-%d %H:%i:%s')) as time
                                                FROM    Expedients_Services es, Expedients e
                                                WHERE   es.expedient = e.expedientID AND
                                                        e.leavingDate IS NULL AND
                                                        e.type != 2 AND
                                                        es.arriveTime IS NOT NULL AND
                                                        es.arriveDate IS NOT NULL AND
                                                        e.requestDate IS NOT NULL AND
                                                        e.requestTime IS NOT NULL AND
                                                        (
                                                            es.corpseCollection1 = {$elem[0]['id']} OR
                                                            es.corpseCollection2 = {$elem[0]['id']} OR
                                                            es.familyAssistance = {$elem[0]['id']}
                                                        )
                                                        $where
                        ");
        
                        $responseTime = mysqli_num_rows($result) == 0 ? array() : $db->resultToArray($result);
                        if(empty($responseTime)){
                            $data['responseTime'] = '-';
                        }else{
                            $totalTime = 0;
                            foreach($responseTime as $item){
                                $totalTime += intval($item['time']);
                            }
                            $data['responseTime'] = $totalTime / count($responseTime);
                        }
                    }

                    // Expediente lunes
                    if($elem[0] == null){
                        $data['monday'] = '-';
                    }else{
                        $where = '';
                        if($sinceDate != '' && $untilDate != ''){
                            $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $sinceDate AND $untilDate";
                        }

                        $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                FROM    Services_Auto sa, Expedients e, Actions a, Staff s
                                                WHERE   sa.service = e.expedientID AND
                                                        e.type != 2 AND
                                                        e.leavingDate IS NULL AND
                                                        sa.action = a.ID  AND
                                                        a.type = 'staff' AND
                                                        sa.value = s.ID AND
                                                        s.ID = {$elem[0]['id']} AND
                                                        sa.service = e.expedientID AND
                                                        DAYNAME(e.requestDate) = 'Monday'
                                                        $where
                        ");

                        $monday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                        if($monday == 0){
                            $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                    FROM    Expedients e
                                                    WHERE   e.leavingDate IS NULL AND
                                                            e.type != 2 AND
                                                            (
                                                                e.responsibleUser = {$elem[0]['id']} ||
                                                                e.crematoriumTechnical = {$elem[0]['id']}
                                                            ) AND
                                                            DAYNAME(e.requestDate) = 'Monday'
                                                            $where
                            ");
    
                            $monday += mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];        
                            
                            if($monday == 0){
                                $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                        FROM    Expedients_Services es, Expedients e
                                                        WHERE   (
                                                                    es.tribunalUser = {$elem[0]['id']} ||
                                                                    es.doctorDeliver = {$elem[0]['id']} ||
                                                                    es.familyAssistance = {$elem[0]['id']} ||
                                                                    es.corpseCollection1 = {$elem[0]['id']} ||
                                                                    es.corpseCollection2 = {$elem[0]['id']}
                                                                ) AND
                                                                e.type != 2 AND
                                                                es.expedient = e.expedientID AND
                                                                DAYNAME(e.requestDate) = 'Monday' AND
                                                                e.leavingDate IS NULL
                                                                $where
                                ");
        
                                $monday += mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];     
                            }
                        }

                        $data['monday'] = $monday;
                    }

                    // Expediente martes
                    if($elem[0] == null){
                        $data['tuesday'] = '-';
                    }else{
                        $where = '';
                        if($sinceDate != '' && $untilDate != ''){
                            $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $sinceDate AND $untilDate";
                        }

                        $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                FROM    Services_Auto sa, Expedients e, Actions a, Staff s
                                                WHERE   sa.service = e.expedientID AND
                                                        e.type != 2 AND
                                                        e.leavingDate IS NULL AND
                                                        sa.action = a.ID  AND
                                                        a.type = 'staff' AND
                                                        sa.value = s.ID AND
                                                        s.ID = {$elem[0]['id']} AND
                                                        sa.service = e.expedientID AND
                                                        DAYNAME(e.requestDate) = 'Tuesday'
                                                        $where
                        ");

                        $tuesday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                        if($tuesday == 0){
                            $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                    FROM    Expedients e
                                                    WHERE   e.leavingDate IS NULL AND
                                                            e.type != 2 AND
                                                            (
                                                                e.responsibleUser = {$elem[0]['id']} ||
                                                                e.crematoriumTechnical = {$elem[0]['id']}
                                                            ) AND
                                                            DAYNAME(e.requestDate) = 'Tuesday'
                                                            $where
                            ");
    
                            $tuesday += mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                            if($tuesday == 0){
                                $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                        FROM    Expedients_Services es, Expedients e
                                                        WHERE   (
                                                                    es.tribunalUser = {$elem[0]['id']} ||
                                                                    es.doctorDeliver = {$elem[0]['id']} ||
                                                                    es.familyAssistance = {$elem[0]['id']} ||
                                                                    es.corpseCollection1 = {$elem[0]['id']} ||
                                                                    es.corpseCollection2 = {$elem[0]['id']}
                                                                ) AND
                                                                es.expedient = e.expedientID AND
                                                                DAYNAME(e.requestDate) = 'Tuesday' AND
                                                                e.type != 2 AND
                                                                e.leavingDate IS NULL
                                                                $where
                                ");
        
                                $tuesday += mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];     
                            }
                        }
                    
                        $data['tuesday'] = $tuesday;
                    }

                    // Expediente miércoles
                    if($elem[0] == null){
                        $data['wednesday'] = '-';
                    }else{
                        $where = '';
                        if($sinceDate != '' && $untilDate != ''){
                            $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $sinceDate AND $untilDate";
                        }

                        $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                FROM    Services_Auto sa, Expedients e, Actions a, Staff s
                                                WHERE   sa.service = e.expedientID AND
                                                        e.type != 2 AND
                                                        e.leavingDate IS NULL AND
                                                        sa.action = a.ID  AND
                                                        a.type = 'staff' AND
                                                        sa.value = s.ID AND
                                                        s.ID = {$elem[0]['id']} AND
                                                        sa.service = e.expedientID AND
                                                        DAYNAME(e.requestDate) = 'Wednesday'
                                                        $where
                        ");

                        $wednesday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                        if($wednesday == 0){
                            $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                    FROM    Expedients e
                                                    WHERE   e.leavingDate IS NULL AND
                                                            (
                                                                e.responsibleUser = {$elem[0]['id']} ||
                                                                e.crematoriumTechnical = {$elem[0]['id']}
                                                            ) AND
                                                            e.type != 2 AND
                                                            DAYNAME(e.requestDate) = 'Wednesday'
                                                            $where
                            ");
    
                            $wednesday += mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                            if($wednesday == 0){
                                $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                        FROM    Expedients_Services es, Expedients e
                                                        WHERE   (
                                                                    es.tribunalUser = {$elem[0]['id']} ||
                                                                    es.doctorDeliver = {$elem[0]['id']} ||
                                                                    es.familyAssistance = {$elem[0]['id']} ||
                                                                    es.corpseCollection1 = {$elem[0]['id']} ||
                                                                    es.corpseCollection2 = {$elem[0]['id']}
                                                                ) AND
                                                                es.expedient = e.expedientID AND
                                                                DAYNAME(e.requestDate) = 'Wednesday' AND
                                                                e.type != 2 AND
                                                                e.leavingDate IS NULL
                                                                $where
                                ");
        
                                $wednesday += mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];     
                            }
                        }
                    
                        $data['wednesday'] = $wednesday;
                    }

                    // Expediente jueves
                    if($elem[0] == null){
                        $data['thursday'] = '-';
                    }else{
                        $where = '';
                        if($sinceDate != '' && $untilDate != ''){
                            $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $sinceDate AND $untilDate";
                        }

                        $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                FROM    Services_Auto sa, Expedients e, Actions a, Staff s
                                                WHERE   sa.service = e.expedientID AND
                                                        e.type != 2 AND
                                                        e.leavingDate IS NULL AND
                                                        sa.action = a.ID  AND
                                                        a.type = 'staff' AND
                                                        sa.value = s.ID AND
                                                        s.ID = {$elem[0]['id']} AND
                                                        sa.service = e.expedientID AND
                                                        DAYNAME(e.requestDate) = 'Thursday'
                                                        $where
                        ");

                        $thursday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                        if($thursday == 0){
                            $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                    FROM    Expedients e
                                                    WHERE   e.leavingDate IS NULL AND
                                                            (
                                                                e.responsibleUser = {$elem[0]['id']} ||
                                                                e.crematoriumTechnical = {$elem[0]['id']}
                                                            ) AND
                                                            e.type != 2 AND
                                                            DAYNAME(e.requestDate) = 'Thursday'
                                                            $where
                            ");
    
                            $thursday += mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                            if($thursday == 0){
                                $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                        FROM    Expedients_Services es, Expedients e
                                                        WHERE   (
                                                                    es.tribunalUser = {$elem[0]['id']} ||
                                                                    es.doctorDeliver = {$elem[0]['id']} ||
                                                                    es.familyAssistance = {$elem[0]['id']} ||
                                                                    es.corpseCollection1 = {$elem[0]['id']} ||
                                                                    es.corpseCollection2 = {$elem[0]['id']}
                                                                ) AND
                                                                es.expedient = e.expedientID AND
                                                                DAYNAME(e.requestDate) = 'Thursday' AND
                                                                e.type != 2 AND
                                                                e.leavingDate IS NULL
                                                                $where
                                ");
        
                                $thursday += mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];     
                            }
                        }
                    
                        $data['thursday'] = $thursday;
                    }

                    // Expediente viernes
                    if($elem[0] == null){
                        $data['friday'] = '-';
                    }else{
                        $where = '';
                        if($sinceDate != '' && $untilDate != ''){
                            $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $sinceDate AND $untilDate";
                        }

                        $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                FROM    Services_Auto sa, Expedients e, Actions a, Staff s
                                                WHERE   sa.service = e.expedientID AND
                                                        e.type != 2 AND
                                                        e.leavingDate IS NULL AND
                                                        sa.action = a.ID  AND
                                                        a.type = 'staff' AND
                                                        sa.value = s.ID AND
                                                        s.ID = {$elem[0]['id']} AND
                                                        sa.service = e.expedientID AND
                                                        DAYNAME(e.requestDate) = 'Friday'
                                                        $where
                        ");

                        $friday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                        if($friday == 0){
                            $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                    FROM    Expedients e
                                                    WHERE   e.leavingDate IS NULL AND
                                                            (
                                                                e.responsibleUser = {$elem[0]['id']} ||
                                                                e.crematoriumTechnical = {$elem[0]['id']}
                                                            ) AND
                                                            e.type != 2 AND
                                                            DAYNAME(e.requestDate) = 'Friday'
                                                            $where
                            ");
    
                            $friday += mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];        
                            
                            if($friday == 0){
                                $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                        FROM    Expedients_Services es, Expedients e
                                                        WHERE   (
                                                                    es.tribunalUser = {$elem[0]['id']} ||
                                                                    es.doctorDeliver = {$elem[0]['id']} ||
                                                                    es.familyAssistance = {$elem[0]['id']} ||
                                                                    es.corpseCollection1 = {$elem[0]['id']} ||
                                                                    es.corpseCollection2 = {$elem[0]['id']}
                                                                ) AND
                                                                es.expedient = e.expedientID AND
                                                                DAYNAME(e.requestDate) = 'Friday' AND
                                                                e.type != 2 AND
                                                                e.leavingDate IS NULL
                                                                $where
                                ");
        
                                $friday += mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];     
                            }
                        }
                    
                        $data['friday'] = $friday;
                    }

                    // Expediente sábado
                    if($elem[0] == null){
                        $data['saturday'] = '-';
                    }else{
                        $where = '';
                        if($sinceDate != '' && $untilDate != ''){
                            $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $sinceDate AND $untilDate";
                        }

                        $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                FROM    Services_Auto sa, Expedients e, Actions a, Staff s
                                                WHERE   sa.service = e.expedientID AND
                                                        e.type != 2 AND
                                                        e.leavingDate IS NULL AND
                                                        sa.action = a.ID  AND
                                                        a.type = 'staff' AND
                                                        sa.value = s.ID AND
                                                        s.ID = {$elem[0]['id']} AND
                                                        sa.service = e.expedientID AND
                                                        DAYNAME(e.requestDate) = 'Saturday'
                                                        $where
                        ");

                        $saturday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                        if($saturday == 0){
                            $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                    FROM    Expedients e
                                                    WHERE   e.leavingDate IS NULL AND
                                                            (
                                                                e.responsibleUser = {$elem[0]['id']} ||
                                                                e.crematoriumTechnical = {$elem[0]['id']}
                                                            ) AND
                                                            e.type != 2 AND
                                                            DAYNAME(e.requestDate) = 'Saturday'
                                                            $where
                            ");
    
                            $saturday += mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];         
                            
                            if($saturday == 0){
                                $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                        FROM    Expedients_Services es, Expedients e
                                                        WHERE   (
                                                                    es.tribunalUser = {$elem[0]['id']} ||
                                                                    es.doctorDeliver = {$elem[0]['id']} ||
                                                                    es.familyAssistance = {$elem[0]['id']} ||
                                                                    es.corpseCollection1 = {$elem[0]['id']} ||
                                                                    es.corpseCollection2 = {$elem[0]['id']}
                                                                ) AND
                                                                es.expedient = e.expedientID AND
                                                                DAYNAME(e.requestDate) = 'Saturday' AND
                                                                e.type != 2 AND
                                                                e.leavingDate IS NULL
                                                                $where
                                ");
        
                                $saturday += mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];     
                            }
                        }
                    
                        $data['saturday'] = $saturday;
                    }

                    // Expediente domingo
                    if($elem[0] == null){
                        $data['sunday'] = '-';
                    }else{
                        $where = '';
                        if($sinceDate != '' && $untilDate != ''){
                            $where .= " AND UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%c-%e')) BETWEEN $sinceDate AND $untilDate";
                        }

                        $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                FROM    Services_Auto sa, Expedients e, Actions a, Staff s
                                                WHERE   sa.service = e.expedientID AND
                                                        e.type != 2 AND
                                                        e.leavingDate IS NULL AND
                                                        sa.action = a.ID  AND
                                                        a.type = 'staff' AND
                                                        sa.value = s.ID AND
                                                        s.ID = {$elem[0]['id']} AND
                                                        sa.service = e.expedientID AND
                                                        DAYNAME(e.requestDate) = 'Sunday'
                                                        $where
                        ");

                        $sunday = mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];

                        if($sunday == 0){
                            $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                    FROM    Expedients e
                                                    WHERE   e.leavingDate IS NULL AND
                                                            (
                                                                e.responsibleUser = {$elem[0]['id']} ||
                                                                e.crematoriumTechnical = {$elem[0]['id']}
                                                            ) AND
                                                            e.type != 2 AND
                                                            DAYNAME(e.requestDate) = 'Sunday'
                                                            $where
                            ");
    
                            $sunday += mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];
                            
                            if($sunday == 0){
                                $result = $db->query("  SELECT  DISTINCT COUNT(*) amount
                                                        FROM    Expedients_Services es, Expedients e
                                                        WHERE   (
                                                                    es.tribunalUser = {$elem[0]['id']} ||
                                                                    es.doctorDeliver = {$elem[0]['id']} ||
                                                                    es.familyAssistance = {$elem[0]['id']} ||
                                                                    es.corpseCollection1 = {$elem[0]['id']} ||
                                                                    es.corpseCollection2 = {$elem[0]['id']}
                                                                ) AND
                                                                es.expedient = e.expedientID AND
                                                                DAYNAME(e.requestDate) = 'Sunday' AND
                                                                e.type != 2 AND
                                                                e.leavingDate IS NULL
                                                                $where
                                ");
        
                                $sunday += mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['amount'];     
                            }
                        }
                    
                        $data['sunday'] = $sunday;
                    }

                    // Servicios de porteo
                    $data['carriers'] = '-';
                }

                array_push($filter, $data);
            }
            
            return $filter;
        }

        /*
         * Obtiene el registro de confecciones
         *
         * @return array
         */
        public function listMakingDatatables($data){
            $db = new DbHandler;

            $data['requestDate'] = cleanStr($data['requestDate']);
            $data['requestDateSince'] = cleanStr($data['requestDateSince']);
            $data['requestDateUntil'] = cleanStr($data['requestDateUntil']);
            $data['birthdate'] = cleanStr($data['birthdate']);
            $data['birthdateSince'] = cleanStr($data['birthdateSince']);
            $data['birthdateUntil'] = cleanStr($data['birthdateUntil']);
            $data['deceasedDate'] = cleanStr($data['deceasedDate']);
            $data['deceasedDateSince'] = cleanStr($data['deceasedDateSince']);
            $data['deceasedDateUntil'] = cleanStr($data['deceasedDateUntil']);
            $data['tribunal'] = cleanStr($data['tribunal']);
            $data['deceasedRoom'] = cleanStr($data['deceasedRoom']);

            $where = '';
            if($data['requestDate'] == ''){
                if($data['requestDateSince'] != '' && $data['requestDateUntil'] != ''){
                    $where .= ' AND e.requestDate BETWEEN "' . $data['requestDateSince'] . '" AND "' . $data['requestDateUntil'] . '"';
                }
            }else{
                $where .= ' AND e.requestDate = "' . $data['requestDate'] . '"';
            }

            if($data['clientType'] != ''){
                $where .= ' AND e.clientType IN (';

                foreach($data['clientType'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                }
                $where = substr($where, 0, -1);

                $where .= ')';

                if($data['client'] != ''){
                    $where .= ' AND c.clientID IN (';

                    foreach($data['client'] as $elem){
                        $elem = cleanStr($elem);
                        $where .= $elem . ',';
                    }
                    $where = substr($where, 0, -1);

                    $where .= ')';
                }
            }

            if($data['birthdate'] == ''){
                if($data['birthdateSince'] != '' && $data['birthdateUntil'] != ''){
                    $where .= ' AND e.deceasedBirthday BETWEEN "' . $data['birthdateSince'] . '" AND "' . $data['birthdateUntil'] . '"';
                }
            }else{
                $where .= ' AND e.deceasedBirthday = "' . $data['birthdate'] . '"';
            }

            if($data['deceasedDate'] == ''){
                if($data['deceasedDateSince'] != '' && $data['deceasedDateUntil'] != ''){
                    $where .= ' AND e.deceasedDate BETWEEN "' . $data['deceasedDateSince'] . '" AND "' . $data['deceasedDateUntil'] . '"';
                }
            }else{
                $where .= ' AND e.deceasedDate = "' . $data['deceasedDate'] . '"';
            }

            if($data['expedientTypes'] != ''){
                $where .= ' AND e.type IN (';

                foreach($data['expedientTypes'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                }
                $where = substr($where, 0, -1);

                $where .= ')';
            }

            if($data['deceasedIn'] != ''){
                $where .= ' AND e.deceasedLocation IN (';

                foreach($data['deceasedIn'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                }
                $where = substr($where, 0, -1);

                $where .= ')';
            }

            if($data['doctor'] != ''){
                $where .= ' AND d.ID IN (';

                foreach($data['doctor'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                }
                $where = substr($where, 0, -1);

                $where .= ')';
            }

            if($data['tribunal'] != ''){
                $where .= ' AND e.deceasedTribunal = "' . $data['tribunal'] . '"';
            }

            if($data['mortuary'] != ''){
                $where .= ' AND m.mortuaryID IN (';

                foreach($data['mortuary'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                }
                $where = substr($where, 0, -1);

                $where .= ')';
            }

            if($data['deceasedRoom'] != ''){
                $where .= ' AND e.deceasedRoom = "' . $data['deceasedRoom'] . '"';
            }

            $result = $db->query("  SELECT      DISTINCT e.expedientID, e.number, e.requestDate, e.deceasedBirthday, e.deceasedDate, e.deceasedTime, e.deceasedTribunal, e.deceasedRoom,
                                                c.name as clientName, c.surname as clientSurname,
                                                di.name as deceasedInName,
                                                d.name as doctorName,
                                                m.name as mortuaryName,
                                                (
                                                    SELECT      COALESCE(SUM(iniv.base), 0) AS base
                                                    FROM        Invoices i
                                                    JOIN        Invoices_Ivas iniv ON iniv.invoice = i.ID AND iniv.deleteDate IS NULL
                                                    WHERE       i.leavingDate IS NULL AND
                                                                i.invoice_type != 3 AND
                                                                (
                                                                    (
                                                                        i.ID = (
                                                                            SELECT  MAX(i2.ID)
                                                                            FROM    Invoices i2
                                                                            WHERE   i2.leavingDate IS NULL AND
                                                                                    i2.invoice_type != 3 AND
                                                                                    i2.expedient = i.expedient AND 
                                                                                    (
                                                                                        i2.rectified_type IS NULL OR 
                                                                                        (i2.rectified_type IS NOT NULL AND i2.rectified_type != 2)
                                                                                    )
                                                                        )
                                                                    ) OR
                                                                    (
                                                                        i.rectified_type = 2
                                                                    )
                                                                ) AND
                                                                i.expedient = e.expedientID
                                                ) AS base
                                    FROM        (Expedients e)
                                    LEFT JOIN   Clients c ON e.client = c.clientID
                                    LEFT JOIN   DeceasedIn di ON e.deceasedLocation = di.deceasedInID
                                    LEFT JOIN   Doctors d ON e.deceasedDoctor = d.ID
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    WHERE       e.leavingDate IS NULL AND
                                                e.type != 2
                                                $where
            ");

            if(mysqli_num_rows($result) == 0){
                return array();
            }else{
                $info = array();

                $expedients = $db->resultToArray($result);

                foreach($expedients as $index => $elem){

                    $result = $db->query("  SELECT  SUM(eh.amount * pr.purchasePrice) as purchasePrice
                                            FROM    Expedients e, Expedients_Hirings eh, Products_Retails pr
                                            WHERE   e.expedientID = " . $elem['expedientID'] . " AND
                                                    e.expedientID = eh.expedient AND
                                                    eh.check = 1 AND
                                                    eh.model = pr.model AND
                                                    pr.year = YEAR(e.requestDate) AND
                                                    eh.num_hiring = (
                                                        SELECT  MAX(i2.num_hiring) 
                                                        FROM    Invoices i2 
                                                        WHERE   i2.expedient = e.expedientID AND
                                                                i2.leavingDate IS NULL AND
                                                                i2.invoice_type != 3
                                                    )
                    ");

                    $purchasePrice = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['purchasePrice'];
                    
                    array_push($info, array(
                        $elem['number'], $elem['requestDate'], $elem['clientName'] . ' ' . $elem['clientSurname'], $elem['deceasedInName'],
                        $elem['deceasedBirthday'], $elem['deceasedDate'], $elem['deceasedTime'], $elem['doctorName'], $elem['deceasedTribunal'], $elem['mortuaryName'],
                        $elem['deceasedRoom'], $elem['base'], $purchasePrice
                    ));
                }

                return $info;
            }
        }

        /**
         * Obtiene los datos del resumen de facturación para el cuadro de mando
         * 
         * @param int $date Fecha
         * @param int $dateSince Fecha desde
         * @param int $dateUntil Fecha hasta
         * @param int $mortuary Centro de coste
         * @param int $clientType Tipos de cliente
         * @param int $client Clientes
         * @param int $poll Encuesta
         * @return array
         */
        public function getExpedientsPolls($dateSince, $dateUntil, $mortuary, $clientType, $client, $poll){
            $db = new DbHandler;

            $dateSince = cleanStr($dateSince);
            $dateUntil = cleanStr($dateUntil);

            $where = '';
            if($dateSince != '' && $dateUntil != ''){
                $dateSince = date('Y-m-d H:i:s', $dateSince);
                $dateUntil = date('Y-m-d H:i:s', $dateUntil);

                $where .= " AND e.entryDate BETWEEN '$dateSince' AND '$dateUntil'";
            }

            $whereCC = '';
            if($mortuary != ''){
                $whereCC .= " AND (";
                foreach($mortuary as $elem){
                    $elem = cleanStr($elem);
                    $whereCC .= " cc.mortuary = $elem OR";
                }
                $whereCC = substr($whereCC, 0, -3);
                $whereCC .= ")";
            }else{
                $whereCC .= " AND cc.mortuary != 0";
            }

            if($clientType != ''){
                $where .= ' AND e.clientType IN (';
                foreach($clientType as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                }
                $where = substr($where, 0, -1);
                $where .= ')';
            }

            if($client != ''){
                $where .= ' AND c.clientID IN (';
                foreach($client as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                }
                $where = substr($where, 0, -1);
                $where .= ')';
            }

            $wherePoll = '';
            $wherePollv2 = '';
            if($poll != ''){
                $wherePoll .= ' AND poit.poll IN (';
                $wherePollv2 .= ' AND p.ID IN (';
                foreach($poll as $elem){
                    $elem = cleanStr($elem);
                    
                    $wherePoll .= $elem . ',';
                    $wherePollv2 .= $elem . ',';
                }
                $wherePoll = substr($wherePoll, 0, -1);
                $wherePoll .= ')';

                $wherePollv2 = substr($wherePollv2, 0, -1);
                $wherePollv2 .= ')';
            }

            $result = $db->query("  SELECT  e.expedientID, CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceased, e.number, e.tpv,
                                            (
                                                SELECT  COUNT(*)
                                                FROM    Expedients_Polls ep
                                                WHERE   ep.leavingDate IS NULL AND
                                                        ep.sent = 1 AND
                                                        ep.expedient = e.expedientID AND
                                                        (
                                                            SELECT  COUNT(*)
                                                            FROM    Expedients_Polls_Results epr, Polls_Items poit
                                                            WHERE   ep.id = epr.expedient_poll AND
                                                                    epr.leavingDate IS NULL AND
                                                                    epr.poll_item = poit.id AND
                                                                    poit.leavingDate IS NULL
                                                                    $wherePoll
                                                        ) > 0
                                                        $where
                                                        $whereCC
                                            ) as total_sended,

                                            (   SELECT  p.title
                                                FROM    Expedients_Services es, Polls p
                                                WHERE   es.expedient = e.expedientID AND
                                                        es.poll = p.ID
                                                        $wherePollv2
                                                        $where
                                                        $whereCC
                                            ) as poll_title,
                                        
                                        (   SELECT  COUNT(DISTINCT(epr.expedient_poll))
                                            FROM    Expedients_Polls ep, Expedients_Polls_Results epr
                                            WHERE   ep.leavingDate IS NULL AND
                                                    ep.sent = 1 AND
                                                    ep.expedient = e.expedientID AND
                                                    ep.id = epr.expedient_poll AND
                                                    epr.leavingDate IS NULL AND
                                                    (
                                                        SELECT  COUNT(*)
                                                        FROM    Polls_Items poit
                                                        WHERE   epr.poll_item = poit.id AND
                                                                poit.leavingDate IS NULL
                                                                $wherePoll
                                                    ) > 0
                                                    $where
                                                    $whereCC
                                        ) total_responsed,
                                        (
                                            (   SELECT  SUM(epr.score)
                                                FROM    Expedients_Polls ep, Expedients_Polls_Results epr
                                                WHERE   ep.leavingDate IS NULL AND
                                                        ep.sent = 1 AND
                                                        ep.expedient = e.expedientID AND
                                                        ep.id = epr.expedient_poll AND
                                                        epr.leavingDate IS NULL AND
                                                        (
                                                            SELECT  COUNT(*)
                                                            FROM    Polls_Items poit
                                                            WHERE   epr.poll_item = poit.id AND
                                                                    poit.leavingDate IS NULL
                                                                    $wherePoll
                                                        ) > 0
                                                    $where
                                                    $whereCC
                                            )
                                            /
                                            (   SELECT  COUNT(*)
                                                FROM    Expedients_Polls ep, Expedients_Polls_Results epr
                                                WHERE   ep.leavingDate IS NULL AND
                                                        ep.sent = 1 AND
                                                        ep.expedient = e.expedientID AND
                                                        ep.id = epr.expedient_poll AND
                                                        epr.leavingDate IS NULL AND
                                                        (
                                                            SELECT  COUNT(*)
                                                            FROM    Polls_Items poit
                                                            WHERE   epr.poll_item = poit.id AND
                                                                    poit.leavingDate IS NULL
                                                                    $wherePoll
                                                        ) > 0
                                                        $where
                                                        $whereCC
                                            )
                                        ) score
                                    FROM        Expedients e
                                    LEFT JOIN   Cost_Center cc ON e.deceasedMortuary = cc.mortuary
                                    LEFT JOIN   Clients c ON e.client = c.clientID
                                    WHERE       e.leavingDate IS NULL AND
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Expedients_Polls ep
                                                    WHERE   ep.leavingDate IS NULL AND
                                                            ep.sent = 1 AND
                                                            ep.expedient = e.expedientID AND
                                                            (
                                                                SELECT  COUNT(*)
                                                                FROM    Expedients_Polls_Results epr, Polls_Items poit
                                                                WHERE   ep.id = epr.expedient_poll AND
                                                                        epr.leavingDate IS NULL AND
                                                                        epr.poll_item = poit.id AND
                                                                        poit.leavingDate IS NULL
                                                                        $wherePoll
                                                            ) > 0
                                                        $where
                                                        $whereCC
                                                ) > 0
                                                $where
                                                $whereCC
                                    ORDER BY    e.expedientID
            ");
           
           return mysqli_num_rows($result) == 0 ? array() : $db->resultToArray($result); 
        }

        /**
         * Obtiene los datos del resumen de facturación para el cuadro de mando
         * 
         * @param int $date Fecha
         * @param int $dateSince Fecha desde
         * @param int $dateUntil Fecha hasta
         * @param int $mortuary Centro de coste
         * @param int $clientType Tipos de cliente
         * @param int $client Clientes
         * @return array
         */
        public function downloadExpedientsPolls($dateSince, $dateUntil, $mortuary, $clientType, $client, $poll){
            $db = new DbHandler;

            $dateSince = cleanStr($dateSince);
            $dateUntil = cleanStr($dateUntil);

            $where = '';
            if($dateSince != '' && $dateUntil != ''){

                $dateSince = date('Y-m-d H:i:s', $dateSince);
                $dateUntil = date('Y-m-d H:i:s', $dateUntil);

                $where .= " AND e.entryDate BETWEEN '$dateSince' AND '$dateUntil'";
            }

            $whereCC = '';
            if($mortuary != ''){
                $whereCC .= " AND (";
                foreach($mortuary as $elem){
                    $elem = cleanStr($elem);
                    $whereCC .= " cc.mortuary = $elem OR";
                }
                $whereCC = substr($whereCC, 0, -3);
                $whereCC .= ")";
            }else{
                $whereCC .= " AND cc.mortuary != 0";
            }

            if($clientType != ''){
                $where .= ' AND e.clientType IN (';
                foreach($clientType as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                }
                $where = substr($where, 0, -1);
                $where .= ')';
            }

            if($client != ''){
                $where .= ' AND c.clientID IN (';
                foreach($client as $elem){
                    $elem = cleanStr($elem);
                    $where .= $elem . ',';
                }
                $where = substr($where, 0, -1);
                $where .= ')';
            }

            $wherePoll = '';
            $wherePollItem = '';
            if($poll != ''){
                $wherePoll .= ' AND p.ID IN (';
                $wherePollItem .= ' AND pit.poll IN (';
                foreach($poll as $elem){
                    $elem = cleanStr($elem);
                    $wherePoll .= $elem . ',';
                    $wherePollItem .= $elem . ',';
                }
                $wherePoll = substr($wherePoll, 0, -1);
                $wherePoll .= ')';

                $wherePollItem = substr($wherePollItem, 0, -1);
                $wherePollItem .= ')';
            }

            $info = array();

            // Get poll headers info  
            $result = $db->query("  SELECT      DISTINCT 
                                                p.id,
                                                p.title,
                                                (
                                                    SELECT  COUNT(*) 
                                                    FROM    Polls_Items pit
                                                    WHERE   pit.poll = p.id AND
                                                            pit.leavingDate IS NULL
                                                            $wherePollItem
                                                ) * 2 as total_questions
                                    FROM        Expedients_Services es, Polls p, Expedients e
                                    LEFT JOIN   Cost_Center cc ON e.deceasedMortuary = cc.mortuary
                                    LEFT JOIN   Clients c ON e.client = c.clientID
                                    WHERE       e.leavingDate IS NULL AND
                                                es.expedient = e.expedientID AND
                                                es.poll = p.ID AND
                                                (
                                                    SELECT COUNT(*)
                                                    FROM  Expedients_Polls ep
                                                    WHERE ep.leavingDate IS NULL
                                                        AND ep.sent = 1
                                                        AND ep.expedient = e.expedientID
                                                        $where
                                                        $whereCC
                                                ) > 0
                                                $where
                                                $whereCC
                                                $wherePoll
                                    ORDER BY    p.id DESC
            ");
           
           $info['pollsHeaders'] = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);

           foreach($info['pollsHeaders'] as $index=>$item){

                $pollID = $item['id'];
                $result = $db->query("  SELECT      pit.question
                                        FROM        Polls_Items pit
                                        WHERE       pit.poll = $pollID AND 
                                                    pit.leavingDate IS NULL
                                                    $wherePollItem
                                        ORDER BY    pit.order_question ASC
                ");

                $info['pollsHeaders'][$index]['questions'] = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
            }
            
            // Get poll values 
            $result = $db->query("      SELECT      DISTINCT e.expedientID, e.number, CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceased,
                                                    IF(
                                                        pit.poll IS NULL,
                                                        0,
                                                        (
                                                            SELECT  COUNT(*) 
                                                            FROM    Polls_Items pit
                                                            WHERE   pit.poll = pit.poll AND
                                                                    pit.leavingDate IS NULL
                                                                    $wherePollItem
                                                        ) 
                                                    ) as total_questions
                                        FROM        Expedients e
                                        LEFT JOIN   Cost_Center cc ON e.deceasedMortuary = cc.mortuary
                                        LEFT JOIN   Clients c ON e.client = c.clientID
                                        LEFT JOIN   Expedients_Polls ep ON ep.expedient = e.expedientID 
                                        LEFT JOIN   Expedients_Polls_Results epr ON ep.id = epr.expedient_poll 
                                        LEFT JOIN   Polls_Items pit ON epr.poll_item = pit.id $wherePollItem
                                        WHERE       e.leavingDate IS NULL AND
                                                    ep.leavingDate IS NULL AND
                                                    ep.sent = 1 AND
                                                    epr.leavingDate IS NULL AND
                                                    (
                                                        SELECT COUNT(*)
                                                        FROM  Expedients_Polls ep
                                                        WHERE ep.leavingDate IS NULL
                                                            AND ep.sent = 1
                                                            AND ep.expedient = e.expedientID
                                                            $where
                                                            $whereCC
                                                    ) > 0
                                                    $where
                                                    $whereCC
                                        ORDER BY    e.expedientID ASC, pit.order_question ASC
            ");

            $info['pollsExpedients'] = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);

            foreach($info['pollsExpedients'] as $index=>$item){
                $expedientID = $item['expedientID'];

                // Get poll values 
                $result = $db->query("      SELECT      ep.id as result_id, pit.poll, epr.score, epr.notes
                                            FROM        Expedients_Polls ep, Expedients_Polls_Results epr, Polls_Items pit, Expedients e
                                            LEFT JOIN   Cost_Center cc ON e.deceasedMortuary = cc.mortuary
                                            LEFT JOIN   Clients c ON e.client = c.clientID
                                            WHERE       e.leavingDate IS NULL AND
                                                        ep.leavingDate IS NULL AND
                                                        ep.sent = 1 AND
                                                        ep.expedient = e.expedientID AND
                                                        ep.id = epr.expedient_poll AND
                                                        epr.poll_item = pit.id AND
                                                        epr.leavingDate IS NULL AND
                                                        e.expedientID = $expedientID AND
                                                        (
                                                            SELECT COUNT(*)
                                                            FROM  Expedients_Polls ep
                                                            WHERE ep.leavingDate IS NULL
                                                                AND ep.sent = 1
                                                                AND ep.expedient = e.expedientID
                                                                $where
                                                                $whereCC
                                                        ) > 0
                                                        $where
                                                        $whereCC
                                                        $wherePollItem
                                            ORDER BY    ep.id ASC, pit.order_question ASC
                ");
                $info['pollsExpedients'][$index]['answers'] = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
            }

           return $info; 
        }
    }
?>