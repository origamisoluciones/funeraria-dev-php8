<?php
    require_once($_SESSION['basePath'] . "defines.php");
    require_once($_SESSION['basePath'] . "core/db/dbHandler.php");
    require_once($_SESSION['basePath'] . "core/tools/utils.php");
    require_once($_SESSION['basePath'] . "model/visitsControl.php");
    require_once($_SESSION['basePath'] . "model/products.php");
    require_once($_SESSION['basePath'] . "model/templates.php");
    require_once($_SESSION['basePath'] . "model/events.php");
    require_once($_SESSION['basePath'] . "model/settings.php");
    require_once($_SESSION['basePath'] . "model/budgets.php");
    require_once($_SESSION['basePath'] . "model/invoices.php");
    require_once($_SESSION['basePath'] . "model/stock.php");
    require_once($_SESSION['basePath'] . "core/tools/security.php");
    require_once($_SESSION['basePath'] . "core/tools/validations.php");

    class Expedients{

        /**
         * Obtiene el número del expediente
         * 
         * @param int $id Id del expediente
         * @return string Número del expediente
         */
        public function getNumber($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            $result = $db->query("  SELECT  e.number
                                    FROM    Expedients e
                                    WHERE   e.expedientID = $id");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['number'];
        }

        /**
        * Crea un nuevo expediente
        *
        * @param array $data
        *
        * @return array
        */
        public function createExpedient($data){
            $db = new DbHandler;
          
            $data['deceasedBirthday'] = cleanStr($data['deceasedBirthday']);
            $data['deceasedDate'] = cleanStr($data['deceasedDate']);
            $data['deceasedTime'] = cleanStr($data['deceasedTime']);
            $data['funeralDate'] = cleanStr($data['funeralDate']);
            $data['funeralTime'] = cleanStr($data['funeralTime']);
            $data['funeralDateNew'] = cleanStr($data['funeralDateNew']);
            $data['funeralTimeNew'] = cleanStr($data['funeralTimeNew']);
            $data['funeralDateBurial'] = cleanStr($data['funeralDateBurial']);
            $data['funeralTimeBurial'] = cleanStr($data['funeralTimeBurial']);
            $data['ceremonyDate'] = cleanStr($data['ceremonyDate']);
            $data['ceremonyTime'] = cleanStr($data['ceremonyTime']);
            $data['funeralHomeEntryDate'] = cleanStr($data['funeralHomeEntryDate']);
            $data['funeralHomeEntryTime'] = cleanStr($data['funeralHomeEntryTime']);
            $data['entryDateBarrow'] = cleanStr($data['entryDateBarrow']);
            $data['entryTimeBarrow'] = cleanStr($data['entryTimeBarrow']);
            $data['moveLeavingDate'] = cleanStr($data['moveLeavingDate']);
            $data['moveLeavingTime'] = cleanStr($data['moveLeavingTime']);
            $data['requestTime'] = cleanStr($data['requestTime']);
            $data['requestDate'] = cleanStr($data['requestDate']);
            $data['expType'] = cleanStr($data['expType']);
            $data['clientType'] = cleanStr($data['clientType']);
            $data['policy'] = cleanStr($data['policy']);
            $data['capital'] = cleanStr($data['capital']);
            $data['status'] = cleanStr($data['status']);
            $data['room'] = cleanStr($data['room']);
            $data['cremation'] = cleanStr($data['cremation']);
            $data['move'] = cleanStr($data['move']);
            $data['lossNumber'] = cleanStr($data['lossNumber']);
            $data['internalRef'] = cleanStr($data['internalRef']);
            $data['literal'] = cleanStr($data['literal']);
            $data['applicantName'] = cleanStr($data['applicantName']);
            $data['applicantSurname'] = cleanStr($data['applicantSurname']);
            $data['applicantAddress'] = cleanStr($data['applicantAddress']);
            $data['applicantNIF'] = cleanStr($data['applicantNIF']);
            $data['applicantNifType'] = cleanStr($data['applicantNifType']);
            $data['applicantLocation'] = cleanStr($data['applicantLocation']);
            $data['applicantMail'] = cleanStr($data['applicantMail']);
            $data['applicantPhone'] = cleanStr($data['applicantPhone']);
            $data['applicantMobilePhone'] = cleanStr($data['applicantMobilePhone']);
            $data['familyContactName'] = cleanStr($data['familyContactName']);
            $data['familyContactSurname'] = cleanStr($data['familyContactSurname']);
            $data['familyContactRelationship'] = cleanStr($data['familyContactRelationship']);
            $data['familyContactAddress'] = cleanStr($data['familyContactAddress']);
            $data['familyContactNIF'] = cleanStr($data['familyContactNIF']);
            $data['familyContactNifType'] = cleanStr($data['familyContactNifType']);
            $data['familyContactLocation'] = cleanStr($data['familyContactLocation']);
            $data['familyContactMail'] = cleanStr($data['familyContactMail']);
            $data['familyContactPhone'] = cleanStr($data['familyContactPhone']);
            $data['familyContactMobilePhone'] = cleanStr($data['familyContactMobilePhone']);
            $data['otherContactName'] = cleanStr($data['otherContactName']);
            $data['otherContactPhone'] = cleanStr($data['otherContactPhone']);
            $data['otherContactRelationship'] = cleanStr($data['otherContactRelationship']);
            $data['client'] = cleanStr($data['client']);
            $data['deceasedName'] = cleanStr($data['deceasedName']);
            $data['deceasedSurname'] = cleanStr($data['deceasedSurname']);
            $data['deceasedNIF'] = cleanStr($data['deceasedNIF']);
            $data['deceasedNifType'] = cleanStr($data['deceasedNifType']);
            $data['deceasedGender'] = cleanStr($data['deceasedGender']);
            $data['deceasedMaritalStatus'] = cleanStr($data['deceasedMaritalStatus']);
            $data['deceasedMaritalStatusDescription'] = cleanStr($data['deceasedMaritalStatusDescription']);
            $data['deceasedChildOfFather'] = cleanStr($data['deceasedChildOfFather']);
            $data['deceasedChildOfMother'] = cleanStr($data['deceasedChildOfMother']);
            $data['deceasedFirstNuptials'] = cleanStr($data['deceasedFirstNuptials']);
            $data['deceasedSecondNuptials'] = cleanStr($data['deceasedSecondNuptials']);
            $data['deceasedNationality'] = cleanStr($data['deceasedNationality']);
            $data['deceasedNationalityName'] = cleanStr($data['deceasedNationalityName']);
            $data['deceasedNationalityProvince'] = cleanStr($data['deceasedNationalityProvince']);
            $data['deceasedBirthdayLocation'] = cleanStr($data['deceasedBirthdayLocation']);
            $data['deceasedLocality'] = cleanStr($data['deceasedLocality']);
            $data['deceasedUsualAddress'] = cleanStr($data['deceasedUsualAddress']);
            $data['deceasedProvince'] = cleanStr($data['deceasedProvince']);
            $data['deceasedLocation'] = cleanStr($data['deceasedLocation']);
            $data['otherDeceasedLocation'] = cleanStr($data['otherDeceasedLocation']);
            $data['deceasedDoctor'] = cleanStr($data['deceasedDoctor']);
            $data['deceasedDoctorCertificate'] = cleanStr($data['deceasedDoctorCertificate']);
            $data['deceasedCause'] = cleanStr($data['deceasedCause']);
            $data['deceasedTribunal'] = cleanStr($data['deceasedTribunal']);
            $data['deceasedTribunalNumber'] = cleanStr($data['deceasedTribunalNumber']);
            $data['deceasedMortuary'] = cleanStr($data['deceasedMortuary']);
            $data['deceasedMortuaryAddress'] = cleanStr($data['deceasedMortuaryAddress']);
            $data['deceasedRoom'] = cleanStr($data['deceasedRoom']);
            $data['tellmebyeRoom'] = cleanStr($data['tellmebyeRoom']);
            $data['tellmebyeRoomName'] = cleanStr($data['tellmebyeRoomName']);
            $data['deceasedPanel'] = cleanStr($data['deceasedPanel']);
            $data['startVelacionDate'] = cleanStr($data['startVelacionDate']);
            $data['startVelacionTime'] = cleanStr($data['startVelacionTime']);
            $data['endVelacionDate'] = cleanStr($data['endVelacionDate']);
            $data['endVelacionTime'] = cleanStr($data['endVelacionTime']);

            $data['startVelacionDate2'] = cleanStr($data['startVelacionDate2']);
            $data['startVelacionTime2'] = cleanStr($data['startVelacionTime2']);
            $data['endVelacionDate2'] = cleanStr($data['endVelacionDate2']);
            $data['endVelacionTime2'] = cleanStr($data['endVelacionTime2']);

            $data['church'] = cleanStr($data['church']);
            $data['cemetery'] = cleanStr($data['cemetery']);
            $data['niche'] = cleanStr($data['niche']);
            $data['funeralNicheNumber'] = cleanStr($data['funeralNicheNumber']);
            $data['funeralBusyNiche'] = cleanStr($data['funeralBusyNiche']);
            $data['regime'] = cleanStr($data['regime']);
            $data['propertyName'] = cleanStr($data['propertyName']);

            // Niche 1
            $data['deceasedNiche'] = cleanStr($data['deceasedNiche']);
            $data['funeralDateNiche'] = cleanStr($data['funeralDateNiche']);

            // Niche 2
            $data['deceasedNiche2'] = cleanStr($data['deceasedNiche2']);
            $data['funeralDateNiche2'] = cleanStr($data['funeralDateNiche2']);

            // Niche 3
            $data['deceasedNiche3'] = cleanStr($data['deceasedNiche3']);
            $data['funeralDateNiche3'] = cleanStr($data['funeralDateNiche3']);

            $data['exhumation'] = cleanStr($data['exhumation']);
            $data['nicheHeight'] = cleanStr($data['nicheHeight']);
            $data['mortuaryReg'] = cleanStr($data['mortuaryReg']);
            $data['funeralReg'] = cleanStr($data['funeralReg']);
            $data['personalReg'] = cleanStr($data['personalReg']);
            $data['crematoriumReg'] = cleanStr($data['crematoriumReg']);
            $data['tanatologicalPractice'] = cleanStr($data['tanatologicalPractice']);
            $data['funeralHome'] = cleanStr($data['funeralHome']);
            $data['coffin'] = cleanStr($data['coffin']);
            $data['responsibleUser'] = cleanStr($data['responsibleUser']);
            $data['responsibleName'] = cleanStr($data['responsibleName']);
            $data['responsibleNIF'] = cleanStr($data['responsibleNIF']);
            $data['crematorium'] = cleanStr($data['crematorium']);
            $data['crematoriumClient'] = cleanStr($data['crematoriumClient']);
            $data['crematoriumContactPersonPhone'] = cleanStr($data['crematoriumContactPersonPhone']);
            $data['crematoriumContactPerson'] = cleanStr($data['crematoriumContactPerson']);
            $data['crematoriumIntroduction'] = cleanStr($data['crematoriumIntroduction']);
            $data['crematoriumWaitOnRoom'] = cleanStr($data['crematoriumWaitOnRoom']);
            $data['crematoriumVaseBio'] = cleanStr($data['crematoriumVaseBio']);
            $data['moveFuneralHome'] = cleanStr($data['moveFuneralHome']);
            $data['moveClient'] = cleanStr($data['moveClient']);
            $data['moveCollection'] = cleanStr($data['moveCollection']);
            $data['moveDestination'] = cleanStr($data['moveDestination']);
            $data['moveVia'] = cleanStr($data['moveVia']);
            $data['moveNotes'] = cleanTextArea($data['moveNotes']);
            $data['moveJudicial'] = cleanStr($data['moveJudicial']);
            $data['moveTraslado'] = cleanStr($data['moveTraslado']);
            $data['moveDevolucion'] = cleanStr($data['moveDevolucion']);
            $data['ecologicCoffin'] = cleanStr($data['ecologicCoffin']);
            $data['authName'] = cleanStr($data['authName']);
            $data['authDni'] = cleanStr($data['authDni']);
            $data['authNifType'] = cleanStr($data['authNifType']);
            $data['otherCoffin'] = cleanStr($data['otherCoffin']);
            $data['churchLabel'] = cleanStr($data['churchLabel']);
            $data['cemeteryLabel'] = cleanStr($data['cemeteryLabel']);
            $data['authDate'] = cleanStr($data['authDate']);
            $data['authTime'] = cleanStr($data['authTime']);
            $data['authPlace'] = cleanStr($data['authPlace']);
            $data['smokeOpacityDateStart'] = cleanStr($data['smokeOpacityDateStart']);
            $data['smokeOpacityTimeStart'] = cleanStr($data['smokeOpacityTimeStart']);
            $data['smokeOpacityDateEnd'] = cleanStr($data['smokeOpacityDateEnd']);
            $data['smokeOpacityTimeEnd'] = cleanStr($data['smokeOpacityTimeEnd']);
            $data['smokeOpacityLoadWeight'] = cleanStr($data['smokeOpacityLoadWeight']);
            $data['smokeOpacityBacharachScale'] = cleanStr($data['smokeOpacityBacharachScale']);
            $data['smokeOpacityDateReading'] = cleanStr($data['smokeOpacityDateReading']);
            $data['smokeOpacityTimeReading'] = cleanStr($data['smokeOpacityTimeReading']);
            $data['smokeOpacityIncidents'] = cleanStr($data['smokeOpacityIncidents']);
            $data['smokeOpacityIncidentsNotes'] = cleanTextArea($data['smokeOpacityIncidentsNotes']);
            $data['crematoriumPacemaker'] = cleanStr($data['crematoriumPacemaker']);
            $data['crematoriumTechnical'] = cleanStr($data['crematoriumTechnical']);
            $data['moveContactPhone'] = cleanStr($data['moveContactPhone']);
            $data['moveContactPerson'] = cleanStr($data['moveContactPerson']);
            $data['moveDestinationAddress'] = cleanStr($data['moveDestinationAddress']);
            $data['moveCollectionAddress'] = cleanStr($data['moveCollectionAddress']);
            $data['moveFinalDestination'] = cleanStr($data['moveFinalDestination']);
            $data['crematoriumContactPhonePerson'] = cleanStr($data['crematoriumContactPhonePerson']);
            $data['authContactPhone'] = cleanStr($data['authContactPhone']);
            $data['flightNumber'] = cleanStr($data['flightNumber']);
            $data['airportOrigin'] = cleanStr($data['airportOrigin']);
            $data['departureDate'] = cleanStr($data['departureDate']);
            $data['departureTime'] = cleanStr($data['departureTime']);
            $data['arrivalAirport'] = cleanStr($data['arrivalAirport']);
            $data['arrivalDate'] = cleanStr($data['arrivalDate']);
            $data['arrivalTime'] = cleanStr($data['arrivalTime']);
            $data['agency'] = cleanStr($data['agency']);
            $data['agencyContact'] = cleanStr($data['agencyContact']);
            $data['agencyContactPhone'] = cleanStr($data['agencyContactPhone']);
            $data['otherCeremony'] = cleanStr($data['otherCeremony']);
            $data['otherInhumation'] = cleanStr($data['otherInhumation']);
            $data['deceasedNationalityLocation'] = cleanStr($data['deceasedNationalityLocation']);
            $data['familyContactNationality'] = cleanStr($data['familyContactNationality']);
            $data['familyContactOtherCountry'] = cleanStr($data['familyContactOtherCountry']);
            $data['familyContactOtherProvince'] = cleanStr($data['familyContactOtherProvince']);
            $data['familyContactOtherLocation'] = cleanStr($data['familyContactOtherLocation']);
            $data['arriveTime'] = cleanStr($data['arriveTime']);
            $data['arriveDate'] = cleanStr($data['arriveDate']);
            $data['cremation'] = cleanStr($data['cremation']);
            $data['crematoriumStatus'] = cleanStr($data['crematoriumStatus']);
            $data['crematoriumEntryDate'] = cleanStr($data['crematoriumEntryDate']);
            $data['crematoriumEntryTime'] = cleanStr($data['crematoriumEntryTime']);
            $data['crematoriumLeavingDate'] = cleanStr($data['crematoriumLeavingDate']);
            $data['crematoriumLeavingTime'] = cleanStr($data['crematoriumLeavingTime']);
            $data['deceasedMortuary'] = cleanStr($data['deceasedMortuary']);
            $data['covid'] = cleanStr($data['covid']);
            $data['trazabilityId'] = cleanStr($data['trazabilityId']);
            $data['funeralHomeService'] = cleanStr($data['funeralHomeService']);
            $data['familyAssistance'] = cleanStr($data['familyAssistance']);
            $data['carCollection1'] = cleanStr($data['carCollection1']);
            $data['carCollection1LicensePlate'] = cleanStr($data['carCollection1LicensePlate']);
            $data['carCollection1Brand'] = cleanStr($data['carCollection1Brand']);
            $data['carCollection1Model'] = cleanStr($data['carCollection1Model']);
            $data['corpseCollection1'] = cleanStr($data['corpseCollection1']);
            $data['corpseCollection2'] = cleanStr($data['corpseCollection2']);
            $data['carCollection2'] = cleanStr($data['carCollection2']);
            $data['staffTransfer1'] = cleanStr($data['staffTransfer1']);
            $data['staffTransfer2'] = cleanStr($data['staffTransfer2']);
            $data['hearse'] = cleanStr($data['hearse']);
            $data['hearseLicensePlate'] = cleanStr($data['hearseLicensePlate']);
            $data['hearseBrand'] = cleanStr($data['hearseBrand']);
            $data['hearseModel'] = cleanStr($data['hearseModel']);
            $data['placeDestinationMiddle'] = cleanStr($data['placeDestinationMiddle']);
            $data['placeDestinationFinal'] = cleanStr($data['placeDestinationFinal']);
            $data['placeDestinationFinalCemetery'] = cleanStr($data['placeDestinationFinalCemetery']);
            $data['notesExpedient'] = cleanTextArea($data['notesExpedient']);
            $data['mortuaryRegNotes'] = cleanTextArea($data['mortuaryRegNotes']);

            $data['refrigeratedChamberName'] = cleanStr($data['refrigeratedChamberName']);
            $data['refrigeratedChamberDateStart'] = cleanStr($data['refrigeratedChamberDateStart']);
            $data['refrigeratedChamberTimeStart'] = cleanStr($data['refrigeratedChamberTimeStart']);
            $data['refrigeratedChamberDateEnd'] = cleanStr($data['refrigeratedChamberDateEnd']);
            $data['refrigeratedChamberTimeEnd'] = cleanStr($data['refrigeratedChamberTimeEnd']);

            // Validación de campos
            if($data['expType'] == ''){
                return false;
            }
            if($data['applicantName'] == ''){
                return false;
			}
			if($data['applicantNIF'] != ''){
                if($data['applicantNifType'] != '3' && $data['applicantNifType'] != '4'){
                    if(!isValidIdNumber($data['applicantNIF'])){
                        return false;
                    }
                }
            }
            if($data['applicantMail'] != ''){
                if(!checkEmail($data['applicantMail'])){
                    return false;
                }
            }
            if($data['applicantPhone'] != ''){
                if(!checkPhone($data['applicantPhone'])){
                    return false;
                }
            }
            if($data['applicantMobilePhone'] != ''){
                if(!checkPhone($data['applicantMobilePhone'])){
                    return false;
                }
            }
            if($data['familyContactNIF'] != ''){
                if($data['familyContactNifType'] != '3' && $data["familyContactNifType"] != '4'){
                    if(!isValidIdNumber($data['familyContactNIF'])){
                        return false;
                    }
                }
            }
            if($data['familyContactMail'] != ''){
                if(!checkEmail($data['familyContactMail'])){
                    return false;
                }
            }
            if($data['familyContactPhone'] != ''){
                if(!checkPhone($data['familyContactPhone'])){
                    return false;
                }
            }
            if($data['familyContactMobilePhone'] != ''){
                if(!checkPhone($data['familyContactMobilePhone'])){
                    return false;
                }
            }
            if($data['deceasedNIF'] != ''){
                if($data['deceasedNifType'] != 3 &&  $data["deceasedNifType"] != 4){
                    if(!isValidIdNumber($data['deceasedNIF'])){
                        return false;
                    }
                }
            }
            if($data['responsibleNIF'] != ''){
                if($data['responsibleNIF'] != 3 &&  $data["responsibleNIF"] != 4){
                    if(!isValidIdNumber($data['responsibleNIF'])){
                        return false;
                    }
                }
            }
            if($data['authDni'] != ''){
                if($data["authNifType"] != 3 && $data["authNifType"] != 4){
                    if(!isValidIdNumber($data['authDni'])){
                        return false;
                    }
                }
            }
            if($data['moveContactPhone'] != ''){
                if(!checkPhone($data['moveContactPhone'])){
                    return false;
                }
            }
            if($data['authContactPhone'] != ''){
                if(!checkPhone($data['authContactPhone'])){
                    return false;
                }
            }

            $createYear = explode('-', $data['requestDate'])[0];

            // Calculate extraID
            $result = $db->query("  SELECT  MAX(expedientID) as id
                                    FROM    Expedients");
            $maxID = mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0]['id'] : '1';
            $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);
            $extraID .= ($maxID+1);
            
            // Gets client price
            if($data['client'] != null && $data['client'] != ''){

                $result = $db->query("   SELECT   p.name
                                        FROM     Clients c, Prices p
                                        WHERE    c.clientID = {$data['client']} 
                                            AND  p.leavingDate IS NULL
                                            AND  p.priceID = c.price");
                                        
                if(mysqli_num_rows($result) > 0){
                    $priceName = $db->resultToArray($result)[0]['name'];

                    $result = $db->query("  SELECT   p.priceID
                                            FROM     Prices p
                                            WHERE    p.name = '$priceName' 
                                                AND  p.leavingDate IS NULL
                                                AND  p.year = $createYear");

                    if(mysqli_num_rows($result) > 0){
                        $priceClient = $db->resultToArray($result)[0]['priceID'];
                    }else{
                        $result = $db->query("  SELECT   c.price
                                                FROM     Clients c
                                                WHERE    c.clientID = {$data['client']}");
                                            
                        if(mysqli_num_rows($result) > 0){
                            $priceClient = $db->resultToArray($result)[0]['price'];
                        }else{
                            $priceClient = 'null';
                        }
                    }
                }else{
                    $priceClient = 'null';
                }

            }else{
                $priceClient = 'null'; 
            }
           
            // Cálculo del número de secuencia expediente
            $result = $db->query("  SELECT  COUNT(expedientID) as total 
                                    FROM    Expedients 
                                    WHERE   leavingDate IS NULL AND
                                            expNumYear = '" . $createYear . "'
            ");
            if(mysqli_num_rows($result) > 0){
                $numExp = $db->resultToArray($result)[0]['total'] + 1;
            }else{
                $numExp = 1;
            }
            
            //Tipo de expediente
            switch($data['expType']){
                case '1': //DEFUNCION
                    switch($data['clientType']){
                        case '1': //PARTICULARES

                            $expNumLetter = 'P';

                            $expNumYear = $createYear;
                            //Calcular el numero de secuencia del expediente par tipo DEFUNCION
                            $result = $db->query("  SELECT  COALESCE(MAX(expNumSecuence), 0) as total 
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND type = 1 AND                                                           
                                                            expNumYear = '" . $expNumYear . "'"
                            );

                            if(mysqli_num_rows($result) > 0){
                                $expNumSec = $db->resultToArray($result)[0]['total'] + 1;
                            }else{
                                $expNumSec = 1;
                            }

                            //Calcular el numero de secuencia del expediente para Particulares
                            $result = $db->query("  SELECT  COALESCE(MAX(expNumType), 0) as total 
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = 1 AND type = 1 AND
                                                            expNumYear = '" . $expNumYear . "'"
                            );
                            
                            if(mysqli_num_rows($result) > 0){
                                $expNumType = $db->resultToArray($result)[0]['total'] + 1;
                            }else{
                                $expNumType = 1;
                            }

                            $expNumYear = substr($expNumYear, -2);
                            $numberExp = $expNumSec . ' ' . $expNumLetter . $expNumType . '/' . $expNumYear;

                        break;

                        case '2': //SEGUROS
                            $expNumLetter = 'S';

                            $expNumYear = $createYear;

                            //Calcular el numero de secuencia del expediente para tipo DEFUNCION
                            $result = $db->query("  SELECT  COALESCE(MAX(expNumSecuence), 0) as total 
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND type = 1 AND                                                           
                                                            expNumYear = '" . $expNumYear . "'"
                            );
                          
                            if(mysqli_num_rows($result) > 0){
                                $expNumSec = $db->resultToArray($result)[0]['total'] + 1;
                            }else{
                                $expNumSec = 1;
                            }


                            //Calcular el numero de secuencia del expediente para seguros
                            $result = $db->query("  SELECT  COALESCE(MAX(expNumType), 0) as total 
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = 2 AND type = 1 AND
                                                            expNumYear = '" . $expNumYear . "'"
                            );
                            
                            if(mysqli_num_rows($result) > 0){
                                $expNumType = $db->resultToArray($result)[0]['total'] + 1;
                            }else{
                                $expNumType = 1;
                            }
                            $expNumYear = substr($expNumYear, -2);

                            //  $numberExp = $expNumLetter . '-' . $expNumSec . '/' . $expNumYear . ' ' . $expNumType;
                            $numberExp = $expNumSec . ' ' . $expNumLetter . $expNumType . '/' . $expNumYear;
                            break;

                        case '3': //EMPRESAS
                            $expNumLetter = 'E';

                            $expNumYear = $createYear;
                            //Calcular el numero de secuencia del expediente par tipo DEFUNCION
                            $result = $db->query("  SELECT  COALESCE(MAX(expNumSecuence), 0) as total 
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND type = 1 AND                                                           
                                                            expNumYear = '" . $expNumYear . "'"
                            );

                            if(mysqli_num_rows($result) > 0){
                                $expNumSec = $db->resultToArray($result)[0]['total'] + 1;
                            }else{
                                $expNumSec = 1;
                            }

                            //Calcular el numero de secuencia del expediente para empresas
                            $result = $db->query("  SELECT  COALESCE(MAX(expNumType), 0) as total 
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = 3 AND type = 1 AND
                                                            expNumYear = '" . $expNumYear . "'"
                            );
                            
                            if(mysqli_num_rows($result) > 0){
                                $expNumType = $db->resultToArray($result)[0]['total'] + 1;
                            }else{
                                $expNumType = 1;
                            }

                            $expNumYear = substr($expNumYear, -2);
                            // $numberExp = $expNumLetter . '-' . $expNumSec . '/' . $expNumYear . ' ' . $expNumType;
                            $numberExp = $expNumSec . ' ' . $expNumLetter . $expNumType . '/' . $expNumYear;
                            break;
                    }
                break;

                case '2': //PRESUPUESTO

                    $expNumYear = $createYear;

                    $expNumLetter = 'PR';
                    //Calcular el numero de secuencia del expediente par tipo PRESUPUESTO
                    $result = $db->query("  SELECT  COALESCE(MAX(expNumSecuence), 0) as total 
                                            FROM    Expedients 
                                            WHERE   leavingDate IS NULL AND type = 2 AND                                                           
                                                    expNumYear = '" . $expNumYear . "'"
                    );

                    if(mysqli_num_rows($result) > 0){
                        $expNumSec = $db->resultToArray($result)[0]['total'] + 1;
                    }else{
                        $expNumSec = 1;
                    }
                    $expNumYear = $createYear;
                    $expNumYear = substr($expNumYear, -2);
                    //$expNumYear = 2012;
                    $expNumType = 0;
                    $numberExp = $expNumLetter . '-' . $expNumSec . '/' . $expNumYear;
                break;

                case '3': //VARIOS
                    $expNumYear = $createYear;
                    
                    $expNumLetter = 'V';
                    //Calcular el numero de secuencia del expediente par tipo VARIOS
                    $result = $db->query("  SELECT  COALESCE(MAX(expNumSecuence), 0) as total 
                                            FROM    Expedients 
                                            WHERE   leavingDate IS NULL AND type = 3 AND                                                           
                                                    expNumYear = '" . $expNumYear . "'"
                    );
                   
                    if(mysqli_num_rows($result) > 0){
                        $expNumSec = $db->resultToArray($result)[0]['total'] + 1;
                    }else{
                        $expNumSec = 1;
                    }
                    $expNumYear = $createYear;
                    //$expNumYear = 2012;
                    $expNumYear = substr($expNumYear, -2);
                    $expNumType = 0;
                    $numberExp = $expNumLetter . '-' . $expNumSec . '/' . $expNumYear;
                break;
            }
           
            // Get next trazability ID
            if($data['cremation'] === 'true'){

                $result = $db->query("  SELECT  COALESCE(MAX(e.trazabilityId), 0) as max_id_trazability 
                                        FROM    Expedients e
                                        WHERE   e.leavingDate IS NULL AND
                                                e.cremation = 1  AND 
                                                e.trazabilityId != 'false' AND e.trazabilityId != ''
                ");
                if(mysqli_num_rows($result) > 0){
                    $data['trazabilityId'] = intval($db->resultToArray($result)[0]['max_id_trazability']) + 1;
                }else{
                    $data['trazabilityId'] = 1;
                }
            }

            if(empty($data['applicantLocation'])){
                $data['applicantLocation'] = 'null';
            }
            if(empty($data['familyContactLocation'])){
                $data['familyContactLocation'] = 'null';
            }
            if(empty($data['lossNumber'])){
                $data['lossNumber'] = null;
            }
            if(empty($data['internalRef'])){
                $data['internalRef'] = null;
            }
            if(empty($data['deceasedBirthdayLocation'])){
                $data['deceasedBirthdayLocation'] = 'null';
            }
            if(empty($data['deceasedProvince']) && $data['deceasedProvince'] != "0"){
                $data['deceasedProvince'] = 'null';
            }
            if(empty($data['deceasedLocation']) && $data['deceasedLocation'] != "0"){
                $data['deceasedLocation'] = 'null';
            }
            if(empty($data['deceasedMortuary'])){
                $data['deceasedMortuary'] = 'null';
            }
            if(empty($data['deceasedDoctor'])){
                $data['deceasedDoctor'] = 'null';
            }
            if(empty($data['client'])){
                $data['client'] = 'null';
            }
            if(empty($data['church'])){
                $data['church'] = 'null';
            }
            if(empty($data['cemetery'])){
                $data['cemetery'] = 'null';
            }
            if(empty($data['niche'])){
                $data['niche'] = 'null';
            }
            if(empty($data['funeralHome'])){
                $data['funeralHome'] = 'null';
            }
            if(empty($data['crematorium'])){
                $data['crematorium'] = 'null';
            }
            if(empty($data['crematoriumClient'])){
                $data['crematoriumClient'] = 'null';
            }
            if(empty($data['moveFuneralHome'])){
                $data['moveFuneralHome'] = 'null';
            }
            if(empty($data['moveClient'])){
                $data['moveClient'] = 'null';
            }
            if(empty($data['moveCollection'])){
                $data['moveCollection'] = 'null';
            }
            if(empty($data['moveDestination'])){
                $data['moveDestination'] = 'null';
            }
            if(empty($data['moveContactPhone'])){
                $data['moveContactPhone'] = 'null';
            }
            if(empty($data['moveContactPerson'])){
                $data['moveContactPerson'] = null;
            }
            if(empty($data['moveDestinationAddress'])){
                $data['moveDestinationAddress'] = null;
            }
            if(empty($data['moveCollectionAddress'])){
                $data['moveCollectionAddress'] = null;
            }
            if($data['moveFinalDestination'] == ''){
                $data['moveFinalDestination'] = null;
            }
            if(empty($data['responsibleUser'])){
                $data['responsibleUser'] = 'null';
            }
            if(empty($data['placeDestinationMiddle'])){
                $data['placeDestinationMiddle'] = 'null';
            }
            if(empty($data['placeDestinationFinal'])){
                $data['placeDestinationFinal'] = 'null';
            }
            if(empty($data['placeDestinationFinalCemetery'])){
                $data['placeDestinationFinalCemetery'] = 'null';
            }

            if($data['deceasedBirthday'] == ""){
                $deceasedBirthdayUp = '';
                $deceasedBirthdayDown = '';
            }else{
                $deceasedBirthdayUp = 'deceasedBirthday, ';
                $deceasedBirthdayDown = '"' . $data['deceasedBirthday'] . '", ';
            }
            if($data['deceasedLocality'] == ''){
                $deceasedLocality = 'null';
            }else{
                $deceasedLocality = "'". $data['deceasedLocality'] ."' ";
            }
            if($data['deceasedDate'] == ""){
                $deceasedDateUp = '';
                $deceasedDateDown = '';
            }else{
                $deceasedDateUp = 'deceasedDate, ';
                $deceasedDateDown = '"' . $data['deceasedDate'] . '", ';
            }

            if($data['deceasedTime'] == ""){
                $deceasedTimeUp = '';
                $deceasedTimeDown = '';
            }else{
                $deceasedTimeUp = 'deceasedTime, ';
                $deceasedTimeDown = '"' . $data['deceasedTime'] . '", ';
            }

            if($data['funeralDateNiche'] == ""){
                $funeralDateNicheUp = '';
                $funeralDateNicheDown = '';
            }else{
                $funeralDateNicheUp = 'funeralDateNiche, ';
                $funeralDateNicheDown = '"' . $data['funeralDateNiche'] . '", ';
            }

            if($data['funeralDateNiche2'] == ""){
                $funeralDateNicheUp2 = '';
                $funeralDateNicheDown2 = '';
            }else{
                $funeralDateNicheUp2 = 'funeralDateNiche2, ';
                $funeralDateNicheDown2 = '"' . $data['funeralDateNiche2'] . '", ';
            }

            if($data['funeralDateNiche3'] == ""){
                $funeralDateNicheUp3 = '';
                $funeralDateNicheDown3 = '';
            }else{
                $funeralDateNicheUp3 = 'funeralDateNiche3, ';
                $funeralDateNicheDown3 = '"' . $data['funeralDateNiche3'] . '", ';
            }

            if($data['funeralDate'] == ""){
                $funeralDateUp = '';
                $funeralDateDown = '';
            }else{
                $funeralDateUp = 'funeralDate, ';
                $funeralDateDown = '"' . $data['funeralDate'] . '", ';
            }

            if($data['funeralTime'] == ""){
                $funeralTimeUp = '';
                $funeralTimeDown = '';
            }else{
                $funeralTimeUp = 'funeralTime, ';
                $funeralTimeDown = '"' . $data['funeralTime'] . '", ';
            }

            if($data['funeralDateNew'] == ""){
                $funeralDateNewUp = '';
                $funeralDateNewDown = '';
            }else{
                $funeralDateNewUp = 'funeralDateNew, ';
                $funeralDateNewDown = '"' . $data['funeralDateNew'] . '", ';
            }

            if($data['funeralTimeNew'] == ""){
                $funeralTimeNewUp = '';
                $funeralTimeNewDown = '';
            }else{
                $funeralTimeNewUp = 'funeralTimeNew, ';
                $funeralTimeNewDown = '"' . $data['funeralTimeNew'] . '", ';
            }

            if($data['funeralDateBurial'] == ""){
                $funeralDateBurialUp = '';
                $funeralDateBurialDown = '';
            }else{
                $funeralDateBurialUp = 'funeralDateBurial, ';
                $funeralDateBurialDown = '"' . $data['funeralDateBurial'] . '", ';
            }

            if($data['funeralTimeBurial'] == ""){
                $funeralTimeBurialUp = '';
                $funeralTimeBurialDown = '';
            }else{
                $funeralTimeBurialUp = 'funeralTimeBurial, ';
                $funeralTimeBurialDown = '"' . $data['funeralTimeBurial'] . '", ';
            }

            if($data['ceremonyDate'] == ""){
                $ceremonyDateUp = '';
                $ceremonyDateDown = '';
            }else{
                $ceremonyDateUp = 'ceremonyDate, ';
                $ceremonyDateDown = '"' . $data['ceremonyDate'] . '", ';
            }

            if($data['ceremonyTime'] == ""){
                $ceremonyTimeUp = '';
                $ceremonyTimeDown = '';
            }else{
                $ceremonyTimeUp = 'ceremonyTime, ';
                $ceremonyTimeDown = '"' . $data['ceremonyTime'] . '", ';
            }

            if($data['funeralHomeEntryDate'] == ""){
                $funeralHomeEntryDateUp = '';
                $funeralHomeEntryDateDown = '';
            }else{
                $funeralHomeEntryDateUp = 'funeralHomeEntryDate, ';
                $funeralHomeEntryDateDown = '"' . $data['funeralHomeEntryDate'] . '", ';
            }

            if($data['funeralHomeEntryTime'] == ""){
                $funeralHomeEntryTimeUp = '';
                $funeralHomeEntryTimeDown = '';
            }else{
                $funeralHomeEntryTimeUp = 'funeralHomeEntryTime, ';
                $funeralHomeEntryTimeDown = '"' . $data['funeralHomeEntryTime'] . '", ';
            }

            if($data['entryDateBarrow'] == ""){
                $entryDateBarrowUp = '';
                $entryDateBarrowDown = '';
            }else{
                $entryDateBarrowUp = 'entryDateBarrow, ';
                $entryDateBarrowDown = '"' . $data['entryDateBarrow'] . '", ';
            }

            if($data['entryTimeBarrow'] == ""){
                $entryTimeBarrowUp = '';
                $entryTimeBarrowDown = '';
            }else{
                $entryTimeBarrowUp = 'entryTimeBarrow, ';
                $entryTimeBarrowDown = '"' . $data['entryTimeBarrow'] . '", ';
            }

            if($data['crematoriumTechnical'] == ""){
                $data['crematoriumTechnical'] = 'null';
            }

            if($data['deceasedProvince'] == ""){
                $deceasedProvince = 'null';
            }else{
                $deceasedProvince = '"' . $data['deceasedProvince'] . '"';
            }

            if($data['otherDeceasedLocation'] == ""){
                $otherDeceasedLocation = 'null,';
            }else{
                $otherDeceasedLocation = '"' . $data['otherDeceasedLocation'] . '", ';
            }

            if($data['crematoriumContactPhonePerson'] == ""){
                $data['crematoriumContactPhonePerson'] = 'null';
            }
            if($data['authContactPhone'] == ""){
                $data['authContactPhone'] = 'null';
            }

            if($data['moveLeavingDate'] == ""){
                $moveLeavingDateUp = '';
                $moveLeavingDateDown = '';
            }else{
                $moveLeavingDateUp = 'moveLeavingDate, ';
                $moveLeavingDateDown = '"' . $data['moveLeavingDate'] . '", ';
            }

            if($data['moveLeavingTime'] == ""){
                $moveLeavingTimeUp = '';
                $moveLeavingTimeDown = '';
            }else{
                $moveLeavingTimeUp = 'moveLeavingTime, ';
                $moveLeavingTimeDown = '"' . $data['moveLeavingTime'] . '", ';
            }

            if($data['authDate'] == ''){
                $data['authDate'] = 'null';
            }
            if($data['authTime'] == ''){
                $data['authTime'] = 'null';
            }
            if($data['smokeOpacityDateStart'] == ''){
                $data['smokeOpacityDateStart'] = 'null';
            }
            if($data['smokeOpacityTimeStart'] == ''){
                $data['smokeOpacityTimeStart'] = 'null';
            }
            if($data['smokeOpacityDateEnd'] == ''){
                $data['smokeOpacityDateEnd'] = 'null';
            }
            if($data['smokeOpacityTimeEnd'] == ''){
                $data['smokeOpacityTimeEnd'] = 'null';
            }
            if($data['smokeOpacityDateReading'] == ''){
                $data['smokeOpacityDateReading'] = 'null';
            }
            if($data['smokeOpacityTimeReading'] == ''){
                $data['smokeOpacityTimeReading'] = 'null';
            }
            if($data['smokeOpacityLoadWeight'] == ''){
                $data['smokeOpacityLoadWeight'] = 'null';
            }
            if(empty($data['smokeOpacityBacharachScale'])){
                $data['smokeOpacityBacharachScale'] = 'null';
            }
            if($data['flightNumber'] == ''){
                $data['flightNumber'] = 'null';
            }
            if($data['airportOrigin'] == ''){
                $data['airportOrigin'] = 'null';
            }
            if($data['departureDate'] == ""){
                $departureDateUp = '';
                $departureDateDown = '';
            }else{
                $departureDateUp = 'departureDate, ';
                $departureDateDown = '"' . $data['departureDate'] . '", ';
            }
            if($data['departureTime'] == ''){
                $data['departureTime'] = 'null';
            }
            if($data['arrivalAirport'] == ''){
                $data['arrivalAirport'] = 'null';
            }
            if($data['arrivalDate'] == ""){
                $arrivalDateUp = '';
                $arrivalDateDown = '';
            }else{
                $arrivalDateUp = 'arrivalDate, ';
                $arrivalDateDown = '"' . $data['arrivalDate'] . '", ';
            }
            if($data['arrivalTime'] == ''){
                $data['arrivalTime'] = 'null';
            }
            if($data['agency'] == ''){
                $data['agency'] = 'null';
            }
            if($data['agencyContact'] == ''){
                $data['agencyContact'] = 'null';
            }
            if($data['agencyContactPhone'] == ''){
                $data['agencyContactPhone'] = 'null';
            }
            if($data['otherCeremony'] == ''){
                $data['otherCeremony'] = null;
            }
            if($data['otherInhumation'] == ''){
                $data['otherInhumation'] = null;
            }

            // Velacion data - 1
            if($data['startVelacionDate'] == "" || $data['startVelacionDate'] == null){
                $startVelacionDateUp = '';
                $startVelacionDateDown = '';
            }else{
                $startVelacionDateUp = 'startVelacionDate, ';
                $startVelacionDateDown = '"' . $data['startVelacionDate'] . '", ';
            }

            if($data['startVelacionTime'] == "" || $data['startVelacionTime'] == null){
                $startVelacionTimeUp = '';
                $startVelacionTimeDown = '';
            }else{
                $startVelacionTimeUp = 'startVelacionTime, ';
                $startVelacionTimeDown = '"' . $data['startVelacionTime'] . '", ';
            }

            if($data['endVelacionDate'] == "" || $data['endVelacionDate'] == null){
                $endVelacionDateUp = '';
                $endVelacionDateDown = '';
            }else{
                $endVelacionDateUp = 'endVelacionDate, ';
                $endVelacionDateDown = '"' . $data['endVelacionDate'] . '", ';
            }

            if($data['endVelacionTime'] == "" || $data['endVelacionTime'] == null){
                $endVelacionTimeUp = '';
                $endVelacionTimeDown = '';
            }else{
                $endVelacionTimeUp = 'endVelacionTime, ';
                $endVelacionTimeDown = '"' . $data['endVelacionTime'] . '", ';
            }


            // Velacion data - 2
            if($data['startVelacionDate2'] == "" || $data['startVelacionDate2'] == null){
                $startVelacionDateUp2 = '';
                $startVelacionDateDown2 = '';
            }else{
                $startVelacionDateUp2 = 'startVelacionDate2, ';
                $startVelacionDateDown2 = '"' . $data['startVelacionDate2'] . '", ';
            }

            if($data['startVelacionTime2'] == "" || $data['startVelacionTime2'] == null){
                $startVelacionTimeUp2 = '';
                $startVelacionTimeDown2 = '';
            }else{
                $startVelacionTimeUp2 = 'startVelacionTime2, ';
                $startVelacionTimeDown2 = '"' . $data['startVelacionTime2'] . '", ';
            }

            if($data['endVelacionDate2'] == "" || $data['endVelacionDate2'] == null){
                $endVelacionDateUp2 = '';
                $endVelacionDateDown2 = '';
            }else{
                $endVelacionDateUp2 = 'endVelacionDate2, ';
                $endVelacionDateDown2 = '"' . $data['endVelacionDate2'] . '", ';
            }

            if($data['endVelacionTime2'] == "" || $data['endVelacionTime2'] == null){
                $endVelacionTimeUp2 = '';
                $endVelacionTimeDown2 = '';
            }else{
                $endVelacionTimeUp2 = 'endVelacionTime2, ';
                $endVelacionTimeDown2 = '"' . $data['endVelacionTime2'] . '", ';
            }

            if($data['carCollection1LicensePlate'] == ''){
                $data['carCollection1LicensePlate'] = 'null';
            }
            if($data['carCollection1Brand'] == ''){
                $data['carCollection1Brand'] = 'null';
            }
            if($data['carCollection1Model'] == ''){
                $data['carCollection1Model'] = 'null';
            }
            if($data['hearse'] == ''){
                $data['hearse'] = 'null';
            }
            if($data['hearseLicensePlate'] == ''){
                $data['hearseLicensePlate'] = 'null';
            }
            if($data['hearseBrand'] == ''){
                $data['hearseBrand'] = 'null';
            }
            if($data['hearseModel'] == ''){
                $data['hearseModel'] = 'null';
            }
            if($data['mortuaryRegNotes'] == ''){
                $data['mortuaryRegNotes'] = 'null';
            }

            if($data['refrigeratedChamberName'] == ""){
                $refrigeratedChamberNameUp = '';
                $refrigeratedChamberNameDown = '';
            }else{
                $refrigeratedChamberNameUp = 'refrigeratedChamberName, ';
                $refrigeratedChamberNameDown = '"' . $data['refrigeratedChamberName'] . '", ';
            }
            if($data['refrigeratedChamberDateStart'] == ""){
                $refrigeratedChamberDateStartUp = '';
                $refrigeratedChamberDateStartDown = '';
            }else{
                $refrigeratedChamberDateStartUp = 'refrigeratedChamberDateStart, ';
                $refrigeratedChamberDateStartDown = '"' . $data['refrigeratedChamberDateStart'] . '", ';
            }
            if($data['refrigeratedChamberTimeStart'] == ""){
                $refrigeratedChamberTimeStartUp = '';
                $refrigeratedChamberTimeStartDown = '';
            }else{
                $refrigeratedChamberTimeStartUp = 'refrigeratedChamberTimeStart, ';
                $refrigeratedChamberTimeStartDown = '"' . $data['refrigeratedChamberTimeStart'] . '", ';
            }
            if($data['refrigeratedChamberDateEnd'] == ""){
                $refrigeratedChamberDateEndUp = '';
                $refrigeratedChamberDateEndDown = '';
            }else{
                $refrigeratedChamberDateEndUp = 'refrigeratedChamberDateEnd, ';
                $refrigeratedChamberDateEndDown = '"' . $data['refrigeratedChamberDateEnd'] . '", ';
            }
            if($data['refrigeratedChamberTimeEnd'] == ""){
                $refrigeratedChamberTimeEndUp = '';
                $refrigeratedChamberTimeEndDown = '';
            }else{
                $refrigeratedChamberTimeEndUp = 'refrigeratedChamberTimeEnd, ';
                $refrigeratedChamberTimeEndDown = '"' . $data['refrigeratedChamberTimeEnd'] . '", ';
            }

            $currentDate = $data['requestDate'];

            $expNumYear = $createYear;

            $expedient = $db->query("INSERT INTO Expedients (entryDate, number, user,  requestTime, requestDate, type, clientType, policy, capital, status, room, cremation, move, lossNumber, internalRef,
                                        literal, applicantName, applicantSurname, applicantAddress, applicantNIF, applicantLocation, applicantMail, 
                                        applicantPhone, applicantMobilePhone, familyContactName, familyContactSurname, familyContactRelationship, familyContactAddress, familyContactNIF, 
                                        familyContactLocation, familyContactMail, familyContactPhone, familyContactMobilePhone, otherContactName,
                                        otherContactPhone, otherContactRelationship, client, deceasedName, deceasedSurname, deceasedNIF, deceasedGender, 
                                        deceasedMaritalStatus, deceasedMaritalStatusDescription, deceasedChildOfFather, deceasedChildOfMother, deceasedFirstNuptials, deceasedSecondNuptials, 
                                        deceasedNationality, deceasedNationalityName, deceasedNationalityProvince, $deceasedBirthdayUp deceasedBirthdayLocation, deceasedUsualAddress, 
                                        deceasedLocation, otherDeceasedLocation, $deceasedDateUp $deceasedTimeUp deceasedDoctor, deceasedDoctorCertificate, deceasedCause, deceasedTribunal, deceasedTribunalNumber,
                                        deceasedMortuary, deceasedMortuaryAddress, deceasedRoom, deceasedPanel, church, cemetery, $funeralDateUp $funeralTimeUp $funeralDateNewUp $funeralTimeNewUp $funeralDateBurialUp $funeralTimeBurialUp $ceremonyDateUp $ceremonyTimeUp niche, funeralNicheNumber, 
                                        funeralBusyNiche, regime, propertyName, deceasedNiche, $funeralDateNicheUp deceasedNiche2, $funeralDateNicheUp2 deceasedNiche3, $funeralDateNicheUp3 exhumation, nicheHeight, mortuaryReg, funeralReg, personalReg, 
                                        crematoriumReg, tanatologicalPractice, funeralHome, $funeralHomeEntryDateUp $funeralHomeEntryTimeUp $entryDateBarrowUp $entryTimeBarrowUp
                                        $refrigeratedChamberNameUp $refrigeratedChamberDateStartUp $refrigeratedChamberTimeStartUp $refrigeratedChamberDateEndUp $refrigeratedChamberTimeEndUp
                                        coffin, responsibleUser, responsibleName, responsibleNIF, crematorium, crematoriumClient, crematoriumContactPersonPhone, crematoriumContactPerson, 
                                        crematoriumIntroduction, crematoriumWaitOnRoom, crematoriumVaseBio, moveFuneralHome, moveClient, $moveLeavingDateUp
                                        $moveLeavingTimeUp moveCollection, moveDestination, moveVia, moveNotes, moveJudicial, ecologicCoffin, authName, authDni, otherCoffin, churchLabel, cemeteryLabel, authDate,
                                        authTime, authPlace, crematoriumPacemaker, crematoriumTechnical, extraID, moveContactPhone, moveContactPerson, moveDestinationAddress, moveCollectionAddress, moveFinalDestination,
                                        crematoriumContactPhonePerson, authContactPhone, flightNumber, airportOrigin, $departureDateUp departureTime, arrivalAirport, $arrivalDateUp arrivalTime, agency, agencyContact, agencyContactPhone,
                                        otherCeremony, otherInhumation, expNumLetter, expNumSecuence,
                                        expNumYear, expNumType, changeStatusAuto, deceasedNationalityLocation, familyContactNationality, familyContactOtherCountry, familyContactOtherProvince, familyContactOtherLocation,
                                        applicantNifType, familyContactNifType, priceExp, deceasedNifType, covid, deceasedLocality, deceasedProvince, moveTraslado, moveDevolucion, trazabilityId,
                                        $startVelacionDateUp $startVelacionTimeUp $endVelacionDateUp $endVelacionTimeUp $startVelacionDateUp2 $startVelacionTimeUp2 $endVelacionDateUp2 $endVelacionTimeUp2
                                        authDniType, hearse, hearseLicensePlate, hearseBrand, hearseModel, carCollection1LicensePlate, carCollection1Brand, carCollection1Model, mortuaryRegNotes,
                                        placeDestinationMiddle, placeDestinationFinal, placeDestinationFinalCemetery,
                                        smokeOpacityDateStart, smokeOpacityTimeStart, smokeOpacityDateEnd, smokeOpacityTimeEnd, smokeOpacityLoadWeight, smokeOpacityBacharachScale, smokeOpacityDateReading, smokeOpacityTimeReading, smokeOpacityIncidents, smokeOpacityIncidentsNotes,
                                        notesExpedient, tellmebyeRoom, tellmebyeRoomName
                                    ) 
                                    VALUES ('$currentDate', '$numberExp', " . $_SESSION['user'] . ", '" . $data['requestTime'] . "', '" . $data['requestDate'] . "', " . $data['expType'] . ", 
                                        " . $data['clientType'] . ", '" . $data['policy'] . "', '" . $data['capital'] . "', " . $data['status'] . ", 
                                        " . $data['room'] . ", " . $data['cremation'] . ", " . $data['move'] . ", '" . $data['lossNumber'] . "', '" . $data['internalRef'] . "', " . $data['literal'] . ", 
                                        '" . $data['applicantName'] . "', '" . $data['applicantSurname'] . "', '" . $data['applicantAddress'] . "', 
                                        '" . $data['applicantNIF'] . "', " . $data['applicantLocation'] . ", '" . $data['applicantMail'] . "', 
                                        '" . $data['applicantPhone'] . "', '" . $data['applicantMobilePhone'] . "', '" . $data['familyContactName'] . "', 
                                        '" . $data['familyContactSurname'] . "',  '" . $data['familyContactRelationship'] . "', '" . $data['familyContactAddress'] . "', '" . $data['familyContactNIF'] . "', 
                                        " . $data['familyContactLocation'] . ", '" . $data['familyContactMail'] . "', '" . $data['familyContactPhone'] . "', 
                                        '" . $data['familyContactMobilePhone'] . "', '" . $data['otherContactName'] . "', '" . $data['otherContactPhone'] . "', 
                                        '" . $data['otherContactRelationship'] . "', " . $data['client'] . ", '" . $data['deceasedName'] . "', '" . $data['deceasedSurname'] . "', 
                                        '" . $data['deceasedNIF'] . "', '" . $data['deceasedGender'] . "', '" . $data['deceasedMaritalStatus'] . "', '" . $data['deceasedMaritalStatusDescription'] . "', '" . $data['deceasedChildOfFather'] . "', 
                                        '" . $data['deceasedChildOfMother'] . "', '" . $data['deceasedFirstNuptials'] . "', '" . $data['deceasedSecondNuptials'] . "', 
                                        '" . $data['deceasedNationality'] . "', '" . $data['deceasedNationalityName'] . "', '" . $data['deceasedNationalityProvince'] . "', $deceasedBirthdayDown " . $data['deceasedBirthdayLocation'] . ", 
                                        '" . $data['deceasedUsualAddress'] . "', " . $data['deceasedLocation'] . ",  $otherDeceasedLocation $deceasedDateDown $deceasedTimeDown 
                                        " . $data['deceasedDoctor'] . ", '" . $data['deceasedDoctorCertificate'] . "', '" . $data['deceasedCause'] . "', '" . $data['deceasedTribunal'] . "', '" . $data['deceasedTribunalNumber'] . "', 
                                        " . $data['deceasedMortuary'] . ", '" . $data['deceasedMortuaryAddress'] . "', '" . $data['deceasedRoom'] . "', " . $data['deceasedPanel'] . ", " . $data['church'] . ", 
                                        " . $data['cemetery'] . ", $funeralDateDown $funeralTimeDown $funeralDateNewDown $funeralTimeNewDown $funeralDateBurialDown $funeralTimeBurialDown $ceremonyDateDown $ceremonyTimeDown" . $data['niche'] . ", 
                                        '" . $data['funeralNicheNumber'] . "', " . $data['funeralBusyNiche'] . ", " . $data['regime'] . ", '" . $data['propertyName'] . "', 
                                        '" . $data['deceasedNiche'] . "', $funeralDateNicheDown '" . $data['deceasedNiche2'] . "', $funeralDateNicheDown2   '" . $data['deceasedNiche3'] . "', $funeralDateNicheDown3 
                                        '" . $data['exhumation'] . "', " . $data['nicheHeight'] . ", " . $data['mortuaryReg'] . ", " . $data['funeralReg'] . ", " . $data['personalReg'] . ", " . $data['crematoriumReg'] . ",
                                        " . $data['tanatologicalPractice'] . ", " . $data['funeralHome'] . ", $funeralHomeEntryDateDown $funeralHomeEntryTimeDown $entryDateBarrowDown $entryTimeBarrowDown 
                                        $refrigeratedChamberNameDown $refrigeratedChamberDateStartDown $refrigeratedChamberTimeStartDown $refrigeratedChamberDateEndDown $refrigeratedChamberTimeEndDown
                                        " . $data['coffin'] . ", " . $data['responsibleUser'] . ", '" . $data['responsibleName'] . "', 
                                        '" . $data['responsibleNIF'] . "', " . $data['crematorium'] . ", " . $data['crematoriumClient'] . ", '" . $data['crematoriumContactPersonPhone'] . "', 
                                        '" . $data['crematoriumContactPerson'] . "', " . $data['crematoriumIntroduction'] . ", " . $data['crematoriumWaitOnRoom'] . ", 
                                        " . $data['crematoriumVaseBio'] . ", " . $data['moveFuneralHome'] . ", " . $data['moveClient'] . ", $moveLeavingDateDown $moveLeavingTimeDown 
                                        " . $data['moveCollection'] . ", " . $data['moveDestination'] . ", " . $data['moveVia'] . ", '" . $data['moveNotes'] . "', " . $data['moveJudicial'] . ", 
                                        " . $data['ecologicCoffin'] . ", '" . $data['authName'] . "', '" . $data['authDni'] . "', '" . $data['otherCoffin'] . "', '" . $data['churchLabel'] . "', '" . $data['cemeteryLabel'] . "',
                                        " . $data['authDate'] . ", " . $data['authTime'] . ", '" . $data['authPlace'] . "', " . $data['crematoriumPacemaker'] . ", " . $data['crematoriumTechnical'] . ", '$extraID', 
                                        " . $data['moveContactPhone'].", '".$data['moveContactPerson']."', '".$data['moveDestinationAddress']."', '".$data['moveCollectionAddress']."', '".$data['moveFinalDestination']."',
                                        " . $data['crematoriumContactPhonePerson'].", ". $data['authContactPhone']. ", '" . $data['flightNumber'] . "', '" . $data['airportOrigin'] . "', $departureDateDown  " . $data['departureTime'] . ", 
                                        '" . $data['arrivalAirport'] . "', $arrivalDateDown " . $data['arrivalTime'] . ", '" . $data['agency'] . "', '" . $data['agencyContact'] . "', '" . $data['agencyContactPhone'] . "',
                                        '" .$data['otherCeremony']."', '".$data['otherInhumation']."', '$expNumLetter' , $expNumSec, $expNumYear, $expNumType, 0, '" . $data['deceasedNationalityLocation'] . "',
                                        " . $data['familyContactNationality'] . ", '" . $data['familyContactOtherCountry'] . "', '" . $data['familyContactOtherProvince'] . "', '" . $data['familyContactOtherLocation'] . "',
                                        " . $data['applicantNifType'] . ", " . $data['familyContactNifType'] . ", $priceClient, " . $data['deceasedNifType'] . ", " . $data['covid'] . ", ".$deceasedLocality.", ".$deceasedProvince.",
                                        " . $data['moveTraslado'] . ", " . $data['moveDevolucion'] . ", '" . $data['trazabilityId'] . "', 
                                        $startVelacionDateDown $startVelacionTimeDown $endVelacionDateDown $endVelacionTimeDown $startVelacionDateDown2 $startVelacionTimeDown2 $endVelacionDateDown2 $endVelacionTimeDown2 
                                        " . $data['authNifType'] . ", 
                                        " . $data['hearse'] . ", '" . $data['hearseLicensePlate'] . "', '" . $data['hearseBrand'] . "', '" . $data['hearseModel'] . "', '" . $data['carCollection1LicensePlate'] . "', '" . $data['carCollection1Brand'] . "', '" . $data['carCollection1Model'] . "', '" . $data['mortuaryRegNotes'] . "',
                                        " . $data['placeDestinationMiddle'] . ", " . $data['placeDestinationFinal'] . ", " . $data['placeDestinationFinalCemetery'] . ",
                                        " . $data['smokeOpacityDateStart'] . ", " . $data['smokeOpacityTimeStart'] . ",  " . $data['smokeOpacityDateEnd'] . ", " . $data['smokeOpacityTimeEnd'] . ", " . $data['smokeOpacityLoadWeight'] . ", " . $data['smokeOpacityBacharachScale'] . ",
                                        " . $data['smokeOpacityDateReading'] . ", " . $data['smokeOpacityTimeReading'] . ", " . $data['smokeOpacityIncidents'] . ", '" . $data['smokeOpacityIncidentsNotes'] . "', '" . $data['notesExpedient'] . "',
                                        '" . $data['tellmebyeRoom'] . "', '" . $data['tellmebyeRoomName'] . "')"
            );
          
            $result = $db->query("  SELECT  expedientID AS expedient, funeralHomeEntryDate AS fechaInicio, funeralHomeEntryTime AS horaInicio,
                                            funeralDate AS fechaFin, funeralTime AS horaFin, number
                                    FROM    Expedients
                                    WHERE   extraID = '" . $extraID . "'");
      
            if(mysqli_num_rows($result) > 0){
                $expedient = $db->resultToArray($result)[0];

                // Creación de los servicios asociados al expediente
                if(!$this->createService($expedient['expedient'])){
                    return array($data['type'], false, $numberExp);
                }else{
                    //Actualizar fecha y hora de llegada
                    if($data['arriveTime'] == ''){
                        $consulta = "arriveTime = null,"; 
                    }else{
                        $consulta = "arriveTime = '" . $data['arriveTime'] . "',";
                    }
                    if($data['arriveDate'] == ''){
                        $consulta .= "arriveDate = null,"; 
                    }else{
                        $consulta .= "arriveDate = '" . $data['arriveDate'] . "',";
                    }

                    $consulta .= "
                        funeralHomeService = " . $data['funeralHomeService'] . ",
                        familyAssistance = " . $data['familyAssistance'] . ", 
                        carCollection = " . $data['carCollection1'] . ",
                        corpseCollection1 = " . $data['corpseCollection1'] . ", 
                        corpseCollection2 = " . $data['corpseCollection2'] . ",

                        carCollection2 = " . $data['carCollection2'] . ",
                        staffTransfer1 = " . $data['staffTransfer1'] . ", 
                        staffTransfer2 = " . $data['staffTransfer2'] . "
                    ";

                    $db->query("    UPDATE  Expedients_Services 
                                    SET     $consulta
                                    WHERE   expedient = " . $expedient['expedient'] . "");                      
                }

                // Creación de la documentación asociada al expediente
                if(!$this->createDocs($expedient['expedient'])){
                    return array($data['type'], false, $numberExp);
                }

                // Crear evento en la agenda si hay cremación
                if($data['cremation'] != "false"){
                    $events = new Events();

                    $toEvent = array(   "status" => $data['crematoriumStatus'], 
                                        "name" => 'Cremación Exp. ' . $numExp,
                                        "cleaningType" => "null",
                                        "cleaningMortuary" => "null",
                                        "cleaningUser" => "null",
                                        "type" => 1,
                                        "start" => $data['crematoriumEntryDate'] . " " . $data['crematoriumEntryTime'],
                                        "end" => $data['crematoriumLeavingDate'] . " " . $data['crematoriumLeavingTime'],
                                        "regularity" => "null",
                                        "reminder" => 1, 
                                        "cremation" => 1,
                                        "expedient" => $expedient['expedient'],
                                        "allDay" => 0
                    );

                    $event = $events->create($toEvent);
                    if($event[0]){
                        $result = $db->query("  SELECT  ID 
                                                FROM    Events 
                                                WHERE   extraID = '" . $event[1] . "'");

                        $eventID = $db->resultToArray($result)[0]['ID'];

                        $db->query("UPDATE  Expedients 
                                    SET     crematoriumEvent = " . $eventID . " 
                                    WHERE   expedientID = " . $expedient['expedient'] . "");
                    }
                }

                // Creación las contrataciones asociadas al expediente en base a los productos existentes (sin checkear)
                if($this->createHiringsFirst($expedient['expedient'], $priceClient)){
                 
                    if(
                        $data['deceasedMortuary'] != null && 
                        $data['deceasedMortuary'] != 'null' && 
                        strlen($data['deceasedMortuary']) > 0
                    ){
                        $result = $db->query("SELECT m.isYourOwn FROM Mortuaries m WHERE m.mortuaryID = " . $data['deceasedMortuary']);
                        if(mysqli_num_rows($result) > 0){
                            $isYourOwn = $db->resultToArray($result)[0];

                            $fieldFuneralHomeEntryDate = $data['startVelacionDate'] == '' ? $data['funeralHomeEntryDate'] : $data['startVelacionDate'];
                            $fieldFuneralHomeEntryTime = $data['startVelacionTime'] == '' ? $data['funeralHomeEntryTime'] : $data['startVelacionTime'];
                            $fieldFuneralDate = $data['funeralDate'];
                            $fieldFuneralTime = $data['funeralTime'];

                            if($isYourOwn['isYourOwn'] === "1"){
                                $vc = new VisitsControl();
                                $contVisit = 1;
                                $hora = null;
                                if($fieldFuneralHomeEntryDate != '' && $fieldFuneralHomeEntryTime != '' && $fieldFuneralDate != '' && $fieldFuneralTime != ''){
                                    $vControl = $vc->createVisitControl($expedient['expedient']);
                                    if(strtotime($fieldFuneralHomeEntryTime) < strtotime("08:00:00")){
                                        $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, $fieldFuneralHomeEntryTime, $fieldFuneralHomeEntryDate)[0];
                                        $vc->createVisitDescription($visit);
                                        $fieldFuneralHomeEntryTime = "08:00:00";
                                        $contVisit++;
                                    }
                                    // for($dia = strtotime($fieldFuneralHomeEntryDate); $dia <= strtotime($fieldFuneralDate); $dia = $dia+(60*60*24)){                
                                    for($dia = strtotime($fieldFuneralHomeEntryDate); $dia <= strtotime($fieldFuneralDate);  $dia = strtotime("+1 day", $dia)){
                                        if($dia == strtotime($fieldFuneralHomeEntryDate)){
                                            //Empieza el rimer día
                                            if(strtotime($fieldFuneralHomeEntryDate) == strtotime($fieldFuneralDate)){
                                                //Acaba el primer día
                                                for($hora = strtotime($fieldFuneralHomeEntryTime); $hora <= strtotime($fieldFuneralTime); $hora = $hora+(60*60*3)){
                                                    $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', $hora), date("Y-m-d", $dia))[0];
                                                    $vc->createVisitDescription($visit);
                                                    $contVisit++;
                                                } 
                                            }else{
                                                //Acaba otro día
                                                for($hora = strtotime($fieldFuneralHomeEntryTime); $hora <= strtotime("22:00:00"); $hora = $hora+(60*60*3)){
                                                    $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', $hora), date("Y-m-d", $dia))[0];
                                                    $vc->createVisitDescription($visit);
                                                    $contVisit++;
                                                }
                                                if($hora > strtotime("22:00:00")){
                                                    $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', strtotime("22:00:00")), date("Y-m-d", $dia))[0];
                                                    $vc->createVisitDescription($visit);
                                                    $contVisit++;
                                                }
                                            }
                                        }else{
                                            //Si ya no es el primer día
                                            if($dia == strtotime($fieldFuneralDate)){
                                                //Si estamos en el primer día empezamos a crear desde la hora de inicio
                                                for($hora = strtotime("08:00"); $hora <= strtotime($fieldFuneralTime); $hora = $hora+(60*60*3)){
                                                    $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', $hora), date("Y-m-d", $dia))[0];
                                                    $vc->createVisitDescription($visit);
                                                    $contVisit++;
                                                } 
                                            }else{
                                                for($hora = strtotime("08:00"); $hora <= strtotime("22:00:00"); $hora = $hora+(60*60*3)){
                                                    $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', $hora), date("Y-m-d", $dia))[0];
                                                    $vc->createVisitDescription($visit);
                                                    $contVisit++;
                                                }
                                                if($hora > strtotime("22:00:00")){
                                                    $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', strtotime("22:00:00")), date("Y-m-d", $dia))[0];
                                                    $vc->createVisitDescription($visit);
                                                    $contVisit++;
                                                }
                                            }
                                        }                
                                    }
                                    if(strtotime($fieldFuneralTime) > $hora - (60*60*3)){
                                        $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, $fieldFuneralTime, $fieldFuneralDate)[0];
                                        $vc->createVisitDescription($visit);
                                    }
                                }else{
                                    if($fieldFuneralHomeEntryDate != '' && $fieldFuneralHomeEntryTime != ''){
                                        $vControl = $vc->createVisitControl($expedient['expedient']);
                                        $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, $fieldFuneralHomeEntryTime, $fieldFuneralHomeEntryDate)[0];
                                        $vc->createVisitDescription($visit);
                                    }
                                }
                            }else{
                                $vc = new VisitsControl();
                                $contVisit = 1;
                                if($fieldFuneralHomeEntryDate != '' && $fieldFuneralHomeEntryTime != '' && $fieldFuneralDate != '' && $fieldFuneralTime != ''){
                                    $vControl = $vc->createVisitControl($expedient['expedient']);
                                    // for($dia = strtotime($fieldFuneralHomeEntryDate); $dia <= strtotime($fieldFuneralDate); $dia = $dia+(60*60*24)){
                                    for($dia = strtotime($fieldFuneralHomeEntryDate); $dia <= strtotime($fieldFuneralDate);  $dia = strtotime("+1 day", $dia)){
                                        if(strtotime($fieldFuneralHomeEntryTime) > strtotime("11:00:00")){
                                            if(strtotime(date('Y-m-d', $dia + 60 * 60 * 24) . ' ' . $fieldFuneralHomeEntryTime) < strtotime($fieldFuneralDate . ' ' . $fieldFuneralTime)){
                                                $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', strtotime("11:00:00")), date("Y-m-d", $dia+(60*60*24)))[0];
                                                $vc->createVisitDescription($visit);
                                                $contVisit++;
                                            }
                                        }else{
                                            if(strtotime(date('Y-m-d', $dia) . ' ' . $fieldFuneralHomeEntryTime) < strtotime($fieldFuneralDate . ' ' . $fieldFuneralTime)){
                                                $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', strtotime("11:00:00")), date("Y-m-d", $dia))[0];
                                                $vc->createVisitDescription($visit);
                                                $contVisit++;
                                            }
                                        }
                                    }
                                }elseif($fieldFuneralHomeEntryDate && $fieldFuneralHomeEntryTime != ''){
                                    $vControl = $vc->createVisitControl($expedient['expedient']);
                                    if(strtotime($fieldFuneralHomeEntryTime) > strtotime("11:00:00")){
                                        $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', strtotime("11:00:00")), date('Y-m-d', strtotime($fieldFuneralHomeEntryDate) + 24 * 60 * 60))[0];
                                    }else{
                                        $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', strtotime("11:00:00")), $fieldFuneralHomeEntryDate)[0];
                                    }
                                    $vc->createVisitDescription($visit);
                                }
                            }
                        }
                    }
                }
            }

            return $expedient;
        }

        /**
        * Crear expediente - Tipo TPV
        *
        * @param array $data
        *
        * @return array
        */
        public function createExpedientTPV($data){
            $db = new DbHandler;

            $data['requestTime'] = cleanStr($data['requestTime']);
            $data['requestDate'] = cleanStr($data['requestDate']);
            $data['expType'] = cleanStr($data['expType']);
            $data['clientType'] = cleanStr($data['clientType']);
            $data['policy'] = cleanStr($data['policy']);
            $data['capital'] = cleanStr($data['capital']);
            $data['status'] = cleanStr($data['status']);
            $data['lossNumber'] = cleanStr($data['lossNumber']);
            $data['arriveTime'] = cleanStr($data['arriveTime']);
            $data['arriveDate'] = cleanStr($data['arriveDate']);
            $data['client'] = cleanStr($data['client']);
            $data['deceasedName'] = cleanStr($data['deceasedName']);
            $data['deceasedGender'] = cleanStr($data['deceasedGender']);
            $data['deceasedSurname'] = cleanStr($data['deceasedSurname']);
            $data['deceasedNIF'] = cleanStr($data['deceasedNIF']);
            $data['deceasedNifType'] = cleanStr($data['deceasedNifType']);
            $data['deceasedMortuary'] = cleanStr($data['deceasedMortuary']);
            $data['deceasedMortuaryAddress'] = cleanStr($data['deceasedMortuaryAddress']);

            // Validación de campos
            if($data['expType'] == ''){
                return false;
            }
            
            if($data['deceasedNIF'] != ''){
                if($data['deceasedNifType'] != 3 &&  $data["deceasedNifType"] != 4){
                    if(!isValidIdNumber($data['deceasedNIF'])){
                        return false;
                    }
                }
            }
            if(empty($data['deceasedMortuary'])){
                $data['deceasedMortuary'] = 'null';
            }

            // Calculate extraID
            $result = $db->query("  SELECT  MAX(expedientID) as id
                                    FROM    Expedients");

            $maxID = mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0]['id'] : '1';
            $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);
            $extraID .= ($maxID+1);
            
            // if($data['client'] != null && $data['client'] != ''){
            //     $result = $db->query("  SELECT   c.price
            //                             FROM     Clients c
            //                             WHERE    c.clientID = {$data['client']}");
                                        
            //     if(mysqli_num_rows($result) > 0){
            //         $priceClient = $db->resultToArray($result)[0]['price'];
            //     }else{
            //         $priceClient = 'null';
            //     }
            // }else{
            //     $priceClient = 'null'; 
            // }

            $createYear = explode('-', $data['requestDate'])[0];

            // Gets client price
            if($data['client'] != null && $data['client'] != ''){

               $result = $db->query("   SELECT   p.name
                                        FROM     Clients c, Prices p
                                        WHERE    c.clientID = {$data['client']} 
                                            AND  p.leavingDate IS NULL
                                            AND  p.priceID = c.price");
                                        
                if(mysqli_num_rows($result) > 0){
                    $priceName = $db->resultToArray($result)[0]['name'];

                    $result = $db->query("  SELECT   p.priceID
                                            FROM     Prices p
                                            WHERE    p.name = '$priceName' 
                                                AND  p.leavingDate IS NULL
                                                AND  p.year = $createYear");

                    if(mysqli_num_rows($result) > 0){
                        $priceClient = $db->resultToArray($result)[0]['priceID'];
                    }else{
                        $result = $db->query("  SELECT   c.price
                                                FROM     Clients c
                                                WHERE    c.clientID = {$data['client']}");
                                            
                        if(mysqli_num_rows($result) > 0){
                            $priceClient = $db->resultToArray($result)[0]['price'];
                        }else{
                            $priceClient = 'null';
                        }
                    }
                }else{
                    $priceClient = 'null';
                }

            }else{
                $priceClient = 'null'; 
            }

            //Tipo de expediente
            switch($data['expType']){
                case '1': //DEFUNCION
                    switch($data['clientType']){
                        case '1': //PARTICULARES

                            $expNumLetter = 'P';

                            $expNumYear = $createYear;
                            //Calcular el numero de secuencia del expediente par tipo DEFUNCION
                            $result = $db->query("  SELECT  COUNT(expedientID) as total 
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND type = 1 AND                                                           
                                                            entryDate >= '" .  $expNumYear . "-01-01 00:00:00' AND 
                                                            entryDate <= '" .  $expNumYear . "-12-31 23:59:59'" );

                            if(mysqli_num_rows($result) > 0){
                                $expNumSec = $db->resultToArray($result)[0]['total'] + 1;
                            }else{
                                $expNumSec = 1;
                            }

                            //Calcular el numero de secuencia del expediente para Particulares
                            $result = $db->query("  SELECT  COUNT(expedientID) as total 
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = 1 AND type = 1 AND
                                                            entryDate >= '" .  $expNumYear . "-01-01 00:00:00' AND 
                                                            entryDate <= '" . $expNumYear . "-12-31 23:59:59'" );
                            
                            if(mysqli_num_rows($result) > 0){
                                $expNumType = $db->resultToArray($result)[0]['total'] + 1;
                            }else{
                                $expNumType = 1;
                            }

                            $expNumYear = substr($expNumYear, -2);
                            $numberExp = $expNumSec . ' ' . $expNumLetter . $expNumType . '/' . $expNumYear;

                        break;

                        case '2': //SEGUROS
                            $expNumLetter = 'S';

                            $expNumYear = $createYear;

                            //Calcular el numero de secuencia del expediente para tipo DEFUNCION
                            $result = $db->query("  SELECT  COUNT(expedientID) as total 
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND type = 1 AND                                                           
                                                            entryDate >= '" . $expNumYear . "-01-01 00:00:00' AND 
                                                            entryDate <= '" . $expNumYear . "-12-31 23:59:59'" );
                          
                            if(mysqli_num_rows($result) > 0){
                                $expNumSec = $db->resultToArray($result)[0]['total'] + 1;
                            }else{
                                $expNumSec = 1;
                            }


                            //Calcular el numero de secuencia del expediente para seguros
                            $result = $db->query("  SELECT  COUNT(expedientID) as total 
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = 2 AND type = 1 AND
                                                            entryDate >= '" .  $expNumYear . "-01-01 00:00:00' AND 
                                                            entryDate <= '" . $expNumYear . "-12-31 23:59:59'" );
                            
                            if(mysqli_num_rows($result) > 0){
                                $expNumType = $db->resultToArray($result)[0]['total'] + 1;
                            }else{
                                $expNumType = 1;
                            }
                            $expNumYear = substr($expNumYear, -2);

                            $numberExp = $expNumSec . ' ' . $expNumLetter . $expNumType . '/' . $expNumYear;
                        break;

                        case '3': //EMPRESAS
                            $expNumLetter = 'E';

                            $expNumYear = $createYear;
                            //Calcular el numero de secuencia del expediente par tipo DEFUNCION
                            $result = $db->query("  SELECT  COUNT(expedientID) as total 
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND type = 1 AND                                                           
                                                            entryDate >= '" . $expNumYear . "-01-01 00:00:00' AND 
                                                            entryDate <= '" . $expNumYear . "-12-31 23:59:59'" );

                            if(mysqli_num_rows($result) > 0){
                                $expNumSec = $db->resultToArray($result)[0]['total'] + 1;
                            }else{
                                $expNumSec = 1;
                            }


                            //Calcular el numero de secuencia del expediente para empresas
                            $result = $db->query("  SELECT  COUNT(expedientID) as total 
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = 3 AND type = 1 AND
                                                            entryDate >= '" .  $expNumYear . "-01-01 00:00:00' AND 
                                                            entryDate <= '" . $expNumYear . "-12-31 23:59:59'" );
                            
                            if(mysqli_num_rows($result) > 0){
                                $expNumType = $db->resultToArray($result)[0]['total'] + 1;
                            }else{
                                $expNumType = 1;
                            }

                            $expNumYear = substr($expNumYear, -2);
                            $numberExp = $expNumSec . ' ' . $expNumLetter . $expNumType . '/' . $expNumYear;
                        break;
                    }
                break;

                case '2': //PRESUPUESTO

                    $expNumLetter = 'PR';
                    //Calcular el numero de secuencia del expediente par tipo PRESUPUESTO
                    $result = $db->query("  SELECT  COUNT(expedientID) as total 
                                            FROM    Expedients 
                                            WHERE   leavingDate IS NULL AND type = 2 AND                                                           
                                                    entryDate >= '" . $createYear . "-01-01 00:00:00' AND 
                                                    entryDate <= '" . $createYear . "-12-31 23:59:59'" );
                    
                    if(mysqli_num_rows($result) > 0){
                        $expNumSec = $db->resultToArray($result)[0]['total'] + 1;
                    }else{
                        $expNumSec = 1;
                    }
                    $expNumYear = $createYear;
                    $expNumYear = substr($expNumYear, -2);
                    //$expNumYear = 2012;
                    $expNumType = 0;
                    $numberExp = $expNumLetter . '-' . $expNumSec . '/' . $expNumYear;
                break;

                case '3': //VARIOS
                    $expNumLetter = 'V';
                    //Calcular el numero de secuencia del expediente par tipo VARIOS
                    $result = $db->query("  SELECT  COUNT(expedientID) as total 
                                            FROM    Expedients 
                                            WHERE   leavingDate IS NULL AND type = 3 AND                                                           
                                                    entryDate >= '" . $createYear . "-01-01 00:00:00' AND 
                                                    entryDate <= '" . $createYear . "-12-31 23:59:59'" );

                    if(mysqli_num_rows($result) > 0){
                        $expNumSec = $db->resultToArray($result)[0]['total'] + 1;
                    }else{
                        $expNumSec = 1;
                    }
                    $expNumYear = $createYear;
                    //$expNumYear = 2012;
                    $expNumYear = substr($expNumYear, -2);
                    $expNumType = 0;
                    $numberExp = $expNumLetter . '-' . $expNumSec . '/' . $expNumYear;
                break;
            }

            if(empty($data['lossNumber'])){
                $data['lossNumber'] = null;
            }
            if(empty($data['client'])){
                $data['client'] = 'null';
            }

            $currentDate = $data['requestDate'];
            $expNumYear = $createYear;
            
            $expedient = $db->query("INSERT INTO Expedients (entryDate, number, user, requestTime, requestDate, type, clientType, policy, capital, status, lossNumber, 
                                        client, deceasedGender, deceasedName, deceasedSurname, deceasedNIF, deceasedNifType, deceasedMortuary, deceasedMortuaryAddress, 
                                        niche, move, room, literal, cremation, deceasedRoom, deceasedPanel, regime, funeralBusyNiche, nicheHeight, crematoriumIntroduction, 
                                        crematoriumWaitOnRoom, crematoriumVaseBio, crematoriumPacemaker, moveVia, moveJudicial, extraID, priceExp, expNumLetter, expNumSecuence,
                                        expNumYear, expNumType, tpv) 
                                    VALUES ('$currentDate', '$numberExp', " . $_SESSION['user'] . ", '" . $data['requestTime'] . "', '" . $data['requestDate'] . "', " . $data['expType'] . ", 
                                        " . $data['clientType'] . ", '" . $data['policy'] . "', '" . $data['capital'] . "', " . $data['status'] . ", 
                                        '" . $data['lossNumber'] . "', " . $data['client'] . ", '" . $data['deceasedGender'] . "', '" . $data['deceasedName'] . "', '" . $data['deceasedSurname'] . "', 
                                        '" . $data['deceasedNIF'] . "', '" . $data['deceasedNifType'] . "', " . $data['deceasedMortuary'] . ", '" . $data['deceasedMortuaryAddress'] . "',
                                        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                                        0, 0, 0, 0, 0, '$extraID', $priceClient, '$expNumLetter' , $expNumSec,
                                        $expNumYear, $expNumType, 1)");

            $result = $db->query("  SELECT  expedientID AS expedient, funeralHomeEntryDate AS fechaInicio, funeralHomeEntryTime AS horaInicio,
                                            funeralDate AS fechaFin, funeralTime AS horaFin, number
                                    FROM    Expedients
                                    WHERE   extraID = '" . $extraID . "'");
      
            if(mysqli_num_rows($result) > 0){
                $expedient = $db->resultToArray($result)[0];

                // Creación de los servicios asociados al expediente
                if(!$this->createService($expedient['expedient'], 'TPV')){
                    return false;
                }else{
                    //Actualizar hora de llegada
                    if($data['arriveTime'] == ''){
                        $consulta = "arriveTime = null"; 
                    }else{
                        $consulta = "arriveTime = '" . $data['arriveTime'] . "'";
                    }
                    if($data['arriveDate'] == ''){
                        $consulta .= ",arriveDate = null"; 
                    }else{
                        $consulta .= ",arriveDate = '" . $data['arriveDate'] . "'";
                    }
                    $db->query("    UPDATE  Expedients_Services 
                                    SET     $consulta
                                    WHERE   expedient = " . $expedient['expedient'] . "");                      
                }

                // Creación las contrataciones asociadas al expediente en base a los productos existentes (sin checkear)
                if(!$this->createHiringsFirst($expedient['expedient'], $priceClient)){
                    return false;
                }
            }

            return $expedient;
        }

        /**
        * Obtiene los datos de un expediente
        *
        * @param array $data
        *
        * @return array
        */
        public function readExpedient($data){
            $db = new DbHandler;

            $data['ID'] = cleanStr($data['ID']);

            $result = $db->query("  SELECT      e.*, 
                                                e.type as expedientType,
                                                ess.arriveTime,
                                                ess.arriveDate,
                                                ess.crematoriumProgramOven,
                                                ess.crematoriumWhoDelivered,
                                                st2.name as crematoriumWhoDeliveredName,
                                                st2.surname as crematoriumWhoDeliveredSurname,
                                                ess.crematoriumWhoProgramOven,
                                                st3.name as crematoriumWhoProgramOvenName,
                                                st3.surname as crematoriumWhoProgramOvenSurname,
                                                ess.crematoriumNotes,
                                                ess.crematoriumControlDeliversAshes,
                                                ess.crematoriumFirstGenerateDocDate,
                                                CONCAT(u7.name, ' ', u7.surname) as crematoriumFirstGenerateDocUser,
                                                di.name as deceasedLocationName,
                                                m.name AS deceasedMortuaryName, 
                                                m.tellmebye as mortuaryTellmebye, 
                                                m.tellmebyeName as mortuaryTellmebyeName,
                                                m.address as mortuaryAddress,
                                                l8.name AS mortuaryLocation,
                                                ch.name AS churchName,
                                                cm.name AS cemeteryName, 
                                                f.name AS funeralHomeName,
                                                cr.name AS crematoriumName,
                                                f1.name AS crematoriumClientName,
                                                fh.name AS moveFuneralHomeName,
                                                c2.name AS moveClientName,
                                                ev.ID as eventID, ev.name as crematoriumEvent, ev.start as crematoriumEntry, 
                                                ev.end as crematoriumLeaving, ev.status as crematoriumStatus,
                                                e.otherDeceasedLocation,
                                                d.ID as deceasedDoctorID, d.name as deceasedDoctorName,
                                                l1.province as applicantLocationProvince, l1.name as applicantLocationName, l1.postalCode as applicantLocationPostalCode,
                                                l2.province as familyContactLocationProvince, l2.name as familyContactLocationName, l2.postalCode as familyContactLocationPostalCode,
                                                l3.province as deceasedBirthdayLocationProvince, l3.name as deceasedBirthdayLocationName, l3.postalCode as deceasedBirthdayLocationPostalCode,
                                                l4.province as moveCollectionProvince, l4.name as moveCollectionName, l4.postalCode as moveCollectionPostalCode,
                                                l5.province as moveDestinationProvince, l5.name as moveDestinationName, l5.postalCode as moveDestinationPostalCode,
                                                st.name as crematoriumTechnicalName, st.surname as crematoriumTechnicalSurname,
                                                ea.number as numberAssociate, ea.deceasedName as deceasedNameAssociate, ea.deceasedSurname as deceasedSurnameAssociate,
                                                st1.name as responsibleUserName, st1.nif as responsibleUserNif, CONCAT(st1.name, ' ', st1.surname) as responsibleUserNamePreparacion, 
                                                i.ID as invoice, i.generatedInvoiceNumber as numInvoice, i.num_hiring as invoice_num_hiring,
                                                ess.funeralHomeService, ess.corpseCollection1, ess.corpseCollection2, ess.familyAssistance, ess.carCollection,
                                                fuS.name as fuName, u2.name as c1Name, u2.surname as c1Surname, u3.name as faName, u3.surname as faSurname,
                                                st6.name as faName1, st6.surname as faSurname1, 
                                                u4.name as c2Name, u4.surname as c2Surname, 
                                                ca.brand as carBrand, ca.model as carModel, ca.licensePlate as carLicense,
                                                CONCAT(st4.name, ' ', st4.surname) as corpseCollection1Name,
                                                CONCAT(st5.name, ' ', st5.surname) as corpseCollection2Name,
                                                ess.staffTransfer1, ess.staffTransfer2, ess.carCollection2,
                                                ca2.brand as carBrand2, ca2.model as carModel2, ca2.licensePlate as carLicense2,
                                                u5.name as st1Name, u5.surname as st1Surname,
                                                CONCAT(st7.name, ' ', st7.surname) as staffTransfer1Name,
                                                u6.name as st2Name, u6.surname as st2Surname,
                                                CONCAT(st8.name, ' ', st8.surname) as staffTransfer2Name,
                                                ca3.brand as carBrandHearse, ca3.model as carModelHearse, ca3.licensePlate as carLicenseHearse,
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Services_Cars sc, Cars cars
                                                    WHERE   sc.service = e.expedientID
                                                        AND cars.ID = sc.car
                                                        AND cars.drivingService = 1
                                                ) as hearse_from_service,
                                                dpm.name as placeDestinationMiddleName, l6.name as placeDestinationMiddleLocality,
                                                dpf.name as placeDestinationFinalName, l7.name as placeDestinationFinalLocality,
                                                cm2.name AS placeDestinationFinalCemeteryName,
                                                ess.webLink,
                                                c1.protocol as client_protocol,
                                                c1.doc as client_doc,
                                                c1.brandName as clientBrandName, 
                                                c1.name as clientName, 
                                                c1.surname as clientSurname, 
                                                c1.type as client_type, 
                                                c1.nif as clientNif,
                                                e.next_invoice_status,
                                                (
                                                    SELECT  MAX(eh.num_hiring)
                                                    FROM    Expedients_Hirings eh
                                                    WHERE   expedient = e.expedientID
                                                ) as num_hiring,
                                                (
                                                    SELECT  MAX(eh.num_hiring)
                                                    FROM    Expedients_Hirings eh
                                                    WHERE   eh.expedient = e.expedientID AND 
                                                            eh.num_hiring = (
                                                                SELECT      MAX(eh2.num_hiring)
                                                                FROM        Expedients_Hirings eh2
                                                                LEFT JOIN   Invoices i2 ON i2.expedient = eh2.expedient AND i2.leavingDate IS NULL AND i2.num_hiring = eh2.num_hiring
                                                                WHERE       eh2.expedient = e.expedientID AND
                                                                            (i2.invoice_type IS NULL OR i2.invoice_type != 3)
                                                            )
                                                    LIMIT   1
                                                ) as last_hiring_not_anuled,
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices i2
                                                    WHERE   i2.expedient = e.expedientID AND
                                                            i2.leavingDate IS NULL
                                                ) as total_invoices,
                                                (
                                                    SELECT  MAX(i2.num_hiring)
                                                    FROM    Invoices i2
                                                    WHERE   i2.expedient = e.expedientID AND
                                                            i2.leavingDate IS NULL AND 
                                                            i2.invoice_type != 3
                                                ) as last_invoice_not_anuled,
                                                (
                                                    SELECT  eh.rectified_type
                                                    FROM    Expedients_Hirings eh
                                                    WHERE   eh.expedient = e.expedientID AND 
                                                            eh.num_hiring = (
                                                                SELECT      MAX(eh2.num_hiring)
                                                                FROM        Expedients_Hirings eh2
                                                                LEFT JOIN   Invoices i2 ON i2.expedient = eh2.expedient AND i2.leavingDate IS NULL AND i2.num_hiring = eh2.num_hiring
                                                                WHERE       eh2.expedient = e.expedientID AND
                                                                            (i2.invoice_type IS NULL OR i2.invoice_type != 3)
                                                            )
                                                    LIMIT   1
                                                ) as last_hiring_rectified_type
                                    FROM        (Expedients e, Expedients_Services ess)
                                    LEFT JOIN   Events ev ON e.crematoriumEvent = ev.ID AND ev.leavingDate IS NULL
                                    LEFT JOIN   Doctors d ON e.deceasedDoctor = d.ID
                                    LEFT JOIN   Locations l1 ON e.applicantLocation = l1.locationID
                                    LEFT JOIN   Locations l2 ON e.familyContactLocation = l2.locationID
                                    LEFT JOIN   Locations l3 ON e.deceasedBirthdayLocation = l3.locationID
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   Churches ch ON e.church = ch.churchID
                                    LEFT JOIN   Cemeteries cm  ON e.cemetery = cm.cemeteryID
                                    LEFT JOIN   FuneralHomes f  ON e.funeralHome = f.funeralHomeID
                                    LEFT JOIN   Crematoriums cr  ON e.crematorium = cr.crematoriumID
                                    LEFT JOIN   FuneralHomes f1 ON e.crematoriumClient = f1.funeralHomeID
                                    LEFT JOIN   Clients c1 ON e.client = c1.clientID
                                    LEFT JOIN   Clients c2 ON e.moveClient = c2.clientID
                                    LEFT JOIN   FuneralHomes fh ON e.moveFuneralHome = fh.funeralHomeID
                                    LEFT JOIN   Locations l4 ON e.moveCollection = l4.locationID
                                    LEFT JOIN   Locations l5 ON e.moveDestination = l5.locationID
                                    LEFT JOIN   DeceasedIn di ON di.deceasedInID = e.deceasedLocation
                                    LEFT JOIN   Staff st ON e.crematoriumTechnical = st.ID
                                    LEFT JOIN   Staff st1 ON e.responsibleUser = st1.ID
                                    LEFT JOIN   Staff st2 ON ess.crematoriumWhoDelivered = st2.ID
                                    LEFT JOIN   Staff st3 ON ess.crematoriumWhoProgramOven = st3.ID
                                    LEFT JOIN   Invoices i ON i.expedient = e.expedientID AND i.leavingDate IS NULL AND i.ID = (SELECT MAX(i2.ID) FROM Invoices i2 WHERE i2.leavingDate IS NULL AND i2.expedient = e.expedientID)
                                    LEFT JOIN   Expedients ea ON ea.expedientID = e.associate
                                    LEFT JOIN   FuneralHomes fuS on ess.funeralHomeService = fuS.funeralHomeID
                                    LEFT JOIN   Users u2 ON ess.corpseCollection1 = u2.userID
                                    LEFT JOIN   Users u4 ON ess.corpseCollection2 = u4.userID
                                    LEFT JOIN   Users u3 ON ess.familyAssistance = u3.userID
                                    LEFT JOIN   Cars ca ON ess.carCollection = ca.ID
                                    LEFT JOIN   Staff st4 ON ess.corpseCollection1 = st4.ID
                                    LEFT JOIN   Staff st5 ON ess.corpseCollection2 = st5.ID
                                    LEFT JOIN   Staff st6 ON ess.familyAssistance = st6.ID
                                    LEFT JOIN   Cars ca2 ON ess.carCollection2 = ca2.ID
                                    LEFT JOIN   Users u5 ON ess.staffTransfer1 = u5.userID
                                    LEFT JOIN   Users u6 ON ess.staffTransfer2 = u6.userID
                                    LEFT JOIN   Staff st7 ON ess.staffTransfer1 = st7.ID
                                    LEFT JOIN   Staff st8 ON ess.staffTransfer2 = st8.ID
                                    LEFT JOIN   Cars ca3 ON e.hearse = ca3.ID
                                    LEFT JOIN   Destination_Places_Middles dpm ON dpm.ID = e.placeDestinationMiddle 
                                    LEFT JOIN   Locations l6 ON dpm.location = l6.locationID
                                    LEFT JOIN   Destination_Places_Finals dpf ON dpf.ID = e.placeDestinationFinal
                                    LEFT JOIN   Locations l7 ON dpf.location = l7.locationID
                                    LEFT JOIN   Locations l8 ON l8.locationID = m.location
                                    LEFT JOIN   Cemeteries cm2  ON e.placeDestinationFinalCemetery = cm2.cemeteryID
                                    LEFT JOIN   Users u7 ON ess.crematoriumFirstGenerateDocUser = u7.userID
                                    WHERE       e.expedientID = " . $data['ID']. " AND
                                                e.expedientID = ess.expedient
            ");

            if(mysqli_num_rows($result) == 0){
				return null;
			}else{
                return $db->resultToArray($result);
            }
        }

        /**
        * Obtiene el nombre y apellidos de un difunto
        *
        * @param array $data
        *
        * @return array
        */
        public function getDeceasedInfo($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT  e.deceasedName, e.deceasedSurname 
                                    FROM    Expedients e
                                    WHERE   e.expedientID = " . $expedient. "");

            if(mysqli_num_rows($result) == 0){
				return null;
			}else{
                return $db->resultToArray($result);
            }
        }

        /**
        * Modifica los datos de un expediente
        *
        * @param array $data
        *
        * @return bool
        */
        public function updateExpedient($data){
            $db = new DbHandler;

            $data['expedientID'] = cleanStr($data['expedientID']);
            $data['deceasedBirthday'] = cleanStr($data['deceasedBirthday']);
            $data['deceasedDate'] = cleanStr($data['deceasedDate']);
            $data['deceasedTime'] = cleanStr($data['deceasedTime']);
            $data['deceasedRoom'] = cleanStr($data['deceasedRoom']);
            $data['tellmebyeRoom'] = cleanStr($data['tellmebyeRoom']);
            $data['tellmebyeRoomName'] = cleanStr($data['tellmebyeRoomName']);
            $data['funeralDate'] = cleanStr($data['funeralDate']);
            $data['funeralTime'] = cleanStr($data['funeralTime']);
            $data['ceremonyDate'] = cleanStr($data['ceremonyDate']);
            $data['ceremonyTime'] = cleanStr($data['ceremonyTime']);
            $data['funeralDateNew'] = cleanStr($data['funeralDateNew']);
            $data['funeralTimeNew'] = cleanStr($data['funeralTimeNew']);
            $data['funeralDateBurial'] = cleanStr($data['funeralDateBurial']);
            $data['funeralTimeBurial'] = cleanStr($data['funeralTimeBurial']);
            $data['funeralDateNiche'] = cleanStr($data['funeralDateNiche']);
            $data['funeralDateNiche2'] = cleanStr($data['funeralDateNiche2']);
            $data['funeralDateNiche3'] = cleanStr($data['funeralDateNiche3']);
            $data['funeralHomeEntryDate'] = cleanStr($data['funeralHomeEntryDate']);
            $data['funeralHomeEntryTime'] = cleanStr($data['funeralHomeEntryTime']);
            $data['entryDateBarrow'] = cleanStr($data['entryDateBarrow']);
            $data['entryTimeBarrow'] = cleanStr($data['entryTimeBarrow']);
            $data['crematoriumEntryDate'] = cleanStr($data['crematoriumEntryDate']);
            $data['crematoriumEntryTime'] = cleanStr($data['crematoriumEntryTime']);
            $data['crematoriumLeavingDate'] = cleanStr($data['crematoriumLeavingDate']);
            $data['crematoriumLeavingTime'] = cleanStr($data['crematoriumLeavingTime']);
            $data['crematoriumArriveTime'] = cleanStr($data['crematoriumArriveTime']);
            $data['moveLeavingDate'] = cleanStr($data['moveLeavingDate']);
            $data['moveLeavingTime'] = cleanStr($data['moveLeavingTime']);
            $data['expType'] = cleanStr($data['expType']);
            $data['requestTime'] = cleanStr($data['requestTime']);
            $data['requestDate'] = cleanStr($data['requestDate']);
            $data['clientType'] = cleanStr($data['clientType']);
            $data['policy'] = cleanStr($data['policy']);
            $data['capital'] = cleanStr($data['capital']);
            $data['move'] = cleanStr($data['move']);
            $data['status'] = cleanStr($data['status']);
            $data['room'] = cleanStr($data['room']);
            $data['cremation'] = cleanStr($data['cremation']);
            $data['literal'] = cleanStr($data['literal']);
            $data['applicantName'] = cleanStr($data['applicantName']);
            $data['applicantSurname'] = cleanStr($data['applicantSurname']);
            $data['applicantNIF'] = cleanStr($data['applicantNIF']);
            $data['applicantNifType'] = cleanStr($data['applicantNifType']);
            $data['applicantAddress'] = cleanStr($data['applicantAddress']);
            $data['applicantLocation'] = cleanStr($data['applicantLocation']);
            $data['applicantMail'] = cleanStr($data['applicantMail']);
            $data['applicantPhone'] = cleanStr($data['applicantPhone']);
            $data['applicantMobilePhone'] = cleanStr($data['applicantMobilePhone']);
            $data['familyContactName'] = cleanStr($data['familyContactName']);
            $data['familyContactSurname'] = cleanStr($data['familyContactSurname']);
            $data['familyContactRelationship'] = cleanStr($data['familyContactRelationship']);
            $data['familyContactNIF'] = cleanStr($data['familyContactNIF']);
            $data['familyContactNifType'] = cleanStr($data['familyContactNifType']);
            $data['familyContactAddress'] = cleanStr($data['familyContactAddress']);
            $data['familyContactLocation'] = cleanStr($data['familyContactLocation']);
            $data['familyContactMail'] = cleanStr($data['familyContactMail']);
            $data['familyContactPhone'] = cleanStr($data['familyContactPhone']);
            $data['familyContactMobilePhone'] = cleanStr($data['familyContactMobilePhone']);
            $data['familyContactNationality'] = cleanStr($data['familyContactNationality']);
            $data['familyContactOtherCountry'] = cleanStr($data['familyContactOtherCountry']);
            $data['familyContactOtherProvince'] = cleanStr($data['familyContactOtherProvince']);
            $data['familyContactOtherLocation'] = cleanStr($data['familyContactOtherLocation']);
            $data['otherContactName'] = cleanStr($data['otherContactName']);
            $data['otherContactPhone'] = cleanStr($data['otherContactPhone']);
            $data['otherContactRelationship'] = cleanStr($data['otherContactRelationship']);
            $data['client'] = cleanStr($data['client']);
            $data['deceasedName'] = cleanStr($data['deceasedName']);
            $data['deceasedSurname'] = cleanStr($data['deceasedSurname']);
            $data['deceasedNIF'] = cleanStr($data['deceasedNIF']);
            $data['deceasedNifType'] = cleanStr($data['deceasedNifType']);
            $data['deceasedGender'] = cleanStr($data['deceasedGender']);
            $data['deceasedMaritalStatus'] = cleanStr($data['deceasedMaritalStatus']);
            $data['deceasedMaritalStatusDescription'] = cleanStr($data['deceasedMaritalStatusDescription']);
            $data['deceasedChildOfFather'] = cleanStr($data['deceasedChildOfFather']);
            $data['deceasedChildOfMother'] = cleanStr($data['deceasedChildOfMother']);
            $data['deceasedFirstNuptials'] = cleanStr($data['deceasedFirstNuptials']);
            $data['deceasedSecondNuptials'] = cleanStr($data['deceasedSecondNuptials']);
            $data['deceasedNationality'] = cleanStr($data['deceasedNationality']);
            $data['deceasedNationalityName'] = cleanStr($data['deceasedNationalityName']);
            $data['deceasedNationalityProvince'] = cleanStr($data['deceasedNationalityProvince']);
            $data['deceasedNationalityLocation'] = cleanStr($data['deceasedNationalityLocation']);
            $data['deceasedBirthdayLocation'] = cleanStr($data['deceasedBirthdayLocation']);
            $data['deceasedLocality'] = cleanStr($data['deceasedLocality']);
            $data['deceasedProvince'] = cleanStr($data['deceasedProvince']);
            $data['deceasedUsualAddress'] = cleanStr($data['deceasedUsualAddress']);
            $data['deceasedLocation'] = cleanStr($data['deceasedLocation']);
            $data['otherDeceasedLocation'] = cleanStr($data['otherDeceasedLocation']);
            $data['deceasedMortuary'] = cleanStr($data['deceasedMortuary']);
            $data['startVelacionDate'] = cleanStr($data['startVelacionDate']);
            $data['startVelacionTime'] = cleanStr($data['startVelacionTime']);
            $data['endVelacionDate'] = cleanStr($data['endVelacionDate']);
            $data['endVelacionTime'] = cleanStr($data['endVelacionTime']);
            $data['startVelacionDate2'] = cleanStr($data['startVelacionDate2']);
            $data['startVelacionTime2'] = cleanStr($data['startVelacionTime2']);
            $data['endVelacionDate2'] = cleanStr($data['endVelacionDate2']);
            $data['endVelacionTime2'] = cleanStr($data['endVelacionTime2']);
            $data['deceasedPanel'] = cleanStr($data['deceasedPanel']);
            $data['deceasedMortuaryAddress'] = cleanStr($data['deceasedMortuaryAddress']);
            $data['deceasedDoctor'] = cleanStr($data['deceasedDoctor']);
            $data['deceasedDoctorCertificate'] = cleanStr($data['deceasedDoctorCertificate']);
            $data['deceasedCause'] = cleanStr($data['deceasedCause']);
            $data['deceasedTribunal'] = cleanStr($data['deceasedTribunal']);
            $data['deceasedTribunalNumber'] = cleanStr($data['deceasedTribunalNumber']);
            $data['church'] = cleanStr($data['church']);
            $data['cemetery'] = cleanStr($data['cemetery']);
            $data['niche'] = cleanStr($data['niche']);
            $data['funeralNicheNumber'] = cleanStr($data['funeralNicheNumber']);
            $data['funeralBusyNiche'] = cleanStr($data['funeralBusyNiche']);
            $data['regime'] = cleanStr($data['regime']);
            $data['propertyName'] = cleanStr($data['propertyName']);
            $data['exhumation'] = cleanStr($data['exhumation']);
            $data['nicheHeight'] = cleanStr($data['nicheHeight']);
            $data['deceasedNiche'] = cleanStr($data['deceasedNiche']);
            $data['deceasedNiche2'] = cleanStr($data['deceasedNiche2']);
            $data['deceasedNiche3'] = cleanStr($data['deceasedNiche3']);
            $data['mortuaryReg'] = cleanStr($data['mortuaryReg']);
            $data['funeralReg'] = cleanStr($data['funeralReg']);
            $data['personalReg'] = cleanStr($data['personalReg']);
            $data['crematoriumReg'] = cleanStr($data['crematoriumReg']);
            $data['tanatologicalPractice'] = cleanStr($data['tanatologicalPractice']);
            $data['funeralHome'] = cleanStr($data['funeralHome']);
            $data['coffin'] = cleanStr($data['coffin']);
            $data['responsibleNIF'] = cleanStr($data['responsibleNIF']);
            $data['crematorium'] = cleanStr($data['crematorium']);
            $data['crematoriumClient'] = cleanStr($data['crematoriumClient']);
            $data['crematoriumIntroduction'] = cleanStr($data['crematoriumIntroduction']);
            $data['crematoriumWaitOnRoom'] = cleanStr($data['crematoriumWaitOnRoom']);
            $data['crematoriumVaseBio'] = cleanStr($data['crematoriumVaseBio']);
            $data['moveFuneralHome'] = cleanStr($data['moveFuneralHome']);
            $data['moveClient'] = cleanStr($data['moveClient']);
            $data['moveCollection'] = cleanStr($data['moveCollection']);
            $data['moveDestination'] = cleanStr($data['moveDestination']);
            $data['moveVia'] = cleanStr($data['moveVia']);
            $data['moveJudicial'] = cleanStr($data['moveJudicial']);
            $data['moveTraslado'] = cleanStr($data['moveTraslado']);
            $data['moveDevolucion'] = cleanStr($data['moveDevolucion']);
            $data['moveNotes'] = cleanTextArea($data['moveNotes']);
            $data['lossNumber'] = cleanStr($data['lossNumber']);
            $data['internalRef'] = cleanStr($data['internalRef']);
            $data['coffin'] = cleanStr($data['coffin']);
            $data['ecologicCoffin'] = cleanStr($data['ecologicCoffin']);
            $data['authName'] = cleanStr($data['authName']);
            $data['authDni'] = cleanStr($data['authDni']);
            $data['authNifType'] = cleanStr($data['authNifType']);
            $data['otherCoffin'] = cleanStr($data['otherCoffin']);
            $data['churchLabel'] = cleanStr($data['churchLabel']);
            $data['cemeteryLabel'] = cleanStr($data['cemeteryLabel']);
            $data['authDate'] = cleanStr($data['authDate']);
            $data['authTime'] = cleanStr($data['authTime']);
            $data['authPlace'] = cleanStr($data['authPlace']);
            
            $data['smokeOpacityDateStart'] = cleanStr($data['smokeOpacityDateStart']);
            $data['smokeOpacityTimeStart'] = cleanStr($data['smokeOpacityTimeStart']);
            $data['smokeOpacityDateEnd'] = cleanStr($data['smokeOpacityDateEnd']);
            $data['smokeOpacityTimeEnd'] = cleanStr($data['smokeOpacityTimeEnd']);
            $data['smokeOpacityLoadWeight'] = cleanStr($data['smokeOpacityLoadWeight']);
            $data['smokeOpacityBacharachScale'] = cleanStr($data['smokeOpacityBacharachScale']);
            $data['smokeOpacityDateReading'] = cleanStr($data['smokeOpacityDateReading']);
            $data['smokeOpacityTimeReading'] = cleanStr($data['smokeOpacityTimeReading']);
            $data['smokeOpacityIncidents'] = cleanStr($data['smokeOpacityIncidents']);
            $data['smokeOpacityIncidentsNotes'] = cleanTextArea($data['smokeOpacityIncidentsNotes']);

            $data['crematoriumPacemaker'] = cleanStr($data['crematoriumPacemaker']);
            $data['crematoriumTechnical'] = cleanStr($data['crematoriumTechnical']);
            $data['moveContactPhone'] = cleanStr($data['moveContactPhone']);
            $data['moveContactPerson'] = cleanStr($data['moveContactPerson']);
            $data['moveDestinationAddress'] = cleanStr($data['moveDestinationAddress']);
            $data['moveCollectionAddress'] = cleanStr($data['moveCollectionAddress']);
            $data['moveFinalDestination'] = cleanStr($data['moveFinalDestination']);
            $data['crematoriumContactPhonePerson'] = cleanStr($data['crematoriumContactPhonePerson']);
            $data['authContactPhone'] = cleanStr($data['authContactPhone']);
            $data['crematoriumContactPerson'] = cleanStr($data['crematoriumContactPerson']);
            $data['flightNumber'] = cleanStr($data['flightNumber']);
            $data['airportOrigin'] = cleanStr($data['airportOrigin']);
            $data['departureDate'] = cleanStr($data['departureDate']);
            $data['departureTime'] = cleanStr($data['departureTime']);
            $data['arrivalAirport'] = cleanStr($data['arrivalAirport']);
            $data['arrivalDate'] = cleanStr($data['arrivalDate']);
            $data['arrivalTime'] = cleanStr($data['arrivalTime']);
            $data['agency'] = cleanStr($data['agency']);
            $data['agencyContact'] = cleanStr($data['agencyContact']);
            $data['agencyContactPhone'] = cleanStr($data['agencyContactPhone']);
            $data['otherCeremony'] = cleanStr($data['otherCeremony']);
            $data['otherInhumation'] = cleanStr($data['otherInhumation']);
            $data['crematoriumStatus'] = cleanStr($data['crematoriumStatus']);
            $data['crematoriumEntryDate'] = cleanStr($data['crematoriumEntryDate']);
            $data['crematoriumEntryTime'] = cleanStr($data['crematoriumEntryTime']);
            $data['crematoriumLeavingDate'] = cleanStr($data['crematoriumLeavingDate']);
            $data['crematoriumLeavingTime'] = cleanStr($data['crematoriumLeavingTime']);
            $data['covid'] = cleanStr($data['covid']);
            $data['trazabilityId'] = cleanStr($data['trazabilityId']);
            $data['funeralHomeService'] = cleanStr($data['funeralHomeService']);
            $data['familyAssistance'] = cleanStr($data['familyAssistance']);
            $data['carCollection1'] = cleanStr($data['carCollection1']);
            $data['carCollection1LicensePlate'] = cleanStr($data['carCollection1LicensePlate']);
            $data['carCollection1Brand'] = cleanStr($data['carCollection1Brand']);
            $data['carCollection1Model'] = cleanStr($data['carCollection1Model']);
            $data['corpseCollection1'] = cleanStr($data['corpseCollection1']);
            $data['corpseCollection2'] = cleanStr($data['corpseCollection2']);
            $data['carCollection2'] = cleanStr($data['carCollection2']);
            $data['staffTransfer1'] = cleanStr($data['staffTransfer1']);
            $data['staffTransfer2'] = cleanStr($data['staffTransfer2']);
            $data['hearse'] = cleanStr($data['hearse']);
            $data['hearseLicensePlate'] = cleanStr($data['hearseLicensePlate']);
            $data['hearseBrand'] = cleanStr($data['hearseBrand']);
            $data['hearseModel'] = cleanStr($data['hearseModel']);
            $data['placeDestinationMiddle'] = cleanStr($data['placeDestinationMiddle']);
            $data['placeDestinationFinal'] = cleanStr($data['placeDestinationFinal']);
            $data['placeDestinationFinalCemetery'] = cleanStr($data['placeDestinationFinalCemetery']);
            $data['notesExpedient'] = cleanTextArea($data['notesExpedient']);
            $data['mortuaryRegNotes'] = cleanTextArea($data['mortuaryRegNotes']);

            $data['refrigeratedChamberName'] = cleanStr($data['refrigeratedChamberName']);
            $data['refrigeratedChamberDateStart'] = cleanStr($data['refrigeratedChamberDateStart']);
            $data['refrigeratedChamberTimeStart'] = cleanStr($data['refrigeratedChamberTimeStart']);
            $data['refrigeratedChamberDateEnd'] = cleanStr($data['refrigeratedChamberDateEnd']);
            $data['refrigeratedChamberTimeEnd'] = cleanStr($data['refrigeratedChamberTimeEnd']);

            // Validación de campos
            if($data['expType'] == ''){
                return false;
            }
            if($data['applicantName'] == ''){
                return false;
            }

			if($data['applicantNIF'] != ''){
                if($data['applicantNifType'] != '3' && $data['applicantNifType'] != '4'){
                    if(!isValidIdNumber($data['applicantNIF'])){
                        return false;
                    }
                }
            }

            if($data['applicantMail'] != ''){
                if(!checkEmail($data['applicantMail'])){
                    return false;
                }
            }
            if($data['applicantPhone'] != ''){
                if(!checkPhone($data['applicantPhone'])){
                    return false;
                }
            }
            if($data['applicantMobilePhone'] != ''){
                if(!checkPhone($data['applicantMobilePhone'])){
                    return false;
                }
            }
            if($data['familyContactNIF'] != ''){
                if($data["familyContactNifType"] != '3' && $data["familyContactNifType"] != '4'){
                    if(!isValidIdNumber($data['familyContactNIF'])){
                        return false;
                    }
                }
            }
            if($data['familyContactMail'] != ''){
                if(!checkEmail($data['familyContactMail'])){
                    return false;
                }
            }
            if($data['familyContactPhone'] != ''){
                if(!checkPhone($data['familyContactPhone'])){
                    return false;
                }
            }
            if($data['familyContactMobilePhone'] != ''){
                if(!checkPhone($data['familyContactMobilePhone'])){
                    return false;
                }
            }
            if($data['deceasedNIF'] != ''){
                if($data['deceasedNifType'] != 3 &&  $data['deceasedNifType'] != 4){
                    if(!isValidIdNumber($data['deceasedNIF'])){
                        return false;
                    }
                }
            }
            if($data['responsibleNIF'] != ''){
                if($data["responsibleNIF"] != 3 && $data["responsibleNIF"] != 4){
                    if(!isValidIdNumber($data['responsibleNIF'])){
                        return false;
                    }
                }
            }

            if($data['authDni'] != ''){
                if($data["authNifType"] != 3 && $data["authNifType"] != 4){
                    if(!isValidIdNumber($data['authDni'])){
                        return false;
                    }
                }
            }
            if($data['moveContactPhone'] != ''){
                if(!checkPhone($data['moveContactPhone'])){
                    return false;
                }
            }
            if($data['authContactPhone'] != ''){
                if(!checkPhone($data['authContactPhone'])){
                    return false;
                }
            }

            if(empty($data['applicantLocation'])){
                $data['applicantLocation'] = 'null';
            }
            if(empty($data['familyContactLocation'])){
                $data['familyContactLocation'] = 'null';
            }
            if(empty($data['client'])){
                $data['client'] = 'null';
            }
            if(empty($data['deceasedBirthdayLocation'])){
                $data['deceasedBirthdayLocation'] = 'null';
            }
            if(empty($data['deceasedLocation']) && $data['deceasedLocation'] != "0"){
                $data['deceasedLocation'] = 'null';
            }
            if(empty($data['deceasedMortuary'])){
                $data['deceasedMortuary'] = 'null';
            }
            if(empty($data['deceasedDoctor'])){
                $data['deceasedDoctor'] = 'null';
            }
            if(empty($data['church'])){
                $data['church'] = 'null';
            }
            if(empty($data['cemetery'])){
                $data['cemetery'] = 'null';
            }
            if(empty($data['niche'])){
                $data['niche'] = 'null';
            }
            if(empty($data['funeralHome'])){
                $data['funeralHome'] = 'null';
            }
            if(empty($data['crematorium'])){
                $data['crematorium'] = 'null';
            }
            if(empty($data['crematoriumClient'])){
                $data['crematoriumClient'] = 'null';
            }
            if(empty($data['moveFuneralHome'])){
                $data['moveFuneralHome'] = 'null';
            }
            if(empty($data['moveClient'])){
                $data['moveClient'] = 'null';
            }
            if(empty($data['moveCollection'])){
                $data['moveCollection'] = 'null';
            }
            if(empty($data['moveDestination'])){
                $data['moveDestination'] = 'null';
            }
            if(empty($data['moveContactPhone'])){
                $data['moveContactPhone'] = 'null';
            }
            if(empty($data['moveContactPerson'])){
                $data['moveContactPerson'] = null;
            }
            if(empty($data['moveDestinationAddress'])){
                $data['moveDestinationAddress'] = null;
            }
            if(empty($data['moveCollectionAddress'])){
                $data['moveCollectionAddress'] = null;
            }
            if($data['moveFinalDestination'] == ''){
                $data['moveFinalDestination'] = null;
            }
            if(empty($data['responsibleUser'])){
                $data['responsibleUser'] = 'null';
            }
            if(empty($data['carOrigin'])){
                $data['carOrigin'] = 'null';
            }
            if(empty($data['placeDestinationMiddle'])){
                $data['placeDestinationMiddle'] = 'null';
            }
            if(empty($data['placeDestinationFinal'])){
                $data['placeDestinationFinal'] = 'null';
            }
            if(empty($data['placeDestinationFinalCemetery'])){
                $data['placeDestinationFinalCemetery'] = 'null';
            }
         
            if($data['deceasedBirthday'] == ""){
                $deceasedBirthday = 'deceasedBirthday = null, ';
            }else{
                $deceasedBirthday = 'deceasedBirthday = "' . $data['deceasedBirthday'] . '", ';
            }
            if($data['deceasedLocality'] == ''){
                $deceasedLocality = 'null';
            }else{
                $deceasedLocality = "'" . $data['deceasedLocality']. "'"; 
            }
            if($data['deceasedProvince'] == ''){
                $deceasedProvince = 'null';
            }else{
                $deceasedProvince = "'" . $data['deceasedProvince']. "'"; 
            }

            if($data['deceasedDate'] == ""){
                $deceasedDate = 'deceasedDate = null, ';
            }else{
                $deceasedDate = 'deceasedDate = "' . $data['deceasedDate'] . '", ';
            }

            if($data['deceasedTime'] == ""){
                $deceasedTime = 'deceasedTime = null, ';
            }else{
                $deceasedTime = 'deceasedTime = "' . $data['deceasedTime'] . '", ';
            }

            $deceasedRoom = $data['deceasedRoom'];

            if($data['funeralDate'] == ""){
                $funeralDate = 'funeralDate = null, ';
            }else{
                $funeralDate = 'funeralDate = "' . $data['funeralDate'] . '", ';
            }

            if($data['funeralTime'] == ""){
                $funeralTime = 'funeralTime = null, ';
            }else{
                $funeralTime = 'funeralTime = "' . $data['funeralTime'] . '", ';
            }

            if($data['ceremonyDate'] == ""){
                $ceremonyDate = 'ceremonyDate = null, ';
            }else{
                $ceremonyDate = 'ceremonyDate = "' . $data['ceremonyDate'] . '", ';
            }

            if($data['ceremonyTime'] == ""){
                $ceremonyTime = 'ceremonyTime = null, ';
            }else{
                $ceremonyTime = 'ceremonyTime = "' . $data['ceremonyTime'] . '", ';
            }

            if($data['funeralDateNew'] == ""){
                $funeralDateNew = 'funeralDateNew = null, ';
            }else{
                $funeralDateNew = 'funeralDateNew = "' . $data['funeralDateNew'] . '", ';
            }

            if($data['funeralTimeNew'] == ""){
                $funeralTimeNew = 'funeralTimeNew = null, ';
            }else{
                $funeralTimeNew = 'funeralTimeNew = "' . $data['funeralTimeNew'] . '", ';
            }

            if($data['funeralDateBurial'] == ""){
                $funeralDateBurial = 'funeralDateBurial = null, ';
            }else{
                $funeralDateBurial = 'funeralDateBurial = "' . $data['funeralDateBurial'] . '", ';
            }

            if($data['funeralTimeBurial'] == ""){
                $funeralTimeBurial = 'funeralTimeBurial = null, ';
            }else{
                $funeralTimeBurial = 'funeralTimeBurial = "' . $data['funeralTimeBurial'] . '", ';
            }

            if($data['otherDeceasedLocation'] == ""){
                $otherDeceasedLocation = 'otherDeceasedLocation = "' . 'null", ';
            }else{
                $otherDeceasedLocation = 'otherDeceasedLocation = "' . $data['otherDeceasedLocation'] . '", ';
            }

            if($data['funeralDateNiche'] == ""){
                $funeralDateNiche = 'funeralDateNiche = null, ';
            }else{
                $funeralDateNiche = 'funeralDateNiche = "' . $data['funeralDateNiche'] . '", ';
            }

            if($data['funeralDateNiche2'] == ""){
                $funeralDateNiche2 = 'funeralDateNiche2 = null, ';
            }else{
                $funeralDateNiche2 = 'funeralDateNiche2 = "' . $data['funeralDateNiche2'] . '", ';
            }

            if($data['funeralDateNiche3'] == ""){
                $funeralDateNiche3 = 'funeralDateNiche3 = null, ';
            }else{
                $funeralDateNiche3 = 'funeralDateNiche3 = "' . $data['funeralDateNiche3'] . '", ';
            }

            if($data['funeralHomeEntryDate'] == ""){
                $funeralHomeEntryDate = 'funeralHomeEntryDate = null, ';
            }else{
                $funeralHomeEntryDate = 'funeralHomeEntryDate = "' . $data['funeralHomeEntryDate'] . '", ';
            }

            if($data['funeralHomeEntryTime'] == ""){
                $funeralHomeEntryTime = 'funeralHomeEntryTime = null, ';
            }else{
                $funeralHomeEntryTime = 'funeralHomeEntryTime = "' . $data['funeralHomeEntryTime'] . '", ';
            }

            if($data['entryDateBarrow'] == ""){
                $entryDateBarrow = 'entryDateBarrow = null, ';
            }else{
                $entryDateBarrow = 'entryDateBarrow = "' . $data['entryDateBarrow'] . '", ';
            }

            if($data['entryTimeBarrow'] == ""){
                $entryTimeBarrow = 'entryTimeBarrow = null, ';
            }else{
                $entryTimeBarrow = 'entryTimeBarrow = "' . $data['entryTimeBarrow'] . '", ';
            }

            if($data['crematoriumArriveTime'] == ""){
                $crematoriumArriveTime = 'crematoriumArriveTime = null, ';
            }else{
                $crematoriumArriveTime = 'crematoriumArriveTime = "' . $data['crematoriumArriveTime'] . '", ';
            }

            if($data['crematoriumTechnical'] == ""){
                $data['crematoriumTechnical'] = 'null';
            }
            if($data['crematoriumContactPhonePerson'] == ""){
                $data['crematoriumContactPhonePerson'] = 'null';
            }
            
            if($data['authContactPhone'] == ""){
                $data['authContactPhone'] = 'null';
            }

            if($data['moveLeavingDate'] == ""){
                $moveLeavingDate = 'moveLeavingDate = null, ';
            }else{
                $moveLeavingDate = 'moveLeavingDate = "' . $data['moveLeavingDate'] . '", ';
            }

            if($data['moveLeavingTime'] == ""){
                $moveLeavingTime = 'moveLeavingTime = null, ';
            }else{
                $moveLeavingTime = 'moveLeavingTime = "' . $data['moveLeavingTime'] . '", ';
            }

            $data['nicheHeight'] = $data['nicheHeight'] == '' ? 'null' : $data['nicheHeight'];
            $data['regime'] = $data['regime'] == '' ? 'null' : $data['regime'];
            $data['moveVia'] = $data['moveVia'] == '' ? 'null' : $data['moveVia'];

            if($data['authDate'] == ''){
                $data['authDate'] = 'null';
            }
            if($data['authTime'] == ''){
                $data['authTime'] = 'null';
            }
            if($data['flightNumber'] == ''){
                $data['flightNumber'] = 'null';
            }
            if($data['airportOrigin'] == ''){
                $data['airportOrigin'] = 'null';
            }
            if($data['departureDate'] == ""){
                $departureDate = 'departureDate = null, ';
            }else{
                $departureDate = 'departureDate = "' . $data['departureDate'] . '", ';
            }
            if($data['departureTime'] == ''){
                $data['departureTime'] = 'null';
            }
            if($data['arrivalAirport'] == ''){
                $data['arrivalAirport'] = 'null';
            }
            if($data['arrivalDate'] == ""){
                $arrivalDate = 'arrivalDate = null, ';
            }else{
                $arrivalDate = 'arrivalDate = "' . $data['arrivalDate'] . '", ';
            }
            if($data['arrivalTime'] == ''){
                $data['arrivalTime'] = 'null';
            }
            if($data['agency'] == ''){
                $data['agency'] = 'null';
            }
            if($data['agencyContact'] == ''){
                $data['agencyContact'] = 'null';
            }
            if($data['agencyContactPhone'] == ''){
                $data['agencyContactPhone'] = 'null';
            }
            if($data['otherCeremony'] == ''){
                $data['otherCeremony'] = null;
            }
            if($data['otherInhumation'] == ''){
                $data['otherInhumation'] = null;
            }
            if($data['smokeOpacityDateStart'] == ''){
                $data['smokeOpacityDateStart'] = 'null';
            }
            if($data['smokeOpacityTimeStart'] == ''){
                $data['smokeOpacityTimeStart'] = 'null';
            }
            if($data['smokeOpacityDateEnd'] == ''){
                $data['smokeOpacityDateEnd'] = 'null';
            }
            if($data['smokeOpacityTimeEnd'] == ''){
                $data['smokeOpacityTimeEnd'] = 'null';
            }
            if($data['smokeOpacityDateReading'] == ''){
                $data['smokeOpacityDateReading'] = 'null';
            }
            if($data['smokeOpacityTimeReading'] == ''){
                $data['smokeOpacityTimeReading'] = 'null';
            }
            if($data['smokeOpacityLoadWeight'] == ''){
                $data['smokeOpacityLoadWeight'] = 'null';
            }
            if(empty($data['smokeOpacityBacharachScale'])){
                $data['smokeOpacityBacharachScale'] = 'null';
            }

            // Velacion 1
            if($data['startVelacionDate'] == ""){
                $startVelacionDate = 'startVelacionDate = null, ';
            }else{
                $startVelacionDate = 'startVelacionDate = "' . $data['startVelacionDate'] . '", ';
            }

            if($data['startVelacionTime'] == ""){
                $startVelacionTime = 'startVelacionTime = null, ';
            }else{
                $startVelacionTime = 'startVelacionTime = "' . $data['startVelacionTime'] . '", ';
            }

            if($data['endVelacionDate'] == ""){
                $endVelacionDate = 'endVelacionDate = null, ';
            }else{
                $endVelacionDate = 'endVelacionDate = "' . $data['endVelacionDate'] . '", ';
            }

            if($data['endVelacionTime'] == ""){
                $endVelacionTime = 'endVelacionTime = null, ';
            }else{
                $endVelacionTime = 'endVelacionTime = "' . $data['endVelacionTime'] . '", ';
            }

            // Velacion 2
            if($data['startVelacionDate2'] == ""){
                $startVelacionDate2 = 'startVelacionDate2 = null, ';
            }else{
                $startVelacionDate2 = 'startVelacionDate2 = "' . $data['startVelacionDate2'] . '", ';
            }

            if($data['startVelacionTime2'] == ""){
                $startVelacionTime2 = 'startVelacionTime2 = null, ';
            }else{
                $startVelacionTime2 = 'startVelacionTime2 = "' . $data['startVelacionTime2'] . '", ';
            }

            if($data['endVelacionDate2'] == ""){
                $endVelacionDate2 = 'endVelacionDate2 = null, ';
            }else{
                $endVelacionDate2 = 'endVelacionDate2 = "' . $data['endVelacionDate2'] . '", ';
            }

            if($data['endVelacionTime2'] == ""){
                $endVelacionTime2 = 'endVelacionTime2 = null, ';
            }else{
                $endVelacionTime2 = 'endVelacionTime2 = "' . $data['endVelacionTime2'] . '", ';
            }

            
            if($data['carCollection1LicensePlate'] == ''){
                $carCollection1LicensePlate = 'carCollection1LicensePlate = null, ';
            }else{
                $carCollection1LicensePlate = 'carCollection1LicensePlate = "' . $data['carCollection1LicensePlate'] . '", ';
            }
            if($data['carCollection1Brand'] == ''){
                $carCollection1Brand = 'carCollection1Brand = null, ';
            }else{
                $carCollection1Brand = 'carCollection1Brand = "' . $data['carCollection1Brand'] . '", ';
            }
            if($data['carCollection1Model'] == ''){
                $carCollection1Model = 'carCollection1Model = null, ';
            }else{
                $carCollection1Model = 'carCollection1Model = "' . $data['carCollection1Model'] . '", ';
            }
            
            if($data['hearse'] == ""){
                $hearse = 'hearse = null, ';
            }else{
                $hearse = 'hearse = ' . $data['hearse'] . ', ';
            }
            if($data['hearseLicensePlate'] == ''){
                $hearseLicensePlate = 'hearseLicensePlate = null, ';
            }else{
                $hearseLicensePlate = 'hearseLicensePlate = "' . $data['hearseLicensePlate'] . '", ';
            }
            if($data['hearseBrand'] == ''){
                $hearseBrand = 'hearseBrand = null, ';
            }else{
                $hearseBrand = 'hearseBrand = "' . $data['hearseBrand'] . '", ';
            }
            if($data['hearseModel'] == ''){
                $hearseModel = 'hearseModel = null, ';
            }else{
                $hearseModel = 'hearseModel = "' . $data['hearseModel'] . '", ';
            }
            if($data['mortuaryRegNotes'] == ''){
                $mortuaryRegNotes = 'mortuaryRegNotes = null, ';
            }else{
                $mortuaryRegNotes = 'mortuaryRegNotes = "' . $data['mortuaryRegNotes'] . '", ';
            }

            if($data['refrigeratedChamberName'] == ""){
                $refrigeratedChamberName = 'refrigeratedChamberName = null, ';
            }else{
                $refrigeratedChamberName = 'refrigeratedChamberName = "' . $data['refrigeratedChamberName'] . '", ';
            }
            if($data['refrigeratedChamberDateStart'] == ""){
                $refrigeratedChamberDateStart = 'refrigeratedChamberDateStart = null, ';
            }else{
                $refrigeratedChamberDateStart = 'refrigeratedChamberDateStart = "' . $data['refrigeratedChamberDateStart'] . '", ';
            }
            if($data['refrigeratedChamberTimeStart'] == ""){
                $refrigeratedChamberTimeStart = 'refrigeratedChamberTimeStart = null, ';
            }else{
                $refrigeratedChamberTimeStart = 'refrigeratedChamberTimeStart = "' . $data['refrigeratedChamberTimeStart'] . '", ';
            }
            if($data['refrigeratedChamberDateEnd'] == ""){
                $refrigeratedChamberDateEnd = 'refrigeratedChamberDateEnd = null, ';
            }else{
                $refrigeratedChamberDateEnd = 'refrigeratedChamberDateEnd = "' . $data['refrigeratedChamberDateEnd'] . '", ';
            }
            if($data['refrigeratedChamberTimeEnd'] == ""){
                $refrigeratedChamberTimeEnd = 'refrigeratedChamberTimeEnd = null, ';
            }else{
                $refrigeratedChamberTimeEnd = 'refrigeratedChamberTimeEnd = "' . $data['refrigeratedChamberTimeEnd'] . '", ';
            }
    
            //Obtener datos del expediente editado antes de realizar la edicion
            $result = $db->query("  SELECT  requestDate, number, expNumLetter, expNumSecuence, expNumYear, expNumType, clientType, client,
                                            deceasedMortuary, funeralDate, funeralTime, funeralHomeEntryDate, funeralHomeEntryTime, startVelacionDate, startVelacionTime
                                    FROM    Expedients 
                                    WHERE   leavingDate IS NULL AND expedientID =" . $data['expedientID']);

            if(mysqli_num_rows($result) > 0){
                $resultSQL = $db->resultToArray($result);
                $createYear = explode('-', $resultSQL[0]['requestDate'])[0];
                $numberExp = $resultSQL[0]['number'];
                $expNumLetter = $resultSQL[0]['expNumLetter'] ;
                $expNumSec = $resultSQL[0]['expNumSecuence'] ;
                $expNumYear = $resultSQL[0]['expNumYear'] ;
                $expNumType = $resultSQL[0]['expNumType'] ;
                $clientType = $resultSQL[0]['clientType'] ;
                $clientOld = $resultSQL[0]['client'] ;
                $currentFuneralDate = $resultSQL[0]['funeralDate'];
                $currentFuneralTime = $resultSQL[0]['funeralTime'] == null ? null : substr($resultSQL[0]['funeralTime'], 0, -3);
                $currentFuneralHomeEntryDate = $resultSQL[0]['funeralHomeEntryDate'];
                $currentFuneralHomeEntryTime = $resultSQL[0]['funeralHomeEntryTime'] == null ? null : substr($resultSQL[0]['funeralHomeEntryTime'], 0, -3);
                $currentStartVelacionDate = $resultSQL[0]['startVelacionDate'];
                $currentStartVelacionTime = $resultSQL[0]['startVelacionTime'] == null ? null : substr($resultSQL[0]['startVelacionTime'], 0, -3);
            }else{
                $expNumSec = null;
                $expNumYear = null;
                $expNumType = null;
                $clientOld = null;
                $createYear = date('Y');
            }   

            // SI SE MODIFICA El TIPO DE CLIENTE CAMBIA EL NÚMERO DEL EXPEDIENTE SOLO PARA DEFUNCION      
            if($data['clientType'] != $clientType){
                
                if($data['expType'] == '1'){  //DEFUNCION                     
                    
                    switch ($data['clientType']) {
                        case '1': //PARTICULARES                       
                            
                            $expNumLetter = 'P';

                            //Calcular el numero de secuencia del expediente para Particulares
                            $result = $db->query("  SELECT  COUNT(expedientID) as total 
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = 1 AND type = 1 AND
                                                            expedientID < " . $data['expedientID']." AND
                                                            entryDate >= '$expNumYear-01-01' AND 
                                                            entryDate <= '$expNumYear-12-31'");

                            if(mysqli_num_rows($result) > 0){
                                $expNumType = $db->resultToArray($result)[0]['total'] + 1;
                            }else{
                                $expNumType = 1;
                            }

                            $numberYear =substr($expNumYear,-2);
                            $numberExp = $expNumSec . ' ' . $expNumLetter . $expNumType . '/' . $numberYear;
                           
                            //ACTUALIZAR EL RESTO DE PARTICULARES, Seleccionar los que son posteriores al editado
                            $res = $db->query(" SELECT  expedientID, number, expNumLetter, expNumSecuence, expNumYear, expNumType
                                                FROM    Expedients 
                                                WHERE   leavingDate IS NULL AND
                                                        clientType = 1 AND type = 1 AND
                                                        expedientID > " . $data['expedientID']." AND
                                                        entryDate >= '$expNumYear-01-01' AND 
                                                        entryDate <= '$expNumYear-12-31'" );

                            if(mysqli_num_rows($res) > 0){
                                $postExpedients = $db->resultToArray($res);
                                foreach($postExpedients as $expedientPost){                                 
                                    $newTypeNumber = intVal($expedientPost['expNumType']) + 1; //Aumentar el numero de particulares                                    
                                    $newNumSec = intVal($expedientPost['expNumSecuence']); //Aumentar el numero de secuencia
                                    $numberYear = substr($expedientPost['expNumYear'], -2);
                                    $newNumberExpedient = $newNumSec . ' ' . $expedientPost['expNumLetter'] . $newTypeNumber . '/' . $numberYear;
                                    
                                    //Actualizar expedientes
                                    $db->query("    UPDATE  Expedients
                                                    SET     number =  '$newNumberExpedient', 
                                                            expNumType = $newTypeNumber
                                                    WHERE   expedientID = ".$expedientPost['expedientID']);
                                }
                            }

                            //ACTUALIZAR EL RESTO del tipo de cliente antiguo: SEGURO O EMPRESA
                            $res1 = $db->query("    SELECT  expedientID, number, expNumLetter, expNumSecuence, expNumYear, expNumType
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = $clientType AND type = 1 AND
                                                            expedientID > " . $data['expedientID']." AND
                                                            entryDate >= '$expNumYear-01-01' AND 
                                                            entryDate <= '$expNumYear-12-31'");

                            if(mysqli_num_rows($res1) > 0){
                                $postExpedients1 = $db->resultToArray($res1);
                                foreach($postExpedients1 as $expedientPost){ 
                                    $newNumSec = intVal($expedientPost['expNumSecuence']) ; //Disminuir el numero de secuencia      
                                    $numberYear = substr($expedientPost['expNumYear'], -2);
                                    $newTypeNumber  = intVal($expedientPost['expNumType']) - 1;      
                                    // $newNumberExpedient = $expedientPost['expNumLetter'] .'-'. $newNumSec .'/'.$numberYear.' '.$newTypeNumber; //Nuevo numero;
                                    $newNumberExpedient = $newNumSec . ' ' . $expedientPost['expNumLetter'] . $newTypeNumber . '/' . $numberYear;
                                    
                                    //Actualizar expediente
                                    $db->query("    UPDATE  Expedients
                                                    SET     number =  '$newNumberExpedient', 
                                                            expNumType = $newTypeNumber
                                                    WHERE   expedientID = ".$expedientPost['expedientID']);
                                }
                            }
                        break;

                        case '2': //SEGUROS  
                        
                            $expNumLetter = 'S';

                            //Calcular el numero de secuencia del expediente para Seguros
                            $result = $db->query("  SELECT  COUNT(expedientID) as total 
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = 2 AND type = 1 AND
                                                            expedientID < " . $data['expedientID']." AND
                                                            entryDate >= '$expNumYear-01-01' AND 
                                                            entryDate <= '$expNumYear-12-31'");

                            if(mysqli_num_rows($result) > 0){
                                $expNumType = $db->resultToArray($result)[0]['total'] + 1;
                            }else{
                                $expNumType = 1;
                            }

                            $numberYear =substr($expNumYear,-2);
                            $numberExp = $expNumSec . ' ' . $expNumLetter . $expNumType . '/' . $numberYear;
                            
                            //ACTUALIZAR EL RESTO DE PARTICULARES, Seleccionar los que son posteriores al editado
                            $res = $db->query("     SELECT  expedientID, number, expNumLetter, expNumSecuence, expNumYear, expNumType
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = 2 AND type = 1 AND
                                                            expedientID > " . $data['expedientID']." AND
                                                            entryDate >= '$expNumYear-01-01' AND 
                                                            entryDate <= '$expNumYear-12-31'" );

                            if(mysqli_num_rows($res) > 0){
                                $postExpedients = $db->resultToArray($res);
                                foreach($postExpedients as $expedientPost){                                    
                                    $newTypeNumber = intVal($expedientPost['expNumType']) + 1; //Aumentar el numero de particulares                                    
                                    $newNumSec = intVal($expedientPost['expNumSecuence']); //Aumentar el numero de secuencia
                                    $numberYear = substr($expedientPost['expNumYear'], -2);
                                    $newNumberExpedient = $newNumSec . ' ' . $expedientPost['expNumLetter'] . $newTypeNumber . '/' . $numberYear;

                                    //Actualizar expedientes
                                   $db->query("     UPDATE  Expedients
                                                    SET     number =  '$newNumberExpedient', expNumType = $newTypeNumber
                                                    WHERE   expedientID = ".$expedientPost['expedientID']);
                                }
                            }

                            //ACTUALIZAR EL RESTO del tipo de cliente antiguo: SEGURO O EMPRESA
                            $res1 = $db->query("    SELECT  expedientID, number, expNumLetter, expNumSecuence, expNumYear, expNumType
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = $clientType AND type = 1 AND
                                                            expedientID > " . $data['expedientID']." AND
                                                            entryDate >= '$expNumYear-01-01' AND 
                                                            entryDate <= '$expNumYear-12-31'");

                            if(mysqli_num_rows($res1) > 0){

                                $postExpedients1 = $db->resultToArray($res1);

                                foreach($postExpedients1 as $expedientPost){ 
                                    $newNumSec = intVal($expedientPost['expNumSecuence']); //Disminuir el numero de secuencia      
                                    $numberYear = substr($expedientPost['expNumYear'], -2);
                                    $newTypeNumber  = intVal($expedientPost['expNumType']) - 1;      
                                    $newNumberExpedient = $newNumSec . ' ' . $expedientPost['expNumLetter'] . $newTypeNumber . '/' . $numberYear;

                                    //Actualizar expediente
                                    $db->query("    UPDATE  Expedients
                                                    SET     number =  '$newNumberExpedient', 
                                                            expNumType = $newTypeNumber
                                                    WHERE   expedientID = ".$expedientPost['expedientID']);
                                }
                            }
                        break;

                        case '3': //EMPRESAS
                            $expNumLetter = 'E'; 
                            
                            //Calcular el numero de secuencia del expediente para Particulares
                            $result = $db->query("  SELECT  COUNT(expedientID) as total 
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = 3 AND type = 1 AND
                                                            expedientID < " . $data['expedientID']." AND
                                                            entryDate >= '$expNumYear-01-01' AND 
                                                            entryDate <= '$expNumYear-12-31'");

                            if(mysqli_num_rows($result) > 0){
                                $expNumType = $db->resultToArray($result)[0]['total'] + 1;
                            }else{
                                $expNumType = 1;
                                $expNumSec = 1;
                            }

                            $numberYear =substr($expNumYear,-2);
                            $numberExp = $expNumSec . ' ' . $expNumLetter . $expNumType . '/' . $numberYear;
                           
                            //ACTUALIZAR EL RESTO DE PARTICULARES, Seleccionar los que son posteriores al editado
                            $res = $db->query("     SELECT  expedientID, number, expNumLetter, expNumSecuence, expNumYear, expNumType
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = 3 AND type = 1 AND
                                                            expedientID > " . $data['expedientID']." AND
                                                            entryDate >= '$expNumYear-01-01' AND 
                                                            entryDate <= '$expNumYear-12-31'" );

                            if(mysqli_num_rows($res) > 0){
                                $postExpedients = $db->resultToArray($res);
                                foreach($postExpedients as $expedientPost){          
                                    $newTypeNumber = intVal($expedientPost['expNumType']) + 1; //Aumentar el numero de particulares                                    
                                    $newNumSec = intVal($expedientPost['expNumSecuence']); //Aumentar el numero de secuencia
                                    $numberYear = substr($expedientPost['expNumYear'], -2);
                                    $newNumberExpedient = $newNumSec . ' ' . $expedientPost['expNumLetter'] . $newTypeNumber . '/' . $numberYear;

                                    //Actualizar expedientes
                                    $db->query("    UPDATE  Expedients
                                                    SET     number =  '$newNumberExpedient', 
                                                            expNumType = $newTypeNumber
                                                    WHERE   expedientID = ".$expedientPost['expedientID']);
                                }
                            }

                            //ACTUALIZAR EL RESTO del tipo de cliente antiguo: SEGURO O EMPRESA
                            $res1 = $db->query("  SELECT  expedientID, number, expNumLetter, expNumSecuence, expNumYear, expNumType
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = $clientType AND type = 1 AND
                                                            expedientID > " . $data['expedientID']." AND
                                                            entryDate >= '$expNumYear-01-01' AND 
                                                            entryDate <= '$expNumYear-12-31'");

                            if(mysqli_num_rows($res1) > 0){
                                $postExpedients1 = $db->resultToArray($res1);
                                foreach($postExpedients1 as $expedientPost){ 
                                    $newNumSec = intVal($expedientPost['expNumSecuence']); //Disminuir el numero de secuencia      
                                    $numberYear = substr($expedientPost['expNumYear'], -2);
                                    $newTypeNumber  = intVal($expedientPost['expNumType']) - 1;      
                                    $newNumberExpedient = $newNumSec . ' ' . $expedientPost['expNumLetter'] . $newTypeNumber . '/' . $numberYear;

                                    //Actualizar expediente
                                    $db->query("    UPDATE  Expedients
                                                    SET     number =  '$newNumberExpedient', 
                                                            expNumType = $newTypeNumber
                                                    WHERE   expedientID = ".$expedientPost['expedientID']);
                                }
                            }
                        break;
                    }
                } 
            }

            //CHANGES THE PRICE ASSOCIATED WITH THE EXPEDIENTES IF THE CLIENT CHANGES
            $updatePriceExpHiring = false;
            if($data['client'] != null && $data['client'] != '' && $data['client'] != $clientOld){
                $result = $db->query("  SELECT   p.name
                                        FROM     Clients c, Prices p
                                        WHERE    c.clientID = {$data['client']} 
                                            AND  p.leavingDate IS NULL
                                            AND  p.priceID = c.price");
                                        
                if(mysqli_num_rows($result) > 0){
                    $priceName = $db->resultToArray($result)[0]['name'];

                    $result = $db->query("  SELECT   p.priceID
                                            FROM     Prices p
                                            WHERE    p.name = '$priceName' 
                                                AND  p.leavingDate IS NULL
                                                AND  p.year = $createYear");

                    if(mysqli_num_rows($result) > 0){
                        $priceClient = $db->resultToArray($result)[0]['priceID'];
                    }else{
                        $result = $db->query("  SELECT   c.price
                                                FROM     Clients c
                                                WHERE    c.clientID = {$data['client']}");
                                            
                        if(mysqli_num_rows($result) > 0){
                            $priceClient = $db->resultToArray($result)[0]['price'];
                        }else{
                            $priceClient = 'null';
                        }
                    }
                }else{
                    $priceClient = 'null';
                }
            }else{
                $priceClient = 'null'; 
            }

            $priceClientUpdate = '';
            if($priceClient != 'null'){
                $priceClientUpdate = 'priceExp = '. $priceClient .',';
                $updatePriceExpHiring = true;
            }

            // Get next trazability ID
            if($data['cremation'] === 'true' && ($data['trazabilityId'] == null || $data['trazabilityId'] == '')){

                $result = $db->query("  SELECT  MAX(e.trazabilityId) as max_id_trazability 
                                        FROM    Expedients e
                                        WHERE   e.leavingDate IS NULL AND
                                                e.cremation = 1  AND 
                                                e.trazabilityId != 'false' AND 
                                                e.trazabilityId != '' AND
                                                e.expedientID != " . $data['expedientID']);
                if(mysqli_num_rows($result) > 0){
                    $data['trazabilityId'] = intval($db->resultToArray($result)[0]['max_id_trazability']) + 1;
                }else{
                    $data['trazabilityId'] = 1;
                }
            }

            $expedient = $db->query("   UPDATE  Expedients
                                        SET     number = '$numberExp', requestTime = '" . $data['requestTime'] . "', requestDate = '" . $data['requestDate'] . "', 
                                                clientType = " . $data['clientType'] . ", policy = '" . $data['policy'] . "', 
                                                capital = '" . $data['capital'] . "', move = " . $data['move'] . ", status = " . $data['status'] . ", 
                                                room = " . $data['room'] . ", cremation = " . $data['cremation'] . ", literal = " . $data['literal'] . ", 
                                                applicantName = '" . $data['applicantName'] . "', applicantSurname = '" . $data['applicantSurname'] . "', 
                                                applicantNIF = '" . $data['applicantNIF'] . "', 
                                                applicantAddress = '" . $data['applicantAddress'] . "', applicantLocation = " . $data['applicantLocation'] . ", 
                                                applicantMail = '" . $data['applicantMail'] . "', applicantPhone = '" . $data['applicantPhone'] . "', 
                                                applicantMobilePhone = '" . $data['applicantMobilePhone'] . "', 
                                                familyContactName = '" . $data['familyContactName'] . "', familyContactSurname = '" . $data['familyContactSurname'] . "',
                                                familyContactRelationship = '" . $data['familyContactRelationship'] . "', 
                                                familyContactNIF = '" . $data['familyContactNIF'] . "', familyContactAddress = '" . $data['familyContactAddress'] . "', 
                                                familyContactLocation = " . $data['familyContactLocation'] . ", familyContactMail = '" . $data['familyContactMail'] . "', 
                                                familyContactPhone = '" . $data['familyContactPhone'] . "', familyContactMobilePhone = '" . $data['familyContactMobilePhone'] . "',
                                                familyContactNationality = " . $data['familyContactNationality'] . " , familyContactOtherCountry = '" . $data['familyContactOtherCountry'] . "',
                                                familyContactOtherProvince = '" . $data['familyContactOtherProvince'] . "', familyContactOtherLocation = '" . $data['familyContactOtherLocation'] . "',
                                                otherContactName = '" .  $data['otherContactName'] . "', otherContactPhone = '" . $data['otherContactPhone'] . "',
                                                otherContactRelationship = '" . $data['otherContactRelationship'] . "', client = " . $data['client'] . ", 
                                                deceasedName = '" . $data['deceasedName'] . "', deceasedSurname = '" . $data['deceasedSurname'] . "', 
                                                deceasedNIF = '" . $data['deceasedNIF'] . "', deceasedGender = '" . $data['deceasedGender'] . "', 
                                                deceasedMaritalStatus = '" . $data['deceasedMaritalStatus'] . "', deceasedMaritalStatusDescription = '" . $data['deceasedMaritalStatusDescription'] . "', deceasedChildOfFather = '" . $data['deceasedChildOfFather'] . "', 
                                                deceasedChildOfMother = '" . $data['deceasedChildOfMother'] . "', deceasedFirstNuptials = '" . $data['deceasedFirstNuptials'] . "', 
                                                deceasedSecondNuptials = '" . $data['deceasedSecondNuptials'] . "', deceasedNationality = '" . $data['deceasedNationality'] . "', 
                                                deceasedNationalityName = '" . $data['deceasedNationalityName'] . "', deceasedNationalityProvince = '" . $data['deceasedNationalityProvince'] . "',
                                                deceasedNationalityLocation = '" . $data['deceasedNationalityLocation'] . "',
                                                $deceasedBirthday deceasedBirthdayLocation = " . $data['deceasedBirthdayLocation'] . ", 
                                                deceasedUsualAddress = '" . $data['deceasedUsualAddress'] . "', 
                                                deceasedLocation = " . $data['deceasedLocation'] . ", $deceasedDate $otherDeceasedLocation
                                                $deceasedTime deceasedMortuary = " . $data['deceasedMortuary'] . ", 
                                                deceasedRoom = '$deceasedRoom', deceasedPanel = " . $data['deceasedPanel'] . ",
                                                deceasedMortuaryAddress = '" . $data['deceasedMortuaryAddress'] . "',
                                                deceasedDoctor = " . $data['deceasedDoctor'] . ", deceasedDoctorCertificate = '" . $data['deceasedDoctorCertificate'] . "', deceasedCause = '" . $data['deceasedCause'] . "', 
                                                deceasedTribunal = '" . $data['deceasedTribunal'] . "', deceasedTribunalNumber = '" . $data['deceasedTribunalNumber'] . "', 
                                                church = " . $data['church'] . ", cemetery = " . $data['cemetery'] . ", $funeralDate
                                                $funeralTime $ceremonyDate $ceremonyTime $funeralDateNew $funeralTimeNew $funeralDateBurial $funeralTimeBurial niche = " . $data['niche'] . ", funeralNicheNumber = '" . $data['funeralNicheNumber'] . "', 
                                                funeralBusyNiche = " . $data['funeralBusyNiche'] . ", regime = " . $data['regime'] . ", propertyName = '" . $data['propertyName'] . "', exhumation = '" . $data['exhumation'] . "', 
                                                nicheHeight = " . $data['nicheHeight'] . ", $funeralDateNiche $funeralDateNiche2 $funeralDateNiche3 deceasedNiche = '" . $data['deceasedNiche'] . "', deceasedNiche2 = '" . $data['deceasedNiche2'] . "', deceasedNiche3 = '" . $data['deceasedNiche3'] . "',
                                                mortuaryReg = " . $data['mortuaryReg'] . ", funeralReg = " . $data['funeralReg'] . ", personalReg = " . $data['personalReg'] . ", crematoriumReg = " . $data['crematoriumReg'] . ",
                                                tanatologicalPractice = " . $data['tanatologicalPractice'] . ", funeralHome = " . $data['funeralHome'] . ", $funeralHomeEntryDate $funeralHomeEntryTime $entryDateBarrow $entryTimeBarrow 
                                                $refrigeratedChamberName $refrigeratedChamberDateStart $refrigeratedChamberTimeStart $refrigeratedChamberDateEnd $refrigeratedChamberTimeEnd
                                                coffin = " . $data['coffin'] . ", responsibleUser = " . $data['responsibleUser'] . ", responsibleName = '" . $data['responsibleName'] . "', 
                                                responsibleNIF = '" . $data['responsibleNIF'] . "', crematorium = " . $data['crematorium'] . ", crematoriumClient = " . $data['crematoriumClient'] . ",
                                                $crematoriumArriveTime crematoriumIntroduction = " . $data['crematoriumIntroduction'] . ", 
                                                crematoriumWaitOnRoom = " . $data['crematoriumWaitOnRoom'] . ", crematoriumVaseBio = " . $data['crematoriumVaseBio'] . ",
                                                moveFuneralHome = " . $data['moveFuneralHome'] . ", $moveLeavingDate $moveLeavingTime moveClient = " . $data['moveClient'] . ",
                                                moveCollection = " . $data['moveCollection'] . ", moveDestination = " . $data['moveDestination'] . ", moveVia = " . $data['moveVia'] . ",
                                                moveJudicial = " . $data['moveJudicial'] . ", moveTraslado = " . $data['moveTraslado'] . ", moveDevolucion = " . $data['moveDevolucion'] . ",
                                                moveNotes = '" . $data['moveNotes'] . "', lossNumber = '" . $data['lossNumber'] . "', internalRef = '" . $data['internalRef'] . "',
                                                coffin = " . $data['coffin'] . ", ecologicCoffin = " . $data['ecologicCoffin'] . ", authName = '" . $data['authName'] . "', authDni = '" . $data['authDni'] . "',
                                                otherCoffin = '" . $data['otherCoffin'] . "', churchLabel = '" . $data['churchLabel'] . "', cemeteryLabel = '" . $data['cemeteryLabel'] . "',
                                                authDate = " . $data['authDate'] . ", authTime = " . $data['authTime'] . ", authPlace = '" . $data['authPlace'] . "',
                                                smokeOpacityDateStart = " . $data['smokeOpacityDateStart'] . ", smokeOpacityTimeStart = " . $data['smokeOpacityTimeStart'] . ",
                                                smokeOpacityDateEnd = " . $data['smokeOpacityDateEnd'] . ", smokeOpacityTimeEnd = " . $data['smokeOpacityTimeEnd'] . ",
                                                smokeOpacityLoadWeight = " . $data['smokeOpacityLoadWeight'] . ", smokeOpacityBacharachScale = " . $data['smokeOpacityBacharachScale'] . ",
                                                smokeOpacityDateReading = " . $data['smokeOpacityDateReading'] . ", smokeOpacityTimeReading = " . $data['smokeOpacityTimeReading'] . ",
                                                smokeOpacityIncidents = " . $data['smokeOpacityIncidents'] . ", smokeOpacityIncidentsNotes = '" . $data['smokeOpacityIncidentsNotes'] . "',
                                                crematoriumPacemaker = " . $data['crematoriumPacemaker'] . ", crematoriumTechnical = " . $data['crematoriumTechnical'] . ",
                                                moveContactPhone = ".$data['moveContactPhone'].", moveContactPerson = '".$data['moveContactPerson']."', 
                                                moveDestinationAddress = '".$data['moveDestinationAddress']."', moveCollectionAddress = '".$data['moveCollectionAddress']."',
                                                moveFinalDestination = '".$data['moveFinalDestination']."',
                                                crematoriumContactPhonePerson = ".$data['crematoriumContactPhonePerson'].",
                                                authContactPhone = ".$data['authContactPhone'].",
                                                crematoriumContactPerson = '".$data['crematoriumContactPerson']."',
                                                flightNumber =  '".$data['flightNumber']."', airportOrigin =  '".$data['airportOrigin']."', $departureDate departureTime =  ".$data['departureTime'].", 
                                                arrivalAirport =  '".$data['arrivalAirport']."', $arrivalDate arrivalTime =  ".$data['arrivalTime'].",
                                                agency =  '".$data['agency']."', agencyContact =  '".$data['agencyContact']."', agencyContactPhone =  '".$data['agencyContactPhone']."',
                                                otherCeremony =  '".$data['otherCeremony']."', otherInhumation =  '".$data['otherInhumation']."',
                                                expNumLetter =  '$expNumLetter',
                                                expNumYear =  $expNumYear, expNumType =  $expNumType,
                                                applicantNifType = " . $data['applicantNifType'] . ",
                                                familyContactNifType = " . $data['familyContactNifType'] . ",
                                                deceasedNifType = " . $data['deceasedNifType'] . ",
                                                covid = " . $data['covid'] . ",
                                                deceasedLocality = " . $deceasedLocality . ",
                                                deceasedProvince = " . $deceasedProvince . ",
                                                trazabilityId = '" . $data['trazabilityId'] . "',
                                                $startVelacionDate
                                                $startVelacionTime
                                                $endVelacionDate
                                                $endVelacionTime
                                                $startVelacionDate2
                                                $startVelacionTime2
                                                $endVelacionDate2
                                                $endVelacionTime2
                                                $priceClientUpdate
                                                $carCollection1LicensePlate
                                                $carCollection1Brand
                                                $carCollection1Model
                                                $hearse
                                                $hearseLicensePlate
                                                $hearseBrand
                                                $hearseModel
                                                $mortuaryRegNotes
                                                placeDestinationMiddle = " . $data['placeDestinationMiddle'] . ",
                                                placeDestinationFinal = " . $data['placeDestinationFinal'] . ",
                                                placeDestinationFinalCemetery = " . $data['placeDestinationFinalCemetery'] . ",
                                                authDniType = " . $data['authNifType'] . ",
                                                notesExpedient = '" . $data['notesExpedient'] . "',
                                                tellmebyeRoom = '" . $data['tellmebyeRoom'] . "',
                                                tellmebyeRoomName = '" . $data['tellmebyeRoomName'] . "'
                                    WHERE       expedientID = " . $data['expedientID']
            );

            if($expedient){
                // Actualiza el registro civil de los literales del control de servicio
                $result = $db->query("  SELECT  es.literalReceived
                                        FROM    Expedients_Services es
                                        WHERE   es.expedient = ". $data['expedientID']);

                $literalReceived = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['literalReceived'];
                if($literalReceived != '1' && $literalReceived != 1){
                    $db->query("UPDATE  Expedients_Services
                                SET     literalCivilRegister = '" . $data['deceasedTribunal'] . "'
                                WHERE   expedient = " . $data['expedientID']);
                }

                //Actualizar hora de llegada
                if($data['arriveTime'] == ''){
                   $consulta = "arriveTime = null,"; 
                }else{
                    $consulta = "arriveTime = '" . $data['arriveTime'] . "',";
                }
                if($data['arriveDate'] == ''){
                    $consulta .= "arriveDate = null,"; 
                 }else{
                    $consulta .= "arriveDate = '" . $data['arriveDate'] . "',";
                 }

                $consulta .= "
                    funeralHomeService = " . $data['funeralHomeService'] . ",
                    familyAssistance = " . $data['familyAssistance'] . ", 
                    carCollection = " . $data['carCollection1'] . ",
                    corpseCollection1 = " . $data['corpseCollection1'] . ", 
                    corpseCollection2 = " . $data['corpseCollection2'] . ",

                    carCollection2 = " . $data['carCollection2'] . ",
                    staffTransfer1 = " . $data['staffTransfer1'] . ", 
                    staffTransfer2 = " . $data['staffTransfer2'] . "
                ";

                $db->query("UPDATE  Expedients_Services 
                            SET     $consulta
                            WHERE   expedient = " . $data['expedientID'] . "");

                if($data['cremation'] != "false"){
                    $eventCremation = $db->query("SELECT e.crematoriumEvent AS ID, e.number FROM Expedients e WHERE e.expedientID = " . $data['expedientID']);
                    if(mysqli_num_rows($eventCremation) > 0){
                        $eventCremation = $db->resultToArray($eventCremation)[0];
                        if($eventCremation['ID'] == null){
                            $events = new Events();
                            $toEvent = array(   "status" => $data['crematoriumStatus'], 
                                                "name" => 'Cremación Exp. ' . $eventCremation['number'],
                                                "cleaningType" => "null",
                                                "cleaningMortuary" => "null",
                                                "cleaningUser" => "null",
                                                "type" => 1,
                                                "start" => $data['crematoriumEntryDate'] . " " . $data['crematoriumEntryTime'],
                                                "end" => $data['crematoriumLeavingDate'] . " " . $data['crematoriumLeavingTime'],
                                                "regularity" => "null",
                                                "allDay" => 0,
                                                "reminder" => 1, 
                                                "cremation" => 1,
                                                "expedient" => $data['expedientID'],
                                                "allDay" => 0
                            );

                            $event = $events->create($toEvent);

                            if($event[0]){
                                $result = $db->query("  SELECT  ID 
                                                        FROM    Events 
                                                        WHERE   extraID = '" . $event[1] . "'");

                                $eventID = $db->resultToArray($result)[0]['ID'];

                                $db->query("UPDATE  Expedients 
                                            SET     crematoriumEvent = " . $eventID . " 
                                            WHERE   expedientID = " . $data['expedientID'] . "");
                            }
                        }else{
                            $db->query("UPDATE Events e SET e.leavingDate = NULL WHERE e.ID = " . $eventCremation['ID']);
                            $events = new Events();
                            $toEvent = array(   "status" => $data['crematoriumStatus'], 
                                                "name" => 'Cremación Exp. ' . $eventCremation['number'],
                                                "cleaningType" => "null",
                                                "cleaningMortuary" => "null",
                                                "cleaningUser" => "null",
                                                "type" => 1,
                                                "start" => $data['crematoriumEntryDate'] . " " . $data['crematoriumEntryTime'],
                                                "end" => $data['crematoriumLeavingDate'] . " " . $data['crematoriumLeavingTime'],
                                                "regularity" => "null",
                                                "reminder" => 0, 
                                                "cremation" => 1,
                                                "expedient" => $data['expedientID'],
                                                "event" => $eventCremation['ID']
                            );

                            $events->update($toEvent);
                        }
                    }
                }else{
                    $eventCremation = $db->query("SELECT e.crematoriumEvent AS ID, e.number FROM Expedients e WHERE e.expedientID = " . $data['expedientID']);
                    if(mysqli_num_rows($eventCremation) > 0){
                        $eventCremation = $db->resultToArray($eventCremation)[0];
                        $date = date("Y-m-d H:i:s");
                        if($eventCremation['ID'] != null){
                            $db->query("UPDATE Events e SET e.leavingDate = '" . $date . "' WHERE e.ID = " . $eventCremation['ID']);
                        }
                    }
                }

                $auxFuneralHomeEntryDate = $data['funeralHomeEntryDate'] == '' || $data['funeralHomeEntryDate'] == 'null' ? null : $data['funeralHomeEntryDate'];
                $auxFuneralHomeEntryTime = $data['funeralHomeEntryTime'] == '' || $data['funeralHomeEntryTime'] == 'null' ? null : $data['funeralHomeEntryTime'];
                $auxFuneralDate = $data['funeralDate'] == '' || $data['funeralDate'] == 'null' ? null : $data['funeralDate'];
                $auxFuneralTime = $data['funeralTime'] == '' || $data['funeralTime'] == 'null' ? null : $data['funeralTime'];
                $auxStartVelacionDate = $data['startVelacionDate'] == '' || $data['startVelacionDate'] == 'null' ? null : $data['startVelacionDate'];
                $auxStartVelacionTime = $data['startVelacionTime'] == '' || $data['startVelacionTime'] == 'null' ? null : $data['startVelacionTime'];

                $vc = new VisitsControl();
                $visitsAmount = intval($vc->getVisitControlByExpedientAmount($data['expedientID']));

                // Comprobar si las fechas actuales y las nuevas coinciden. En ese caso no hacer, en otro caso aplicar control de visitas
                if(
                    $currentFuneralDate != $auxFuneralDate ||
                    $currentFuneralTime != $auxFuneralTime ||
                    $currentFuneralHomeEntryDate != $auxFuneralHomeEntryDate ||
                    $currentFuneralHomeEntryTime != $auxFuneralHomeEntryTime ||
                    $currentStartVelacionDate != $auxStartVelacionDate ||
                    $currentStartVelacionTime != $auxStartVelacionTime ||
                    $visitsAmount == 0
                ){
                    if($data['deceasedMortuary'] != null){
                        $flagToDelete = false;
                        $result = $db->query("SELECT m.isYourOwn FROM Mortuaries m WHERE m.mortuaryID = " . $data['deceasedMortuary']);

                        $fieldFuneralHomeEntryDate = $data['startVelacionDate'] == '' ? $data['funeralHomeEntryDate'] : $data['startVelacionDate'];
                        $fieldFuneralHomeEntryTime = $data['startVelacionTime'] == '' ? $data['funeralHomeEntryTime'] : $data['startVelacionTime'];
                        $fieldFuneralDate = $data['funeralDate'];
                        $fieldFuneralTime = $data['funeralTime'];

                        if(mysqli_num_rows($result) > 0){
                            $isYourOwn = $db->resultToArray($result)[0];
                            if($isYourOwn['isYourOwn'] == '1'){
                                $vc = new VisitsControl();
                                $visitsControl = $vc->getVisitControlByExpedient($data['expedientID']);

                                // Creación visitas del expediente
                                if($visitsControl == NULL){
                                    $contVisit = 1;
                                    $hora = null;
                                    if($fieldFuneralHomeEntryDate != '' && $fieldFuneralHomeEntryTime != '' && $fieldFuneralDate != '' && $fieldFuneralTime != ''){
                                        $vControl = $vc->createVisitControl($data['expedientID']);
                                        if(strtotime($fieldFuneralHomeEntryTime) < strtotime("08:00:00")){
                                            $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, $fieldFuneralHomeEntryTime, $fieldFuneralHomeEntryDate)[0];
                                            $vc->createVisitDescription($visit);
                                            $fieldFuneralHomeEntryTime = "08:00:00";
                                            $contVisit++;
                                        }

                                        // for($dia = strtotime($fieldFuneralHomeEntryDate); $dia <= strtotime($fieldFuneralDate); $dia = $dia+(60*60*24)){ 
                                        for($dia = strtotime($fieldFuneralHomeEntryDate); $dia <= strtotime($fieldFuneralDate); $dia = strtotime("+1 day", $dia)){
                                            if($dia == strtotime($fieldFuneralHomeEntryDate)){
                                                //Empieza el rimer día
                                                if(strtotime($fieldFuneralHomeEntryDate) == strtotime($fieldFuneralDate)){
                                                    //Acaba el primer día
                                                    for($hora = strtotime($fieldFuneralHomeEntryTime); $hora <= strtotime($fieldFuneralTime); $hora = $hora+(60*60*3)){
                                                        $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', $hora), date("Y-m-d", $dia))[0];
                                                        $vc->createVisitDescription($visit);
                                                        $contVisit++;
                                                    } 
                                                }else{
                                                    //Acaba otro día
                                                    for($hora = strtotime($fieldFuneralHomeEntryTime); $hora <= strtotime("22:00:00"); $hora = $hora+(60*60*3)){
                                                        $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', $hora), date("Y-m-d", $dia))[0];
                                                        $vc->createVisitDescription($visit);
                                                        $contVisit++;
                                                    }
                                                    // if($hora > strtotime("22:00:00")){
                                                    //     if($contVisit < count($visitsControl)){
                                                    //         $vc->updateVisit($visitsControl[$contVisit]["ID"], date('H:i:s', strtotime("22:00:00")), date("Y-m-d", $dia));
                                                    //     }else{
                                                    //         $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', strtotime("22:00:00")), date("Y-m-d", $dia))[0];
                                                    //         $vc->createVisitDescription($visit);
                                                    //         $contVisit++;
                                                    //     }
                                                    //     $contVisit++;
                                                    // }
                                                }
                                            }else{
                                                //Si ya no es el primer día
                                                if($dia == strtotime($fieldFuneralDate)){
                                                    //Si estamos en el primer día empezamos a crear desde la hora de inicio
                                                    for($hora = strtotime("08:00"); $hora <= strtotime($fieldFuneralTime); $hora = $hora+(60*60*3)){
                                                        $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', $hora), date("Y-m-d", $dia))[0];
                                                        $vc->createVisitDescription($visit);
                                                        $contVisit++;
                                                    } 
                                                }else{
                                                    for($hora = strtotime("08:00"); $hora <= strtotime("22:00:00"); $hora = $hora+(60*60*3)){
                                                        $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', $hora), date("Y-m-d", $dia))[0];
                                                        $vc->createVisitDescription($visit);
                                                        $contVisit++;
                                                    }
                                                    // if($hora > strtotime("22:00:00")){
                                                    //     if($contVisit < count($visits)){
                                                    //         $vc->updateVisit($visits[$contVisit]["ID"], date('H:i:s', strtotime("22:00:00")), date("Y-m-d", $dia));
                                                    //     }else{
                                                    //         $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', strtotime("22:00:00")), date("Y-m-d", $dia))[0];
                                                    //         $vc->createVisitDescription($visit);
                                                    //         $contVisit++;
                                                    //     }
                                                    //     $contVisit++;
                                                    // }
                                                }
                                            }                
                                        }
                                        if(strtotime($fieldFuneralTime) > $hora - (60*60*3)){
                                            $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, $fieldFuneralTime, $fieldFuneralDate)[0];
                                            $vc->createVisitDescription($visit);
                                        }
                                    }else{
                                        if($fieldFuneralHomeEntryDate != '' && $fieldFuneralHomeEntryTime != ''){
                                            $vControl = $vc->createVisitControl($data['expedientID']);
                                            $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, $fieldFuneralHomeEntryTime, $fieldFuneralHomeEntryDate)[0];
                                            $vc->createVisitDescription($visit);
                                        }else{
                                            $flagToDelete = true;
                                        }
                                    }
                                }else{

                                    if($fieldFuneralHomeEntryDate != '' && $fieldFuneralHomeEntryTime != '' && $fieldFuneralDate != '' && $fieldFuneralTime != '' ){
                                        $visitControlID = $visitsControl["ID"];
                                        $visits = $vc->getVisitsIDs($visitControlID);
                                        if($visits == null){
                                            $visits = [];
                                        }
                                        for($i=0; $i < count($visits); $i++){
                                            $vc->deleteVisit($visits[$i]['ID']);
                                        }
                                        $visitCount = 1;
                                        if(strtotime($fieldFuneralHomeEntryTime) < strtotime("08:00:00")){
                                            $vc->updateVisit($visits[$visitCount-1]["ID"], $fieldFuneralHomeEntryTime, $fieldFuneralHomeEntryDate);
                                            // Activar cuando a la primera visita no se le generan "visits_descriptions"
                                            // $vc->createVisitDescription(array('visit' => $visits[$visitCount-1]["ID"]));
                                            $fieldFuneralHomeEntryTime = "08:00:00";
                                            $visitCount++;
                                        }
                                        $dia = null;
                                        $hora = null;
                                        // for($dia = strtotime($fieldFuneralHomeEntryDate); $dia <= strtotime($fieldFuneralDate); $dia = $dia+(60*60*24)){
                                        for($dia = strtotime($fieldFuneralHomeEntryDate); $dia <= strtotime($fieldFuneralDate); $dia = strtotime("+1 day", $dia)){
                                            
                                            if($dia == strtotime($fieldFuneralHomeEntryDate)){
                                                //Empieza el rimer día
                                                if(strtotime($fieldFuneralHomeEntryDate) == strtotime($fieldFuneralDate)){
                                                    //Acaba el primer día
                                                    for($hora = strtotime($fieldFuneralHomeEntryTime); $hora <= strtotime($fieldFuneralTime); $hora = $hora+(60*60*3)){
                                                        if($visitCount < count($visits)){
                                                            $vc->updateVisit($visits[$visitCount-1]["ID"], date('H:i:s', $hora), date("Y-m-d", $dia));
                                                        }else{
                                                            $visit = $vc->createVisit($visitControlID, "Visita: ".$visitCount, date('H:i:s', $hora), date("Y-m-d", $dia))[0];
                                                            $vc->createVisitDescription($visit);
                                                        }
                                                        $visitCount++;
                                                    } 
                                                }else{
                                                    //Acaba otro día
                                                    for($hora = strtotime($fieldFuneralHomeEntryTime); $hora <= strtotime("22:00:00"); $hora = $hora+(60*60*3)){
                                                        if($visitCount < count($visits)){
                                                            $vc->updateVisit($visits[$visitCount-1]["ID"], date('H:i:s', $hora), date("Y-m-d", $dia));
                                                        }else{
                                                            $visit = $vc->createVisit($visitControlID, "Visita: ".$visitCount, date('H:i:s', $hora), date("Y-m-d", $dia))[0];
                                                            $vc->createVisitDescription($visit);
                                                        }
                                                        $visitCount++;
                                                    }
                                                    if($hora > strtotime("22:00:00")){
                                                        if($visitCount < count($visits)){
                                                            $vc->updateVisit($visits[$visitCount-1]["ID"], date('H:i:s', strtotime("22:00:00")), date("Y-m-d", $dia));
                                                        }else{
                                                            $visit = $vc->createVisit($visitControlID, "Visita: ".$visitCount, date('H:i:s', strtotime("22:00:00")), date("Y-m-d", $dia))[0];
                                                            $vc->createVisitDescription($visit);
                                                        }
                                                        $visitCount++;
                                                    }
                                                }
                                            }else{
                                                //Si ya no es el primer día
                                                if($dia == strtotime($fieldFuneralDate)){
                                                    //Si estamos en el primer día empezamos a crear desde la hora de inicio
                                                    for($hora = strtotime("08:00"); $hora <= strtotime($fieldFuneralTime); $hora = $hora+(60*60*3)){
                                                        if($visitCount < count($visits)){
                                                            $vc->updateVisit($visits[$visitCount-1]["ID"], date('H:i:s', $hora), date("Y-m-d", $dia));
                                                        }else{
                                                            $visit = $vc->createVisit($visitControlID, "Visita: ".$visitCount, date('H:i:s', $hora), date("Y-m-d", $dia))[0];
                                                            $vc->createVisitDescription($visit);
                                                        }
                                                        $visitCount++;
                                                    } 
                                                }else{
                                                    for($hora = strtotime("08:00"); $hora <= strtotime("22:00:00"); $hora = $hora+(60*60*3)){
                                                        if($visitCount < count($visits)){
                                                            $vc->updateVisit($visits[$visitCount-1]["ID"], date('H:i:s', $hora), date("Y-m-d", $dia));
                                                        }else{
                                                            $visit = $vc->createVisit($visitControlID, "Visita: ".$visitCount, date('H:i:s', $hora), date("Y-m-d", $dia))[0];
                                                            $vc->createVisitDescription($visit);
                                                        }
                                                        $visitCount++;
                                                    }
                                                    if($hora > strtotime("22:00:00")){
                                                        if($visitCount < count($visits)){
                                                            $vc->updateVisit($visits[$visitCount-1]["ID"], date('H:i:s', strtotime("22:00:00")), date("Y-m-d", $dia));
                                                        }else{
                                                            $visit = $vc->createVisit($visitControlID, "Visita: ".$visitCount, date('H:i:s', strtotime("22:00:00")), date("Y-m-d", $dia))[0];
                                                            $vc->createVisitDescription($visit);
                                                        }
                                                        $visitCount++;
                                                    }
                                                }
                                            }                
                                        }
                                        if(strtotime($fieldFuneralTime) > $hora - (60*60*3)){
                                            if($visitCount < count($visits)){
                                                $vc->updateVisit($visits[$visitCount-1]["ID"], $fieldFuneralTime, $fieldFuneralDate);
                                            }else{
                                                $visit = $vc->createVisit($visitControlID, "Visita: ".$visitCount, date('H:i:s', strtotime($fieldFuneralTime)), date("Y-m-d", strtotime($fieldFuneralDate)))[0];
                                                $vc->createVisitDescription($visit);
                                            }
                                            $visitCount++;
                                        }
                                        for($visitCount; $visitCount < count($visits); $visitCount++){
                                            $vc->deleteVisit($visits[$visitCount-1]['ID']);
                                        }
                                    }else{
                                        $visitControlID = $visitsControl["ID"];
                                        $visits = $vc->getVisitsIDs($visitControlID);
                                        if($visits == null){
                                            $visits = [];
                                        }
                                        $visitCount = 0;
                                        if($fieldFuneralHomeEntryDate != '' && $fieldFuneralHomeEntryTime != ''){
                                            if(isset($visits[$visitCount-1])){
                                                $vc->updateVisit($visits[$visitCount-1]["ID"], date('H:i:s', strtotime($fieldFuneralHomeEntryTime)), date("Y-m-d", strtotime($fieldFuneralHomeEntryDate)));
                                                $visitCount++;
                                            }
                                        }
                                        for($visitCount; $visitCount < count($visits); $visitCount++){
                                            if(isset($visits[$visitCount-1])){
                                                $vc->deleteVisit($visits[$visitCount-1]['ID']);
                                            }
                                        }

                                        $flagToDelete = true;
                                    }
                                }
                            }else{
                                $vc = new VisitsControl();
                                $visitsControl = $vc->getVisitControlByExpedient($data['expedientID']);
                                // Creación las contrataciones asociadas al expediente en base a los productos existentes (sin checkear)
                                if($visitsControl == NULL){
                                    $contVisit = 1;
                                    if($fieldFuneralHomeEntryDate != '' && $fieldFuneralHomeEntryTime != '' && $fieldFuneralDate != '' && $fieldFuneralTime != ''){
                                        $vControl = $vc->createVisitControl($data['expedientID']);
                                        // for($dia = strtotime($fieldFuneralHomeEntryDate); $dia <= strtotime($fieldFuneralDate); $dia = $dia+(60*60*24)){
                                        for($dia = strtotime($fieldFuneralHomeEntryDate); $dia <= strtotime($fieldFuneralDate); $dia = strtotime("+1 day", $dia)){
                                            if(strtotime($fieldFuneralHomeEntryTime) > strtotime("11:00:00")){
                                                if(strtotime(date('Y-m-d', $dia + 60 * 60 * 24) . ' ' . $fieldFuneralHomeEntryTime) < strtotime($fieldFuneralDate . ' ' . $fieldFuneralTime)){
                                                    $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', strtotime("11:00:00")), date("Y-m-d", $dia+(60*60*24)))[0];
                                                    $vc->createVisitDescription($visit);
                                                    $contVisit++;
                                                }
                                            }else{
                                                if(strtotime(date('Y-m-d', $dia) . ' ' . $fieldFuneralHomeEntryTime) < strtotime($fieldFuneralDate . ' ' . $fieldFuneralTime)){
                                                    $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', strtotime("11:00:00")), date("Y-m-d", $dia))[0];
                                                    $vc->createVisitDescription($visit);
                                                    $contVisit++;
                                                }
                                            }
                                        }
                                    }elseif($fieldFuneralHomeEntryDate && $fieldFuneralHomeEntryTime != ''){
                                        $vControl = $vc->createVisitControl($data['expedientID']);
                                        if(strtotime($fieldFuneralHomeEntryTime) > strtotime("11:00:00")){
                                            $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', strtotime("11:00:00")), date('Y-m-d', strtotime($fieldFuneralHomeEntryDate) + 24 * 60 * 60))[0];
                                        }else{
                                            $visit = $vc->createVisit($vControl['visitControl'], "Visita: ".$contVisit, date('H:i:s', strtotime("11:00:00")), $fieldFuneralHomeEntryDate)[0];
                                        }
                                        $vc->createVisitDescription($visit);
                                    }
                                }else{
                                    $visitControlID = $visitsControl["ID"];
                                    $visits = $vc->getVisitsIDs($visitControlID);
                                    if($visits == null){
                                        $visits = [];
                                    }
                                    $visitCount = 0;
                                    $contVisit = 1;
                                    if($fieldFuneralHomeEntryDate != '' && $fieldFuneralHomeEntryTime != '' && $fieldFuneralDate != '' && $fieldFuneralTime != ''){
                                        $vControl = $vc->getVisitControlByExpedient($data['expedientID']);
                                        
                                        // for($dia = strtotime($fieldFuneralHomeEntryDate); $dia <= strtotime($fieldFuneralDate); $dia = $dia+(60*60*24)){
                                        for($dia = strtotime($fieldFuneralHomeEntryDate); $dia <= strtotime($fieldFuneralDate); $dia = strtotime("+1 day", $dia)){
                                            if($visitCount < count($visits)){
                                                if(strtotime($fieldFuneralHomeEntryTime) > strtotime("11:00:00")){
                                                    // if(strtotime(date('Y-m-d', $dia + 60 * 60 * 24) . ' ' . $fieldFuneralHomeEntryTime) < strtotime($fieldFuneralDate . ' ' . $fieldFuneralTime)){
                                                    if(strtotime(date('Y-m-d', $dia + 60 * 60 * 24) . ' 11:00') < strtotime($fieldFuneralDate . ' ' . $fieldFuneralTime)){
                                                        $vc->updateVisit($visits[$visitCount]["ID"], date('H:i:s', strtotime("11:00:00")), date("Y-m-d", $dia + 24 * 60 * 60));
                                                        $visitCount++;
                                                    }
                                                }else{
                                                    if(strtotime(date('Y-m-d', $dia) . ' ' . $fieldFuneralHomeEntryTime) < strtotime($fieldFuneralDate . ' ' . $fieldFuneralTime)){
                                                        $vc->updateVisit($visits[$visitCount]["ID"], date('H:i:s', strtotime("11:00:00")), date("Y-m-d", $dia));
                                                        $visitCount++;
                                                    }
                                                }
                                            }else{
                                                if(strtotime($fieldFuneralHomeEntryTime) > strtotime("11:00:00")){
                                                    // if(strtotime(date('Y-m-d', $dia + 60 * 60 * 24) . ' ' . $fieldFuneralHomeEntryTime) < strtotime($fieldFuneralDate . ' ' . $fieldFuneralTime)){
                                                    if(strtotime(date('Y-m-d', $dia + 60 * 60 * 24) . ' 11:00') < strtotime($fieldFuneralDate . ' ' . $fieldFuneralTime)){
                                                        $visit = $vc->createVisit($vControl['ID'], "Visita: ".(count($visits) + 1), date('H:i:s', strtotime("11:00:00")), date("Y-m-d", $dia+(60*60*24)))[0];
                                                        $vc->createVisitDescription($visit);
                                                        $contVisit++;
                                                        $visitCount++;
                                                    }
                                                }else{
                                                    if(strtotime(date('Y-m-d', $dia) . ' ' . $fieldFuneralHomeEntryTime) < strtotime($fieldFuneralDate . ' ' . $fieldFuneralTime)){
                                                        $visit = $vc->createVisit($vControl['ID'], "Visita: ".(count($visits) + 1), date('H:i:s', strtotime("11:00:00")), date("Y-m-d", $dia))[0];
                                                        $vc->createVisitDescription($visit);
                                                        $contVisit++;
                                                        $visitCount++;
                                                    }
                                                }
                                            }
                                        }
                                        for($visitCount; $visitCount < count($visits); $visitCount++){
                                            $vc->deleteVisit($visits[$visitCount]['ID']);
                                        }

                                        if($visitCount == 0){
                                            $flagToDelete = true;
                                        }
                                    }else{
                                        $db->query("UPDATE  VisitsControl
                                                    SET     leavingDate = " . time() . "
                                                    WHERE   expedient = " . $data['expedientID']);
                                    }
                                }
                            }
                        }

                        $db->query("UPDATE  VisitsControl
                                    SET     leavingDate = NULL
                                    WHERE   expedient = " . $data['expedientID']);

                        if($flagToDelete){
                            $db->query("UPDATE  VisitsControl
                                        SET     leavingDate = " . time() . "
                                        WHERE   expedient = " . $data['expedientID']);
                        }
                    }else{
                        // Buscar visit_control -> visit -> visit_description -> visit_description_cafe
                        $db->query("UPDATE  VisitsControl
                                    SET     leavingDate = " . time() . "
                                    WHERE   expedient = " . $data['expedientID']);
                    }
                }
            }

            //ACTUALIZAMOS EL DIA Y HORA A LA QUE ESTÁN OCUPADO EL PERSONAL
            if($data['funeralDate'] != null && $data['funeralDate'] != '' && $data['funeralTime'] != null && $data['funeralTime'] != ''){

                $settings = new Settings;

                //ENTERRADORES
                $result = $db->query('  SELECT  * 
                                        FROM    Services_Gravediggers 
                                        WHERE   service = "'. $data['expedientID'].'"');

                if(mysqli_num_rows($result) > 0){
                    $duration = $settings->getTime('Enterradores');
                    $toTime = date('H:i:s', strtotime($data['funeralTime']) + (60 * 60 * $duration));

                    $db->query('    UPDATE  Services_Gravediggers 
                                    SET     day = "' .  $data['funeralDate'] . '",
                                            fromTime = "'.  $data['funeralTime'] . '",
                                            toTime = "'.  $toTime . '"
                                    WHERE   service = "'. $data['expedientID'] . '" ');
                }

                //CAMPANEROS
                $result = $db->query('  SELECT  * 
                                        FROM    Services_Bellringers 
                                        WHERE   service = "'. $data['expedientID'].'"');

                if(mysqli_num_rows($result) > 0){
                    $duration = $settings->getTime('Campaneros');
                    $toTime = date('H:i:s', strtotime($data['funeralTime']) + (60 * 60 * $duration));

                    $db->query('    UPDATE  Services_Bellringers 
                                    SET     day = "' .  $data['funeralDate'] . '",
                                            fromTime = "'.  $data['funeralTime'] . '",
                                            toTime = "'.  $toTime . '"
                                    WHERE   service = "'. $data['expedientID'] . '" ');
                }

                //PORTEADORES
                $result = $db->query('  SELECT  * 
                                        FROM    Services_Carriers
                                        WHERE   service = "'. $data['expedientID'].'"');

                if(mysqli_num_rows($result) > 0){
                    $duration = $settings->getTime('Porteadores');
                    $toTime = date('H:i:s', strtotime($data['funeralTime']) + (60 * 60 * $duration));

                    $db->query('    UPDATE  Services_Carriers 
                                    SET     day = "' .  $data['funeralDate'] . '",
                                            fromTime = "'.  $data['funeralTime'] . '",
                                            toTime = "'.  $toTime . '"
                                    WHERE   service = "'. $data['expedientID'] . '" ');
                }

                //COROS
                $result = $db->query('  SELECT  * 
                                        FROM    Services_Choirs
                                        WHERE   service = "'. $data['expedientID'].'"');

                if(mysqli_num_rows($result) > 0){
                    $duration = $settings->getTime('Coros');
                    $toTime = date('H:i:s', strtotime($data['funeralTime']) + (60 * 60 * $duration));

                    $db->query('    UPDATE  Services_Choirs 
                                    SET     day = "' .  $data['funeralDate'] . '",
                                            fromTime = "'.  $data['funeralTime'] . '",
                                            toTime = "'.  $toTime . '"
                                    WHERE   service = "'. $data['expedientID'] . '" ');
                }

                //CURAS
                $result = $db->query('  SELECT  * 
                                        FROM    Services_Priests
                                        WHERE   service = "'. $data['expedientID'].'"');

                if(mysqli_num_rows($result) > 0){
                    $duration = $settings->getTime('Curas');
                    $toTime = date('H:i:s', strtotime($data['funeralTime']) + (60 * 60 * $duration));

                    $db->query('    UPDATE  Services_Priests 
                                    SET     day = "' .  $data['funeralDate'] . '",
                                            fromTime = "'.  $data['funeralTime'] . '",
                                            toTime = "'.  $toTime . '"
                                    WHERE   service = "'. $data['expedientID'] . '" ');
                }
                
            }

            // Actualizamos el price exp en la ultima contratacion generada
            if($updatePriceExpHiring){

                $result = $db->query("  SELECT   MAX(eh.num_hiring) as num_hiring
                                        FROM     Expedients_Hirings eh
                                        WHERE    eh.expedient = {$data['expedientID']} AND 
                                                 (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices i 
                                                    WHERE   i.expedient = eh.expedient AND 
                                                            i.leavingDate IS NULL AND 
                                                            i.num_hiring = eh.num_hiring
                                                 ) = 0
                ");

                if(mysqli_num_rows($result) > 0){
                    $resultSQL = $db->resultToArray($result);
                    $maxHiringToUpdate = $resultSQL[0]['num_hiring'];

                    $db->query("UPDATE  Expedients_Hirings
                                SET     priceExp = $priceClient
                                WHERE   expedient = {$data['expedientID']} AND 
                                        num_hiring = $maxHiringToUpdate
                    ");
                }
            }

            return $expedient;
        }

        /**
        * Modifica los datos de un expediente - Tipo TPV
        *
        * @param array $data
        *
        * @return bool
        */
        public function updateExpedientTPV($data){
            $db = new DbHandler;

            $data['expedientID'] = cleanStr($data['expedientID']);
            $data['requestTime'] = cleanStr($data['requestTime']);
            $data['requestDate'] = cleanStr($data['requestDate']);
            $data['expType'] = cleanStr($data['expType']);
            $data['clientType'] = cleanStr($data['clientType']);
            $data['policy'] = cleanStr($data['policy']);
            $data['capital'] = cleanStr($data['capital']);
            $data['status'] = cleanStr($data['status']);
            $data['lossNumber'] = cleanStr($data['lossNumber']);
            $data['arriveTime'] = cleanStr($data['arriveTime']);
            $data['arriveDate'] = cleanStr($data['arriveDate']);
            $data['client'] = cleanStr($data['client']);
            $data['deceasedName'] = cleanStr($data['deceasedName']);
            $data['deceasedSurname'] = cleanStr($data['deceasedSurname']);
            $data['deceasedNIF'] = cleanStr($data['deceasedNIF']);
            $data['deceasedNifType'] = cleanStr($data['deceasedNifType']);
            $data['deceasedMortuary'] = cleanStr($data['deceasedMortuary']);
            $data['deceasedGender'] = cleanStr($data['deceasedGender']);
            $data['deceasedMortuaryAddress'] = cleanStr($data['deceasedMortuaryAddress']);

            if($data['client'] == null || $data['client'] == ''){
                $data['client'] = 'null';
            }

            // Validación de campos
            if($data['expType'] == ''){
                return false;
            }
            
            if($data['deceasedNIF'] != ''){
                if($data['deceasedNifType'] != 3 &&  $data["deceasedNifType"] != 4){
                    if(!isValidIdNumber($data['deceasedNIF'])){
                        return false;
                    }
                }
            }

            if(empty($data['deceasedMortuary'])){
                $data['deceasedMortuary'] = 'null';
            }
          
            //Obtener datos del expediente editado antes de realizar la edicion
            $result = $db->query("  SELECT  requestDate, number, expNumLetter, expNumSecuence, expNumYear, expNumType, clientType, client,
                                            deceasedMortuary, funeralDate, funeralTime, funeralHomeEntryDate, funeralHomeEntryTime
                                    FROM    Expedients 
                                    WHERE   leavingDate IS NULL AND expedientID =" . $data['expedientID']);

            if(mysqli_num_rows($result) > 0){
                $resultSQL = $db->resultToArray($result);
                $createYear = explode('-', $resultSQL[0]['requestDate'])[0];
                $numberExp = $resultSQL[0]['number'];
                $expNumLetter = $resultSQL[0]['expNumLetter'] ;
                $expNumSec = $resultSQL[0]['expNumSecuence'] ;
                $expNumYear = $resultSQL[0]['expNumYear'] ;
                $expNumType = $resultSQL[0]['expNumType'] ;
                $clientType = $resultSQL[0]['clientType'] ;
                $clientOld = $resultSQL[0]['client'] ;
            }else{
                $expNumSec = null;
                $expNumYear = null;
                $expNumType = null;
                $clientOld = null;
                $createYear = date('Y');
            }   

            // SI SE MODIFICA El TIPO DE CLIENTE CAMBIA EL NÚMERO DEL EXPEDIENTE SOLO PARA DEFUNCION      
            if($data['clientType'] != $clientType){
                
                if($data['expType'] == '1'){  //DEFUNCION                     
                    
                    switch ($data['clientType']) {
                        case '1': //PARTICULARES                       
                            
                            $expNumLetter = 'P';

                            //Calcular el numero de secuencia del expediente para Particulares
                            $result = $db->query("  SELECT  COUNT(expedientID) as total 
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = 1 AND type = 1 AND
                                                            expedientID < " . $data['expedientID']." AND
                                                            entryDate >= '$expNumYear-01-01' AND 
                                                            entryDate <= '$expNumYear-12-31'");

                            if(mysqli_num_rows($result) > 0){
                                $expNumType = $db->resultToArray($result)[0]['total'] + 1;
                            }else{
                                $expNumType = 1;
                            }

                            $numberYear =substr($expNumYear,-2);
                            $numberExp = $expNumSec . ' ' . $expNumLetter . $expNumType . '/' . $numberYear;
                            
                            //ACTUALIZAR EL RESTO DE PARTICULARES, Seleccionar los que son posteriores al editado
                            $res = $db->query(" SELECT  expedientID, number, expNumLetter, expNumSecuence, expNumYear, expNumType
                                                FROM    Expedients 
                                                WHERE   leavingDate IS NULL AND
                                                        clientType = 1 AND type = 1 AND
                                                        expedientID > " . $data['expedientID']." AND
                                                        entryDate >= '$expNumYear-01-01' AND 
                                                        entryDate <= '$expNumYear-12-31'" );

                            if(mysqli_num_rows($res) > 0){
                                $postExpedients = $db->resultToArray($res);
                                foreach($postExpedients as $expedientPost){                                 
                                    $newTypeNumber = intVal($expedientPost['expNumType']) + 1; //Aumentar el numero de particulares                                    
                                    $newNumSec = intVal($expedientPost['expNumSecuence']); //Aumentar el numero de secuencia
                                    $numberYear = substr($expedientPost['expNumYear'], -2);
                                    $newNumberExpedient = $newNumSec . ' ' . $expedientPost['expNumLetter'] . $newTypeNumber . '/' . $numberYear;
                                    
                                    //Actualizar expedientes
                                    $expedientsPostUpdates = $db->query("   UPDATE  Expedients
                                                                            SET     number =  '$newNumberExpedient', 
                                                                                    expNumType = $newTypeNumber
                                                                            WHERE   expedientID = ".$expedientPost['expedientID']);
                                }
                            }

                            //ACTUALIZAR EL RESTO del tipo de cliente antiguo: SEGURO O EMPRESA
                            $res1 = $db->query("    SELECT  expedientID, number, expNumLetter, expNumSecuence, expNumYear, expNumType
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = $clientType AND type = 1 AND
                                                            expedientID > " . $data['expedientID']." AND
                                                            entryDate >= '$expNumYear-01-01' AND 
                                                            entryDate <= '$expNumYear-12-31'");

                            if(mysqli_num_rows($res1) > 0){
                                $postExpedients1 = $db->resultToArray($res1);
                                foreach($postExpedients1 as $expedientPost){ 
                                    $newNumSec = intVal($expedientPost['expNumSecuence']) ; //Disminuir el numero de secuencia      
                                    $numberYear = substr($expedientPost['expNumYear'], -2);
                                    $newTypeNumber  = intVal($expedientPost['expNumType']) - 1;      
                                    $newNumberExpedient = $newNumSec . ' ' . $expedientPost['expNumLetter'] . $newTypeNumber . '/' . $numberYear;
                                    
                                    //Actualizar expediente
                                    $expedientsPostUpdates = $db->query("   UPDATE  Expedients
                                                                            SET     number =  '$newNumberExpedient', 
                                                                                    expNumType = $newTypeNumber
                                                                            WHERE   expedientID = ".$expedientPost['expedientID']);
                                }
                            }
                        break;

                        case '2': //SEGUROS  
                        
                            $expNumLetter = 'S';

                            //Calcular el numero de secuencia del expediente para Seguros
                            $result = $db->query("  SELECT  COUNT(expedientID) as total 
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = 2 AND type = 1 AND
                                                            expedientID < " . $data['expedientID']." AND
                                                            entryDate >= '$expNumYear-01-01' AND 
                                                            entryDate <= '$expNumYear-12-31'");

                            if(mysqli_num_rows($result) > 0){
                                $expNumType = $db->resultToArray($result)[0]['total'] + 1;
                            }else{
                                $expNumType = 1;
                            }

                            $numberYear =substr($expNumYear,-2);
                            $numberExp = $expNumSec . ' ' . $expNumLetter . $expNumType . '/' . $numberYear;
                           
                            //ACTUALIZAR EL RESTO DE PARTICULARES, Seleccionar los que son posteriores al editado
                            $res = $db->query("  SELECT  expedientID, number, expNumLetter, expNumSecuence, expNumYear, expNumType
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = 2 AND type = 1 AND
                                                            expedientID > " . $data['expedientID']." AND
                                                            entryDate >= '$expNumYear-01-01' AND 
                                                            entryDate <= '$expNumYear-12-31'" );

                            if(mysqli_num_rows($res) > 0){
                                $postExpedients = $db->resultToArray($res);
                                foreach($postExpedients as $expedientPost){                                    
                                    $newTypeNumber = intVal($expedientPost['expNumType']) + 1; //Aumentar el numero de particulares                                    
                                    $newNumSec = intVal($expedientPost['expNumSecuence']); //Aumentar el numero de secuencia
                                    $numberYear = substr($expedientPost['expNumYear'], -2);
                                    $newNumberExpedient = $newNumSec . ' ' . $expedientPost['expNumLetter'] . $newTypeNumber . '/' . $numberYear;

                                    //Actualizar expedientes
                                    $expedientsPostUpdates = $db->query("   UPDATE  Expedients
                                                                            SET     number =  '$newNumberExpedient', expNumType = $newTypeNumber
                                                                            WHERE   expedientID = ".$expedientPost['expedientID']);

                                    //Actualizar presupuestos y facturas
                                    $genNumInvoice = 'P' . $newNumSec .'/'.$expedientPost['expNumYear'];
                                    $result = $db->query("  UPDATE  Invoices
                                                            SET     generatedInvoiceNumber = '" . $genNumInvoice . "'
                                                            WHERE   expedient = " . $expedientPost['expedientID'] . "");
                                    
                                    $numBudget = 'PR-' . $newNumberExpedient;                                       
                                    $result = $db->query("  UPDATE  Budgets
                                                            SET     numBudget = '" . $numBudget . "'
                                                            WHERE   expedient = " . $expedientPost['expedientID'] . "");
                                }
                            }

                            //ACTUALIZAR EL RESTO del tipo de cliente antiguo: SEGURO O EMPRESA
                            $res1 = $db->query("    SELECT  expedientID, number, expNumLetter, expNumSecuence, expNumYear, expNumType
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = $clientType AND type = 1 AND
                                                            expedientID > " . $data['expedientID']." AND
                                                            entryDate >= '$expNumYear-01-01' AND 
                                                            entryDate <= '$expNumYear-12-31'");

                            if(mysqli_num_rows($res1) > 0){

                                $postExpedients1 = $db->resultToArray($res1);
                                foreach($postExpedients1 as $expedientPost){ 
                                    $newNumSec = intVal($expedientPost['expNumSecuence']); //Disminuir el numero de secuencia      
                                    $numberYear = substr($expedientPost['expNumYear'], -2);
                                    $newTypeNumber  = intVal($expedientPost['expNumType']) - 1;      
                                    $newNumberExpedient = $newNumSec . ' ' . $expedientPost['expNumLetter'] . $newTypeNumber . '/' . $numberYear;

                                    //Actualizar expediente
                                    $expedientsPostUpdates = $db->query("   UPDATE  Expedients
                                                                            SET     number =  '$newNumberExpedient', 
                                                                                    expNumType = $newTypeNumber
                                                                            WHERE   expedientID = ".$expedientPost['expedientID']);
                                }
                            }
                           
                        break;

                        case '3': //EMPRESAS
                            $expNumLetter = 'E'; 
                            
                            //Calcular el numero de secuencia del expediente para Particulares
                            $result = $db->query("  SELECT  COUNT(expedientID) as total 
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = 3 AND type = 1 AND
                                                            expedientID < " . $data['expedientID']." AND
                                                            entryDate >= '$expNumYear-01-01' AND 
                                                            entryDate <= '$expNumYear-12-31'");

                            if(mysqli_num_rows($result) > 0){
                                $expNumType = $db->resultToArray($result)[0]['total'] + 1;
                                // $expNumSec = $expNumType;
                            }else{
                                $expNumType = 1;
                                $expNumSec = 1;
                            }

                            $numberYear =substr($expNumYear,-2);
                            $numberExp = $expNumSec . ' ' . $expNumLetter . $expNumType . '/' . $numberYear;
                           
                            //ACTUALIZAR EL RESTO DE PARTICULARES, Seleccionar los que son posteriores al editado
                            $res = $db->query("  SELECT  expedientID, number, expNumLetter, expNumSecuence, expNumYear, expNumType
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = 3 AND type = 1 AND
                                                            expedientID > " . $data['expedientID']." AND
                                                            entryDate >= '$expNumYear-01-01' AND 
                                                            entryDate <= '$expNumYear-12-31'" );

                            if(mysqli_num_rows($res) > 0){
                                $postExpedients = $db->resultToArray($res);
                                foreach($postExpedients as $expedientPost){          
                                    $newTypeNumber = intVal($expedientPost['expNumType']) + 1; //Aumentar el numero de particulares                                    
                                    $newNumSec = intVal($expedientPost['expNumSecuence']); //Aumentar el numero de secuencia
                                    $numberYear = substr($expedientPost['expNumYear'], -2);
                                    $newNumberExpedient = $newNumSec . ' ' . $expedientPost['expNumLetter'] . $newTypeNumber . '/' . $numberYear;

                                    //Actualizar expedientes
                                    $expedientsPostUpdates = $db->query("   UPDATE  Expedients
                                                                            SET     number =  '$newNumberExpedient', 
                                                                                    expNumType = $newTypeNumber
                                                                            WHERE   expedientID = ".$expedientPost['expedientID']);
                                }
                            }

                            //ACTUALIZAR EL RESTO del tipo de cliente antiguo: SEGURO O EMPRESA
                            $res1 = $db->query("    SELECT  expedientID, number, expNumLetter, expNumSecuence, expNumYear, expNumType
                                                    FROM    Expedients 
                                                    WHERE   leavingDate IS NULL AND
                                                            clientType = $clientType AND type = 1 AND
                                                            expedientID > " . $data['expedientID']." AND
                                                            entryDate >= '$expNumYear-01-01' AND 
                                                            entryDate <= '$expNumYear-12-31'");

                            if(mysqli_num_rows($res1) > 0){
                                $postExpedients1 = $db->resultToArray($res1);
                                foreach($postExpedients1 as $expedientPost){ 
                                    $newNumSec = intVal($expedientPost['expNumSecuence']); //Disminuir el numero de secuencia      
                                    $numberYear = substr($expedientPost['expNumYear'], -2);
                                    $newTypeNumber  = intVal($expedientPost['expNumType']) - 1;      
                                    $newNumberExpedient = $newNumSec . ' ' . $expedientPost['expNumLetter'] . $newTypeNumber . '/' . $numberYear;

                                    //Actualizar expediente
                                    $expedientsPostUpdates = $db->query("   UPDATE  Expedients
                                                                            SET     number =  '$newNumberExpedient', 
                                                                                    expNumType = $newTypeNumber
                                                                            WHERE   expedientID = ".$expedientPost['expedientID']);
                                }
                            }
                            
                        break;
                    }
                } 
            }

            //CHANGES THE PRICE ASSOCIATED WITH THE EXPEDIENTES IF THE CLIENT CHANGES
            $updatePriceExpHiring = false;
            if($data['client'] != null && $data['client'] != '' && $data['client'] != $clientOld){
                $result = $db->query("  SELECT   p.name
                                        FROM     Clients c, Prices p
                                        WHERE    c.clientID = {$data['client']} 
                                            AND  p.leavingDate IS NULL
                                            AND  p.priceID = c.price");
                                        
                if(mysqli_num_rows($result) > 0){
                    $priceName = $db->resultToArray($result)[0]['name'];

                    $result = $db->query("  SELECT   p.priceID
                                            FROM     Prices p
                                            WHERE    p.name = '$priceName' 
                                                AND  p.leavingDate IS NULL
                                                AND  p.year = $createYear");

                    if(mysqli_num_rows($result) > 0){
                        $priceClient = $db->resultToArray($result)[0]['priceID'];
                    }else{
                        $result = $db->query("  SELECT   c.price
                                                FROM     Clients c
                                                WHERE    c.clientID = {$data['client']}");
                                            
                        if(mysqli_num_rows($result) > 0){
                            $priceClient = $db->resultToArray($result)[0]['price'];
                        }else{
                            $priceClient = 'null';
                        }
                    }
                }else{
                    $priceClient = 'null';
                }
            }else{
                $priceClient = 'null'; 
            }

            $priceClientUpdate = '';
            if($priceClient != 'null'){
                $priceClientUpdate = 'priceExp = '. $priceClient .',';
                $updatePriceExpHiring = true;
            }
            
            $expedient = $db->query("   UPDATE  Expedients
                                        SET     number = '$numberExp', 
                                                requestTime = '" . $data['requestTime'] . "',
                                                requestDate = '" . $data['requestDate'] . "',
                                                clientType = " . $data['clientType'] . ", 
                                                policy = '" . $data['policy'] . "',
                                                capital = '" . $data['capital'] . "',
                                                status = " . $data['status'] . ",
                                                lossNumber = '" . $data['lossNumber'] . "',
                                                client = " . $data['client'] . ",
                                                deceasedGender = '" . $data['deceasedGender'] . "',
                                                deceasedName = '" . $data['deceasedName'] . "',
                                                deceasedSurname = '" . $data['deceasedSurname'] . "',
                                                deceasedNIF = '" . $data['deceasedNIF'] . "',
                                                deceasedMortuary = " . $data['deceasedMortuary'] . ",
                                                deceasedMortuaryAddress = '" . $data['deceasedMortuaryAddress'] . "',
                                                deceasedNifType = " . $data['deceasedNifType'] . ",
                                                expNumLetter =  '$expNumLetter',
                                                expNumYear =  $expNumYear, 
                                                $priceClientUpdate
                                                expNumType =  $expNumType
                                        WHERE   expedientID = " . $data['expedientID']);
            if($expedient){

                //Actualizar hora de llegada
                if($data['arriveTime'] == ''){
                    $consulta = "arriveTime = null"; 
                }else{
                    $consulta = "arriveTime = '" . $data['arriveTime'] . "'";
                }
                if($data['arriveDate'] == ''){
                    $consulta .= ",arriveDate = null"; 
                }else{
                    $consulta .= ",arriveDate = '" . $data['arriveDate'] . "'";
                }

                $db->query("UPDATE  Expedients_Services 
                            SET     $consulta
                            WHERE   expedient = " . $data['expedientID'] . "");
            }

            // Actualizamos el price exp en la ultima contratacion generada
            if($updatePriceExpHiring){

                $result = $db->query("  SELECT   MAX(eh.num_hiring) as num_hiring
                                        FROM     Expedients_Hirings eh
                                        WHERE    eh.expedient = {$data['expedientID']} AND 
                                                 (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices i 
                                                    WHERE   i.expedient = eh.expedient AND 
                                                            i.leavingDate IS NULL AND 
                                                            i.num_hiring = eh.num_hiring
                                                 ) = 0
                ");

                if(mysqli_num_rows($result) > 0){
                    $resultSQL = $db->resultToArray($result);
                    $maxHiringToUpdate = $resultSQL[0]['num_hiring'];

                    $db->query("UPDATE  Expedients_Hirings
                                SET     priceExp = $priceClient
                                WHERE   expedient = {$data['expedientID']} AND 
                                        num_hiring = $maxHiringToUpdate
                    ");
                }
            }

            return $expedient;
        }

        /**
        * Modifica el estado de un expediente
        *
        * @param array $data
        *
        * @return bool
        */
        public function updateExpedientStatus($data){
            $db = new DbHandler;

            $data['expedientID'] = cleanStr($data['expedientID']);

            return $db->query(" UPDATE  Expedient
                                SET     status = '" . $data['status'] . "' 
                                WHERE   expedientID = " . $data['expedientID'] . "");
        }

        /**
        * Modifica una encuesta asociada a un expediente
        *
        * @param array $data
        *
        * @return bool
        */
        public function updateExpedientSurvey($data){
            $db = new DbHandler;

            // Validación de campos
            if($data['survey'] == ''){
                return false;
            }else{
                $data['survey'] = cleanStr($data['survey']);
            }

            if($data['expedient'] == ''){
                return false;
            }else{
                $data['expedient'] = cleanStr($data['expedient']);
            }

            return $db->query(" UPDATE  Expedients_Services
                                SET     poll = '" . $data['survey'] . "' 
                                WHERE   expedient = " . $data['expedient'] . "");
        }

        /**
        * Elimina un expediente
        *
        * @param array $data
        *
        * @return bool
        */
        public function deleteExpedient($data){
            $db = new DbHandler;
            $events = new Events();

            $data['expedientID'] = cleanStr($data['expedientID']);

            $res = $db->query(" SELECT  e.expNumLetter, e.expNumSecuence, e.expNumYear, e.expNumType, e.type, e.clientType
                                FROM    Expedients e
                                WHERE   e.expedientID = ". $data['expedientID'] . "");
            
            if(mysqli_num_rows($res) == 0 ){
                $number = null;
                $clientType = null;
            }else{
                $res = $db->resultToArray($res);
                $expNumLetter = $res[0]['expNumLetter'];
                $expNumSecuence = $res[0]['expNumSecuence'];
                $clientType = $res[0]['clientType'];                
                $year = $res[0]['expNumYear'];
                $expNumType = $res[0]['expNumType'];
                $type = $res[0]['type'];                  
            }

            //Eliminar expediente actual
            $result = $db->query("  UPDATE  Expedients
                                    SET     leavingDate = '" . date('Y-m-d H:i:s') . "'
                                    WHERE   expedientID = " . $data['expedientID'] . "");
            if(!$result){
                return array(false, null);
            }else{

                //Eliminar cremacion referente a ese expediente                
                $result = $db->query("  SELECT  crematoriumEvent as eventID
                                        FROM    Expedients 
                                        WHERE   expedientID = " . $data['expedientID'] . "");

                $eventID = $db->resultToArray($result)[0];                
                if($eventID != null){
                    $events->delete($eventID);
                }

                //Seleccionar los expedientes posteriores de tipo defuncion                          
                $res = $db->query("     SELECT  *
                                        FROM    Expedients 
                                        WHERE   leavingDate IS NULL AND
                                                expedientID > " . $data['expedientID']." AND
                                                entryDate >= '$year-01-01 00:00:00' AND 
                                                entryDate <= '$year-12-31 23:59:59' AND type = $type");

                $postExpedients = $db->resultToArray($res);

                foreach($postExpedients as $expedientPost){  
                    //Tipo de expediente
                    switch($expedientPost["type"]){

                        case '1': //DEFUNCION
                            
                            //Seleccionar los expedientes posteriores de tipo defuncion                          
                            $res = $db->query(" SELECT  *
                                                FROM    Expedients 
                                                WHERE   leavingDate IS NULL AND
                                                        expedientID > " . $data['expedientID']." AND
                                                        entryDate >= '$year-01-01 00:00:00' AND 
                                                        entryDate <= '$year-12-31 23:59:59' AND type = 1");

                            $postExpedients = $db->resultToArray($res);
                            switch ($expedientPost["clientType"]) {
                                case '1': //PARTICULARES    

                                    $newSecuenceNumber = intVal($expedientPost['expNumSecuence']) - 1; //Disminuir el numero de secuencia                                    
                                    $numberYear = substr($expedientPost["expNumYear"], -2);

                                    if($clientType == $expedientPost['clientType']){
                                        $newTypeNumber = $expedientPost['expNumType'] - 1;
                                    }else{
                                        $newTypeNumber = $expedientPost['expNumType'];
                                    }

                                    $newNumberExpedient = $newSecuenceNumber . ' ' . $expedientPost['expNumLetter'] . $newTypeNumber . '/' . $numberYear;

                                    // Actualiza el número del expediente y el número de secuencia dentro de la serie
                                    $db->query("UPDATE  Expedients
                                                SET     number =  '$newNumberExpedient', expNumSecuence = $newSecuenceNumber, expNumType = $newTypeNumber
                                                WHERE   expedientID = ".$expedientPost['expedientID']);
                                break;

                                case '2': //SEGUROS
                                   
                                    $newSecuenceNumber = intVal($expedientPost['expNumSecuence']) - 1; //Disminuir el numero de secuencia   
                                    $numberYear = substr($expedientPost["expNumYear"], -2);

                                    if($clientType == $expedientPost['clientType']){
                                        $newTypeNumber = $expedientPost['expNumType'] - 1;
                                    }else{
                                        $newTypeNumber = $expedientPost['expNumType'];
                                    }
                                    
                                    $newNumberExpedient = $newSecuenceNumber . ' ' . $expedientPost['expNumLetter'] . $newTypeNumber . '/' . $numberYear;
                                    
                                    // Actualiza el número del expediente y el número de secuencia dentro de la serie
                                    $db->query("UPDATE  Expedients
                                                SET     number =  '$newNumberExpedient', expNumSecuence = $newSecuenceNumber, expNumType = $newTypeNumber
                                                WHERE   expedientID = ".$expedientPost['expedientID']);
                                break;
                                case '3': //EMPRESAS

                                    $newSecuenceNumber = intVal($expedientPost['expNumSecuence']) - 1; //Disminuir el numero de secuencia   
                                    $numberYear = substr($expedientPost["expNumYear"], -2);
                                    
                                    if($clientType == $expedientPost['clientType']){
                                        $newTypeNumber = $expedientPost['expNumType'] - 1;
                                    }else{
                                        $newTypeNumber = $expedientPost['expNumType'];
                                    }

                                    $newNumberExpedient = $newSecuenceNumber . ' ' . $expedientPost['expNumLetter'] . $newTypeNumber . '/' . $numberYear;
                                    // Actualiza el número del expediente y el número de secuencia dentro de la serie
                                    $db->query("UPDATE  Expedients
                                                SET     number =  '$newNumberExpedient', expNumSecuence = $newSecuenceNumber, expNumType = $newTypeNumber
                                                WHERE   expedientID = ".$expedientPost['expedientID']);
                                break;                            
                            }
                        break;

                        case '2': //PRESUPUESTO                       

                            $newSecuenceNumber = intVal($expedientPost['expNumSecuence']) - 1; //Disminuir el numero de secuencia
                            $numberYear = substr($expedientPost["expNumYear"], -2);  
                            $newNumberExpedient = $expedientPost['expNumLetter'] .'-'. $newSecuenceNumber .'/'.$numberYear; //Nuevo numero                                
                        
                            // Actualiza el número del expediente y el número de secuencia dentro de la serie
                            $db->query("UPDATE  Expedients
                                        SET     number =  '$newNumberExpedient', expNumSecuence = $newSecuenceNumber
                                        WHERE   expedientID = ".$expedientPost['expedientID']);
                        break;

                        case '3': //VARIOS
                           
                            $newSecuenceNumber = intVal($expedientPost['expNumSecuence']) - 1; //Disminuir el numero de secuencia    
                            $newNumberExpedient = $expedientPost['expNumLetter'] .'-'. $newSecuenceNumber .'/'. substr($expedientPost['expNumYear'], 2, strlen($expedientPost['expNumYear'])); //Nuevo numero                                
                            
                            // Actualiza el número del expediente y el número de secuencia dentro de la serie
                            $db->query("UPDATE  Expedients
                                        SET     number =  '$newNumberExpedient', expNumSecuence = $newSecuenceNumber
                                        WHERE   expedientID = ".$expedientPost['expedientID']);
                        break;
                    }
                } 

                // Restore warehouse stock
                if($type != '2'){
                    $this->updateHiringStock($data['expedientID'], 1);
                }

                $invoice = new Invoices;
                $invoiceID = $invoice->updateOnDeleteExpedient($data['expedientID']);

                return array(true, $invoiceID);
            }
        }

        /**
         * Obtiene los expedientes activos
         * 
         * @return array Expedientes activos
         */
        public function getActiveExpedients(){
            $db = new DbHandler;

            $result = $db->query("  SELECT  e.expedientID, e.number, e.deceasedName, e.deceasedSurname 
                                    FROM    (Expedients e)
                                    WHERE   e.leavingDate IS NULL AND
                                            (e.status = 2 OR e.status = 6) AND
                                            e.type = 1
            ");
            
            if(mysqli_num_rows($result) == 0){
				return null;
			}else{
				return $db->resultToArray($result);
			}
        }

        /**
         * Asocia un expediente de varios a un expediente activo
         * 
         * @param int $expedient Expediente a asociar
         * @param int $associate Expediente asociado
         * @return array
         */
        public function associate($expedient, $associate, $mode){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $associate = cleanStr($associate);
           
            $result = $db->query("  SELECT  *
                                    FROM    Expedients e
                                    WHERE   e.expedientID = $expedient");

            $data = $db->resultToArray($result)[0];
            
            if(!$mode){ // If mode is true -> mode TPV, is false, normal model
    
                if($data['deceasedBirthdayLocation'] == ''){
                    $data['deceasedBirthdayLocation'] = 'null';
                }else{
                    $data['deceasedBirthdayLocation'] = "'" . $data['deceasedBirthdayLocation'] . "'";
                }
                if($data['deceasedLocation'] == ''){
                    $data['deceasedLocation'] = 'null';
                }else{
                    $data['deceasedLocation'] = "'" . $data['deceasedLocation'] . "'";
                }
                if($data['deceasedMortuary'] == ''){
                    $data['deceasedMortuary'] = 'null';
                }else{
                    $data['deceasedMortuary'] = "'" . $data['deceasedMortuary'] . "'";
                }
                if($data['deceasedDoctor'] == ''){
                    $data['deceasedDoctor'] = 'null';
                }else{
                    $data['deceasedDoctor'] = "'" . $data['deceasedDoctor'] . "'";
                }
                if($data['deceasedBirthday'] == ""){
                    $deceasedBirthday = '';
                }else{
                    $deceasedBirthday = 'deceasedBirthday = "' . $data['deceasedBirthday'] . '", ';
                }
                if($data['deceasedDate'] == ""){
                    $deceasedDate = '';
                }else{
                    $deceasedDate = 'deceasedDate = "' . $data['deceasedDate'] . '", ';
                }
                if($data['deceasedTime'] == ""){
                    $deceasedTime = '';
                }else{
                    $deceasedTime = 'deceasedTime = "' . $data['deceasedTime'] . '", ';
                }

                $db->query("    UPDATE  Expedients e
                                SET     e.deceasedName = '" . $data['deceasedName'] . "',
                                        e.deceasedSurname = '" . $data['deceasedSurname'] . "',
                                        e.deceasedNIF = '" . $data['deceasedNIF'] . "',
                                        e.deceasedMaritalStatus = '" . $data['deceasedMaritalStatus'] . "',
                                        e.deceasedFirstNuptials = '" . $data['deceasedFirstNuptials'] . "',
                                        e.deceasedSecondNuptials = '" . $data['deceasedSecondNuptials'] . "',
                                        e.deceasedGender = '" . $data['deceasedGender'] . "',
                                        e.deceasedChildOfFather = '" . $data['deceasedChildOfFather'] . "',
                                        e.deceasedChildOfMother = '" . $data['deceasedChildOfMother'] . "',
                                        e.deceasedNationality = '" . $data['deceasedNationality'] . "',
                                        $deceasedBirthday
                                        e.deceasedUsualAddress = '" . $data['deceasedUsualAddress'] . "',
                                        e.deceasedLocality = '" . $data['deceasedLocality'] . "',
                                        e.deceasedProvince = '" . $data['deceasedProvince'] . "',
                                        e.deceasedBirthdayLocation = {$data['deceasedBirthdayLocation']},
                                        e.deceasedLocation = {$data['deceasedLocation']},
                                        $deceasedDate
                                        $deceasedTime
                                        e.deceasedDoctor = {$data['deceasedDoctor']},
                                        e.deceasedDoctorCertificate = '" . $data['deceasedDoctorCertificate'] . "',
                                        e.deceasedCause = '" . $data['deceasedCause'] . "',
                                        e.deceasedTribunal = '" . $data['deceasedTribunal'] . "',
                                        e.deceasedTribunalNumber = '" . $data['deceasedTribunalNumber'] . "',
                                        e.deceasedMortuary = {$data['deceasedMortuary']},
                                        e.deceasedRoom = '" . $data['deceasedRoom'] . "',
                                        e.deceasedPanel = '" . $data['deceasedPanel'] . "'
                                WHERE   e.expedientID = $associate");
            }else{

                if($data['deceasedMortuary'] == ''){
                    $data['deceasedMortuary'] = 'null';
                }else{
                    $data['deceasedMortuary'] = "'" . $data['deceasedMortuary'] . "'";
                }

                $db->query("    UPDATE  Expedients e
                                SET     e.deceasedName = '" . $data['deceasedName'] . "',
                                        e.deceasedSurname = '" . $data['deceasedSurname'] . "',
                                        e.deceasedNIF = '" . $data['deceasedNIF'] . "',
                                        e.deceasedGender = '" . $data['deceasedGender'] . "',
                                        e.deceasedMortuary = {$data['deceasedMortuary']},
                                        e.deceasedRoom = '" . $data['deceasedRoom'] . "'
                                WHERE   e.expedientID = $associate");
            }

            return $db->query(" INSERT INTO Expedients_Associates(expedientID, associate)
                                VALUES ($associate, $expedient)");
        }

        /**
         * Obtiene los datos de un expediente asociado
         * 
         * @param int $expedient Expediente
         * @return array Datos
         */
        public function getAssociate($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            
            $result = $db->query("  SELECT  ea.ID, e.number, e.deceasedName, e.deceasedSurname
                                    FROM    Expedients e, Expedients_Associates ea
                                    WHERE   ea.associate = e.expedientID AND ea.expedientID = $expedient AND ea.leavingDate IS NULL");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0];
        }

        /**
         * Obtiene el ID de un 
         * 
         * @param int $expedient Expediente
         * @return array Datos
         */
        public function getAssociateExpedient($expedient, $associate){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $associate = cleanStr($associate);

            $result = $db->query("  SELECT  e.expedientID 
                                    FROM    Expedients e, Expedients_Associates ea
                                    WHERE   ea.associate = $expedient  AND ea.expedientID = $associate AND ea.expedientID = e.expedientID AND ea.leavingDate IS NULL");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['expedientID'];
        }

        /**
         * Obtiene el ID de un 
         * 
         * @param int $expedient Expediente
         * @return array Datos
         */
        public function getAssociateExpedientInfo($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            
            $result = $db->query("  SELECT  e.expedientID, e.number, e.tpv,
                                            (
                                                SELECT  MAX(eh.num_hiring)
                                                FROM    Expedients_Hirings eh
                                                WHERE   eh.expedient = e.expedientID
                                            ) as num_hiring
                                    FROM    Expedients e, Expedients_Associates ea
                                    WHERE   ea.associate = $expedient AND 
                                            ea.expedientID = e.expedientID AND 
                                            ea.leavingDate IS NULL
            ");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }

        /**
         * Elimina la asociación de un expediente a otro
         * 
         * @param array $expedient Expediente
         * @return bool
         */
        public function deleteAssociation($associateID){
            $db = new DbHandler;

            $associateID = cleanStr($associateID);

            return $db->query(" UPDATE  Expedients_Associates ea
                                SET     ea.leavingDate = '" . date('Y-m-d H:i:s') . "'
                                WHERE   ea.ID = $associateID");
        }

        /**
         * Elimina la asociación de un expediente a otro
         * 
         * @param array $expedient Expediente
         * @return bool
         */
        public function deleteAssociationExpedient($expedient, $associate){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $associate = cleanStr($associate);

            return $db->query(" UPDATE  Expedients_Associates ea
                                SET     ea.leavingDate = '" . date('Y-m-d H:i:s') . "'
                                WHERE   ea.expedientID = $expedient AND ea.associate = $associate");
        }

        /**
         * Obtiene los datos de un expedient
         * 
         * @param int $expedient Id del expediente
         * @return array
         */
        public function getExpedient($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT      e.type as expType, e.status, e.user, e.clientType, e.applicantLocation, e.familyContactLocation,
                                                e.client, e.deceasedBirthdayLocation, e.deceasedLocation, e.deceasedMortuary, e.deceasedDoctor, e.church,
                                                e.cemetery, e.niche, e.crematorium, e.crematoriumClient, e.funeralHome, e.moveFuneralHome, e.moveClient,
                                                e.moveCollection, e.moveDestination, e.requestTime, e.requestDate, e.policy, e.lossNumber, e.internalRef, e.capital, e.move,
                                                e.room, e.literal, e.cremation, e.applicantName, e.applicantSurname, e.applicantNIF, e.applicantAddress,
                                                e.applicantMail, e.applicantPhone, e.applicantMobilePhone, e.familyContactName, e.familyContactSurname, e.familyContactRelationship,
                                                e.familyContactNIF, e.familyContactAddress, e.familyContactMail, e.familyContactPhone, e.familyContactMobilePhone,
                                                e.otherContactName, e.otherContactPhone, e.otherContactRelationship, e.deceasedName, e.deceasedSurname,
                                                e.deceasedNIF, e.deceasedGender, e.deceasedMaritalStatus, e.deceasedMaritalStatusDescription, e.deceasedChildOfFather,
                                                e.deceasedChildOfMother, e.deceasedFirstNuptials, e.deceasedSecondNuptials, e.deceasedNationality,
                                                e.deceasedNationalityName, e.deceasedNationalityProvince, e.deceasedNationalityLocation, e.deceasedBirthday, e.deceasedUsualAddress, e.deceasedDate,
                                                e.deceasedTime, e.deceasedRoom, e.deceasedPanel, e.deceasedMortuaryAddress, e.deceasedDoctorCertificate, e.deceasedCause,
                                                e.deceasedTribunal, e.deceasedTribunalNumber, e.churchLabel, e.cemeteryLabel, e.funeralDate, e.funeralTime,
                                                e.regime, e.propertyName, e.funeralNicheNumber, e.funeralBusyNiche, 
                                                e.deceasedNiche, e.funeralDateNiche,  e.deceasedNiche2, e.funeralDateNiche2, e.deceasedNiche3, e.funeralDateNiche3,
                                                e.exhumation, e.nicheHeight, e.ecologicCoffin, e.crematoriumContactPerson, e.crematoriumContactPersonPhone,
                                                e.crematoriumIntroduction, e.crematoriumWaitOnRoom, e.crematoriumVaseBio, e.crematoriumPacemaker,
                                                e.crematoriumTechnical, e.authName, e.authDni, e.authDate, e.authTime, e.authPlace, e.funeralHomeEntryDate,
                                                e.funeralHomeEntryTime, e.coffin, e.otherCoffin, e.crematoriumReg, e.funeralReg, e.personalReg, e.mortuaryReg,
                                                e.tanatologicalPractice, e.responsibleUser, e.responsibleName, e.responsibleNIF, e.moveLeavingDate,
                                                e.moveLeavingTime, e.moveVia, e.moveJudicial, e.moveNotes, e.ceremonyDate, e.ceremonyTime, e.familyContactOtherLocation,
                                                e.familyContactOtherProvince, e.familyContactOtherCountry, e.familyContactNationality, e.otherInhumation,
                                                e.otherCeremony, e.arrivalTime, e.arrivalAirport, e.departureTime, e.airportOrigin, e.flightNumber, e.authContactPhone,
                                                e.agency, e.agencyContact, e.agencyContactPhone,
                                                e.crematoriumContactPhonePerson, e.moveFinalDestination, e.moveCollectionAddress, e.moveDestinationAddress,
                                                e.moveContactPerson, e.moveContactPhone, e.applicantNifType, e.familyContactNifType,
                                                es.arriveTime, es.arriveDate, e.deceasedNifType, e.otherDeceasedLocation, e.covid, 
                                                e.startVelacionDate, e.startVelacionTime, e.endVelacionDate, e.endVelacionTime,
                                                e.startVelacionDate2, e.startVelacionTime2, e.endVelacionDate2, e.endVelacionTime2,
                                                e.smokeOpacityDateStart, e.smokeOpacityTimeStart, e.smokeOpacityDateEnd, e.smokeOpacityTimeEnd, e.smokeOpacityLoadWeight,
                                                e.smokeOpacityBacharachScale, e.smokeOpacityDateReading, e.smokeOpacityTimeReading, e.smokeOpacityIncidents, e.smokeOpacityIncidentsNotes,
                                                e.notesExpedient, e.departureDate, e.arrivalDate 
                                    FROM        (Expedients e)
                                    LEFT JOIN   Expedients_Services es ON es.expedient = e.expedientID
                                    WHERE       e.expedientID = $expedient");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0];
        }

        /**
         * Obtiene las contrataciones de un expediente
         * 
         * @param int $expedient Id del expediente
         * @return array
         */
        public function getHiring($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $maxNumHiring = $this->getActiveHiring($expedient);

            $result = $db->query("  SELECT      eh.*
                                    FROM        (Expedients_Hirings eh, Products p, Products_Models pm) 
                                    WHERE       p.leavingDate IS NULL AND pm.leavingDate IS NULL AND
                                                eh.expedient = $expedient AND
                                                eh.model = pm.productModelID AND
                                                eh.product = p.productID AND
                                                eh.num_hiring = $maxNumHiring
                                    ORDER BY    p.blockBelow, p.orderBy, eh.ID
            ");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }

        /**
         * Asigna la contratación al nuevo expediente
         * 
         * @param int $expedient Id del expediente
         * @param array $hiring Contratación
         * @return bool
         */
        public function setHiring($expedient, $hiring){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $hiring['product'] = cleanStr($hiring['product']);
            $hiring['model'] = cleanStr($hiring['model']);
            $hiring['supplier'] = cleanStr($hiring['supplier']);
            $hiring['retail'] = cleanStr($hiring['retail']);
            $hiring['amount'] = cleanStr($hiring['amount']);
            $hiring['discount'] = cleanStr($hiring['discount']);
            $hiring['total'] = cleanStr($hiring['total']);
            $hiring['check'] = cleanStr($hiring['check']);
            $hiring['warehouse'] = cleanStr($hiring['warehouse']);

            // Get expedient price
            $result = $db->query("  SELECT  e.priceExp
                                    FROM    Expedients e
                                    WHERE   e.expedientID = $expedient
            ");
            $priceExp = 'null';
            if(mysqli_num_rows($result) > 0){
                $result = $db->resultToArray($result);
				$priceExp = $result[0]['priceExp'];
			}

            /**
             * No es necesario calcular si hay que escribir en Expedients_Hirings o Expedients_Hirings_Rectified ya que esta función se utiliza
             * cuando convertimos un prespuesto a una defunción o varios, entonces la tabla siempre será Expedients_Hirings
            **/

            // Calculate extraID
            $result = $db->query("  SELECT  MAX(ID) as id
                                    FROM    Expedients_Hirings");

            $maxID = mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0]['id'] : '1';
            $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 7);
            $extraID .= ($maxID+1);

            if($hiring['warehouse'] == null){
                $hiring['warehouse'] = 'null';
            }

            return $db->query(" INSERT INTO Expedients_Hirings(expedient, template, product, model, supplier, retail, amount, texts, discount, total, `check`, extraID, warehouse, priceExp)
                                VALUES ($expedient, null, " . $hiring['product'] . ", " . $hiring['model'] . ", " . $hiring['supplier'] . ", " . $hiring['retail'] . ",
                                        " . $hiring['amount'] . ", '', " . $hiring['discount'] . ", " . $hiring['total'] . ", " . $hiring['check'] . ", '$extraID',
                                        " . $hiring['warehouse'] . ", $priceExp)");
        }

        /**
         * Elimina las contrataciones de un expediente
         * 
         * @param int $expedient Id del expediente
         * @return bool
         */
        public function unsetHirings($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            /**
             * No es necesario calcular si hay que escribir en Expedients_Hirings o Expedients_Hirings_Rectified ya que esta función se utiliza
             * cuando convertimos un prespuesto a una defunción o varios, entonces la tabla siempre será Expedients_Hirings
            **/
            
            return $db->query("DELETE FROM Expedients_Hirings WHERE expedient = $expedient");
        }
        
        /**
        * Obtiene los estados de los expedientes
        *
        * @return array
        */
        public function getExpedientStatus(){
            $db = new DbHandler;
            
            $result = $db->query("  SELECT  *
                                    FROM    Expedients_Status
                                    WHERE   expedientStatusID != 1");
            
            if(mysqli_num_rows($result) == 0){
				return null;
			}else{
				return $db->resultToArray($result);
			}
        }

        /**
        * Obtiene los tipos de expedientes
        *
        * @return array
        */
        public function getExpedientType($data){
            $db = new DbHandler;

            $data = cleanStr($data);
            
            $result = $db->query("  SELECT *
                                    FROM   Expedients_Types 
                                    WHERE  name = '" . $data . "'");
            
            if(mysqli_num_rows($result) == 0){
				return null;
			}else{
				return $db->resultToArray($result);
			}
        }

        /**
        * Obtiene los datos para visitas de un expedientes
        *
        * @return array
        */
        public function getExpedientVisit($data){
            $db = new DbHandler;
            
            $data['expedientID'][0]['expedient'] = cleanStr($data['expedientID'][0]['expedient']);

            $result = $db->query("SELECT    e.deceasedName, e.deceasedSurname, e.number, e.deceasedGender,
                                            e.funeralHomeEntryTime, e.funeralHomeEntryDate, m.name, e.requestTime, 
                                            e.deceasedRoom, e.funeralTime, e.funeralDate, e.requestDate,
                                            e.startVelacionDate, e.startVelacionTime
                                  FROM      Expedients e
                                  LEFT JOIN Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                  WHERE     expedientID = " . $data['expedientID'][0]['expedient']);
            
            if(mysqli_num_rows($result) == 0){
				return null;
			}else{
				return $db->resultToArray($result);
			}
        }

        /**
        * Obtiene el cliente asociado al expediente a editar
        *
        * @param array $data
        *
        * @return array
        */
        public function getClient($data){
            $db = new DbHandler;

            $data = cleanStr($data);
            
            $result = $db->query("SELECT    c.*, l.name as locationName, l.postalCode, l.province, c.price
                                  FROM      (Expedients e, Clients c)
                                  LEFT JOIN Locations l ON c.location = l.locationID
                                  WHERE     e.client = c.clientID AND 
                                            e.expedientID = " . $data . "");
            
            if(mysqli_num_rows($result) == 0){
				return null;
			}else{
				return $db->resultToArray($result);
			}
        }

        /**
        * Obtiene la tarifa asociada a una plantilla
        *
        * @param array $data
        *
        * @return array
        */
        public function getClientExp($data){
            $db = new DbHandler;

            $data = cleanStr($data);
            
            $result = $db->query("SELECT t.price
                                  FROM   Templates t
                                  WHERE  t.templateID = " . $data . "");
            
            if(mysqli_num_rows($result) == 0){
				return null;
			}else{
				return $db->resultToArray($result);
			}
        }
        
        /**
        * Obtiene el estado del expediente a editar
        *
        * @param array $data
        *
        * @return array
        */
        public function getStatus($data){
            $db = new DbHandler;

            $data = cleanStr($data);
            
            $result = $db->query("  SELECT  s.expedientStatusID, s.name
                                    FROM    Expedients e, Expedients_Status s
                                    WHERE   e.status = s.expedientStatusID AND 
                                            e.expedientID = " . $data . "");
            
            if(mysqli_num_rows($result) == 0){
				return null;
			}else{
				return $db->resultToArray($result);
			}
        }
        
        /**
        * Obtiene la funeraria asociada al expediente a editar
        *
        * @param array $data
        *
        * @return array
        */
        public function getFuneralHome($data){
            $db = new DbHandler;

            $data = cleanStr($data);
            
            $result = $db->query("  SELECT  f.funeralHomeID, f.name, f.nif, f.phones, f.fax
                                    FROM    Expedients e, FuneralHomes f
                                    WHERE   e.funeralHome = f.funeralHomeID AND 
                                            e.expedientID = " . $data . "");
            
            if(mysqli_num_rows($result) == 0){
				return null;
			}else{
				return $db->resultToArray($result);
			}
        }

        /**
         * Obtiene la sala del expediente
         * 
         * @param int $expedient Expediente
         * @return int
         */
        public function getDeceasedRoom($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT  e.deceasedRoom
                                    FROM    Expedients e
                                    WHERE   e.expedientID = $expedient");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['deceasedRoom'];
        }
        
        /**
        * Modifica el estado del expediente
        *
        * @param array $expedientID, $status
        *
        * @return array
        */
        public function setStatusExpedient($expedientID, $status){
            $db = new DbHandler;

            $expedientID = cleanStr($expedientID);
            $status = cleanStr($status);
            
            return $db->query(" UPDATE  Expedients
                                SET     status = " . $status . "
                                WHERE   expedientID = " . $expedientID . "");
        }

        /**
         * Obtiene los datos del expediente para mostrar en la vista de logs del expediente
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getExpedientLogs($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT  e.expedientID, e.number, e.deceasedName, e.deceasedSurname, e.deceasedGender, e.tpv
                                    FROM    Expedients e
                                    WHERE   e.expedientID = $data");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }

        /**
         * Comprueba si ya hay una cremación para una fecha dada
         * 
         * @param int $start Fecha de inicio
         * @param int $end Fecha de fin
         * @return bool
         */
        public function checkCremationTime($start, $end, $crematorium){
            $db = new DbHandler;

            $crematorium = cleanStr($crematorium);
            $start = cleanStr($start);
            $end = cleanStr($end);

            $start = date('Y-m-d H:i:s', $start);
            $end = date('Y-m-d H:i:s', $end);

            $result = $db->query("  SELECT  e.ID
                                    FROM    Events e, Expedients ex
                                    WHERE   e.type = 1 AND
                                            e.expedient = ex.expedientID AND
                                            ex.crematorium = $crematorium AND
                                            (
                                                ('$start' BETWEEN e.start AND e.end) OR
                                                ('$end' BETWEEN e.start AND e.end)
                                            ) AND (
                                                e.status = 6 OR e.status = 7
                                            ) AND e.leavingDate IS NULL");

            return mysqli_num_rows($result) == 0 ? false : true;
        }

        /**
         * Comprueba si ya hay una cremación para una fecha dada
         * 
         * @param int $start Fecha de inicio
         * @param int $end Fecha de fin
         * @param int $expedient Id del expediente
         * @return bool
         */
        public function checkCremationTimeEdit($start, $end, $expedient, $crematorium){
            $db = new DbHandler;

            $crematorium = cleanStr($crematorium);
            $start = cleanStr($start);
            $end = cleanStr($end);
            $expedient = cleanStr($expedient);

            $start = date('Y-m-d H:i:s', $start);
            $end = date('Y-m-d H:i:s', $end);

            $result = $db->query("  SELECT  e.ID
                                    FROM    Events e, Expedients ex
                                    WHERE   e.type = 1 AND
                                            e.expedient = ex.expedientID AND
                                            ex.crematorium = $crematorium AND
                                            (
                                                ('$start' BETWEEN e.start AND e.end) OR
                                                ('$end' BETWEEN e.start AND e.end)
                                            ) AND (
                                                e.status = 6 OR e.status = 7
                                            ) AND e.leavingDate IS NULL AND
                                            ex.leavingDate IS NULL AND
                                            e.expedient != $expedient");

            return mysqli_num_rows($result) == 0 ? false : true;
        }

        /* **************** Expedientes - Contratación **************** */
        /**
        * Añade los datos de una contratación la primera vez que se crea el expediente
        *
        * @param array $data
        *
        * @return bool
        */
        public function createHiringsFirst($data, $priceID){
            $db = new DbHandler;
            $products = new Products;

            $data = cleanStr($data);
            
            $result = $db->query("  SELECT  year(requestDate) as year, entryDate
                                    FROM    Expedients
                                    WHERE   expedientID = $data");

            if(mysqli_num_rows($result) > 0){
                $aux = $db->resultToArray($result)[0];
                $year = $aux['year'];
                $entryDate = strtotime($aux['entryDate']);
            }else{
                $year = date('Y');
                $entryDate = 0;
            }

            $datos = $products->getProductsHiring();
            if($datos != null){
                foreach($datos as $indexProduc=>$product){
                    
                    // PATCH ADDED 28/10/2022 TO FIXED: 
                    //  When the contract is created, a supplier and default model are associated. 
                    //  It may happen that the non-provider is associated with a model that does not belong to it.
                    
                    $orderBy = '';
                    if(intval($_SESSION['company']) >= 6){
                        $orderBy = ' ORDER BY s.supplierID DESC';
                    }
                  
                    $result = $db->query("  SELECT      pp.ID as product_retail_id, 
                                                        pm.productModelID, 
                                                        pm.supplier, 
                                                        st.ID as warehouse
                                            FROM        (Products_Models pm,  Suppliers s, Products_Retails pp)
                                            LEFT JOIN   Stock st ON st.model = pm.productModelID
                                            WHERE       pm.product = " . $product['productID'] . " AND 
                                                        pm.leavingDate IS NULL AND 
                                                        pm.supplier = s.supplierID AND 
                                                        s.leavingDate IS NULL AND 
                                                        pp.model = pm.productModelID AND 
                                                        pp.year = $year
                                            $orderBy
                                            LIMIT     1
                    ");
    
                    if(mysqli_num_rows($result) > 0){
                        $result = $db->resultToArray($result)[0];
    
                        $retail = $result['product_retail_id'];
                        $model = $result['productModelID'];
                        $supplier = $result['supplier'];
                        $warehouse = $result['warehouse'] == null ? '0' : $result["warehouse"];

                        /**
                         * No es necesario calcular si hay que escribir en Expedients_Hirings o Expedients_Hirings_Rectified ya que esta función se utiliza
                         * cuando creamos un expediente (Normal o TPV) para crear su contractación asociada
                         **/

                        $result = $db->query("  SELECT  MAX(ID) as id
                                                FROM    Expedients_Hirings");

                        $maxID = mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0]['id'] : '1';
                        $extraID = $maxID.$indexProduc;

                        $hiringId = 'null';
                        if($retail != null){
    
                            $result = $db->query("  INSERT INTO Expedients_Hirings (
                                                        expedient, template, product, model, supplier, 
                                                        retail, amount, texts, discount, total, `check`, extraID, warehouse, priceExp
                                                    ) 
                                                    VALUES(
                                                        " . $data . ", null, " . $product['productID'] . ", " . $model . ", " . $supplier . ", 
                                                        " . $retail . ", 1, '', 0, 0, 0, '$extraID', 0, $priceID
                                                    )
                            ");

                            $hiringId = $db->getLastInsertId();
                        }

                        // Creación de los servicios dinámicos para cada producto
                        $actions = $db->query(" SELECT  pa.action, pa.checked, p.orderType
                                                FROM    Products_Actions pa, Products p
                                                WHERE   pa.product = " . $product['productID'] . " AND
                                                        pa.checked = 1 AND
                                                        pa.product = p.productID
                        ");
                        $actions = $db->resultToArray($actions);

                        foreach($actions as $action){
                            if($action['orderType'] == '3'){
                                $actionStatus = 1;
                            }else{
                                $actionStatus = 0;
                            }

                            if($entryDate >= 1716328800){
                                $db->query("INSERT INTO Services_Auto(service, model, action, value, status, hiring)
                                            VALUES(" . $data . ", " . $model . ", " . $action['action'] . ", 0, $actionStatus, $hiringId)");
                            }else{
                                $db->query("INSERT INTO Services_Auto(service, model, action, value, status)
                                            VALUES(" . $data . ", " . $model . ", " . $action['action'] . ", 0, $actionStatus)");
                            }
                        }
                    }
                }
            }

            return true;
        }

        /**
        * Añade los datos de los productos de una plantilla la primera vez que se crea
        *
        * @param array $data
        *
        * @return bool
        */
        public function createHiringsFirstTemplate($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $products = new Products();
            $year = date('Y');

            foreach($products->getProductsHiring() as $product){

                $result = $db->query("SELECT    pm.productModelID, pm.supplier, st.ID as warehouse
                                      FROM      (Products_Models pm,  Suppliers s, Products_Retails pp)
                                      LEFT JOIN Stock st ON st.model = pm.productModelID
                                      WHERE     pm.product = " . $product['productID'] . " AND 
                                                pm.leavingDate IS NULL AND pm.supplier = s.supplierID AND s.leavingDate IS NULL AND pp.model = pm.productModelID AND pp.year =  $year
                                      LIMIT     1");

                if(mysqli_num_rows($result) > 0){
                    $result = $db->resultToArray($result)[0];

                    $model = $result['productModelID'];
                    $supplier = $result['supplier'];

                    $result = $db->query("INSERT INTO Templates_Products(template, product, model, supplier, amount, texts, discount, total, `check`) 
                                          VALUES( " . $data . ", " . $product['productID'] . ", " . $model . ", " . $supplier . ", 1, '', 0, 0, 0)");

                }
            }

            return true;
        }

        /**
        * Obtiene los datos de una contratación
        *
        * @param array $data
        *
        * @return array
        */
        public function readHirings($data){
            $db = new DbHandler;

            $data['expedient'] = cleanStr($data['expedient']);

            $maxNumHiring = $this->getActiveHiring($data['expedient']);

            $result = $db->query("  SELECT  eh.amount, eh.texts, eh.discount, eh.total, 
                                            p.productID, p.name, 
                                            pm.productModelID, pm.name, 
                                            s.supplierID, s.name, 
                                            pr.model, pr.purchasePrice
                                    FROM    Expedients_Hirings eh, Products p, Products_Models pm, Suppliers s, Products_Retails pr
                                    WHERE   eh.product = p.productID AND
                                            eh.model = pm.productModelID AND 
                                            eh.supplier = s.supplierID AND 
                                            eh.retail = pr.model AND 
                                            eh.num_hiring = $maxNumHiring AND
                                            eh.expedient = " . $data['expedient'] . "");

            if(mysqli_num_rows($result) == 0){
				return null;
			}else{
				return $db->resultToArray($result);
			}
        }

        /**
        * Obtiene los datos de los presupuestos de un expediente
        *
        * @param array $data
        *
        * @return array
        */
        public function readBudgets($data){
            $db = new DbHandler;

            $data['expedient'] = cleanStr($data['expedient']);

            $result = $db->query("SELECT *
                                  FROM   Budgets b
                                  WHERE  b.expedient = " . $data['expedient'] . "");

            if(mysqli_num_rows($result) == 0){
				return null;
			}else{
				return $db->resultToArray($result);
			}
        }

        /**
        * Obtiene los datos de las facturas proforma de un expediente
        *
        * @param array $data
        *
        * @return array
        */
        public function readInvoicesProforma($data){
            $db = new DbHandler;

            $data['expedient'] = cleanStr($data['expedient']);

            $result = $db->query("SELECT *,
                                         REPLACE(invpr.numInvoice, '/', '-') as number
                                  FROM   Invoices_Proforma invpr
                                  WHERE  invpr.expedient = " . $data['expedient'] . "");

            if(mysqli_num_rows($result) == 0){
				return null;
			}else{
				return $db->resultToArray($result);
			}
        }

        /**
        * Obtiene los datos de las facturas de un expediente
        *
        * @param array $data
        *
        * @return array
        */
        public function readInvoices($data){
            $db = new DbHandler;

            $data['expedient'] = cleanStr($data['expedient']);

            $result = $db->query("SELECT    i.ID, 
                                            i.creationDate, 
                                            REPLACE(i.generatedInvoiceNumber, '/', '-') as number,
                                            i.createDate,
                                            i.invoice_type,
                                            i.rectified_type,
                                            CONCAT(u.name, ' ', u.surname) as user_info
                                  FROM      Invoices i
                                  LEFT JOIN Users u ON i.user = u.userID
                                  WHERE     i.leavingDate IS NULL AND
                                            i.expedient = " . $data['expedient'] . "
                                  ORDER BY  i.createDate ASC
            ");

            if(mysqli_num_rows($result) == 0){
				return null;
			}else{
				return $db->resultToArray($result);
			}
        }

        /**
        * Obtiene los datos de una contratación en base a la plantilla dada
        *
        * @param array $data
        *
        * @return array
        */
        public function readHiringsByTemplate($data){
            $db = new DbHandler;

            $data['template'] = cleanStr($data['template']);

            $result = $db->query("  SELECT      eh.amount, eh.texts, eh.discount, eh.total, 
                                                p.productID, p.name, 
                                                pm.productModelID, pm.name, 
                                                s.supplierID, s.name, 
                                                pr.model, pr.purchasePrice
                                    FROM        Expedients_Hirings eh, Products p, Products_Models pm, Suppliers s, Products_Retails pr
                                    WHERE       eh.product = p.productID AND
                                                eh.model = pm.productModelID AND 
                                                eh.supplier = s.supplierID AND 
                                                eh.retail = pr.model AND 
                                                eh.template = " . $data['template'] . "
                                    ORDER BY    p.blockBelow, p.orderBy
            ");

            if(mysqli_num_rows($result) == 0){
				return null;
			}else{
				return $db->resultToArray($result);
			}
        }

        /**
        * Modifica los datos de una contratación (checks)
        *
        * @param array $data
        *
        * @return bool
        */
        public function updateHirings($expedient, $data, $companyId){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $data[0] = cleanStr($data[0]);
            $data[1] = cleanStr($data[1]);
            $data[3] = cleanStr($data[3]);
            $data[4] = cleanStr($data[4]);
            $data[5] = cleanStr($data[5]);
            $data[7] = cleanStr($data[7]);
            $data[9] = cleanStr($data[9]);
            $data[10] = cleanStr($data[10]);
            $data[11] = cleanStr($data[11]);

            $hiringIdToRet = $data[0];

            // Get expedient price
            $result = $db->query("  SELECT  e.priceExp
                                    FROM    Expedients e
                                    WHERE   e.expedientID = $expedient
            ");
            $priceExp = 'null';
            if(mysqli_num_rows($result) > 0){
                $result = $db->resultToArray($result);
				$priceExp = $result[0]['priceExp'];
			}

            // Get expedient hirings data
            $result = $db->query("  SELECT  eh.num_hiring, eh.rectified_type
                                    FROM    Expedients_Hirings eh
                                    WHERE   eh.expedient = $expedient AND
                                            eh.num_hiring = (
                                                SELECT  MAX(eh2.num_hiring)
                                                FROM    Expedients_Hirings eh2
                                                WHERE   eh2.expedient = eh.expedient
                                            )
                                    LIMIT   1
            ");
            $numHiring = 0;
            $rectifiedType = 'null';
            if(mysqli_num_rows($result) > 0){
                $result = $db->resultToArray($result);
				$numHiring = $result[0]['num_hiring'];
				$rectifiedType = $result[0]['rectified_type'] == null ? 'null' : $result[0]['rectified_type'];
			}

            if($data[0] != ""){
                // Actualización de stock
                $result = $db->query("  SELECT  eh.check, eh.amount, eh.model, eh.warehouse, eh.supplier
                                        FROM    Expedients_Hirings eh, Products p, Expedients e
                                        WHERE   eh.ID = " . $data[0] . " AND
                                                eh.product = p.productID AND
                                                p.type = 2 AND
                                                eh.expedient = e.expedientID AND
                                                e.type != 2");

                if(mysqli_num_rows($result) > 0){
                    $stock = new Stock;

                    $hiring = $db->resultToArray($result)[0];

                    $currentCheck = $hiring['check'];
                    $currentAmount = $hiring['amount'];
                    $currentModel = $hiring['model'];
                    $currentWarehouse = $hiring['warehouse'];
                    $warehouse = $data[11];
                    $newModel = $data[4];

                    $newAmount = $data[7];

                    if($data[1] == 1){
                        if($currentCheck == 0){
                            $stock->delStock($warehouse, $newModel, $newAmount);
                        }else{
                            if($currentWarehouse == $warehouse){
                                if($currentModel == $newModel){
                                    if($currentAmount != $newAmount){
                                        $stock->addStock($warehouse, $newModel, $currentAmount);
                                        $stock->delStock($warehouse, $currentModel, $newAmount);
                                    }
                                }else{
                                    $stock->addStock($warehouse, $currentModel, $currentAmount);
                                    if($newModel != ''){
                                        $stock->delStock($warehouse, $newModel, $newAmount);
                                    }
                                }
                            }else{
                                if($currentWarehouse == null){
                                    $currentWarehouse = $warehouse;
                                }
                                if($currentModel == $newModel){
                                    $stock->addStock($currentWarehouse, $currentModel, $currentAmount);
                                    $stock->delStock($warehouse, $currentModel, $newAmount);
                                }else{
                                    $stock->addStock($currentWarehouse, $currentModel, $currentAmount);
                                    if($newModel != ''){
                                        $stock->delStock($warehouse, $newModel, $newAmount);
                                    }
                                }
                            }
                        }
                    }else{
                        if($currentCheck == 1){
                            $stock->addStock($currentWarehouse, $currentModel, $currentAmount);
                        }
                    }
                }

                $query = $db->query("   SELECT  eh.model, eh.amount, eh.supplier
                                        FROM    Expedients_Hirings eh
                                        WHERE   eh.ID = {$data[0]}
                ");

                if(mysqli_num_rows($query) == 0){
                    return;
                }

                $resultAux = $db->resultToArray($query)[0];
                $oldModel = $resultAux['model'];
                $oldAmount = $resultAux['amount'];
                $oldSupplier = $resultAux['supplier'];

                if($data[5] == '' || $data[4] == ''){

                    $db->query("UPDATE  Expedients_Hirings
                                SET     `check` = " . $data[1] . "
                                WHERE   ID = " . $data[0]);
                }else{

                    $db->query("UPDATE  Expedients_Hirings
                                SET     `check` = " . $data[1] . ",
                                        product = " . $data[3] . ",
                                        model = " . $data[4] . ",
                                        supplier = " . $data[5] . ",
                                        retail = " . $data[4] . ",
                                        amount = " . $data[7] . ",
                                        discount = " . $data[9] . ",
                                        total = " . $data[10] . ",
                                        warehouse = " . $data[11] . "
                                WHERE   ID = " . $data[0]);
                }

                // TEXTOS
                if($data[8] != ""){
                    foreach($data[8] as $text){
                        $text[0] = cleanStr($text[0]); 
                        $text[1] = cleanStr($text[1]); 
                        $text[2] = cleanStr($text[2]); 

                        $result = $db->query("  SELECT  ID
                                                FROM    Expedients_Texts
                                                WHERE   hiring = $data[0] AND
                                                        rowIndex = $text[0]");

                        if(mysqli_num_rows($result) == 0){
                            $db->query("INSERT INTO Expedients_Texts(hiring, rowIndex, value, discount)
                                        VALUES ($data[0], $text[0], '$text[1]', $text[2])");
                        }else{
                            $db->query("UPDATE  Expedients_Texts
                                        SET     value = '$text[1]',
                                                discount = $text[2]
                                        WHERE   hiring = $data[0] AND
                                                rowIndex = $text[0]");
                        }
                    }

                    $result = $db->query("  SELECT      ID
                                            FROM        Expedients_Texts
                                            WHERE       hiring = $data[0] AND
                                                        rowIndex >= $data[7]
                                            ORDER BY    rowIndex ASC");

                    if(mysqli_num_rows($result) > 0){
                        $textsShow = $db->resultToArray($result);

                        foreach($textsShow as $element){
                            $db->query("DELETE FROM Expedients_Texts WHERE ID = {$element['ID']}");
                        }
                    }
                }

                // PRE-ORDERS
                if($data[1] == 0){
                    $existPreOrder = $db->query("   SELECT  *
                                                    FROM    Pre_Orders 
                                                    WHERE   hiring = " . $data[0]);

                    if(mysqli_num_rows($existPreOrder) > 0){
                        $db->query("UPDATE  Pre_Orders 
                                    SET     leavingDate = " . time() . "
                                    WHERE   hiring = " . $data[0]);

                        $query = $db->query("   SELECT  ol.ID
                                                FROM    Orders_Lines ol, Orders o, Pre_Orders  po
                                                WHERE   ol.order = o.ID AND
                                                        o.ID = po.order AND
                                                        po.hiring = {$data[0]} AND
                                                        ol.model = $oldModel");

                        if(mysqli_num_rows($query) > 0){
                            $orderLine = $db->resultToArray($query)[0]['ID'];

                            $db->query("DELETE FROM Orders_Lines
                                        WHERE   ID = $orderLine");
                        }
                    }
                }else{
                    $resultCompany = $db->query("   SELECT  s.value
                                                    FROM    Settings s
                                                    WHERE   s.name = 'company'");

                    $companyId = mysqli_num_rows($resultCompany) == 0 ? null : $db->resultToArray($resultCompany)[0]['value'];

                    if($data[5] != $companyId && $data[5] != ''){
                        $preOrder = $db->query("SELECT  *
                                                FROM    Products p
                                                WHERE   p.productID = $data[3] AND
                                                        p.preOrder = 1");
                                                        
                        if(mysqli_num_rows($preOrder) > 0){
                            $existPreOrder = $db->query("   SELECT  count(ID) as amount
                                                            FROM    Pre_Orders 
                                                            WHERE   hiring = " . $data[0]);
    
                            $existPreOrder = $db->resultToArray($existPreOrder)[0]['amount'];
    
                            if($existPreOrder == 0){
                                // COMPRUEBA QUE EL PRODUCTO - MODELO TENGA UN PROVEEDOR DISTINTO DE 'NO PROVEEDOR'
                                $hasSupplier = $db->query(" SELECT  name
                                                            FROM    Suppliers
                                                            WHERE   supplierID = " . $data[5]);
    
                                $hasSupplier = $db->resultToArray($hasSupplier)[0]['name'];
                                if($hasSupplier != 'No proveedor'){
                                    if($_SESSION['company'] == 1){
                                        if($data[3] != 58 && $data[3] != 68){
                                            $db->query("INSERT INTO Pre_Orders (hiring, sentEmail)
                                                        VALUES (" . $data[0] . ", 0)");
                                        }
                                    }else{
                                        $db->query("INSERT INTO Pre_Orders (hiring, sentEmail)
                                                    VALUES (" . $data[0] . ", 0)");
                                    }
                                }
                            }else{
                                $result = $db->query("  SELECT  o.ID, YEAR(e.entryDate) as year
                                                        FROM    Pre_Orders  po, Orders o, Expedients_Hirings eh, Expedients e
                                                        WHERE   po.order = o.ID AND
                                                                po.hiring = {$data[0]} AND
                                                                po.order IS NOT NULL AND
                                                                po.hiring = eh.ID AND
                                                                eh.expedient = e.expedientID");

                                if(mysqli_num_rows($result) > 0){
                                    $info = $db->resultToArray($result)[0];

                                    $order = $info['ID'];
                                    $expedientYear = $info['year'];

                                    if($oldModel != $data[4]){
                                        $query = $db->query("   SELECT  ol.ID
                                                                FROM    Orders_Lines ol
                                                                WHERE   ol.order = $order AND
                                                                        ol.model = $oldModel");

                                        $orderLine = mysqli_num_rows($query) == 0 ? null : $db->resultToArray($query)[0]['ID'];

                                        $query = $db->query("   SELECT  pr.purchasePrice
                                                                FROM    Products_Retails pr
                                                                WHERE   pr.model = {$data[4]} AND
                                                                        pr.year = $expedientYear");

                                        $purchasePrice = mysqli_num_rows($query) == 0 ? null : $db->resultToArray($query)[0]['purchasePrice'];
                                        
                                        if($orderLine != null && $purchasePrice != null){
                                            $db->query("UPDATE  Orders_Lines
                                                        SET     model = {$data[4]},
                                                                amount = {$data[7]},
                                                                price = $purchasePrice
                                                        WHERE   ID = $orderLine");
                                        }
                                    }

                                    if($oldAmount != $data[7]){
                                        $query = $db->query("   SELECT  ol.ID
                                                                FROM    Orders_Lines ol
                                                                WHERE   ol.order = $order AND
                                                                        ol.model = $oldModel");

                                        $orderLine = mysqli_num_rows($query) == 0 ? null : $db->resultToArray($query)[0]['ID'];

                                        $db->query("UPDATE  Orders_Lines
                                                    SET     amount = {$data[7]}
                                                    WHERE   ID = $orderLine");
                                    }

                                    // When current supplier is different from new supplier.
                                    // Check if exists an associated order. If supplier changes, remove from current order and generate a pre order
                                    if($oldSupplier != $data[5]){
                                        // Get associated pre order
                                        $result = $db->query("  SELECT  po.ID, po.order
                                                                FROM    Pre_Orders po
                                                                WHERE   po.hiring = {$data[0]}");

                                        if(mysqli_num_rows($result) > 0){
                                            $preOrderInfo = $db->resultToArray($result)[0];
                                            if($preOrderInfo['order'] != null){
                                                // Gets order lines
                                                $result = $db->query("  SELECT  ol.ID
                                                                        FROM    Orders_Lines ol
                                                                        WHERE   ol.order = {$preOrderInfo['order']} AND
                                                                                ol.model = {$data[4]} AND
                                                                                ol.amount = {$data[7]}");

                                                if(mysqli_num_rows($result) > 0){
                                                    $orderLineId = $db->resultToArray($result)[0]['ID'];

                                                    $result = $db->query("  DELETE FROM Orders_Lines
                                                                            WHERE ID = $orderLineId");

                                                    $db->query("UPDATE  Pre_Orders 
                                                                SET     `order` = null
                                                                WHERE   hiring = " . $data[0]);
                                                }
                                            }
                                        }
                                    }
                                }

                                if($oldSupplier == $data[5]){
                                    $result = $db->query("  SELECT	o.ID, YEAR(e.entryDate) as year
                                                            FROM	Pre_Orders po, Expedients_Hirings eh, Expedients e, Orders o
                                                            WHERE	po.leavingDate IS NOT NULL AND
                                                                    po.hiring = {$data[0]} AND
                                                                    po.hiring = eh.ID AND
                                                                    eh.expedient = e.expedientID AND
                                                                    po.order = o.ID");
    
                                    $db->query("UPDATE  Pre_Orders 
                                                SET     leavingDate = null
                                                WHERE   hiring = " . $data[0]);
    
                                    if(mysqli_num_rows($result) > 0){
                                        $info = $db->resultToArray($result)[0];
    
                                        $order = $info['ID'];
                                        $expedientYear = $info['year'];
    
                                        $query = $db->query("   SELECT  pr.purchasePrice
                                                                FROM    Products_Retails pr
                                                                WHERE   pr.model = {$data[4]} AND
                                                                        pr.year = $expedientYear");
    
                                        $purchasePrice = mysqli_num_rows($query) == 0 ? null : $db->resultToArray($query)[0]['purchasePrice'];
    
                                        if($purchasePrice != null){
                                            $db->query("INSERT INTO Orders_Lines(`order`, model, amount, price)
                                                        VALUES ($order, {$data[4]}, {$data[7]}, $purchasePrice)");
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }else if($data[4] != '' && $data[5] != ''){
                // Calculate extraID
                $result = $db->query("  SELECT  MAX(ID) as id
                                        FROM    Expedients_Hirings");

                $maxID = mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0]['id'] : '1';
                $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 7);
                $extraID .= ($maxID+1);


                $db->query("INSERT INTO Expedients_Hirings (expedient, `check`, product, model, supplier, retail, amount, discount, total, extraID, warehouse, priceExp, num_hiring, rectified_type)
                            VALUES ($expedient, " . $data[1] . ", " . $data[3] . ", " . $data[4] . ", " . $data[5] . ", 
                                    " . $data[4] . ", " . $data[7] . ", " . $data[9] . ", " . $data[10] . ", '$extraID', " . $data[11] . ", $priceExp, $numHiring, $rectifiedType)");

                $hiringID = $db->getLastInsertId();
                
                $hiringIdToRet = $hiringID;

                if($data[8] != ""){
                    foreach($data[8] as $text){
                        $db->query("INSERT INTO Expedients_Texts (hiring, rowIndex, value, discount)
                                    VALUES ($hiringID, $text[0], '$text[1]', $text[2])");
                    }
                }

                $preOrder = $db->query("SELECT  *
                                        FROM    Products p
                                        WHERE   p.productID = $data[3] AND
                                                p.preOrder = 1");
                                                        
                if(mysqli_num_rows($preOrder) > 0){
                    if($data[1] == 1){
                        $hasSupplier = $db->query(" SELECT  name
                                                    FROM    Suppliers
                                                    WHERE   supplierID = " . $data[5]);
        
                        $hasSupplier = $db->resultToArray($hasSupplier)[0]['name'];
        
                        if($hasSupplier != 'No proveedor' && $data[5] != $companyId){
                            $db->query("INSERT INTO Pre_Orders (hiring, sentEmail) VALUES ($hiringID, 0)");
                        }
                    }
                }

                // Get expedient type
                $result = $db->query("  SELECT  e.type
                                        FROM    Expedients e
                                        WHERE   e.expedientID = " . $expedient);
                
                $expedientType = $db->resultToArray($result)[0]['type'];

                if($expedientType != 2){
                    // Stock
                    $result = $db->query("  SELECT  p.type
                                            FROM    Products_Models pm, Products p
                                            WHERE   pm.product = p.productID AND
                                                    pm.productModelID = " . $data[4]);
                    
                    $type = $db->resultToArray($result)[0]['type'];
    
                    if($type == 2){
                        $stock = new Stock;
                        $stock->delStock($data[11], $data[4], $data[7]);
                    }
                }
            }

            return $hiringIdToRet;
        }

        /**
        * Modifica los datos de una contratación (checks)
        *
        * @param array $data
        *
        * @return bool
        */
        public function deleteHirings($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $maxNumHiring = $this->getActiveHiring($expedient);

            $result = $db->query("  SELECT  ID
                                    FROM    Expedients_Hirings
                                    WHERE   expedient = $expedient AND 
                                            num_hiring = $maxNumHiring
            ");
            
            if(mysqli_num_rows($result) > 0){
                $result = $db->resultToArray($result);

                foreach($result as $elem){

                    $db->query("DELETE FROM Pre_Orders WHERE hiring = " . $elem['ID']);

                    $db->query("DELETE FROM Expedients_Texts WHERE hiring = " . $elem['ID']);

                    $db->query("DELETE FROM Expedients_Work_Orders_Communication WHERE hiring = " . $elem['ID'] . "");
                    
                    $db->query("DELETE FROM Expedients_Work_Orders_Flowers WHERE hiring = " . $elem['ID'] . "");
                }
            }

            return $db->query("DELETE FROM Expedients_Hirings WHERE expedient = " . $expedient . "");
        }

        /**
         * Obtiene las notas de la contratación
         * 
         * @param int $id ID del expediente
         * @return array Notas de la contratación
         */
        public function getNotesHiring($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            $result = $db->query("  SELECT  e.notesHiring
                                    FROM    Expedients e
                                    WHERE   e.expedientID = $id");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['notesHiring'];
        }

        /**
        * Calcula el total de una contratación
        *
        * @param array $data
        *
        * @return int
        */
        public function getTotal($data){
            $db = new DbHandler;

            $data['expedient'] = cleanStr($data['expedient']);

            $maxNumHiring = $this->getActiveHiring($data['expedient']);

            $result = $db->query("  SELECT  SUM(total) AS total 
                                    FROM    Expedients_Hirings 
                                    WHERE   num_hiring = $maxNumHiring AND
                                            expedient = " . $data['expedient'] . "");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result)[0];
            }
        }

        /**
         * Obtiene los textos de un producto-modelo de la contratación
         * 
         * @param array $data ID del expediente y del modelo
         * @return array
         */
        public function getTexts($data){
            $db = new DbHandler;

            $data['expedientID'] = cleanStr($data['expedientID']);
            $data['modelID'] = cleanStr($data['modelID']);

            $result = $db->query("  SELECT  REPLACE(value, '\\\', '') as value
                                    FROM    Expedients_Texts
                                    WHERE   expedient = " . $data['expedientID'] . " AND
                                            model = " . $data['modelID'] . "");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }

        /**
         * Obtiene los textos de una línea de la contratación
         *
         * @param array $data ID de la línea de la contratación
         * @return array
         */
        public function getTextsByHiring($data){
            $db = new DbHandler;

            $data['hiring'] = cleanStr($data['hiring']);
            $data['mode'] = cleanStr($data['mode']); // Indica si hay que cargar la contratación normal o la rectificada

            $result = $db->query("  SELECT  ID, discount, hiring, rowIndex, REPLACE(value, '\\\', '') as value
                                    FROM    Expedients_Texts
                                    WHERE   hiring = " . $data['hiring']);

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }

        /* **************** Expedientes - Esquela **************** */
        /**
        * Añade una esquela
        *
        * @param array $data
        *
        * @return bool
        */
        public function createObituary($data){
            $db = new DbHandler;

            $data['expedient'] = cleanStr($data['expedient']);
            $data['namePre'] = cleanStr($data['namePre']);
            $data['extraText'] = cleanStr($data['extraText']);
            if($_SESSION['company'] == '25'){
                $data['died'] = cleanTextArea($data['died']);
            }else{
                $data['died'] = cleanStr($data['died']);
            }
            $data['prayForCheck'] = cleanStr($data['prayForCheck']);
            $data['prayForText'] = cleanStr($data['prayForText']);
            $data['prayForGenre'] = cleanStr($data['prayForGenre']);
            $data['dep'] = cleanStr($data['dep']);
            $data['spousePre'] = cleanStr($data['spousePre']);
            $data['spouseName'] = cleanStr($data['spouseName']);
            $data['childrenPre'] = cleanStr($data['childrenPre']);
            $data['childrenNames'] = cleanStr($data['childrenNames']);
            $data['childrenInLawPre'] = cleanStr($data['childrenInLawPre']);
            $data['childrenInLawNames'] = cleanStr($data['childrenInLawNames']);
            $data['grandchildrenPre'] = cleanStr($data['grandchildrenPre']);
            $data['grandchildrenNames'] = cleanStr($data['grandchildrenNames']);
            $data['grandchildrenInLawPre'] = cleanStr($data['grandchildrenInLawPre']);
            $data['grandchildrenInLawNames'] = cleanStr($data['grandchildrenInLawNames']);
            $data['greatGrandchildrenPre'] = cleanStr($data['greatGrandchildrenPre']);
            $data['greatGrandchildrenNames'] = cleanStr($data['greatGrandchildrenNames']);
            $data['parentsPre'] = cleanStr($data['parentsPre']);
            $data['parentsNames'] = cleanStr($data['parentsNames']);
            $data['parentsInLawPre'] = cleanStr($data['parentsInLawPre']);
            $data['parentsInLawNames'] = cleanStr($data['parentsInLawNames']);
            $data['paternalGrandfathersPre'] = cleanStr($data['paternalGrandfathersPre']);
            $data['paternalGrandfathersNames'] = cleanStr($data['paternalGrandfathersNames']);
            $data['paternalGrandmotherPre'] = cleanStr($data['paternalGrandmotherPre']);
            $data['paternalGrandmotherNames'] = cleanStr($data['paternalGrandmotherNames']);
            $data['siblingsPre'] = cleanStr($data['siblingsPre']);
            $data['siblingsNames'] = cleanStr($data['siblingsNames']);
            $data['politicalSiblingsPre'] = cleanStr($data['politicalSiblingsPre']);
            $data['politicalSiblingsNames'] = cleanStr($data['politicalSiblingsNames']);
            $data['siblings'] = cleanStr($data['siblings']);
            $data['politicalSiblings'] = cleanStr($data['politicalSiblings']);
            $data['grandchildren'] = cleanStr($data['grandchildren']);
            $data['politicalGrandchildren'] = cleanStr($data['politicalGrandchildren']);
            $data['greatGrandchildren'] = cleanStr($data['greatGrandchildren']);
            $data['uncles'] = cleanStr($data['uncles']);
            $data['nephews'] = cleanStr($data['nephews']);
            $data['cousins'] = cleanStr($data['cousins']);
            $data['restFamily'] = cleanStr($data['restFamily']);
            $data['pray'] = cleanStr($data['pray']);
            $data['funeral'] = cleanStr($data['funeral']);
            $data['mourning'] = cleanStr($data['mourning']);
            $data['deliverObituariesIn'] = cleanStr($data['deliverObituariesIn']);
            $data['busRoute'] = cleanStr($data['busRoute']);
            $data['xmlUrl'] = cleanStr($data['xmlUrl']);
            $data['type'] = cleanStr($data['type']);
            $data['quote'] = cleanStr($data['quote']);
            $data['obituaryPreview'] = cleanStr($data['obituaryPreview']);

            return $db->query(" INSERT INTO Expedients_Obituaries (expedient, namePre, extraText, died, prayForCheck,
                                    prayForText, prayForGenre, dep, spousePre, spouseName, 
                                    childrenPre, childrenNames, childrenInLawPre, childrenInLawNames, 
                                    grandchildrenPre, grandchildrenNames, grandchildrenInLawPre, 
                                    grandchildrenInLawNames, greatGrandchildrenPre, greatGrandchildrenNames, 
                                    parentsPre, parentsNames, parentsInLawPre, parentsInLawNames, paternalGrandfathersPre, 
                                    paternalGrandfathersNames, paternalGrandmotherPre, paternalGrandmotherNames, 
                                    siblingsPre, siblingsNames, politicalSiblingsPre, politicalSiblingsNames, 
                                    siblings, politicalSiblings, grandchildren, politicalGrandchildren, 
                                    greatGrandchildren, uncles, nephews, cousins, restFamily, pray, funeral, mourning, 
                                    deliverObituariesIn, busRoute, xmlUrl, `type`, `quote`, obituaryPreview, model, `update`) 
                               VALUES(" . $data['expedient'] . ", '" . $data['namePre'] . "', '" . $data['extraText'] . "', 
                                      '" . $data['died'] . "', " . $data['prayForCheck'] . ", '" . $data['prayForText'] . "', 
                                      '" . $data['prayForGenre'] . "', " . $data['dep'] . ", '" . $data['spousePre'] . "', 
                                      '" . $data['spouseName'] . "', '" . $data['childrenPre'] . "', '" . $data['childrenNames'] . "', 
                                      '" . $data['childrenInLawPre'] . "', '" . $data['childrenInLawNames'] . "', 
                                      '" . $data['grandchildrenPre'] . "', '" . $data['grandchildrenNames'] . "', 
                                      '" . $data['grandchildrenInLawPre'] . "', '" . $data['grandchildrenInLawNames'] . "', 
                                      '" . $data['greatGrandchildrenPre'] . "', '" . $data['greatGrandchildrenNames'] . "', 
                                      '" . $data['parentsPre'] . "', '" . $data['parentsNames'] . "', '" . $data['parentsInLawPre'] . "', 
                                      '" . $data['parentsInLawNames'] . "', '" . $data['paternalGrandfathersPre'] . "', 
                                      '" . $data['paternalGrandfathersNames'] . "', '" . $data['paternalGrandmotherPre'] . "', 
                                      '" . $data['paternalGrandmotherNames'] . "', '" . $data['siblingsPre'] . "', 
                                      '" . $data['siblingsNames'] . "', '" . $data['politicalSiblingsPre'] . "', 
                                      '" . $data['politicalSiblingsNames'] . "', " . $data['siblings'] . ", " . $data['politicalSiblings'] . ", 
                                      " . $data['grandchildren'] . ", " . $data['politicalGrandchildren'] . ", " . $data['greatGrandchildren'] . ", 
                                      " . $data['uncles'] . ", " . $data['nephews'] . ", " . $data['cousins'] . ", '" . $data['restFamily'] . "',
                                      '" . $data['pray'] . "', '" . $data['funeral'] . "', " . $data['mourning'] . ", 
                                      '" . $data['deliverObituariesIn'] . "', '" . $data['busRoute'] . "', '" . $data['xmlUrl'] . "',
                                      " . $data['type'] . ", '" . $data['quote'] . "', '" . $data['obituaryPreview'] . "', 1, " . time());
        }

        /**
         * Comprueba si existe o no un tipo de esquela
         * 
         * @param int $obituaryType
         * @param int $expedient
         * 
         * @return bool
         */
        public function checkExistObituary($expedient, $obituaryType){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $obituaryType = cleanStr($obituaryType);

            $result = $db->query("  SELECT  * 
                                    FROM    Expedients_Obituaries as o
                                    WHERE   o.expedient = '" . $expedient . "' AND
                                            o.type = '" . $obituaryType . "'");
            
            if(mysqli_num_rows($result) == 0){
                return false;
            }else{
                return true;
            }
        }

        /**
         * Obtiene la esquela por defecto
         * 
         * @param int $expedient
         * 
         * @return bool
         */
        public function getSelectedObituary($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT  o.type, o.model
                                    FROM    Expedients_Obituaries as o
                                    WHERE   o.expedient = $expedient AND
                                            o.selected = 1");
            
            if(mysqli_num_rows($result) == 0){
                return array('type' => 0, 'model' => 0);
            }else{
                return $db->resultToArray($result)[0];
            }
        }

        /**
         * Obtiene la esquela por defecto
         * 
         * @param int $expedient
         * 
         * @return bool
         */
        public function getSelectedObituaryEye($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("SELECT    o.type, o.model
                                  FROM      Expedients_Obituaries as o
                                  WHERE     o.expedient = $expedient AND
                                            o.selected = 1");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result)[0];
            }
        }

        /**
         * Obtiene la esquela en prensa por defecto
         * 
         * @param int $expedient
         * 
         * @return bool
         */
        public function getSelectedObituaryPressEye($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("SELECT    o.type, o.model
                                  FROM      Expedients_Press as o
                                  WHERE     o.expedient = $expedient AND
                                            o.selected = 1");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result)[0];
            }
        }

        /**
         * Comprueba si existe o no un tipo de esquela
         * 
         * @param int $type Tipo
         * @param int $model Modelo
         * @param int $expedient Expediente
         * @return array
         */
        public function existObituary($type, $model, $expedientId){
            $db = new DbHandler;

            $type = cleanStr($type);
            $model = cleanStr($model);
            $expedientId = cleanStr($expedientId);

            $result = $db->query("  SELECT  o.ID, o.obituary
                                    FROM    Expedients_Obituaries as o
                                    WHERE   o.expedient = $expedientId AND
                                            o.type = $type AND
                                            o.model = $model");

            if(mysqli_num_rows($result) > 0){
                $obituary = $db->resultToArray($result)[0];
                if($obituary['obituary'] == NULL){
                    return false;
                }else{
                    return $obituary;
                }
            }else{
                return false;
            }
        }

        /**
         * Comprueba si existe o no un tipo de esquela
         * 
         * @param int $obituaryType
         * @param int $expedient
         * 
         * @return bool
         */
        public function getNewObituary($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedSurname, e.deceasedRoom, e.deceasedGender, e.deceasedMaritalStatus, e.startVelacionDate, e.startVelacionTime, e.funeralDateNew, e.funeralTimeNew, e.deceasedUsualAddress,
                                                e.deceasedMaritalStatusDescription, e.deceasedBirthday, e.deceasedDate, e.deceasedTime, e.deceasedFirstNuptials, e.deceasedSecondNuptials,
                                                e.deceasedSecondNuptials AS second, e.church, lc.name as churchNameLocation, lc.province as churchNameProvince, e.cremation, e.funeralDate, e.funeralTime, c.name as crematoriumName, e.deceasedRoom,
                                                e.cemetery, IF(m.name = 'Otro', e.deceasedMortuaryAddress, m.name) as mortuaryName, d.name as locationName, ld.name as deceasedInLocality, l.name as applicantLocationName,
                                                IF(e.churchLabel = 'Otro', e.otherCeremony, ch.name) AS churchName,
                                                m.address AS mortuaryAddress, lm.name AS mortuaryLocation, m.phones as mortuaryPhones,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, ce.name) AS cemeteryName,
                                                e.churchLabel, e.cemeteryLabel, e.status as expedientStatus, e.ceremonyDate, e.ceremonyTime
                                    FROM        (Expedients e)
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   DeceasedIn d ON e.deceasedLocation = d.deceasedInID
                                    LEFT JOIN   Locations ld ON ld.locationID = d.location
                                    LEFT JOIN   Crematoriums c ON c.crematoriumID = e.crematorium
                                    LEFT JOIN   Events ev ON ev.expedient = e.expedientID
                                    LEFT JOIN   Locations l ON l.locationID = e.applicantLocation
                                    LEFT JOIN   Locations lm ON lm.locationID = m.location
                                    LEFT JOIN   Churches ch ON ch.churchID = e.church
                                    LEFT JOIN   Locations lc ON lc.locationID = ch.location
                                    LEFT JOIN   Cemeteries ce ON ce.cemeteryID = e.cemetery
                                    WHERE       e.expedientID = " . $expedient . "");
            
            if(mysqli_num_rows($result) == 0){
				return null;
			}else{
                return $db->resultToArray($result);
            }
        }

        /**
         * Comprueba si existe o no un tipo de esquela
         * 
         * @param int $obituaryType
         * @param int $expedient
         * 
         * @return bool
         */
        public function getSavedObituary($expedient, $type){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);

            $result = $db->query("  SELECT  eo.*, e.deceasedDate, e.deceasedBirthday
                                    FROM    Expedients_Obituaries eo, Expedients e
                                    WHERE   eo.expedient = $expedient AND 
                                            eo.type = $type AND
                                            eo.expedient = e.expedientID");
            
            if(mysqli_num_rows($result) == 0){
				return null;
			}else{
                return $db->resultToArray($result);
            }
        }

        /**
         * Comprueba si existe o no un tipo de esquela
         * 
         * @param int $obituaryType
         * @param int $expedient
         * 
         * @return bool
         */
        public function getSavedObituaryInit($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT  eo.*, e.status as expedientStatus
                                    FROM    Expedients_Obituaries eo, Expedients e
                                    WHERE   eo.expedient = $expedient AND
                                            eo.expedient = e.expedientID AND 
                                            eo.selected = 1");

            if(mysqli_num_rows($result) == 0){
				$result = $db->query("  SELECT  MIN(eo.type) as type
                                        FROM    Expedients_Obituaries eo
                                        WHERE   eo.expedient = $expedient");

                if(mysqli_num_rows($result) > 0){
                    $type = $db->resultToArray($result)[0]['type'];

                    $currentDate = time();
                    $db->query("UPDATE  Expedients_Obituaries
                                SET     selected = 1,
                                        `update` = $currentDate
                                WHERE   type = $type AND 
                                        model = 0 AND 
                                        expedient = $expedient");

                    $result = $db->query("  SELECT  eo.*, e.status as expedientStatus
                                            FROM    Expedients_Obituaries eo, Expedients e
                                            WHERE   eo.expedient = $expedient AND
                                                    eo.expedient = e.expedientID AND
                                                    eo.selected = 1");

                    if(mysqli_num_rows($result) == 0){
                        return null;
                    }else{
                        return $db->resultToArray($result);
                    }
                }else{
                    return null;
                }
			}else{
                return $db->resultToArray($result);
            }
        }

        /**
         * Comprueba si existe o no un tipo de esquela
         * 
         * @param int $obituaryType
         * @param int $expedient
         * 
         * @return bool
         */
        public function saveObituary($obituary){
            $db = new DbHandler;
            
            $obituary['expedient'] = cleanStr($obituary['expedient']);
            $obituary['type'] = cleanStr($obituary['type']);
            $obituary['namePre'] = cleanStr($obituary['namePre']);
            $obituary['name'] = cleanStr($obituary['name']);
            $obituary['surname'] = cleanStr($obituary['surname']);
            $obituary['extraText'] = cleanStr($obituary['extraText']);
            if($_SESSION['company'] == '25'){
                $obituary['died'] = cleanTextArea($obituary['died']);
            }else{
                $obituary['died'] = cleanStr($obituary['died']);
            }
            $obituary['prayForCheck'] = cleanStr($obituary['prayForCheck']);
            $obituary['prayForText'] = cleanStr($obituary['prayForText']);
            $obituary['prayForGenre'] = cleanStr($obituary['prayForGenre']);
            $obituary['spousePre'] = cleanStr($obituary['spousePre']);
            $obituary['spouseName'] = cleanTextArea($obituary['spouseName']);
            $obituary['childrenPre'] = cleanStr($obituary['childrenPre']);
            $obituary['childrenNames'] = cleanTextArea($obituary['childrenNames']);
            $obituary['childrenInLawPre'] = cleanStr($obituary['childrenInLawPre']);
            $obituary['childrenInLawNames'] = cleanTextArea($obituary['childrenInLawNames']);
            $obituary['grandchildrenPre'] = cleanStr($obituary['grandchildrenPre']);
            $obituary['grandchildrenNames'] = cleanTextArea($obituary['grandchildrenNames']);
            $obituary['grandchildrenInLawPre'] = cleanStr($obituary['grandchildrenInLawPre']);
            $obituary['grandchildrenInLawNames'] = cleanTextArea($obituary['grandchildrenInLawNames']);
            $obituary['greatGrandchildrenPre'] = cleanStr($obituary['greatGrandchildrenPre']);
            $obituary['greatGrandchildrenNames'] = cleanTextArea($obituary['greatGrandchildrenNames']);
            $obituary['parentsPre'] = cleanStr($obituary['parentsPre']);
            $obituary['parentsNames'] = cleanTextArea($obituary['parentsNames']);
            $obituary['parentsInLawPre'] = cleanStr($obituary['parentsInLawPre']);
            $obituary['parentsInLawNames'] = cleanTextArea($obituary['parentsInLawNames']);
            $obituary['paternalGrandfathersPre'] = cleanStr($obituary['paternalGrandfathersPre']);
            $obituary['paternalGrandfathersNames'] = cleanTextArea($obituary['paternalGrandfathersNames']);
            $obituary['paternalGrandmotherPre'] = cleanStr($obituary['paternalGrandmotherPre']);
            $obituary['paternalGrandmotherNames'] = cleanTextArea($obituary['paternalGrandmotherNames']);
            $obituary['siblingsPre'] = cleanStr($obituary['siblingsPre']);
            $obituary['siblingsNames'] = cleanTextArea($obituary['siblingsNames']);
            $obituary['politicalSiblingsPre'] = cleanStr($obituary['politicalSiblingsPre']);
            $obituary['politicalSiblingsNames'] = cleanTextArea($obituary['politicalSiblingsNames']);
            $obituary['siblings'] = cleanStr($obituary['siblings']);
            $obituary['politicalSiblings'] = cleanStr($obituary['politicalSiblings']);
            $obituary['grandchildren'] = cleanStr($obituary['grandchildren']);
            $obituary['politicalGrandchildren'] = cleanStr($obituary['politicalGrandchildren']);
            $obituary['greatGrandchildren'] = cleanStr($obituary['greatGrandchildren']);
            $obituary['uncles'] = cleanStr($obituary['uncles']);
            $obituary['nephews'] = cleanStr($obituary['nephews']);
            $obituary['cousins'] = cleanStr($obituary['cousins']);
            $obituary['restFamily'] = cleanStr($obituary['restFamily']);
            $obituary['pray'] = cleanTextArea($obituary['pray']);
            $obituary['funeral'] = cleanStr($obituary['funeral']);
            $obituary['mourning'] = cleanStr($obituary['mourning']);
            $obituary['deliverObituariesIn'] = cleanTextArea($obituary['deliverObituariesIn']);
            $obituary['busRoute'] = cleanTextArea($obituary['busRoute']);
            $obituary['mortuary'] = cleanStr($obituary['mortuary']);
            $obituary['location'] = cleanStr($obituary['location']);
            $obituary['roomNumber'] = cleanStr($obituary['roomNumber']);
            
            $result = $db->query("SELECT * FROM Expedients_Obituaries eo WHERE eo.expedient = " . $obituary['expedient'] . " AND eo.type = " . $obituary['type'] . "");

            if(mysqli_num_rows($result)  == 0){
                for($i = 0; $i <= 6; $i++){
                    $db->query("INSERT INTO Expedients_Obituaries (expedient, namePre, `name`, surname, extraText, died, prayForCheck, prayForText, prayForGenre, dep, spousePre, 
                                    spouseName, childrenPre, childrenNames, childrenInLawPre, childrenInLawNames, grandchildrenPre, grandchildrenNames, 
                                    grandchildrenInLawPre, grandchildrenInLawNames, greatGrandchildrenPre, greatGrandchildrenNames, parentsPre, 
                                    parentsNames, parentsInLawPre, parentsInLawNames, paternalGrandfathersPre, paternalGrandfathersNames, 
                                    paternalGrandmotherPre, paternalGrandmotherNames, siblingsPre, siblingsNames, politicalSiblingsPre, 
                                    politicalSiblingsNames, siblings, politicalSiblings, grandchildren, politicalGrandchildren, 
                                    greatGrandchildren, uncles, nephews, cousins, restFamily, pray, funeral, mourning, deliverObituariesIn, busRoute, 
                                    `type`, model, mortuary, `location`, roomNumber, `update`) 
                                VALUES (" . $obituary['expedient'] . ", '" . $obituary['namePre'] . "', '" . $obituary['name'] . "', '" . $obituary['surname'] . "', '" . $obituary['extraText'] . "', 
                                    '" . $obituary['died'] . "', " . $obituary['prayForCheck'] . ", '" . $obituary['prayForText'] . "', '" . $obituary['prayForGenre'] . "', 
                                    " . $obituary['dep'] . ", '" . $obituary['spousePre'] . "', '" . $obituary['spouseName'] . "', '" . $obituary['childrenPre'] . "', '" . $obituary['childrenNames'] . "', 
                                    '" . $obituary['childrenInLawPre'] . "', '" . $obituary['childrenInLawNames'] . "', '" . $obituary['grandchildrenPre'] . "', '" . $obituary['grandchildrenNames'] . "', 
                                    '" . $obituary['grandchildrenInLawPre'] . "', '" . $obituary['grandchildrenInLawNames'] . "', '" . $obituary['greatGrandchildrenPre'] . "', '" . $obituary['greatGrandchildrenNames'] . "', 
                                    '" . $obituary['parentsPre'] . "', '" . $obituary['parentsNames'] . "', '" . $obituary['parentsInLawPre'] . "', '" . $obituary['parentsInLawNames'] . "', 
                                    '" . $obituary['paternalGrandfathersPre'] . "', '" . $obituary['paternalGrandfathersNames'] . "', '" . $obituary['paternalGrandmotherPre'] . "', '" . $obituary['paternalGrandmotherNames'] . "', 
                                    '" . $obituary['siblingsPre'] . "', '" . $obituary['siblingsNames'] . "', '" . $obituary['politicalSiblingsPre'] . "', '" . $obituary['politicalSiblingsNames'] . "', 
                                    " . $obituary['siblings'] . ", " . $obituary['politicalSiblings'] . ", " . $obituary['grandchildren'] . ", " . $obituary['politicalGrandchildren'] . ", 
                                    " . $obituary['greatGrandchildren'] . ", " . $obituary['uncles'] . ", " . $obituary['nephews'] . ", " . $obituary['cousins'] . ", 
                                    '" . $obituary['restFamily'] . "', '" . $obituary['pray'] . "', '" . $obituary['funeral'] . "', " . $obituary['mourning'] . ", '" . $obituary['deliverObituariesIn'] . "',
                                    '" . $obituary['busRoute'] . "', " . $obituary['type'] . ", $i, '" . $obituary['mortuary'] . "', '" . $obituary['location'] . "', '" . $obituary['roomNumber'] . "', " . time() . ")");
                }
                
                return true;
            }else{
                for($i = 0; $i <= 6; $i++){
                    $db->query("UPDATE  Expedients_Obituaries
                                SET     namePre = '" . $obituary['namePre'] . "', `name` = '" . $obituary['name'] . "', surname = '" . $obituary['surname'] . "', 
                                        extraText = '" . $obituary['extraText'] . "', died = '" . $obituary['died'] . "', prayForCheck = " . $obituary['prayForCheck'] . ", 
                                        prayForText = '" . $obituary['prayForText'] . "', prayForGenre = '" . $obituary['prayForGenre'] . "', dep = " . $obituary['dep'] . ", 
                                        spousePre = '" . $obituary['spousePre'] . "', spouseName = '" . $obituary['spouseName'] . "', childrenPre = '" . $obituary['childrenPre'] . "', 
                                        childrenNames = '" . $obituary['childrenNames'] . "', childrenInLawPre = '" . $obituary['childrenInLawPre'] . "', childrenInLawNames = '" . $obituary['childrenInLawNames'] . "', 
                                        grandchildrenPre = '" . $obituary['grandchildrenPre'] . "', grandchildrenNames ='" . $obituary['grandchildrenNames'] . "', 
                                        grandchildrenInLawPre = '" . $obituary['grandchildrenInLawPre'] . "', grandchildrenInLawNames = '" . $obituary['grandchildrenInLawNames'] . "', 
                                        greatGrandchildrenPre = '" . $obituary['greatGrandchildrenPre'] . "', greatGrandchildrenNames = '" . $obituary['greatGrandchildrenNames'] . "', 
                                        parentsPre = '" . $obituary['parentsPre'] . "', parentsNames = '" . $obituary['parentsNames'] . "', 
                                        parentsInLawPre = '" . $obituary['parentsInLawPre'] . "', parentsInLawNames = '" . $obituary['parentsInLawNames'] . "', 
                                        paternalGrandfathersPre = '" . $obituary['paternalGrandfathersPre'] . "', paternalGrandfathersNames = '" . $obituary['paternalGrandfathersNames'] . "', 
                                        paternalGrandmotherPre = '" . $obituary['paternalGrandmotherPre'] . "', paternalGrandmotherNames = '" . $obituary['paternalGrandmotherNames'] . "', 
                                        siblingsPre = '" . $obituary['siblingsPre'] . "', siblingsNames = '" . $obituary['siblingsNames'] . "', 
                                        politicalSiblingsPre = '" . $obituary['politicalSiblingsPre'] . "', politicalSiblingsNames = '" . $obituary['politicalSiblingsNames'] . "', 
                                        siblings = " . $obituary['siblings'] . ", politicalSiblings = " . $obituary['politicalSiblings'] . ", grandchildren = " . $obituary['grandchildren'] . ", 
                                        politicalGrandchildren = " . $obituary['politicalGrandchildren'] . ", greatGrandchildren = " . $obituary['greatGrandchildren'] . ", 
                                        uncles = " . $obituary['uncles'] . ", nephews = " . $obituary['nephews'] . ", cousins = " . $obituary['cousins'] . ", 
                                        restFamily = '" . $obituary['restFamily'] . "', pray = '" . $obituary['pray'] . "', funeral= '" . $obituary['funeral'] . "', 
                                        mourning = " . $obituary['mourning'] . ", deliverObituariesIn = '" . $obituary['deliverObituariesIn'] . "', busRoute = '" . $obituary['busRoute'] . "', 
                                        mortuary = '" . $obituary['mortuary']. "', location = '" . $obituary['location']. "', roomNumber = '" . $obituary['roomNumber'] . "', `update` = " . time() . "
                                WHERE   expedient = " . $obituary['expedient'] . " AND `type` = " . $obituary['type'] . " AND model = $i");
                }

                return true;
            }
        }

        /**
         * Comprueba si existe o no un tipo de esquela
         * 
         * @param int $obituaryType
         * @param int $expedient
         * 
         * @return bool
         */
        public function saveReminder($obituary){
            $db = new DbHandler;
            
            $obituary['expedient'] = cleanStr($obituary['expedient']);
            $obituary['type'] = cleanStr($obituary['type']);
            $obituary['namePre'] = cleanStr($obituary['namePre']);
            $obituary['name'] = cleanStr($obituary['name']);
            $obituary['surname'] = cleanStr($obituary['surname']);
            $obituary['extraText'] = cleanStr($obituary['extraText']);
            if($_SESSION['company'] == '25'){
                $obituary['died'] = cleanTextArea($obituary['died']);
            }else{
                $obituary['died'] = cleanStr($obituary['died']);
            }
            $obituary['prayForCheck'] = cleanStr($obituary['prayForCheck']);
            $obituary['prayForText'] = cleanStr($obituary['prayForText']);
            $obituary['prayForGenre'] = cleanStr($obituary['prayForGenre']);
            $obituary['spousePre'] = cleanStr($obituary['spousePre']);
            $obituary['spouseName'] = cleanStr($obituary['spouseName']);
            $obituary['childrenPre'] = cleanStr($obituary['childrenPre']);
            $obituary['childrenNames'] = cleanStr($obituary['childrenNames']);
            $obituary['childrenInLawPre'] = cleanStr($obituary['childrenInLawPre']);
            $obituary['childrenInLawNames'] = cleanStr($obituary['childrenInLawNames']);
            $obituary['grandchildrenPre'] = cleanStr($obituary['grandchildrenPre']);
            $obituary['grandchildrenNames'] = cleanStr($obituary['grandchildrenNames']);
            $obituary['grandchildrenInLawPre'] = cleanStr($obituary['grandchildrenInLawPre']);
            $obituary['grandchildrenInLawNames'] = cleanStr($obituary['grandchildrenInLawNames']);
            $obituary['greatGrandchildrenPre'] = cleanStr($obituary['greatGrandchildrenPre']);
            $obituary['greatGrandchildrenNames'] = cleanStr($obituary['greatGrandchildrenNames']);
            $obituary['parentsPre'] = cleanStr($obituary['parentsPre']);
            $obituary['parentsNames'] = cleanStr($obituary['parentsNames']);
            $obituary['parentsInLawPre'] = cleanStr($obituary['parentsInLawPre']);
            $obituary['parentsInLawNames'] = cleanStr($obituary['parentsInLawNames']);
            $obituary['paternalGrandfathersPre'] = cleanStr($obituary['paternalGrandfathersPre']);
            $obituary['paternalGrandfathersNames'] = cleanStr($obituary['paternalGrandfathersNames']);
            $obituary['paternalGrandmotherPre'] = cleanStr($obituary['paternalGrandmotherPre']);
            $obituary['paternalGrandmotherNames'] = cleanStr($obituary['paternalGrandmotherNames']);
            $obituary['siblingsPre'] = cleanStr($obituary['siblingsPre']);
            $obituary['siblingsNames'] = cleanStr($obituary['siblingsNames']);
            $obituary['politicalSiblingsPre'] = cleanStr($obituary['politicalSiblingsPre']);
            $obituary['politicalSiblingsNames'] = cleanStr($obituary['politicalSiblingsNames']);
            $obituary['siblings'] = cleanStr($obituary['siblings']);
            $obituary['politicalSiblings'] = cleanStr($obituary['politicalSiblings']);
            $obituary['grandchildren'] = cleanStr($obituary['grandchildren']);
            $obituary['politicalGrandchildren'] = cleanStr($obituary['politicalGrandchildren']);
            $obituary['greatGrandchildren'] = cleanStr($obituary['greatGrandchildren']);
            $obituary['uncles'] = cleanStr($obituary['uncles']);
            $obituary['nephews'] = cleanStr($obituary['nephews']);
            $obituary['cousins'] = cleanStr($obituary['cousins']);
            $obituary['restFamily'] = cleanStr($obituary['restFamily']);
            $obituary['pray'] = cleanStr($obituary['pray']);
            $obituary['mourning'] = cleanStr($obituary['mourning']);
           
            $result = $db->query("SELECT * FROM Expedients_Obituaries eo WHERE eo.expedient = " . $obituary['expedient'] . " AND eo.type = " . $obituary['type'] . "");

            if(mysqli_num_rows($result)  == 0){
                for($i = 0; $i <= 6; $i++){
                    $db->query("INSERT INTO Expedients_Obituaries (expedient, namePre, `name`, surname, extraText, died, prayForCheck, prayForText, prayForGenre, dep, spousePre, 
                                    spouseName, childrenPre, childrenNames, childrenInLawPre, childrenInLawNames, grandchildrenPre, grandchildrenNames, 
                                    grandchildrenInLawPre, grandchildrenInLawNames, greatGrandchildrenPre, greatGrandchildrenNames, parentsPre, 
                                    parentsNames, parentsInLawPre, parentsInLawNames, paternalGrandfathersPre, paternalGrandfathersNames, 
                                    paternalGrandmotherPre, paternalGrandmotherNames, siblingsPre, siblingsNames, politicalSiblingsPre, 
                                    politicalSiblingsNames, siblings, politicalSiblings, grandchildren, politicalGrandchildren, 
                                    greatGrandchildren, uncles, nephews, cousins, restFamily, pray, mourning, 
                                    `type`, model,`update`) 
                                VALUES (" . $obituary['expedient'] . ", '" . $obituary['namePre'] . "', '" . $obituary['name'] . "', '" . $obituary['surname'] . "', '" . $obituary['extraText'] . "', 
                                    '" . $obituary['died'] . "', " . $obituary['prayForCheck'] . ", '" . $obituary['prayForText'] . "', '" . $obituary['prayForGenre'] . "', 
                                    " . $obituary['dep'] . ", '" . $obituary['spousePre'] . "', '" . $obituary['spouseName'] . "', '" . $obituary['childrenPre'] . "', '" . $obituary['childrenNames'] . "', 
                                    '" . $obituary['childrenInLawPre'] . "', '" . $obituary['childrenInLawNames'] . "', '" . $obituary['grandchildrenPre'] . "', '" . $obituary['grandchildrenNames'] . "', 
                                    '" . $obituary['grandchildrenInLawPre'] . "', '" . $obituary['grandchildrenInLawNames'] . "', '" . $obituary['greatGrandchildrenPre'] . "', '" . $obituary['greatGrandchildrenNames'] . "', 
                                    '" . $obituary['parentsPre'] . "', '" . $obituary['parentsNames'] . "', '" . $obituary['parentsInLawPre'] . "', '" . $obituary['parentsInLawNames'] . "', 
                                    '" . $obituary['paternalGrandfathersPre'] . "', '" . $obituary['paternalGrandfathersNames'] . "', '" . $obituary['paternalGrandmotherPre'] . "', '" . $obituary['paternalGrandmotherNames'] . "', 
                                    '" . $obituary['siblingsPre'] . "', '" . $obituary['siblingsNames'] . "', '" . $obituary['politicalSiblingsPre'] . "', '" . $obituary['politicalSiblingsNames'] . "', 
                                    " . $obituary['siblings'] . ", " . $obituary['politicalSiblings'] . ", " . $obituary['grandchildren'] . ", " . $obituary['politicalGrandchildren'] . ", 
                                    " . $obituary['greatGrandchildren'] . ", " . $obituary['uncles'] . ", " . $obituary['nephews'] . ", " . $obituary['cousins'] . ", 
                                    '" . $obituary['restFamily'] . "', '" . $obituary['pray'] . "', " . $obituary['mourning'] . "," . $obituary['type'] . ", $i, " . time() . ")");
                }
  
                return true;
            }else{
                for($i = 0; $i <= 6; $i++){
                    $db->query("UPDATE  Expedients_Obituaries
                                SET     namePre = '" . $obituary['namePre'] . "', `name` = '" . $obituary['name'] . "', surname = '" . $obituary['surname'] . "', 
                                        extraText = '" . $obituary['extraText'] . "', died = '" . $obituary['died'] . "', prayForCheck = " . $obituary['prayForCheck'] . ", 
                                        prayForText = '" . $obituary['prayForText'] . "', prayForGenre = '" . $obituary['prayForGenre'] . "', dep = " . $obituary['dep'] . ", 
                                        spousePre = '" . $obituary['spousePre'] . "', spouseName = '" . $obituary['spouseName'] . "', childrenPre = '" . $obituary['childrenPre'] . "', 
                                        childrenNames = '" . $obituary['childrenNames'] . "', childrenInLawPre = '" . $obituary['childrenInLawPre'] . "', childrenInLawNames = '" . $obituary['childrenInLawNames'] . "', 
                                        grandchildrenPre = '" . $obituary['grandchildrenPre'] . "', grandchildrenNames ='" . $obituary['grandchildrenNames'] . "', 
                                        grandchildrenInLawPre = '" . $obituary['grandchildrenInLawPre'] . "', grandchildrenInLawNames = '" . $obituary['grandchildrenInLawNames'] . "', 
                                        greatGrandchildrenPre = '" . $obituary['greatGrandchildrenPre'] . "', greatGrandchildrenNames = '" . $obituary['greatGrandchildrenNames'] . "', 
                                        parentsPre = '" . $obituary['parentsPre'] . "', parentsNames = '" . $obituary['parentsNames'] . "', 
                                        parentsInLawPre = '" . $obituary['parentsInLawPre'] . "', parentsInLawNames = '" . $obituary['parentsInLawNames'] . "', 
                                        paternalGrandfathersPre = '" . $obituary['paternalGrandfathersPre'] . "', paternalGrandfathersNames = '" . $obituary['paternalGrandfathersNames'] . "', 
                                        paternalGrandmotherPre = '" . $obituary['paternalGrandmotherPre'] . "', paternalGrandmotherNames = '" . $obituary['paternalGrandmotherNames'] . "', 
                                        siblingsPre = '" . $obituary['siblingsPre'] . "', siblingsNames = '" . $obituary['siblingsNames'] . "', 
                                        politicalSiblingsPre = '" . $obituary['politicalSiblingsPre'] . "', politicalSiblingsNames = '" . $obituary['politicalSiblingsNames'] . "', 
                                        siblings = " . $obituary['siblings'] . ", politicalSiblings = " . $obituary['politicalSiblings'] . ", grandchildren = " . $obituary['grandchildren'] . ", 
                                        politicalGrandchildren = " . $obituary['politicalGrandchildren'] . ", greatGrandchildren = " . $obituary['greatGrandchildren'] . ", 
                                        uncles = " . $obituary['uncles'] . ", nephews = " . $obituary['nephews'] . ", cousins = " . $obituary['cousins'] . ", 
                                        restFamily = '" . $obituary['restFamily'] . "', pray = '" . $obituary['pray'] . "', mourning = " . $obituary['mourning'] . ", `update` = " . time() . "
                                WHERE   expedient = " . $obituary['expedient'] . " AND `type` = " . $obituary['type'] . " AND model = $i");
                }
        
                return true;
            }
        }

        /**
         * Comprueba si existe o no un tipo de esquela
         * 
         * @param int $obituaryType
         * @param int $expedient
         * 
         * @return bool
         */
        public function getObituaryTypes($data){
            $db = new DbHandler;

            $data['expedient'] = cleanStr($data['expedient']);
            $data['type'] = cleanStr($data['type']);

            $result = $db->query("  SELECT  * 
                                    FROM    Expedients_Obituaries as o
                                    WHERE   o.expedient = '" . $data['expedient'] . "' AND
                                            o.type = '" . $data['type'] . "'");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return true;
            }
        }

        /**
         * Función para setear el campo obituaryPreview, con el que se controla la previsualización o no de la esquela
         * 
         * @param array data
         * 
         * @return bool
         */
        public function setObituaryPreview($data){
            $db = new DbHandler;

            $data['expedient'] = cleanStr($data['expedient']);
            $data['obituaryType'] = cleanStr($data['obituaryType']);
            
            $result = $db->query("  UPDATE  Expedients_Obituaries 
                                    SET     obituaryPreview = 1
                                    WHERE   expedient = " . $data['expedient'] . " AND
                                            `type` = " . $data['obituaryType'] . " ");
            if($result){
                return true;
            }else{
                return false;
            }
        }

        /**
        * Obtiene los datos de una esquela
        *
        * @param array $data
        *
        * @return array
        */
        public function readObituary($data){
            $db = new DbHandler;

            $data['expedient'] = cleanStr($data['expedient']);
            $data['type'] = cleanStr($data['type']);

            $result = $db->query("SELECT    eo.*, e.deceasedName, e.deceasedSurname, m.name as mortuary, e.deceasedRoom, e.deceasedDate, l.name as locationName
                                  FROM      (Expedients_Obituaries eo, Expedients e)
                                  LEFT JOIN Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                  LEFT JOIN Locations l ON e.deceasedLocation = l.locationID
                                  WHERE     eo.expedient = e.expedientID AND
                                            eo.expedient = " . $data['expedient'] . " AND
                                            eo.type = " . $data['type'] . "");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result);
            }
        }

        /**
         * Obtiene los datos de la esquela para el editor
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de esquela
         * @param int $model Modelo de esquela
         * @return array
         */
        public function getObituaryEditor($expedient, $type, $model){
            $db = new DbHandler;

            $result = $db->query("  SELECT  c.nif
                                    FROM    Expedients e, Clients c
                                    WHERE   e.expedientID = $expedient AND
                                            e.client = c.clientID");


            if(mysqli_num_rows($result) == 0 ){
                $client = null;
            }else{
                $client = null;
                $client =  $db->resultToArray($result)[0]['nif'];
            } 

            if($client == null){
                $expedient = cleanStr($expedient);
                $type = cleanStr($type);
                $model = cleanStr($model);
    
                $result = $db->query("  SELECT      eo.*, e.funeralHomeEntryDate, e.funeralHomeEntryTime, e.deceasedMaritalStatus, e.deceasedDate, e.deceasedBirthday, 
                                                    e.deceasedMortuaryAddress, e.deceasedLocality, e.deceasedProvince, e.deceasedUsualAddress, 
                                                    l.name as mortuaryLocation, l.postalCode as mortuaryPostalCode, l.province as mortuaryProvince,
                                                    e.startVelacionDate, e.startVelacionTime, e.endVelacionTime, di.name as deceasedInName,
                                                    e.cemeteryLabel, 
                                                    IF(e.cemeteryLabel = 'Otro', e.otherInhumation, cem.name) AS cemeteryName,
                                                    m.address as mortuaryAddress, m.phones as mortuaryPhones,
                                                    e.churchLabel, 
                                                    IF(e.churchLabel = 'Otro', e.otherCeremony, ch.name) AS churchName,
                                                    e.ceremonyDate, e.ceremonyTime,
                                                    f.name AS funeralHome
                                        FROM        (Expedients_Obituaries eo, Expedients e, Expedients_Services es)
                                        LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                        LEFT JOIN   Locations l ON m.location = l.locationID
                                        LEFT JOIN   DeceasedIn di ON di.deceasedInID = e.deceasedLocation
                                        LEFT JOIN   Cemeteries cem ON e.cemetery = cem.cemeteryID
                                        LEFT JOIN   Churches ch ON e.church = ch.churchID
                                        LEFT JOIN   FuneralHomes f ON f.funeralHomeID = es.funeralHomeService
                                        WHERE       eo.expedient = $expedient AND
                                                    eo.type = $type AND
                                                    eo.model = $model AND
                                                    eo.expedient = e.expedientID AND 
                                                    e.expedientID = es.expedient
                ");
               
                return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
            }else{
                $expedient = cleanStr($expedient);
                $type = cleanStr($type);
                $model = cleanStr($model);
    
                $result = $db->query("  SELECT      eo.*, e.funeralHomeEntryDate, e.funeralHomeEntryTime, e.deceasedMaritalStatus, c.nif, e.deceasedDate, e.deceasedBirthday, 
                                                    e.deceasedMortuaryAddress, e.deceasedLocality, e.deceasedProvince, e.deceasedUsualAddress, 
                                                    l.name as mortuaryLocation, l.postalCode as mortuaryPostalCode, l.province as mortuaryProvince,
                                                    e.startVelacionDate, e.startVelacionTime, e.endVelacionTime, di.name as deceasedInName,
                                                    e.cemeteryLabel, 
                                                    IF(e.cemeteryLabel = 'Otro', e.otherInhumation, cem.name) AS cemeteryName,
                                                    m.address as mortuaryAddress, m.phones as mortuaryPhones,
                                                    e.churchLabel, 
                                                    IF(e.churchLabel = 'Otro', e.otherCeremony, ch.name) AS churchName,
                                                    e.ceremonyDate, e.ceremonyTime,
                                                    f.name AS funeralHome
                                        FROM        (Expedients_Obituaries eo, Clients c, Expedients e, Expedients_Services es)
                                        LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                        LEFT JOIN   Locations l ON m.location = l.locationID
                                        LEFT JOIN   DeceasedIn di ON di.deceasedInID = e.deceasedLocation
                                        LEFT JOIN   Cemeteries cem ON e.cemetery = cem.cemeteryID
                                        LEFT JOIN   Churches ch ON e.church = ch.churchID
                                        LEFT JOIN   FuneralHomes f ON f.funeralHomeID = es.funeralHomeService
                                        WHERE       eo.expedient = $expedient AND
                                                    eo.type = $type AND
                                                    eo.model = $model AND
                                                    eo.expedient = e.expedientID AND
                                                    e.client = c.clientID AND 
                                                    e.expedientID = es.expedient
                ");
               
                return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
            }
        }

        /**
         * Obtiene los datos de la esquela para el editor
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de esquela
         * @param int $model Modelo de esquela
         * @return array
         */
        public function getObituaryReminderPacketEditor($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);

            $result = $db->query("  SELECT  e.deceasedName, e.deceasedSurname, e.deceasedGender 
                                    FROM    Expedients e 
                                    WHERE   e.expedientID = $expedient");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }

        /**
        * Modifica los datos de una esquela
        *
        * @param $array $data
        *
        * @return bool
        */
        public function updateObituary($data){
            $db = new DbHandler;

            $data['namePre'] = cleanStr($data['namePre']);
            $data['extraText'] = cleanStr($data['extraText']);
            if($_SESSION['company'] == '25'){
                $data['died'] = cleanTextArea($data['died']);
            }else{
                $data['died'] = cleanStr($data['died']);
            }
            $data['prayForCheck'] = cleanStr($data['prayForCheck']);
            $data['prayForText'] = cleanStr($data['prayForText']);
            $data['prayForGenre'] = cleanStr($data['prayForGenre']);
            $data['dep'] = cleanStr($data['dep']);
            $data['spousePre'] = cleanStr($data['spousePre']);
            $data['spouseName'] = cleanStr($data['spouseName']);
            $data['childrenPre'] = cleanStr($data['childrenPre']);
            $data['childrenNames'] = cleanStr($data['childrenNames']);
            $data['childrenInLawPre'] = cleanStr($data['childrenInLawPre']);
            $data['childrenInLawNames'] = cleanStr($data['childrenInLawNames']);
            $data['grandchildrenPre'] = cleanStr($data['grandchildrenPre']);
            $data['grandchildrenNames'] = cleanStr($data['grandchildrenNames']);
            $data['grandchildrenInLawPre'] = cleanStr($data['grandchildrenInLawPre']);
            $data['grandchildrenInLawNames'] = cleanStr($data['grandchildrenInLawNames']);
            $data['greatGrandchildrenPre'] = cleanStr($data['greatGrandchildrenPre']);
            $data['greatGrandchildrenNames'] = cleanStr($data['greatGrandchildrenNames']);
            $data['parentsPre'] = cleanStr($data['parentsPre']);
            $data['parentsNames'] = cleanStr($data['parentsNames']);
            $data['parentsInLawPre'] = cleanStr($data['parentsInLawPre']);
            $data['parentsInLawNames'] = cleanStr($data['parentsInLawNames']);
            $data['paternalGrandfathersPre'] = cleanStr($data['paternalGrandfathersPre']);
            $data['paternalGrandfathersNames'] = cleanStr($data['paternalGrandfathersNames']);
            $data['paternalGrandmotherPre'] = cleanStr($data['paternalGrandmotherPre']);
            $data['paternalGrandmotherNames'] = cleanStr($data['paternalGrandmotherNames']);
            $data['siblingsPre'] = cleanStr($data['siblingsPre']);
            $data['siblingsNames'] = cleanStr($data['siblingsNames']);
            $data['politicalSiblingsPre'] = cleanStr($data['politicalSiblingsPre']);
            $data['politicalSiblingsNames'] = cleanStr($data['politicalSiblingsNames']);
            $data['siblings'] = cleanStr($data['siblings']);
            $data['politicalSiblings'] = cleanStr($data['politicalSiblings']);
            $data['grandchildren'] = cleanStr($data['grandchildren']);
            $data['politicalGrandchildren'] = cleanStr($data['politicalGrandchildren']);
            $data['greatGrandchildren'] = cleanStr($data['greatGrandchildren']);
            $data['uncles'] = cleanStr($data['uncles']);
            $data['nephews'] = cleanStr($data['nephews']);
            $data['cousins'] = cleanStr($data['cousins']);
            $data['restFamily'] = cleanStr($data['restFamily']);
            $data['pray'] = cleanStr($data['pray']);
            $data['funeral'] = cleanStr($data['funeral']);
            $data['mourning'] = cleanStr($data['mourning']);
            $data['deliverObituariesIn'] = cleanStr($data['deliverObituariesIn']);
            $data['busRoute'] = cleanStr($data['busRoute']);
            $data['xmlUrl'] = cleanStr($data['xmlUrl']);
            $data['quote'] = cleanStr($data['quote']);
            $data['obituaryPreview'] = cleanStr($data['obituaryPreview']);
            $data['expedient'] = cleanStr($data['expedient']);
            $data['type'] = cleanStr($data['type']);

            return $db->query(" UPDATE  Expedients_Obituaries 
                                SET     namePre = '" . $data['namePre'] . "', extraText = '" . $data['extraText'] . "', 
                                        died = '" . $data['died'] . "', prayForCheck = " . $data['prayForCheck'] . ", 
                                        prayForText = '" . $data['prayForText'] . "', prayForGenre = '" . $data['prayForGenre'] . "', 
                                        dep = " . $data['dep'] . ", spousePre = '" . $data['spousePre'] . "', 
                                        spouseName = '" . $data['spouseName'] . "', childrenPre = '" . $data['childrenPre'] . "', 
                                        childrenNames = '" . $data['childrenNames'] . "', childrenInLawPre = '" . $data['childrenInLawPre'] . "', 
                                        childrenInLawNames = '" . $data['childrenInLawNames'] . "', 
                                        grandchildrenPre = '" . $data['grandchildrenPre'] . "', 
                                        grandchildrenNames = '" . $data['grandchildrenNames'] . "', 
                                        grandchildrenInLawPre = '" . $data['grandchildrenInLawPre'] . "', 
                                        grandchildrenInLawNames = '" . $data['grandchildrenInLawNames'] . "', 
                                        greatGrandchildrenPre = '" . $data['greatGrandchildrenPre'] . "', 
                                        greatGrandchildrenNames = '" . $data['greatGrandchildrenNames'] . "', 
                                        parentsPre = '" . $data['parentsPre'] . "', parentsNames = '" . $data['parentsNames'] . "', 
                                        parentsInLawPre = '" . $data['parentsInLawPre'] . "', parentsInLawNames = '" . $data['parentsInLawNames'] . "', 
                                        paternalGrandfathersPre = '" . $data['paternalGrandfathersPre'] . "', 
                                        paternalGrandfathersNames = '" . $data['paternalGrandfathersNames'] . "', 
                                        paternalGrandmotherPre = '" . $data['paternalGrandmotherPre'] . "', 
                                        paternalGrandmotherNames = '" . $data['paternalGrandmotherNames'] . "', 
                                        siblingsPre = '" . $data['siblingsPre'] . "', 
                                        siblingsNames = '" . $data['siblingsNames'] . "', 
                                        politicalSiblingsPre = '" . $data['politicalSiblingsPre'] . "', 
                                        politicalSiblingsNames = '" . $data['politicalSiblingsNames'] . "', 
                                        siblings = " . $data['siblings'] . ", politicalSiblings = " . $data['politicalSiblings'] . ", 
                                        grandchildren = " . $data['grandchildren'] . ", politicalGrandchildren = " . $data['politicalGrandchildren'] . ", 
                                        greatGrandchildren = " . $data['greatGrandchildren'] . ", uncles = " . $data['uncles'] . ", 
                                        nephews = " . $data['nephews'] . ", cousins = " . $data['cousins'] . ", restFamily = '" . $data['restFamily'] . "', 
                                        pray = '" . $data['pray'] . "', funeral = '" . $data['funeral'] . "', 
                                        mourning = " . $data['mourning'] . ", deliverObituariesIn = '" . $data['deliverObituariesIn'] . "', 
                                        busRoute = '" . $data['busRoute'] . "', xmlUrl = '" . $data['xmlUrl'] . "', quote = '" . $data['quote'] . "',
                                        obituaryPreview = '" . $data['obituaryPreview'] . "',
                                        `update` = " . time() . "
                                WHERE    expedient = " . $data['expedient'] . " AND
                                        `type` = " . $data['type'] . " ");
        }

        /**
        * Obtenemos el modelo de equela a cargar en el editor de esquelas
        *
        * @param array $data
        *
        * @return bool
        */
        public function getModelObituary($data){
            $db = new DbHandler;

            $data['expedient'] = cleanStr($data['expedient']);
            $data['type'] = cleanStr($data['type']);

            $result = $db->query("  SELECT  model
                                    FROM    Expedients_Obituaries 
                                    WHERE   expedient = " . $data['expedient'] . " AND
                                            `type` = " . $data['type'] . " ");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0]['model'] : null;
        }        

        /**
        * Obtiene los datos de una esquela relativos al expediente
        *
        * @param $array $data
        *
        * @return array
        */
        public function getObituaryExpedient($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedSurname, e.deceasedRoom, e.deceasedGender, e.deceasedMaritalStatus,
                                                e.deceasedMaritalStatusDescription, e.deceasedBirthday, e.deceasedDate, e.deceasedFirstNuptials,
                                                e.deceasedSecondNuptials, e.deceasedRoom, e.church, e.cremation, e.funeralDate, e.funeralTime, c.name as crematoriumName,
                                                e.cemetery, m.name as mortuaryName, d.name as locationName, l.name as applicantLocationName
                                    FROM        (Expedients e, Mortuaries m)
                                    LEFT JOIN   DeceasedIn d ON e.deceasedLocation = d.deceasedInID
                                    LEFT JOIN   Crematoriums c ON c.crematoriumID = e.crematorium
                                    LEFT JOIN   Events ev ON ev.expedient = e.expedientID
                                    LEFT JOIN   Locations l ON l.locationID = e.applicantLocation
                                    WHERE       e.deceasedMortuary = m.mortuaryID AND 
                                                e.expedientID = " . $data . "");
            
            if(mysqli_num_rows($result) == 0){
				return null;
			}else{
                return $db->resultToArray($result);
            }
        }

        /**
         * Comprueba si un expediente tiene un cliente seleccionado
         *
         * @param int $expedient Id del expediente
         * @return bool
         */
        public function hasClient($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT  client
                                    FROM    Expedients
                                    WHERE   expedientID = $expedient AND
                                            client IS NOT NULL");

            return mysqli_num_rows($result) == 0 ? false : true;
        }

        /* **************** Expedientes - C. Servicio **************** */
        /**
         * Crea un servicio para un expediente y lo asocia al mismo
         * 
         * @param int $data
         * @return bool
         */
        public function createService($data, $mode = null){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT  e.deceasedTribunal
                                    FROM    Expedients e
                                    WHERE   e.expedientID = $data");

            $tribunal = mysqli_num_rows($result) == 0 ? '' : $db->resultToArray($result)[0]['deceasedTribunal'];

            if($mode == 'TPV'){
                $result = $db->query("  INSERT INTO Expedients_Services(expedient, choir, funeralHomeService, corpseCollection1, corpseCollection2, 
                                            familyAssistance, carCollection, arriveTime, arriveDate, revReqCheck, dni, priestTime,
                                            gravediggersCheck, notifiedChoir, notifiedBellringer, carriersTime, notes,
                                            gravediggersCheckPrinted, gravediggersCheckSigned, carriersTimeCheck, literalCivilRegister, 
                                            crematoriumProgramOven, crematoriumControlDeliversAshes, notApplyAll, literalReceived, literalNoFinished,
                                            literalRequest, literalNotApply, policeNotified, policeNotApply, tribunalInProgress, tribunalDeliver, tribunalNotApply,
                                            doctorInProgress, doctorDone, doctorDeliver, doctorNotApply, webConfirm, webNotApply, preparationConfirm, preparationNotApply,
                                            tombstoneNotApply, tombstonePrint, vivoSent)
                                        VALUES (" . $data . ", null, null, null, null, null, null, null, null, 0, null, null, 0, 0, 0, null, null, 0, 0, 1, '$tribunal', 0, 0, 1, 1, 1,
                                            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1)");
            }else{

                $result = $db->query("  INSERT INTO Expedients_Services(expedient, choir, funeralHomeService, corpseCollection1, corpseCollection2, 
                                            familyAssistance, carCollection, arriveTime, arriveDate, revReqCheck, dni, priestTime,
                                            gravediggersCheck, notifiedChoir, notifiedBellringer, carriersTime, notes,
                                            gravediggersCheckPrinted, gravediggersCheckSigned, carriersTimeCheck, literalCivilRegister, 
                                            crematoriumProgramOven, crematoriumControlDeliversAshes) 
                                        VALUES (" . $data . ", null, null, null, null, null, null, null, null, 0, null, null, 0, 0, 0, null, null, 0, 0, 1, '$tribunal', 0, 0)");
            }

            if(intval($_SESSION['company']) == 1){
                $result = $db->query("  INSERT INTO Services_Control(service, send, sent)
                                        VALUES ($data, 'manuelarodriguez@fe-seguros.com,lafevilla@gmail.com', 0)");
            }else{
                $result = $db->query("  INSERT INTO Services_Control(service, send, sent)
                                        VALUES ($data, '', 0)");
            }

            return $result ? true : false;
        }

        /**
         * Obtienes los datos del servicio relativos al expediente
         * 
         * @param int $data
         * @return array
         */
        public function getServiceExpedient($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedSurname, e.deceasedGender, e.number, e.requestDate, e.clientType,
                                                e.requestTime, e.policy, e.capital, e.lossNumber, e.funeralHomeEntryTime, e.deceasedTribunal,
                                                e.funeralNicheNumber, e.deceasedRoom, e.ceremonyTime as funeralTime, e.niche, e.funeralBusyNiche, e.regime, e.deceasedNiche, e.exhumation, e.nicheHeight,
                                                e.funeralDateNew, e.funeralTimeNew, e.applicantMobilePhone, e.familyContactMobilePhone, e.otherContactPhone,
                                                c.name, 
                                                n.name as niche, 
                                                es.revReqCheck, es.gravediggersCheck, es.notifiedChoir, es.notifiedBellringer, es.choir as choirID, es.arriveTime, es.arriveDate, es.dni, es.priestTime, es.carriersTime, 
                                                es.funeralHomeService, es.corpseCollection1, es.corpseCollection2, es.familyAssistance, es.carCollection, es.notes, es.bellringer as bellringerID, es.priestTimeCheck,
                                                es.carriersTimeCheck, es.gravediggersCheckPrinted, es.gravediggersCheckSigned, es.gravediggersNotApply,  es.policeNotified, es.policeNotApply, es.policeLocation, es.webNotApply,
                                                es.webConfirm, es.webLink, es.doctorDone, es.doctorDeliver, es.doctorNotApply, es.doctorInProgress, es.tribunalDeliver, es.tribunalNotApply, es.tribunalInProgress,
                                                es.literalReceived, es.literalNoFinished, es.literalRequest, es.literalVolumePage, es.literalWhoTakes, es.literalCivilRegister, es.literalDateExit, es.literalTimeExit, es.literalNotApply,
                                                es.tribunalLocation, es.tribunalUser, es.tombstone, es.preparationNotApply, es.preparationConfirm, es.control, es.notApplyAll, es.tombstonePrint, es.tombstoneNotApply,
                                                es.vivoSent, es.vivoNotApply, es.priestInspected, es.priestPayed, es.priestNotes, es.showFinalDestinationWeb, es.showVelationWeb, es.showCeremonyWeb,
                                                es.sinceAniversaryWeb, es.untilAniversaryWeb, es.showAgeObituaryWeb, es.churchAniversaryWeb, es.dateAniversaryWeb, es.timeAniversaryWeb,
                                                es.surveyNotApply, es.surveySend,
                                                es.poll, po.title as poll_title,
                                                IF(e.churchLabel = 'Otro', e.otherCeremony, chu.name) as churchAniversaryWebName,
                                                st.name as staffName, st.surname as staffSurname, st2.name as doctorDelivName, st2.surname as doctorDelivSurname,
                                                ch.name as choirName, 
                                                b.name as bellringerName,
                                                f.name as fuName, u2.name as c1Name, u2.surname as c1Surname, u3.name as faName, u3.surname as faSurname,
                                                st1.name as faName1, st1.surname as faSurname1, 
                                                u4.name as c2Name, u4.surname as c2Surname, 
                                                ca.brand as carBrand, ca.model as carModel, ca.licensePlate as carLicense,
                                                CONCAT(st3.name, ' ', st3.surname) as corpseCollection1Name,
                                                CONCAT(st4.name, ' ', st4.surname) as corpseCollection2Name,
                                                m.name as deceasedMortuary
                                    FROM        (Expedients e, Expedients_Services es) 
                                    LEFT JOIN   Choirs ch ON es.choir = ch.choirID
                                    LEFT JOIN   Clients c on e.client = c.clientID
                                    LEFT JOIN   Niches n on e.niche = n.nicheID
                                    LEFT JOIN   FuneralHomes f on es.funeralHomeService = f.funeralHomeID
                                    LEFT JOIN   Users u2 on es.corpseCollection1 = u2.userID
                                    LEFT JOIN   Users u4 on es.corpseCollection2 = u4.userID
                                    LEFT JOIN   Users u3 on es.familyAssistance = u3.userID
                                    LEFT JOIN   Cars ca on es.carCollection = ca.ID
                                    LEFT JOIN   Mortuaries m on e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   BellRingers b on es.bellringer = b.ID
                                    LEFT JOIN   Staff st ON es.tribunalUser = st.ID
                                    LEFT JOIN   Staff st1 ON es.familyAssistance = st1.ID
                                    LEFT JOIN   Staff st2 ON es.doctorDeliver = st2.ID
                                    LEFT JOIN   Staff st3 ON es.corpseCollection1 = st3.ID
                                    LEFT JOIN   Staff st4 ON es.corpseCollection2 = st4.ID
                                    LEFT JOIN   Polls po ON es.poll = po.ID
                                    LEFT JOIN   Churches chu ON es.churchAniversaryWeb = chu.churchID
                                    WHERE       e.expedientID = es.expedient AND 
                                                e.expedientID = " . $data);

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }

        /**
         * Comprueba si el acta de preparación está creada para un expediente
         * 
         * @param int $expedient Id del expediente
         * @return bool
         */
        public function checkActPrep($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT  ed.nameFile
                                    FROM    Expedients_Documents ed
                                    WHERE   ed.expedient = $expedient AND
                                            ed.name = 'Actividades preparación'");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['nameFile'];
        }

        /**
         * Guarda el servicio de un expediente
         *
         * @param array $data
         * 
         * @return bool
         */
        function saveServiceExpedient($data){
            $db = new DbHandler;

            $data['arriveTime'] = cleanStr($data['arriveTime']);
            $data['arriveDate'] = cleanStr($data['arriveDate']);
            $data['priestTime'] = cleanStr($data['priestTime']);
            $data['carrierTime'] = cleanStr($data['carrierTime']);
            $data['tribunalUser'] = cleanStr($data['tribunalUser']);
            $data['doctorDeliver'] = cleanStr($data['doctorDeliver']);
            $data['choir'] = cleanStr($data['choir']);
            $data['selectSurvey'] = cleanStr($data['selectSurvey']);
            $data['revReqCheck'] = cleanStr($data['revReqCheck']);
            $data['control'] = cleanStr($data['control']);
            $data['dni'] = cleanStr($data['dni']);
            $data['gravediggersCheck'] = cleanStr($data['gravediggersCheck']);
            $data['carriersTimeCheck'] = cleanStr($data['carriersTimeCheck']);
            $data['priestTimeCheck'] = cleanStr($data['priestTimeCheck']);
            $data['priestInspected'] = cleanStr($data['priestInspected']);
            $data['priestPayed'] = cleanStr($data['priestPayed']);
            $data['priestNotes'] = cleanTextArea($data['priestNotes']);
            $data['policeNotified'] = cleanStr($data['policeNotified']);
            $data['policeLocation'] = cleanStr($data['policeLocation']);
            $data['policeNotApply'] = cleanStr($data['policeNotApply']);
            $data['tribunalInProgress'] = cleanStr($data['tribunalInProgress']);
            $data['tribunalDeliver'] = cleanStr($data['tribunalDeliver']);
            $data['tribunalUser'] = cleanStr($data['tribunalUser']);
            $data['tribunalLocation'] = cleanStr($data['tribunalLocation']);
            $data['tribunalNotApply'] = cleanStr($data['tribunalNotApply']);
            $data['literalReceived'] = cleanStr($data['literalReceived']);
            $data['literalNoFinished'] = cleanStr($data['literalNoFinished']);
            $data['literalRequest'] = cleanStr($data['literalRequest']);
            $data['literalVolumePage'] = cleanStr($data['literalVolumePage']);
            $data['literalWhoTakes'] = cleanStr($data['literalWhoTakes']);
            $data['literalCivilRegister'] = cleanStr($data['literalCivilRegister']);
            $data['literalDateExit'] = cleanStr($data['literalDateExit']);
            $data['literalTimeExit'] = cleanStr($data['literalTimeExit']);
            $data['literalNotApply'] = cleanStr($data['literalNotApply']);
            $data['doctorInProgress'] = cleanStr($data['doctorInProgress']);
            $data['doctorDone'] = cleanStr($data['doctorDone']);
            $data['doctorDeliver'] = cleanStr($data['doctorDeliver']);
            $data['doctorNotApply'] = cleanStr($data['doctorNotApply']);
            $data['webConfirm'] = cleanStr($data['webConfirm']);
            $data['showAgeObituaryWeb'] = cleanStr($data['showAgeObituaryWeb']);
            $data['showFinalDestinationWeb'] = cleanStr($data['showFinalDestinationWeb']);
            $data['showVelationWeb'] = cleanStr($data['showVelationWeb']);
            $data['showCeremonyWeb'] = cleanStr($data['showCeremonyWeb']);
            $data['webNotApply'] = cleanStr($data['webNotApply']);
            $data['sinceAniversaryWeb'] = cleanStr($data['sinceAniversaryWeb']);
            if($data['sinceAniversaryWeb'] == ""){
                $sinceAniversaryWeb = 'sinceAniversaryWeb = null, ';
            }else{
                $sinceAniversaryWeb = 'sinceAniversaryWeb = "' . $data['sinceAniversaryWeb'] . '", ';
            }
            $data['untilAniversaryWeb'] = cleanStr($data['untilAniversaryWeb']);
            if($data['untilAniversaryWeb'] == ""){
                $untilAniversaryWeb = 'untilAniversaryWeb = null, ';
            }else{
                $untilAniversaryWeb = 'untilAniversaryWeb = "' . $data['untilAniversaryWeb'] . '", ';
            }

            $data['churchAniversaryWeb'] = cleanStr($data['churchAniversaryWeb']);
            if($data['churchAniversaryWeb'] == ""){
                $churchAniversaryWeb = 'churchAniversaryWeb = null, ';
            }else{
                $churchAniversaryWeb = 'churchAniversaryWeb = ' . $data['churchAniversaryWeb'] . ', ';
            }

            $data['dateAniversaryWeb'] = cleanStr($data['dateAniversaryWeb']);
            if($data['dateAniversaryWeb'] == ""){
                $dateAniversaryWeb = 'dateAniversaryWeb = null, ';
            }else{
                $dateAniversaryWeb = 'dateAniversaryWeb = "' . $data['dateAniversaryWeb'] . '", ';
            }

            $data['timeAniversaryWeb'] = cleanStr($data['timeAniversaryWeb']);
            if($data['timeAniversaryWeb'] == ""){
                $timeAniversaryWeb = 'timeAniversaryWeb = null, ';
            }else{
                $timeAniversaryWeb = 'timeAniversaryWeb = "' . $data['timeAniversaryWeb'] . '", ';
            }

            $data['preparationConfirm'] = cleanStr($data['preparationConfirm']);
            $data['preparationNotApply'] = cleanStr($data['preparationNotApply']);
            $data['notApplyAll'] = cleanStr($data['notApplyAll']);
            $data['tombstonePrint'] = cleanStr($data['tombstonePrint']);
            $data['tombstoneNotApply'] = cleanStr($data['tombstoneNotApply']);
            $data['gravediggersCheckSigned'] = cleanStr($data['gravediggersCheckSigned']);
            $data['gravediggersCheckPrinted'] = cleanStr($data['gravediggersCheckPrinted']);
            $data['gravediggersNotApply'] = cleanStr($data['gravediggersNotApply']);
            $data['vivoSent'] = isset($data['vivoSent']) ? cleanStr($data['vivoSent']) : 0;
            $data['vivoNotApply'] = isset($data['vivoNotApply']) ? cleanStr($data['vivoNotApply']) : 0;
            $data['surveySend'] = cleanStr($data['surveySend']);
            $data['surveyNotApply'] = cleanStr($data['surveyNotApply']);
            
            $data['crematoriumProgramOven'] = isset($data['crematoriumProgramOven']) ? cleanStr($data['crematoriumProgramOven']) : 0;
            $data['crematoriumWhoDelivered'] = isset($data['crematoriumWhoDelivered']) ? cleanStr($data['crematoriumWhoDelivered']) : '';
            $data['crematoriumWhoProgramOven'] = isset($data['crematoriumWhoProgramOven']) ? cleanStr($data['crematoriumWhoProgramOven']) : '';
            $data['crematoriumNotes'] = isset($data['crematoriumNotes']) ? cleanTextArea($data['crematoriumNotes']) : '';
            $data['crematoriumControlDeliversAshes'] = isset($data['crematoriumControlDeliversAshes']) ? cleanStr($data['crematoriumControlDeliversAshes']) : 0;

            $data['expedientID'] = cleanStr($data['expedientID']);

            $data['arriveTime'] != 'null' ? $arriveTime = "arriveTime = '" . $data['arriveTime'] . "'," : $arriveTime = "arriveTime = null,";
            $data['arriveDate'] != 'null' ? $arriveDate = "arriveDate = '" . $data['arriveDate'] . "'," : $arriveDate = "arriveDate = null,";
            $data['priestTime'] != 'null' ? $priestTime = "priestTime = '" . $data['priestTime'] . "'," : $priestTime = "priestTime = null,";
            $data['carrierTime'] != 'null' ? $carrierTime = "carriersTime = '" . $data['carrierTime'] . "'," : $carrierTime = "carriersTime = null,";
            $data['tribunalUser'] = $data['tribunalUser'] == '' ? 'null' : $data['tribunalUser'];
            $data['doctorDeliver'] = $data['doctorDeliver'] == '' ? 'null' : $data['doctorDeliver'];

            $data['literalWhoTakes'] = $data['literalWhoTakes'] == '' ? 'null' : $data['literalWhoTakes'];
            $data['literalCivilRegister'] = $data['literalCivilRegister'] == '' ? 'null' : $data['literalCivilRegister'];
            $literalDateExit = $data['literalDateExit'] == '' ? 'null' :  "'". $data['literalDateExit'] . "'";
            $literalDateExit = $data['literalDateExit'] == 'null' ? 'null' :  "'". $data['literalDateExit'] . "'";
            $literalTimeExit = $data['literalTimeExit'] == '' ? 'null' :  "'". $data['literalTimeExit'] . "'";

            $data['crematoriumWhoProgramOven'] = $data['crematoriumWhoProgramOven'] == '' ? 'null' : $data['crematoriumWhoProgramOven'];
            $data['crematoriumWhoDelivered'] = $data['crematoriumWhoDelivered'] == '' ? 'null' : $data['crematoriumWhoDelivered'];
            $data['crematoriumNotes'] = $data['crematoriumNotes'] == '' ? 'null' : "'". $data['crematoriumNotes'] . "'";

            return $db->query(" UPDATE  Expedients_Services 
                                SET     choir = " . $data['choir'] . ", 
                                        " . $arriveTime . "
                                        " . $arriveDate . "
                                        poll = " . $data['selectSurvey'] . ",
                                        revReqCheck = " . $data['revReqCheck'] . ",
                                        control = " . $data['control'] . ",
                                        dni = '" . $data['dni'] . "', " . $priestTime . "
                                        gravediggersCheck = " . $data['gravediggersCheck'] . ", 
                                        gravediggersCheckSigned = " . $data['gravediggersCheckSigned'] . ", 
                                        gravediggersCheckPrinted = " . $data['gravediggersCheckPrinted'] . ", 
                                        gravediggersNotApply = " . $data['gravediggersNotApply'] . ", 
                                        " . $carrierTime . "
                                        carriersTimeCheck = " . $data['carriersTimeCheck'] . ",
                                        priestTimeCheck = " . $data['priestTimeCheck'] . ",
                                        priestInspected = " . $data['priestInspected'] . ",
                                        priestPayed = " . $data['priestPayed'] . ",
                                        priestNotes = '" . $data['priestNotes'] . "',
                                        policeNotified = " . $data['policeNotified'] . ",
                                        policeLocation = '" . $data['policeLocation'] . "',
                                        policeNotApply = " . $data['policeNotApply'] . ",
                                        tribunalInProgress = " . $data['tribunalInProgress'] . ",
                                        tribunalDeliver = " . $data['tribunalDeliver'] . ",
                                        tribunalUser = " . $data['tribunalUser'] . ",
                                        tribunalLocation = '" . $data['tribunalLocation'] . "',
                                        tribunalNotApply = " . $data['tribunalNotApply'] . ",
                                        literalReceived = " . $data['literalReceived'] . ",
                                        literalNoFinished = " . $data['literalNoFinished'] . ",
                                        literalRequest = " . $data['literalRequest'] . ",
                                        literalVolumePage = '" . $data['literalVolumePage'] . "',
                                        literalWhoTakes = '" . $data['literalWhoTakes'] . "',
                                        literalCivilRegister = '" . $data['literalCivilRegister'] . "',
                                        literalDateExit = $literalDateExit,
                                        literalTimeExit = $literalTimeExit,
                                        literalNotApply = " . $data['literalNotApply'] . ",
                                        doctorInProgress = " . $data['doctorInProgress'] . ",
                                        doctorDone = " . $data['doctorDone'] . ",
                                        doctorDeliver = " . $data['doctorDeliver'] . ",
                                        doctorNotApply = " . $data['doctorNotApply'] . ",
                                        webConfirm = " . $data['webConfirm'] . ",
                                        showAgeObituaryWeb = " . $data['showAgeObituaryWeb'] . ",
                                        showFinalDestinationWeb = " . $data['showFinalDestinationWeb'] . ",
                                        showVelationWeb = " . $data['showVelationWeb'] . ",
                                        showCeremonyWeb = " . $data['showCeremonyWeb'] . ",
                                        webNotApply = " . $data['webNotApply'] . ",
                                        $sinceAniversaryWeb
                                        $untilAniversaryWeb
                                        $churchAniversaryWeb
                                        $dateAniversaryWeb
                                        $timeAniversaryWeb
                                        preparationConfirm = " . $data['preparationConfirm'] . ",
                                        preparationNotApply = " . $data['preparationNotApply'] . ",
                                        notApplyAll = " . $data['notApplyAll'] . ",
                                        tombstoneNotApply = " . $data['tombstoneNotApply'] . ",
                                        tombstonePrint = " . $data['tombstonePrint'] . ",
                                        vivoSent = " . $data['vivoSent'] . ",
                                        vivoNotApply = " . $data['vivoNotApply'] . ",
                                        surveySend = " . $data['surveySend'] . ",
                                        surveyNotApply = " . $data['surveyNotApply'] . ",
                                        crematoriumProgramOven = " . $data['crematoriumProgramOven'] . ",
                                        crematoriumWhoProgramOven = " . $data['crematoriumWhoProgramOven'] . ",
                                        crematoriumWhoDelivered = " . $data['crematoriumWhoDelivered'] . ",
                                        crematoriumNotes = " . $data['crematoriumNotes'] . ",
                                        crematoriumControlDeliversAshes = " . $data['crematoriumControlDeliversAshes'] . "
                                WHERE   expedient = " . $data['expedientID']);
        }

        /**
         * Guarda el servicio de un expediente (solo seccion de literales)
         *
         * @param array $data
         * 
         * @return bool
         */
        function updateServiceLiterals($data){
            $db = new DbHandler;

            $data['literalReceived'] = cleanStr($data['literalReceived']);
            $data['literalNoFinished'] = cleanStr($data['literalNoFinished']);
            $data['literalRequest'] = cleanStr($data['literalRequest']);
            $data['literalVolumePage'] = cleanStr($data['literalVolumePage']);
            $data['literalWhoTakes'] = cleanStr($data['literalWhoTakes']);
            $data['literalCivilRegister'] = cleanStr($data['literalCivilRegister']);
            $data['literalDateExit'] = cleanStr($data['literalDateExit']);
            $data['literalTimeExit'] = cleanStr($data['literalTimeExit']);
            $data['literalNotApply'] = cleanStr($data['literalNotApply']);

            $data['expedientID'] = cleanStr($data['expedientID']);

            $data['literalWhoTakes'] = $data['literalWhoTakes'] == '' ? 'null' : $data['literalWhoTakes'];
            $data['literalCivilRegister'] = $data['literalCivilRegister'] == '' ? 'null' : $data['literalCivilRegister'];
            $literalDateExit = $data['literalDateExit'] == '' ? 'null' :  "'". $data['literalDateExit'] . "'";
            $literalDateExit = $data['literalDateExit'] == 'null' ? 'null' :  "'". $data['literalDateExit'] . "'";
            $literalTimeExit = $data['literalTimeExit'] == '' ? 'null' :  "'". $data['literalTimeExit'] . "'";
            
            return $db->query(" UPDATE  Expedients_Services 
                                SET     literalReceived = " . $data['literalReceived'] . ",
                                        literalNoFinished = " . $data['literalNoFinished'] . ",
                                        literalRequest = " . $data['literalRequest'] . ",
                                        literalVolumePage = '" . $data['literalVolumePage'] . "',
                                        literalWhoTakes = '" . $data['literalWhoTakes'] . "',
                                        literalCivilRegister = '" . $data['literalCivilRegister'] . "',
                                        literalDateExit = $literalDateExit,
                                        literalTimeExit = $literalTimeExit,
                                        literalNotApply = " . $data['literalNotApply'] . "
                                WHERE   expedient = " . $data['expedientID']);
        }

        /**
         * Guarda el servicio de un expediente - Tipo TPV
         *
         * @param array $data
         * 
         * @return bool
         */
        function saveServiceExpedientTPV($data){
            $db = new DbHandler;
            
            $data['expedientID'] = cleanStr($data['expedientID']);
            $data['arriveTime'] = cleanStr($data['arriveTime']);
            $data['arriveDate'] = cleanStr($data['arriveDate']);
            $data['priestTime'] = cleanStr($data['priestTime']);
            $data['priestTimeCheck'] = cleanStr($data['priestTimeCheck']);
            $data['priestInspected'] = cleanStr($data['priestInspected']);
            $data['priestPayed'] = cleanStr($data['priestPayed']);
            $data['priestNotes'] = cleanTextArea($data['priestNotes']);
            $data['choir'] = cleanStr($data['choir']);
            $data['gravediggersCheck'] = cleanStr($data['gravediggersCheck']);
            $data['gravediggersCheckSigned'] = cleanStr($data['gravediggersCheckSigned']);
            $data['gravediggersCheckPrinted'] = cleanStr($data['gravediggersCheckPrinted']);
            $data['gravediggersNotApply'] = cleanStr($data['gravediggersNotApply']);
            $data['notApplyAll'] = cleanStr($data['notApplyAll']);
            $data['crematoriumProgramOven'] = isset($data['crematoriumProgramOven']) ? cleanStr($data['crematoriumProgramOven']) : 0;
            $data['crematoriumWhoDelivered'] = isset($data['crematoriumWhoDelivered']) ? cleanStr($data['crematoriumWhoDelivered']) : '';
            $data['crematoriumWhoProgramOven'] = isset($data['crematoriumWhoProgramOven']) ? cleanStr($data['crematoriumWhoProgramOven']) : '';
            $data['crematoriumNotes'] = isset($data['crematoriumNotes']) ? cleanTextArea($data['crematoriumNotes']) : '';
            $data['crematoriumControlDeliversAshes'] = isset($data['crematoriumControlDeliversAshes']) ? cleanStr($data['crematoriumControlDeliversAshes']) : 0;
            $data['crematoriumWhoProgramOven'] = $data['crematoriumWhoProgramOven'] == '' ? 'null' : $data['crematoriumWhoProgramOven'];
            $data['crematoriumWhoDelivered'] = $data['crematoriumWhoDelivered'] == '' ? 'null' : $data['crematoriumWhoDelivered'];
            $data['crematoriumNotes'] = $data['crematoriumNotes'] == '' ? 'null' : "'". $data['crematoriumNotes'] . "'";
            $data['arriveTime'] != 'null' ? $arriveTime = "arriveTime = '" . $data['arriveTime'] . "'," : $arriveTime = "arriveTime = null,";
            $data['arriveDate'] != 'null' ? $arriveDate = "arriveDate = '" . $data['arriveDate'] . "'," : $arriveDate = "arriveDate = null,";

            return $db->query(" UPDATE  Expedients_Services 
                                SET     choir = " . $data['choir'] . ", 
                                        " . $arriveTime . "
                                        " . $arriveDate . "
                                        gravediggersCheck = " . $data['gravediggersCheck'] . ", 
                                        gravediggersCheckSigned = " . $data['gravediggersCheckSigned'] . ", 
                                        gravediggersCheckPrinted = " . $data['gravediggersCheckPrinted'] . ", 
                                        gravediggersNotApply = " . $data['gravediggersNotApply'] . ", 
                                        notes = '" . $data['notes'] . "',
                                        priestTimeCheck = " . $data['priestTimeCheck'] . ",
                                        priestInspected = " . $data['priestInspected'] . ",
                                        priestPayed = " . $data['priestPayed'] . ",
                                        priestNotes = '" . $data['priestNotes'] . "',
                                        notApplyAll = " . $data['notApplyAll'] . ",
                                        crematoriumProgramOven = " . $data['crematoriumProgramOven'] . ",
                                        crematoriumWhoProgramOven = " . $data['crematoriumWhoProgramOven'] . ",
                                        crematoriumWhoDelivered = " . $data['crematoriumWhoDelivered'] . ",
                                        crematoriumNotes = " . $data['crematoriumNotes'] . ",
                                        crematoriumControlDeliversAshes = " . $data['crematoriumControlDeliversAshes'] . ",
                                        carriersTimeCheck = 1,
                                        literalReceived = 1,
                                        literalNoFinished = 1,
                                        literalRequest = 1,
                                        literalNotApply = 1,
                                        policeNotified = 1,
                                        policeNotApply = 1,
                                        tribunalInProgress = 1,
                                        tribunalDeliver = 1,
                                        tribunalNotApply = 1,
                                        doctorInProgress = 1,
                                        doctorDone = 1,
                                        doctorDeliver = 1,
                                        doctorNotApply = 1,
                                        webConfirm = 1,
                                        webNotApply = 1,
                                        preparationConfirm = 1,
                                        preparationNotApply = 1,
                                        tombstoneNotApply = 1,
                                        tombstonePrint = 1,
                                        surveySend = 1,
                                        surveyNotApply = 1,
                                        vivoSent = 1
                                WHERE   expedient = " . $data['expedientID']);
        }

        /**
         * Obtiene los curas
         *
         * @param int $data
         * @return array
         */
        public function getPriests($data){
            $db = new DbHandler;
            $priestDuration = new Settings();

            $data['service'] = cleanStr($data['service']);
            $data['q'] = cleanStr($data['q']);
            $data['fromTime'] = cleanStr($data['fromTime']);

            $duration = $priestDuration->getTime('Curas');
            $funeralDate = $this->getFuneralDate($data['service']);
            $funeralTime = $this->getFuneralTime($data['service']);

            $priests = $db->query(" SELECT      p.*
                                    FROM        (Priests p)
                                    LEFT JOIN   Locations l ON p.location = l.locationID
                                    LEFT JOIN   ChurchesPriests chpr ON p.priestID = chpr.priest
                                    LEFT JOIN   Churches ch ON chpr.church = ch.churchID
                                    WHERE       (
                                                    p.name LIKE '%" . $data['q'] . "%' OR
                                                    p.surname LIKE '%" . $data['q'] . "%' OR
                                                    l.name LIKE '%" . $data['q'] . "%' OR
                                                    p.area LIKE '%" . $data['q'] . "%' OR
                                                    p.parish LIKE '%" . $data['q'] . "%' OR
                                                    ch.name LIKE '%" . $data['q'] . "%'
                                                ) AND 
                                                p.leavingDate IS NULL AND
                                                NOT EXISTS( 
                                                    SELECT  sp.priest 
                                                    FROM    Services_Priests sp
                                                    WHERE   p.priestID = sp.priest AND
                                                            sp.service = " . $data['service'] . "
                                                )
                                    GROUP BY    p.priestID
                                    ORDER BY    p.name");

            $priests = $db->resultToArray($priests);
            
            // Obtiene los curas que ya están ocupados para ese momento
            $toShow = array();
            foreach($priests as $index => $priest){
                $result = $db->query("  SELECT  e.number
                                        FROM    Services_Priests sp, Expedients e
                                        WHERE   sp.service = e.expedientID AND
                                                sp.priest = " . $priest['priestID'] . " AND
                                                sp.day = '" . $funeralDate . "' AND
                                                CAST(UNIX_TIMESTAMP(CONCAT(sp.day, ' $funeralTime')) AS UNSIGNED) BETWEEN CAST(UNIX_TIMESTAMP((CONCAT(sp.day, ' ', sp.fromTime) - INTERVAL $duration HOUR)) AS UNSIGNED) AND CAST(UNIX_TIMESTAMP(CONCAT(sp.day, ' ', sp.toTime)) AS UNSIGNED)");

                if(mysqli_num_rows($result) == 0){
                    $priest['busy'] = 0;
                    $priest['number'] = '';
                }else{
                    $priest['busy'] = 1;
                    $number = $db->resultToArray($result)[0]['number'];
                    $priest['number'] = ' - ' . $number;
                }

                array_push($toShow, $priest);
            }

            return $toShow;
        }

        /**
         * Añade un cura a un servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function setPriest($data){
            $db = new DbHandler;
            $priestDuration = new Settings();

            $data['service'] = cleanStr($data['service']);
            $data['fromTime'] = cleanStr($data['fromTime']);
            $data['priest'] = cleanStr($data['priest']);

            $duration = $priestDuration->getTime('Curas');
            $funeralDate = $this->getFuneralDate($data['service']);
            if(empty($funeralDate) || $funeralDate == null || $funeralDate == ''){
                $funeralDate = 'null';
            }else{
                $funeralDate = "'". $funeralDate."'";
            }
            $toTime = date('H:i:s', strtotime($data['fromTime']) + (60 * 60 * $duration));

            $result = $db->query("  INSERT INTO Services_Priests(service, priest, notified, day, fromTime, toTime) 
                                    VALUES(" . $data['service'] . ", " . $data['priest'] . ", 0, $funeralDate, '" . $data['fromTime'] .  "', '" . $toTime .  "')");

            return $result ? true : false;
        }

        /**
         * Añade un cura a un servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function setChoir($data){
            $db = new DbHandler;

            $data['service'] = cleanStr($data['service']);
            $data['fromTime'] = cleanStr($data['fromTime']);
            $data['choir'] = cleanStr($data['choir']);

            $choirDuration = new Settings();

            $duration = $choirDuration->getTime('Coros');
            $funeralDate = $this->getFuneralDate($data['service']);

            if(empty($funeralDate) || $funeralDate == null || $funeralDate == ''){
                $funeralDate = 'null';
            }else{
                $funeralDate = "'". $funeralDate."'";
            }       

            $toTime = date('H:i:s', strtotime($data['fromTime']) + (60 * 60 * $duration));
            $data['fromTime'] = date('H:i:s', strtotime($data['fromTime']) - (60 * 60 * 1));

            $result = $db->query("  INSERT INTO Services_Choirs(service, choir, notified, day, fromTime, toTime) 
                                    VALUES(" . $data['service'] . ", " . $data['choir'] . ", 0,  $funeralDate, '" . $data['fromTime'] .  "', '" . $toTime .  "')");

            return $result ? true : false;
        }

        /**
         * Añade un campanero a un servicio
         * 
         * @param array $data
         * @return bool
         */
        public function setBellringer($data){
            $db = new DbHandler;

            $data['service'] = cleanStr($data['service']);
            $data['fromTime'] = cleanStr($data['fromTime']);
            $data['bellringer'] = cleanStr($data['bellringer']);

            $bellringerDuration = new Settings();
            $duration = $bellringerDuration->getTime('Campaneros');
            $funeralDate = $this->getFuneralDate($data['service']);

            if(empty($funeralDate) || $funeralDate == null || $funeralDate == ''){
                $funeralDate = 'null';
            }else{
                $funeralDate = "'". $funeralDate."'";
            }

            $toTime = date('H:i:s', strtotime($data['fromTime']) + (60 * 60 * $duration));
            $data['fromTime'] = date('H:i:s', strtotime($data['fromTime']) - (60 * 60 * 1));

            $result = $db->query("  INSERT INTO Services_Bellringers(service, bellringer, notified, day, fromTime, toTime) 
                                    VALUES(" . $data['service'] . ", " . $data['bellringer'] . ", 0, $funeralDate, '" . $data['fromTime'] .  "', '" . $toTime .  "')");

            return $result ? true : false;
        }

        /**
         * Obtiene la fecha de funeral de un expediente
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function getFuneralDate($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT  e.funeralDate, e.funeralTime
                                    FROM    Expedients e
                                    WHERE   e.expedientID = " . $data);

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0]['funeralDate'] : null;
        }

        /**
         * Obtiene la hora de funeral de un expediente
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function getFuneralTime($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT  e.funeralTime
                                    FROM    Expedients e
                                    WHERE   e.expedientID = " . $data . "");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0]['funeralTime'] : null;
        }

        /**
         * Comprueba si un cura ya se ha añadido al servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function checkPriest($data){
            $db = new DbHandler;

            $data['service'] = cleanStr($data['service']);
            $data['priest'] = cleanStr($data['priest']);

            $result = $db->query("  SELECT  ID 
                                    FROM    Services_Priests
                                    WHERE   service = " . $data['service'] . " AND 
                                            priest = " . $data['priest'] . "");

            return mysqli_num_rows($result) > 0 ? true : false;
        }

        /**
         * Modifica un cura añadido al servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function updatePriest($data){
            $db = new DbHandler;

            $data['notified'] = cleanStr($data['notified']);
            $data['servicePriest'] = cleanStr($data['servicePriest']);

            $result = $db->query("  UPDATE  Services_Priests 
                                    SET     notified = " . $data['notified'] . " 
                                    WHERE   ID = " . $data['servicePriest'] . "");

            return $result > 0 ? true : false;
        }

        /**
         * Elimina un cura añadido al servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function deletePriest($data){
            $db = new DbHandler;

            $data['servicePriest'] = cleanStr($data['servicePriest']);

            $result = $db->query("DELETE FROM Services_Priests WHERE ID = " . $data['servicePriest'] . "");
            return $result > 0 ? true : false;
        }

        /**
         * Elimina un coro añadido al servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function deleteChoir($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("DELETE FROM Services_Choirs WHERE ID = " . $data);

            return $result > 0 ? true : false;
        }

        /**
         * Elimina un campanero añadido al servicio
         * 
         * @param array $data ID del servicio
         * @return bool
         */
        public function deleteBellringer($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $db->query("DELETE FROM Services_Bellringers WHERE ID = " . $data);

            return true;
        }

        /**
         * Obtiene los enterradores
         *
         * @param int $data
         * 
         * @return array
         */
        public function getGravediggers($data){
            $db = new DbHandler;
            $gravediggerDuration = new Settings;

            $data['q'] = cleanStr($data['q']);
            $data['service'] = cleanStr($data['service']);
 
            $duration = $gravediggerDuration->getTime('Enterradores');
            $funeralDate = $this->getFuneralDate($data['service']);
            $funeralTime = $this->getFuneralTime($data['service']);
            $time = date('H:i:s', strtotime($funeralTime));

            $gravediggers = $db->query("SELECT      g.gravediggerID,
                                                    CONCAT(
                                                        g.name,
                                                        IF(
                                                            (
                                                                SELECT  GROUP_CONCAT(c.name SEPARATOR ', ')
                                                                FROM    GravediggersCemeteries gc, Cemeteries c
                                                                WHERE   gc.gravedigger = g.`gravediggerID` AND
                                                                        gc.cemetery = c.`cemeteryID`
                                                            ) IS NULL,
                                                            '',
                                                            CONCAT(
                                                                ' - ',
                                                                COALESCE(
                                                                    (
                                                                        SELECT  GROUP_CONCAT(c.name SEPARATOR ', ')
                                                                        FROM    GravediggersCemeteries gc, Cemeteries c
                                                                        WHERE   gc.gravedigger = g.`gravediggerID` AND
                                                                                gc.cemetery = c.`cemeteryID`
                                                                    ),
                                                                    ''
                                                                )
                                                            )
                                                        )
                                                    ) as name
                                        FROM        Gravediggers g
                                        LEFT JOIN   Locations l ON g.location = l.locationID
                                        WHERE       (
                                                        g.name LIKE '%" . $data['q'] . "%' OR
                                                        l.name LIKE '%" . $data['q'] . "%'
                                                    ) AND 
                                                    g.leavingDate IS NULL AND
                                                    NOT EXISTS( SELECT  sg.gravedigger
                                                                FROM    Services_Gravediggers sg 
                                                                WHERE   g.gravediggerID = sg.gravedigger AND
                                                                        sg.service = " . $data['service'] . ")
                                        ORDER BY    g.name");

            $gravediggers = $db->resultToArray($gravediggers);

            if($gravediggers != null){
                // Obtiene los porteadores que ya están ocupados para ese momento
                $toShow = array();
                foreach($gravediggers as $gravedigger){

                    $result = $db->query("  SELECT  e.number
                                            FROM    Services_Gravediggers sg, Expedients e, Gravediggers g
                                            WHERE   sg.service = e.expedientID AND
                                                    sg.gravedigger = " . $gravedigger['gravediggerID'] . " AND
                                                    sg.day = '" . $funeralDate . "' AND
                                                    UNIX_TIMESTAMP(TIME('" . $time . "')) BETWEEN UNIX_TIMESTAMP(sg.fromTime) - TIME('$duration') AND UNIX_TIMESTAMP(sg.toTime) 
                                                    AND e.leavingDate IS NULL  
                                                    AND sg.gravedigger = g.gravediggerID 
                                                    AND g.leavingDate IS NULL");

                    if(mysqli_num_rows($result) == 0){
                        $gravedigger['busy'] = 0;
                        $gravedigger['number'] = '';
                    }else{
                        $gravedigger['busy'] = 1;
                        $number = $db->resultToArray($result)[0]['number'];
                        $gravedigger['number'] = ' - ' . $number;
                    }

                    array_push($toShow, $gravedigger);
                }
            }

            foreach($toShow as $key => $value){
                foreach($toShow as $key2 => $value2){
                    if($value['gravediggerID'] == $value2['gravediggerID'] && $key != $key2){
                        unset($toShow[$key]);
                    }
                }
            }

            return $toShow;
        }

        /**
         * Obtiene los campaneros
         * 
         * @param array $data Nombre del campanero
         * @return array
         */
        public function getBellringers($data){
            $db = new DbHandler;

            $data['q'] = cleanStr($data['q']);

            $result = $db->query("  SELECT  *
                                    FROM    BellRingers
                                    WHERE   (
                                                name LIKE '%" . $data['q'] . "%' OR 
                                                surname LIKE '%" . $data['q'] . "%' OR 
                                                parish LIKE '%" . $data['q'] . "%') AND
                                            leavingDate IS NULL
                                    ORDER BY name");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }

        /**
         * Añade un enterrador a un servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function setGravedigger($data){
            $db = new DbHandler;
            $gravediggerDuration = new Settings();

            $data['service'] = cleanStr($data['service']);
            $data['gravedigger'] = cleanStr($data['gravedigger']);

            $duration = $gravediggerDuration->getTime('Enterradores');
            $funeralDate = $this->getFuneralDate($data['service']);
            
            if(empty($funeralDate) || $funeralDate == null || $funeralDate == ''){
                $funeralDate = 'null';
            }else{
                $funeralDate = "'". $funeralDate."'";
            }
            $toTime = date('H:i:s', strtotime($this->getFuneralTime($data['service'])) + (60 * 60 * $duration));

            $result = $db->query("  INSERT INTO Services_Gravediggers(service, gravedigger, notified, day, fromTime, toTime) 
                                    VALUES(" . $data['service'] . ", " . $data['gravedigger'] . ", 0, $funeralDate, '" . $this->getFuneralTime($data['service']) .  "', '" . $toTime .  "')");

            return $result ? true : false;
        }

        /**
         * Comprueba si un enterrador ya se ha añadido al servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function checkGravedigger($data){
            $db = new DbHandler;

            $data['service'] = cleanStr($data['service']);
            $data['gravedigger'] = cleanStr($data['gravedigger']);

            $result = $db->query("  SELECT  ID 
                                    FROM    Services_Gravediggers 
                                    WHERE   service = " . $data['service'] . " AND 
                                            gravedigger = " . $data['gravedigger'] . "");

            return mysqli_num_rows($result) > 0 ? true : false;
        }

        /**
         * Modifica un enterrador añadido al servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function updateGravedigger($data){
            $db = new DbHandler;

            $data['notified'] = cleanStr($data['notified']);
            $data['serviceGravedigger'] = cleanStr($data['serviceGravedigger']);

            $result = $db->query("  UPDATE  Services_Gravediggers 
                                    SET     notified = " . $data['notified'] . " 
                                    WHERE   ID = " . $data['serviceGravedigger'] . "");

            return $result > 0 ? true : false;
        }

        /**
         * Modifica un enterrador añadido al servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function updateChoir($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  UPDATE  Services_Choirs
                                    SET     notified = IF(notified = 0, 1, IF(notified = 1, 0, 0))
                                    WHERE   ID = " . $data);

            return $result > 0 ? true : false;
        }

        /**
         * Modifica un campanero añadido al servicio
         * 
         * @param array $data
         * @return bool
         */
        public function updateBellringer($data){
            $db = new DbHandler;

            $data['bellringerID'] = cleanStr($data['bellringerID']);

            return $db->query(" UPDATE  Services_Bellringers
                                SET     notified = IF(notified = 0, 1, IF(notified = 1, 0, 0))
                                WHERE   ID = " . $data['bellringerID']);
        }

        /**
         * Elimina un enterrador añadido al servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function deleteGravedigger($data){
            $db = new DbHandler;

            $data['serviceGravedigger'] = cleanStr($data['serviceGravedigger']);

            return $db->query(" DELETE FROM Services_Gravediggers WHERE ID = " . $data['serviceGravedigger'] . "");
        }

        /**
         * Obtiene los coros
         *
         * @param int $data
         * 
         * @return array
         */
        public function getChoirs($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT  * 
                                    FROM    Choirs 
                                    WHERE   leavingDate IS NULL AND name LIKE '%". $data ."%'
                                    ORDER BY name");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }

        /**
         * Obtiene los porteadores
         *
         * @param int $data
         * 
         * @return array
         */
        public function getCarriers($data){
            $db = new DbHandler;

            $data['q'] = cleanStr($data['q']);
            $data['service'] = cleanStr($data['service']);
            
            $funeralDate = $this->getFuneralDate($data['service']);
            $funeralTime = $this->getFuneralTime($data['service']);

            $result = $db->query("  SELECT      c.*, sc.day, sc.fromTime, sc.toTime
                                    FROM        Carriers c
                                    LEFT JOIN   Services_Carriers sc ON c.carrierID = sc.carrier
                                    WHERE       (c.name LIKE '%" . $data['q'] . "%' OR c.surname LIKE '%" . $data['q'] . "%') AND 
                                                c.leavingDate IS NULL AND
                                                NOT EXISTS( 
                                                    SELECT  sc.carrier
                                                    FROM    Services_Carriers sc 
                                                    WHERE   c.carrierID = sc.carrier AND
                                                            sc.service = " . $data['service'] . "
                                                )
                                    ORDER BY    c.name");
            $carriers = $db->resultToArray($result);

            // Obtiene los porteadores que ya están ocupados para ese momento
            $toShow = array();
            foreach($carriers as $carrier){
                if($carrier['day'] != null){
                    $result = $db->query("  SELECT  e.number
                                            FROM    Services_Carriers sc, Expedients e
                                            WHERE   sc.service = e.expedientID AND
                                                    sc.carrier = " . $carrier['carrierID'] . " AND
                                                    sc.day = '" . $funeralDate . "' AND
                                                    (UNIX_TIMESTAMP(TIME('$funeralTime')) BETWEEN UNIX_TIMESTAMP(TIME(e.funeralTime)) AND (UNIX_TIMESTAMP(TIME(e.funeralTime)) + TIME(3) * 60 * 60) OR
                                                    (UNIX_TIMESTAMP(TIME('$funeralTime')) + TIME(3) * 60 * 60) BETWEEN UNIX_TIMESTAMP(TIME(e.funeralTime)) AND (UNIX_TIMESTAMP(TIME(e.funeralTime)) + TIME(3) * 60 * 60))");

                    if(mysqli_num_rows($result) == 0){
                        $carrier['busy'] = 0;
                        $carrier['number'] = '';
                    }else{
                        $carrier['busy'] = 1;
                        $number = $db->resultToArray($result)[0]['number'];
                        $carrier['number'] = ' - ' . $number;
                    }
                }else{
                    $carrier['busy'] = 0;
                    $carrier['number'] = '';
                }

                if(array_search($carrier['carrierID'], array_column($toShow, 'carrierID')) === false){
                    array_push($toShow, $carrier);  
                }
            }
            
            return $toShow;
        }

        /**
         * Comprueba si el servicio religioso está marcado en la contratación
         * 
         * @param int expedient Id del expediente
         * @return bool
         */
        public function checkBlockProduct($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $maxNumHiring = $this->getActiveHiring($expedient);

            $result = $db->query("  SELECT  p.serviceBelow
                                    FROM    Expedients_Hirings eh, Products p
                                    WHERE   eh.expedient = $expedient AND
                                            eh.num_hiring = $maxNumHiring AND
                                            eh.product = p.productID AND
                                            eh.check = 1 AND p.serviceBelow != 0
            ");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }

        /**
         * Obtiene los porteadores de un servicio para asignarlo como conductor
         *
         * @param int $data
         * 
         * @return array
         */
        public function getCarriersService($data){
            $db = new DbHandler;

            $data['service'] = cleanStr($data['service']);
            $search = $data['q'];
           
            $result = $db->query("  SELECT      c.carrierID, c.name, c.surname, e.number AS number, '0' AS busy
                                    FROM        Carriers c, Services_Carriers sc, Expedients e
                                    WHERE       c.carrierID = sc.carrier AND
                                                c.leavingDate IS NULL AND
                                                e.expedientID = " . $data['service'] . " AND
                                                sc.service = " . $data['service'] . " AND
                                                (
                                                    c.name LIKE '%$search%' OR
                                                    c.surname LIKE '%$search%'
                                                )
                                    ORDER BY    c.name");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }

        /**
         * Añade un porteador a un servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function setCarrier($data){
            $db = new DbHandler;
            $carrierDuration = new Settings();

            $data['service'] = cleanStr($data['service']);
            $data['fromTime'] = cleanStr($data['fromTime']);
            $data['carrier'] = cleanStr($data['carrier']);

            $duration = $carrierDuration->getTime('Porteadores');
            $funeralDate = $this->getFuneralDate($data['service']);

            if(empty($funeralDate) || $funeralDate == null || $funeralDate == ''){
                $funeralDate = 'null';
            }else{
                $funeralDate = "'". $funeralDate."'";
            }

            $toTime = date('H:i:s', strtotime($data['fromTime']) + (60 * 60 * $duration));

            $result = $db->query("  INSERT INTO Services_Carriers(service, carrier, confirmed, day, fromTime, toTime) 
                                    VALUES(" . $data['service'] . ", " . $data['carrier'] . ", 0, $funeralDate, '" . $data['fromTime'] .  "', '" . $toTime .  "')");

            return $result ? true : false;
        }

        /**
         * Comprueba si un porteador ya se ha añadido al servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function checkCarrier($data){
            $db = new DbHandler;

            $data['service'] = cleanStr($data['service']);
            $data['carrier'] = cleanStr($data['carrier']);

            $result = $db->query("  SELECT  ID 
                                    FROM    Services_Carriers 
                                    WHERE   service = " . $data['service'] . " AND 
                                            carrier = " . $data['carrier'] . "");

            return mysqli_num_rows($result) > 0 ? true : false;
        }

        /**
         * Comprueba si un coche ya se ha añadido al servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function checkCar($data){
            $db = new DbHandler;

            $data['service'] = cleanStr($data['service']);
            $data['car'] = cleanStr($data['car']);

            $result = $db->query("  SELECT  ID 
                                    FROM    Services_Cars 
                                    WHERE   service = " . $data['service'] . " AND 
                                            car = " . $data['car'] . "");

            return mysqli_num_rows($result) > 0 ? true : false;
        }

        /**
         * Comprueba si un coche ya se ha añadido al servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function getServiceCar($id){
            $db = new DbHandler;

            $data['id'] = cleanStr($id);

            $result = $db->query("  SELECT  * 
                                    FROM    Services_Cars 
                                    WHERE   ID = $id");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0];
        }
        /**
         * Comprueba si un coche ya se ha añadido al servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function getServicePriest($id){
            $db = new DbHandler;

            $data['id'] = cleanStr($id);

            $result = $db->query("  SELECT  * 
                                    FROM    Services_Priests 
                                    WHERE   ID = $id");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0];
        }
        /**
         * Comprueba si un coche ya se ha añadido al servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function getServiceChoir($id){
            $db = new DbHandler;

            $data['id'] = cleanStr($id);

            $result = $db->query("  SELECT  * 
                                    FROM    Services_Choirs 
                                    WHERE   service = $id");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0];
        }
        /**
         * Comprueba si un coche ya se ha añadido al servicio
         * 
         * @param array $data
         * 
         * @return bool
         */

        public function getServiceGravedigger($id){
            $db = new DbHandler;

            $data['id'] = cleanStr($id);

            $result = $db->query("  SELECT  * 
                                    FROM    Services_Gravediggers 
                                    WHERE   id = $id");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0];
        }
        
        /**
         * Añade un porteador a un servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function setCar($data){
            $db = new DbHandler;

            $data['service'] = cleanStr($data['service']);
            $data['car'] = cleanStr($data['car']);

            $result = $db->query("  INSERT INTO Services_Cars(service, car) 
                                    VALUES(" . $data['service'] . ", " . $data['car'] . ")");

            // Checks if exists in expedient other car like 'vehiculo de conduccion'
            $result = $db->query("  SELECT  COUNT(*) as total
                                    FROM    Services_Cars sc, Cars c
                                    WHERE   sc.service = " . $data['service'] . " AND
                                            sc.car = c.ID AND
                                            c.drivingService = 1 AND
                                            c.ID = " . $data['car']);

            $responseDrivingCar = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0];

            // If no exists, sets this car like 'vehiculo de conduccion'
            if($responseDrivingCar != null && intval($responseDrivingCar['total']) == 1){

                $result = $db->query("  UPDATE  Expedients
                                        SET     hearse = " . $data['car'] . "
                                        WHERE   expedientID = " . $data['service']);
            }

            $result = $db->query("  SELECT  sc.ID, c.licensePlate, c.brand, c.model
                                    FROM    Services_Cars sc, Cars c
                                    WHERE   sc.service = " . $data['service'] . " AND
                                            sc.car = " . $data['car'] . " AND
                                            sc.car = c.ID");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0];
        }

       
        public function updateCarrier($data){
            $db = new DbHandler;

            $data['confirmed'] = cleanStr($data['confirmed']);
            $data['serviceCarrier'] = cleanStr($data['serviceCarrier']);

            $result = $db->query("  UPDATE  Services_Carriers 
                                    SET     confirmed = " . $data['confirmed'] . " 
                                    WHERE   ID = " . $data['serviceCarrier'] . "");

            return $result > 0 ? true : false;
        }

        /**
         * Modifica un coche añadido al servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function updateCar($data){
            $db = new DbHandler;

            if($data != null){
                foreach($data as $elem){
                    $elem[0] = cleanStr($elem[0]);
                    $elem[1] = cleanStr($elem[1]);
                    $elem[2] = cleanStr($elem[2]);
                    $elem[3] = cleanStr($elem[3]);
    
                    $driver = $elem[1];
                    if($driver == ''){
                        $driver = 'null';
                    }
                    $cleanBefore = $elem[2];
                    if($cleanBefore == ''){
                        $cleanBefore = 'null';
                    }
                    $cleanAfter = $elem[3];
                    if($cleanAfter == ''){
                        $cleanAfter = 'null';
                    }
                    $db->query("UPDATE  Services_Cars
                                SET     driver = $driver,
                                        cleanBefore = $cleanBefore,
                                        cleanAfter = $cleanAfter
                                WHERE   ID = $elem[0]");
                }
            }

            return true;
        }

        /**
         * Elimina un porteador añadido al servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function getServiceCarrier($data){
            $db = new DbHandler;

            $data['serviceCarrier'] = cleanStr($data['serviceCarrier']);

            $result = $db->query("  SELECT  * 
                                    FROM    Services_Carriers 
                                    WHERE   ID = " . $data['serviceCarrier'] . "");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }
        /**
         * Elimina un porteador añadido al servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function deleteCarrierForServiceCar($service, $carrier){
            $db = new DbHandler;

            $service = cleanStr($service);
            $carrier = cleanStr($carrier);

            $result = $db->query("  UPDATE  Services_Cars 
                                    SET     driver = NULL
                                    WHERE   driver = $carrier AND service = $service");
            

            $result2 = $db->query("  SELECT  s.name, s.surname, sc.ID
                                     FROM    Services_Cars sc, Staff s, Staff_Posts sp
                                     WHERE   sc.service = $service AND  sc.cleanBefore = s.ID AND s.ID = sp.staff AND sp.post = 5");

            $result = $db->query("  SELECT  c.name, c.surname
                                    FROM    Carriers as c
                                    WHERE   c.carrierID = $carrier");

            if(mysqli_num_rows($result) > 0){
                $result2 = $db->resultToArray($result2);
                $result = $db->resultToArray($result)[0];
                if(count($result2) > 0){
                    foreach($result2 as $row){
                        if($row['name'] == $result['name'] && $row['surname'] == $result['surname']){
                            $id = $row['ID'];
                            $result = $db->query("  UPDATE  Services_Cars 
                                                    SET     cleanBefore = NULL
                                                    WHERE   ID = $id");
                        }
                    }
                }

            }

            $result = $db->query("  UPDATE  Services_Cars 
                                    SET     cleanAfter = NULL
                                    WHERE   cleanAfter = $carrier AND service = $service");

            return true;
        }

        /**
         * Elimina un porteador añadido al servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function deleteCarrier($data){
            $db = new DbHandler;

            $data['serviceCarrier'] = cleanStr($data['serviceCarrier']);

            return $db->query(" DELETE FROM Services_Carriers 
                                WHERE       ID = " . $data['serviceCarrier'] . "");

        }

        /**
         * Elimina un coche añadido al servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function deleteCar($data){
            $db = new DbHandler;

            $data['serviceCar'] = cleanStr($data['serviceCar']);

            $result = $db->query("  SELECT  sc.car, e.hearse, e.expedientID
                                    FROM    Services_Cars sc, Expedients e
                                    WHERE   sc.ID = " . $data['serviceCar'] . " AND
                                            e.expedientID = sc.service");

            $infoExpedient = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0];

            // If no exists, sets this car like 'vehiculo de conduccion'
            if($infoExpedient != null && intval($infoExpedient['car']) == intval($infoExpedient['hearse'])){

                $result = $db->query("  UPDATE  Expedients
                                        SET     hearse = null
                                        WHERE   expedientID = " . $infoExpedient['expedientID']);
            }

            $result = $db->query("  DELETE FROM Services_Cars 
                                    WHERE       ID = " . $data['serviceCar'] . "");

            return $result > 0 ? true : false;
        }

        /**
         * Obtiene las funerarias
         *
         * @param int $data
         * 
         * @return array
         */
        public function getFuneralHomes($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      funeralHomeID, name 
                                    FROM        FuneralHomes 
                                    WHERE       leavingDate IS NULL AND name LIKE '%". $data ."%'
                                    ORDER BY    name");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }

        /**
         * Obtiene los usuarios de tipo 'Funerario'
         *
         * @return array
         */
        public function getCorpseCollection(){
            $db = new DbHandler;

            $result = $db->query("  SELECT      s.ID, s.name, s.surname
                                    FROM        Staff s, Staff_Posts sp
                                    WHERE       s.ID = sp.staff AND sp.value = 1 AND sp.post IN (1,2,4,5,7,8,9) AND leavingDate IS NULL
                                    GROUP BY    s.ID
                                    ORDER BY    s.name");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }

        /**
         * Obtiene los usuarios de tipo 'Funerario'
         *
         * @return array
         */
        public function getCorpseCollection2($name){
            $db = new DbHandler;

            $name = cleanStr($name);

            $result = $db->query("  SELECT  s.ID as ID, CONCAT(s.name, ' ', s.surname) as name
                                    FROM    Staff s, Staff_Posts sp 
                                    WHERE   s.ID = sp.staff 
                                        AND sp.value = 1 
                                        AND sp.post IN (1,2,4,5,7,8,9) 
                                        AND leavingDate IS NULL
                                        AND (s.name LIKE '%$name%' OR s.surname LIKE '%$name%')
                                    GROUP BY s.ID
                                    ORDER BY s.name");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }

        /**
         * Obtiene los usuarios de tipo 'Asistencia'
         *
         * @param int $data
         * 
         * @return array
         */
        public function getFamilyAssistance($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      s.ID, s.name, s.surname
                                    FROM        Staff s, Staff_Posts sp
                                    WHERE       (
                                                    s.name LIKE '%". $data ."%' OR
                                                    s.surname LIKE '%". $data ."%'
                                                ) AND
                                                s.ID = sp.staff AND
                                                sp.value = 1 AND
                                                sp.post IN (1,2,3,4,8,9) AND
                                                leavingDate IS NULL
                                    GROUP BY    s.ID
                                    ORDER BY    s.name");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }

        /**
         * Obtiene los coches
         *
         * @param int $data
         * 
         * @return array
         */
        public function getCarCollection($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      * 
                                    FROM        Cars 
                                    WHERE       name LIKE '%" . $data . "%'
                                    ORDER BY    brandName");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }

        /**
         * Guarda los productos de los servicios del expediente
         * 
         * @param null|array $data
         * 
         * @return array
         */
        public function updateProductOthersSection($service, $data){
            $db = new DbHandler;

            $flag = 0;

            if($data != null && $data != ''){
                $result = $db->query("  SELECT  e.entryDate
                                        FROM    Expedients e 
                                        WHERE   e.expedientID = $service");

                $entryDate = strtotime($db->resultToArray($result)[0]['entryDate']);

                foreach($data as $product){
                    $product[0] = cleanStr($product[0]);
                    $product[1] = cleanStr($product[1]);
                    $product[2] = cleanTextArea($product[2]);
                    
                    if($entryDate >= 1716328800 && $product[3] != '0'){
                        $result = $db->query("  UPDATE  Services_Auto
                                                SET     value = '" . $product[2] . "'
                                                WHERE   service = " . $service . " AND 
                                                        model = " . $product[0] . " AND 
                                                        action = " . $product[1] . " AND
                                                        hiring = {$product[3]}");
                    }else{
                        $result = $db->query("  UPDATE  Services_Auto
                                                SET     value = '" . $product[2] . "'
                                                WHERE   service = " . $service . " AND 
                                                        model = " . $product[0] . " AND 
                                                        action = " . $product[1]);
                    }
    
                    if(!$result){
                        $flag++;
                    }
                }
            }

            return $flag > 0 ? false : true;
        }

        /**
         * Actualiza los productos que se colocan de forma automática en el servicio
         * 
         * @param int $id
         * @param array $data
         * @param string $entryDate Entry date expedient
         * @param string $hiringId Hiring id
         * @return bool
         */
        public function updateServiceAuto($id, $data, $entryDate, $hiringId){
            $fixDate = strtotime($entryDate);

            $db = new DbHandler;

            $id = cleanStr($id);
            $data[0] = cleanStr($data[0]);
            $data[1] = cleanStr($data[1]);
            $data[3] = cleanStr($data[3]);
            $data[4] = cleanStr($data[4]);

            $actions = $db->query(" SELECT  action
                                    FROM    Products_Actions 
                                    WHERE   checked = 1 AND 
                                            product = " . $data[3]);

            if(mysqli_num_rows($actions) > 0){
                $actions = $db->resultToArray($actions);

                foreach($actions as $action){
                    if($fixDate >= 1716328800){
                        if($data[0] == ''){
                            $db->query("INSERT INTO Services_Auto(service, model, action, value, status, hiring) 
                                        VALUES(" . $id . ", " . $data[4] . ", " . $action['action'] . ", 0, " . $data[1] . ", " . $hiringId . ")");
                        }else{
                            $result = $db->query("  SELECT  sa.ID
                                                    FROM    Services_Auto sa
                                                    WHERE   sa.service = " . $id . " AND 
                                                            sa.model = " . $data[4] . " AND 
                                                            sa.action = " . $action['action'] . " AND
                                                            sa.hiring = {$data[0]}");
    
                            if(mysqli_num_rows($result) > 0){
                                $sAutoId = $db->resultToArray($result)[0]['ID'];
    
                                $db->query("UPDATE  Services_Auto
                                            SET     status = " . $data[1] . " 
                                            WHERE   ID = $sAutoId");
                            }else{
                                $db->query("INSERT INTO Services_Auto(service, model, action, value, status, hiring) 
                                            VALUES(" . $id . ", " . $data[4] . ", " . $action['action'] . ", 0, " . $data[1] . ", " . $data[0] . ")");
                            }
                        }
                    }else{
                        $result = $db->query("  SELECT  sa.ID
                                                FROM    Services_Auto sa
                                                WHERE   sa.service = " . $id . " AND 
                                                        sa.model = " . $data[4] . " AND 
                                                        sa.action = " . $action['action']);

                        if(mysqli_num_rows($result) > 0){
                            $db->query("UPDATE  Services_Auto
                                        SET     status = " . $data[1] . " 
                                        WHERE   service = " . $id . " AND 
                                                model = " . $data[4] . " AND 
                                                action = " . $action['action']);
                        }else{
                            $db->query("INSERT INTO Services_Auto(service, model, action, value, status) 
                                        VALUES(" . $id . ", " . $data[4] . ", " . $action['action'] . ", 0, " . $data[1] . ")");
                        }
                    }
                }
            }
        }

        /**
         * Obtiene los usuarios que pueden repartir esquelas
         * 
         * @return array
         */
        public function getUsersObituaries($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT userID, name, surname 
                                    FROM Users 
                                    WHERE type = 5 AND 
                                          (name LIKE '%" . $data . "%' OR 
                                          surname LIKE '%" . $data . "%')
                                    ORDER BY name");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }

        /**
         * Obtiene los usuarios que pueden obtener el certificado médico
         * 
         * @return array
         */
        public function getUsersDoctor($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT userID, name, surname 
                                    FROM Users 
                                    WHERE type = 4 AND 
                                          (name LIKE '%" . $data . "%' OR 
                                          surname LIKE '%" . $data . "%')
                                    ORDER BY name");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }


        /**
         * Obtiene los datos de un usuario
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getUserById($data){
            $db = new DbHandler;

            $data['userID'] = cleanStr($data['userID']);

            $result = $db->query("  SELECT userID, name, surname 
                                    FROM Users 
                                    WHERE userID = " . $data['userID'] . "");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }

        /**
        * Obtiene los expedientes del día
        *
        * @return array
        */
        public function listTodayExpedients(){
            $db = new DbHandler;

            $list = array();

            // Expedientes
            $currentDate = date("Y-m-d");

            $result = $db->query("  SELECT      e.expedientID, e.type, e.funeralDate, e.funeralTime, e.number, e.deceasedGender, 
                                                e.deceasedName, e.deceasedSurname, e.deceasedRoom, e.crematoriumArriveTime, e.deceasedMortuaryAddress,
                                                e.ceremonyTime, e.funeralTimeBurial, e.cremation, ev.start as crematoriumEntry,
                                                e.startVelacionDate, e.startVelacionTime,
                                                m.name AS mortuary,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, c.name) as cemetery,
                                                l.name AS mortuaryLocation,
                                                IF(e.churchLabel = 'Otro', e.otherCeremony, ch.name) as church,
                                                es.carriersTime,
                                                f.name AS funeralHome,
                                                cr.name as crematoriumName
                                    FROM        (Expedients e, Expedients_Services es)
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   Cemeteries c ON e.cemetery = c.cemeteryID
                                    LEFT JOIN   Churches ch ON e.church = ch.churchID
                                    LEFT JOIN   Locations l ON ch.location = l.locationID
                                    LEFT JOIN   FuneralHomes f ON f.funeralHomeID = es.funeralHomeService
                                    LEFT JOIN   Crematoriums cr  ON e.crematorium = cr.crematoriumID
                                    LEFT JOIN   Events ev ON e.crematoriumEvent = ev.ID AND ev.leavingDate IS NULL
                                    WHERE       es.expedient = e.expedientID AND
                                                e.funeralDate LIKE '%$currentDate%' AND
                                                e.leavingDate IS NULL AND
                                                e.type != 2
                                    ORDER BY    e.funeralDate, e.funeralTime");

            $expedients = $db->resultToArray($result);

            if(mysqli_num_rows($result) > 0){
                foreach($expedients as $key => $expedient){
                    $carriers = $db->query("SELECT  c.name, c.surname, sc.confirmed
                                            FROM    Carriers c, Services_Carriers sc
                                            WHERE   c.carrierID = sc.carrier AND
                                                    sc.service = " . $expedient['expedientID']);

                    if(mysqli_num_rows($carriers) > 0){
                        $expedients[$key]['carriers'] = $db->resultToArray($carriers);
                    }else{
                        $expedients[$key]['carriers'] = array();
                    }

                    $cars = $db->query("    SELECT      ca.name AS driverName, ca.surname AS driverSurname, c.licensePlate, c.brand, c.model, sca.confirmed
                                            FROM        (Cars c, Services_Cars sc, Expedients e)
                                            LEFT JOIN   Carriers ca ON sc.driver = ca.carrierID
                                            LEFT JOIN   Services_Carriers sca ON ca.carrierID = sca.carrier AND sca.service = e.expedientID
                                            WHERE       e.expedientID = sc.service AND
                                                        c.ID = sc.car AND
                                                        sc.service = " . $expedient['expedientID']);

                    if(mysqli_num_rows($cars) > 0){
                        $expedients[$key]['cars'] = $db->resultToArray($cars);
                    }else{
                        $expedients[$key]['cars'] = array();
                    }

                    $maxNumHiring = $this->getActiveHiring($expedient['expedientID']);
                    $buses = $db->query("   SELECT  SUM(eh.amount) AS buses
                                            FROM    Expedients_Hirings eh, Products p
                                            WHERE   eh.expedient = " . $expedient['expedientID'] . " AND
                                                    eh.num_hiring = $maxNumHiring AND
                                                    eh.check = 1 AND
                                                    eh.product = p.productID AND
                                                    p.isBus = 1");

                    if(mysqli_num_rows($buses) > 0){
                        $expedients[$key]['buses'] = $db->resultToArray($buses)[0]['buses'];
                    }else{
                        $expedients[$key]['buses'] = 0;
                    }
                }
            }

            count($expedients) == 0 ? $list['expedients'] = null : $list['expedients'] = $expedients;

            // Cremaciones
            $result = $db->query("  SELECT      e.type, e.expedientID, e.number, e.deceasedName, e.deceasedSurname, e.crematoriumIntroduction, e.crematoriumWaitOnRoom, e.crematoriumVaseBio, e.deceasedGender,
                                                e.familyContactName, e.familyContactSurname, e.crematoriumArriveTime, e.familyContactMobilePhone, e.ecologicCoffin, e.crematoriumPacemaker,
                                                e.authDate, e.authTime, e.authPlace,
                                                ev.start,
                                                f.name AS funeralHome,
                                                e.crematorium as crematoriumID, cr.name AS crematoriumName
                                    FROM        (Expedients e, Expedients_Services es, Events ev)
                                    LEFT JOIN   FuneralHomes f ON f.funeralHomeID = es.funeralHomeService
                                    LEFT JOIN   Crematoriums cr  ON e.crematorium = cr.crematoriumID
                                    WHERE       es.expedient = e.expedientID AND
                                                e.cremation = 1 AND
                                                e.crematoriumEvent = ev.ID AND 
                                                ev.start LIKE '%$currentDate%' AND
                                                e.leavingDate IS NULL AND
                                                ev.status = 7
                                    ORDER BY    ev.start");

            $cremations = $db->resultToArray($result);
            
            count($cremations) == 0 ? $list['cremations'] = null : $list['cremations'] = $cremations;
            
            return $list;
        }

        /**
        * Obtiene los expedientes de un dia dado
        *
        * @return array
        */
        public function searchSummary($data){
            $db = new DbHandler;

            $list = array();

            $data['date'] = cleanStr($data['date']);
            $date =  $data['date'];

            $result = $db->query("  SELECT      e.expedientID, e.type, e.funeralDate, e.funeralTime, e.number, e.deceasedGender, 
                                                e.deceasedName, e.deceasedSurname, e.deceasedRoom, e.crematoriumArriveTime, e.deceasedMortuaryAddress,
                                                e.ceremonyTime, e.funeralTimeBurial, e.cremation, ev.start as crematoriumEntry,
                                                e.startVelacionDate, e.startVelacionTime,
                                                m.name AS mortuary,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, c.name) as cemetery,
                                                l.name AS mortuaryLocation,
                                                IF(e.churchLabel = 'Otro', e.otherCeremony, ch.name) as church,
                                                es.carriersTime,
                                                f.name AS funeralHome,
                                                cr.name as crematoriumName
                                    FROM        (Expedients e, Expedients_Services es)
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   Cemeteries c ON e.cemetery = c.cemeteryID
                                    LEFT JOIN   Churches ch ON e.church = ch.churchID
                                    LEFT JOIN   Locations l ON ch.location = l.locationID
                                    LEFT JOIN   FuneralHomes f ON f.funeralHomeID = es.funeralHomeService
                                    LEFT JOIN   Crematoriums cr  ON e.crematorium = cr.crematoriumID
                                    LEFT JOIN   Events ev ON e.crematoriumEvent = ev.ID AND ev.leavingDate IS NULL
                                    WHERE       es.expedient = e.expedientID AND
                                                e.funeralDate LIKE '%$date%' AND
                                                e.leavingDate IS NULL AND
                                                e.type != 2
                                    ORDER BY    e.funeralDate, e.funeralTime");

            $expedients = $db->resultToArray($result);

            if(mysqli_num_rows($result) > 0){
                foreach($expedients as $key => $expedient){
                    $carriers = $db->query("SELECT  c.name, c.surname, sc.confirmed
                                            FROM    Carriers c, Services_Carriers sc
                                            WHERE   c.carrierID = sc.carrier AND
                                                    sc.service = " . $expedient['expedientID']);

                    if(mysqli_num_rows($carriers) > 0){
                        $expedients[$key]['carriers'] = $db->resultToArray($carriers);
                    }else{
                        $expedients[$key]['carriers'] = array();
                    }

                    $cars = $db->query("    SELECT      ca.name AS driverName, ca.surname AS driverSurname, c.licensePlate, c.brand, c.model, sca.confirmed
                                            FROM        (Cars c, Services_Cars sc, Expedients e)
                                            LEFT JOIN   Carriers ca ON sc.driver = ca.carrierID
                                            LEFT JOIN   Services_Carriers sca ON ca.carrierID = sca.carrier AND sca.service = e.expedientID
                                            WHERE       e.expedientID = sc.service AND
                                                        c.ID = sc.car AND
                                                        sc.service = " . $expedient['expedientID']);

                    if(mysqli_num_rows($cars) > 0){
                        $expedients[$key]['cars'] = $db->resultToArray($cars);
                    }else{
                        $expedients[$key]['cars'] = array();
                    }

                    $maxNumHiring = $this->getActiveHiring($expedient['expedientID']);
                    $buses = $db->query("   SELECT  SUM(eh.amount) AS buses
                                            FROM    Expedients_Hirings eh, Products p
                                            WHERE   eh.expedient = " . $expedient['expedientID'] . " AND
                                                    eh.num_hiring = $maxNumHiring AND
                                                    eh.check = 1 AND
                                                    eh.product = p.productID AND
                                                    p.isBus = 1");

                    if(mysqli_num_rows($buses) > 0){
                        $expedients[$key]['buses'] = $db->resultToArray($buses)[0]['buses'];
                    }else{
                        $expedients[$key]['buses'] = 0;
                    }                                          

                }
            }
            
            count($expedients) == 0 ? $list['expedients'] = null : $list['expedients'] = $expedients;

            // Cremaciones
            $result = $db->query("  SELECT      e.expedientID, e.type, e.number, e.deceasedName, e.deceasedSurname, e.crematoriumIntroduction, e.crematoriumWaitOnRoom, e.crematoriumVaseBio, e.deceasedGender,
                                                e.familyContactName, e.familyContactSurname, e.crematoriumArriveTime, e.familyContactMobilePhone, e.ecologicCoffin, e.crematoriumPacemaker,
                                                ev.start,
                                                f.name AS funeralHome
                                    FROM        (Expedients e, Expedients_Services es, Events ev)
                                    LEFT JOIN   FuneralHomes f ON f.funeralHomeID = es.funeralHomeService
                                    WHERE       es.expedient = e.expedientID AND
                                                e.cremation = 1 AND 
                                                e.crematoriumEvent = ev.ID AND 
                                                ev.start LIKE '%$date%' AND
                                                e.leavingDate IS NULL AND
                                                ev.status = 7
                                    ORDER BY    ev.start");

            $cremations = $db->resultToArray($result);

            count($cremations) == 0 ? $list['cremations'] = null : $list['cremations'] = $cremations;

            return $list;
        }

        /**
        * Obtiene los expedientes de mañana
        *
        * @return array
        */
        public function listTomorrowExpedients(){
            $db = new DbHandler;

            $list = array();

            $currentDate = date("Y-m-d", time() + 60 * 60 * 24);
            $result = $db->query("  SELECT      e.expedientID, e.type, e.funeralDate, e.funeralTime, e.number, e.deceasedGender, 
                                                e.deceasedName, e.deceasedSurname, e.deceasedRoom, e.deceasedMortuaryAddress, 
                                                e.crematoriumArriveTime, 
                                                e.ceremonyTime, e.funeralTimeBurial, e.cremation, ev.start as crematoriumEntry,
                                                e.startVelacionDate, e.startVelacionTime,
                                                m.name AS mortuary,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, c.name) as cemetery,
                                                l.name AS mortuaryLocation,
                                                IF(e.churchLabel = 'Otro', e.otherCeremony, ch.name) as church,
                                                es.carriersTime,
                                                f.name AS funeralHome,
                                                cr.name as crematoriumName
                                    FROM        (Expedients e, Expedients_Services es)
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   Cemeteries c ON e.cemetery = c.cemeteryID
                                    LEFT JOIN   Churches ch ON e.church = ch.churchID
                                    LEFT JOIN   Locations l ON ch.location = l.locationID
                                    LEFT JOIN   FuneralHomes f ON f.funeralHomeID = es.funeralHomeService
                                    LEFT JOIN   Crematoriums cr  ON e.crematorium = cr.crematoriumID
                                    LEFT JOIN   Events ev ON e.crematoriumEvent = ev.ID AND ev.leavingDate IS NULL
                                    WHERE       es.expedient = e.expedientID AND
                                                e.funeralDate LIKE '%$currentDate%' AND
                                                e.leavingDate IS NULL AND
                                                e.type != 2
                                    ORDER BY    e.funeralDate, e.funeralTime");

            $expedients = $db->resultToArray($result);

            if(mysqli_num_rows($result) > 0){
                foreach($expedients as $key => $expedient){
                    $carriers = $db->query("SELECT  c.name, c.surname, sc.confirmed
                                            FROM    Carriers c, Services_Carriers sc
                                            WHERE   c.carrierID = sc.carrier AND
                                                    sc.service = " . $expedient['expedientID'] . "");

                    if(mysqli_num_rows($carriers) > 0){
                        $expedients[$key]['carriers'] = $db->resultToArray($carriers);
                    }else{
                        $expedients[$key]['carriers'] = array();
                    }

                    $cars = $db->query("    SELECT      ca.name AS driverName, ca.surname AS driverSurname, c.licensePlate, c.brand, c.model, sca.confirmed
                                            FROM        (Cars c, Services_Cars sc, Expedients e)
                                            LEFT JOIN   Carriers ca ON sc.driver = ca.carrierID
                                            LEFT JOIN   Services_Carriers sca ON ca.carrierID = sca.carrier AND sca.service = e.expedientID
                                            WHERE       e.expedientID = sc.service AND
                                                        c.ID = sc.car AND
                                                        sc.service = " . $expedient['expedientID']);

                    if(mysqli_num_rows($cars) > 0){
                        $expedients[$key]['cars'] = $db->resultToArray($cars);
                    }else{
                        $expedients[$key]['cars'] = array();
                    }

                    $maxNumHiring = $this->getActiveHiring($expedient['expedientID']);
                    $buses = $db->query("   SELECT  SUM(eh.amount) AS buses
                                            FROM    Expedients_Hirings eh, Products p
                                            WHERE   eh.expedient = " . $expedient['expedientID'] . " AND
                                                    eh.num_hiring = $maxNumHiring AND
                                                    eh.check = 1 AND
                                                    eh.product = p.productID AND
                                                    p.isBus = 1");

                    if(mysqli_num_rows($buses) > 0){
                        $expedients[$key]['buses'] = $db->resultToArray($buses)[0]['buses'];
                    }else{
                        $expedients[$key]['buses'] = 0;
                    }                                          
                }
            }
            
            count($expedients) == 0 ? $list['expedients'] = null : $list['expedients'] = $expedients;

            // Cremaciones
            $result = $db->query("  SELECT      e.expedientID, e.type, e.number, e.deceasedGender, e.deceasedName, e.deceasedSurname, e.crematoriumIntroduction, e.crematoriumWaitOnRoom, e.crematoriumVaseBio, e.deceasedGender,
                                                e.familyContactName, e.familyContactSurname, e.familyContactMobilePhone, e.crematoriumArriveTime, e.ecologicCoffin, e.crematoriumPacemaker,
                                                e.authDate, e.authTime, e.authPlace,
                                                ev.start,
                                                f.name AS funeralHome,
                                                e.crematorium as crematoriumID, cr.name AS crematoriumName
                                    FROM        (Expedients e, Expedients_Services es, Events ev)
                                    LEFT JOIN   FuneralHomes f ON f.funeralHomeID = es.funeralHomeService
                                     LEFT JOIN   Crematoriums cr  ON e.crematorium = cr.crematoriumID
                                    WHERE       es.expedient = e.expedientID AND
                                                e.cremation = 1 AND 
                                                e.crematoriumEvent = ev.ID AND 
                                                ev.start LIKE '%$currentDate%' AND
                                                e.leavingDate IS NULL AND
                                                ev.status = 7
                                    ORDER BY    ev.start");

            $cremations = $db->resultToArray($result);

            count($cremations) == 0 ? $list['cremations'] = null : $list['cremations'] = $cremations;

            return $list;
        }

        /**
         * Obtiene los datos para el resumen de flores de hoy
         * 
         * @param string $day Dat to consult
         * @return array
         */
        public function listSummaryFlowers($day){
            $db = new DbHandler;

            $list = array();

            $result = $db->query("  SELECT      e.expedientID, e.deceasedName, e.deceasedSurname
                                    FROM        Expedients e
                                    WHERE       e.funeralDate LIKE '%$day%' AND
                                                e.leavingDate IS NULL AND
                                                e.type != 2
                                    ORDER BY    e.funeralDate, e.funeralTime
            ");

            $expedients = [];

            if(mysqli_num_rows($result) > 0){
                $expedients = $db->resultToArray($result);
                foreach($expedients as $key => $expedient){
                    
                    $maxNumHiring = $this->getActiveHiring($expedient['expedientID']);

                    // Obtenemos los expedientes asociados al expediente actual
                    $result = $db->query("  SELECT  exas.expedientID
                                            FROM    Expedients_Associates exas
                                            WHERE   exas.associate = {$expedient['expedientID']} AND
                                                    exas.leavingDate IS NULL
                    ");
                    $expedientesAssociates = $db->resultToArray($result);

                    $expedientesAssociatesIds = '';
                    if(count($expedientesAssociates) > 0){
                        foreach($expedientesAssociates as $elem){
                            $expedientesAssociatesIds.= $elem['expedientID'] . ',';
                        }
                        if($expedientesAssociatesIds != ''){
                            $expedientesAssociatesIds = substr($expedientesAssociatesIds, 0, -1);
                        }
                    }

                    if($expedientesAssociatesIds != ''){

                        $result = $db->query("   SELECT  Z.product_name, 
                                                        Z.model_name, 
                                                        Z.texts, 
                                                        Z.supplier_name,
                                                        Z.deliveryDate
                                                FROM(
                                                        (
                                                            SELECT	    p.name as product_name, 
                                                                        pm.name as model_name,
                                                                        REPLACE(et.value, '\\\', '') as texts,
                                                                        sup.name as supplier_name,
                                                                        ord.deliveryDate
                                                            FROM	    (Expedients e, Expedients_Hirings eh, Products p, Products_Models pm, Suppliers sup)
                                                            LEFT JOIN   Expedients_Texts et ON eh.ID = et.hiring
                                                            LEFT JOIN   Pre_Orders po ON po.leavingDate IS NULL AND po.hiring = eh.ID
                                                            LEFT JOIN   Orders ord ON ord.leavingDate IS NULL AND po.order = ord.ID
                                                            WHERE	    e.expedientID = {$expedient['expedientID']} AND
                                                                        eh.expedient = e.expedientID AND
                                                                        eh.num_hiring = $maxNumHiring AND
                                                                        eh.check = 1 AND
                                                                        eh.product = p.productID AND
                                                                        p.blockBelow = 3 AND
                                                                        eh.model = pm.productModelID AND
                                                                        eh.supplier = sup.supplierID
                                                        )
                                                        UNION
                                                        (
                                                            SELECT      p.name as product_name, 
                                                                        pm.name as model_name,
                                                                        REPLACE(et.value, '\\\', '') as texts,
                                                                        sup.name as supplier_name,
                                                                        ord.deliveryDate
                                                            FROM        (Expedients e, Expedients_Hirings eh, Products p, Products_Models pm, Suppliers sup)
                                                            LEFT JOIN   Expedients_Texts et ON eh.ID = et.hiring
                                                            LEFT JOIN   Pre_Orders po ON po.leavingDate IS NULL AND po.hiring = eh.ID
                                                            LEFT JOIN   Orders ord ON ord.leavingDate IS NULL AND po.order = ord.ID
                                                            WHERE	    e.expedientID IN ($expedientesAssociatesIds) AND 
                                                                        eh.expedient = e.expedientID AND
                                                                        eh.num_hiring = 0 AND
                                                                        eh.check = 1 AND
                                                                        eh.product = p.productID AND
                                                                        p.blockBelow = 3 AND
                                                                        eh.model = pm.productModelID AND
                                                                        eh.supplier = sup.supplierID
                                                        )
                                                ) as Z
                        ");

                    }else{
                        $result = $db->query("  SELECT	    p.name as product_name, 
                                                            pm.name as model_name,
                                                            REPLACE(et.value, '\\\', '') as texts,
                                                            sup.name as supplier_name,
                                                            ord.deliveryDate
                                                FROM	    (Expedients e, Expedients_Hirings eh, Products p, Products_Models pm, Suppliers sup)
                                                LEFT JOIN   Expedients_Texts et ON eh.ID = et.hiring
                                                LEFT JOIN   Pre_Orders po ON po.leavingDate IS NULL AND po.hiring = eh.ID
                                                LEFT JOIN   Orders ord ON ord.leavingDate IS NULL AND po.order = ord.ID
                                                WHERE	    e.expedientID = {$expedient['expedientID']} AND
                                                            eh.expedient = e.expedientID AND
                                                            eh.num_hiring = $maxNumHiring AND
                                                            eh.check = 1 AND
                                                            eh.product = p.productID AND
                                                            p.blockBelow = 3 AND
                                                            eh.model = pm.productModelID AND
                                                            eh.supplier = sup.supplierID
                        ");
                    }


                    if(mysqli_num_rows($result) > 0){
                        $expedients[$key]['products'] = $db->resultToArray($result);
                    }else{
                        unset($expedients[$key]);
                    }
                }
            }

            count($expedients) == 0 ? $list['expedients'] = null : $list['expedients'] = array_values($expedients);

            return $list;
        }

        /**
         * Obtiene los datos de control del expediente
         * 
         * @param int $data ID del expediente
         * @return array
         */
        function readControl($data){
            $db = new DbHandler;

            $data['expedient'] = cleanStr($data['expedient']);

            $result = $db->query("  SELECT      sc.assistance, sc.notes, sc.mailTo, sc.send, sc.sent,
                                                e.number, e.deceasedName, e.deceasedSurname, e.deceasedNIF,
                                                e.capital, e.policy, e.lossNumber, e.clientType, e.deceasedDate, e.deceasedLocation,
                                                e.deceasedGender, e.deceasedMortuary,
                                                m.name as mortuaryName, di.name as deceasedInName
                                    FROM        (Services_Control sc, Expedients e)
                                    LEFT JOIN   DeceasedIn di ON di.deceasedInID = e.deceasedLocation
                                    LEFT JOIN   Mortuaries m ON m.mortuaryID = e.deceasedMortuary
                                    WHERE       sc.service = " . $data['expedient'] . " AND
                                                sc.service = e.expedientID");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $control = array();

                $result = $db->resultToArray($result)[0];
                $control['control'] = $result;

                $result = $db->query("  SELECT  e.ID, e.email
                                        FROM    Emails e, Services_Control_Emails scm
                                        WHERE   scm.email = e.ID AND expedient = " . $data['expedient']);

                if(mysqli_num_rows($result) == 0){
                    $control['emails'] = null;
                }else{
                    $result = $db->resultToArray($result);
                    $control['emails'] = $result;
                }


                $result = $db->query("  SELECT  a.ID, CONCAT(a.name, ' ', a.surname) as name
                                        FROM    Assistants a, Assistants_Control ac
                                        WHERE   ac.assistant = a.ID AND ac.expedient = " . $data['expedient']);

                if(mysqli_num_rows($result) == 0){
                    $control['assistances'] = null;
                }else{
                    $result = $db->resultToArray($result);
                    $control['assistances'] = $result;
                }

                $result = $db->query("  SELECT  emails
                                        FROM    Assistants_Emails_Control
                                        WHERE   expedient = " . $data['expedient']);

                if(mysqli_num_rows($result) == 0){
                    $control['copy'] = null;
                }else{
                    $result = $db->resultToArray($result);
                    $control['copy'] = $result;
                }

                return $control;
            }
        }

        /**
         * Modificar los datos de control del expediente
         * 
         * @param int $data Datos del control
         * @return bool
         */
        public function updateControl($data){
            $db = new DbHandler;

            $data['expedient'] = cleanStr($data['expedient']);
            
            $db->query("DELETE FROM Services_Control_Emails
                        WHERE expedient = " . $data['expedient'] . "");

            if($data['send'] != null){
                foreach($data['send'] as $email){
                    $db->query("INSERT INTO Services_Control_Emails(expedient, email)
                                VALUES (" . $data['expedient'] . ", $email)");
                }
            }

            //Eliminamos los datos de las asistencias del expediente
            $db->query("DELETE FROM Assistants_Control
                                WHERE expedient = " . $data['expedient'] . "");
            //Añadimos las nuevas asistencias
            if($data['assistance'] != null && count($data['assistance']) > 0){
                foreach($data['assistance'] as $assistance){
                    $db->query("INSERT INTO Assistants_Control(expedient, assistant)
                                VALUES (" . $data['expedient'] . ", $assistance)");
                }
            }

            //Eliminamos los datos de las copia de los correos del expediente
            $db->query("DELETE FROM Assistants_Emails_Control 
                        WHERE expedient = " . $data['expedient'] . "");
            //Añadimos los nuevos correos
            if($data['mailTo'] != '' && $data['mailTo'] != null){
                $db->query("INSERT INTO Assistants_Emails_Control(expedient, emails)
                            VALUES (" . $data['expedient'] . ", '" . $data['mailTo'] . "')");
            }

            return $db->query(" UPDATE  Services_Control
                                SET     notes = '" . $data['notes'] . "'
                                WHERE   service = " . $data['expedient']);
        }

        /**
         * Modifica el estado del envío del email en el control del expediente
         * 
         * @param int $data ID del expediente
         * @return bool
         */
        public function updateControlSent($data){
            $db = new DbHandler;

            $data['expedient'] = cleanStr($data['expedient']);

            return $db->query(" UPDATE  Services_Control
                                SET     sent = 1
                                WHERE   service = " . $data['expedient']);
        }

        /* **************** Expedientes - Documentación **************** */
        public function createDocs($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $db->query(" INSERT INTO Expedients_Documents (expedient, user, type, date, name, file) VALUES
                            (" . $data . ", null, 1, null, 'Acta de incineración', 'actaIncineracion'),
                            (" . $data . ", null, 2, null, 'Autorización para cremación', 'autoCremacion'), 
                            (" . $data . ", null, 3, null, 'Autorización publicar esquela', 'autoPubliEsquela'), 
                            (" . $data . ", null, 5, null, 'Acta licencia juzgado de guardia', 'actaJuzgado'), 
                            (" . $data . ", null, 6, null, 'Actividades preparación', 'actaPreparacion'), 
                            (" . $data . ", null, 8, null, 'Carta de flores', 'cartaFlores'), 
                            (" . $data . ", null, 9, null, 'Carta de flores registro', 'cartaFloresRegistro'), 
                            (" . $data . ", null, 10, null, 'Cerrado por defunción', 'cerradoDefuncion'), 
                            (" . $data . ", null, 11, null, 'Conservación embalsamiento', 'conservEmbalsamiento'), 
                            (" . $data . ", null, 12, null, 'Conservación temporal', 'conservTemporal'), 
                            (" . $data . ", null, 13, null, 'Contrato servicios compañías', 'contratoServiciosCompania'), 
                            (" . $data . ", null, 14, null, 'Contrato servicios particulares', 'contratoServiciosFuner'), 
                            (" . $data . ", null, 15, null, 'Cuestionario de satisfacción particulares', 'cuestionarioSatisfaccion'), 
                            (" . $data . ", null, 16, null, 'Datos de la iglesia', 'datosIglesia'), 
                            (" . $data . ", null, 17, null, 'Esquela', 'esquela'), 
                            (" . $data . ", null, 18, null, 'Esquela prensa', 'esquelaPrensa'), 
                            (" . $data . ", null, 19, null, 'Exhumación judicial', 'exhumacionJudicial'), 
                            (" . $data . ", null, 20, null, 'Informe situación nicho judicial', 'situacionNichoJudicial'), 
                            (" . $data . ", null, 21, null, 'Justificante de asistencia al sepelio', 'justificanteSepelio'), 
                            (" . $data . ", null, 22, null, 'Lápida provisional', 'lapidaProvisional'), 
                            (" . $data . ", null, 23, null, 'Libro de visitas', 'libroVisitas'), 
                            (" . $data . ", null, 24, null, 'No se recibe duelo', 'noDuelo'), 
                            (" . $data . ", null, 25, null, 'Pésames web', 'pesameWeb'),
                            (" . $data . ", null, 26, null, 'Pedidos de compra', 'pedidosCompra'),
                            (" . $data . ", null, 27, null, 'Precintado de féretro', 'precintadoFeretro'), 
                            (" . $data . ", null, 28, null, 'Recibis', 'recibis'), 
                            (" . $data . ", null, 29, null, 'Recibis iglesia', 'recibisIglesia'), 
                            (" . $data . ", null, 30, null, 'Recordatorio', 'recordatorio'), 
                            (" . $data . ", null, 31, null, 'Recordatorio sobre', 'recordatorioSobre'), 
                            (" . $data . ", null, 32, null, 'Recordatorio sobre cruz', 'recordatorioSobreCruz'),
                            (" . $data . ", null, 33, null, 'Resumen', 'resumenServicio'),
                            (" . $data . ", null, 34, null, 'Autorización del titular a depositar cenizas', 'depositarCenizas'), 
                            (" . $data . ", null, 35, null, 'Autorización del titular a retirar cenizas', 'retirarCenizas'), 
                            (" . $data . ", null, 36, null, 'Sanidad traslado de cenizas y cadáveres', 'trasladoCenizasCadaver'), 
                            (" . $data . ", null, 37, null, 'Solicitud literales', 'solicitudLiterales'), 
                            (" . $data . ", null, 38, null, 'Solicitud necropsia', 'solicitudNecropsia'), 
                            (" . $data . ", null, 39, null, 'Tarjetón agradecimiento', 'tarjetonAgradecimiento'), 
                            (" . $data . ", null, 40, null, 'Tarjetas', 'tarjetas'), 
                            (" . $data . ", null, 41, null, 'Traslado de cadáveres hospitales', 'trasladoHospital'),
                            (" . $data . ", null, 44, null, 'Autorización para la prestación de servicio funerario (Infortunio)', 'prestacionServicio'),
                            (" . $data . ", null, 46, null, 'Recibo y conforme póliza Ocaso', 'reciboOcaso'),
                            (" . $data . ", null, 47, null, 'Autorización prestación de servicio y LOPD', 'autoPrestacionServicio'),
                            (" . $data . ", null, 48, null, 'Hoja de datos del servicio', 'hojaDatosServicio'),
                            (" . $data . ", null, 49, null, 'Formulario de solicitud de pedido', 'formularioPedido'),
                            (" . $data . ", null, 50, null, 'Hoja de pedidos flor', 'hojaPedidos'),
                            (" . $data . ", null, 51, null, 'Autorización sepultura', 'autoSepultura'),
                            (" . $data . ", null, 52, null, 'Mandato expreso', 'mandatoExpreso'),
                            (" . $data . ", null, 53, null, 'Reconocimiento previo incineración', 'reconocPrevioIncineracion'),
                            (" . $data . ", null, 54, null, 'Solicitud de modificación en los elementos del servicio funerario contratado', 'modificacionServicioFunerario'),
                            (" . $data . ", null, 55, null, 'Modelo hoja de datos', 'modeloHojaDeDatos'),
                            (" . $data . ", null, 56, null, 'Extracción de dispositivos acta', 'actaExtraccionDispositivos'),
                            (" . $data . ", null, 57, null, 'Recibís - La FE Seguros', 'recibisCampaneroLaFE'),
                            (" . $data . ", null, 63, null, 'Recepción de cadáveres procedentes de otras funerarias', 'recepcionCadaveresOtrasFunerarias'),
                            (" . $data . ", null, 65, null, 'Conservación autorización familiar', 'conservacionAutorizacionFamiliar'),
                            (" . $data . ", null, 66, null, 'Parte de defunción', 'parteDefuncion')");

            // Documentos específicos por compañía
            // Último ID = 66;
            $documentCustom = [];
            switch($_SESSION['company']){
                case '10':
                    $documentCustom[0] = "58, null, 'Autorización para cremación - Tanatorio M. Sánchez', 'autoCremacionTanatorioMSanchez'";
                break;
                case '11':
                    // $documentCustom[0] = "59, null, 'Instancia San José', 'instanciaSanJose'";
                    // $documentCustom[1] = "60, null, 'Instancia S. Eulalia', 'instanciaSEulalia'";
                    // $documentCustom[2] = "61, null, 'Instancia Ayto. Sant Joan de Libritja', 'instanciaAytoSJoanLibritja'";
                    $documentCustom[0] = "62, null, 'Model 017 instancia inhumación (Ayuntamiento de Ibiza)', 'instanciaInhumacionIbiza'";
                break;
                case '13':
                    $documentCustom[0] = "64, null, 'Hoja cementerio - Ciudad Real', 'hojaCementerioCiudadReal'";
                break;
                default:
                    $documentCustom = [];
                break;
            }
     
            if(count($documentCustom) > 0 ){
                foreach($documentCustom as $doc){
                    $db->query(" INSERT INTO Expedients_Documents (expedient, user, type, date, name, file) VALUES (" . $data . ", null, $doc)");
                }
            }

            return true;
        }

        public function setServiceValue($data){
            $db = new DbHandler;

            $data['service'] = cleanStr($data['service']);
            $data['model'] = cleanStr($data['model']);
            $data['action'] = cleanStr($data['action']);

            return $db->query(" UPDATE  Services_Auto
                                SET     value = 1
                                WHERE   service = " . $data['service'] . " AND
                                        model = " . $data['model'] . " AND
                                        action = " . $data['action'] . "");
        }

        /**
         * Obtiene los correos para enviar al servicio
         * 
         * @param array $data IDs de los correos
         * @return array
         */
        public function getEmailsControl($data){
            $db = new DbHandler;

            $emails = array();

            foreach($data as $elem){
                $elem = cleanStr($elem);
                $result = $db->query("  SELECT  e.email
                                        FROM    Emails e
                                        WHERE   ID = $elem");

                $email = $db->resultToArray($result)[0]['email'];

                array_push($emails, $email);
            }

            return $emails;
        }

        /**
         * Obtiene todas las cremaciones de hoy
         * 
         * @return array
         */
        public function getTodayCremations(){
            $db = new DbHandler;

            $currentDate = date("Y-m-d");

            $result = $db->query("  SELECT      e.number, e.deceasedName, e.deceasedSurname, e.crematoriumIntroduction, e.crematoriumWaitOnRoom, e.crematoriumVaseBio,
                                                e.crematoriumPacemaker, e.ecologicCoffin, e.crematoriumArriveTime,
                                                e.familyContactName, e.familyContactSurname, e.familyContactMobilePhone, e.crematoriumArriveTime,
                                                e.authDate, e.authTime, e.authPlace,
                                                ev.start,
                                                f.name AS funeralHome,
                                                e.crematorium as crematoriumID, cr.name AS crematoriumName
                                    FROM        (Expedients e, Expedients_Services es, Events ev)
                                    LEFT JOIN   FuneralHomes f ON f.funeralHomeID = es.funeralHomeService
                                    LEFT JOIN   Crematoriums cr  ON e.crematorium = cr.crematoriumID
                                    WHERE       es.expedient = e.expedientID AND
                                                e.crematoriumEvent = ev.ID AND 
                                                ev.start LIKE '%$currentDate%' AND
                                                e.leavingDate IS NULL AND
                                                ev.status = 7");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }

        /**
         * Obtiene todas las cremaciones de mañana
         * 
         * @return array
         */
        public function getTomorrowCremations(){
            $db = new DbHandler;

            $currentDate = date("Y-m-d", time() + 60 * 60 * 24);

            $result = $db->query("  SELECT      e.number, e.deceasedName, e.deceasedSurname, e.crematoriumIntroduction, e.crematoriumWaitOnRoom, e.crematoriumVaseBio,
                                                e.crematoriumPacemaker, e.ecologicCoffin, e.crematoriumArriveTime,
                                                e.familyContactName, e.familyContactSurname, e.familyContactMobilePhone, e.crematoriumArriveTime,
                                                e.authDate, e.authTime, e.authPlace,
                                                ev.start,
                                                f.name AS funeralHome,
                                                e.crematorium as crematoriumID, cr.name AS crematoriumName
                                    FROM        (Expedients e, Expedients_Services es, Events ev)
                                    LEFT JOIN   FuneralHomes f ON f.funeralHomeID = es.funeralHomeService
                                    LEFT JOIN   Crematoriums cr  ON e.crematorium = cr.crematoriumID
                                    WHERE       es.expedient = e.expedientID AND
                                                e.crematoriumEvent = ev.ID AND 
                                                ev.start LIKE '%$currentDate%' AND
                                                e.leavingDate IS NULL AND
                                                ev.status = 7");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }

        /**
         * Obtiene las tareas pendientes de un servicio
         * 
         * @param array $data ID del expediente
         * @return array
         */
        public function getTasksByExpedient($data){
            $db = new DbHandler;

            $data = cleanStr($data);
            
            $maxNumHiring = $this->getActiveHiring($data);

            $sections = array();

            $service = $db->query(" SELECT      es.revReqCheck, es.control, es.priestTimeCheck, es.gravediggersNotApply, es.gravediggersCheck, es.gravediggersCheckPrinted,
                                                es.gravediggersCheckSigned, es.carriersTimeCheck, es.choir, es.notifiedChoir, es.bellringer, es.notifiedBellringer,
                                                ch.name as choirName, ch.homePhone as choirPhone1, ch.mobilePhone as choirPhone2, ch.otherPhone as choirPhone3,
                                                be.name as bellringerName, be.parish as bellringerParish, be.mobilePhone as bellringerPhones, es.priestTime, 
                                                es.carriersTime, e.deceasedName, e.deceasedSurname, e.deceasedGender, es.vivoSent,
                                                e.funeralDateNew, e.funeralTimeNew, es.priestInspected, es.priestPayed,
                                                e.entryDate,
                                                m.vivo_recuerdo_client, m.vivo_recuerdo_key
                                    FROM        (Expedients_Services es, Expedients e)
                                    LEFT JOIN   Choirs ch ON es.choir = ch.choirID
                                    LEFT JOIN   BellRingers be ON es.bellringer = be.ID
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    WHERE       e.type != 2 AND
                                                es.expedient = $data AND
                                                es.expedient = e.expedientID ");

            $service = $db->resultToArray($service)[0];

            if(
                $service['vivo_recuerdo_client'] == null ||
                $service['vivo_recuerdo_client'] == '' ||
                $service['vivo_recuerdo_key'] == null ||
                $service['vivo_recuerdo_key'] == ''
            ){
                $service['vivoSent'] = '1';
            }
            
            // Detalles del servicio
            $details = array();
            array_push($details, $service['revReqCheck']);
            array_push($details, $service['control']);
            array_push($details, $service['deceasedName']);
            array_push($details, $service['deceasedSurname']);
            array_push($details, $service['deceasedGender']);

            $sections['details'] = $details;

            // Curas
            $priests = array();

            $result = $db->query("  SELECT  sp.ID,
                                            p.name, p.surname, p.parish, p.homePhone, p.mobilePhone, p.otherPhone
                                    FROM    Services_Priests sp, Priests p
                                    WHERE   sp.priest = p.priestID AND
                                            sp.service = $data AND
                                            sp.notified = 0");

            $result = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
           
            $result2 = $db->query(" SELECT	p.name
                                    FROM	Expedients_Hirings eh, Products p
                                    WHERE   eh.product = p.productID AND
                                            eh.check = 1 AND
                                            eh.expedient = $data AND
                                            p.serviceBelow = 2 AND 
                                            eh.num_hiring = $maxNumHiring
            ");

            $priestSection = mysqli_num_rows($result2) > 0 ? true : false; 
            if($priestSection){
                array_push($priests, $service['priestTimeCheck']);            
                array_push($priests, $result);
                array_push($priests, $service['priestTime']);
                array_push($priests, array());
                if($service['funeralDateNew'] != null && $service['funeralTimeNew'] != null){
                    if($service['priestInspected'] == '0'){
                        $priests[3]['priestInspected'] = $service['priestInspected'];
                    }
                    if($service['priestPayed'] == '0'){
                        $priests[3]['priestPayed'] = $service['priestPayed'];
                    }
                }
            }

            $sections['priests'] = $priests;

            // Coros
            $choirs = array();

            $result2 = $db->query(" SELECT	p.name
                                    FROM	Expedients_Hirings eh, Products p
                                    WHERE   eh.product = p.productID AND
                                            eh.check = 1 AND
                                            eh.expedient = $data AND
                                            p.serviceBelow = 3 AND
                                            eh.num_hiring = $maxNumHiring
            ");

            $choirSection = mysqli_num_rows($result2) > 0 ? true : false; 
            if($choirSection){
                $result = $db->query("  SELECT  sc.ID, c.name, c.homePhone, c.mobilePhone, c.otherPhone
                                        FROM    Services_Choirs sc, Choirs c
                                        WHERE   sc.choir = c.choirID AND
                                                sc.service = $data AND
                                                sc.notified = 0");
    
                $choirs = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
            }

            $sections['choirs'] = $choirs;

            // Campaneros
            $bellringers = array();

            $result2 = $db->query(" SELECT	p.name
                                    FROM	Expedients_Hirings eh, Products p
                                    WHERE   eh.product = p.productID AND
                                            eh.check = 1 AND
                                            eh.expedient = $data AND
                                            p.serviceBelow = 4 AND
                                            eh.num_hiring = $maxNumHiring
            ");

            $bellringersSection = mysqli_num_rows($result2) > 0 ? true : false; 
            if($bellringersSection){
                $result = $db->query("  SELECT  sb.ID, b.name, b.surname, b.parish, b.mobilePhone
                                        FROM    Services_Bellringers sb, BellRingers b
                                        WHERE   sb.bellringer = b.ID AND
                                                sb.service = $data AND
                                                sb.notified = 0");
    
                $bellringers = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
            }

            $sections['bellringers'] = $bellringers;

            // Enterradores
            $gravediggers = array();

            $result = $db->query("      SELECT  sg.ID, g.name, g.surname, g.homePhone, g.mobilePhone, g.otherPhone
                                        FROM    Services_Gravediggers sg, Gravediggers g
                                        WHERE   sg.gravedigger = g.gravediggerID AND
                                                sg.service = $data AND
                                                sg.notified = 0");

            $result = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;

            $result2 = $db->query(" SELECT	p.name
                                    FROM	Expedients_Hirings eh, Products p
                                    WHERE   eh.product = p.productID AND
                                            eh.check = 1 AND
                                            eh.expedient = $data AND
                                            p.serviceBelow = 1 AND
                                            eh.num_hiring = $maxNumHiring
            ");

            $gravediggersSection = mysqli_num_rows($result2) > 0 ? true : false;
            if($gravediggersSection){
                array_push($gravediggers, $service['gravediggersCheck']);
            }else{
                array_push($gravediggers, 1);
            }

            if($service['gravediggersNotApply'] == 0 || $service['gravediggersNotApply'] == '0'){
                if($gravediggersSection){
                    array_push($gravediggers, $service['gravediggersCheckPrinted'], $service['gravediggersCheckSigned']);
                }else{
                    array_push($gravediggers, 1, 1);
                }
            }else{
                array_push($gravediggers, 1, 1);
            }

            if($gravediggersSection){
                array_push($gravediggers, $result);
            }else{
                array_push($gravediggers, []);
            }
            $sections['gravediggers'] = $gravediggers;

            // Otros
            if(strtotime($service['entryDate']) >= 1716328800){
                $result = $db->query("  SELECT      sa.action, sa.value, 
                                                    a.type, a.label, 
                                                    pm.productModelID, pm.name,
                                                    p.name as productName, s.name as supplierName, s.phones as supplierPhones, eh.ID as hiringID
                                        FROM        Services_Auto sa, Actions a, Products_Models pm, Products p, Expedients_Hirings eh, Suppliers s
                                        WHERE       sa.service = $data AND 
                                                    sa.status = 1 AND 
                                                    sa.value = '0' AND 
                                                    sa.action = a.ID AND 
                                                    a.type = 'checkbox' AND 
                                                    sa.model = pm.productModelID AND
                                                    pm.product = p.productID AND
                                                    a.label != 'No aplica' AND
                                                    a.label != 'No finalizar' AND
                                                    eh.expedient = sa.service AND
                                                    eh.check = 1 AND
                                                    p.productID = eh.product AND
                                                    eh.model = pm.productModelID AND
                                                    eh.supplier = s.supplierID AND
                                                    p.checkCService = 1 AND
                                                    sa.hiring = eh.ID AND
                                                    eh.num_hiring = $maxNumHiring
                                        ORDER BY    pm.productModelID, eh.ID");
            }else{
                $result = $db->query("  SELECT      sa.action, sa.value, 
                                                    a.type, a.label, 
                                                    pm.productModelID, pm.name,
                                                    p.name as productName, s.name as supplierName, s.phones as supplierPhones, eh.ID as hiringID
                                        FROM        Services_Auto sa, Actions a, Products_Models pm, Products p, Expedients_Hirings eh, Suppliers s
                                        WHERE       sa.service = $data AND 
                                                    sa.status = 1 AND 
                                                    sa.value = '0' AND 
                                                    sa.action = a.ID AND 
                                                    a.type = 'checkbox' AND 
                                                    sa.model = pm.productModelID AND
                                                    pm.product = p.productID AND
                                                    a.label != 'No aplica' AND
                                                    a.label != 'No finalizar' AND
                                                    eh.expedient = sa.service AND
                                                    eh.check = 1 AND
                                                    p.productID = eh.product AND
                                                    eh.model = pm.productModelID AND
                                                    eh.supplier = s.supplierID AND
                                                    p.checkCService = 1 AND
                                                    eh.num_hiring = $maxNumHiring
                                        ORDER BY    pm.productModelID");
            }

            $result = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;

            $sections['others'] = $result;

            $result = $db->query("  SELECT      es.policeNotified, es.policeLocation, es.webConfirm, es.webLink, es.doctorDone,
                                                es.doctorDeliver, es.doctorInProgress, es.tribunalDeliver, es.tribunalInProgress,
                                                es.tribunalLocation, es.tribunalUser, es.literalReceived, es.literalRequest, es.literalVolumePage, es.literalWhoTakes,
                                                es.literalCivilRegister, es.literalDateExit, es.literalTimeExit, es.tombstone, es.preparationConfirm, es.tombstonePrint, es.surveySend,
                                                es.vivoSent, es.crematoriumProgramOven, es.crematoriumControlDeliversAshes,
                                                e.status, e.cremation,
                                                m.vivo_recuerdo_client, m.vivo_recuerdo_key
                                    FROM        (Expedients_Services es, Expedients e)
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    WHERE       es.expedient = $data AND
                                                es.expedient = e.expedientID");

            $result = mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;

            if(
                $result['vivo_recuerdo_client'] == null ||
                $result['vivo_recuerdo_client'] == '' ||
                $result['vivo_recuerdo_key'] == null ||
                $result['vivo_recuerdo_key'] == ''
            ){
                $result['vivoSent'] = '1';
            }

            if(intval($result['status']) == 3 || intval($result['status']) == 4){
                $result['literalRequest'] = 1;
                $result['literalReceived'] = 1;
            }
            if($_SESSION['company'] != '1' && $_SESSION['company'] != '2' && $_SESSION['company'] != '3' && $_SESSION['company'] != '6'){
                $result['webConfirm'] = 1;
            }

            $sections['others2'] = $result;

            // Porteadores
            $carriers = array();

            $result = $db->query("  SELECT  sc.ID,
                                            c.name, c.surname, c.phones
                                    FROM    Services_Carriers sc, Carriers c
                                    WHERE   sc.carrier = c.carrierID AND
                                            sc.service = $data AND
                                            sc.confirmed = 0");

            $result = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;

            array_push($carriers, $service['carriersTimeCheck']);
            array_push($carriers, $result);
            array_push($carriers, $service['carriersTime']);

            $sections['carriers'] = $carriers;

            return $sections;
        }

        /**
         * Obtiene las tareas pendientes de un servicio
         * 
         * @param array $data ID del expediente
         * @return array
         */
        public function getLiteralsByExpedient($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $sections = array();

            $service = $db->query(" SELECT  e.deceasedName, e.deceasedSurname, e.deceasedGender
                                    FROM    Expedients e
                                    WHERE   e.type != 2 AND e.expedientID = $data");

            $service = $db->resultToArray($service)[0];
            $sections['details'] = $service;
            
            $result = $db->query("  SELECT  es.literalReceived, es.literalRequest
                                    FROM    Expedients_Services es, Expedients e
                                    WHERE   es.expedient = $data AND
                                            es.expedient = e.expedientID");

            $result = mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
            $sections['others2'] = $result;

            return $sections;
        }
        
        /**
         * Obtiene las tareas pendientes de un servicio
         * 
         * @param array $data
         * 
         * @return array
         */
        public function updateTasksByExpedient($data){
            require_once($_SESSION['basePath'] . "model/logs.php");
            $logs = new Logs;
        
            $db = new DbHandler;

            $expedient = cleanStr($data['expedient']);

            // DETALLES
            if(isset($data['details'])){
                if(isset($data['details']['control']) && $data['details']['control']!= ''){
                    $detailsControl = $data['details']['control'];
                    $detailsControl = cleanStr($detailsControl);
                    
                    $db->query("UPDATE  Expedients_Services
                                SET     control = $detailsControl
                                WHERE   expedient = $expedient");

                    $logs->createExpedient("Tareas pendientes", $expedient, "Control - Control realizado", "'Ha confirmado el control realizado'");
                }
            }

            // CURAS
            if(isset($data['priests'])){
                if(isset($data['priests']['priestCheck']) && $data['priests']['priestCheck'] != ''){
                    $priestTimeCheck = $data['priests']['priestCheck']['priestTime'];
                    $priestTimeCheck = cleanStr($priestTimeCheck);
                   
                    $db->query("UPDATE  Expedients_Services
                                SET     priestTimeCheck = $priestTimeCheck
                                WHERE   expedient = $expedient");

                    if($priestTimeCheck != 'false'){
                        $logs->createExpedient("Tareas pendientes", $expedient, "Curas - Hora curas", "'Ha confirmado la hora de los curas'");
                    }
                }

                if(isset($data['priests']['priestTable']) && $data['priests']['priestTable'] != ''){
                    foreach($data['priests']['priestTable'] as $priest){
                        $id = $priest[0];
                        $notified = $priest[1];

                        $id = cleanStr($id);
                        $notified = cleanStr($notified);

                        $db->query("UPDATE  Services_Priests
                                    SET     notified = $notified
                                    WHERE   ID = $id");

                        if($notified == 'true'){
                            $result = $db->query("  SELECT  CONCAT(p.name, ' ', p.surname) as name
                                                    FROM    Services_Priests sp, Priests p
                                                    WHERE   sp.priest = p.priestID AND
                                                            sp.ID = $id");

                            $name = mysqli_num_rows($result) == 0 ? '' : $db->resultToArray($result)[0]['name'];
                            $logs->createExpedient("Tareas pendientes", $expedient, "Curas - Avisar cura", "'Ha confirmado el aviso al cura $name'");
                        }
                    }
                }

                if(isset($data['priests']['priestTimePendTask']) && $data['priests']['priestTimePendTask'] != ''){
                    $priesTimePendingTask = $data['priests']['priestTimePendTask'];
                    $priesTimePendingTask = cleanStr($priesTimePendingTask);
                    $db->query("UPDATE  Expedients_Services
                                SET     priestTime = '" .$priesTimePendingTask."'
                                WHERE   expedient = $expedient");

                    $logs->createExpedient("Tareas pendientes", $expedient, "Curas - Revisar curas", "'Ha confirmado la revisión de los curas'");
                }

                if(isset($data['priests']['priestInspected']) && $data['priests']['priestInspected'] != ''){
                    $priestInspected = $data['priests']['priestInspected'];
                    $priestInspected = cleanStr($priestInspected);
                    $db->query("UPDATE  Expedients_Services
                                SET     priestInspected = " .$priestInspected."
                                WHERE   expedient = $expedient");

                    $logs->createExpedient("Tareas pendientes", $expedient, "Curas - Revisar curas", "'Ha confirmado la revisión de los curas cuando hay fecha y hora de funeral'");
                }

                if(isset($data['priests']['priestPayed']) && $data['priests']['priestPayed'] != ''){
                    $priestPayed = $data['priests']['priestPayed'];
                    $priestPayed = cleanStr($priestPayed);
                    $db->query("UPDATE  Expedients_Services
                                SET     priestPayed = " .$priestPayed."
                                WHERE   expedient = $expedient");

                    $logs->createExpedient("Tareas pendientes", $expedient, "Curas - Revisar curas", "'Ha confirmado la revisión de los curas cuando hay fecha y hora de funeral'");
                }
            }

            // COROS
            if(isset($data['choirs'])){
                foreach($data['choirs'] as $choir){
                    $ID = $choir[0];
                    $choirNotified = $choir[1];
    
                    $ID = cleanStr($ID);
                    $choirNotified = cleanStr($choirNotified);
    
                    $db->query("UPDATE  Services_Choirs
                                SET     notified = $choirNotified
                                WHERE   ID = $ID");
    
                    if($choirNotified == 'true'){
                        $result = $db->query("  SELECT  c.name
                                                FROM    Services_Choirs sc, Choirs c
                                                WHERE   sc.choir = c.choirID AND
                                                        sc.ID = $ID");

                        $name = mysqli_num_rows($result) == 0 ? '' : $db->resultToArray($result)[0]['name'];
                        $logs->createExpedient("Tareas pendientes", $expedient, "Coros - Avisar coro", "'Ha confirmado el aviso al coro $name'");
                    }
                }
            }

            // CAMPANEROS
            if(isset($data['bellringers'])){
                foreach($data['bellringers'] as $bellringer){
                    $ID = $bellringer[0];
                    $notifiedBellringer = $bellringer[1];

                    $ID = cleanStr($ID);
                    $notifiedBellringer = cleanStr($notifiedBellringer);

                    $db->query("UPDATE  Services_Bellringers
                                SET     notified = $notifiedBellringer
                                WHERE   ID = $ID");

                    if($notifiedBellringer == 'true'){
                        $result = $db->query("  SELECT  CONCAT(b.name, ' ', b.surname) as name
                                                FROM    Services_Bellringers sb, BellRingers b
                                                WHERE   sb.bellringer = b.ID AND
                                                        sb.ID = $ID");

                        $name = mysqli_num_rows($result) == 0 ? '' : $db->resultToArray($result)[0]['name'];
                        $logs->createExpedient("Tareas pendientes", $expedient, "Campaneros - Avisar campanero", "'Ha confirmado el aviso al campanero $name'");
                    }
                }
            }

            // ENTERRADORES
            if(isset($data['gravediggers'])){
                if(isset($data['gravediggers']['gravediggerChecks'])){
                    if(isset($data['gravediggers']['gravediggerChecks']['gravediggersCheck'])){
                        $gravediggersCheck = $data['gravediggers']['gravediggerChecks']['gravediggersCheck'];
                        $gravediggersCheck = cleanStr($gravediggersCheck);

                        $db->query("UPDATE  Expedients_Services
                                    SET     gravediggersCheck = $gravediggersCheck
                                    WHERE   expedient = $expedient");

                        if($gravediggersCheck != 'false'){
                            $logs->createExpedient("Tareas pendientes", $expedient, "Enterradores - Confirmar", "'Ha revisado los enterradores'");
                        }
                    }

                    if(isset($data['gravediggers']['gravediggerChecks']['gravediggersCheckPrinted'])){
                        $gravediggersCheckPrinted = $data['gravediggers']['gravediggerChecks']['gravediggersCheckPrinted'];
                        $gravediggersCheckPrinted = cleanStr($gravediggersCheckPrinted);

                        $db->query("UPDATE  Expedients_Services
                                    SET     gravediggersCheckPrinted = $gravediggersCheckPrinted
                                    WHERE   expedient = $expedient");

                        if($gravediggersCheckPrinted != 'false'){
                            $logs->createExpedient("Tareas pendientes", $expedient, "Enterradores - Documento impreso", "'Ha impreso el documento'");
                        }
                    }

                    if(isset($data['gravediggers']['gravediggerChecks']['gravediggersCheckSigned'])){
                        $gravediggersCheckSigned = $data['gravediggers']['gravediggerChecks']['gravediggersCheckSigned'];
                        $gravediggersCheckSigned = cleanStr($gravediggersCheckSigned);

                        $db->query("UPDATE  Expedients_Services
                                    SET     gravediggersCheckSigned = $gravediggersCheckSigned
                                    WHERE   expedient = $expedient");

                        if($gravediggersCheckSigned != 'false'){
                            $logs->createExpedient("Tareas pendientes", $expedient, "Enterradores - DOcumento firmado", "'Ha firmado el documento'");
                        }
                    }
                }

                if(isset($data['gravediggers']['gravediggerTable'])){
                    foreach($data['gravediggers']['gravediggerTable'] as $gravedigger){
                        $id = $gravedigger[0];
                        $notified = $gravedigger[1];

                        $id = cleanStr($id);
                        $notified = cleanStr($notified);

                        $db->query("UPDATE  Services_Gravediggers
                                    SET     notified = $notified
                                    WHERE   ID = $id");

                        if($notified == 'true'){
                            $result = $db->query("  SELECT  CONCAT(g.name, ' ', g.surname) as name
                                                    FROM    Services_Gravediggers sg, Gravediggers g
                                                    WHERE   sg.gravedigger = g.gravediggerID AND
                                                            sg.ID = $id");

                            $name = mysqli_num_rows($result) == 0 ? '' : $db->resultToArray($result)[0]['name'];
                            $logs->createExpedient("Tareas pendientes", $expedient, "Enterradores - Avisar enterrador", "'Ha confirmado el aviso al enterrador $name'");
                        }
                    }
                }
            }

            // OTROS
            if(isset($data['others'])){
                foreach($data['others'] as $others){
                    $others[0] = cleanStr($others[0]);
                    $others[1] = cleanStr($others[1]);
                    $others[2] = cleanStr($others[2]);
                    $others[3] = cleanStr($others[3]);

                    if($others[2] == '1' || $others[2] == 1){
                        // Fix for next after this update
                        // Find with "hiring". If it is found, filter with hiring. If not, without hiring
                        $result = $db->query("  SELECT  sa.ID
                                                FROM    Services_Auto sa
                                                WHERE   sa.service = $expedient AND 
                                                        sa.model = " . $others[0] . " AND 
                                                        sa.action = " . $others[1] . " AND
                                                        sa.hiring = " . $others[3]);

                        $found = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['ID'];
                        if($found == null){
                            $result = $db->query("  UPDATE  Services_Auto 
                                                    SET     value = '" . $others[2] . "'
                                                    WHERE   service = $expedient AND 
                                                            model = " . $others[0] . " AND 
                                                            action = " . $others[1] . " AND
                                                            hiring IS NULL");
    
                            $result = $db->query("  SELECT  a.label, pm.name as model, p.name as product
                                                    FROM    Services_Auto sa, Actions a, Products_Models pm, Products p
                                                    WHERE   sa.service = $expedient AND 
                                                            sa.model = " . $others[0] . " AND 
                                                            sa.action = " . $others[1] . " AND
                                                            sa.action = a.ID AND
                                                            sa.model = pm.productModelID AND
                                                            pm.product = p.productID AND
                                                            sa.hiring IS NULL");
    
                            $result = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0];
                            if($result != null){
                                $logs->createExpedient("Tareas pendientes", $expedient, "{$result['product']} - {$result['model']} - {$result['label']}", "'Ha marcado {$result['label']} para {$result['product']} - {$result['model']}'");
                            }
                        }else{
                            $result = $db->query("  UPDATE  Services_Auto 
                                                    SET     value = '" . $others[2] . "'
                                                    WHERE   ID = $found");

                            $result = $db->query("  SELECT  a.label, pm.name as model, p.name as product
                                                    FROM    Services_Auto sa, Actions a, Products_Models pm, Products p
                                                    WHERE   sa.action = a.ID AND
                                                            sa.model = pm.productModelID AND
                                                            pm.product = p.productID AND
                                                            sa.ID = $found");
    
                            $result = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0];
                            if($result != null){
                                $logs->createExpedient("Tareas pendientes", $expedient, "{$result['product']} - {$result['model']} - {$result['label']}", "'Ha marcado {$result['label']} para {$result['product']} - {$result['model']}'");
                            }
                        }
                    }
                }
            }

            if(isset($data['others2'])){
                foreach($data['others2'] as $key => $value){
                    $key = cleanStr($key);
                    $value = cleanStr($value);

                if($value == 1 || $value == '1'){
                        $db->query("UPDATE  Expedients_Services es
                                    SET     es.$key = $value
                                    WHERE   es.expedient = $expedient");
                    
                        if($key == "policeNotified"){
                            $logs->createExpedient("Tareas pendientes", $expedient, "Policía - Avisar policía", "'Ha confirmado el aviso a la policía'");
                        }else if($key == "webConfirm"){
                            $logs->createExpedient("Tareas pendientes", $expedient, "Página web - Confirmar", "'Ha confirmado la página web'");
                        }else if($key == "doctorDone"){
                            $logs->createExpedient("Tareas pendientes", $expedient, "Certificado médico - Entregado", "'Ha establecido que el certificado médico ha sido entregado'");
                        }else if($key == "doctorInProgress"){
                            $logs->createExpedient("Tareas pendientes", $expedient, "Certificado médico - En proceso", "'Ha establecido que el certificado médico está en proceso'");
                        }else if($key == "tribunalDeliver"){
                            $logs->createExpedient("Tareas pendientes", $expedient, "Juzgado - Entregado", "'Ha establecido que la documentación del juzgado ha sido entregada'");
                        }else if($key == "tribunalInProgress"){
                            $logs->createExpedient("Tareas pendientes", $expedient, "Juzgado - En proceso", "'Ha establecido que la documentación del juzgado está en proceso'");
                        }else if($key == "literalReceived"){
                            $logs->createExpedient("Tareas pendientes", $expedient, "Literales - Recibido", "'Ha establecido que los literales han sido recibidos'");
                        }else if($key == "literalRequest"){
                            $logs->createExpedient("Tareas pendientes", $expedient, "Literales - Solicitado", "'Ha establecido que los literales están en proceso'");
                        }else if($key == "tombstonePrint"){
                            $logs->createExpedient("Tareas pendientes", $expedient, "Lápida provisional - Impresa", "'Ha establecido que la lápida provisional ha sido impresa'");
                        }else if($key == "preparationConfirm"){
                            $logs->createExpedient("Tareas pendientes", $expedient, "Act. preparación - Confirmada", "'Ha establecido que las actividades de preparación han sido confirmadas'");
                        }else if($key == "surveySend"){
                            $logs->createExpedient("Tareas pendientes", $expedient, "Encuesta de satisfacción - Enviada", "'Ha establecido que la encuesta de satisfacción ha sido enviada'");
                        }
                    }
                }
            }

            // PORTEADORES
            if(isset($data['carriers'])){
                if(isset($data['carriers']['carrierTable'])){
                    foreach($data['carriers']['carrierTable'] as $carrier){
                        $id = $carrier[0];
                        $confirmed = $carrier[1];

                        $id = cleanStr($id);
                        $confirmed = cleanStr($confirmed);

                        $db->query("UPDATE  Services_Carriers
                                    SET     confirmed = $confirmed
                                    WHERE   ID = $id");

                        if($confirmed == 'true'){
                            $result = $db->query("  SELECT  CONCAT(c.name, ' ', c.surname) as name
                                                    FROM    Services_Carriers sc, Carriers c
                                                    WHERE   sc.carrier = c.carrierID AND
                                                            sc.ID = $id");

                            $name = mysqli_num_rows($result) == 0 ? '' : $db->resultToArray($result)[0]['name'];
                            $logs->createExpedient("Tareas pendientes", $expedient, "Confirmar - Avisar porteador", "'Ha confirmado el aviso al porteador $name'");
                        }
                    }
                }

                if(isset($data['carriers']['carriersTimePendTask']) && $data['carriers']['carriersTimePendTask'] != ''){
                    $carriersTimePendTask = $data['carriers']['carriersTimePendTask'];
                    $carriersTimePendTask = cleanStr($carriersTimePendTask);
                    $db->query("UPDATE  Expedients_Services
                                SET     carriersTime = '" .$carriersTimePendTask."'
                                WHERE   expedient = $expedient");

                    if($carriersTimePendTask != ''){
                        $logs->createExpedient("Tareas pendientes", $expedient, "Porteadores - Hora", "'Ha añadido la hora de los porteadores'");
                    }
                }
            }

            return true;
        }

        /**
         * Obtiene las tareas pendientes de un servicio
         * 
         * @param array $data
         * 
         * @return array
         */
        public function updateLiteralsByExpedient($data){
            require_once($_SESSION['basePath'] . "model/logs.php");
            $logs = new Logs;
        
            $db = new DbHandler;

            $expedient = cleanStr($data['expedient']);

      
            if(isset($data['others2'])){
                foreach($data['others2'] as $key => $value){
                    $key = cleanStr($key);
                    $value = cleanStr($value);

                if($value == 1 || $value == '1'){
                        $db->query("UPDATE  Expedients_Services es
                                    SET     es.$key = $value
                                    WHERE   es.expedient = $expedient");
                
                        if($key == "literalReceived"){
                            $logs->createExpedient("Tareas pendientes", $expedient, "Literales - Recibido", "'Ha establecido que los literales han sido recibidos'");
                        }else if($key == "literalRequest"){
                            $logs->createExpedient("Tareas pendientes", $expedient, "Literales - Solicitado", "'Ha establecido que los literales están en proceso'");
                        }
                    }
                }
            }
            return true;
        }

        public function getTasksByExpedientAmount($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $amount = 0;
            $printDebug = false;

            $service = $db->query(" SELECT      es.revReqCheck, es.control, es.priestTimeCheck, es.gravediggersCheck, es.gravediggersNotApply, es.gravediggersCheckPrinted,
                                                es.gravediggersCheckSigned, es.carriersTimeCheck, es.choir, es.notifiedChoir, es.bellringer, es.notifiedBellringer,
                                                ch.name as choirName, ch.homePhone as choirPhone1, ch.mobilePhone as choirPhone2, ch.otherPhone as choirPhone3,
                                                be.name as bellringerName, be.parish as bellringerParish, be.mobilePhone as bellringerPhones, es.priestTime, 
                                                es.carriersTime, e.deceasedName, e.deceasedSurname, e.deceasedGender, es.vivoSent,
                                                e.funeralDateNew, e.funeralTimeNew, es.priestInspected, es.priestPayed,
                                                e.entryDate
                                    FROM        (Expedients_Services es, Expedients e)
                                    LEFT JOIN   Choirs ch ON es.choir = ch.choirID
                                    LEFT JOIN   BellRingers be ON es.bellringer = be.ID
                                    WHERE       e.type != 2 AND es.expedient = $data AND es.expedient = e.expedientID ");

            if(mysqli_num_rows($service) == 0){
                return $amount;
            }

            $service = $db->resultToArray($service)[0];

            // Control
            if(intval($service['revReqCheck']) != 0 && intval($service['control']) == 0){
                $amount++;
            }

            $maxNumHiring = $this->getActiveHiring($data);

            // Curas
            $result2 = $db->query(" SELECT	p.name
                                    FROM	Expedients_Hirings eh, Products p
                                    WHERE   eh.product = p.productID AND
                                            eh.check = 1 AND
                                            eh.expedient = $data AND
                                            p.serviceBelow = 2 AND
                                            eh.num_hiring = $maxNumHiring
            ");

            $priestSection = mysqli_num_rows($result2) > 0 ? true : false; 
            if($priestSection){
                $result = $db->query("  SELECT  sp.ID,
                                                p.name, p.parish, p.homePhone, p.mobilePhone, p.otherPhone
                                        FROM    Services_Priests sp, Priests p
                                        WHERE   sp.priest = p.priestID AND
                                                sp.service = $data AND
                                                sp.notified = 0
                ");
    
                $amountPriest = mysqli_num_rows($result);
                $amount += $amountPriest;

                if($amountPriest > 0){
                    if($service['priestTimeCheck'] == null || intval($service['priestTimeCheck']) == 0){
                        $amount++;
                    }
                }

                if($service['funeralDateNew'] != null && $service['funeralTimeNew'] != null){
                    if($service['priestInspected'] == '0'){
                        $amount++;
                    }
                    if($service['priestPayed'] == '0'){
                        $amount++;
                    }
                }
            }

            // Coros
            $result2 = $db->query(" SELECT	p.name
                                    FROM	Expedients_Hirings eh, Products p
                                    WHERE   eh.product = p.productID AND
                                            eh.check = 1 AND
                                            eh.expedient = $data AND
                                            p.serviceBelow = 3 AND
                                            eh.num_hiring = $maxNumHiring
            ");

            $choirSection = mysqli_num_rows($result2) > 0 ? true : false; 
            if($choirSection){
                $result = $db->query("  SELECT  sc.ID,
                                                c.name, c.homePhone, c.mobilePhone, c.otherPhone
                                        FROM    Services_Choirs sc, Choirs c
                                        WHERE   sc.choir = c.choirID AND
                                                sc.service = $data AND
                                                sc.notified = 0");

                $amount += mysqli_num_rows($result);
            }

            // Campaneros
            $result2 = $db->query(" SELECT	p.name
                                    FROM	Expedients_Hirings eh, Products p
                                    WHERE   eh.product = p.productID AND
                                            eh.check = 1 AND
                                            eh.expedient = $data AND
                                            p.serviceBelow = 4 AND
                                            eh.num_hiring = $maxNumHiring
            ");

            $bellringersSection = mysqli_num_rows($result2) > 0 ? true : false; 
            if($bellringersSection){
                $result = $db->query("  SELECT  sb.ID,
                                                b.name, b.parish, b.mobilePhone
                                        FROM    Services_Bellringers sb, BellRingers b
                                        WHERE   sb.bellringer = b.ID AND
                                                sb.service = $data AND
                                                sb.notified = 0");

                $amount += mysqli_num_rows($result);
            }

            // Enterradores
            $result2 = $db->query(" SELECT	p.name
                                    FROM	Expedients_Hirings eh, Products p
                                    WHERE   eh.product = p.productID AND
                                            eh.check = 1 AND
                                            eh.expedient = $data AND
                                            p.serviceBelow = 1 AND
                                            eh.num_hiring = $maxNumHiring
            ");

            $gravediggersSection = mysqli_num_rows($result2) > 0 ? true : false; 
            if($gravediggersSection){
                $result = $db->query("  SELECT  sg.ID,
                                                g.name, g.homePhone, g.mobilePhone, g.otherPhone
                                        FROM    Services_Gravediggers sg, Gravediggers g
                                        WHERE   sg.gravedigger = g.gravediggerID AND
                                                sg.service = $data AND
                                                sg.notified = 0");

                $amount += mysqli_num_rows($result);

                if($service['gravediggersCheck'] == null || intval($service['gravediggersCheck']) == 0){
                    $amount++;
                }
                
                if(intval($service['gravediggersNotApply']) == 0){
                    if($service['gravediggersCheckPrinted'] == null || intval($service['gravediggersCheckPrinted']) == 0){
                        $amount++;
                    }
                    if($service['gravediggersCheckSigned'] == null || intval($service['gravediggersCheckSigned'] == 0)){
                        $amount++;
                    }
                }
            }

            // Otros
            if(strtotime($service['entryDate']) >= 1716328800){         
                $result = $db->query("  SELECT      sa.action, sa.value, 
                                                    a.type, a.label, 
                                                    pm.productModelID, pm.name,
                                                    p.name as productName
                                        FROM        Services_Auto sa, Actions a, Products_Models pm, Products p, Expedients_Hirings eh
                                        WHERE       sa.service = $data AND 
                                                    sa.status = 1 AND 
                                                    sa.value = '0' AND 
                                                    sa.action = a.ID AND 
                                                    a.type = 'checkbox' AND 
                                                    sa.model = pm.productModelID AND
                                                    pm.product = p.productID AND
                                                    a.label != 'No aplica' AND
                                                    a.label != 'No finalizar' AND
                                                    eh.expedient = sa.service AND
                                                    eh.check = 1 AND
                                                    p.productID = eh.product AND
                                                    eh.model = pm.productModelID AND
                                                    p.checkCService = 1 AND
                                                    sa.hiring = eh.ID AND 
                                                    eh.num_hiring = $maxNumHiring
                                        ORDER BY    pm.productModelID
                ");
            }else{
                $result = $db->query("  SELECT      sa.action, sa.value, 
                                                    a.type, a.label, 
                                                    pm.productModelID, pm.name,
                                                    p.name as productName
                                        FROM        Services_Auto sa, Actions a, Products_Models pm, Products p, Expedients_Hirings eh
                                        WHERE       sa.service = $data AND 
                                                    sa.status = 1 AND 
                                                    sa.value = '0' AND 
                                                    sa.action = a.ID AND 
                                                    a.type = 'checkbox' AND 
                                                    sa.model = pm.productModelID AND
                                                    pm.product = p.productID AND
                                                    a.label != 'No aplica' AND
                                                    a.label != 'No finalizar' AND
                                                    eh.expedient = sa.service AND
                                                    eh.check = 1 AND
                                                    p.productID = eh.product AND
                                                    eh.model = pm.productModelID AND
                                                    p.checkCService = 1 AND
                                                    eh.num_hiring = $maxNumHiring
                                        ORDER BY    pm.productModelID
                ");
            }

            $amount += mysqli_num_rows($result);

            $result = $db->query("  SELECT      es.policeNotified, es.policeLocation, es.webConfirm, es.webLink, es.doctorDone,
                                                es.doctorDeliver, es.doctorInProgress, es.tribunalDeliver, es.tribunalInProgress,
                                                es.tribunalLocation, es.tribunalUser, es.literalReceived, es.literalRequest, es.literalVolumePage, es.literalWhoTakes,
                                                es.literalCivilRegister, es.literalDateExit, es.literalTimeExit, es.tombstone, es.preparationConfirm, es.tombstonePrint, 
                                                es.surveySend, es.surveyNotApply, e.status, es.vivoSent, es.tombstoneNotApply, es.crematoriumProgramOven, 
                                                es.crematoriumControlDeliversAshes, e.cremation,
                                                m.vivo_recuerdo_client, m.vivo_recuerdo_key
                                    FROM        Expedients_Services es, Expedients e
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    WHERE       es.expedient = $data AND
                                                es.expedient = e.expedientID");

            if(mysqli_num_rows($result) > 0){
                $result = $db->resultToArray($result)[0];

                if(
                    $result['vivo_recuerdo_client'] == null ||
                    $result['vivo_recuerdo_client'] == '' ||
                    $result['vivo_recuerdo_key'] == null ||
                    $result['vivo_recuerdo_key'] == ''
                ){
                    $result['vivoSent'] = '1';
                }

                if($result['policeNotified'] == '0' || $result['policeNotified'] == null){
                    $amount++;
                }
                
                if($_SESSION['company'] == '1' || $_SESSION['company'] == '2' || $_SESSION['company'] == '3' || $_SESSION['company'] == '6'){
                    if($result['webConfirm'] == '0' || $result['webConfirm'] == null){
                        $amount++;
                    }
                }
               
                if($result['doctorDone'] == '0' || $result['doctorDone'] == null){
                    $amount++;
                }
               
                if($result['doctorInProgress'] == '0' || $result['doctorInProgress'] == null){
                    $amount++;
                }
                
                if($result['tribunalInProgress'] == '0' || $result['tribunalInProgress'] == null){
                    $amount++;
                }
               
                if($result['tribunalDeliver'] == '0' || $result['tribunalDeliver'] == null){
                    $amount++;
                }
                
                if($result['literalReceived'] == '0' || $result['literalReceived'] == null){
                    if(intval($result['status']) != 3  && intval($result['status']) != 4){
                        $amount++;
                    }
                }
               
                if($result['literalRequest'] == '0' || $result['literalRequest'] == null){
                    if(intval($result['status']) != 3 && intval($result['status']) != 4){
                        $amount++;
                    }
                }
               
                if($result['preparationConfirm'] == '0' || $result['preparationConfirm'] == null){
                    $amount++;
                }
               
                if(($result['tombstonePrint'] == '0' || $result['tombstonePrint'] == null) && $result['tombstoneNotApply'] != '1'){
                    $amount++;
                }
              
                if(($result['surveySend'] == '0' || $result['surveySend'] == null) && $result['surveyNotApply'] != '1'){
                    $amount++;
                }
               
                if($result['vivoSent'] == '0' || $result['vivoSent'] == null){
                    $amount++;
                }

                if($result['cremation'] == '1' && $result['crematoriumProgramOven'] == '0'){
                    $amount++;
                }

                if($result['cremation'] == '1' && $result['crematoriumControlDeliversAshes'] == '0'){
                    $amount++;
                }
            }

            // Porteadores
            $result = $db->query("  SELECT  sc.ID,
                                            c.name, c.phones
                                    FROM    Services_Carriers sc, Carriers c
                                    WHERE   sc.carrier = c.carrierID AND
                                            sc.service = $data AND
                                            sc.confirmed = 0");
            $amount += mysqli_num_rows($result);

            return $amount;
        }

        /**
         * Obtiene los coches del servicio
         * 
         * @param array $data ID del expediente
         * @return array
         */
        public function getCars($data){
            $db = new DbHandler;

            $data['expedient'] = cleanStr($data['expedient']);

            $result = $db->query("  SELECT      sc.ID, sc.driver, sc.cleanBefore, sc.cleanAfter,
                                                c.licensePlate, c.brand, c.model,
                                                CONCAT(ca1.name, ' ', ca1.surname) as driverName,
                                                CONCAT(ca2.name, ' ', ca2.surname) as cleanAfterName,
                                                CONCAT(s.name, ' ', s.surname) as cleanBeforeName
                                    FROM        (Services_Cars sc)
                                    LEFT JOIN   Cars c ON sc.car = c.ID
                                    LEFT JOIN   Carriers ca1 ON sc.driver = ca1.carrierID
                                    LEFT JOIN   Carriers ca2 ON sc.cleanAfter = ca2.carrierID
                                    LEFT JOIN   Staff s ON sc.cleanBefore = s.ID
                                    WHERE       sc.service = " . $data['expedient']);

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }

        /** ************************** Asistencias ************************** */
        /**
         * Obtiene el ID de un expediente dada su asistencia
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getExpedientID($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT  expedient 
                                    FROM    Assistances 
                                    WHERE   ID = " . $data . " AND 
                                            leavingDate IS NULL");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0]['expedient'] : null;
        }

        /**
         * Obtiene el ID de un expediente dada su asistencia
         * 
         * @param int $data
         * 
         * @return array
         */
        public function searchByNumber($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT  expedientID, number, deceasedName, deceasedSurname
                                    FROM    Expedients 
                                    WHERE   leavingDate IS NULL AND 
                                            (number LIKE '%" . $data . "%' OR deceasedName LIKE '%" . $data . "%' OR deceasedSurname LIKE '%" . $data . "%')
                                    ORDER BY expNumYear DESC, expNumSecuence DESC");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }

        /**
         * Obtiene datos de los expedientes que no tienen una cremación
         * 
         * 
         * @param int $data ID del expediente
         * @return array
         */
        public function searchByNumberNotCremation($data){
            $db = new DbHandler;

            $result = $db->query("  SELECT  e.expedientID, e.number, e.deceasedName, e.deceasedSurname
                                    FROM    Expedients e
                                    WHERE   e.crematoriumEvent IS null AND 
                                        e.crematorium IS null AND
                                        e.leavingDate IS NULL AND
                                        e.type != 2 AND
                                        (
                                            e.number LIKE '%$data%' OR CONCAT(e.deceasedName,  ' ' , e.deceasedSurname) LIKE '%$data%'
                                        )");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }

        /**
         * Obtiene información del expediente
         * 
         * @param int $data ID del expediente
         * @return array Información del expediente
         */
        public function getInfo($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT  number, deceasedName, deceasedSurname, deceasedNIF,
                                            familyContactName, familyContactSurname, familyContactPhone
                                    FROM    Expedients
                                    WHERE   expedientID = $data");
            
            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0];
        }

        /** ***************************************************** PDFS ******************************************************** */
        /**
         * Crea los datos referentes al documento y expediente
         * 
         * @param int $data
         * 
         * @return array
         */
        public function createDoc($data){
            $db = new DbHandler;

            $data['userID'] = cleanStr($data['userID']);
            $data['expedientID'] = cleanStr($data['expedientID']);
            $data['nameFile'] = cleanStr($data['nameFile']);

            $result = $db->query("  UPDATE Expedients_Documents ed
                                    SET     ed.nameFile = '" . $data['file'] . "',
                                            ed.user = '" . $data['userID'] . "',
                                            ed.date = '" . date('Y-m-d') . "'
                                    WHERE   ed.expedient = " . $data['expedientID'] . " AND
                                            ed.file = '" . $data['nameFile'] ."'");
            return $result;
        }

        /**
         * Sube los datos referentes al documento y expediente
         * 
         * @param int $data
         * 
         * @return array
         */
        public function uploadDoc($data){
            $db = new DbHandler;

            $data['expedientID'] = cleanStr($data['expedientID']);
            $data['userID'] = cleanStr($data['userID']);
            $data['nameFile'] = cleanStr($data['nameFile']);
            
            if(isset($data['type'])){
                $data['type'] = cleanStr($data['type']);
                $type = $data['type'];
            }else{
                $type = 0;
            }
            
            if(isset($data['doc'])){
                $data['doc'] = cleanStr($data['doc']);
                $doc = $data['doc'];
            }else{
                $doc = $data['nameFile'];
            }

            return $db->query(" INSERT INTO Expedients_Documents(expedient, user, `type`, `date`, `name`, `file`, nameFile)
                                VALUES (" . $data['expedientID'] . ", " . $data['userID'] . ", $type, '" . date('Y-m-d') . "', 
                                    '" . $data['nameFile'] ."', '" . $doc ."', '" . $data['file'] ."')");
        }

        /**
         * Borra los datos referentes al documento y expediente
         * 
         * @param int $data
         * 
         * @return array
         */
        public function deleteDoc($data){
            $db = new DbHandler;

            $data['expedientID'] = cleanStr($data['expedientID']);
            $data['nameFile'] = cleanStr($data['nameFile']);
            if(isset($data['pathFile']) && $data['pathFile'] != null){
                $data['pathFile'] = cleanStr($data['pathFile']);
            }else{
                $data['pathFile'] = null;
            }

            $result = $db->query("  UPDATE  Expedients_Documents ed
                                    SET     ed.nameFile = null,
                                            ed.user = null,
                                            ed.date = null
                                    WHERE   ed.expedient = " . $data['expedientID'] . " AND
                                            ed.file = '" . $data['nameFile'] ."'");


            if($data['nameFile'] == 'actaPreparacion' && $_SESSION['company'] == '1'){
                $db->query("UPDATE  Services_Auto
                            SET     value = 0
                            WHERE   service = " . $data['expedientID'] . " AND
                                    model = 804 AND
                                    action = 32
                ");
            }
            if($data['nameFile'] == 'lapidaProvisional' && $_SESSION['company'] == '1'){
                $db->query("UPDATE  Services_Auto
                            SET     value = 0
                            WHERE   service = " . $data['expedientID'] . " AND
                                    model = 568 AND
                                    action = 31
                ");
                $db->query("UPDATE  Services_Auto
                            SET     value = 0
                            WHERE   service = " . $data['expedientID'] . " AND
                                    model = 569 AND
                                    action = 31
                ");
            }


            switch($data['nameFile']){
                case 'actaIncineracion':
                case 'autoCremacion':
                case 'autoPubliEsquela':
                case 'actaJuzgado':
                case 'actaPreparacion':
                case 'cartaFlores':
                case 'cartaFloresRegistro':
                case 'conservEmbalsamiento':
                case 'conservTemporal':
                case 'contratoServiciosCompania':  
                case 'contratoServiciosFuner':   
                case 'cuestionarioSatisfaccion':
                case 'datosIglesia':
                case 'exhumacionJudicial':
                case 'situacionNichoJudicial':
                case 'justificanteSepelio':
                case 'libroVisitas':
                case 'pesameWeb':
                case 'precintadoFeretro':
                case 'recibis':
                case 'recibisIglesia':
                case 'resumenServicio':
                case 'solicitudLiterales':
                case 'solicitudNecropsia':
                case 'tarjetas':
                case 'reciboOcaso':
                case 'autorizacionPreventiva':
                case 'prestacionServicio':
                case 'fichaAsistencia':
                case 'solicitudModificacion':
                case 'autoPrestacionServicio':
                case 'hojaDatosServicio':
                case 'formularioPedido':
                case 'hojaPedidos':
                case 'autoSepultura':
                case 'depositarCenizas':
                case 'retirarCenizas':
                case 'actaExtraccionDispositivos':
                case 'trasladoCenizasCadaver':
                case 'tarjetonAgradecimiento':
                case 'trasladoHospital':
                case 'precintadoFeretro':
                case 'recibisCampaneroLaFE':
                case 'reconocPrevioIncineracion':
                case 'autoCremacionTanatorioMSanchez':
                case 'instanciaSanJose':
                case 'instanciaSEulalia':
                case 'instanciaInhumacionIbiza':
                case 'recepcionCadaveresOtrasFunerarias':
                case 'conservacionAutorizacionFamiliar':
                case 'hojaCementerioCiudadReal':
                case 'parteDefuncion':
                    if(is_file($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/docs/' . $data['nameFile'] . '.html')){
                        unlink($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/docs/' . $data['nameFile'] . '.html');
                    }

                    if(is_file($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/docs/' . $data['nameFile'] . '.pdf')){
                        unlink($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/docs/' . $data['nameFile'] . '.pdf');
                    }
                break;
                case 'instanciaAytoSJoanLibritja':
                    if(is_file($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/docs/' . $data['nameFile'] . '.html')){
                        unlink($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/docs/' . $data['nameFile'] . '.html');
                    }

                    if(is_file($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/docs/' . $data['nameFile'] . '.json')){
                        unlink($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/docs/' . $data['nameFile'] . '.json');
                    }
                break;
                case 'recordatorio':
                    if(is_file($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/reminder/0/0/files/recordatorio.pdf')){
                        unlink($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/reminder/0/0/files/recordatorio.pdf');
                    }

                    if(is_file($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/reminder/0/0/files/json.json')){
                        unlink($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/reminder/0/0/files/json.json');
                    }
                break;
                case 'recordatorioSobre':
                    if(is_file($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/reminder-packet/0/0/files/recordatorio-sobre.pdf')){
                        unlink($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/reminder-packet/0/0/files/recordatorio-sobre.pdf');
                    }

                    if(is_file($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/reminder-packet/0/0/files/json.json')){
                        unlink($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/reminder-packet/0/0/files/json.json');
                    }
                break;
                case 'recordatorioSobreCruz':
                    if(is_file($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/reminder-packet-cross/0/0/files/recordatorio-sobre-cruz.pdf')){
                        unlink($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/reminder-packet-cross/0/0/files/recordatorio-sobre-cruz.pdf');
                    }

                    if(is_file($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/reminder-packet-cross/0/0/files/json.json')){
                        unlink($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/reminder-packet-cross/0/0/files/json.json');
                    }
                break;
                case 'cerradoDefuncion':
                    if(is_file($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/closed-death/0/0/files/cerradoPorDefuncion.pdf')){
                        unlink($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/closed-death/0/0/files/cerradoPorDefuncion.pdf');
                    }
                break;
                case 'noDuelo':
                    if(is_file($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/no-duel-received/0/0/files/NoRecibeDuelo.pdf')){
                        unlink($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/no-duel-received/0/0/files/NoRecibeDuelo.pdf');
                    }
                break;
                case 'lapidaProvisional':
                    if(isset($data['pathFile']) && $data['pathFile'] != null){
                        $pathPieces = explode('/expedients/' . $data['expedientID'] . '/', $data['pathFile']);
                        $pdfPath = $pathPieces[1];
                        if(is_file($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/' . $pdfPath)){
                            unlink($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/' . $pdfPath);
                        }
    
                        $jsonPath = str_replace('lapida.pdf', '' , $pdfPath);
                        if(is_file($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/' . $jsonPath . 'json.json')){
                            unlink($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedientID'] . '/' . $jsonPath . 'json.json');
                        }
                    }
                break;
            }
            
            return true;
        }

        /**
         * Borra los datos referentes al documento y expediente
         * 
         * @param int $data
         * 
         * @return array
         */
        public function deleteUpdatedDoc($data){
            $db = new DbHandler;

            $data['docID'] = cleanStr($data['docID']);
            $data['expedientID'] = cleanStr($data['expedientID']);
            $data['nameFile'] = cleanStr($data['nameFile']);

            $result = $db->query(" DELETE FROM Expedients_Documents WHERE ID = " . $data['docID'] . "");

            unlink($_SESSION['basePath'] . "resources/files/{$_SESSION['company']}/expedients/". $data['expedientID'] . "/docs/" . $data['nameFile'] . ".pdf");
        }

        /**
         * Obtiene el número de pdfs (documentación) de un tipo para un expediente
         *
         * @param array Contiene el ID del expediente y el nombre del documento a buscar
         * 
         * @return int
         */
        public function countPdfs($data){
            $data['service'] = cleanStr($data['service']);
            $data['docName'] = cleanStr($data['docName']);

            $files = scandir($_SESSION['basePath'] . "resources/files/{$_SESSION['company']}/expedients/" . $data['service'] . "/docs/");

            $pdf = "";
            foreach($files as $file){
                if(strpos($file, $data['docName']) !== false){
                    $pdf = $file;
                }
            }

            $pdf = explode("_", $pdf);
            if(count($pdf) > 1){
                $pdf = intval(explode(".", $pdf[1])[0]);
            }else{
                $pdf = 0;
            }

            return ++$pdf;
        }
                
        
        /**
         * Obtiene las asistencias dado un período para crear un pdf
         * 
         * @param array $data
         * 
         * @return array
         */
        public function getAlbaran($ID){
            $db = new DbHandler;

            $ID = cleanStr($ID);

            $deliveryNote = $db->query("SELECT    dn.*, m.name AS mortuaryName, o.deliveryDate, s.name AS supplierName
                                        FROM      (DeliveryNotes dn)
                                        LEFT JOIN Orders o ON o.ID = dn.order
                                        LEFT JOIN Mortuaries m ON m.mortuaryID = o.deliveryPlace
                                        LEFT JOIN Suppliers s ON s.supplierID = o.supplier
                                        WHERE       dn.ID = " . $ID);

            if(mysqli_num_rows($deliveryNote) > 0){
                $deliveryNote = $db->resultToArray($deliveryNote)[0];
            }
            
            $deliveryNoteLines = $db->query("   SELECT  dnl.receivedAmount AS amount, p.name as productName, pm.name as productModelName
                                                FROM    DeliveryNotes dn, DeliveryNotes_Lines dnl, Products p, Products_Models pm
                                                WHERE   dn.ID = dnl.deliveryNote AND
                                                        dn.ID = " . $ID . " AND
                                                        pm.product = p.productID AND
                                                        dnl.model = pm.productModelID");
            
            if(mysqli_num_rows($deliveryNoteLines) > 0){
                $deliveryNoteLines = $db->resultToArray($deliveryNoteLines);
            }
            
            $orderLines = $db->query("  SELECT  ol.amount, p.name as productName, pm.name as productModelName, pm.supplierReference
                                        FROM    Orders_Lines ol, Products p, Products_Models pm, DeliveryNotes dn
                                        WHERE   ol.order = dn.order AND
                                                dn.ID = $ID AND
                                                ol.model = pm.productModelID AND
                                                pm.product = p.productID");

            if(mysqli_num_rows($orderLines) > 0){
                $orderLines = $db->resultToArray($orderLines);
            }
            

            return array($deliveryNote, $deliveryNoteLines, $orderLines);
        }

        /**
         * Obtiene las asistencias dado un período para crear un pdf
         * 
         * @param array $data
         * 
         * @return array
         */
        public function getAlbaranes(){
            $db = new DbHandler;

            $deliveryNotes = $db->query("   SELECT  dn.*
                                            FROM    DeliveryNotes dn, Orders o
                                            WHERE   o.ID = dn.order AND dn.inAgreement = 0 AND o.leavingDate IS NULL");
            
            if(mysqli_num_rows($deliveryNotes) > 0){
                $deliveryNotes = $db->resultToArray($deliveryNotes);
            }

            $result = array();

            foreach($deliveryNotes AS $key => $delivery){
                $deliveryNote = $db->query("SELECT      dn.*, m.name AS mortuaryName, o.deliveryDate, s.name AS supplierName
                                            FROM        (DeliveryNotes dn)
                                            LEFT JOIN   Orders o ON o.ID = dn.order
                                            LEFT JOIN   Mortuaries m ON m.mortuaryID = o.deliveryPlace
                                            LEFT JOIN   Suppliers s ON s.supplierID = o.supplier
                                            WHERE       dn.ID = " . $delivery['ID'] );
    
                if(mysqli_num_rows($deliveryNote) > 0){
                    $deliveryNote = $db->resultToArray($deliveryNote)[0];
                }
                
                $deliveryNoteLines = $db->query("   SELECT  dnl.receivedAmount AS amount, p.name as productName, pm.name as productModelName
                                                    FROM    DeliveryNotes dn, DeliveryNotes_Lines dnl, Products p, Products_Models pm
                                                    WHERE   dn.ID = dnl.deliveryNote AND
                                                            dn.ID = " . $delivery['ID'] . " AND
                                                            pm.product = p.productID AND
                                                            dnl.model = pm.productModelID");
                
                if(mysqli_num_rows($deliveryNoteLines) > 0){
                    $deliveryNoteLines = $db->resultToArray($deliveryNoteLines);
                }
                
                $orderLines = $db->query("  SELECT  ol.amount, p.name as productName, pm.name as productModelName
                                            FROM    Orders_Lines ol, Products p, Products_Models pm, DeliveryNotes dn
                                            WHERE   ol.order = dn.order AND
                                                    dn.ID = " . $delivery['ID'] . " AND
                                                    ol.model = pm.productModelID AND
                                                    pm.product = p.productID");
    
                if(mysqli_num_rows($orderLines) > 0){
                    $orderLines = $db->resultToArray($orderLines);
                }

                $result[$key] = array($deliveryNote, $deliveryNoteLines, $orderLines);
            }

            return $result;
        }
        /**
         * Obtiene las asistencias dado un período para crear un pdf
         * 
         * @param array $data
         * 
         * @return array
         */
        public function getAsistencia($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $query = "  SELECT      a.*, ss.*,
                                    l.locationID, l.name as locationName,
                                    e.number, e.deceasedGender, e.deceasedName, e.deceasedSurname, e.deceasedFirstNuptials, e.policy, e.deceasedDate, e.number, e.deceasedFirstNuptials, e.capital,
                                    m.name as mortuaryName,
                                    l2.name AS mortuaryLocation, l2.province AS mortuaryProvince
                        FROM        (Assistances a, Expedients e)
                        LEFT JOIN   Locations l ON a.location = l.locationID
                        LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                        LEFT JOIN   Locations l2 ON m.location = l2.locationID
                        LEFT JOIN   Satisfaction_Survey ss ON ss.expedient = a.expedient
                        WHERE       a.expedient = e.expedientID AND a.expedient = $data";

            $result = $db->query($query);

            if(mysqli_num_rows($result) > 0){
                $info = $db->resultToArray($result)[0];

                $expedient = $info['expedient'];

                $result = $db->query("  SELECT  a.ID
                                        FROM    Assistances a
                                        WHERE   a.expedient = $expedient AND
                                                a.leavingDate IS NULL");

                if(mysqli_num_rows($result) > 0){
                    $assistance = $db->resultToArray($result)[0]['ID'];

                    $result = $db->query("  SELECT  s.service,
                                                    sa.value, sa.notes
                                            FROM    Survey_Assistance sa, Survey s
                                            WHERE   sa.assistance = $assistance AND
                                                    sa.survey = s.ID");

                    if(mysqli_num_rows($result) > 0){
                        return array($info, $db->resultToArray($result));
                    }else{
                        return null;
                    }
                }else{
                    return null;
                }
            }else{
                return null;
            }

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf acta de incineración
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getActaIncineracion($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.deceasedNIF, e.deceasedName, e.deceasedSurname, e.number, e.deceasedBirthday, e.deceasedDate, e.deceasedGender, e.trazabilityId,
                                                ev.start,
                                                cr.address,
                                                l.name, l.province
                                    FROM        (Expedients e)
                                    LEFT JOIN   Events ev ON ev.ID = e.crematoriumEvent
                                    LEFT JOIN   Crematoriums cr ON e.crematorium = cr.crematoriumID
                                    LEFT JOIN   Locations l ON cr.location = l.locationID
                                    WHERE       expedientID = " . $data . "");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf acta de juzgado
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getActaJuzgado($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.applicantName, e.applicantSurname, e.applicantNIF, e.number, e.deceasedGender, e.deceasedName, 
                                                e.deceasedSurname, e.deceasedDate, e.deceasedTime,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, c.name) AS deceasedCemetery
                                    FROM        Expedients e
                                    LEFT JOIN   Cemeteries c ON e.cemetery = c.cemeteryID
                                    WHERE       expedientID = " . $data . "");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf acta de juzgado
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getActaPreparacion($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedSurname, e.deceasedGender, e.funeralHomeEntryTime, e.tanatologicalPractice,
                                                e.responsibleName, e.responsibleNIF, f.name as funeralHome,
                                                s.name
                                    FROM        (Expedients e)
                                    LEFT JOIN   Staff s ON e.responsibleUser = s.ID
                                    LEFT JOIN   FuneralHomes f ON e.funeralHome = f.funeralHomeID
                                    WHERE       expedientID =  $data");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf autorización para cremación
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getAutoCremacion($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.familyContactName, e.familyContactSurname, e.familyContactNIF, e.familyContactAddress, e.deceasedGender, e.familyContactRelationship, e.number, e.deceasedName, e.deceasedSurname,
                                                e.deceasedNIF, e.deceasedDate, e.deceasedTime, e.crematoriumIntroduction, e.crematoriumWaitOnRoom, e.crematoriumVaseBio, e.crematoriumPacemaker, e.deceasedRoom,
                                                e.authDate, e.authTime, e.authPlace, e.crematoriumArriveTime,
                                                c.name AS crematorium,
                                                ev.start, ev.end,
                                                l.name as familyContactLocality,
                                                l2.name as cremationLocality,
                                                di.name as deceasedInName,
                                                l3.name AS deceasedLocation, l3.province AS deceasedProvince
                                    FROM        (Expedients e)
                                    LEFT JOIN   Events ev ON ev.expedient = e.expedientId
                                    LEFT JOIN   Crematoriums c ON e.crematorium = c.crematoriumID
                                    LEFT JOIN   Locations l ON e.familyContactLocation = l.locationID
                                    LEFT JOIN   Locations l2 ON c.location = l2.locationID
                                    LEFT JOIN   DeceasedIn di ON di.deceasedInID = e.deceasedLocation
                                    LEFT JOIN   Locations l3 ON l3.locationID = di.location
                                    WHERE       expedientID = " . $data);

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf hoja cementerio de Ciudad Real
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getHojaCementerio($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedSurname, e.deceasedGender, e.deceasedBirthday, e.deceasedDate, e.deceasedTime, e.deceasedCause,
                                                e.deceasedUsualAddress, e.deceasedCause
                                    FROM        Expedients e
                                    WHERE       e.expedientID = " . $data);

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf hoja cementerio de Ciudad Real
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getParteDefuncion($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedSurname, e.number, e.requestDate, e.entryDateBarrow, e.entryTimeBarrow,
                                                st1.name as familyAssistanceName, st1.surname as familyAssistanceSurname,
                                                st2.name as corpseCollection1Name, st2.surname as corpseCollection1Surname,
                                                st3.name as corpseCollection2Name, st3.surname as corpseCollection2Surname
                                    FROM        (Expedients e, Expedients_Services es)
                                    LEFT JOIN   Staff st1 ON es.familyAssistance = st1.ID
                                    LEFT JOIN   Staff st2 ON es.corpseCollection1 = st2.ID
                                    LEFT JOIN   Staff st3 ON es.corpseCollection2 = st3.ID
                                    WHERE       e.expedientID = es.expedient AND
                                                e.expedientID = " . $data);

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf autorización para publicar esquela
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getAutoPubliEsquela($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.familyContactName, e.familyContactSurname, e.familyContactNIF, e.deceasedName, e.deceasedSurname, e.deceasedGender, e.deceasedRoom,
                                                m.name AS deceasedMortuary,
                                                c.name as clientName,
                                                (
                                                    SELECT  CONCAT(u.name,' ', u.surname)
                                                    FROM    Users u
                                                    WHERE   u.userID = " . $_SESSION['user'] . "
                                                ) as userName
                                    FROM        (Expedients e)
                                    LEFT JOIN   Mortuaries m ON m.mortuaryID = e.deceasedMortuary
                                    LEFT JOIN   Clients c ON c.clientID = e.crematoriumClient
                                    WHERE       expedientID = $data");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf carta de flores
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getCartaFlores($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $carta = $db->query("   SELECT  e.number, e.deceasedName, e.deceasedSurname, e.funeralDate, e.deceasedGender, e.funeralDate
                                    FROM    Expedients e
                                    WHERE   expedientID = $data");

            if(mysqli_num_rows($carta) > 0){
                $carta = $db->resultToArray($carta)[0];

                $maxNumHiring = $this->getActiveHiring($data);
                   
                // Obtenemos los expedientes asociados al expediente actual
                $result = $db->query("  SELECT  exas.expedientID
                                        FROM    Expedients_Associates exas
                                        WHERE   exas.associate = $data AND
                                                exas.leavingDate IS NULL
                ");
                $expedientesAssociates = $db->resultToArray($result);

                $expedientesAssociatesIds = '';
                if(count($expedientesAssociates) > 0){
                    foreach($expedientesAssociates as $elem){
                        $expedientesAssociatesIds.= $elem['expedientID'] . ',';
                    }
                    if($expedientesAssociatesIds != ''){
                        $expedientesAssociatesIds = substr($expedientesAssociatesIds, 0, -1);
                    }
                }

                if($expedientesAssociatesIds != ''){

                    $texts = $db->query("   SELECT  Z.productID, 
                                                    Z.name, 
                                                    Z.value, 
                                                    Z.serviceBelow
                                            FROM(
                                                    (
                                                        SELECT      p.productID, 
                                                                    p.name, 
                                                                    REPLACE(et.value, '\\\', '') as value, 
                                                                    p.serviceBelow
                                                        FROM        Expedients_Hirings eh
                                                        LEFT JOIN   Expedients_Texts et ON eh.ID = et.hiring
                                                        LEFT JOIN   Products p ON p.productID = eh.product
                                                        WHERE       $data = eh.expedient AND 
                                                                    eh.num_hiring = $maxNumHiring AND
                                                                    (p.serviceBelow = 5 OR p.serviceBelow = 6 OR p.serviceBelow = 7) AND 
                                                                    eh.check = 1
                                                    )
                                                    UNION
                                                    (
                                                        SELECT      p.productID, 
                                                                    p.name, 
                                                                    REPLACE(et.value, '\\\', '') as value, 
                                                                    '6' as serviceBelow
                                                        FROM        Expedients_Hirings eh
                                                        LEFT JOIN   Expedients_Texts et ON eh.ID = et.hiring
                                                        LEFT JOIN   Products p ON p.productID = eh.product
                                                        WHERE       eh.expedient IN ($expedientesAssociatesIds) AND 
                                                                    (p.serviceBelow = 5 OR p.serviceBelow = 6 OR p.serviceBelow = 7) AND 
                                                                    eh.check = 1
                                                    )
                                            ) as Z
                    ");

                    if(mysqli_num_rows($texts) > 0){
                        $carta['texts'] = $db->resultToArray($texts);
                    }

                    $result = $db->query("  SELECT  Z.category, 
                                                    Z.value
                                            FROM(
                                                    (
                                                        SELECT  category, value
                                                        FROM    Flowers_Letters fl
                                                        WHERE   fl.expedient = $data
                                                    )
                                                    UNION
                                                    (
                                                        SELECT  category, value
                                                        FROM    Flowers_Letters fl
                                                        WHERE   fl.expedient IN ($expedientesAssociatesIds) 
                                                    )
                                            ) as Z
                    ");

        
                    if(mysqli_num_rows($result) > 0){
                        $carta['moreTexts'] = $db->resultToArray($result);
                    }

                }else{

                    $texts = $db->query("   SELECT      p.productID, p.name, REPLACE(et.value, '\\\', '') as value, p.serviceBelow
                                            FROM        Expedients_Hirings eh
                                            LEFT JOIN   Expedients_Texts et ON eh.ID = et.hiring
                                            LEFT JOIN   Products p ON p.productID = eh.product
                                            WHERE       $data = eh.expedient AND 
                                                        eh.num_hiring = $maxNumHiring AND
                                                        (p.serviceBelow = 5 OR p.serviceBelow = 6 OR p.serviceBelow = 7) AND 
                                                        eh.check = 1
                    ");

                    if(mysqli_num_rows($texts) > 0){
                        $carta['texts'] = $db->resultToArray($texts);
                    }
        
                    $result = $db->query("  SELECT  category, value
                                            FROM    Flowers_Letters fl
                                            WHERE   fl.expedient = $data");
        
                    if(mysqli_num_rows($result) > 0){
                        $carta['moreTexts'] = $db->resultToArray($result);
                    }
                }
            }

            return count($carta) > 0 ? $carta : null;
        }

        /**
         * Obtiene los datos para el pdf carta de flores registro
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getCartaFloresRegistro($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.number, e.deceasedName, e.deceasedSurname, e.deceasedRoom, e.number, 
                                                m.name AS deceasedMortuary, e.deceasedGender, deceasedMortuaryAddress
                                    FROM        (Expedients e)
                                    LEFT JOIN   Mortuaries m ON m.mortuaryID = e.deceasedMortuary
                                   WHERE        expedientID = " . $data . "");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf conservación temporal
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getConservTemporal($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("SELECT e.deceasedName, e.deceasedSurname, e.deceasedBirthday, e.deceasedNIF, e.deceasedDate, e.deceasedGender
                                    FROM Expedients e
                                   WHERE expedientID = " . $data . "");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf conservación embalsamiento
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getConservEmbalsamiento($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("SELECT e.deceasedName, e.deceasedSurname, e.deceasedBirthday, e.deceasedNIF, e.deceasedDate, e.deceasedTime, e.deceasedGender
                                    FROM Expedients e
                                   WHERE expedientID = " . $data . "");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf contratos servicios compañias
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getContratoServiciosCompañias($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.familyContactName, e.familyContactSurname, e.familyContactNIF, e.deceasedName, e.deceasedSurname, 
                                                e.number, e.deceasedGender, e.number, m.name as mortuary
                                    FROM        Expedients e
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    WHERE       expedientID = " . $data . "");

            $result = $db->resultToArray($result)[0];

            $maxNumHiring = $this->getActiveHiring($data);

            //Contratación normal
            $result2 = $db->query(" SELECT      eh.amount, eh.discount,
                                                pr.productID as productID, pr.name as productName, pr.supplied, pr.texts,
                                                pm.productModelID as modelID, pm.name as modelName,
                                                pp.priceNoIVA,
                                                it.percentage,
                                                et.discount as multipleDiscount
                                    FROM        (Expedients_Hirings eh, Expedients e, Products_Prices pp, Products pr, IVA_Types it, Clients c, Products_Models pm)
                                    LEFT JOIN   Expedients_Texts  et ON et.hiring = eh.ID
                                    WHERE       eh.expedient = " . $data . " AND 
                                                eh.check = 1 AND 
                                                eh.expedient = e.expedientID AND
                                                e.client = c.clientID AND
                                                c.price = pp.price AND
                                                eh.model = pm.productModelID AND
                                                eh.product = pr.productID AND
                                                pr.IVA = it.IVATypeID AND
                                                pr.leavingDate IS NULL AND
                                                pr.supplied = 0 AND 
                                                pp.model = pm.productModelID AND
                                                eh.num_hiring = $maxNumHiring
                                    ORDER BY    pr.orderBy, eh.product, eh.model
            ");

            if(mysqli_num_rows($result2) > 0){
                $result2 = $db->resultToArray($result2);
                $result['factura'] = $result2;
            }

            //Contratación suplidos
            $result2 = $db->query(" SELECT      eh.amount, eh.discount,
                                                pr.productID as productID, pr.name as productName, pr.supplied, pr.texts,
                                                pm.productModelID as modelID, pm.name as modelName,
                                                it.percentage,
                                                et.discount as multipleDiscount,
                                                eh.total as cost
                                    FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                    LEFT JOIN   Expedients_Texts  et ON et.hiring = eh.ID
                                    WHERE       eh.expedient = " . $data . " AND 
                                                eh.check = 1 AND 
                                                eh.expedient = e.expedientID AND
                                                eh.model = pm.productModelID AND
                                                eh.product = pr.productID AND
                                                pr.IVA = it.IVATypeID AND
                                                pr.leavingDate IS NULL AND
                                                pr.supplied = 1 AND
                                                eh.num_hiring = $maxNumHiring
                                    ORDER BY    pr.orderBy, eh.product, eh.model
            ");

            if(mysqli_num_rows($result2) > 0){
                $result2 = $db->resultToArray($result2);
                $result['suplidos'] = $result2;
            }

            return $result;
        }

        /**
         * Obtiene los datos para el pdf contratos servicios funerarios
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getContratoServiciosFunerarios($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedSurname, e.deceasedGender, e.number, m.name as mortuary
                                    FROM        Expedients e
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    WHERE       expedientID = " . $data . "");

            $result = $db->resultToArray($result)[0];

            $maxNumHiring = $this->getActiveHiring($data);

            //Contratación normal
            $result2 = $db->query(" SELECT      eh.amount, eh.discount,
                                                pr.productID as productID, pr.name as productName, pr.supplied, pr.texts,
                                                pm.productModelID as modelID, pm.name as modelName,
                                                pp.priceNoIVA,
                                                it.percentage,
                                                et.discount as multipleDiscount
                                    FROM        (Expedients_Hirings eh, Expedients e, Products_Prices pp, Products pr, IVA_Types it, Clients c, Products_Models pm)
                                    LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                    WHERE       eh.expedient = " . $data . " AND 
                                                eh.check = 1 AND 
                                                eh.expedient = e.expedientID AND
                                                e.client = c.clientID AND
                                                c.price = pp.price AND
                                                eh.model = pm.productModelID AND
                                                eh.product = pr.productID AND
                                                pr.IVA = it.IVATypeID AND
                                                pr.leavingDate IS NULL AND
                                                pr.supplied = 0 AND 
                                                pp.model = pm.productModelID AND
                                                eh.num_hiring = $maxNumHiring
                                    ORDER BY    pr.orderBy, eh.product, eh.model
            ");

            if(mysqli_num_rows($result2) > 0){
                $result2 = $db->resultToArray($result2);
                $result['factura'] = $result2;
            }

            //Contratación suplidos
            $result2 = $db->query(" SELECT      eh.amount, eh.discount,
                                                pr.productID as productID, pr.name as productName, pr.supplied, pr.texts,
                                                pm.productModelID as modelID, pm.name as modelName,
                                                it.percentage,
                                                et.discount as multipleDiscount,
                                                eh.total as cost
                                    FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                    LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                    WHERE       eh.expedient = " . $data . " AND 
                                                eh.check = 1 AND 
                                                eh.expedient = e.expedientID AND
                                                eh.model = pm.productModelID AND
                                                eh.product = pr.productID AND
                                                pr.IVA = it.IVATypeID AND
                                                pr.leavingDate IS NULL AND
                                                pr.supplied = 1 AND
                                                eh.num_hiring = $maxNumHiring
                                    ORDER BY    pr.orderBy, eh.product, eh.model
            ");

            if(mysqli_num_rows($result2) > 0){
                $result2 = $db->resultToArray($result2);
                $result['suplidos'] = $result2;
            }

            return $result;
        }

        /**
         * Obtiene los datos para el pdf cuestionario de satisfacción
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getCuestionarioSatisfaccion($data){
            $db = new DbHandler;

            $data = cleanStr($data);
            $result = $db->query("  SELECT  e.deceasedGender, e.deceasedName, e.deceasedSurname, e.number,
                                            ss.aspects, ss.date, ss.relationship, ss.name, ss.expedient
                                    FROM    Expedients e, Satisfaction_Survey ss
                                    WHERE   e.expedientID = " . $data . " AND
                                            e.expedientID = ss.expedient");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $data = $db->resultToArray($result)[0];

                $expedient = $data['expedient'];

                $result = $db->query("  SELECT  a.ID
                                        FROM    Assistances a
                                        WHERE   a.expedient = $expedient AND
                                                a.leavingDate IS NULL");

                if(mysqli_num_rows($result) > 0){
                    $assistance = $db->resultToArray($result)[0]['ID'];

                    $result = $db->query("  SELECT  s.service,
                                                    sa.value, sa.notes
                                            FROM    Survey_Assistance sa, Survey s
                                            WHERE   sa.assistance = $assistance AND
                                                    sa.survey = s.ID");

                    if(mysqli_num_rows($result) > 0){
                        return array($data, $db->resultToArray($result));
                    }else{
                        return null;
                    }
                }else{
                    return null;
                }
            }
        }

        /**
         * Obtiene los datos para el pdf datos de iglesia
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getDatosIglesia($data){
            $db = new DbHandler;

            $data = cleanStr($data);
                                    
            $result = $db->query("  SELECT      e.number, e.funeralDate, e.deceasedDate, e.deceasedName, e.deceasedSurname, e.deceasedChildOfFather,
                                                e.deceasedChildOfMother, e.deceasedMaritalStatus, e.deceasedFirstNuptials, e.deceasedRoom, e.deceasedBirthday,
                                                e.deceasedUsualAddress, e.deceasedGender, e.churchLabel, e.deceasedRoom, e.deceasedMortuaryAddress, e.regime, e.exhumation,
                                                e.nicheHeight, e.funeralNicheNumber,
                                                IF(e.churchLabel = 'Otro', e.otherCeremony, ch.name) as church,
                                                di.name as deceasedIn,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, c.name) as cemetery,
                                                m.name as mortuary,
                                                l.name as birthdayLocation, l.province AS deceasedBirthdayProvince,
                                                l2.name as locationName, l2.province locationProvince,
                                                e.deceasedProvince as usualProvince, e.deceasedLocality as usualLocation
                                    FROM        (Expedients e)
                                    LEFT JOIN   DeceasedIn di ON e.deceasedLocation = di.deceasedInID
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   Cemeteries c ON e.cemetery = c.cemeteryID
                                    LEFT JOIN   Churches ch ON e.church = ch.churchID
                                    LEFT JOIN   Locations l ON l.locationID = e.deceasedBirthdayLocation
                                    LEFT JOIN   Locations l2 ON l2.locationID = di.location
                                    WHERE       expedientID = $data");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf datos de iglesia
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getDepositarCenizas($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.exhumation, e.funeralNicheNumber, e.deceasedName, e.deceasedSurname, e.deceasedGender, e.number,
                                                e.familyContactName, e.familyContactSurname, e.familyContactNIF, e.familyContactAddress, e.deceasedDate,
                                                e.niche, e.nicheHeight, e.exhumation, e.regime, e.cemeteryLabel,
                                                l.name AS familyContactLocality, l.province AS familyContactProvince,
                                                di.name as deceasedIn, CONCAT(l2.name, ', ', l2.province) AS deceasedInName,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, c.name) as cemetery,
                                                l3.name AS cemeteryLocation, l3.province AS cemeteryProvince,
                                                CONCAT(l4.name, ', ' , l4.province) AS applicantLocation
                                    FROM        Expedients e
                                    LEFT JOIN   Locations l ON e.familyContactLocation = l.locationID
                                    LEFT JOIN   DeceasedIn di ON di.deceasedInID = e.deceasedLocation
                                    LEFT JOIN   Locations l2 ON l2.locationID = di.location
                                    LEFT JOIN   Cemeteries c ON e.cemetery = c.cemeteryID
                                    LEFT JOIN   Locations l3 ON l3.locationID = c.location
                                    LEFT JOIN   Locations l4 ON l4.locationID = e.applicantLocation
                                    WHERE       expedientID = $data");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf datos de iglesia
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getDistribution($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT  e.deceasedGender, e.deceasedName, e.deceasedSurname
                                    FROM    (Expedients e)
                                   WHERE    expedientID = " . $data . "");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf exhumación judicial
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getExhumacionJudicial($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedSurname, e.deceasedGender, applicantName, applicantSurname, applicantNif, applicantLocation, 
                                                deceasedName, deceasedSurname, deceasedGender, deceasedLocation as expedientDL, e.otherDeceasedLocation,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, c.name) as cemetery,
                                                l.name AS cemeteryLocation, l.province AS cemeteryProvince,
                                                l2.name as deceasedLocation
                                    FROM        Expedients e
                                    LEFT JOIN   Cemeteries c ON c.cemeteryID = e.cemetery
                                    LEFT JOIN   Locations l ON l.locationID = c.location
                                    LEFT JOIN   DeceasedIn d ON e.deceasedLocation = d.deceasedInID
                                    LEFT JOIN   Locations l2 ON l2.locationID = d.location
                                    WHERE       expedientID = $data");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }        


        /**
         * Obtiene los datos para el pdf exhumación judicial
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getEsquela($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      eo.*, 
                                                e.deceasedName, 
                                                e.deceasedSurname, 
                                                e.deceasedRoom, 
                                                l.name AS deceasedLocation, 
                                                m.name AS mortuaryName, 
                                                e.deceasedMortuaryAddress
                                    FROM        Expedients_Obituaries eo, Expedients e
                                    LEFT JOIN   Locations l ON e.deceasedBirthdayLocation = l.locationID
                                    LEFT JOIN   Mortuaries m ON e.deceasedLocation = m.mortuaryID
                                        WHERE   eo.expedient = " . $data . " AND 
                                                e.expedientID = eo.expedient AND 
                                                eo.update = (SELECT MAX(`update`) FROM Expedients_Obituaries WHERE expedient = " . $data . ")");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }        

        /**
         * Obtiene los datos para el pdf factura
         * 
         * @param int $expedientID Expedient id
         * @param int $numHiring Num hiring 
         * @param int $rectifiedTypeParam Rectified type parameter (1->S, 2->I)
         * 
         * @return array
         */
        public function getFactura($expedientID, $numHiring = null, $rectifiedTypeParam = null){
            $db = new DbHandler;

            $expedientID = cleanStr($expedientID);
            if($numHiring != null){
                $numHiring = cleanStr($numHiring);
            }else{
                $result = $db->query("  SELECT  MAX(eh.num_hiring) as num_hiring
                                        FROM    Expedients_Hirings eh
                                        WHERE   eh.expedient = $expedientID
                ");

                if(mysqli_num_rows($result) > 0){
                    $numHiring = $db->resultToArray($result)[0]['num_hiring'];
                }else{
                    $numHiring = 0;
                }
            }

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedSurname, e.number, e.policy, e.lossNumber, e.deceasedGender, e.deceasedDate,
                                                e.familyContactName, e.familyContactSurname, e.familyContactNIF, e.familyContactRelationship, e.tpv, e.clientType,
                                                m.name AS mortuary, m.isYourOwn,
                                                c.name AS clientName, c.surname AS clientSurname, c.clientID AS clientID, c.type as clientType, c.address, c.nif, l.name as locationName, l.postalCode, l.province,
                                                i.ID as facturaID, i.comments, i.accountNumber, i.paymentMethod, i.generatedInvoiceNumber, i.creationDate as creationDate, 
                                                i.original_invoice_rectified, i.invoice_type, i.rectified_type, i.billingSerie, i.verifactu_error, i.verifactu_csv, i.verifactu_hash, i.description
                                    FROM        (Expedients e)
                                    LEFT JOIN   Mortuaries m ON m.mortuaryID = e.deceasedMortuary
                                    LEFT JOIN   Invoices i ON i.expedient = e.expedientID AND i.leavingDate IS NULL AND i.num_hiring = $numHiring
                                    LEFT JOIN   Clients c ON c.clientID = e.client
                                    LEFT JOIN   Locations l ON l.locationID = c.location
                                    WHERE       expedientID = " . $expedientID . "
                                    ORDER BY    i.ID DESC
            ");

            $result = $db->resultToArray($result)[0];

            //Obtener el id de la tarifa de particulares para el año de solicitud del expediente
            $particularPrice = $db->query(" SELECT  p.priceID
                                            FROM    Prices p, Expedients e 
                                            WHERE   p.name = 'Particulares' 
                                                    AND p.leavingDate IS NULL
                                                    AND p.year = YEAR(e.requestDate) 
                                                    AND e.expedientID = ".$expedientID."
            ");

            if(mysqli_num_rows($particularPrice) > 0){
                $particularPrice = $db->resultToArray($particularPrice)[0]['priceID'];

                $result2 = $db->query(" SELECT      eh.ID as hiringID, eh.amount, eh.discount, eh.total as totalEditPrice,
                                                    pr.productID as productID, pr.name as productName, pr.supplied, pr.texts, pr.editPrice,
                                                    pm.productModelID as modelID, pm.name as modelName,
                                                    pp.priceNoIVA, it.percentage, e.clientType,
                                                    (
                                                        SELECT pp2.priceNoIVA
                                                        FROM   Products_Prices pp2
                                                        WHERE  pp2.price = $particularPrice AND pp2.model = pm.productModelID
                                                    ) as particularPrice,
                                                    et.discount as multipleDiscount,
                                                    eh.old_hiring
                                        FROM        (Expedients_Hirings eh, Expedients e, Products_Prices pp, Products pr, IVA_Types it, Products_Models pm)
                                        LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                        WHERE       eh.expedient = " . $expedientID . " AND 
                                                    eh.check = 1 AND 
                                                    eh.expedient = e.expedientID AND
                                                    pp.price = eh.priceExp AND
                                                    eh.model = pm.productModelID AND
                                                    eh.product = pr.productID AND
                                                    pr.IVA = it.IVATypeID AND
                                                    pr.leavingDate IS NULL AND
                                                    pr.supplied = 0 AND 
                                                    pr.isInvoiced = 0 AND
                                                    pp.model = pm.productModelID AND
                                                    eh.num_hiring = $numHiring
                                        ORDER BY    pr.blockBelow, pr.orderBy, pr.productID, eh.ID
                ");
                                        
                if(mysqli_num_rows($result2) > 0){
                    $result2 = $db->resultToArray($result2);
                    $i = 0;
                    foreach($result2 as $key => $value){
                        $texts =  $db->query("  SELECT  REPLACE(et.value, '\\\', '') as value
                                                FROM    Expedients_Texts et
                                                WHERE   et.hiring = {$value['hiringID']}"
                        );
                                            
                        if(mysqli_num_rows($texts) > 0){
                            $result2[$i]['texts'] = $db->resultToArray($texts);
                        }else{
                            $result2[$i]['texts'] = '';
                        }
                        $i++;
                    }
                    $result['factura'] = $result2;
                }
            }else{
                $result['factura'] = array();
            }

            if(!isset($result['factura']) || $result['factura'] == null){
                $result['factura'] = array();
            }

            // Contratacion original - cuando la factura a procesar es rectitificada por diferencias
            if($rectifiedTypeParam == 2 || $result['rectified_type'] == '2'){

                $searchHiringToRectified = $db->query(" SELECT  MAX(i.num_hiring) as num_hiring
                                                        FROM    Invoices i
                                                        WHERE   i.expedient = $expedientID AND
                                                                i.leavingDate IS NULL AND
                                                                i.num_hiring < $numHiring AND
                                                                i.invoice_type != 3
                ");

                if(mysqli_num_rows($searchHiringToRectified) > 0){
                    $numHiringOriginal = $db->resultToArray($searchHiringToRectified)[0]['num_hiring'];
                }else{
                    $numHiringOriginal = 0;
                }

                $result2 = $db->query(" SELECT      eh.ID as hiringID, eh.amount, eh.discount, eh.total as totalEditPrice,
                                                    pr.productID as productID, pr.name as productName, pr.supplied, pr.texts, pr.editPrice,
                                                    pm.productModelID as modelID, pm.name as modelName,
                                                    pp.priceNoIVA, it.percentage, e.clientType,
                                                    (
                                                        SELECT pp2.priceNoIVA
                                                        FROM   Products_Prices pp2
                                                        WHERE  pp2.price = $particularPrice AND pp2.model = pm.productModelID
                                                    ) as particularPrice,
                                                    et.discount as multipleDiscount
                                        FROM        (Expedients_Hirings eh, Expedients e, Products_Prices pp, Products pr, IVA_Types it, Products_Models pm)
                                        LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                        WHERE       eh.expedient = " . $expedientID . " AND 
                                                    eh.num_hiring = $numHiringOriginal AND
                                                    eh.check = 1 AND 
                                                    eh.expedient = e.expedientID AND
                                                    pp.price = e.priceExp AND
                                                    eh.model = pm.productModelID AND
                                                    eh.product = pr.productID AND
                                                    pr.IVA = it.IVATypeID AND
                                                    pr.leavingDate IS NULL AND
                                                    pr.supplied = 0 AND 
                                                    pr.isInvoiced = 0 AND
                                                    pp.model = pm.productModelID
                                        ORDER BY    pr.blockBelow, pr.orderBy, pr.productID, eh.ID
                ");
                                        
                if(mysqli_num_rows($result2) > 0){
                    $result2 = $db->resultToArray($result2);
                    $i = 0;
                    foreach($result2 as $key => $value){
                        $texts =  $db->query("  SELECT      REPLACE(et.value, '\\\', '') as value
                                                FROM        Expedients_Texts et
                                                WHERE       et.hiring = {$value['hiringID']}
                                                ORDER BY    et.rowIndex DESC");
                                            
                        if(mysqli_num_rows($texts) > 0){
                            $result2[$i]['texts'] = $db->resultToArray($texts);
                        }else{
                            $result2[$i]['texts'] = '';
                        }
                        $i++;
                    }
                    $result['facturaRectificada'] = $result2;
                }else{
                    $result['facturaRectificada'] = array();
                }

            }else{
                $result['facturaRectificada'] = array();
            }
           
            //Contratación suplidos
            $result2 = $db->query(" SELECT      eh.ID as hiringID, eh.amount, eh.discount,
                                                pr.productID as productID, pr.name as productName, pr.supplied, pr.texts, pr.editPrice,
                                                pm.productModelID as modelID, pm.name as modelName,
                                                it.percentage,
                                                et.discount as multipleDiscount,
                                                eh.total as cost,
                                                eh.old_hiring
                                    FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                    LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                    WHERE       eh.expedient = " . $expedientID . " AND 
                                                eh.check = 1 AND 
                                                eh.expedient = e.expedientID AND
                                                eh.model = pm.productModelID AND
                                                eh.product = pr.productID AND
                                                pr.IVA = it.IVATypeID AND
                                                pr.leavingDate IS NULL AND
                                                pr.supplied = 1 AND
                                                pr.isInvoiced = 0 AND
                                                eh.num_hiring = $numHiring
                                    ORDER BY    pr.blockBelow, pr.orderBy, pr.name, eh.ID
            ");

            if(mysqli_num_rows($result2) > 0){
                $result2 = $db->resultToArray($result2);
                $i = 0;
                foreach($result2 as $key => $value){
                    $texts =  $db->query("  SELECT  REPLACE(et.value, '\\\', '') as value
                                            FROM    Expedients_Texts et
                                            WHERE   et.hiring = {$value['hiringID']}");
                                        
                    if(mysqli_num_rows($texts) > 0){
                        $result2[$i]['texts'] = $db->resultToArray($texts);
                    }else{
                        $result2[$i]['texts'] = '';
                    }
                    $i++;
                }
                $result['suplidos'] = $result2;
            }

            if(!isset($result['suplidos']) || $result['suplidos'] == null){
                $result['suplidos'] = array();
            }

            // Suplidos original - cuando la factura a procesar es rectitificada por diferencias
            if($rectifiedTypeParam == 2 || $result['rectified_type'] == '2'){

                $searchHiringToRectified = $db->query("  SELECT  MAX(i.num_hiring) as num_hiring
                                        FROM    Invoices i
                                        WHERE   i.expedient = $expedientID AND
                                                i.leavingDate IS NULL AND
                                                i.num_hiring < $numHiring AND
                                                i.invoice_type != 3
                ");

                if(mysqli_num_rows($searchHiringToRectified) > 0){
                    $numHiringOriginal = $db->resultToArray($searchHiringToRectified)[0]['num_hiring'];
                }else{
                    $numHiringOriginal = 0;
                }

                //Contratación suplidos
                $result2 = $db->query(" SELECT      eh.ID as hiringID, eh.amount, eh.discount,
                                                    pr.productID as productID, pr.name as productName, pr.supplied, pr.texts, pr.editPrice,
                                                    pm.productModelID as modelID, pm.name as modelName,
                                                    it.percentage,
                                                    et.discount as multipleDiscount,
                                                    eh.total as cost
                                        FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                        LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                        WHERE       eh.expedient = " . $expedientID . " AND 
                                                    eh.num_hiring = $numHiringOriginal AND
                                                    eh.check = 1 AND 
                                                    eh.expedient = e.expedientID AND
                                                    eh.model = pm.productModelID AND
                                                    eh.product = pr.productID AND
                                                    pr.IVA = it.IVATypeID AND
                                                    pr.leavingDate IS NULL AND
                                                    pr.supplied = 1 AND
                                                    pr.isInvoiced = 0
                                        ORDER BY    pr.blockBelow, pr.orderBy, pr.name, eh.ID
                ");

                if(mysqli_num_rows($result2) > 0){
                    $result2 = $db->resultToArray($result2);
                    $i = 0;
                    foreach($result2 as $key => $value){
                        $texts =  $db->query("  SELECT      REPLACE(et.value, '\\\', '') as value
                                                FROM        Expedients_Texts et
                                                WHERE       et.hiring = {$value['hiringID']}
                                                ORDER BY    et.rowIndex DESC");
                                            
                        if(mysqli_num_rows($texts) > 0){
                            $result2[$i]['texts'] = $db->resultToArray($texts);
                        }else{
                            $result2[$i]['texts'] = '';
                        }
                        $i++;
                    }
                    $result['suplidosRectificada'] = $result2;
                }else{
                    $result['suplidosRectificada'] = array();
                }
            }else{
                $result['suplidosRectificada'] = array();
            }

            // Expediente asociado
            $result2 = $db->query(" SELECT  e.number
                                    FROM    Expedients e, Expedients_Associates ea
                                    WHERE   e.expedientID = ea.associate AND
                                            ea.leavingDate IS NULL AND
                                            ea.expedientID = " . $expedientID);
            
            if(mysqli_num_rows($result2) > 0){
                $result2 = $db->resultToArray($result2);
                $result['associates'] = $result2;
            }

            //Obtener información de la factura
            require_once($_SESSION['basePath'] . "model/invoices.php");
            $invoices = new Invoices;
            $result['invoiceInfo'] = $invoices->getInvoiceInfoEconomic($expedientID, $result['facturaID']);
            
            return $result;
        }

        /**
         * Obtiene los datos para el pdf factura proforma
         * 
         * @param int $invoiceProformaID Invoice proforma id
         * 
         * @return array
         */
        public function getFacturaProforma($invoiceProformaID){
            $db = new DbHandler;

            $invoiceProformaID = cleanStr($invoiceProformaID);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedSurname, e.number, e.policy, e.lossNumber, e.deceasedGender, e.deceasedDate,
                                                e.familyContactName, e.familyContactSurname, e.familyContactNIF, e.familyContactRelationship, e.tpv, e.clientType,
                                                m.name AS mortuary, m.isYourOwn,
                                                c.name AS clientName, c.surname AS clientSurname, c.clientID AS clientID, c.type as clientType, c.address, c.nif, l.name as locationName, l.postalCode, l.province,
                                                invpr.expedient,
                                                invpr.id as facturaID, 
                                                '' as comments, 
                                                '' as accountNumber, 
                                                '' as paymentMethod, 
                                                invpr.numInvoice as generatedInvoiceNumber, 
                                                invpr.creationDate, 
                                                (
                                                    SELECT   eh.rectified_type
                                                    FROM     Expedients_Hirings eh
                                                    WHERE    eh.expedient = e.expedientID AND 
                                                             eh.num_hiring = (
                                                                SELECT  MAX(eh2.num_hiring)
                                                                FROM    Expedients_Hirings eh2
                                                                WHERE   eh2.expedient = e.expedientID
                                                            )
                                                    LIMIT   1
                                                ) as rectified_type
                                    FROM        (Invoices_Proforma invpr)
                                    LEFT JOIN   Expedients e ON invpr.expedient = e.expedientID
                                    LEFT JOIN   Mortuaries m ON m.mortuaryID = e.deceasedMortuary
                                    LEFT JOIN   Clients c ON c.clientID = e.client
                                    LEFT JOIN   Locations l ON l.locationID = c.location
                                    WHERE       invpr.id = " . $invoiceProformaID . "");

            $result = $db->resultToArray($result)[0];

            $expedientID = $result["expedient"];

            $numHiring = $this->getActiveHiring($expedientID);
           
            //Obtener el id de la tarifa de particulares para el año de solicitud del expediente
            $particularPrice = $db->query(" SELECT  p.priceID
                                            FROM    Prices p, Expedients e 
                                            WHERE   p.name = 'Particulares' 
                                                    AND p.leavingDate IS NULL
                                                    AND p.year = YEAR(e.requestDate) 
                                                    AND e.expedientID = ".$expedientID."
            ");

            if(mysqli_num_rows($particularPrice) > 0){
                $particularPrice = $db->resultToArray($particularPrice)[0]['priceID'];

                $result2 = $db->query(" SELECT      eh.ID as hiringID, eh.amount, eh.discount, eh.total as totalEditPrice,
                                                    pr.productID as productID, pr.name as productName, pr.supplied, pr.texts, pr.editPrice,
                                                    pm.productModelID as modelID, pm.name as modelName,
                                                    pp.priceNoIVA, it.percentage, e.clientType,
                                                    (
                                                        SELECT pp2.priceNoIVA
                                                        FROM   Products_Prices pp2
                                                        WHERE  pp2.price = $particularPrice AND pp2.model = pm.productModelID
                                                    ) as particularPrice,
                                                    et.discount as multipleDiscount,
                                                    eh.old_hiring
                                        FROM        (Expedients_Hirings eh, Expedients e, Products_Prices pp, Products pr, IVA_Types it, Products_Models pm)
                                        LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                        WHERE       eh.expedient = " . $expedientID . " AND 
                                                    eh.check = 1 AND 
                                                    eh.expedient = e.expedientID AND
                                                    pp.price = eh.priceExp AND
                                                    eh.model = pm.productModelID AND
                                                    eh.product = pr.productID AND
                                                    pr.IVA = it.IVATypeID AND
                                                    pr.leavingDate IS NULL AND
                                                    pr.supplied = 0 AND 
                                                    pr.isInvoiced = 0 AND
                                                    pp.model = pm.productModelID AND
                                                    eh.num_hiring = $numHiring
                                        ORDER BY    pr.blockBelow, pr.orderBy, pr.productID, eh.ID
                ");
                                        
                if(mysqli_num_rows($result2) > 0){
                    $result2 = $db->resultToArray($result2);
                    $i = 0;
                    foreach($result2 as $key => $value){
                        $texts =  $db->query("  SELECT  REPLACE(et.value, '\\\', '') as value
                                                FROM    Expedients_Texts et
                                                WHERE   et.hiring = {$value['hiringID']}"
                        );
                                            
                        if(mysqli_num_rows($texts) > 0){
                            $result2[$i]['texts'] = $db->resultToArray($texts);
                        }else{
                            $result2[$i]['texts'] = '';
                        }
                        $i++;
                    }
                    $result['factura'] = $result2;
                }
            }else{
                $result['factura'] = array();
            }

            if(!isset($result['factura']) || $result['factura'] == null){
                $result['factura'] = array();
            }

            // Contratacion original - cuando la factura a procesar es rectitificada por diferencias
            if($result['rectified_type'] == '2'){

                $searchHiringToRectified = $db->query(" SELECT  MAX(i.num_hiring) as num_hiring
                                                        FROM    Invoices i
                                                        WHERE   i.expedient = $expedientID AND
                                                                i.leavingDate IS NULL AND
                                                                i.num_hiring < $numHiring AND
                                                                i.invoice_type != 3
                ");

                if(mysqli_num_rows($searchHiringToRectified) > 0){
                    $numHiringOriginal = $db->resultToArray($searchHiringToRectified)[0]['num_hiring'];
                }else{
                    $numHiringOriginal = 0;
                }

                $result2 = $db->query(" SELECT      eh.ID as hiringID, eh.amount, eh.discount, eh.total as totalEditPrice,
                                                    pr.productID as productID, pr.name as productName, pr.supplied, pr.texts, pr.editPrice,
                                                    pm.productModelID as modelID, pm.name as modelName,
                                                    pp.priceNoIVA, it.percentage, e.clientType,
                                                    (
                                                        SELECT pp2.priceNoIVA
                                                        FROM   Products_Prices pp2
                                                        WHERE  pp2.price = $particularPrice AND pp2.model = pm.productModelID
                                                    ) as particularPrice,
                                                    et.discount as multipleDiscount
                                        FROM        (Expedients_Hirings eh, Expedients e, Products_Prices pp, Products pr, IVA_Types it, Products_Models pm)
                                        LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                        WHERE       eh.expedient = " . $expedientID . " AND 
                                                    eh.num_hiring = $numHiringOriginal AND
                                                    eh.check = 1 AND 
                                                    eh.expedient = e.expedientID AND
                                                    pp.price = e.priceExp AND
                                                    eh.model = pm.productModelID AND
                                                    eh.product = pr.productID AND
                                                    pr.IVA = it.IVATypeID AND
                                                    pr.leavingDate IS NULL AND
                                                    pr.supplied = 0 AND 
                                                    pr.isInvoiced = 0 AND
                                                    pp.model = pm.productModelID
                                        ORDER BY    pr.blockBelow, pr.orderBy, pr.productID, eh.ID
                ");
                                        
                if(mysqli_num_rows($result2) > 0){
                    $result2 = $db->resultToArray($result2);
                    $i = 0;
                    foreach($result2 as $key => $value){
                        $texts =  $db->query("  SELECT      REPLACE(et.value, '\\\', '') as value
                                                FROM        Expedients_Texts et
                                                WHERE       et.hiring = {$value['hiringID']}
                                                ORDER BY    et.rowIndex DESC");
                                            
                        if(mysqli_num_rows($texts) > 0){
                            $result2[$i]['texts'] = $db->resultToArray($texts);
                        }else{
                            $result2[$i]['texts'] = '';
                        }
                        $i++;
                    }
                    $result['facturaRectificada'] = $result2;
                }else{
                    $result['facturaRectificada'] = array();
                }

            }else{
                $result['facturaRectificada'] = array();
            }
           
            //Contratación suplidos
            $result2 = $db->query(" SELECT      eh.ID as hiringID, eh.amount, eh.discount,
                                                pr.productID as productID, pr.name as productName, pr.supplied, pr.texts, pr.editPrice,
                                                pm.productModelID as modelID, pm.name as modelName,
                                                it.percentage,
                                                et.discount as multipleDiscount,
                                                eh.total as cost,
                                                eh.old_hiring
                                    FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                    LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                    WHERE       eh.expedient = " . $expedientID . " AND 
                                                eh.check = 1 AND 
                                                eh.expedient = e.expedientID AND
                                                eh.model = pm.productModelID AND
                                                eh.product = pr.productID AND
                                                pr.IVA = it.IVATypeID AND
                                                pr.leavingDate IS NULL AND
                                                pr.supplied = 1 AND
                                                pr.isInvoiced = 0 AND
                                                eh.num_hiring = $numHiring
                                    ORDER BY    pr.blockBelow, pr.orderBy, pr.name, eh.ID
            ");

            if(mysqli_num_rows($result2) > 0){
                $result2 = $db->resultToArray($result2);
                $i = 0;
                foreach($result2 as $key => $value){
                    $texts =  $db->query("  SELECT  REPLACE(et.value, '\\\', '') as value
                                            FROM    Expedients_Texts et
                                            WHERE   et.hiring = {$value['hiringID']}");
                                        
                    if(mysqli_num_rows($texts) > 0){
                        $result2[$i]['texts'] = $db->resultToArray($texts);
                    }else{
                        $result2[$i]['texts'] = '';
                    }
                    $i++;
                }
                $result['suplidos'] = $result2;
            }

            if(!isset($result['suplidos']) || $result['suplidos'] == null){
                $result['suplidos'] = array();
            }

            // Suplidos original - cuando la factura a procesar es rectitificada por diferencias
            if($result['rectified_type'] == '2'){

                $searchHiringToRectified = $db->query("  SELECT  MAX(i.num_hiring) as num_hiring
                                                        FROM    Invoices i
                                                        WHERE   i.expedient = $expedientID AND
                                                                i.leavingDate IS NULL AND
                                                                i.num_hiring < $numHiring AND
                                                                i.invoice_type != 3
                ");

                if(mysqli_num_rows($searchHiringToRectified) > 0){
                    $numHiringOriginal = $db->resultToArray($searchHiringToRectified)[0]['num_hiring'];
                }else{
                    $numHiringOriginal = 0;
                }

                //Contratación suplidos
                $result2 = $db->query(" SELECT      eh.ID as hiringID, eh.amount, eh.discount,
                                                    pr.productID as productID, pr.name as productName, pr.supplied, pr.texts, pr.editPrice,
                                                    pm.productModelID as modelID, pm.name as modelName,
                                                    it.percentage,
                                                    et.discount as multipleDiscount,
                                                    eh.total as cost
                                        FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                        LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                        WHERE       eh.expedient = " . $expedientID . " AND 
                                                    eh.num_hiring = $numHiringOriginal AND
                                                    eh.check = 1 AND 
                                                    eh.expedient = e.expedientID AND
                                                    eh.model = pm.productModelID AND
                                                    eh.product = pr.productID AND
                                                    pr.IVA = it.IVATypeID AND
                                                    pr.leavingDate IS NULL AND
                                                    pr.supplied = 1 AND
                                                    pr.isInvoiced = 0
                                        ORDER BY    pr.blockBelow, pr.orderBy, pr.name, eh.ID
                ");

                if(mysqli_num_rows($result2) > 0){
                    $result2 = $db->resultToArray($result2);
                    $i = 0;
                    foreach($result2 as $key => $value){
                        $texts =  $db->query("  SELECT      REPLACE(et.value, '\\\', '') as value
                                                FROM        Expedients_Texts et
                                                WHERE       et.hiring = {$value['hiringID']}
                                                ORDER BY    et.rowIndex DESC");
                                            
                        if(mysqli_num_rows($texts) > 0){
                            $result2[$i]['texts'] = $db->resultToArray($texts);
                        }else{
                            $result2[$i]['texts'] = '';
                        }
                        $i++;
                    }
                    $result['suplidosRectificada'] = $result2;
                }else{
                    $result['suplidosRectificada'] = array();
                }
            }else{
                $result['suplidosRectificada'] = array();
            }

            // Expediente asociado
            $result2 = $db->query(" SELECT  e.number
                                    FROM    Expedients e, Expedients_Associates ea
                                    WHERE   e.expedientID = ea.associate AND
                                            ea.leavingDate IS NULL AND
                                            ea.expedientID = " . $expedientID);
            
            if(mysqli_num_rows($result2) > 0){
                $result2 = $db->resultToArray($result2);
                $result['associates'] = $result2;
            }

            //Obtener información de la factura
            require_once($_SESSION['basePath'] . "model/invoicesProforma.php");
            $invoicesProforma = new InvoicesProforma;
            $result['invoiceInfo'] = $invoicesProforma->getInvoiceInfoEconomic($expedientID, $result['facturaID']);

            return $result;
        }

        /**
         * Obtiene los datos para el pdf factura
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getPresupuesto($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedSurname, e.number, e.policy, e.lossNumber, e.clientType, e.deceasedGender,
                                                m.name AS mortuary, m.isYourOwn,
                                                c.name AS clientName, c.surname AS clientSurname, c.clientID AS clientID, c.address, c.nif, l.name as locationName, l.postalCode, l.province,
                                                b.numBudget, b.expedient 
                                    FROM        (Budgets b)
                                    LEFT JOIN   Expedients e ON b.expedient = e.expedientID
                                    LEFT JOIN   Mortuaries m ON m.mortuaryID = e.deceasedMortuary
                                    LEFT JOIN   Clients c ON c.clientID = e.client
                                    LEFT JOIN   Locations l ON l.locationID = c.location
                                    WHERE       b.ID = " . $data . "");

            $result = $db->resultToArray($result)[0];

            $data = $result["expedient"];

            $maxNumHiring = $this->getActiveHiring($data);
           
            //Obtener el id de la tarifa de particulares para el año de solicitud del expediente
            $particularPrice = $db->query(" SELECT  p.priceID
                                            FROM    Prices p, Expedients e 
                                            WHERE   p.name = 'Particulares' AND
                                                    p.leavingDate IS NULL AND
                                                    p.year = YEAR(e.requestDate) AND
                                                    e.expedientID = ".$data."");

            $particularPrice = $db->resultToArray($particularPrice)[0]['priceID'];

            $result2 = $db->query(" SELECT      eh.ID as hiringID, eh.amount, eh.discount, eh.total as totalEditPrice, eh.expedient, 
                                                pr.productID as productID, pr.name as productName, pr.supplied, pr.texts,
                                                pm.productModelID as modelID, pm.name as modelName, pr.editPrice,
                                                pp.priceNoIVA,
                                                it.percentage,
                                                (
                                                    SELECT pp2.priceNoIVA
                                                    FROM   Products_Prices pp2
                                                    WHERE  pp2.price = $particularPrice AND pp2.model = pm.productModelID
                                                ) as particularPrice,
                                                et.discount as multipleDiscount
                                    FROM        (Expedients_Hirings eh, Expedients e, Products_Prices pp, Products pr, IVA_Types it, Products_Models pm)
                                    LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                    WHERE       eh.expedient = " . $data . " AND 
                                                eh.check = 1 AND 
                                                eh.expedient = e.expedientID AND
                                                eh.priceExp = pp.price AND
                                                eh.model = pm.productModelID AND
                                                eh.product = pr.productID AND
                                                pr.IVA = it.IVATypeID AND
                                                pr.leavingDate IS NULL AND
                                                pr.supplied = 0 AND 
                                                pr.isInvoiced = 0 AND
                                                pp.model = pm.productModelID AND
                                                eh.num_hiring = $maxNumHiring
                                    ORDER BY    pr.blockBelow, pr.orderBy, pr.name, eh.ID");

            if(mysqli_num_rows($result2) > 0){
                $result2 = $db->resultToArray($result2);
                $i = 0;
                foreach($result2 as $key => $value){
                    $texts =  $db->query("  SELECT  REPLACE(et.value, '\\\', '') as value
                                            FROM    Expedients_Texts et
                                            WHERE   et.value != '' AND 
                                                    et.hiring = {$value['hiringID']}");
                                        
                    if(mysqli_num_rows($texts) > 0){
                        $result2[$i]['texts'] = $db->resultToArray($texts);
                    }else{
                        $result2[$i]['texts'] = '';
                    }
                    $i++;
                }
                $result['factura'] = $result2;
            }

            //Contratación suplidos
            $result2 = $db->query(" SELECT      eh.ID as hiringID, eh.amount, eh.discount,
                                                pr.productID as productID, pr.name as productName, pr.supplied, pr.texts, pr.editPrice,
                                                pm.productModelID as modelID, pm.name as modelName,
                                                it.percentage,
                                                et.discount as multipleDiscount,
                                                eh.total as cost
                                    FROM        (Expedients_Hirings eh, Expedients e, Products pr, IVA_Types it, Products_Models pm)
                                    LEFT JOIN   Expedients_Texts et ON et.hiring = eh.ID
                                    WHERE       eh.expedient = " . $data . " AND 
                                                eh.check = 1 AND 
                                                eh.expedient = e.expedientID AND
                                                eh.model = pm.productModelID AND
                                                eh.product = pr.productID AND
                                                pr.IVA = it.IVATypeID AND
                                                pr.leavingDate IS NULL AND
                                                pr.supplied = 1 AND
                                                pr.isInvoiced = 0 AND
                                                eh.num_hiring = $maxNumHiring
                                    ORDER BY    pr.blockBelow, pr.orderBy, pr.name, eh.ID
            ");

            if(mysqli_num_rows($result2) > 0){
                $result2 = $db->resultToArray($result2);
                $i = 0;
                foreach($result2 as $key => $value){
                    $texts =  $db->query("  SELECT  REPLACE(et.value, '\\\', '') as value
                                            FROM    Expedients_Texts et
                                            WHERE   et.value != '' AND 
                                                    et.hiring = {$value['hiringID']}");
                                        
                    if(mysqli_num_rows($texts) > 0){
                        $result2[$i]['texts'] = $db->resultToArray($texts);
                    }else{
                        $result2[$i]['texts'] = '';
                    }
                    $i++;
                }
                $result['suplidos'] = $result2;
            }

            $result2 = $db->query(" SELECT  e.number
                                    FROM    Expedients e, Expedients_Associates ea
                                    WHERE   e.expedientID = ea.associate AND 
                                            ea.leavingDate IS NULL AND 
                                            ea.expedientID = " . $data);
            
            if(mysqli_num_rows($result2) > 0){
                $result2 = $db->resultToArray($result2);
                $result['associates'] = $result2;
            }

            return $result;
        }

        /**
         * Obtiene los datos para las facturas recibidas
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getFacturaRecivida($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            $result = $db->query("  SELECT      ri.*,
                                                ba.owner as bankAccountOwner,
                                                cc.owner as creditCardOwner,
                                                ef.name as expenseFixedName,
                                                ev.name as expenseVariableName,
                                                ccc.name as costCenterName,
                                                s.name as supplierName, s.nif as supplierNif
                                    FROM        (Received_Invoices ri)
                                    LEFT JOIN   Bank_Accounts ba ON ri.bankAccount = ba.ID
                                    LEFT JOIN   Credit_Cards cc ON ri.creditCard = cc.ID
                                    LEFT JOIN   Expenses_Fixed ef ON ri.expenseFixed = ef.ID
                                    LEFT JOIN   Expenses_Variable ev ON ri.expenseVariable = ev.ID
                                    LEFT JOIN   Cost_Center ccc ON ri.costCenter = ccc.ID
                                    LEFT JOIN   Suppliers s ON ri.supplier = s.supplierID
                                    WHERE       ri.ID = $id");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0];
        }

        /**
         * Obtiene los ivas de una factura recibida
         * 
         * @param int $id ID de la factura
         * @return array Datos de la factura
         */
        public function getReceivedInvoiceIvas($id){
            $db = new DbHandler;

            $id = cleanStr($id);

            $result = $db->query("  SELECT      riv.*
                                    FROM        Received_Invoices_Ivas riv
                                    WHERE       riv.received_invoice = $id AND
                                                riv.deleteDate IS NULL
            ");
            return mysqli_num_rows($result) == 0 ? [] : $db->resultToArray($result);
        }

        /**
         * Obtiene los datos para el pdf exhumación judicial
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getFacturado($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $maxNumHiring = $this->getActiveHiring($data);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedSurname, e.number,
                                                m.name AS mortuary,
                                                c.name AS clientName, c.surname AS clientSurname, c.clientID AS clientID,
                                                i.comments, i.accountNumber, i.paymentMethod
                                    FROM        (Expedients e)
                                    LEFT JOIN   Mortuaries m ON m.mortuaryID = e.deceasedMortuary
                                    LEFT JOIN   Invoices i ON i.leavingDate IS NULL AND i.expedient = e.expedientID AND i.num_hiring = $maxNumHiring
                                    LEFT JOIN   Clients c ON c.clientID = e.client
                                    WHERE       expedientID = " . $data . " 
            ");

            $result = $db->resultToArray($result)[0];

            $result2 = $db->query(" SELECT      eh.amount, eh.discount, pp.priceNoIVA * eh.amount as subTotalNoIVA,
                                                (pp.priceNoIVA * it.percentage / 100) + pp.priceNoIVA as priceIVA,
                                                pr.name as product, it.percentage as IVA, pr.supplied,
                                                (pp.priceNoIVA * it.percentage / 100 + pp.priceNoIVA) * eh.amount as subTotal,
                                                (pp.priceNoIVA * it.percentage / 100 + pp.priceNoIVA) * eh.amount - ((pp.priceNoIVA * it.percentage / 100 + pp.priceNoIVA) * eh.discount / 100) * eh.amount as total,
                                                pm.name as productModelName
                                    FROM        Expedients_Hirings eh, Expedients e, Products_Prices pp, Products pr, IVA_Types it, Clients c, Products_Models pm
                                    WHERE       eh.expedient = " . $data . " AND 
                                                eh.check = 1 AND 
                                                eh.expedient = e.expedientID AND
                                                e.client = c.clientID AND
                                                c.price = pp.price AND
                                                eh.model = pm.productModelID AND
                                                eh.product = pr.productID AND
                                                pr.IVA = it.IVATypeID AND
                                                pr.leavingDate IS NULL AND 
                                                pr.isInvoiced = 0 AND
                                                pp.model = pm.productModelID AND
                                                eh.num_hiring = $maxNumHiring
                                    ORDER BY    pr.productID, pm.productModelID
            ");

            $result2 = $db->resultToArray($result2);
            $result['factura'] = $result2;

            return $result;
        }        

        /**
         * Obtiene los datos para el pdf autorización incineración tanatorio boisaca
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getFirstExpedient(){
            $db = new DbHandler;

            $result = $db->query("  SELECT  MIN(e.entryDate) as minDate
                                    FROM    Expedients e
                                    WHERE   e.leavingDate IS NULL");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0]['minDate'] : null;
        }       

        /**
         * Actualzia el estado de un expediente de finalizado a facturado
         * 
         * @param int $data
         * 
         * @return array
         */
        public function reactiveExpedient($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            return $db->query(" UPDATE  Expedients 
                                SET     status = 4
                                WHERE   expedientID = $data");
        }        

        /**
         * Obtiene los datos para el pdf autorización incineración tanatorio boisaca
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getIncTanatorioBoisaca($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedSurname, e.deceasedDate, e.deceasedGender, e.deceasedLocation as expedientDL, e.otherDeceasedLocation,
                                                l.name AS deceasedLocation
                                    FROM        (Expedients e)
                                    LEFT JOIN   Locations l ON e.deceasedLocation = l.locationID
                                    WHERE       expedientID = " . $data . "");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }        

        /**
         * Obtiene los datos para el pdf autorización incineración vigo memorial
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getIncVigoMemorial($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.deceasedGender, e.deceasedName, e.deceasedSurname, e.deceasedRoom, e.crematoriumIntroduction, e.crematoriumArriveTime,
                                                e.familyContactName, e.familyContactSurname, ev.start, ev.end
                                    FROM        Expedients e
                                    LEFT JOIN   Events ev ON ev.expedient = e.expedientID
                                    WHERE       expedientID = " . $data . "");

            $result = $db->resultToArray($result)[0];

            $maxNumHiring = $this->getActiveHiring($data);

            $marcaPasos = $db->query("SELECT eh.ID FROM Expedients_Hirings eh WHERE eh.expedient = $data AND eh.product = 127 AND eh.num_hiring = $maxNumHiring");
            if(mysqli_num_rows($marcaPasos)){
                $result['marcaPasos'] = 1;
            }else{
                $result['marcaPasos'] = 0;
            }

            return count($result) > 0 ? $result : null;            
        }        

        /**
         * Obtiene los datos para el pdf justificante sepelio
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getJustificanteSepelio($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedSurname, e.deceasedGender, e.funeralHomeEntryDate, e.funeralDate, e.funeralTime,
                                                l.name as mortuaryLocation, m.name as mortuary
                                    FROM        Expedients e
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   Locations l ON m.location = l.locationID
                                    WHERE       expedientID = " . $data . "");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el libro de visitas
         *
         * @param array $data ID del expediente
         * @return array
         */
        public function getLapidaProvisional($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT  deceasedName, deceasedSurname, deceasedBirthday, deceasedDate
                                    FROM    Expedients
                                    WHERE   expedientID = $data");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;   
        }

        /**
         * Obtiene los datos para el pdf libro de visitas
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getLibroCrematorio($data){
            $data['start'] = cleanStr($data['start']);
            $data['end'] = cleanStr($data['end']);
            $data['crematorium'] = cleanStr($data['crematorium']);

            $start = $data['start'];
            $end = $data['end'];

            $utils = new Utils;
            
            $start = $utils->dateConvert($start);
            $start = strtotime($start);
            
            $end = $utils->dateConvert($end);
            $end = strtotime($end);

            $db = new DbHandler;

            if(intval($_SESSION['company'] == 2)){

                $result = $db->query("  SELECT      e.expedientID, cr.name AS crematoriumName
                                        FROM        Expedients e
                                        LEFT JOIN   Crematoriums cr ON cr.crematoriumID = e.crematorium
                                        WHERE       UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) >= $start AND
                                                    UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) <= $end AND
                                                    e.crematorium = " . $data['crematorium'] . " AND
                                                    e.leavingDate IS NULL AND e.type = 1 AND e.crematoriumReg = 1");
            }else{

                $result = $db->query("  SELECT      e.expedientID, cr.name AS crematoriumName
                                        FROM        Expedients e
                                        LEFT JOIN   Crematoriums cr ON cr.crematoriumID = e.crematorium
                                        WHERE       UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) >= $start AND
                                                    UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) <= $end AND
                                                    e.crematorium = " . $data['crematorium'] . " AND
                                                    e.leavingDate IS NULL AND e.type != 2 AND e.crematoriumReg = 1");
            }

            $expedientsIDs = $db->resultToArray($result);

            $expedients = $db->query("  SELECT  e.expedientID, e.number, e.deceasedName, e.deceasedSurname, e.deceasedDate, e.deceasedTime, e.funeralDate, ev.start, e.coffin,
                                                e.moveClient, e.crematorium, e.deceasedBirthdayLocation, 
                                                fh.name AS transport,
                                                l.name AS birthdayLocation,
                                                CONCAT(s.name, ' ', s.surname) AS crematoriumTechnical
                                    FROM        (Expedients e, Events ev, Expedients_Services es)                                    
                                    LEFT JOIN   FuneralHomes fh ON es.funeralHomeService = fh.funeralHomeID
                                    LEFT JOIN   Staff s ON e.crematoriumTechnical = s.ID
                                    LEFT JOIN   Locations l ON e.deceasedBirthdayLocation = l.locationID
                                    WHERE       e.expedientID = ev.expedient AND
                                                UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) >= $start AND
                                                UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) <= $end AND 
                                                e.crematorium = " . $data['crematorium'] . " AND
                                                e.leavingDate IS NULL AND e.type != 2 AND
                                                es.expedient = e.expedientID AND e.crematoriumReg = 1");

            if(mysqli_num_rows($expedients) > 0){
                $expedients = $db->resultToArray($expedients);

                $position = 0;
                $page = 0;
                $crematoriumName = '';
                foreach($expedientsIDs as $key => $ID){
                    if($ID["expedientID"] == $expedients[0]["expedientID"]){
                        $position = $key;
                    }

                    if($crematoriumName == '' && $ID['crematoriumName'] != null && $ID['crematoriumName'] != ''){
                        $crematoriumName = $ID['crematoriumName'];
                    }
                }

                $expedients['page'] = intval($position / 4) + 1;
                $expedients['position'] = ($position % 4) + 1;
                $expedients['crematoriumName'] = $crematoriumName;

                return $expedients;
            }else{
                return null;

            }
        }
        
        /**
         * Obtiene los datos del libro
         * 
         * @param array $data
         * 
         * @return array
         */
        public function getLibroFuneraria($data){
            $data['start'] = cleanStr($data['start']);
            $data['end'] = cleanStr($data['end']);

            $start = $data['start'];
            $end = $data['end'];

            $utils = new Utils;
            
            $start = $utils->dateConvert($start);
            $start = strtotime($start);
            
            $end = $utils->dateConvert($end);
            $end = strtotime($end);

            $db = new DbHandler;

            if(intval($_SESSION['company'] == 2)){
                $result = $db->query("  SELECT  e.expedientID
                                        FROM    Expedients e
                                        WHERE   UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) >= $start AND
                                                UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) <= $end AND
                                                e.leavingDate IS NULL AND e.type = 1 AND e.mortuaryReg = 1");
            }else{
                $result = $db->query("  SELECT  e.expedientID
                                        FROM    Expedients e
                                        WHERE   UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) >= $start AND
                                                UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) <= $end AND
                                                e.leavingDate IS NULL AND e.type != 2 AND e.mortuaryReg = 1");
            }

            $expedientsIDs = $db->resultToArray($result);

            $result = $db->query("  SELECT      e.expedientID, e.funeralDate, e.funeralDateNew, e.deceasedName, e.deceasedSurname, e.number, e.requestDate, 
                                                e.coffin, e.otherCoffin, e.requestDate, e.placeDestinationMiddle, e.placeDestinationFinal, e.placeDestinationFinalCemetery,
                                                e.deceasedDate, e.funeralHomeEntryDate, e.funeralDate,
                                                di.name as deceasedSourceName,
                                                l1.name as deceasedLocationName,
                                                e.deceasedLocation as expedientDL,
                                                e.otherDeceasedLocation,
                                                es.carCollection, ca.brand, ca.model as carModel, ca.licensePlate,
                                                e.carCollection1LicensePlate, e.carCollection1Brand, e.carCollection1Model,
                                                dpm.name as placeDestinationMiddleName, l2.name as placeDestinationMiddleLocation,
                                                ca2.brand as brandHearse, ca2.model as carModelHearse, ca2.licensePlate as licensePlateHearse,
                                                e.hearse, e.hearseLicensePlate as hearseLicensePlateOther, e.hearseBrand as hearseBrandOther, e.hearseModel as hearseModelOther,
                                                dpf.name as placeDestinationFinalName, l3.name as placeDestinationFinalLocation,
                                                c.name as placeDestinationFinalCemeteryName, l4.name as placeDestinationFinalCemeteryLocation,
                                                e.mortuaryRegNotes
                                    FROM        (Expedients e)
                                    LEFT JOIN   DeceasedIn di ON di.deceasedInID = e.deceasedLocation
                                    LEFT JOIN   Locations l1 ON l1.locationID = di.location
                                    LEFT JOIN   Expedients_Services es ON es.expedient = e.expedientID
                                    LEFT JOIN   Cars ca ON ca.ID = es.carCollection
                                    LEFT JOIN   Destination_Places_Middles dpm ON dpm.ID = e.placeDestinationMiddle
                                    LEFT JOIN   Locations l2 ON l2.locationID = dpm.location
                                    LEFT JOIN   Cars ca2 ON ca2.ID = e.hearse
                                    LEFT JOIN   Destination_Places_Finals dpf ON dpf.ID = e.placeDestinationFinal
                                    LEFT JOIN   Locations l3 ON l3.locationID = dpf.location
                                    LEFT JOIN   Cemeteries c ON c.cemeteryID = e.placeDestinationFinalCemetery
                                    LEFT JOIN   Locations l4 ON l4.locationID = c.location
                                    WHERE       UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) >= $start AND
                                                UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) <= $end AND 
                                                e.leavingDate IS NULL AND e.type != 2 AND e.mortuaryReg = 1");

            if(mysqli_num_rows($result) > 0){
                $expedients = $db->resultToArray($result);

                $position = 0;
                foreach($expedientsIDs as $key => $ID){
                    if($ID["expedientID"] == $expedients[0]["expedientID"]){
                        $position = $key;
                    }

                    $expedients['page'] = intval($position/3) + 1;
                    $expedients['position'] = ($position % 3) + 1;
                }
            }

            return isset($expedients) && count($expedients) > 0 ? $expedients : null;
        }

        /**
         * Obtiene los datos del libro
         * 
         * @param array $data
         * 
         * @return array
         */
        public function getLibroPersonal($data){
            $data['start'] = cleanStr($data['start']);
            $data['end'] = cleanStr($data['end']);

            $start = $data['start'];
            $end = $data['end'];

            $utils = new Utils;
            
            $start = $utils->dateConvert($start);
            $start = strtotime($start);
            
            $end = $utils->dateConvert($end);
            $end = strtotime($end);

            $db = new DbHandler;
            
            $result = $db->query("  SELECT  e.expedientID
                                    FROM    Expedients e
                                    WHERE   YEAR(e.requestDate) = " . date("Y", $start) . " AND
                                            e.leavingDate IS NULL AND e.type != 2");

            if(mysqli_num_rows($result) > 0){
                $expedientsIDs = $db->resultToArray($result);
    
                $result2 = $db->query("  SELECT     e.expedientID, e.requestDate, e.requestTime, e.deceasedName, e.deceasedSurname, e.number, e.responsibleUser,
                                                    m.name as mortuaryName,
                                                    l.name as deceasedBirthdayLocation,
                                                    fh.name as funeralHome,
                                                    c.licensePlate as licenseCollection, c.brand as brandCollection, c.model as modelCollection,
                                                    s.name AS responsibleName, s.surname AS responsibleSurname, s.nif AS responsibleNIF
                                        FROM        (Expedients e)
                                        LEFT JOIN   Mortuaries m ON m.mortuaryID = e.deceasedMortuary
                                        LEFT JOIN   Locations l ON e.deceasedBirthdayLocation = l.locationID
                                        LEFT JOIN   FuneralHomes fh ON e.funeralHome = fh.funeralHomeID
                                        LEFT JOIN   Expedients_Services es ON es.expedient = e.expedientID
                                        LEFT JOIN   Cars c ON es.carCollection = c.ID
                                        LEFT JOIN   Staff s ON e.responsibleUser = s.ID
                                        WHERE       UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) >= $start AND
                                                    UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) <= $end AND 
                                                    e.leavingDate IS NULL AND e.type != 2 AND e.personalReg = 1");
    
                if(mysqli_num_rows($result2) > 0){

                    $expedients = $db->resultToArray($result2);
    
                    foreach($expedients as $key => $expedient){
                        $result = $db->query("  SELECT  c.licensePlate as carLicensePlate, c.brand as carBrand, c.model as carModel, sc.service, c.ID,
                                                        cr.name AS driverName, cr.surname AS driverSurname, cr.nif AS driverNIF
                                                FROM    Services_Cars sc, Cars c, Carriers cr
                                                WHERE   sc.car = c.ID AND c.type = 4 AND sc.service = " . $expedient['expedientID'] . " AND sc.driver = cr.carrierID
                                                LIMIT   1");
    
                        if(mysqli_num_rows($result) > 0){
                            $vehicles = $db->resultToArray($result)[0];
                            $expedients[$key]['vehicles'] = $vehicles;
                        }else{
                            $expedients[$key]['vehicles'] =[];
                        }
    
                        $carriers = $db->query("SELECT  c.name, c.surname, c.NIF
                                                FROM    Services_Carriers sc, Carriers c
                                                WHERE   sc.carrier = c.carrierID AND
                                                        sc.service = " . $expedient['expedientID'] . "");
                        
                        if(mysqli_num_rows($carriers) > 0){
                            $carriers = $db->resultToArray($carriers);
                            $expedients[$key]['carriers'] = $carriers;
                        }else{
                            $expedients[$key]['carriers'] = [];
                        }
    
                        $corpseCollection = $db->query("SELECT      s.name, s.surname, s.nif
                                                        FROM        Expedients_Services es
                                                        LEFT JOIN   Staff s ON s.ID = es.corpseCollection1 OR s.ID = es.corpseCollection2
                                                        WHERE       es.expedient = " . $expedient['expedientID'] . "");
    
                        if(mysqli_num_rows($corpseCollection) > 0){
                            $corpseCollection = $db->resultToArray($corpseCollection);
                            $expedients[$key]['corpseCollection'] = $corpseCollection;
                        }else{
                            $expedients[$key]['corpseCollection'] =[];
                        }
    
                        $familyAssistance = $db->query("SELECT      s.name, s.surname, s.nif
                                                        FROM        Expedients_Services es
                                                        LEFT JOIN   Staff s ON s.ID = es.familyAssistance
                                                        WHERE       es.expedient = " . $expedient['expedientID'] . "");
    
                        if(mysqli_num_rows($familyAssistance) > 0){
                            $familyAssistance = $db->resultToArray($familyAssistance);
                            $expedients[$key]['familyAssistance'] = $familyAssistance;
                        }else{
                            $expedients[$key]['familyAssistance'] =[];
                        }
                    }
    
                    $position = 0;
                    $page = 0;
                    foreach($expedientsIDs as $key => $ID){
                        if($ID["expedientID"] == $expedients[0]["expedientID"]){
                            $position = $key;
                        }
                    }
    
                    $expedients['page'] = intval($position / 2) + 1;
                    $expedients['position'] = ($position % 2) + 1;
                    
                }
                
                return isset($expedients) && count($expedients) > 0 ? $expedients : null;
            }else{
                return null;
            }
        }

        /**
         * Obtiene los datos para el pdf libro de visitas
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getLibroTanatorio($data){
            $data['start'] = cleanStr($data['start']);
            $data['end'] = cleanStr($data['end']);
            $data['mortuary'] = cleanStr($data['mortuary']);

            $start = $data['start'];
            $end = $data['end'];
            $mortuary = $data['mortuary'];

            $utils = new Utils;
            
            $start = $utils->dateConvert($start);
            $start = strtotime($start);
            
            $end = $utils->dateConvert($end);
            $end = strtotime($end);
            
            $db = new DbHandler;

            if(intval($_SESSION['company'] == 2)){
                $result = $db->query("  SELECT      e.expedientID, m.name as mortuaryName
                                        FROM        Expedients e
                                        LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                        WHERE       UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) >= $start AND
                                                    UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) <= $end AND
                                                    e.deceasedMortuary = " . $data['mortuary'] . " AND 
                                                    e.leavingDate IS NULL AND e.type = 1 AND e.funeralReg = 1");
            }else{
                $result = $db->query("  SELECT      e.expedientID, m.name as mortuaryName
                                        FROM        Expedients e
                                        LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                        WHERE       UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) >= $start AND
                                                    UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) <= $end AND
                                                    e.deceasedMortuary = " . $data['mortuary'] . " AND 
                                                    e.leavingDate IS NULL AND e.type != 2 AND e.funeralReg = 1");
            }

            $expedientsIDs = $db->resultToArray($result);

            $expedients = $db->query("  SELECT      e.expedientID, e.funeralDate, e.funeralTime, e.entryDate, e.deceasedName, e.deceasedSurname, e.number, e.moveClient, e.crematorium, e.cremation,
                                                    e.tanatologicalPractice, e.funeralHomeEntryDate, e.funeralHomeEntryTime, e.responsibleName,
                                                    fh.name AS transport,
                                                    CONCAT(s.name, ' ', s.surname) AS responsibleUser
                                        FROM        (Expedients e)                                    
                                        LEFT JOIN   FuneralHomes fh ON e.funeralHome = fh.funeralHomeID
                                        LEFT JOIN   Staff s ON e.responsibleUser = s.ID
                                        WHERE       UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) >= $start AND
                                                    UNIX_TIMESTAMP(STR_TO_DATE(e.requestDate, '%Y-%m-%d')) <= $end AND 
                                                    e.deceasedMortuary = " . $data['mortuary'] . " AND 
                                                    e.leavingDate IS NULL AND e.type != 2 AND e.funeralReg = 1");

            if(mysqli_num_rows($expedients) > 0){
                $expedients = $db->resultToArray($expedients);

                $position = 0;
                $page = 0;
                $mortuaryName = '';
                foreach($expedientsIDs as $key => $ID){
                    if($ID["expedientID"] == $expedients[0]["expedientID"]){
                        $position = $key;
                    }
                    if($mortuaryName == '' && $ID['mortuaryName'] != null && $ID['mortuaryName'] != '' ){
                        $mortuaryName = $ID['mortuaryName'];
                    }
                }

                $expedients['page'] = intval($position / 4) + 1;
                $expedients['position'] = ($position % 4) + 1;
                $expedients['mortuaryName'] = $mortuaryName;

                return $expedients;
            }else{
                return null;

            }
        }

        /**
         * Obtiene los datos para el pdf libro de visitas
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getLibroVisitas($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedSurname, e.funeralDate, e.funeralTime, e.deceasedDate, e.deceasedRoom, e.deceasedGender, e.churchLabel,
                                                l.name AS deceasedLocation, l.province AS deceasedProvince,
                                                m.name AS deceasedMortuary,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, c.name) AS deceasedCemetery,
                                                IF(e.churchLabel = 'Otro', e.otherCeremony, ch.name) AS churchName
                                    FROM        (Expedients e)
                                    LEFT JOIN   Locations l ON e.deceasedLocation = l.locationID
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   Cemeteries c ON e.cemetery = c.cemeteryID
                                    LEFT JOIN   Churches ch ON e.church = ch.churchID
                                        WHERE   expedientID = " . $data);

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Guarda el libro de visitas como html
         * 
         * @param string $data Libro de visitas
         * @return bool
         */
        public function savePDF($data){
            file_put_contents($_SESSION['basePath'] . 'resources/files/' . $_SESSION['company'] . '/expedients/' . $data['expedient'] . '/docs/' . $data['docName'] . '.html', $data['text']);
        }

        /**
         * Obtiene los datos para el pdf libro de visitas
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getLiteralesPendientes(){
            $db = new DbHandler;

            $result = $db->query("  SELECT      DAY(e.entryDate) AS day, MONTH(e.entryDate) AS month, e.deceasedName, e.deceasedSurname, e.number,
                                                c.name AS client,
                                                l.name AS location,
                                                m.name AS mortuary,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, ce.name) AS cemetery
                                    FROM        (Expedients e)
                                    LEFT JOIN   Clients c ON e.client = c.clientID
                                    LEFT JOIN   Cemeteries ce ON e.cemetery = ce.cemeteryID
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = ce.cemeteryID
                                    LEFT JOIN   Locations l ON e.deceasedBirthdayLocation = l.locationID");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }

        /**
         * Obtiene los datos para el pdf pésame web
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getPedido($order){
            $db = new DbHandler;

            $order = cleanStr($order);

            $result = $db->query("  SELECT      o.*,
                                                s.supplierID, s.name as supplierName, s.phones as supplierPhones, s.mail as supplierEmail,
                                                m.mortuaryID, m.name as mortuaryName,
                                                e.expedientID, e.number as expedientNumber, e.deceasedName, e.deceasedSurname,
                                                em.email as sendToEmail,
                                                dn.received,
                                                po.sentEmail,
                                                eh.model,
                                                et.value as hiring_text
                                    FROM        (Orders o, Suppliers s)
                                    LEFT JOIN   Expedients e ON o.expedient = e.expedientID
                                    LEFT JOIN   Mortuaries m ON o.deliveryPlace = m.mortuaryID
                                    LEFT JOIN   Emails em ON o.sendTo = em.ID
                                    LEFT JOIN   DeliveryNotes dn ON dn.order = o.ID
                                    LEFT JOIN   Pre_Orders po ON po.order = o.ID
                                    LEFT JOIN   Expedients_Hirings eh ON po.hiring = eh.ID
                                    LEFT JOIN   Expedients_Texts et ON eh.ID = et.hiring
                                    WHERE       o.ID = $order AND
                                                o.supplier = s.supplierID");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $aux = $db->resultToArray($result);

                $orderData = $aux[0];

                $result = $db->query("  SELECT  ol.*,
                                                olp.amount as lastPurchaseAmount, olp.price as lastPurchasePrice, olp.date as lastPurchaseDate,
                                                p.productID, p.name as productName, pm.supplierReference,
                                                pm.productModelID, pm.name as modelName
                                        FROM    Orders_Lines ol, Orders_Last_Purchases olp, Products p, Products_Models pm
                                        WHERE   ol.order = $order AND
                                                ol.model = olp.model AND
                                                ol.model = pm.productModelID AND
                                                pm.product = p.productID");

                if(mysqli_num_rows($result) == 0){
                    return array($orderData, null);
                }else{
                    $lines = $db->resultToArray($result);

                    foreach($lines as $index => $elem){
                        $text = '';
                        foreach($aux as $item){
                            if($item['model'] == $elem['productModelID']){
                                $text .= "{$item['hiring_text']}\n";
                            }
                        }

                        $lines[$index]['hiring_text'] = $text;
                    }

                    return array($orderData, $lines);
                }
            }
        }        

        /**
         * Obtiene los datos para el pdf pésame web
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getPesameWeb($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT  c.*, e.deceasedName, e.deceasedSurname, e.deceasedGender
                                    FROM    Condolences c, Expedients e
                                    WHERE   c.ID = $data AND
                                            c.expedient = e.expedientID");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }        

        /**
         * Obtiene los datos para el pdf precintado feretro
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getPrecintadoFeretro($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT  e.deceasedName, e.deceasedSurname, e.deceasedGender, e.number, applicantName, applicantSurname, applicantNif, applicantLocation
                                    FROM    Expedients e
                                    WHERE   expedientID = " . $data . "");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }                

        /**
         * Obtiene los datos para el pdf recibis
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getRecibis($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT  e.deceasedName, e.deceasedSurname, e.number, e.deceasedGender
                                    FROM    Expedients e
                                    WHERE   expedientID = " . $data . "");

            $result = $db->resultToArray($result)[0];

            $maxNumHiring = $this->getActiveHiring($data);
            
            $products = $db->query("SELECT  p.name
                                    FROM    Products p, Expedients_Hirings eh
                                    WHERE   eh.expedient = " . $data . " AND 
                                            eh.check = 1 AND 
                                            eh.num_hiring = $maxNumHiring AND
                                            p.productID = eh.product AND 
                                            p.supplied = 1 AND p.relatedChurch = 1
            ");

            $result['products'] = $db->resultToArray($products);

            return count($result) > 0 ? $result : null;
        }

        /**
         * Obtiene los datos para el pdf recibis iglesia
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getRecibisIglesia($data, $client = null){
            $db = new DbHandler;

            $data = cleanStr($data);
            if($client != null){
                $client = cleanStr($client);
            }

            if($client == null){
                $expedient = $db->query("   SELECT      e.deceasedName, e.deceasedSurname, e.number, e.funeralDate, e.policy, e.clientType, e.familyContactName, e.familyContactSurname,
                                                        e.familyContactNIF, e.familyContactPhone, e.familyContactMobilePhone, e.familyContactAddress, l.name AS familyContactLocation,
                                                        l.province AS familyContactProvince, e.lossNumber, e.deceasedGender, e.deceasedDate,
                                                        CONCAT(c.name, ' ', c.surname) AS clientName, c.nif AS clientCIF, c.brandName, c.address AS clientAddress, 
                                                        IF(e.churchLabel = 'Otro', e.otherCeremony, ch.name) AS church,
                                                        l2.name as churchLocationName, l2.province as churchLocationProvince
                                            FROM        (Expedients e)
                                            LEFT JOIN   Locations l ON l.locationID = e.familyContactLocation
                                            LEFT JOIN   Clients c ON e.client = c.clientID
                                            LEFT JOIN   Churches ch ON e.church = ch.churchID
                                            LEFT JOIN   Locations l2 ON l2.locationID = ch.location
                                            WHERE       expedientID = " . $data);
            }else{
                $expedient = $db->query("   SELECT      e.deceasedName, e.deceasedSurname, e.number, e.funeralDate, e.policy, e.clientType, e.familyContactName, e.familyContactSurname,
                                                        e.familyContactNIF, e.familyContactPhone, e.familyContactMobilePhone, e.familyContactAddress, l.name AS familyContactLocation,
                                                        l.province AS familyContactProvince, e.lossNumber, e.deceasedGender, e.deceasedDate,
                                                        CONCAT(c.name, ' ', c.surname) AS clientName, c.nif AS clientCIF, c.brandName, c.address AS clientAddress, 
                                                        IF(e.churchLabel = 'Otro', e.otherCeremony, ch.name) AS church,
                                                        l2.name as churchLocationName, l2.province as churchLocationProvince
                                            FROM        (Expedients e)
                                            LEFT JOIN   Locations l ON l.locationID = e.familyContactLocation
                                            LEFT JOIN   Clients c ON c.clientID = $client
                                            LEFT JOIN   Churches ch ON e.church = ch.churchID
                                            LEFT JOIN   Locations l2 ON l2.locationID = ch.location
                                            WHERE       expedientID = " . $data);
            }

            if(mysqli_num_rows($expedient) > 0){
                $expedient = $db->resultToArray($expedient)[0];

                $maxNumHiring = $this->getActiveHiring($data);
                $products = $db->query("SELECT  p.name, eh.total
                                        FROM    Expedients_Hirings eh, Products p
                                        WHERE   eh.expedient = $data AND
                                                eh.num_hiring = $maxNumHiring AND
                                                eh.check = 1 AND
                                                eh.product = p.productID AND
                                                p.supplied = 1");

                if(mysqli_num_rows($products) > 0){
                    return array($expedient, $db->resultToArray($products));
                }else{
                    return array($expedient, null);
                }
            }else{
                return null;
            }
        }

        /**
         * Obtiene los datos para el pdf reordatorio
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getRecordatorio($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedSurname, e.deceasedGender, e.deceasedMaritalStatus,
                                                e.deceasedFirstNuptials, e.deceasedSecondNuptials, e.deceasedBirthday, e.deceasedRoom,
                                                e.deceasedDate,
                                                eo.*,
                                                l.name as locationName
                                    FROM        (Expedients e)
                                    LEFT JOIN   Expedients_Obituaries eo ON e.expedientID = eo.expedient AND eo.type = 0
                                    LEFT JOIN   Churches c ON e.church = c.churchID
                                    LEFT JOIN   Locations l ON c.location = l.locationID
                                    WHERE       expedientID = " . $data);

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf reordatorio
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getRecordatorioSobre($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedSurname, c.nif, e.deceasedGender
                                    FROM        Expedients e
                                    LEFT JOIN   Clients c ON e.client = c.clientID
                                    WHERE       expedientID = " . $data);

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf buscar resumen
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getSearchSummary($date){
            $db = new DbHandler;

            $list = array();

            // Expedientes
            $result = $db->query("  SELECT      e.expedientID, e.type, e.funeralDate, e.funeralTime, e.number, e.deceasedGender, 
                                                e.deceasedName, e.deceasedSurname, e.deceasedRoom, e.crematoriumArriveTime, e.deceasedMortuaryAddress,
                                                e.ceremonyTime, e.funeralTimeBurial, e.cremation, ev.start as crematoriumEntry,
                                                e.startVelacionDate, e.startVelacionTime,
                                                m.name AS mortuary,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, c.name) AS cemetery,
                                                l.name AS mortuaryLocation,
                                                IF(e.churchLabel = 'Otro', e.otherCeremony, ch.name) AS church,
                                                es.carriersTime,
                                                f.name AS funeralHome,
                                                cr.name as crematoriumName
                                    FROM        (Expedients e, Expedients_Services es)
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   Cemeteries c ON e.cemetery = c.cemeteryID
                                    LEFT JOIN   Churches ch ON e.church = ch.churchID
                                    LEFT JOIN   Locations l ON ch.location = l.locationID
                                    LEFT JOIN   FuneralHomes f ON f.funeralHomeID = es.funeralHomeService
                                    LEFT JOIN   Crematoriums cr  ON e.crematorium = cr.crematoriumID
                                    LEFT JOIN   Events ev ON e.crematoriumEvent = ev.ID AND ev.leavingDate IS NULL
                                    WHERE       es.expedient = e.expedientID AND
                                                e.funeralDate LIKE '%$date%' AND
                                                e.leavingDate IS NULL AND
                                                e.type != 2
                                    ORDER BY    e.funeralDate, e.funeralTime");

            $expedients = $db->resultToArray($result);

            if(mysqli_num_rows($result) > 0){
                foreach($expedients as $key => $expedient){
                    $carriers = $db->query("SELECT  c.name, c.surname, sc.confirmed
                                            FROM    Carriers c, Services_Carriers sc
                                            WHERE   c.carrierID = sc.carrier AND
                                                    sc.service = " . $expedient['expedientID'] . "");

                    if(mysqli_num_rows($carriers) > 0){
                        $expedients[$key]['carriers'] = $db->resultToArray($carriers);
                    }else{
                        $expedients[$key]['carriers'] = array();
                    }

                    $cars = $db->query("    SELECT      ca.name AS driverName, ca.surname AS driverSurname, c.licensePlate, c.brand, c.model, sca.confirmed
                                            FROM        (Cars c, Services_Cars sc, Expedients e)
                                            LEFT JOIN   Carriers ca ON sc.driver = ca.carrierID
                                            LEFT JOIN   Services_Carriers sca ON ca.carrierID = sca.carrier AND sca.service = e.expedientID
                                            WHERE       e.expedientID = sc.service AND
                                                        c.ID = sc.car AND
                                                        sc.service = " . $expedient['expedientID']);

                    if(mysqli_num_rows($cars) > 0){
                        $expedients[$key]['cars'] = $db->resultToArray($cars);
                    }else{
                        $expedients[$key]['cars'] = array();
                    }

                    $maxNumHiring = $this->getActiveHiring($expedient['expedientID']);
                    $buses = $db->query("   SELECT  SUM(eh.amount) AS buses
                                            FROM    Expedients_Hirings eh, Products p
                                            WHERE   eh.expedient = " . $expedient['expedientID'] . " AND
                                                    eh.num_hiring = $maxNumHiring AND
                                                    eh.check = 1 AND
                                                    eh.product = p.productID AND
                                                    p.isBus = 1");

                    if(mysqli_num_rows($buses) > 0){
                        $expedients[$key]['buses'] = $db->resultToArray($buses)[0]['buses'];
                    }else{
                        $expedients[$key]['buses'] = 0;
                    }                                          
                }
            }
            
            count($expedients) == 0 ? $list['expedients'] = null : $list['expedients'] = $expedients;

            // Cremaciones
            $result = $db->query("  SELECT      e.type, e.expedientID, e.number, e.deceasedName, e.deceasedSurname, e.crematoriumIntroduction, e.crematoriumWaitOnRoom, e.crematoriumVaseBio, e.deceasedGender,
                                                e.familyContactName, e.familyContactSurname, e.crematoriumArriveTime, e.familyContactMobilePhone, e.ecologicCoffin, e.crematoriumPacemaker,
                                                e.authDate, e.authTime, e.authPlace,
                                                ev.start,
                                                f.name AS funeralHome,
                                                e.crematorium as crematoriumID, cr.name AS crematoriumName
                                    FROM        (Expedients e, Expedients_Services es, Events ev)
                                    LEFT JOIN   FuneralHomes f ON f.funeralHomeID = es.funeralHomeService
                                    LEFT JOIN   Crematoriums cr  ON e.crematorium = cr.crematoriumID
                                    WHERE       es.expedient = e.expedientID AND
                                                e.cremation = 1 AND
                                                e.crematoriumEvent = ev.ID AND 
                                                ev.start LIKE '%$date%' AND
                                                e.leavingDate IS NULL AND
                                                ev.status = 7
                                    ORDER BY    ev.start");

            $cremations = $db->resultToArray($result);
            
            count($cremations) == 0 ? $list['cremations'] = null : $list['cremations'] = $cremations;

            return $list;
        }

        /**
         * Obtiene los datos para el pdf retirar cenizas
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getResumenServicio($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $maxNumHiring = $this->getActiveHiring($data);

            $result = array();

            $query = $db->query("   SELECT      e.deceasedGender, e.deceasedName, e.deceasedSurname, e.number, e.deceasedRoom, e.funeralTime, e.authDate, e.authName, e.authTime, e.authPlace,
                                                e.cremation, e.crematoriumIntroduction, e.crematoriumWaitOnRoom, e.crematoriumVaseBio, e.crematoriumPacemaker, e.ecologicCoffin,
                                                cr.name as crematorium,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, c.name) AS cemetery,
                                                IF(e.churchLabel = 'Otro', e.otherCeremony, ch.name) AS church,
                                                m.name AS mortuary,
                                                es.routeSummary, es.notesSummary, es.churchSummary, es.licenseSummary, es.deliveryReceiptSummary, es.reminderSummary
                                    FROM        (Expedients e, Expedients_Services es)
                                    LEFT JOIN   Cemeteries c ON e.cemetery = c.cemeteryID
                                    LEFT JOIN   Churches ch ON e.church = ch.churchID
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   Crematoriums cr ON e.crematorium = cr.crematoriumID
                                    WHERE       expedientID = $data AND
                                                e.expedientID = es.expedient");

            if(mysqli_num_rows($query) > 0){
                $result['sumary'] = $db->resultToArray($query)[0];
            }

            // Bus
            $query = $db->query("   SELECT  pm.name as modelName, s.name as supplierName
                                    FROM    Expedients_Hirings eh, Products_Models pm, Suppliers s, Products p
                                    WHERE   eh.expedient = $data AND
                                            eh.check = 1 AND
                                            eh.product = p.productID AND
                                            pm.product = p.productID AND
                                            p.name LIKE '%Omnibus%' AND
                                            eh.model = pm.productModelID AND
                                            eh.supplier = s.supplierID AND
                                            eh.num_hiring = $maxNumHiring
            ");

            $result['bus'] = mysqli_num_rows($query) == 0 ? null : $db->resultToArray($query);

            // Taxi
            $query = $db->query("   SELECT  pm.name as modelName, s.name as supplierName
                                    FROM    Expedients_Hirings eh, Products_Models pm, Suppliers s, Products p
                                    WHERE   eh.expedient = $data AND
                                            eh.check = 1 AND
                                            eh.product = p.productID AND
                                            pm.product = p.productID AND
                                            p.name LIKE '%Taxi%' AND
                                            eh.model = pm.productModelID AND
                                            eh.supplier = s.supplierID AND
                                            eh.num_hiring = $maxNumHiring
            ");

            $result['taxi'] = mysqli_num_rows($query) == 0 ? null : $db->resultToArray($query);                                            

            // Recordatorio
            if(intval($_SESSION['company'] == 1)){
                $query = $db->query("   SELECT  pm.name as modelName, s.name as supplierName
                                        FROM    Expedients_Hirings eh, Products_Models pm, Suppliers s, Services_Auto sa, Products p
                                        WHERE   eh.expedient = $data AND
                                                eh.check = 1 AND
                                                eh.product = p.productID AND
                                                pm.product = p.productID AND
                                                p.name LIKE '%Recordatorio%' AND
                                                eh.model = pm.productModelID AND
                                                eh.supplier = s.supplierID AND
                                                sa.service = $data AND
                                                sa.model = eh.model AND
                                                sa.action = 14 AND
                                                sa.status = 1 AND
                                                sa.value = 1 AND
                                                eh.num_hiring = $maxNumHiring
                ");
            }else{
                $query = $db->query("   SELECT  pm.name as modelName, s.name as supplierName
                                        FROM    Expedients_Hirings eh, Products_Models pm, Suppliers s, Services_Auto sa, Products p
                                        WHERE   eh.expedient = $data AND
                                                eh.check = 1 AND
                                                eh.product = p.productID AND
                                                pm.product = p.productID AND
                                                p.name LIKE '%Recordatorio%' AND
                                                eh.model = pm.productModelID AND
                                                eh.supplier = s.supplierID AND
                                                sa.service = $data AND
                                                sa.model = eh.model AND
                                                sa.status = 1 AND
                                                sa.value = 1 AND
                                                eh.num_hiring = $maxNumHiring
                ");
            }

            $result['reminder'] = mysqli_num_rows($query) == 0 ? null : $db->resultToArray($query);

            $query = $db->query("   SELECT      c.name, c.surname, sc.confirmed, ca.licensePlate, ca.brand, ca.model
                                    FROM        (Services_Carriers sc, Carriers c)
                                    LEFT JOIN   Services_Cars sca ON sca.service = $data AND sca.driver = sc.carrier
                                    LEFT JOIN   Cars ca ON sca.car = ca.ID
                                    WHERE       sc.carrier = c.carrierID AND sc.service = $data");

            $carriers = $db->resultToArray($query);

            if(mysqli_num_rows($query) > 0){
                $result['carriers']= array();
                foreach($carriers as $carrier){
                    array_push($result['carriers'], $carrier);
                }
            }

            if(count($result) > 0){
                return $result;            
            }else{
                return null;
            }
        }

        /**
         * Obtiene los datos para el pdf retirar cenizas
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getRetirarCenizas($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.exhumation, e.deceasedName, e.deceasedSurname, e.funeralNicheNumber, e.deceasedGender, e.number, applicantName, applicantSurname, applicantNIF, funeralDateNiche, authName,
                                                e.deceasedNiche, e.funeralDateNiche, e.familyContactName, e.familyContactSurname, e.familyContactNIF, e.familyContactAddress, e.deceasedDate,
                                                e.niche, e.nicheHeight, e.exhumation, e.regime, e.cemeteryLabel, e.applicantLocation,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, c.name) AS cemetery,
                                                l.name AS cemeteryLocation, l.province AS cemeteryProvince,
                                                l1.name as familyContactLocality, l1.province AS familyContactProvince,
                                                di.name as deceasedIn, CONCAT(l2.name, ', ', l2.province) AS deceasedInName,
                                                CONCAT(l4.name, ', ' , l4.province) AS applicantLocation
                                    FROM        (Expedients e)
                                    LEFT JOIN   Cemeteries c ON e.cemetery = c.cemeteryID
                                    LEFT JOIN   Locations l ON l.locationID = c.location
                                    LEFT JOIN   Locations l1 ON e.familyContactLocation = l1.locationID
                                    LEFT JOIN   DeceasedIn di ON di.deceasedInID = e.deceasedLocation
                                    LEFT JOIN   Locations l2 ON l2.locationID = di.location
                                    LEFT JOIN   Locations l4 ON l4.locationID = e.applicantLocation
                                    WHERE       expedientID = " . $data . "");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf acta extraccion dispositivos
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getActaExtraccionDispositivos($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT  e.deceasedName, e.deceasedSurname, e.deceasedNIF, e.deceasedGender, e.deceasedDate, e.deceasedTime
                                    FROM    (Expedients e)
                                    WHERE   expedientID = " . $data . "");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf recibís campanero La Fe Seguros
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getRecibisCampanerosLaFE($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT  e.policy, e.deceasedGender, e.deceasedName, e.deceasedSurname,
                                            e.deceasedUsualAddress as deceasedInName, e.deceasedLocality, e.deceasedProvince
                                    FROM    Expedients e
                                    WHERE   expedientID = " . $data . "");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf retirar cenizas
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getTransladoCenizasCadaver($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedGender, e.funeralNicheNumber, e.number, applicantName, applicantNIF, 
                                                applicantAddress, authName,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, c.name) AS deceasedCemetery,
                                                c.location,
                                    FROM        (Expedients e)
                                    LEFT JOIN   Cemeteries c ON e.cemetery = c.cemeteryID
                                    WHERE       expedientID = " . $data . "");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf situación nicho judicial
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getSituacionNichoJudicial($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedSurname, e.deceasedGender, e.number, 
                                                c.name AS crematoriumName,
                                                l.name AS crematoriumLocation, l.province AS crematoriumProvince
                                    FROM        Expedients e
                                    LEFT JOIN   Crematoriums c ON e.crematorium = c.crematoriumID
                                    LEFT JOIN   Locations l ON l.locationID = c.location
                                    WHERE       expedientID = " . $data . "");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf solicitud de literales
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getSolicitudLiterales($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedSurname, e.funeralNicheNumber, e.deceasedDate, e.deceasedGender, e.otherDeceasedLocation,
                                                CONCAT(l1.name, ', ', l1.province) AS deceasedInLocation
                                    FROM        (Expedients e)
                                    LEFT JOIN   DeceasedIn di ON di.deceasedInID = e.deceasedLocation
                                    LEFT JOIN   Locations l1 ON l1.locationID = di.location
                                    WHERE       expedientID = " . $data . "");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf solicitud de necropsia
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getSolicitudNecropsia($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT  e.deceasedName, e.deceasedSurname, e.deceasedDate, e.deceasedNIF, e.deceasedGender
                                    FROM    Expedients e
                                    WHERE   expedientID = " . $data . "");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los datos para el pdf traslado cenizas cadaver
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getTimes($from, $to, $mortuary){
            $db = new DbHandler;

            $from = cleanStr($from);
            $to = cleanStr($to);
            $mortuary = cleanStr($mortuary);

            $result = $db->query("  SELECT      e.number, e.requestTime, es.arriveTime, 
                                                SEC_TO_TIME(UNIX_TIMESTAMP(STR_TO_DATE(CONCAT(es.arriveDate, ' ', es.arriveTime), '%Y-%m-%d %H:%i:%s')) - UNIX_TIMESTAMP(STR_TO_DATE(CONCAT(e.requestDate, ' ', e.requestTime), '%Y-%m-%d %H:%i:%s'))) AS dif
                                    FROM        (Expedients e)
                                    LEFT JOIN   Expedients_Services es ON e.expedientID = es.expedient
                                    WHERE       e.deceasedMortuary = " . $mortuary . " AND
                                                UNIX_TIMESTAMP(e.entryDate) BETWEEN " . $from . " AND " . $to . "");

            $res['data'] = $db->resultToArrayValue($result);

            return mysqli_num_rows($result) > 0 ? $res : null;
        }

        /**
         * Obtiene los datos para el pdf traslado cenizas cadaver
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getTrasladoCenizasCadaver($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.applicantName, e.applicantNif, e.applicantAddress,  e.deceasedGender, e.deceasedNIF, e.deceasedName, e.deceasedSurname, e.funeralNicheNumber, e.deceasedDate, e.deceasedTime, e.deceasedGender, e.deceasedNIF, e.deceasedBirthday,
                                                e.familyContactName, e.familyContactSurname, e.familyContactName, e.familyContactSurname, e.familyContactNIF, e.familyContactPhone, e.funeralNicheNumber, e.cremation,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, c.name) as deceasedCemetery,
                                                l1.name AS cemeteryLocation,
                                                l2.name AS deceasedBirthdayLocation, l2.province AS deceasedBirthdayProvince,
                                                l3.name AS deceasedLocation, l3.province AS deceasedProvince,
                                                l4.name AS moveDestination,
                                                cr.name as crematoriumName,
                                                l5.name as crematoriumLocation
                                    FROM        (Expedients e)
                                    LEFT JOIN   Cemeteries c ON e.cemetery = c.cemeteryID
                                    LEFT JOIN   Locations l1 ON c.location = l1.locationID
                                    LEFT JOIN   Locations l2 ON e.deceasedBirthdayLocation = l2.locationID
                                    LEFT JOIN   Locations l3 ON e.deceasedLocation = l3.locationID
                                    LEFT JOIN   Locations l4 ON e.moveDestination = l4.locationID
                                    LEFT JOIN   Crematoriums cr ON e.crematorium = cr.crematoriumID
                                    LEFT JOIN   Locations l5 ON cr.location = l5.locationID
                                    WHERE       expedientID = $data");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Obtiene los años para los cuáles ha habido al menos una cremación
         * 
         * @return array
         */
        public function getYearsCremations(){
            $db = new DbHandler;

            $result = $db->query("  SELECT  DISTINCT(EXTRACT(YEAR FROM ev.start)) as year
                                    FROM    Events ev, Expedients e
                                    WHERE   ev.ID = e.crematoriumEvent AND
                                            e.crematoriumEvent IS NOT NULL");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }

        /**
        * Obtenemos los datos de la plantilla
        *
        * @param array $data
        *
        * @return bool
        */
        public function removeProduct($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $db->query("DELETE FROM Pre_Orders WHERE hiring = $data");

            $db->query("DELETE FROM Expedients_Texts WHERE hiring = $data");

            $db->query("DELETE FROM Expedients_Work_Orders_Communication WHERE hiring = " . $data . "");
                    
            $db->query("DELETE FROM Expedients_Work_Orders_Flowers WHERE hiring = " . $data . "");
            
            return $db->query(" DELETE FROM Expedients_Hirings WHERE ID = " . $data . "");
        }

        /**
        * Obtenemos los productos de la contratación que no son suplidos
        *
        * @param array $data
        * @return array
        */
        public function getHiringProducts($data){
            $db = new DbHandler;

            $data['expedient'] = cleanStr($data['expedient']);
            $data['numHiring'] = cleanStr($data['numHiring']);

            $result = $db->query("  
                (
                        SELECT      eh.check, eh.template, eh.product, eh.model, pm.supplier, eh.amount, eh.texts, eh.discount, eh.ID, eh.warehouse, eh.old_hiring,
                                    cc.name as warehouseName,
                                    p.name AS prodName, p.texts AS withText, p.amount AS contable, p.supplied, p.type, p.blockBelow, p.orderType, p.orderBy, p.editPrice,
                                    s.name AS suppName, 
                                    pm.name AS modelName, eh.total as valueEditPrice, it.percentage as percentageEdit,
                                    pp.priceNoIVA, 
                                    (pp.priceNoIVA * it.percentage / 100 + pp.priceNoIVA) AS priceIVA, 
                                    ((pp.priceNoIVA * it.percentage / 100 + pp.priceNoIVA) - ((pp.priceNoIVA * it.percentage / 100 + pp.priceNoIVA) * eh.discount / 100) )* eh.amount  AS priceIVATotal
                        FROM        (Products p, Expedients e) 
                        LEFT JOIN   Expedients_Hirings eh ON p.productID = eh.product 
                        LEFT JOIN   Products_Prices pp ON pp.model = eh.model 
                        LEFT JOIN   IVA_Types it ON it.IVATypeID = p.IVA 
                        LEFT JOIN   Products_Models pm ON eh.model = pm.productModelID
                        LEFT JOIN   Suppliers s ON pm.supplier = s.supplierID 
                        LEFT JOIN   Cost_Center cc ON eh.warehouse = cc.ID
                        LEFT JOIN   Mortuaries m ON cc.warehouse = m.mortuaryID
                        WHERE       p.leavingDate IS NULL AND pm.leavingDate IS NULL AND
                                    pp.price = eh.priceExp AND 
                                    e.expedientID = eh.expedient AND eh.expedient = " . $data['expedient'] . " AND
                                    p.supplied = 0 AND 
                                    p.orderType = 0 AND 
                                    eh.check = 0 AND
                                    eh.num_hiring = " . $data['numHiring'] . "
                    )
                    UNION
                    (
                        SELECT      eh.check, eh.template, eh.product, eh.model, eh.supplier, eh.amount, eh.texts, eh.discount, eh.ID, eh.warehouse, eh.old_hiring,
                                    cc.name as warehouseName,
                                    p.name AS prodName, p.texts AS withText, p.amount AS contable, p.supplied, p.type, p.blockBelow, p.orderType, p.orderBy, p.editPrice,
                                    s.name AS suppName, 
                                    pm.name AS modelName, eh.total as valueEditPrice, it.percentage as percentageEdit,
                                    pp.priceNoIVA,
                                    (pp.priceNoIVA * it.percentage / 100 + pp.priceNoIVA) AS priceIVA, 
                                    ((pp.priceNoIVA * it.percentage / 100 + pp.priceNoIVA) - ((pp.priceNoIVA * it.percentage / 100 + pp.priceNoIVA) * eh.discount / 100) )* eh.amount  AS priceIVATotal
                        FROM        (Products p, Expedients e) 
                        LEFT JOIN   Expedients_Hirings eh ON p.productID = eh.product 
                        LEFT JOIN   Products_Prices pp ON pp.model = eh.model 
                        LEFT JOIN   IVA_Types it ON it.IVATypeID = p.IVA 
                        LEFT JOIN   Suppliers s ON eh.supplier = s.supplierID 
                        LEFT JOIN   Products_Models pm ON eh.model = pm.productModelID
                        LEFT JOIN   Cost_Center cc ON eh.warehouse = cc.ID
                        LEFT JOIN   Mortuaries m ON cc.warehouse = m.mortuaryID
                        WHERE       p.leavingDate IS NULL AND 
                                    pp.price = eh.priceExp AND 
                                    e.expedientID = eh.expedient AND eh.expedient = " . $data['expedient'] . " AND
                                    p.supplied = 0 AND 
                                    p.orderType = 0 AND 
                                    eh.check = 1 AND
                                    eh.num_hiring = " . $data['numHiring'] . "
                    )
                    ORDER BY    blockBelow, orderBy, prodName, ID
            ");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }
        
        /**
         * Obtenemos los productos de la contratación que son suplidos
         *
         * @param array $data
         * @return array
         */
        public function getHiringProductsSupplied($data){
            $db = new DbHandler;

            $data['expedient'] = cleanStr($data['expedient']);
            $data['numHiring'] = cleanStr($data['numHiring']);

            $result = $db->query("  
                (
                    SELECT      eh.check, eh.template, eh.product, eh.model, pm.supplier, eh.amount, eh.texts, eh.discount, eh.ID, eh.warehouse, eh.old_hiring,
                                cc.name as warehouseName,
                                p.name AS prodName, p.texts AS withText, p.amount AS contable, p.supplied, p.type, p.blockBelow, p.orderType, p.editPrice, p.orderBy,
                                s.name AS suppName, 
                                pm.name AS modelName, 
                                eh.total as priceNoIVA, eh.total as valueEditPrice, it.percentage as percentageEdit,
                                (eh.total - (eh.total * eh.discount / 100)) * eh.amount  AS priceNoIVATotal
                    FROM        (Products p, Expedients e) 
                    LEFT JOIN   Expedients_Hirings eh ON p.productID = eh.product 
                    LEFT JOIN   Products_Prices pp ON pp.model = eh.model 
                    LEFT JOIN   IVA_Types it ON it.IVATypeID = p.IVA 
                    LEFT JOIN   Products_Models pm ON eh.model = pm.productModelID 
                    LEFT JOIN   Suppliers s ON pm.supplier = s.supplierID 
                    LEFT JOIN   Cost_Center cc ON eh.warehouse = cc.ID
                    LEFT JOIN   Mortuaries m ON cc.warehouse = m.mortuaryID
                    WHERE       p.leavingDate IS NULL AND pm.leavingDate IS NULL AND 
                                pp.price = eh.priceExp AND 
                                e.expedientID = eh.expedient AND eh.expedient = " . $data['expedient'] . " AND
                                p.supplied = 1 AND 
                                p.orderType = 0 AND 
                                eh.check = 0 AND
                                eh.num_hiring = " . $data['numHiring'] . "
                )
                UNION
                (
                    SELECT      eh.check, eh.template, eh.product, eh.model, eh.supplier, eh.amount, eh.texts, eh.discount, eh.ID, eh.warehouse, eh.old_hiring,
                                cc.name as warehouseName,
                                p.name AS prodName, p.texts AS withText, p.amount AS contable, p.supplied, p.type, p.blockBelow, p.orderType, p.editPrice, p.orderBy,
                                s.name AS suppName, 
                                pm.name AS modelName, 
                                eh.total as priceNoIVA, eh.total as valueEditPrice, it.percentage as percentageEdit,
                                (eh.total - (eh.total * eh.discount / 100)) * eh.amount  AS priceNoIVATotal
                    FROM        (Products p, Expedients e) 
                    LEFT JOIN   Expedients_Hirings eh ON p.productID = eh.product 
                    LEFT JOIN   Products_Prices pp ON pp.model = eh.model 
                    LEFT JOIN   IVA_Types it ON it.IVATypeID = p.IVA 
                    LEFT JOIN   Suppliers s ON eh.supplier = s.supplierID 
                    LEFT JOIN   Products_Models pm ON eh.model = pm.productModelID 
                    LEFT JOIN   Cost_Center cc ON eh.warehouse = cc.ID
                    LEFT JOIN   Mortuaries m ON cc.warehouse = m.mortuaryID
                    WHERE       p.leavingDate IS NULL AND pm.leavingDate IS NULL AND 
                                pp.price = eh.priceExp AND 
                                e.expedientID = eh.expedient AND eh.expedient = " . $data['expedient'] . " AND
                                p.supplied = 1 AND 
                                p.orderType = 0 AND 
                                eh.check = 1 AND
                                eh.num_hiring = " . $data['numHiring'] . "
                )
                ORDER BY        blockBelow, orderBy, prodName, ID
            ");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }

        /**
        * Obtenemos los productos de la contratación que no son suplidos para el expediente asociado
        *
        * @param array $data
        * @return array
        */
        public function getHiringProductsAssociate($expedientID, $numHiring){
            $db = new DbHandler;

            $expedientID = cleanStr($expedientID);
            $numHiring = cleanStr($numHiring);
           
            $result = $db->query("  SELECT      e.expedientID, eh.check, eh.template, eh.product, eh.model, eh.supplier, eh.amount, eh.discount, eh.ID, eh.warehouse,
                                                m.name as warehouseName,
                                                p.name AS prodName, p.texts AS withText, p.amount AS contable, p.supplied, p.type, p.blockBelow, p.orderType,
                                                s.name AS suppName, 
                                                pm.name AS modelName, 
                                                eh.total AS priceIVA, 
                                                (eh.total - (eh.total * eh.discount / 100) )* eh.amount  AS priceIVATotal,
                                                (
                                                    SELECT  GROUP_CONCAT(REPLACE(et.value, '\\\', '') SEPARATOR ', ')
                                                    FROM    Expedients_Texts et
                                                    WHERE   et.hiring = eh.ID
                                                ) as texts,
                                                e.tpv,
                                                eh.num_hiring
			                        FROM        (Products p, Expedients e) 
                                    LEFT JOIN   Expedients_Hirings eh ON p.productID = eh.product 
                                    LEFT JOIN   Products_Prices pp ON pp.model = eh.model 
                                    LEFT JOIN   IVA_Types it ON it.IVATypeID = p.IVA 
                                    LEFT JOIN   Suppliers s ON eh.supplier = s.supplierID 
                                    LEFT JOIN   Products_Models pm ON eh.model = pm.productModelID
                                    LEFT JOIN   Mortuaries m ON eh.warehouse = m.mortuaryID
			                        WHERE       p.leavingDate IS NULL AND 
                                                pm.leavingDate IS NULL AND 
                                                pp.price = eh.priceExp AND 
                                                e.expedientID = eh.expedient AND 
                                                eh.expedient = $expedientID AND
                                                p.supplied = 0 AND 
                                                p.orderType = 0 AND 
                                                eh.check = 1 AND
                                                eh.num_hiring = $numHiring
                                    ORDER BY    p.blockBelow, p.orderBy, eh.ID");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }

        /**
         * Obtenemos los productos de la contratación que son suplidos
         *
         * @param array $data
         * @return array
         */
        public function getHiringProductsSuppliedAssociate($expedientID, $numHiring){
            $db = new DbHandler;

            $expedientID = cleanStr($expedientID);
            $numHiring = cleanStr($numHiring);
            
            $result = $db->query("  SELECT      e.expedientID, eh.check, eh.template, eh.product, eh.model, eh.supplier, eh.amount, eh.texts, eh.discount, eh.ID,
                                                p.name AS prodName, p.texts AS withText, p.amount AS contable, p.supplied, p.type, p.blockBelow, p.orderType,
                                                s.name AS suppName, 
                                                pm.name AS modelName, 
                                                eh.total AS priceIVA,
                                                (eh.total - (eh.total * eh.discount / 100)) * eh.amount  AS priceIVATotal,
                                                (
                                                    SELECT  GROUP_CONCAT(REPLACE(et.value, '\\\', '') SEPARATOR ', ')
                                                    FROM    Expedients_Texts et
                                                    WHERE   et.hiring = eh.ID
                                                ) as texts,
                                                e.tpv,
                                                eh.num_hiring
			                        FROM        (Products p, Expedients e) 
                                    LEFT JOIN   Expedients_Hirings eh ON p.productID = eh.product 
                                    LEFT JOIN   Products_Prices pp ON pp.model = eh.model 
                                    LEFT JOIN   IVA_Types it ON it.IVATypeID = p.IVA 
                                    LEFT JOIN   Suppliers s ON eh.supplier = s.supplierID 
                                    LEFT JOIN   Products_Models pm ON eh.model = pm.productModelID 
			                        WHERE       p.leavingDate IS NULL AND 
                                                pm.leavingDate IS NULL AND 
                                                pp.price = eh.priceExp AND 
                                                e.expedientID = eh.expedient AND 
                                                eh.expedient = $expedientID AND
                                                p.supplied = 1 AND 
                                                p.orderType = 0 AND 
                                                eh.check = 1 AND
                                                eh.num_hiring = $numHiring
                                    ORDER BY    p.blockBelow, p.orderBy, eh.ID");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }

        /**
         * Obtiene los datos del resumen del servicio
         * 
         * @param int ID del servicio
         * @return array
         */
        public function getSummary($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      e.expedientID, e.deceasedName, e.deceasedSurname,
                                                e.cremation, e.crematoriumIntroduction, e.crematoriumWaitOnRoom, e.crematoriumVaseBio, e.crematoriumPacemaker, e.ecologicCoffin,
                                                es.routeSummary, es.notesSummary, es.churchSummary, es.licenseSummary, es.deliveryReceiptSummary, es.reminderSummary,
                                                c.crematoriumID, c.name as crematoriumName
                                    FROM        (Expedients e, Expedients_Services es)
                                    LEFT JOIN   Crematoriums c ON e.crematorium = c.crematoriumID
                                    WHERE       es.expedient = e.expedientID AND
                                                es.expedient = " . $data);

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
        }

        /**
         * Modifica los datos del resumen del servicio
         * 
         * @param array $data
         * 
         * @return bool
         */
        public function setSummary($data){
            $db = new DbHandler;

            $data['route'] = cleanTextArea($data['route']);
            $data['notes'] = cleanTextArea($data['notes']);
            $data['churchSummary'] = cleanStr($data['churchSummary']);
            $data['licenseSummary'] = cleanStr($data['licenseSummary']);
            $data['deliveryReceiptSummary'] = cleanStr($data['deliveryReceiptSummary']);
            $data['reminderSummary'] = cleanStr($data['reminderSummary']);
            $data['expedient'] = cleanStr($data['expedient']);

            return $db->query(" UPDATE  Expedients_Services
                                SET     routeSummary = '" . $data['route'] . "',
                                        notesSummary = '" . $data['notes'] . "',
                                        churchSummary = " . $data['churchSummary'] . ",
                                        licenseSummary = " . $data['licenseSummary'] . ",
                                        deliveryReceiptSummary = " . $data['deliveryReceiptSummary'] . ",
                                        reminderSummary = " . $data['reminderSummary'] . "
                                WHERE   expedient = " . $data['expedient']);
        }

        /**
         * Obtiene el tanatorio del expediente
         * 
         * @param int $expedient Id del expediente
         * @return int|null
         */
        public function getDeliveryPlace($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT  e.deceasedMortuary
                                    FROM    Expedients e
                                    WHERE   e.expedientID = $expedient");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['deceasedMortuary'];
        }

        /**
         * Obtiene los productos que tienen pedido del servicio del expediente para la sección de "Otros"
         * 
         * @param int $expedient Expediente
         * @return array
         */
        public function getServicesOrders($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $year = date('Y');

            $maxNumHiring = $this->getActiveHiring($expedient);
     
            $result = $db->query("  SELECT	    po.ID as preOrderID, po.order as orderID, po.sentEmail,
                                                eh.ID hiringID, eh.amount,
                                                p.productID, p.name as productName,
                                                pm.productModelID as modelID, pm.name as modelName,
                                                s.supplierID, s.name as supplierName, s.phones as suplierPhone, pr.purchasePrice as price,
                                                e.entryDate
                                    FROM	    Pre_Orders po, Expedients_Hirings eh, Expedients e, Products p, Products_Models pm, Suppliers s, Products_Retails pr
                                    WHERE	    po.leavingDate IS NULL AND
                                                po.hiring = eh.ID AND
                                                eh.expedient = e.expedientID AND
                                                e.expedientID = $expedient AND
                                                e.leavingDate IS NULL AND
                                                eh.product = p.productID AND
                                                eh.model = pm.productModelID AND
                                                eh.model = pr.model AND
                                                pr.year = " . $year . " AND
                                                eh.supplier = s.supplierID AND
                                                p.checkCService = 1 AND
                                                eh.num_hiring = $maxNumHiring
                                    GROUP BY    preOrderID
                                    ORDER BY    s.name
            ");

            // Añadir al array: textos y acciones
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $others = $db->resultToArray($result);

                foreach($others as $key => $value){
                    $result = $db->query("  SELECT  REPLACE(et.value, '\\\', '') as value
                                            FROM    Expedients_Texts et
                                            WHERE   et.value != '' AND 
                                                    et.hiring = " . $value['hiringID']);

                    $others[$key]['texts'] = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);

                    if(strtotime($others[$key]['entryDate']) >= 1716328800){
                        $result = $db->query("  SELECT      sa.action, sa.value, sa.status, a.type, a.label
                                                FROM        Services_Auto sa, Actions a, Products_Actions pa
                                                WHERE       sa.service = $expedient AND
                                                            sa.model = " . $value['modelID'] . " AND
                                                            sa.action = a.ID AND
                                                            pa.action = a.ID AND
                                                            pa.product = " . $value['productID'] . " AND
                                                            pa.checked = 1 AND
                                                            sa.hiring = {$value['hiringID']} AND
                                                            a.leavingDate IS NULL
                                                ORDER BY    a.orderBy");
                    }else{
                        $result = $db->query("  SELECT      sa.action, sa.value, sa.status, a.type, a.label
                                                FROM        Services_Auto sa, Actions a, Products_Actions pa
                                                WHERE       sa.service = $expedient AND
                                                            sa.model = " . $value['modelID'] . " AND
                                                            sa.action = a.ID AND
                                                            pa.action = a.ID AND
                                                            pa.product = " . $value['productID'] . " AND
                                                            pa.checked = 1 AND
                                                            a.leavingDate IS NULL
                                                ORDER BY    a.orderBy");
                    }

                    $others[$key]['actions'] = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
                }

                return $others;
            }
        }

        /**
         * Obtiene los productos que no tienen pedido del servicio del expediente para la sección de "Otros"
         * 
         * @param int $expedient Expediente
         * @return array
         */
        public function getServicesNoOrders($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $maxNumHiring = $this->getActiveHiring($expedient);

            $result = $db->query("  SELECT      DISTINCT p.productID, p.name as productName,
                                                s.name as supplierName, s.phones as supplierPhone,                                                
                                                pm.name AS modelName, pm.productModelID as modelID,
                                                eh.ID as hiringID, eh.amount,
                                                e.entryDate
                                    FROM        Services_Auto sa, Products p, Actions a, Expedients_Hirings eh, Products_Models pm, Suppliers s, Expedients e
                                    WHERE       sa.service = $expedient AND 
                                                sa.model = eh.model AND 
                                                sa.action = a.ID AND 
                                                sa.status = 1 AND 
                                                eh.product = p.productID AND 
                                                eh.supplier = s.supplierID AND 
                                                eh.check = 1 AND
                                                eh.expedient = sa.service AND
                                                pm.productModelID = eh.model AND
                                                p.checkCService = 1 AND
                                                eh.expedient = e.expedientID AND
                                                eh.num_hiring = $maxNumHiring AND
                                                pm.productModelID NOT IN(
                                                    SELECT	    pm.productModelID as modelID
                                                    FROM	    Pre_Orders po, Expedients_Hirings eh, Expedients e, Products p, Products_Models pm, Suppliers s
                                                    WHERE	    po.leavingDate IS NULL AND
                                                                po.hiring = eh.ID AND
                                                                eh.expedient = e.expedientID AND
                                                                e.expedientID = $expedient AND
                                                                e.leavingDate IS NULL AND
                                                                eh.product = p.productID AND
                                                                eh.model = pm.productModelID AND
                                                                eh.supplier = s.supplierID AND
                                                                eh.num_hiring = $maxNumHiring
                                                    ORDER BY    s.supplierID, p.blockBelow, p.orderBy 
                                                ) 
                                    ORDER BY    s.supplierID, p.blockBelow, p.orderBy
            ");

            $arrayResult = array();

            // Añadir al array: textos y acciones
            if(mysqli_num_rows($result) > 0){
                $others = $db->resultToArray($result);

                foreach($others as $key => $value){
                    $result = $db->query("  SELECT  REPLACE(et.value, '\\\', '') as value
                                            FROM    Expedients_Texts et
                                            WHERE   et.value != '' AND 
                                                    et.hiring = " . $value['hiringID']);

                    $others[$key]['texts'] = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);


                    if(strtotime($others[$key]['entryDate']) >= 1716328800){
                        $result = $db->query("  SELECT      sa.action, sa.value, sa.status, a.type, a.label, a.orderBy
                                                FROM        Services_Auto sa, Actions a, Products_Actions pa
                                                WHERE       sa.service = $expedient AND
                                                            sa.model = " . $value['modelID'] . " AND
                                                            sa.action = a.ID AND
                                                            pa.action = a.ID AND
                                                            pa.product = " . $value['productID'] . " AND
                                                            pa.checked = 1 AND
                                                            sa.hiring = {$value['hiringID']} AND
                                                            a.leavingDate IS NULL
                                                ORDER BY    a.orderBy");
                    }else{
                        $result = $db->query("  SELECT      sa.action, sa.value, sa.status, a.type, a.label, a.orderBy
                                                FROM        Services_Auto sa, Actions a, Products_Actions pa
                                                WHERE       sa.service = $expedient AND
                                                            sa.model = " . $value['modelID'] . " AND
                                                            sa.action = a.ID AND
                                                            pa.action = a.ID AND
                                                            pa.product = " . $value['productID'] . " AND
                                                            pa.checked = 1 AND
                                                            a.leavingDate IS NULL
                                                ORDER BY    a.orderBy");
                    }

                    $others[$key]['actions'] = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
                }

                $arrayResult = array_merge($arrayResult, $others);
            }

            return count($arrayResult) == 0 ? null : $arrayResult;
        }

        /**
         * Obtiene los productos que de tipo orderType = 3 para la sección de "Otros"
         * 
         * @param int $expedient Expediente
         * @return array
         */
        public function getServiceOrderType($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $arrayResult = array();

            $resultOrderType = $db->query(" SELECT DISTINCT p.productID, p.name as productName, s.name as supplierName, s.phones as supplierPhone,                                                
                                                            pm.name AS modelName, pm.productModelID as modelID,
                                                            0 as hiringID, 1 as amount
                                            FROM            Services_Auto sa, Products p, Actions a, Products_Models pm, Suppliers s 
                                            WHERE           sa.service = " . $expedient . " AND 
                                                            sa.model = pm.productModelID AND 
                                                            sa.action = a.ID AND 
                                                            sa.status = 1 AND 
                                                            pm.product = p.productID AND 
                                                            pm.supplier = s.supplierID AND
                                                            p.orderType = 3 AND
                                                            p.checkCService = 1
                                            ORDER BY        p.name, pm.productModelID, a.orderBy");

            if (mysqli_num_rows($resultOrderType) > 0){
                $resultOrderType = $db->resultToArray($resultOrderType);

                foreach($resultOrderType as $key => $value){
                    $resultOrderType[$key]['texts'] = null;

                    $result = $db->query("  SELECT      sa.action, sa.value, sa.status,
                                                        a.type, a.label, a.orderBy
                                            FROM        Services_Auto sa, Actions a, Products_Actions pa
                                            WHERE       sa.service = $expedient AND
                                                        sa.model = " . $value['modelID'] . " AND
                                                        sa.action = a.ID AND
                                                        pa.action = a.ID AND pa.product = " . $value['productID'] . " AND pa.checked = 1 AND
                                                        a.leavingDate IS NULL
                                            ORDER BY    a.orderBy");

                    $resultOrderType[$key]['actions'] = mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
                }

                $arrayResult = array_merge($arrayResult, $resultOrderType);
            }

            return count($arrayResult) == 0 ? null : $arrayResult;
        }

        /**
         * Filtra los tiempos de respuesta
         * 
         * @param array $data Filtros
         * @param array|null Datos filtrados
         */
        public function filterTimes($data){
            $db = new DbHandler;

            $data['dateCheck'] = cleanStr($data['dateCheck']);
            $data['datePeriod'] = cleanStr($data['datePeriod']);
            $data['dateSince'] = cleanStr($data['dateSince']);
            $data['dateUntil'] = cleanStr($data['dateUntil']);
            $data['dateCheckLength'] = cleanStr($data['dateCheckLength']);
            $data['month'] = cleanStr($data['month']);
            $data['trimester'] = cleanStr($data['trimester']);
            $data['year'] = cleanStr($data['year']);
            $data['callTimeCheck'] = cleanStr($data['callTimeCheck']);
            $data['callTimePeriod'] = cleanStr($data['callTimePeriod']);
            $data['callTimeSince'] = cleanStr($data['callTimeSince']);
            $data['callTimeUntil'] = cleanStr($data['callTimeUntil']);
            $data['callTime'] = cleanStr($data['callTime']);
            $data['arriveTimeCheck'] = cleanStr($data['arriveTimeCheck']);
            $data['arriveTimePeriod'] = cleanStr($data['arriveTimePeriod']);
            $data['arriveTimeSince'] = cleanStr($data['arriveTimeSince']);
            $data['arriveTimeUntil'] = cleanStr($data['arriveTimeUntil']);
            $data['arriveTime'] = cleanStr($data['arriveTime']);
            $data['startDateCheck'] = cleanStr($data['startDateCheck']);
            $data['startDatePeriod'] = cleanStr($data['startDatePeriod']);
            $data['startDateSince'] = cleanStr($data['startDateSince']);
            $data['startDateUntil'] = cleanStr($data['startDateUntil']);
            $data['startDate'] = cleanStr($data['startDate']);
            $data['startTimeCheck'] = cleanStr($data['startTimeCheck']);
            $data['startTimePeriod'] = cleanStr($data['startTimePeriod']);
            $data['startTimeSince'] = cleanStr($data['startTimeSince']);
            $data['startTimeUntil'] = cleanStr($data['startTimeUntil']);
            $data['startTime'] = cleanStr($data['startTime']);
            $data['deceasedDateCheck'] = cleanStr($data['deceasedDateCheck']);
            $data['deceasedDatePeriod'] = cleanStr($data['deceasedDatePeriod']);
            $data['deceasedDateSince'] = cleanStr($data['deceasedDateSince']);
            $data['deceasedDateUntil'] = cleanStr($data['deceasedDateUntil']);
            $data['deceasedDate'] = cleanStr($data['deceasedDate']);
            $data['deceasedTimeCheck'] = cleanStr($data['deceasedTimeCheck']);
            $data['deceasedTimePeriod'] = cleanStr($data['deceasedTimePeriod']);
            $data['deceasedTimeSince'] = cleanStr($data['deceasedTimeSince']);
            $data['deceasedTimeUntil'] = cleanStr($data['deceasedTimeUntil']);
            $data['deceasedTime'] = cleanStr($data['deceasedTime']);
            $data['deceasedInCheck'] = cleanStr($data['deceasedInCheck']);
            $data['deceasedProvinceCheck'] = cleanStr($data['deceasedProvinceCheck']);
            $data['deceasedLocationCheck'] = cleanStr($data['deceasedLocationCheck']);
            $data['funeralDateCheck'] = cleanStr($data['funeralDateCheck']);
            $data['funeralDatePeriod'] = cleanStr($data['funeralDatePeriod']);
            $data['funeralDateSince'] = cleanStr($data['funeralDateSince']);
            $data['funeralDateUntil'] = cleanStr($data['funeralDateUntil']);
            $data['funeralDate'] = cleanStr($data['funeralDate']);
            $data['funeralTimeCheck'] = cleanStr($data['funeralTimeCheck']);
            $data['funeralTimePeriod'] = cleanStr($data['funeralTimePeriod']);
            $data['funeralTimeSince'] = cleanStr($data['funeralTimeSince']);
            $data['funeralTimeUntil'] = cleanStr($data['funeralTimeUntil']);
            $data['funeralTime'] = cleanStr($data['funeralTime']);
            $data['funeralHomeCheck'] = cleanStr($data['funeralHomeCheck']);

            $select = '     SELECT      e.number, e.requestTime, es.arriveTime, fh.name, fh.funeralHomeID, l.name as locationName';
            $from = '       FROM        (Expedients e, Expedients_Services es, FuneralHomes fh)';
            $join = '       LEFT JOIN   DeceasedIn di ON e.deceasedLocation = deceasedInID
                            LEFT JOIN   Locations l ON di.location = l.locationID';
            $where = '      WHERE       e.expedientID = es.expedient AND
                                        e.funeralHome = fh.funeralHomeID AND
                                        e.leavingDate IS NULL';
            $orderBy = '    ORDER BY    fh.name';

            if($data['dateCheck'] == 'true'){
                if($data['datePeriod'] == 'true'){
                    $where .= " AND e.requestDate BETWEEN '" . $data['dateSince'] . "' AND '" . $data['dateUntil'] . "'";
                }elseif($data['dateCheckLength'] == 'true'){
                    if($data['month'] == 0){
                        switch($data['trimester']){
                            case '1':
                                $where .= ' AND YEAR(e.requestDate) = ' . $data['year'] . ' AND MONTH(e.requestDate) BETWEEN 1 AND 3';
                            break;
                            case '2':
                                $where .= ' AND YEAR(e.requestDate) = ' . $data['year'] . ' AND MONTH(e.requestDate) BETWEEN 4 AND 6';
                            break;
                            case '3':
                                $where .= ' AND YEAR(e.requestDate) = ' . $data['year'] . ' AND MONTH(e.requestDate) BETWEEN 7 AND 9';
                            break;
                            case '4':
                                $where .= ' AND YEAR(e.requestDate) = ' . $data['year'] . ' AND MONTH(e.requestDate) BETWEEN 10 AND 12';
                            break;
                        }
                    }else{
                        $where .= ' AND YEAR(e.requestDate) = ' . $data['year'] . ' AND MONTH(e.requestDate) = ' . $data['month'];
                    }
                }else{
                    $where .= " AND e.requestDate = '" . $data['date'] . "'";
                }
            }

            if($data['callTimeCheck'] == 'true'){
                if($data['callTimePeriod'] == 'true'){
                    $where .= " AND e.requestTime BETWEEN CAST('" . $data['callTimeSince'] . "' AS time) AND CAST('" . $data['callTimeUntil'] . "' AS time)";
                }else{
                    $where .= " AND e.requestTime = CAST('" . $data['callTime'] . "' AS time)";
                }
            }

            if($data['arriveTimeCheck'] == 'true'){
                if($data['arriveTimePeriod'] == 'true'){
                    $where .= " AND e.requestTime BETWEEN CAST('" . $data['arriveTimeSince'] . "' AS time) AND CAST('" . $data['arriveTimeUntil'] . "' AS time)";
                }else{
                    $where .= " AND e.requestTime = CAST('" . $data['arriveTime'] . "' AS time)";
                }
            }

            if($data['startDateCheck'] == 'true'){
                if($data['startDatePeriod'] == 'true'){
                    $where .= " AND e.funeralHomeEntryDate BETWEEN '" . $data['startDateSince'] . "' AND '" . $data['startDateUntil'] . "'";
                }else{
                    $where .= " AND e.funeralHomeEntryDate = '" . $data['startDate'] . "'";
                }
            }

            if($data['startTimeCheck'] == 'true'){
                if($data['startTimePeriod'] == 'true'){
                    $where .= " AND e.funeralHomeEntryTime BETWEEN CAST('" . $data['startTimeSince'] . "' AS time) AND CAST('" . $data['startTimeUntil'] . "' AS time)";
                }else{
                    $where .= " AND e.funeralHomeEntryTime = CAST('" . $data['startTime'] . "' AS time)";
                }
            }

            if($data['deceasedDateCheck'] == 'true'){
                if($data['deceasedDatePeriod'] == 'true'){
                    $where .= " AND e.deceasedDate BETWEEN '" . $data['deceasedDateSince'] . "' AND '" . $data['deceasedDateUntil'] . "'";
                }else{
                    $where .= " AND e.deceasedDate = '" . $data['deceasedDate'] . "'";
                }
            }

            if($data['deceasedTimeCheck'] == 'true'){
                if($data['deceasedTimePeriod'] == 'true'){
                    $where .= " AND e.deceasedTime BETWEEN CAST('" . $data['deceasedTimeSince'] . "' AS time) AND CAST('" . $data['deceasedTimeUntil'] . "' AS time)";
                }else{
                    $where .= " AND e.deceasedTime = CAST('" . $data['deceasedTime'] . "' AS time)";
                }
            }

            if($data['deceasedInCheck'] == 'true'){
                $where .= " AND (";
                foreach($data['deceasedIn'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= " e.deceasedLocation = $elem OR";
                }
                $where = rtrim($where, ' OR');
                $where .= ")";
            }elseif($data['deceasedProvinceCheck'] == 'true'){
                $where .= " AND (";
                foreach($data['deceasedProvinces'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= " '$elem' IN(SELECT l.province FROM DeceasedIn d, Locations l WHERE e.deceasedLocation = d.deceasedInID AND d.location = l.locationID AND l.leavingDate IS NULL AND e.leavingDate IS NULL) OR";
                }
                $where = rtrim($where, ' OR');
                $where .= ")";
            }elseif($data['deceasedLocationCheck'] == 'true'){
                $from .= ", DeceasedIn d, Locations l";
                $where .= " AND e.deceasedLocation = d.deceasedInID AND d.location = l.locationID AND l.locationID = " . $data['deceasedLocation'];
            }
            
            if($data['funeralDateCheck'] == 'true'){
                if($data['funeralDatePeriod'] == 'true'){
                    $where .= " AND e.funeralDate BETWEEN '" . $data['funeralDateSince'] . "' AND '" . $data['funeralDateUntil'] . "'";
                }else{
                    $where .= " AND e.funeralDate = '" . $data['funeralDate'] . "'";
                }
            }

            if($data['funeralTimeCheck'] == 'true'){
                if($data['funeralTimePeriod'] == 'true'){
                    $where .= " AND e.funeralTime BETWEEN CAST('" . $data['funeralTimeSince'] . "' AS time) AND CAST('" . $data['funeralTimeUntil'] . "' AS time)";
                }else{
                    $where .= " AND e.funeralTime = CAST('" . $data['funeralTime'] . "' AS time)";
                }
            }

            if($data['funeralHomeCheck'] == 'true'){
                $where .= " AND (";
                foreach($data['funeralHome'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= " e.funeralHome = $elem OR";
                }
                $where = rtrim($where, ' OR');
                $where .= ")";
            }

            $sql = $select . $from . $join . $where . $orderBy;
            $result = $db->query($sql);

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
        }

        /**
         * Filtra las cremaciones
         * 
         * @param array $data Filtros
         * @param array|null Datos filtrados
         */
        public function filterCremations($data){
            $db = new DbHandler;

            $data['dateCheck'] = cleanStr($data['dateCheck']);
            $data['datePeriod'] = cleanStr($data['datePeriod']);
            $data['dateSince'] = cleanStr($data['dateSince']);
            $data['dateUntil'] = cleanStr($data['dateUntil']);
            $data['dateCheckLength'] = cleanStr($data['dateCheckLength']);
            $data['month'] = cleanStr($data['month']);
            $data['trimester'] = cleanStr($data['trimester']);
            $data['year'] = cleanStr($data['year']);
            $data['date'] = cleanStr($data['date']);
            $data['deceasedInCheck'] = cleanStr($data['deceasedInCheck']);
            $data['deceasedProvinceCheck'] = cleanStr($data['deceasedProvinceCheck']);
            $data['deceasedLocationCheck'] = cleanStr($data['deceasedLocationCheck']);
            $data['crematoriumCheck'] = cleanStr($data['crematoriumCheck']);
            $data['cremationDateCheck'] = cleanStr($data['cremationDateCheck']);
            $data['cremationDatePeriod'] = cleanStr($data['cremationDatePeriod']);
            $data['cremationDateSince'] = cleanStr($data['cremationDateSince']);
            $data['cremationDateUntil'] = cleanStr($data['cremationDateUntil']);
            $data['cremationDate'] = cleanStr($data['cremationDate']);
            $data['cremationTimeCheck'] = cleanStr($data['cremationTimeCheck']);
            $data['cremationTimePeriod'] = cleanStr($data['cremationTimePeriod']);
            $data['cremationTimeSince'] = cleanStr($data['cremationTimeSince']);
            $data['cremationTimeUntil'] = cleanStr($data['cremationTimeUntil']);
            $data['cremationTime'] = cleanStr($data['cremationTime']);
            $data['clientCheck'] = cleanStr($data['clientCheck']);
            $data['introductionCheck'] = cleanStr($data['introductionCheck']);
            $data['introduction'] = cleanStr($data['introduction']);
            $data['waitOnRoomCheck'] = cleanStr($data['waitOnRoomCheck']);
            $data['waitOnRoom'] = cleanStr($data['waitOnRoom']);
            $data['vaseBioCheck'] = cleanStr($data['vaseBioCheck']);
            $data['vaseBio'] = cleanStr($data['vaseBio']);

            $select = '     SELECT      e.requestDate, e.number, e.deceasedName, e.deceasedSurname, c.name as crematoriumName, ev.start, YEAR(ev.start) as cremationYear';
            $from = '       FROM        (Expedients e, Crematoriums c, Events ev)';
            $join = '       LEFT JOIN   DeceasedIn di ON e.deceasedLocation = deceasedInID
                            LEFT JOIN   Locations l ON di.location = l.locationID';
            $where = '      WHERE       e.crematorium = c.crematoriumID AND
                                        e.crematoriumEvent = ev.ID AND
                                        e.leavingDate IS NULL';
            $orderBy = '    ORDER BY    e.requestDate';

            if($data['dateCheck'] == 'true'){
                if($data['datePeriod'] == 'true'){
                    $where .= " AND e.requestDate BETWEEN '" . $data['dateSince'] . "' AND '" . $data['dateUntil'] . "'";
                }elseif($data['dateCheckLength'] == 'true'){
                    if($data['month'] == 0){
                        switch($data['trimester']){
                            case '1':
                                $where .= ' AND YEAR(e.requestDate) = ' . $data['year'] . ' AND MONTH(e.requestDate) BETWEEN 1 AND 3';
                            break;
                            case '2':
                                $where .= ' AND YEAR(e.requestDate) = ' . $data['year'] . ' AND MONTH(e.requestDate) BETWEEN 4 AND 6';
                            break;
                            case '3':
                                $where .= ' AND YEAR(e.requestDate) = ' . $data['year'] . ' AND MONTH(e.requestDate) BETWEEN 7 AND 9';
                            break;
                            case '4':
                                $where .= ' AND YEAR(e.requestDate) = ' . $data['year'] . ' AND MONTH(e.requestDate) BETWEEN 10 AND 12';
                            break;
                        }
                    }else{
                        $where .= ' AND YEAR(e.requestDate) = ' . $data['year'] . ' AND MONTH(e.requestDate) = ' . $data['month'];
                    }
                }else{
                    $where .= " AND e.requestDate = '" . $data['date'] . "'";
                }
            }

            if($data['deceasedInCheck'] == 'true'){
                $where .= " AND (";
                foreach($data['deceasedIn'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= " e.deceasedLocation = $elem OR";
                }
                $where = rtrim($where, ' OR');
                $where .= ")";
            }elseif($data['deceasedProvinceCheck'] == 'true'){
                $where .= " AND (";
                foreach($data['deceasedProvinces'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= " '$elem' IN(SELECT l.province FROM DeceasedIn d, Locations l WHERE e.deceasedLocation = d.deceasedInID AND d.location = l.locationID AND l.leavingDate IS NULL AND e.leavingDate IS NULL) OR";
                }
                $where = rtrim($where, ' OR');
                $where .= ")";
            }elseif($data['deceasedLocationCheck'] == 'true'){
                $where .= " AND (";
                foreach($data['deceasedLocation'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= " '$elem' IN(SELECT l.province FROM DeceasedIn d, Locations l WHERE e.deceasedLocation = d.deceasedInID AND d.location = l.locationID AND l.leavingDate IS NULL AND e.leavingDate IS NULL) OR";
                }
                $where = rtrim($where, ' OR');
                $where .= ")";
            }

            if($data['crematoriumCheck'] == 'true'){
                $where .= " AND (";
                foreach($data['crematorium'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= " e.crematorium = $elem OR";
                }
                $where = rtrim($where, ' OR');
                $where .= ")";
            }

            if($data['cremationDateCheck'] == 'true'){
                if($data['cremationDatePeriod'] == 'true'){
                    $where .= " AND ev.start BETWEEN '" . $data['cremationDateSince'] . "' AND '" . $data['cremationDateUntil'] . "'";
                }else{
                    $where .= " AND ev.start = '" . $data['cremationDate'] . "'";
                }
            }

            if($data['cremationTimeCheck'] == 'true'){
                if($data['cremationTimePeriod'] == 'true'){
                    $where .= " AND TIME(ev.start) BETWEEN CAST('" . $data['cremationTimeSince'] . "' AS time) AND CAST('" . $data['cremationTimeUntil'] . "' AS time)";
                }else{
                    $where .= " AND TIME(ev.start) = CAST('" . $data['cremationTime'] . "' AS time)";
                }
            }

            if($data['clientCheck'] == 'true'){
                $where .= " AND (";
                foreach($data['client'] as $elem){
                    $elem = cleanStr($elem);
                    $where .= " e.crematoriumClient = $elem OR";
                }
                $where = rtrim($where, ' OR');
                $where .= ")";
            }

            if($data['introductionCheck'] == 'true'){
                if($data['introduction'] == 'true'){
                    $where .= " AND e.crematoriumIntroduction = 1";
                }else{
                    $where .= " AND e.crematoriumIntroduction = 0";
                }
            }

            if($data['waitOnRoomCheck'] == 'true'){
                if($data['waitOnRoom'] == 'true'){
                    $where .= " AND e.crematoriumWaitOnRoom = 1";
                }else{
                    $where .= " AND e.crematoriumWaitOnRoom = 0";
                }
            }

            if($data['vaseBioCheck'] == 'true'){
                if($data['vaseBio'] == 'true'){
                    $where .= " AND e.crematoriumVaseBio = 1";
                }else{
                    $where .= " AND e.crematoriumVaseBio = 0";
                }
            }

            $sql = $select . $from . $join . $where . $orderBy;
            $result = $db->query($sql);
            $orderedByDate = $db->resultToArray($result);

            $select = '     SELECT      c.name as crematoriumName';
            $orderBy = '    ORDER BY    c.name';
            $sql = $select . $from . $join . $where . $orderBy;
            $result = $db->query($sql);
            $orderedByCrematorium = $db->resultToArray($result);

            $select = '     SELECT      YEAR(ev.start) as cremationYear';
            $orderBy = '    ORDER BY    YEAR(ev.start)';
            $sql = $select . $from . $join . $where . $orderBy;
            $result = $db->query($sql);
            $orderedByYear = $db->resultToArray($result);

            $select = '     SELECT      YEAR(ev.start) as year, MONTH(ev.start) as month';
            $orderBy = '    ORDER BY    YEAR(ev.start), MONTH(ev.start)';
            $sql = $select . $from . $join . $where . $orderBy;
            $result = $db->query($sql);
            $orderedByMonth = $db->resultToArray($result);

            $select = '     SELECT      e.number, l.name';
            $orderBy = '    ORDER BY    l.name';
            $sql = $select . $from . $join . $where . $orderBy;
            $result = $db->query($sql);
            $orderedByLocation = $db->resultToArray($result);

            return mysqli_num_rows($result) > 0 ? array($orderedByDate, $orderedByCrematorium, $orderedByYear, $orderedByMonth, $orderedByLocation) : null;
        }

        /**
         * Obtiene los registros civiles
         * 
         * @param string $data Dato a filtrar
         * @return array
         */
        public function getCivilRegisters($data){
            $db = new DbHandler;

            $data = cleanStr($data);

            $result = $db->query("  SELECT      deceasedTribunal as name
                                    FROM        Expedients
                                    WHERE       deceasedTribunal != '' AND
                                                deceasedTribunal LIKE '%$data%'
                                    GROUP BY    deceasedTribunal");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }

        /**
         * Comprobar si se ha enviado un email notificando el aviso a los curas para mostrar alert
         * 
         * @return array
         */
        public function isPriestNotified(){
            $db = new DbHandler;

            $currentDatetime = date('Y-m-d', time());
          
            $result = $db->query("  SELECT      e.funeralDate, e.funeralTime, e.number, p.name, p.surname, p.mobilePhone, e.expedientID, e.tpv
                                    FROM        Services_Priests sp, Expedients_Services es, Expedients e, Priests p
                                    WHERE       sp.service = es.expedient AND
                                                sp.priest = p.priestID AND   
                                                sp.notified = 0 AND
                                                es.expedient = e.expedientID AND
                                                e.funeralDate = '$currentDatetime' AND                                          
                                                es.priestsNotification = 1 AND
                                                e.leavingDate IS NULL 
                                    ORDER BY    e.number");

            if(mysqli_num_rows($result) > 0){
                $priestsEvents = $db->resultToArray($result);
            }else{
                $priestsEvents = null;
            }

            return $priestsEvents;
        }

        /**
         * Comprobar si se ha enviado un email notificando el aviso a los enterradores para mostrar alert
         * 
         * @return array
         */
        public function isGravediggerNotified(){
            $db = new DbHandler;
            
            $currentDatetime = date('Y-m-d', time());
          
            $result = $db->query("  SELECT  e.funeralDate, e.funeralTime, e.number, g.name, g.surname, e.expedientID, e.tpv
                                    FROM    Expedients_Services es, Expedients e, Services_Gravediggers sg, Gravediggers g
                                    WHERE   sg.gravedigger = g.gravediggerID AND 
                                            sg.service = es.expedient AND
                                            sg.notified = 0 AND
                                            es.expedient = e.expedientID AND
                                            es.gravediggersNotification = 1 AND
                                            e.funeralDate = '$currentDatetime' AND 
                                            e.leavingDate IS NULL");

            if(mysqli_num_rows($result) > 0){
                $gravediggersEvents = $db->resultToArray($result);
            }else{
                $gravediggersEvents = null;
            }

            return $gravediggersEvents;            
        }

        /**
         * Comprobar si se ha enviado un email notificando el aviso a los porteadores para mostrar alert
         * 
         * @return array
         */
        public function isCarrierNotified(){
            $db = new DbHandler;
            
            $currentDatetime = date('Y-m-d', time());
            
            $result = $db->query("  SELECT  e.funeralDate, e.funeralTime, e.number, c.name, c.surname, e.expedientID, e.tpv
                                    FROM    Expedients_Services es, Expedients e, Services_Carriers sc, Carriers c
                                    WHERE   sc.carrier = c.carrierID AND
                                            sc.confirmed = 0 AND
                                            sc.service = es.expedient AND
                                            es.carriersNotification = 1 AND
                                            es.expedient = e.expedientID AND
                                            e.funeralDate = '$currentDatetime' AND 
                                            e.leavingDate IS NULL");

            if(mysqli_num_rows($result) > 0){
                $carriers = $db->resultToArray($result);
            }else{
                $carriers = null;
            }
            
            return $carriers;            
        }

        /**
         * Comprobar si se ha enviado un email notificando el aviso al coro para mostrar alert
         * 
         * @return array
         */
        public function isChoirNotified(){
            $db = new DbHandler;
            
            $currentDatetime = date('Y-m-d', time());
          
            $result = $db->query("  SELECT  e.funeralDate, e.funeralTime, e.number, c.name, e.expedientID, e.tpv
                                    FROM    Expedients_Services es, Expedients e, Services_Choirs sc, Choirs c
                                    WHERE   sc.service = es.expedient AND
                                            sc.choir = c.choirID AND
                                            sc.notified = 0 AND
                                            es.choirsNotification = 1 AND
                                            es.expedient = e.expedientID AND
                                            e.funeralDate = '$currentDatetime' AND
                                            e.leavingDate IS NULL");

            if(mysqli_num_rows($result) > 0){
                $choir = $db->resultToArray($result);
            }else{
                $choir = null;
            }

            return $choir;            
        }

        /**
         * Comprobar si se ha enviado un email notificando el aviso al campanero para mostrar alert
         * 
         * @return array
         */
        public function isBellringerNotified(){
            $db = new DbHandler;
            
            $currentDatetime = date('Y-m-d', time());
          
            $result = $db->query("  SELECT  e.funeralDate, e.funeralTime, e.number, b.name, e.expedientID, e.tpv
                                    FROM    Expedients_Services es, Expedients e, Services_Bellringers sb, BellRingers b
                                    WHERE   sb.service = es.expedient AND
                                            sb.bellringer = b.ID AND
                                            sb.notified = 0 AND
                                            es.bellringersNotification = 1 AND
                                            es.expedient = e.expedientID AND
                                            e.funeralDate = '$currentDatetime' AND
                                            e.leavingDate IS NULL ");

            if(mysqli_num_rows($result) > 0){
                $bellringer = $db->resultToArray($result);
            }else{
                $bellringer = null;
            }

            return $bellringer;            
        }

        /**
         * Comprobar si se ha enviado un email notificando el aviso a la policia para mostrar alert
         * 
         * @return array
         */
        public function isPoliceNotified(){
            $db = new DbHandler;
            
            $currentDatetime = date('Y-m-d', time());
          
            $result = $db->query("  SELECT  e.funeralDate, e.funeralTime, e.number, e.expedientID, e.tpv
                                    FROM    Expedients_Services es, Expedients e
                                    WHERE   es.expedient = e.expedientID  AND
                                            e.funeralDate = '$currentDatetime' AND 
                                            e.leavingDate IS NULL AND
                                            es.policeNotApply IN (NULL, 0) AND
                                            es.policeNotified IN (NULL, 0) AND
                                            es.policeNotification = 1");

            if(mysqli_num_rows($result) > 0){
                $police = $db->resultToArray($result);
            }else{
                $police = null;
            }

            return $police;            
        }

        /**
         * Comprobar si se ha enviado un email notificando web no confirmada para mostrar alert
         * 
         * @return array
         */
        public function isWebNotified(){
            $db = new DbHandler;
            
            $currentDatetime = date('Y-m-d', time());
          
            $result = $db->query("  SELECT  e.funeralDate, e.funeralTime, e.number, e.expedientID, e.tpv
                                    FROM    Expedients_Services es, Expedients e
                                    WHERE   es.expedient = e.expedientID  AND
                                            e.funeralDate = '$currentDatetime' AND 
                                            e.leavingDate IS NULL AND
                                            es.webNotApply IN (NULL, 0) AND
                                            es.webConfirm IN (NULL, 0) AND 
                                            es.webNotification = 1");

            if(mysqli_num_rows($result) > 0){
                $web = $db->resultToArray($result);
            }else{
                $web = null;
            }

            return $web;            
        }

        /**
         * Comprobar si se ha enviado un email notificando acta de preparacion no confirmada para mostrar alert
         * 
         * @return array
         */
        public function isPreparationNotified(){
            $db = new DbHandler;
            
            $currentDatetime = date('Y-m-d', time());
          
            $result = $db->query("  SELECT  e.funeralDate, e.funeralTime, e.number, e.expedientID, e.tpv
                                    FROM    Expedients_Services es, Expedients e
                                    WHERE   es.expedient = e.expedientID  AND
                                            e.funeralDate = '$currentDatetime' AND 
                                            e.leavingDate IS NULL AND
                                            es.preparationNotApply IN (NULL, 0) AND
                                            es.preparationConfirm IN (NULL, 0) AND 
                                            es.preparationNotification = 1");

            if(mysqli_num_rows($result) > 0){
                $preparation = $db->resultToArray($result);
            }else{
                $preparation = null;
            }

            return $preparation;            
        }

        /**
         * Comprobar si se ha enviado un email notificando certificado médico no entregado para mostrar alert
         * 
         * @return array
         */
        public function isDoctorNotified(){
            $db = new DbHandler;
            
            $currentDatetime = date('Y-m-d', time());
          
            $result = $db->query("  SELECT  e.funeralDate, e.funeralTime, e.number, e.expedientID, e.tpv
                                    FROM    Expedients_Services es, Expedients e
                                    WHERE   es.expedient = e.expedientID  AND
                                            e.funeralDate = '$currentDatetime' AND 
                                            e.leavingDate IS NULL AND
                                            es.doctorNotApply IN (NULL, 0) AND
                                            es.doctorDone IN (NULL, 0) AND 
                                            es.doctorNotification = 1");

            if(mysqli_num_rows($result) > 0){
                $doctor = $db->resultToArray($result);
            }else{
                $doctor = null;
            }

            return $doctor;            
        }

        /**
         * Comprobar si se ha enviado un email notificando juzgado no entregado para mostrar alert
         * 
         * @return array
         */
        public function isTribunalNotified(){
            $db = new DbHandler;
            
            $currentDatetime = date('Y-m-d', time());
          
            $result = $db->query("  SELECT  e.funeralDate, e.funeralTime, e.number, e.expedientID, e.tpv
                                    FROM    Expedients_Services es, Expedients e
                                    WHERE   es.expedient = e.expedientID  AND
                                            e.funeralDate = '$currentDatetime' AND 
                                            e.leavingDate IS NULL AND
                                            es.tribunalNotApply IN (NULL, 0) AND
                                            es.tribunalDeliver IN (NULL, 0) AND 
                                            es.tribunalNotification = 1");

            if(mysqli_num_rows($result) > 0){
                $doctor = $db->resultToArray($result);
            }else{
                $doctor = null;
            }

            return $doctor;            
        }

        /**
         * Comprobar si se ha enviado un email notificando control no realizado para mostrar alert
         * 
         * @return array
         */
        public function isControlNotified(){
            $db = new DbHandler;
            
            $currentDatetime = date('Y-m-d', time());
          
            $result = $db->query("  SELECT  e.funeralDate, e.funeralTime, e.number, e.expedientID, e.tpv
                                    FROM    Expedients_Services es, Expedients e
                                    WHERE   es.expedient = e.expedientID  AND
                                            e.funeralDate = '$currentDatetime' AND 
                                            e.leavingDate IS NULL AND
                                            es.revReqCheck = 1 AND
                                            es.control = 0 AND 
                                            es.controlNotification = 1");

            if(mysqli_num_rows($result) > 0){
                $control = $db->resultToArray($result);
            }else{
                $control = null;
            }

            return $control;            
        }

        /**
         * Comprobar si se ha enviado un email notificando recordatorio no creado para mostrar alert
         * 
         * @return array
         */
        public function isReminderNotified(){
            $db = new DbHandler;
            
            $currentDatetime = date('Y-m-d', time());
          
            $result = $db->query("  SELECT  e.funeralDate, e.funeralTime, e.number, e.expedientID, e.tpv
                                    FROM    Expedients e, Expedients_Documents ed, Expedients_Services es
                                    WHERE   ed.name = 'Recordatorio' AND
                                            ed.nameFile = '' AND
                                            ed.expedient = e.expedientID AND
                                            e.funeralDate = '$currentDatetime' AND
                                            es.expedient = e.expedientID AND
                                            es.reminderNotifications = 1 AND
                                            e.leavingDate IS NULL");

            if(mysqli_num_rows($result) > 0){
                $reminder = $db->resultToArray($result);
            }else{
                $reminder = null;
            }
            return $reminder;            
        }

        /**
         * Comprobar si se ha enviado un email notificando flores no confirmadas para mostrar alert
         * 
         * @return array
         */
        public function isFlowerNotified(){
            $db = new DbHandler;
            
            $currentDatetime = date('Y-m-d', time());

            $result = $db->query("  SELECT	e.expedientID, p.name as product, pm.name as model, e.funeralDate, e.funeralTime, e.number, e.tpv
                                    FROM	Expedients e, Expedients_Hirings eh, Products p, Products_Models pm, Services_Auto sa, Expedients_Services es, Actions ac
                                    WHERE	e.funeralDate = '$currentDatetime' AND
                                            e.leavingDate IS NULL AND
                                            e.status != 5 AND
                                            es.expedient = e.expedientID AND
                                            eh.expedient = e.expedientID AND
                                            eh.check = 1 AND
                                            eh.product = p.productID AND
                                            p.blockBelow = 3 AND
                                            eh.model = pm.productModelID AND
                                            sa.service = e.expedientID AND
                                            sa.model = pm.productModelID AND
                                            sa.value = 0 AND 
                                            es.flowerNotification IS NULL AND
                                            sa.action = ac.ID AND
                                            ac.label LIKE 'confirm%'");

            if(mysqli_num_rows($result) > 0){
                $flower = $db->resultToArray($result);
            }else{
                $flower = null;
            }

            return $flower;            
        }

        /**
         * Comprobar si se ha enviado un email notificando buses no confirmadas para mostrar alert
         * 
         * @return array
         */
        public function isBusNotified(){
            $db = new DbHandler;
            
            $currentDatetime = date('Y-m-d', time());
          
            $result = $db->query("  SELECT	e.expedientID, p.name as product, pm.name as model, e.funeralDate, e.funeralTime, e.number, e.tpv
                                    FROM	Expedients e, Expedients_Hirings eh, Products p, Products_Models pm, Expedients_Services es
                                    WHERE	e.funeralDate = '$currentDatetime' AND
                                            e.leavingDate IS NULL AND
                                            e.status != 5 AND
                                            es.expedient = e.expedientID AND
                                            eh.expedient = e.expedientID AND
                                            eh.check = 1 AND
                                            eh.product = p.productID AND
                                            p.blockBelow = 4 AND
                                            eh.model = pm.productModelID AND
                                            p.name LIKE '%bus%' AND
                                            es.busNotification = 1");

            if(mysqli_num_rows($result) > 0){
                $bus = $db->resultToArray($result);
            }else{
                $bus = null;
            }

            return $bus;            
        }

        /**
         * Comprobar si se ha enviado un email notificando taxis no avisados para mostrar alert
         * 
         * @return array
         */
        public function isTaxiNotified(){
            $db = new DbHandler;
            
            $currentDatetime = date('Y-m-d', time());
          
            $result = $db->query("  SELECT	e.expedientID, p.name as product, pm.name as model, e.funeralDate, e.funeralTime, e.number, e.tpv
                                    FROM	Expedients e, Expedients_Hirings eh, Products p, Products_Models pm, Expedients_Services es
                                    WHERE	e.funeralDate = '$currentDatetime' AND
                                            e.leavingDate IS NULL AND
                                            e.status != 5 AND
                                            es.expedient = e.expedientID AND
                                            eh.expedient = e.expedientID AND
                                            eh.check = 1 AND
                                            eh.product = p.productID AND
                                            p.blockBelow = 4 AND
                                            eh.model = pm.productModelID AND
                                            p.name LIKE '%taxi%' AND
                                            es.taxiNotification = 1");

            if(mysqli_num_rows($result) > 0){
                $taxi = $db->resultToArray($result);
            }else{
                $taxi = null;
            }

            return $taxi;            
        }

        /**
         * Comprueba si un expediente existe
         * 
         * @param int $expedient Id del expediente
         * @return bool
         */
        public function existsExpedient($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT  e.expedientID, e.tpv
                                    FROM    Expedients e
                                    WHERE   e.expedientID = $expedient AND
                                            e.leavingDate IS NULL");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0];
        }

        /**
         * Obtiene los expedientes pendiente de facturacion 
         * @return array
         */
        public function getExpedientStatusPendingInvoices(){
            $db = new DbHandler;            
            
            $result = $db->query("  SELECT  e.expedientID, e.number, e.tpv, CONCAT(e.deceasedName, ' ' , e.deceasedSurname) as deceasedName
                                    FROM    Expedients e 
                                    WHERE   e.status = 3 AND e.leavingDate IS NULL");

            if(mysqli_num_rows($result) > 0){
                $expedients = $db->resultToArray($result);                           
            }else{
                $expedients = null;
            }

            return $expedients;  
        }

        /**
         * Obtiene los expedientes pendiente de revision 
         * @return array
         */
        public function getExpedientStatusPendingRevision(){
            $db = new DbHandler;            
            
            $result = $db->query("  SELECT  e.expedientID, e.number, e.tpv, CONCAT(e.deceasedName, ' ' , e.deceasedSurname) as deceasedName
                                    FROM    Expedients e 
                                    WHERE   e.status = 6 AND e.leavingDate IS NULL");

            if(mysqli_num_rows($result) > 0){
                $expedients = $db->resultToArray($result);                           
            }else{
                $expedients = null;
            }

            return $expedients;  
        }

        /**
         * Comprueba si un expediente tiene literales
         * 
         * @param int $expedient Id del expediente
         * @return bool
         */
        public function hasLiterals($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT  e.literal
                                    FROM    Expedients e
                                    WHERE   e.expedientID = $expedient AND
                                            e.literal = 1 AND
                                            e.leavingDate IS NULL");

            return mysqli_num_rows($result) == 0 ? false : true;
        }

        /**
         * Obtiene los datos para la orden de cremación
         * 
         * @param int $expedient Id del expediente
         * @return bool
         */
        public function getCremationData($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT      e.deceasedName, e.deceasedDate, e.deceasedSurname, e.deceasedNIF, e.deceasedGender, s.name as 'technicalName', s.surname as 'technicalSurname', 
                                                e.crematoriumIntroduction, e.crematoriumWaitOnRoom, e.crematoriumVaseBio, e.crematoriumPacemaker, e.ecologicCoffin, e.authDate, e.authTime,
                                                e.authPlace, e.crematoriumArriveTime, ev.start
                                    FROM        Expedients e
                                    LEFT JOIN   Staff s ON e.crematoriumTechnical = s.ID
                                    LEFT JOIN   Events ev ON ev.expedient = e.expedientID AND ev.type = 1
                                    WHERE       e.expedientID =  $expedient AND
                                                e.leavingDate IS NULL");

            if(mysqli_num_rows($result) > 0){
                $expedients = $db->resultToArray($result);                           
            }else{
                $expedients = null;
            }

            return $expedients;
        }

        /**
         * Obtiene los datos para el resumen de cremación
         * 
         * @param int $expedient Id del expediente
         * @return bool
         */
        public function getCrematoriumSummary($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("   SELECT     e.deceasedGender, e.deceasedName, e.deceasedSurname, e.number, e.deceasedRoom, e.funeralTime, e.authDate, e.authName, e.authTime, e.authPlace,
                                                e.cremation, e.crematoriumIntroduction, e.crematoriumWaitOnRoom, e.crematoriumVaseBio, e.crematoriumPacemaker, e.ecologicCoffin,
                                                cr.name as crematorium,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, c.name) AS cemetery,
                                                IF(e.churchLabel = 'Otro', e.otherCeremony, ch.name) AS church,
                                                m.name AS mortuary,
                                                es.routeSummary, es.notesSummary, es.churchSummary, es.licenseSummary, es.deliveryReceiptSummary, es.reminderSummary,
                                                CONCAT(s.name, ' ' , s.surname) as technicalName, 
                                                CONCAT(s2.name, ' ' , s2.surname) as crematoriumWhoDelivered, es.crematoriumNotes, es.crematoriumProgramOven,
                                                CONCAT(s3.name, ' ' , s3.surname) as crematoriumWhoProgramOven,
                                                es.crematoriumFirstGenerateDocDate,
                                                CONCAT(u.name, ' ', u.surname) as crematoriumFirstGenerateDocUser
                                    FROM        (Expedients e, Expedients_Services es)
                                    LEFT JOIN   Cemeteries c ON e.cemetery = c.cemeteryID
                                    LEFT JOIN   Churches ch ON e.church = ch.churchID
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   Crematoriums cr ON e.crematorium = cr.crematoriumID
                                    LEFT JOIN   Staff s ON e.crematoriumTechnical = s.ID
                                    LEFT JOIN   Staff s2 ON es.crematoriumWhoDelivered = s2.ID
                                    LEFT JOIN   Staff s3 ON es.crematoriumWhoProgramOven  = s3.ID
                                    LEFT JOIN   Users u ON es.crematoriumFirstGenerateDocUser = u.userID
                                    WHERE       expedientID = $expedient AND
                                                e.expedientID = es.expedient");

            if(mysqli_num_rows($result) > 0){
                $expedients = $db->resultToArray($result);                           
            }else{
                $expedients = null;
            }

            return $expedients;
        }

        /**
         * Actualiza los datos cuando se genera el resumen por primera vez
         *
         * @param array $expedientID Expediente id
         * @return bool
         */
        public function updateFirstSummaryDoc($expedientID){
            $db = new DbHandler;
            
            $date = time();

            return $db->query(" UPDATE  Expedients_Services
                                SET     crematoriumFirstGenerateDocUser = " . $_SESSION['user'] . ",
                                        crematoriumFirstGenerateDocDate = '" . $date . "'
                                WHERE   expedient = " . $expedientID . "");
        }

        /**
         * Almacena los datos de solicitud de firma de un pdf
         */
        public function saveSignPDF($expedientID, $docName, $code){
            $db = new DbHandler;

            $expedientID = cleanStr($expedientID);
            $docName = cleanStr($docName);
            $code = cleanStr($code);

            return  $db->query("INSERT INTO PdfSign (expedient, docName, code, signed) VALUES ($expedientID, '$docName', '$code', 0)"); 
        }

        /**
         * Almacena los datos de solicitud de firma de un pdf para el editor personalizado
         */
        public function saveSignPDFEditor($expedient, $doc, $code){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $doc = cleanStr($doc);
            $code = cleanStr($code);

            return  $db->query("INSERT INTO Pdf_Sign_Editor (expedient, doc, code, signed) VALUES ($expedient, $doc, '$code', 0)"); 
        }

        /**
         * Actualiza un pdf como firmado y devuelve los datos del expediente 
         */
        public function updateSignPDF($code){
            $db = new DbHandler;

            $code = cleanStr($code);

            //Comprobar que existe y obtener los datos
            $result = $db->query("SELECT * FROM PdfSign WHERE code = '".$code."'");

            if(mysqli_num_rows($result) > 0){

                $pdf = $db->resultToArray($result);              
                $db->query("UPDATE PdfSign SET signed = 1 WHERE code = '".$code."'");  

            }else{
                $pdf = null;
            }

            return $pdf;
        }

        /**
         * Actualiza un pdf como firmado y devuelve los datos del expediente 
         */
        public function updateSignPDFEditor($code){
            $db = new DbHandler;

            $code = cleanStr($code);

            //Comprobar que existe y obtener los datos
            $result = $db->query("SELECT * FROM Pdf_Sign_Editor WHERE code = '".$code."'");

            if(mysqli_num_rows($result) > 0){

                $pdf = $db->resultToArray($result);              
                $db->query("UPDATE Pdf_Sign_Editor SET signed = 1 WHERE code = '".$code."'");  

            }else{
                $pdf = null;
            }

            return $pdf;
        }

        /**
         * Elimina de BD las tuplas insertadas del mismo documento y expediente para que solo quede la última firmada
         */
        public function deleteOld($expedientID, $docName, $code){
            $db = new DbHandler;

            $expedientID = cleanStr($expedientID);
            $docName = cleanStr($docName);
            $code = cleanStr($code);

            //Obtener todas las tuplas que no sean las del documento actual firmado
            $result = $db->query("  SELECT  ID 
                                    FROM    PdfSign 
                                    WHERE   code != '".$code."' AND
                                            docName = '".$docName."' AND
                                            expedient = $expedientID");           

            if(mysqli_num_rows($result) > 0){

                $pdfs = $db->resultToArray($result);   
                foreach($pdfs as $key => $value){                    
                    $db->query("DELETE FROM PdfSign WHERE ID = ".$value['ID']."");  
                } 
            }
        }

        /**
         * Elimina de BD las tuplas insertadas del mismo documento y expediente para que solo quede la última firmada
         */
        public function deleteOldEditor($expedient, $doc, $code){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $doc = cleanStr($doc);
            $code = cleanStr($code);

            //Obtener todas las tuplas que no sean las del documento actual firmado
            $result = $db->query("  SELECT  ID 
                                    FROM    Pdf_Sign_Editor 
                                    WHERE   code != '$code' AND
                                            doc = $doc AND
                                            expedient = $expedient");           

            if(mysqli_num_rows($result) > 0){

                $pdfs = $db->resultToArray($result);   
                foreach($pdfs as $key => $value){                    
                    $db->query("DELETE FROM Pdf_Sign_Editor WHERE ID = ".$value['ID']."");  
                } 
            }
        }

        /**
         * Comprueba si un exediente está firmado
         */
        public function checkPDFsigned($expedientID, $docName){
            $db = new DbHandler;

            $expedientID = cleanStr($expedientID);
            $docName = cleanStr($docName);

            //Obtener todas las tuplas que no sean las del documento actual firmado
            $result = $db->query("  SELECT  ID FROM PdfSign 
                                    WHERE   docName = '".$docName."' AND
                                            expedient = $expedientID AND
                                            signed = 1");           

            if(mysqli_num_rows($result) > 0){
               return true;
            }else{
                return false;
            }
        }
        /**
         * Elimina los datos de la tabla de firmas despues de borrar un documento
         */
        public function deleteSignedDocs($expedientID, $docName){
            $db = new DbHandler;

            $expedientID = cleanStr($expedientID);
            $docName = cleanStr($docName);
            
            //Obtener todas las tuplas sean las del documento y expediente
            $result = $db->query("  SELECT  ID FROM PdfSign 
                                    WHERE   docName = '".$docName."' AND
                                            expedient = $expedientID");           

            if(mysqli_num_rows($result) > 0){

                $pdfs = $db->resultToArray($result);   
                foreach($pdfs as $key => $value){                    
                    $db->query("DELETE FROM PdfSign WHERE ID = ".$value['ID']."");  
                   
                } 
            }
        }

        /**
         * Obtiene los expedientes por nombre
         *
         * @param string $name Nombre del tanatorio
         * @return array
         */
        public function searchByName($name, $expedient){
            $db = new DbHandler;

            $name = cleanStr($name);
            $expedient = cleanStr($expedient);

            if($expedient == null){

                $result = $db->query("  SELECT  e.expedientID, e.number, e.deceasedName, e.deceasedSurname
                                        FROM    Expedients e
                                        WHERE   e.leavingDate IS NULL AND (e.number LIKE '%$name%' OR e.deceasedName LIKE '%$name%' OR e.deceasedSurname LIKE '%$name%')");      
            }else{
                $result = $db->query("  SELECT  e.expedientID, e.number, e.deceasedName, e.deceasedSurname
                                        FROM    Expedients e
                                        WHERE   e.leavingDate IS NULL AND (e.number LIKE '%$name%' OR e.deceasedName LIKE '%$name%' OR e.deceasedSurname LIKE '%$name%')");
            }   
            
            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }

        /**
         * Obtiene los expedientes por nombre
         *
         * @param string $name Nombre del tanatorio
         * @return array
         */
        public function searchByNameOrderObituary($name){
            $db = new DbHandler;

            $name = cleanStr($name);

            $result = $db->query("  SELECT      e.expedientID, e.number, e.deceasedName, e.deceasedSurname, e.status, e.tpv
                                    FROM        Expedients e, Expedients_Status es
                                    WHERE       e.leavingDate IS NULL AND
                                                (
                                                    e.number LIKE '%$name%' OR
                                                    e.deceasedName LIKE '%$name%' OR
                                                    e.deceasedSurname LIKE '%$name%'
                                                ) AND
                                                e.status != 4 AND
                                                e.status != 5 AND
                                                e.status = es.expedientStatusID
                                    ORDER BY    es.orderBy ASC, e.status ASC, e.entryDate DESC");
            
            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result);
        }

        /**
         * Obtiene los datos de un pedido no conforme para pdf de no conformidad
         * 
         * @param int $order Pedido
         * @return array
         */
        public function getOrderNonApproval($order){
            $db = new DbHandler;

            $order = cleanStr($order);

            $result = $db->query("  SELECT  o.date, o.nonApproval, o.correctiveAction,
                                            s.name
                                    FROM    Orders o, Suppliers s
                                    WHERE   o.ID = $order AND
                                            o.supplier = s.supplierID");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0];
        }

        /**
         * Comprueba si el editor de esquelas está bloqueado
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de esquela
         * @param int $model Modelo de esquela
         * @return bool
         */
        public function isObituaryEditorLocked($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);

            $result = $db->query("  SELECT  eo.isOpen
                                    FROM    Expedients_Obituaries eo
                                    WHERE   eo.expedient = $expedient AND
                                            eo.type = $type AND
                                            eo.model = $model");

            return mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['isOpen'];
        }

        /**
         * Bloquea el editor de esquelas
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de esquela
         * @param int $model Modelo de esquela
         * @return bool
         */
        public function lockObituaryEditor($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);
            $user = $_SESSION['user'];

            return $db->query(" UPDATE  Expedients_Obituaries eo
                                SET     eo.isOpen = 1,
                                        eo.user = $user
                                WHERE   eo.expedient = $expedient AND
                                        eo.type = $type AND
                                        eo.model = $model");
        }

        /**
         * Desbloquea el editor de esquelas
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de esquela
         * @param int $model Modelo de esquela
         * @return bool
         */
        public function unlockObituaryEditor($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);

            return $db->query(" UPDATE  Expedients_Obituaries eo
                                SET     eo.isOpen = 0
                                WHERE   eo.expedient = $expedient AND
                                        eo.type = $type AND
                                        eo.model = $model");
        }

        /**
         * Publica esquela
         * 
         * @param int $expedient Expediente
         * @return bool
         */
        public function publish($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $link = '';
            switch($db->getDataConnection()['db']){
                case 'apparosa':
                    $link = "https://pompasfunebres.es/esquelas-y-pesames/ver-esquela/$expedient";
                break;
                case 'appbaiona':
                    $link = "https://pfminor.es/esquelas-y-pesames/ver-esquela/$expedient";
                break;
                case 'appabrisa':
                    $link = "https://esquelas.funerariagolpe.com/esquelas-y-pesames/ver-esquela/$expedient";
                break;
                case 'appcolodro':
                    $link = "https://serviciosfunerarios.grupocolodro.com/esquelas-y-pesames/ver-esquela/$expedient";
                break;
                case 'appibiza':
                    $link = "https://pompasfunebresibiza.es/esquelas-flores-y-pesames/ver-esquela/$expedient";
                break;
                case 'appsantategra':
                    $link = "https://santategra.com/esquelas-y-pesames/ver-esquela/$expedient";
                break;
                case 'appgonzalezavila':
                    $link = "https://gonzalezserviciosfunerarios.com/esquelas-y-pesames/ver-esquela/$expedient";
                break;
                case 'appsanjose':
                    $link = "https://sfunerarios-sanjose.com/esquelas-y-pesames/ver-esquela/$expedient";
                break;
                case 'appmartinez':
                    $link = "https://funerariamartinez.es/esquelas-y-pesames/ver-esquela/$expedient";
                break;
            }

            return $db->query(" UPDATE  Expedients_Services es
                                SET     es.webLink = '$link'
                                WHERE   es.expedient = $expedient");
        }

        /**
         * Quita la esquela de la web
         * 
         * @param int $expedient Expediente
         * @return bool
         */
        public function unpublish($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            return $db->query(" UPDATE  Expedients_Services es
                                SET     es.webLink = null
                                WHERE   es.expedient = $expedient");
        }

        /**
         * Obtiene el link de la web de la esquela
         * 
         * @param int $expedient Expediente
         * @return string|null
         */
        public function getWebLink($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT  es.webLink
                                    FROM    Expedients_Services es
                                    WHERE   es.expedient = $expedient");

            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['webLink'];
        }

        /**
         * Obtiene los expedientes activos para el panel de información
         * 
         * @return array
         */
        public function getInfoActiveExpedients(){
            $db = new DbHandler;

            $result = $db->query("  SELECT      e.expedientID, UNIX_TIMESTAMP(e.requestDate), e.number, et.name as expedientTypeName, e.requestDate, e.deceasedName, e.deceasedSurname,
                                                c.name as clientName,
                                                ct.name as clientTypeName,
                                                u.username
                                    FROM        (Expedients e)
                                    LEFT JOIN   Expedients_Types et ON e.type = et.expedientTypeID
                                    LEFT JOIN   Clients c ON e.client = c.clientID
                                    LEFT JOIN   Clients_Types ct ON e.clientType = ct.clientTypeID
                                    LEFT JOIN   Users u ON e.user = u.userID
                                    WHERE       e.leavingDate IS NULL AND
                                                e.status = 2
                                    ORDER BY    e.requestDate");

            return mysqli_num_rows($result) == 0 ? [] : $db->resultToArrayValue($result);
        }

        /**
         * Obtiene los expedientes activos para el panel de información
         * 
         * @return array
         */
        public function getActiveExpedientsInfo(){
            $db = new DbHandler;

            $currentDate = date('Y-m-d', time());
            $currentTime = date('H:i:s', time());

            $result = $db->query("  SELECT      e.expedientID, UNIX_TIMESTAMP(e.requestDate), e.number, et.name as expedientTypeName, e.requestDate, e.deceasedName, e.deceasedSurname,
                                                c.name as clientName,
                                                ct.name as clientTypeName,
                                                u.username
                                    FROM        (Expedients e)
                                    LEFT JOIN   Expedients_Types et ON e.type = et.expedientTypeID
                                    LEFT JOIN   Clients c ON e.client = c.clientID
                                    LEFT JOIN   Clients_Types ct ON e.clientType = ct.clientTypeID
                                    LEFT JOIN   Users u ON e.user = u.userID
                                    LEFT JOIN   Events ev ON e.expedientID = ev.expedient AND ev.type = 1
                                    WHERE       e.leavingDate IS NULL AND e.status = 2 AND (e.type = 1 OR e.type = 3) 
                                                OR (e.status IN (3,4) AND e.leavingDate IS NULL AND 
                                                ((e.funeralDate > '$currentDate' OR (e.funeralDate = '$currentDate' AND e.funeralTime >= '$currentTime')) AND
                                                IF(ev.end IS NULL, 1, ev.end >= '$currentDate $currentTime')))
                                    ORDER BY    e.requestDate");

            return mysqli_num_rows($result) == 0 ? [] : $db->resultToArrayValue($result);
        }

        /**
         * Obtiene el listado de expedientes
         * 
         * @return array
         */
        public function getListExpedients($where){
            $db = new DbHandler;

            $result = $db->query("  SELECT      e.expedientID, 
                                                e.number,
                                                IF(e.internalRef IS NULL OR e.internalRef = '', '-', e.internalRef),
                                                e.requestDate, 
                                                e.deceasedName, 
                                                e.deceasedSurname, 
                                                CONCAT(c.name, ' ' , c.surname), 
                                                e.status, 
                                                m.name, 
                                                e.type, 
                                                ct.name, -- 10
                                                u.username, 
                                                e.crematorium, 
                                                a.ID, 
                                                e.room, 
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Expedients_Notes en
                                                    WHERE   e.expedientID = en.expedient 
                                                        AND en.delete_date IS NULL
                                                        AND en.section = 0
                                                ) as notesHiring, 
                                                e.expNumSecuence, 
                                                '', 
                                                '', 
                                                '', 
                                                e.expNumYear, -- 20
                                                e.client, 
                                                (
                                                    SELECT      COUNT(*)
                                                    FROM        Invoices i
                                                    WHERE       e.expedientID = i.expedient AND 
                                                                i.leavingDate IS NULL AND
                                                                i.billingSerie = 5
                                                ) as sequence_cash_customer,
                                                e.tpv, 
                                                (   
                                                    (
                                                        SELECT  SUM(epr.score)
                                                        FROM    Expedients_Polls ep, Expedients_Polls_Results epr
                                                        WHERE   
                                                            e.expedientID = ep.expedient AND ep.leavingDate IS NULL
                                                            AND epr.expedient_poll = ep.ID
                                                            AND epr.leavingDate IS NULL
                                                    ) 
                                                    / 
                                                    (
                                                        SELECT  COUNT(*)
                                                        FROM    Expedients_Polls ep, Expedients_Polls_Results epr
                                                        WHERE   
                                                            e.expedientID = ep.expedient AND ep.leavingDate IS NULL
                                                            AND epr.expedient_poll = ep.ID
                                                            AND epr.leavingDate IS NULL
                                                    )
                                                ) as scores,
                                                (
                                                    SELECT      COUNT(*)
                                                    FROM        Invoices i
                                                    WHERE       e.expedientID = i.expedient AND 
                                                                i.leavingDate IS NULL
                                                ) as has_invoice, -- 25
                                                (
                                                    SELECT  COUNT(*)
                                                    FROM    Invoices i, Billing_Series bs
                                                    WHERE   e.expedientID = i.expedient AND 
                                                            i.leavingDate IS NULL AND
                                                            i.billingSerie = bs.id AND
                                                            bs.serie_rectified IS NULL
                                                    ORDER BY i.creationDate DESC
                                                    LIMIT 1
                                                ) as exists_invoice_rectified -- 26
                                    FROM        (Expedients e)
                                    LEFT JOIN   Expedients_Types et ON e.type = et.expedientTypeID
                                    LEFT JOIN   Expedients_Status es ON e.status = es.expedientStatusID
                                    LEFT JOIN   Users u ON e.user = u.userID
                                    LEFT JOIN   Clients_Types ct ON e.clientType = ct.clientTypeID
                                    LEFT JOIN   Locations l1 ON e.applicantLocation = l1.locationID
                                    LEFT JOIN   Locations l2 ON e.familyContactLocation = l2.locationID
                                    LEFT JOIN   Clients c ON e.client = c.clientID
                                    LEFT JOIN   Locations l3 ON e.deceasedBirthdayLocation = l3.locationID
                                    LEFT JOIN   Locations l4 ON e.deceasedLocation = l4.locationID
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   Churches ch ON e.church = ch.churchID
                                    LEFT JOIN   Cemeteries ce ON e.cemetery = ce.cemeteryID
                                    LEFT JOIN   Niches n ON e.niche = n.nicheID
                                    LEFT JOIN   Crematoriums cr ON e.crematorium = cr.crematoriumID
                                    LEFT JOIN   FuneralHomes fh ON e.funeralHome = fh.funeralHomeID
                                    LEFT JOIN   Assistances a ON e.expedientID = a.expedient AND a.leavingDate IS NULL
                                    LEFT JOIN   Events ev ON e.expedientID = ev.expedient AND ev.type = 1
                                    WHERE       $where
            ");

            return mysqli_num_rows($result) == 0 ? [] : $db->resultToArrayValue($result);
        }

        /**
         * Obtiene los expedientes con tareas pendientes
         */
        public function getInfoPendingExpedients(){
            $db = new DbHandler;

            $result = $db->query("  SELECT      e.expedientID, UNIX_TIMESTAMP(e.requestDate), e.number, et.name as type, e.requestDate, e.deceasedName, e.deceasedSurname, ct.name as clientType
                                    FROM        (Expedients e)
                                    LEFT JOIN   Expedients_Types et ON e.type = et.expedientTypeID
                                    LEFT JOIN   Clients_Types ct ON e.clientType = ct.clientTypeID
                                    WHERE       e.leavingDate IS NULL AND e.status != 5
                                    ORDER BY    e.requestDate DESC
                                    LIMIT       100");

            if(mysqli_num_rows($result) == 0){
                return [];
            }else{
                $expedients = $db->resultToArrayValue($result);
                foreach($expedients as $index => $elem){
                    $tasks = $this->getTasksByExpedientAmount($elem[0]);
                    if($tasks == 0){
                        unset($expedients[$index]);
                    }else{
                        array_push($expedients[$index], $tasks);
                    }
                }

                return array_values($expedients);
            }
        }

        /**
         * Obtiene el cliente de un expediente
         * 
         * @param int $expedient Expediente
         * @return int
         */
        public function getClientByExpedient($expedient){
            $db = new DbHandler;

            $result = $db->query("  SELECT  e.client
                                    FROM    Expedients e
                                    WHERE   e.expedientID = $expedient");
                    
            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0]['client'];
        }

        /**
         * Obtiene los datos de la carta de flores para la ventana modal
         * 
         * @param int $expedient Expediente
         * @return array
         */
        public function fillCartaFlores($expedient){
            $db = new DbHandler;

            $data = array();

            $result = $db->query("  SELECT  category, value
                                    FROM    Flowers_Letters fl
                                    WHERE   fl.expedient = $expedient");

            mysqli_num_rows($result) == 0 ? null : array_push($data, $db->resultToArray($result));

            $maxNumHiring = $this->getActiveHiring($expedient);

            // Obtenemos los expedientes asociados al expediente actual
            $result = $db->query("  SELECT  exas.expedientID
                                    FROM    Expedients_Associates exas
                                    WHERE   exas.associate = $expedient AND
                                            exas.leavingDate IS NULL
            ");
            $expedientesAssociates = $db->resultToArray($result);

            $expedientesAssociatesIds = '';
            if(count($expedientesAssociates) > 0){
                foreach($expedientesAssociates as $elem){
                    $expedientesAssociatesIds.= $elem['expedientID'] . ',';
                }
                if($expedientesAssociatesIds != ''){
                    $expedientesAssociatesIds = substr($expedientesAssociatesIds, 0, -1);
                }
            }

            if($expedientesAssociatesIds != ''){

                $result = $db->query("   
                    SELECT Z.productID, 
                            Z.name, 
                            Z.value, 
                            Z.serviceBelow
                    FROM(
                            (
                                SELECT      p.productID, 
                                            p.name, 
                                            REPLACE(et.value, '\\\', '') as value, 
                                            p.serviceBelow
                                FROM        Expedients_Hirings eh
                                LEFT JOIN   Expedients_Texts et ON eh.ID = et.hiring
                                LEFT JOIN   Products p ON p.productID = eh.product
                                WHERE       $expedient = eh.expedient AND 
                                            eh.num_hiring = $maxNumHiring AND
                                            (p.serviceBelow = 5 OR p.serviceBelow = 6 OR p.serviceBelow = 7) AND 
                                            eh.check = 1
                            )
                            UNION
                            (
                                SELECT      p.productID, 
                                            p.name, 
                                            REPLACE(et.value, '\\\', '') as value, 
                                            p.serviceBelow
                                FROM        Expedients_Hirings eh
                                LEFT JOIN   Expedients_Texts et ON eh.ID = et.hiring
                                LEFT JOIN   Products p ON p.productID = eh.product
                                WHERE       eh.expedient IN ($expedientesAssociatesIds) AND 
                                            (p.serviceBelow = 5 OR p.serviceBelow = 6 OR p.serviceBelow = 7) AND 
                                            eh.check = 1
                            )
                    ) as Z
                ");
            }else{
                $result = $db->query("  SELECT      p.productID, p.name, REPLACE(et.value, '\\\', '') as value, p.serviceBelow
                                        FROM        (Expedients_Hirings eh)
                                        LEFT JOIN   Expedients_Texts et ON eh.ID = et.hiring
                                        LEFT JOIN   Products p ON p.productID = eh.product
                                        WHERE       $expedient = eh.expedient AND
                                                    eh.num_hiring = $maxNumHiring AND
                                                    (p.serviceBelow = 5 OR p.serviceBelow = 6 OR p.serviceBelow = 7) AND
                                                    eh.check = 1");
            }

            mysqli_num_rows($result) == 0 ? null : array_push($data, $db->resultToArray($result));

            return $data;
        }

        /**
         * Guarda los valores de la carta de flores
         * 
         * @param int $expedient Expediente
         * @param array $data Datos
         * @return bool
         */
        public function setCartaFlores($expedient, $data){
            $db = new DbHandler;

            $result = $db->query("  SELECT  fl.category
                                    FROM    Flowers_Letters fl
                                    WHERE   fl.expedient = $expedient");

            if(mysqli_num_rows($result) == 0){
                $db->query("INSERT INTO Flowers_Letters(expedient, category, value)
                            VALUES ($expedient, 'attention', '{$data['attention']}')");
                $db->query("INSERT INTO Flowers_Letters(expedient, category, value)
                            VALUES ($expedient, 'date', '{$data['date']}')");
                $db->query("INSERT INTO Flowers_Letters(expedient, category, value)
                            VALUES ($expedient, 'deceased', '{$data['deceased']}')");

                if(isset($data['coronas'])){
                    foreach($data['coronas'] as $elem){
                        $db->query("INSERT INTO Flowers_Letters(expedient, category, value)
                                    VALUES ($expedient, 'coronas', '$elem')");
                    }
                }

                if(isset($data['centros'])){
                    foreach($data['centros'] as $elem){
                        $db->query("INSERT INTO Flowers_Letters(expedient, category, value)
                                    VALUES ($expedient, 'centros', '$elem')");
                    }
                }

                if(isset($data['ramos'])){
                    foreach($data['ramos'] as $elem){
                        $db->query("INSERT INTO Flowers_Letters(expedient, category, value)
                                    VALUES ($expedient, 'ramos', '$elem')");
                    }
                }
            }else{
                $info = $db->resultToArray($result);
                $hasAttention = false;
                $hasDate = false;
                $hasDeceased = false;
                $hasCoronas = false;
                $hasCentros = false;
                $hasRamos = false;
                foreach($info as $elem){
                    switch($elem['category']){
                        case 'attention':
                            $hasAttention = true;
                        break;
                        case 'date':
                            $hasDate = true;
                        break;
                        case 'deceased':
                            $hasDeceased = true;
                        break;
                        case 'coronas':
                            $hasCoronas = true;
                        break;
                        case 'centros':
                            $hasCentros = true;
                        break;
                        case 'ramos':
                            $hasRamos = true;
                        break;
                    }
                }

                if($hasAttention){
                    $db->query("UPDATE  Flowers_Letters
                                SET     value = '{$data['attention']}'
                                WHERE   expedient = $expedient AND
                                        category = 'attention'");
                }else{
                    $db->query("INSERT INTO Flowers_Letters(expedient, category, value)
                                VALUES ($expedient, 'attention', '{$data['attention']}')");
                }

                if($hasDate){
                    $db->query("UPDATE  Flowers_Letters
                                SET     value = '{$data['date']}'
                                WHERE   expedient = $expedient AND
                                        category = 'date'");
                }else{
                    $db->query("INSERT INTO Flowers_Letters(expedient, category, value)
                                VALUES ($expedient, 'date', '{$data['date']}')");
                }

                if($hasDeceased){
                    $db->query("UPDATE  Flowers_Letters
                                SET     value = '{$data['deceased']}'
                                WHERE   expedient = $expedient AND
                                        category = 'deceased'");
                }else{
                    $db->query("INSERT INTO Flowers_Letters(expedient, category, value)
                                VALUES ($expedient, 'deceased', '{$data['deceased']}')");
                }

                if($hasCoronas){
                    $db->query("DELETE FROM Flowers_Letters
                                WHERE   expedient = $expedient AND
                                        category = 'coronas'");
                }
                if(isset($data['coronas'])){
                    foreach($data['coronas'] as $elem){
                        $db->query("INSERT INTO Flowers_Letters(expedient, category, value)
                                    VALUES ($expedient, 'coronas', '$elem')");
                    }
                }

                if($hasCentros){
                    $db->query("DELETE FROM Flowers_Letters
                                WHERE   expedient = $expedient AND
                                        category = 'centros'");
                }
                if(isset($data['centros'])){
                    foreach($data['centros'] as $elem){
                        $db->query("INSERT INTO Flowers_Letters(expedient, category, value)
                                    VALUES ($expedient, 'centros', '$elem')");
                    }
                }

                if($hasRamos){
                    $db->query("DELETE FROM Flowers_Letters
                                WHERE   expedient = $expedient AND
                                        category = 'ramos'");
                }
                if(isset($data['ramos'])){
                    foreach($data['ramos'] as $elem){
                        $db->query("INSERT INTO Flowers_Letters(expedient, category, value)
                                    VALUES ($expedient, 'ramos', '$elem')");
                    }
                }
            }

            return true;
        }

        /**
         * Comprueba si existe un modelo de lápida para un expediente
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo
         * @param int $model Modelo
         * @return bool
         */
        public function hasTombstone($expedient, $type, $model){
            $db = new DbHandler;

            $result = $db->query("  SELECT  et.ID
                                    FROM    Expedients_Tombstones et
                                    WHERE   et.expedient = $expedient AND
                                            et.type = $type AND
                                            et.model = $model");

            return mysqli_num_rows($result) == 0 ? false : true;
        }

        /**
         * Crea un modelo de lápida para un expediente
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo
         * @param int $model Modelo
         * @return bool
         */
        public function createTombstone($expedient, $type, $model){
            $db = new DbHandler;

            return $db->query(" INSERT INTO Expedients_Tombstones(expedient, type, model, isOpen)
                                VALUES ($expedient, $type, $model, 0)");
        }

        /**
         * Comprueba si el editor de lápidas está bloqueado
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de lápida
         * @param int $model Modelo de lápida
         * @return bool
         */
        public function isTombstoneEditorLocked($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);

            $result = $db->query("  SELECT  et.isOpen
                                    FROM    Expedients_Tombstones et
                                    WHERE   et.expedient = $expedient AND
                                            et.type = $type AND
                                            et.model = $model");

            return mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['isOpen'];
        }

        /**
         * Bloquea el editor de lápidas
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de lápida
         * @param int $model Modelo de lápida
         * @return bool
         */
        public function lockTombstoneEditor($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);
            $user = $_SESSION['user'];

            return $db->query(" UPDATE  Expedients_Tombstones et
                                SET     et.isOpen = 1,
                                        et.user = $user
                                WHERE   et.expedient = $expedient AND
                                        et.type = $type AND
                                        et.model = $model");
        }

        /**
         * Desbloquea el editor de lápidass
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de lápidas
         * @param int $model Modelo de lápidas
         * @return bool
         */
        public function unlockTombstoneEditor($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);

            return $db->query(" UPDATE  Expedients_Tombstones et
                                SET     et.isOpen = 0
                                WHERE   et.expedient = $expedient AND
                                        et.type = $type AND
                                        et.model = $model");
        }


        /**
         * Comprueba si existe un modelo de prensa para un expediente
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo
         * @param int $model Modelo
         * @return bool
         */
        public function hasPress($expedient, $type, $model){
            $db = new DbHandler;

            $result = $db->query("  SELECT  et.ID
                                    FROM    Expedients_Press et
                                    WHERE   et.expedient = $expedient AND
                                            et.type = $type AND
                                            et.model = $model");

            return mysqli_num_rows($result) == 0 ? false : true;
        }

        /**
         * Crea un modelo de prensa para un expediente
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo
         * @param int $model Modelo
         * @return bool
         */
        public function createPress($expedient, $type, $model){
            $db = new DbHandler;

            return $db->query(" INSERT INTO Expedients_Press(expedient, type, model, isOpen)
                                VALUES ($expedient, $type, $model, 0)");
        }

        /**
         * Comprueba si el editor de prensa está bloqueado
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de prensa
         * @param int $model Modelo de prensa
         * @return bool
         */
        public function isPressEditorLocked($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);

            $result = $db->query("  SELECT  et.isOpen
                                    FROM    Expedients_Press et
                                    WHERE   et.expedient = $expedient AND
                                            et.type = $type AND
                                            et.model = $model");

            return mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['isOpen'];
        }

        /**
         * Bloquea el editor de prensa
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de prensa
         * @param int $model Modelo de prensa
         * @return bool
         */
        public function lockPressEditor($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);
            $user = $_SESSION['user'];

            return $db->query(" UPDATE  Expedients_Press ep
                                SET     ep.isOpen = 1,
                                        ep.user = $user
                                WHERE   ep.expedient = $expedient AND
                                        ep.type = $type AND
                                        ep.model = $model");
        }

        /**
         * Desbloquea el editor de prensa
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de prensa
         * @param int $model Modelo de prensa
         * @return bool
         */
        public function unlockPressEditor($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);

            return $db->query(" UPDATE  Expedients_Press et
                                SET     et.isOpen = 0
                                WHERE   et.expedient = $expedient AND
                                        et.type = $type AND
                                        et.model = $model");
        }


        /**
         * Comprueba si existe un modelo de recordario para un expediente
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo
         * @param int $model Modelo
         * @return bool
         */
        public function hasReminder($expedient, $type, $model){
            $db = new DbHandler;

            $result = $db->query("  SELECT  et.ID
                                    FROM    Expedients_Reminder et
                                    WHERE   et.expedient = $expedient AND
                                            et.type = $type AND
                                            et.model = $model");

            return mysqli_num_rows($result) == 0 ? false : true;
        }

        /**
         * Crea un modelo de recordario para un expediente
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo
         * @param int $model Modelo
         * @return bool
         */
        public function createReminder($expedient, $type, $model){
            $db = new DbHandler;

            return $db->query(" INSERT INTO Expedients_Reminder(expedient, type, model, isOpen)
                                VALUES ($expedient, $type, $model, 0)");
        }

        /**
         * Comprueba si el editor de recordario está bloqueado
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de recordario
         * @param int $model Modelo de recordario
         * @return bool
         */
        public function isReminderEditorLocked($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);

            $result = $db->query("  SELECT  et.isOpen
                                    FROM    Expedients_Reminder et
                                    WHERE   et.expedient = $expedient AND
                                            et.type = $type AND
                                            et.model = $model");

            return mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['isOpen'];
        }

        /**
         * Bloquea el editor de recordario
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de recordario
         * @param int $model Modelo de recordario
         * @return bool
         */
        public function lockReminderEditor($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);
            $user = $_SESSION['user'];

            return $db->query(" UPDATE  Expedients_Reminder er
                                SET     er.isOpen = 1,
                                        er.user = $user
                                WHERE   er.expedient = $expedient AND
                                        er.type = $type AND
                                        er.model = $model");
        }

        /**
         * Desbloquea el editor de recordarios
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de recordario
         * @param int $model Modelo de recordario
         * @return bool
         */
        public function unlockReminderEditor($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);

            return $db->query(" UPDATE  Expedients_Reminder et
                                SET     et.isOpen = 0
                                WHERE   et.expedient = $expedient AND
                                        et.type = $type AND
                                        et.model = $model");
        }


        /**
         * Comprueba si existe un modelo de recordario para un expediente
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo
         * @param int $model Modelo
         * @return bool
         */
        public function hasReminderPacket($expedient, $type, $model){
            $db = new DbHandler;

            $result = $db->query("  SELECT  et.ID
                                    FROM    Expedients_Reminder_Packet et
                                    WHERE   et.expedient = $expedient AND
                                            et.type = $type AND
                                            et.model = $model");

            return mysqli_num_rows($result) == 0 ? false : true;
        }

        /**
         * Crea un modelo de recordario para un expediente
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo
         * @param int $model Modelo
         * @return bool
         */
        public function createReminderPacket($expedient, $type, $model){
            $db = new DbHandler;

            return $db->query(" INSERT INTO Expedients_Reminder_Packet(expedient, type, model, isOpen)
                                VALUES ($expedient, $type, $model, 0)");
        }

        /**
         * Comprueba si el editor de recordario está bloqueado
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de recordario
         * @param int $model Modelo de recordario
         * @return bool
         */
        public function isReminderPacketEditorLocked($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);

            $result = $db->query("  SELECT  et.isOpen
                                    FROM    Expedients_Reminder_Packet et
                                    WHERE   et.expedient = $expedient AND
                                            et.type = $type AND
                                            et.model = $model");

            return mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['isOpen'];
        }

        /**
         * Bloquea el editor de recordario
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de recordario
         * @param int $model Modelo de recordario
         * @return bool
         */
        public function lockReminderPacketEditor($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);
            $user = $_SESSION['user'];

            return $db->query(" UPDATE  Expedients_Reminder_Packet erp
                                SET     erp.isOpen = 1,
                                        erp.user = $user
                                WHERE   erp.expedient = $expedient AND
                                        erp.type = $type AND
                                        erp.model = $model");
        }

        /**
         * Desbloquea el editor de recordarios
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de recordario
         * @param int $model Modelo de recordario
         * @return bool
         */
        public function unlockReminderPacketEditor($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);

            return $db->query(" UPDATE  Expedients_Reminder_Packet et
                                SET     et.isOpen = 0
                                WHERE   et.expedient = $expedient AND
                                        et.type = $type AND
                                        et.model = $model");
        }

        /**
         * Comprueba si existe un modelo de recordario para un expediente
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo
         * @param int $model Modelo
         * @return bool
         */
        public function hasClosedDeath($expedient, $type, $model){
            $db = new DbHandler;

            $result = $db->query("  SELECT  et.ID
                                    FROM    Expedients_Closed_Death et
                                    WHERE   et.expedient = $expedient AND
                                            et.type = $type AND
                                            et.model = $model");

            return mysqli_num_rows($result) == 0 ? false : true;
        }

        /**
         * Crea un modelo de recordario para un expediente
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo
         * @param int $model Modelo
         * @return bool
         */
        public function createClosedDeath($expedient, $type, $model){
            $db = new DbHandler;

            return $db->query(" INSERT INTO Expedients_Closed_Death(expedient, type, model, isOpen)
                                VALUES ($expedient, $type, $model, 0)");
        }

        /**
         * Comprueba si el editor de recordario está bloqueado
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de recordario
         * @param int $model Modelo de recordario
         * @return bool
         */
        public function isClosedDeathEditorLocked($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);

            $result = $db->query("  SELECT  et.isOpen
                                    FROM    Expedients_Closed_Death et
                                    WHERE   et.expedient = $expedient AND
                                            et.type = $type AND
                                            et.model = $model");

            return mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['isOpen'];
        }

        /**
         * Bloquea el editor de recordario
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de recordario
         * @param int $model Modelo de recordario
         * @return bool
         */
        public function lockClosedDeathEditor($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);
            $user = $_SESSION['user'];

            return $db->query(" UPDATE  Expedients_Closed_Death ecd
                                SET     ecd.isOpen = 1,
                                        ecd.user = $user
                                WHERE   ecd.expedient = $expedient AND
                                        ecd.type = $type AND
                                        ecd.model = $model");
        }

        /**
         * Desbloquea el editor de recordarios
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de recordario
         * @param int $model Modelo de recordario
         * @return bool
         */
        public function unlockClosedDeathEditor($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);

            return $db->query(" UPDATE  Expedients_Closed_Death et
                                SET     et.isOpen = 0
                                WHERE   et.expedient = $expedient AND
                                        et.type = $type AND
                                        et.model = $model");
        }

        /**
         * Comprueba si existe un modelo de duelo para un expediente
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo
         * @param int $model Modelo
         * @return bool
         */
        public function hasNoDuelReceived($expedient, $type, $model){
            $db = new DbHandler;

            $result = $db->query("  SELECT  et.ID
                                    FROM    Expedients_Duel_Received et
                                    WHERE   et.expedient = $expedient AND
                                            et.type = $type AND
                                            et.model = $model");

            return mysqli_num_rows($result) == 0 ? false : true;
        }

        /**
         * Crea un modelo de recordario para un expediente
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo
         * @param int $model Modelo
         * @return bool
         */
        public function createNoDuelReceived($expedient, $type, $model){
            $db = new DbHandler;

            return $db->query(" INSERT INTO Expedients_Duel_Received(expedient, type, model, isOpen)
                                VALUES ($expedient, $type, $model, 0)");
        }

        /**
         * Comprueba si el editor de recordario está bloqueado
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de recordario
         * @param int $model Modelo de recordario
         * @return bool
         */
        public function isNoDuelReceivedEditorLocked($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);

            $result = $db->query("  SELECT  et.isOpen
                                    FROM    Expedients_Duel_Received et
                                    WHERE   et.expedient = $expedient AND
                                            et.type = $type AND
                                            et.model = $model");

            return mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['isOpen'];
        }

        /**
         * Bloquea el editor de recordario
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de recordario
         * @param int $model Modelo de recordario
         * @return bool
         */
        public function lockNoDuelReceivedEditor($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);
            $user = $_SESSION['user'];

            return $db->query(" UPDATE  Expedients_Duel_Received edr
                                SET     edr.isOpen = 1,
                                        edr.user = $user
                                WHERE   edr.expedient = $expedient AND
                                        edr.type = $type AND
                                        edr.model = $model");
        }

        /**
         * Desbloquea el editor de recordarios
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de recordario
         * @param int $model Modelo de recordario
         * @return bool
         */
        public function unlockNoDuelReceivedEditor($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);

            return $db->query(" UPDATE  Expedients_Duel_Received et
                                SET     et.isOpen = 0
                                WHERE   et.expedient = $expedient AND
                                        et.type = $type AND
                                        et.model = $model");
        }

        /**
         * Comprueba si existe un modelo de recordario para un expediente
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo
         * @param int $model Modelo
         * @return bool
         */
        public function hasReminderPacketCross($expedient, $type, $model){
            $db = new DbHandler;

            $result = $db->query("  SELECT  et.ID
                                    FROM    Expedients_Reminder_Packet_Cross et
                                    WHERE   et.expedient = $expedient AND
                                            et.type = $type AND
                                            et.model = $model");

            return mysqli_num_rows($result) == 0 ? false : true;
        }

        /**
         * Crea un modelo de recordario para un expediente
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo
         * @param int $model Modelo
         * @return bool
         */
        public function createReminderPacketCross($expedient, $type, $model){
            $db = new DbHandler;

            return $db->query(" INSERT INTO Expedients_Reminder_Packet_Cross(expedient, type, model, isOpen)
                                VALUES ($expedient, $type, $model, 0)");
        }

        /**
         * Comprueba si el editor de recordario está bloqueado
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de recordario
         * @param int $model Modelo de recordario
         * @return bool
         */
        public function isReminderPacketCrossEditorLocked($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);

            $result = $db->query("  SELECT  et.isOpen
                                    FROM    Expedients_Reminder_Packet_Cross et
                                    WHERE   et.expedient = $expedient AND
                                            et.type = $type AND
                                            et.model = $model");

            return mysqli_num_rows($result) == 0 ? 0 : $db->resultToArray($result)[0]['isOpen'];
        }

        /**
         * Bloquea el editor de recordario
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de recordario
         * @param int $model Modelo de recordario
         * @return bool
         */
        public function lockReminderPacketCrossEditor($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);
            $user = $_SESSION['user'];

            return $db->query(" UPDATE  Expedients_Reminder_Packet_Cross erpc
                                SET     erpc.isOpen = 1,
                                        erpc.user = $user
                                WHERE   erpc.expedient = $expedient AND
                                        erpc.type = $type AND
                                        erpc.model = $model");
        }

        /**
         * Desbloquea el editor de recordarios
         * 
         * @param int $expedient Expediente
         * @param int $type Tipo de recordario
         * @param int $model Modelo de recordario
         * @return bool
         */
        public function unlockReminderPacketCrossEditor($expedient, $type, $model){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);
            $type = cleanStr($type);
            $model = cleanStr($model);

            return $db->query(" UPDATE  Expedients_Reminder_Packet_Cross et
                                SET     et.isOpen = 0
                                WHERE   et.expedient = $expedient AND
                                        et.type = $type AND
                                        et.model = $model");
        }

        /**
         * Obtiene las tareas pendientes
         *
         * @return array
         */
        public function listPendingTasksDatatables(){
            $db = new DbHandler;

            $result = $db->query("  SELECT      e.expedientID, e.number, e.requestDate, e.deceasedName, e.deceasedSurname, CONCAT(c.name, ' ' , c.surname), 
                                                es.name, m.name, et.name, ct.name, e.tpv
                                    FROM        Expedients e
                                    LEFT JOIN   Expedients_Types et ON e.type = et.expedientTypeID
                                    LEFT JOIN   Clients c ON e.client = c.clientID
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   Expedients_Status es ON e.status = es.expedientStatusID
                                    LEFT JOIN   Clients_Types ct ON e.clientType = ct.clientTypeID
                                    WHERE       e.type != 2 AND
                                                e.leavingDate IS NULL AND
                                                e.status != 5
                                    ORDER BY    e.requestDate DESC");
            
            if(mysqli_num_rows($result) == 0){
                return array();
			}else{
                $values = $db->resultToArrayValue($result);
                $pendingTask = array();
                $pos = 0;
                foreach($values as $value){
                    $amount = $this->getTasksByExpedientAmount($value[0]);
                    if($amount > 0){
                        $pendingTask[$pos][0] = $value[0];
                        $pendingTask[$pos][1] = $value[1];
                        $pendingTask[$pos][2] = $value[2];
                        $pendingTask[$pos][3] = $value[3];
                        $pendingTask[$pos][4] = $value[4];
                        $pendingTask[$pos][5] = $value[5];
                        $pendingTask[$pos][6] = $value[6];
                        $pendingTask[$pos][7] = $value[7];
                        $pendingTask[$pos][8] = $value[8];
                        $pendingTask[$pos][9] = $value[9];
                        $pendingTask[$pos][10] = $amount;
                        $pendingTask[$pos][11] = $value[10];
                        $pos++;
                    }
                }

                return $pendingTask;
			}
        }

        /**
         * Get data to API panel
         * 
         * @param int $expedient Expedient
         * @return array
         */
        public function getDataApiPanel($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT      e.deceasedDate, e.deceasedName, e.deceasedSurname, e.deceasedBirthday, e.funeralDate, e.funeralTime, e.deceasedRoom,
                                                e.familyContactPhone, e.familyContactMobilePhone, e.cremation, e.churchLabel, e.cemeteryLabel,
                                                di.name as deceasedLocation, l1.name as deceasedLocationName, l2.name as deceasedBirthdayLocationName,
                                                l2.province as deceasedBirthdayLocationProvince,
                                                eo.extraText,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, ce.name) AS cemeteryName,
                                                IF(e.churchLabel = 'Otro', e.otherCeremony, ch.name) AS churchName,
                                                l3.name as churchLocationName,
                                                ce.cemeteryID as cemetery, 
                                                l4.name as cemeteryLocationName,
                                                cr.crematoriumID as crematorium, cr.name as crematoriumName, l5.name as crematoriumLocationName
                                    FROM        (Expedients e)
                                    LEFT JOIN   DeceasedIn di ON e.deceasedLocation = di.deceasedInID
                                    LEFT JOIN   Locations l1 ON di.location = l1.locationID
                                    LEFT JOIN   Locations l2 ON e.deceasedBirthdayLocation = l2.locationID
                                    LEFT JOIN   Churches ch ON e.church = ch.churchID
                                    LEFT JOIN   Locations l3 ON ch.location = l3.locationID
                                    LEFT JOIN   Cemeteries ce ON e.cemetery = ce.cemeteryID
                                    LEFT JOIN   Locations l4 ON ce.location = l4.locationID
                                    LEFT JOIN   Crematoriums cr ON e.crematorium = cr.crematoriumID
                                    LEFT JOIN   Locations l5 ON cr.location = l5.locationID
                                    LEFT JOIN   Expedients_Obituaries eo ON e.expedientID = eo.expedient AND eo.selected = 1
                                    WHERE       e.leavingDate IS NULL AND
                                                e.expedientID = $expedient");
            
            return mysqli_num_rows($result) == 0 ? null : $db->resultToArray($result)[0];
        }

        /**
         * Selecciona la fecha del último expediente
         */
        public function getFirstExpedientDate(){
            $db = new DbHandler;

            $result =  $db->query(" SELECT  MIN(e.entryDate) AS firtsDate
                                    FROM    Expedients e
                                    WHERE   e.leavingDate IS NULL");

            return mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0]['firtsDate'] : null;
        }

        /**
        * Obtiene los logs
        *
        * @return array
        */
        public function listLogsDatatables($expedient){
            $db = new DbHandler;
            
            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT l.date, u.username, l.action, l.description
                                    FROM Logs l, Users u
                                    WHERE l.user = u.userID AND l.expedient = $expedient");
            
            if(mysqli_num_rows($result) == 0){
				return array();
			}else{
				return $db->resultToArrayValue($result);
			}
        }

        /**
        * Obtiene los logs
        *
        * @return array
        */
        public function updateNotes($expedient, $notes){
            $db = new DbHandler;
 
            $expedient = cleanStr($expedient);
            $notes = cleanTextArea($notes);
             
            return $db->query(" UPDATE  Expedients
                                SET     notesHiring = '$notes'
                                WHERE   expedientID = $expedient");
        }

        /**
        * Obtiene los logs
        *
        * @return array
        */
        public function updatePriceExp($expedient, $template){
            $db = new DbHandler;
 
            $expedient = cleanStr($expedient);
            $template = cleanStr($template);

            $result = $db->query("  SELECT  t.price
                                    FROM    Templates t
                                    WHERE   t.templateID = $template");

            if(mysqli_num_rows($result) > 0){
               $price = $db->resultToArray($result)[0]['price'];

                return $db->query(" UPDATE  Expedients
                                    SET     priceExp = $price
                                    WHERE   expedientID = $expedient");
            }else{
                return false;
            }
        }

         /**
         * Devuelve la información del expediente sobre Nichos para CServicio
         * 
         * @param int $expedient Expediente
         * @return bool
         */
        public function getNicheInfo($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT  e.funeralBusyNiche, e.regime, e.deceasedNiche, e.exhumation, e.nicheHeight  
                                    FROM    Expedients e
                                    WHERE   e.expedient = $expedient");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result);
            }
        }

        /**
        * Resetea la tarifa del expediente a la original del cliente
        *
        * @return array
        */
        public function resetPriceExp($expedient){
            $db = new DbHandler;
 
            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT  c.price
                                    FROM    Expedients e, Clients c
                                    WHERE   e.client = c.clientID AND e.expedientID = $expedient");

            if(mysqli_num_rows($result) > 0){
               $price = $db->resultToArray($result)[0]['price'];

             return $db->query(" UPDATE  Expedients
                                 SET     priceExp = $price
                                 WHERE   expedientID = $expedient");
            }else{
                return false;
            }
        }

        /**
         * Elimina la esquela seleccionada y settea la nueva
         *
         * @return array
         */
        public function setObituaryAsDefault($expedient, $type, $model){
            $db = new DbHandler;

            $currentDate = time();
            $db->query("UPDATE  Expedients_Obituaries
                        SET     selected = 0,
                                `update` = $currentDate
                        WHERE   expedient = $expedient");

            $db->query("UPDATE  Expedients_Obituaries
                        SET     selected = 1,
                                `update` = $currentDate
                        WHERE   expedient = $expedient AND
                                type = $type AND
                                model = $model");
        }

        /**
         * Esquela por defecto
         *
         * @return array
         */
        public function setObituaryPressAsDefault($expedient, $type, $model){
            $db = new DbHandler;

            $db->query("UPDATE  Expedients_Press
                        SET     selected = 0
                        WHERE   expedient = $expedient");

            $db->query("UPDATE  Expedients_Press
                        SET     selected = 1
                        WHERE   expedient = $expedient AND
                                type = $type AND
                                model = $model");
        }

        /**
         * Obtiene la esquela en prensa por defecto
         * 
         * @param int $expedient
         * 
         * @return bool
         */
        public function getSelectedObituaryPress($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("SELECT    o.type, o.model
                                  FROM      Expedients_Press as o
                                  WHERE     o.expedient = $expedient AND
                                            o.selected = 1");
            
            if(mysqli_num_rows($result) == 0){
                return array('type' => 0, 'model' => 0);
            }else{
                return $db->resultToArray($result)[0];
            }
        }

        /**
         * Obtiene los datos para la solicitud de modificacion
         * 
         * @param int $expedient
         * 
         * @return bool
         */
        public function getSolicitudModificacion($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT  CONCAT(e.familyContactName, ' ' , e.familyContactSurname) as familyContact, e.familyContactNIF, e.policy,
                                            e.familyContactRelationship, CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceased
                                    FROM    Expedients e
                                    WHERE   e.expedientID = $expedient");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result)[0];
            }
        }

        /**
         * Obtiene los datos para el recibido de la conformidad de la poliza
         * 
         * @param int $expedient
         * 
         * @return bool
         */
        public function getRecibidoConformePoliza($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT  e.policy, e.lossNumber, CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceased, e.deceasedDate, e.deceasedGender,
                                            CONCAT(e.familyContactName, ' ', e.familyContactSurname) as familyContact, e.familyContactNIF, e.familyContactRelationship
                                    FROM    Expedients e
                                    WHERE   e.expedientID = $expedient" );
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result)[0];
            }
        }

        /**
         * Obtiene los datos para la autorización de la preventiva
         * 
         * @param int $expedient
         * 
         * @return bool
         */
        public function getAutorizacionPreventiva($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT  CONCAT(e.familyContactName, ' ' , e.familyContactSurname) as familyContact, e.familyContactNIF,
                                            CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceased, e.deceasedGender, e.deceasedNIF, e.policy
                                    FROM    Expedients e
                                    WHERE   e.expedientID = $expedient");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result)[0];
            }
        }

        /**
         * Obtiene los datos para la prestación del servicio
         * 
         * @param int $expedient
         * 
         * @return bool
         */
        public function getPrestacionServicio($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $maxNumHiring = $this->getActiveHiring($expedient);

            $result = $db->query("  SELECT      CONCAT(e.familyContactName, ' ' , e.familyContactSurname) as familyContact, e.familyContactNIF, e.familyContactRelationship,
                                                CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceased, e.deceasedGender, e.policy, e.deceasedDate, e.cremation, e.deceasedMortuaryAddress,
                                                i.total,
                                                e.deceasedLocation as expedientDL,
                                                e.otherDeceasedLocation,
                                                m.name as mortuary,
                                                l1.name as cemeteryLocation,
                                                l2.name as crematoriumLocation,
                                                CONCAT(l3.name, ', ', l3.province) as deceasedLocation
                                    FROM        (Expedients e)
                                    LEFT JOIN   Mortuaries m ON m.mortuaryID = e.deceasedMortuary
                                    LEFT JOIN   Cemeteries c ON c.cemeteryID = e.cemetery
                                    LEFT JOIN   Locations l1 ON l1.locationID = c.location
                                    LEFT JOIN   Crematoriums cr ON cr.crematoriumID = e.crematorium
                                    LEFT JOIN   Locations l2 ON l2.locationID = cr.location
                                    LEFT JOIN   DeceasedIn di ON di.deceasedInID = e.deceasedLocation
                                    LEFT JOIN   Locations l3 ON l3.locationID = di.location
                                    LEFT JOIN   Invoices i ON i.leavingDate IS NULL AND i.expedient = e.expedientID AND i.num_hiring = $maxNumHiring
                                    WHERE       e.expedientID = $expedient 
            ");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result)[0];
            }
        }

        /**
         * Obtiene los datos para el auto de prestación del servicio
         * 
         * @param int $expedient
         * 
         * @return bool
         */
        public function getAutoPrestacionServicio($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT      CONCAT(e.familyContactName, ' ' , e.familyContactSurname) as familyContact, e.familyContactNIF, e.familyContactPhone, 
                                                e.familyContactMobilePhone, e.familyContactRelationship, e.familyContactRelationship, e.deceasedGender, e.deceasedDate,
                                                CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceased, 
                                                e.otherDeceasedLocation,
                                                e.funeralHomeEntryDate,
                                                e.funeralHomeEntryTime,
                                                e.requestTime,
                                                e.requestDate,
                                                es.arriveDate,
                                                es.arriveTime,
                                                di.name as deceasedInName, l.name as deceasedLocation, l.province as deceasedProvince,
                                                e.familyContactAddress as familyContactDom, CONCAT(l2.name, ', ', l2.province) as familyContactAddress
                                    FROM        (Expedients e)
                                    LEFT JOIN   DeceasedIn di ON di.deceasedInID = e.deceasedLocation
                                    LEFT JOIN   Expedients_Services es ON es.expedient = e.expedientID
                                    LEFT JOIN   Locations l ON l.locationID = di.location
                                    LEFT JOIN   Locations l2 ON l2.locationID = e.familyContactLocation
                                    WHERE       e.expedientID = $expedient");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result)[0];
            }
        }

        /**
         * Obtiene los datos para la ficha de asistencia
         * 
         * @param int $expedient
         * 
         * @return bool
         */
        public function getFichaAsistencia($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT      CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceased, e.deceasedNIF, e.deceasedDate, e.policy, e.capital,
                                                CONCAT(e.familyContactName, ' ' , e.familyContactSurname) as familyContact, e.familyContactPhone, e.familyContactMobilePhone,
                                                CONCAT(e.familyContactAddress, ' ', l1.name, ' ', l1.province) as familyContactAddress, e.familyContactRelationship, e.cremation,
                                                e.familyContactMail, e.otherContactName, e.otherContactPhone, e.otherContactRelationship, e.deceasedTime, e.deceasedMortuaryAddress,
                                                e.ceremonyDate, e.ceremonyTime,
                                                e.deceasedLocation as expedientDL,
                                                e.otherDeceasedLocation,
                                                l2.name as deceasedLocation,
                                                l3.name as cemeteryLocation,
                                                l4.name as crematoriumLocation,
                                                fh.name as funeralHome,
                                                m.name as mortuary,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, c.name) as cemetery,
                                                cr.name as crematorium,
                                                ev.start, ev.end
                                    FROM        (Expedients e)
                                    LEFT JOIN   Locations l1 ON l1.locationID = e.familyContactLocation
                                    LEFT JOIN   DeceasedIn di ON di.deceasedInID = e.deceasedLocation
                                    LEFT JOIN   Locations l2 ON l2.locationID = di.location
                                    LEFT JOIN   Mortuaries m ON m.mortuaryID = e.deceasedMortuary
                                    LEFT JOIN   Cemeteries c ON c.cemeteryID = e.cemetery
                                    LEFT JOIN   Locations l3 ON l3.locationID = c.location
                                    LEFT JOIN   Crematoriums cr ON cr.crematoriumID = e.crematorium
                                    LEFT JOIN   Locations l4 ON l4.locationID = cr.location
                                    LEFT JOIN   FuneralHomes fh ON fh.funeralHomeID = e.funeralHome
                                    LEFT JOIN   Events ev ON e.crematoriumEvent = ev.ID
                                    WHERE       e.expedientID = $expedient");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $data = $db->resultToArray($result)[0];

                $maxNumHiring = $this->getActiveHiring($expedient);

                $result = $db->query("  
                    SELECT  s.name
                    FROM    Expedients_Hirings eh, Products p, Products_Models pm, Suppliers s
                    WHERE   eh.expedient = $expedient AND
                            eh.check = 1 AND
                            eh.product = p.productID AND
                            p.blockBelow = 3 AND
                            pm.product = p.productID AND
                            eh.model = pm.productModelID AND
                            pm.supplier = s.supplierID AND
                            eh.num_hiring = $maxNumHiring
                ");

                if(mysqli_num_rows($result) == 0){
                    $data['supplier'] = '';
                }else{
                    $data['supplier'] = $db->resultToArray($result)[0]['name'];
                }

                return $data;
            }
        }

        /**
         * Comprueba si existe la asistencia
         * 
         * @param int $expedient
         * 
         * @return bool
         */
        public function checkAssistance($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT  a.ID
                                    FROM    Assistances a
                                    WHERE   a.expedient = $expedient");
            
            if(mysqli_num_rows($result) == 0){
                require_once($_SESSION['basePath'] . "model/assistances.php");

                $assistances = new Assistances;
                $assistances->create(array('expedient' => $expedient));

                $result = $db->query("  SELECT  a.ID
                                        FROM    Assistances a
                                        WHERE   a.expedient = $expedient");

                return $db->resultToArray($result)[0]['ID'];
            }else{
                return $db->resultToArray($result)[0]['ID'];
            }
        }

        /**
         * Obtiene tipos de expediente
         *
         * @param string $name
         *
         * @return array
         */
        public function getTypes(){
            $db = new DbHandler;

            $result = $db->query("  SELECT      e.expedientTypeID, e.name
                                    FROM        Expedients_Types e
                                    ORDER BY    e.name");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result);
            }
        }

        /**
         * Obtiene los datos para la hoja de datos del servicio (Documento)
         *
         * @param string $expedient Expediente
         * @return array
         */
        public function getHojaDatosServicio($expedient){
            $db = new DbHandler;

            $result = $db->query("  SELECT      e.lossNumber, e.deceasedName, e.deceasedSurname, e.deceasedNIF, e.deceasedBirthday, e.deceasedChildOfFather, e.deceasedChildOfMother,
                                                e.deceasedMaritalStatus, e.deceasedFirstNuptials, e.deceasedDate, e.funeralDate, e.funeralTime, e.familyContactName,
                                                e.familyContactSurname, e.familyContactNIF, e.familyContactPhone, e.familyContactMobilePhone, e.familyContactAddress,
                                                l.name as deceasedBirthdayLocation,
                                                di.name as deceasedInName, l2.name as deceasedLocation, l2.province as deceasedProvince,
                                                l3.name as familyContactLocation, l3.name as familyContactProvince
                                    FROM        (Expedients e)
                                    LEFT JOIN   Locations l ON e.deceasedBirthdayLocation = l.locationID
                                    LEFT JOIN   DeceasedIn di ON e.deceasedLocation = di.deceasedInID
                                    LEFT JOIN   Locations l2 ON di.location = l2.locationID
                                    LEFT JOIN   Locations l3 ON e.familyContactLocation = l3.locationID
                                    WHERE       e.expedientID = $expedient");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result)[0];
            }
        }

        /**
         * Obtiene los datos para el formulario de pedido (Documento)
         *
         * @param string $expedient Expediente
         * @return array
         */
        public function getFormularioPedido($expedient){
            $db = new DbHandler;

            $result = $db->query("  SELECT      e.requestDate, CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceased, e.deceasedBirthday, e.deceasedDate, e.lossNumber, e.number, 
                                                e.deceasedMortuary, m.name as mortuaryName, e.deceasedRoom, e.entryDate, e.ceremonyDate, e.ceremonyTime,
                                                e.cremation, ev.start as cremationStart, 
                                                IF(e.churchLabel = 'Otro', e.otherCeremony, ch.name) as churchName,
                                                e.funeralHomeEntryDate, e.funeralHomeEntryTime, e.deceasedMortuaryAddress,
                                                di.name as deceasedInName, l2.name AS deceasedLocation, l2.province AS deceasedProvince
                                    FROM        (Expedients e)
                                    LEFT JOIN   Locations l ON e.deceasedBirthdayLocation = l.locationID
                                    LEFT JOIN   DeceasedIn di ON e.deceasedLocation = di.deceasedInId
                                    LEFT JOIN   Locations l2 ON l2.locationID = di.location
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   Churches ch ON e.church = ch.churchID
                                    LEFT JOIN   Events ev ON e.expedientID = ev.expedient AND ev.type = 1 AND ev.leavingDate IS NULL
                                    WHERE       e.expedientID = $expedient");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result)[0];
            }
        }

        /**
         * Obtiene los datos para el formulario de pedido (Documento)
         *
         * @param string $expedient Expediente
         * @return array
         */
        public function getHojaPedido($expedient){
            $db = new DbHandler;

            $result = $db->query("  SELECT      e.requestDate, m.name as mortuary_name, e.deceasedRoom, e.deceasedName, e.deceasedSurname, e.lossNumber
                                    FROM        (Expedients e)
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    WHERE       e.expedientID = $expedient");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $info = array();

                $info['expedient'] = $db->resultToArray($result)[0];

                $maxNumHiring = $this->getActiveHiring($expedient);

                $result = $db->query("  SELECT 		pm.name as model_name, et.value
                                        FROM 		Expedients_Texts et, Expedients_Hirings eh
                                        LEFT JOIN	Products_Models pm ON eh.model = pm.productModelID
                                        LEFT JOIN	Products p ON eh.product = p.productID
                                        WHERE		et.hiring = eh.ID AND
                                                    eh.expedient = $expedient AND
                                                    eh.num_hiring = $maxNumHiring AND
                                                    p.name LIKE '%albia%'
                                        ORDER BY    pm.productModelID");

                if(mysqli_num_rows($result) == 0){
                    $info['texts'] = array();
                }else{
                    $info['texts'] = $db->resultToArray($result);
                }

                return $info;
            }
        }

        /**
         * Obtiene los datos para la autorización sepultura (Documento)
         *
         * @param string $expedient Expediente
         * @return array
         */
        public function getAutoSepultura($expedient){
            $db = new DbHandler;

            $result = $db->query("  SELECT      CONCAT(e.familyContactName, ' ', e.familyContactSurname) as familyContact, e.familyContactNIF, e.exhumation,
                                                CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceased, e.deceasedGender, e.deceasedMortuaryAddress,
                                                e.deceasedRoom, e.deceasedDate, e.funeralNicheNumber, e.number,
                                                m.name as mortuary, l2.name AS mortuaryLocation,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, c.name) AS cemetery,
                                                l.name AS cemeteryLocation, l.province AS cemeteryProvince,
                                                fh.name as funeralHome, fh.nif as funeralHomeCif, l1.name as funeralHomeLocation,
                                                (
                                                    SELECT  GROUP_CONCAT(p.name SEPARATOR ', ')
                                                    FROM    Users u, Staff s, Staff_Posts sp, Posts p
                                                    WHERE   u.userID = " . $_SESSION['user'] . " AND
                                                            u.userID = s.user AND
                                                            s.leavingDate IS NULL AND
                                                            s.ID = sp.staff AND
                                                            sp.post = p.ID AND
                                                            sp.value = 1
                                                ) as userPosts,
                                                (
                                                    SELECT  CONCAT(u.name, ' ', u.surname)
                                                    FROM    Users u
                                                    WHERE   u.userID = " . $_SESSION['user'] . "
                                                ) as userName
                                    FROM        (Expedients e)
                                    LEFT JOIN   Cemeteries c ON c.cemeteryID = e.cemetery
                                    LEFT JOIN   Locations l ON l.locationID = c.location
                                    LEFT JOIN   FuneralHomes fh ON e.funeralHome = fh.funeralHomeID
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   Locations l1 ON fh.location = l1.locationID
                                    LEFT JOIN   Locations l2 ON l2.locationID = m.location
                                    WHERE       e.expedientID = $expedient");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result)[0];
            }
        }

        /**
         * Obtiene los datos para el mandato expreso
         *
         * @param string $expedient Expediente
         * @return array
         */
        public function getMandatoExpreso($expedient){
            $db = new DbHandler;

            $result = $db->query("  SELECT      CONCAT(e.familyContactName, ' ', e.familyContactSurname) as familyContact, e.familyContactNIF,
                                                CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceased, e.deceasedNIF, e.deceasedDate,
                                                fh.name as funeralHome, fh.nif as funeralHomeCif, l1.name as funeralHomeLocation, e.policy,
                                                c.name as clientName,
                                                e.deceasedGender
                                    FROM        (Expedients e)
                                    LEFT JOIN   Clients c ON c.clientID = e.client
                                    LEFT JOIN   FuneralHomes fh ON e.funeralHome = fh.funeralHomeID
                                    LEFT JOIN   Locations l1 ON fh.location = l1.locationID
                                    WHERE       e.expedientID = $expedient");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result)[0];
            }
        }
        
        /**
         * Obtiene los datos para el reconocimiento previo incineración
         *
         * @param string $expedient Expediente
         * @return array
         */
        public function getReconocPrevioIncineracion($expedient){
            $db = new DbHandler;

            $result = $db->query("  SELECT      CONCAT(e.familyContactName, ' ', e.familyContactSurname) as familyContact, e.familyContactNIF, e.familyContactPhone, 
                                                e.familyContactAddress, e.familyContactRelationship,
                                                CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceased, e.deceasedNIF, e.deceasedDate,
                                                d.name as deceasedLocation, l2.name as deceasedInLocation, l2.province as deceasedInProvince,
                                                l.name as familyContactLocation,
                                                l1.name as funeralHomeLocation,
                                                l3.name as mortuaryLocation,
                                                l4.name as familyContactLocation, l4.province as familyContactProvince
                                    FROM        (Expedients e)
                                    LEFT JOIN   Locations l ON l.locationID = e.familyContactLocation
                                    LEFT JOIN   FuneralHomes fh ON e.funeralHome = fh.funeralHomeID
                                    LEFT JOIN   Locations l1 ON fh.location = l1.locationID
                                    LEFT JOIN   DeceasedIn d ON e.deceasedLocation = d.deceasedInID
                                    LEFT JOIN   Locations l2 ON d.location = l2.locationID
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   Locations l3 ON m.location = l3.locationID
                                    LEFT JOIN   Locations l4 ON e.familyContactLocation = l4.locationID
                                    WHERE       e.expedientID = $expedient");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result)[0];
            }
        }
        
        /**
         * Obtiene los datos para la solicitud de modificación del servicio funerario contratado
         *
         * @param string $expedient Expediente
         * @return array
         */
        public function getModificacionServicioFunerario($expedient){
            $db = new DbHandler;

            $result = $db->query("  SELECT      CONCAT(e.familyContactName, ' ', e.familyContactSurname) as familyContact, e.familyContactNIF, e.familyContactRelationship,
                                                CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceased,
                                                e.policy, c.name as clientName,
                                                CONCAT(l2.name, ', ', l2.province) as mortuaryLocation
                                    FROM        (Expedients e)
                                    LEFT JOIN   Clients c ON c.clientID = e.client
                                    LEFT JOIN   Locations l ON l.locationID = e.familyContactLocation
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   Locations l2 ON l2.locationID = m.location
                                    WHERE       e.expedientID = $expedient");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result)[0];
            }
        }
        
        /**
         * Obtiene los datos para el modelo de hoja de datos
         *
         * @param string $expedient Expediente
         * @return array
         */
        public function getModeloHojaDeDatos($expedient){
            $db = new DbHandler;
            
            $result = $db->query("  SELECT      CONCAT(e.familyContactName, ' ', e.familyContactSurname) as familyContact, e.familyContactNIF, e.familyContactRelationship, e.familyContactAddress,
                                                CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceased, e.deceasedNIF, e.deceasedDate, e.deceasedMortuaryAddress, e.familyContactMobilePhone,
                                                CONCAT(e.applicantName, ' ', e.applicantSurname) as applicant, CONCAT(e.applicantAddress, '(', e.applicantLocation,')') as applicantAddress,e.applicantMail, e.applicantMobilePhone,
                                                e.policy, c.name as clientName,
                                                CONCAT(e.familyContactName, ' ', e.familyContactSurname) as familyContact, e.familyContactPhone,
                                                e.familyContactMail, e.otherContactRelationship, l.name as familyContactLocation, l.postalCode as familyContactPostalCode, l.province as familyContactProvince,
                                                d.name as deceasedLocation, l3.name as cemeteryLocation, fh.name as sourceFuneralHome, fh2.name as destinationFuneralHome,
                                                m.name as mortuaryName, 
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, ce.name) as cemeteryName,
                                                CONCAT(l4.name, ', ', l4.province) AS deceasedInName
                                    FROM        (Expedients e)
                                    LEFT JOIN   Clients c ON c.clientID = e.client
                                    LEFT JOIN   Locations l ON l.locationID = e.familyContactLocation
                                    LEFT JOIN   DeceasedIn d ON e.deceasedLocation = d.deceasedInID
                                    LEFT JOIN   Locations l4 ON l4.locationID = d.location
                                    LEFT JOIN   Locations l2 ON l2.locationID = e.deceasedLocation
                                    LEFT JOIN   FuneralHomes fh ON e.funeralHome = fh.funeralHomeID
                                    LEFT JOIN   FuneralHomes fh2 ON e.moveFuneralHome = fh2.funeralHomeID
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   Cemeteries ce ON e.cemetery = ce.cemeteryID
                                    LEFT JOIN   Locations l3 ON l3.locationID = ce.location
                                    WHERE       e.expedientID = $expedient");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result)[0];
            }
        }

        /**
         * Obtiene los datos para el documento 'Recepción de cadáveres de otras funerarias)
         *
         * @param string $expedient Expediente
         * @return array
         */
        public function getRecepcionCadaveresOtrasFunerarias($expedient){
            $db = new DbHandler;
            
            $result = $db->query("  SELECT      CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceased, e.deceasedNIF, e.deceasedDate, e.deceasedTime, 
                                                e.coffin, e.otherCoffin,
                                                f.name as funeralHomeName, f.nif as funeralHomeNif, f.address as funeralHomeAddress,
                                                l.name as funeralHomeLocation, l.postalCode as funeralHomePostalCode, l.province as funeralHomeProvince,
                                                f.phones as funeralHomePhone, f.mail as funeralHomeEmail
                                    FROM        (Expedients e)
                                    LEFT JOIN   FuneralHomes f ON e.funeralHome = f.funeralHomeID
                                    LEFT JOIN   Locations l ON f.location = l.locationID
                                    WHERE       e.expedientID = $expedient");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result)[0];
            }
        }

        /**
         * Obtiene los datos para el documento 'Conservacion Autorizacion Familiar'
         *
         * @param string $expedient Expediente
         * @return array
         */
        public function getConservacionAutorizacionFamiliar($expedient){
            $db = new DbHandler;
            
            $result = $db->query("  SELECT      CONCAT(e.deceasedName, ' ', e.deceasedSurname) as deceased, e.deceasedGender, e.deceasedDate, e.deceasedTime, 
                                                CONCAT(e.familyContactName, ' ', e.familyContactSurname) as applicant, e.familyContactNIF as applicantNIF, e.familyContactRelationship as applicantRelationship,
                                                f.name as funeralHomeName,
                                                CONCAT(st.name, ' ', st.surname) AS responsibleUser, st.nif as responsibleUserNif
                                    FROM        (Expedients e)
                                    LEFT JOIN   FuneralHomes f ON e.funeralHome = f.funeralHomeID
                                    LEFT JOIN   Staff st ON e.responsibleUser = st.ID
                                    WHERE       e.expedientID = $expedient");
            
            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                return $db->resultToArray($result)[0];
            }
        }

        /**
         * Comprueba si un expediente presupuesto puede ser transformado a defunción o varios
         *
         * @param string $expedient Expediente
         * @return array
         */
        public function canBeConverted($expedient){
            $db = new DbHandler;

            // Comprueba si el cliente es "Cliente de Contado"
            switch($_SESSION['company']){
                case '1':
                case '3':
                    $clientContado = '1116';
                break;
                case '2':
                    $clientContado = '573';
                break;
                case '4':
                    $clientContado = '22';
                break;
                case '5':
                    $clientContado = '24';
                break;
                case '27':
                    $clientContado = '1058';
                break;
                default:
                    $clientContado = '1';
                break;
            }

            $result = $db->query("  SELECT  e.expedientID
                                    FROM    Expedients e
                                    WHERE   e.type = 2 AND
                                            e.expedientID = $expedient AND
                                            e.client = $clientContado");

            if(mysqli_num_rows($result) == 0){
                return true;
            }

            $data = $this->getFactura($expedient);

            $listIvas = [];
            $bruto = 0;
            $supplied = 0;
            $totalDiscount = 0;
            $subTotalDiscount = 0;
            $total = 0;
            $discountAmount  = 0;

            if(isset($data['factura'])){
                for($i = 0; $i < count($data['factura']); $i++) {
                    $priceNoIVA = $data['factura'][$i]['priceNoIVA']; //tarifa asociada al cliente
                    $particularPrice = $data['factura'][$i]['particularPrice']; //tarifa de particulares
                    $percentage = $data['factura'][$i]['percentage'];
                    
                    if($data['factura'][$i]['multipleDiscount'] == null){
                        $amount = $data['factura'][$i]['amount'];                                            
                    }else{
                        $amount = 1;
                    }

                    if($data['factura'][$i]['editPrice'] == '1'){
                        $priceNoIVA = $data['factura'][$i]['totalEditPrice'];
                    }

                    if($data['factura'][$i]['texts'] == 0){
                        $discount = $data['factura'][$i]['discount'];  
                        $subTotalDiscount = floatval($priceNoIVA) * floatval($discount) / 100;
                        $subtotalPrice = floatval($priceNoIVA) - floatval($subTotalDiscount);                                            
                        $discountAmount = floatval($particularPrice) - floatval($subtotalPrice);
                        if($discountAmount < 0){
                            $discountAmount = 0;
                        }                                          
                        $subtotalPrice = floatval($subtotalPrice) * floatval($amount);                                        
                        if(floatval($particularPrice) == 0.00){
                            $discountAmount = $priceNoIVA * $amount - abs(floatval($particularPrice) * $amount - floatval($subtotalPrice));
                        }               
                    }else{
                        $discount = $data['factura'][$i]['multipleDiscount']; 
                        $subTotalDiscount = floatval($priceNoIVA) * floatval($discount) / 100 ;                                            
                        $subtotalPrice = floatval($priceNoIVA) - floatval($subTotalDiscount);                                            
                        $discountAmount = floatval($particularPrice) - floatval($subtotalPrice);     
                        if($discountAmount < 0){
                            $discountAmount = 0;
                        }                                       
                        if(floatval($particularPrice) == 0.00){                                      
                            $discountAmount = $priceNoIVA * $amount - abs(floatval($particularPrice) * $amount - floatval($subtotalPrice));
                        }
                    }
                    if($subtotalPrice < 0){
                        $totalDiscount += abs($subtotalPrice);
                    }else{
                        $totalDiscount = floatval($totalDiscount) + (floatval($discountAmount)*floatval($amount));
                    }

                    // Get ivas
                    $keys = array_column($listIvas, 'type_iva');
                    $indexAux = array_search($percentage, $keys);

                    $subTotal = floatval($subtotalPrice);
                    $ivaAmount = ($subtotalPrice * floatval($percentage)) / 100;

                    if ($indexAux === false) {
                        $listIvas[] = [
                            'type_iva' => $percentage,
                            'base' => $subTotal,
                            'iva' => $ivaAmount
                        ];
                    } else {
                        $listIvas[$indexAux]['base'] += $subTotal;
                        $listIvas[$indexAux]['iva'] += $ivaAmount;
                    }      
                }
            }

            if(isset($data['suplidos'])){
                foreach($data['suplidos'] AS $index => $producto){
                    $price = $producto['cost'];

                    if($producto['multipleDiscount'] == null){
                        $amount = $producto['amount'];
                    }else{
                        $amount = 1;
                    }

                    if($producto['texts'] == 0){                                       
                        $discount = $producto['discount'];                                       
                        $priceDiscount = floatval($price) * floatval($discount) / 100 ;
                        $subTotal = floatval($price) - floatval($priceDiscount) ;
                        $subTotal = floatval($subTotal) * floatval($amount);
                    }else{
                        $discount = $producto['multipleDiscount'];                                       
                        $priceDiscount = floatval($price) * floatval($discount) / 100;
                        $subTotal = floatval($price) - floatval($priceDiscount);
                    }                                    
                                                
                    $totalDiscount = floatval($totalDiscount) + (floatval($priceDiscount)* floatval($amount));
                    if($subTotal < 0){
                        $totalDiscount += abs($subTotal);
                    } 
                    $supplied = floatval($supplied) + floatval($subTotal);                                    
                    
                    if($discount == 0 || $discount == 0.00){
                        $discount = '-';
                    }else{
                        $discount = number_format($discount, 2) . ' %';
                    }
                }
            }

            // Calculate total
            $total += $supplied;
            $bruto += $supplied;
            foreach($listIvas as $index=>$elem){
                $total += floatval($elem['base']) + floatval($elem['iva']);
                $bruto += floatval($elem['base']);

                $listIvas[$index]['base'] = number_format(floatval($elem['base']),2);
                $listIvas[$index]['iva'] = number_format(floatval($elem['iva']),2);
            }
            $total = round($total, 2, PHP_ROUND_HALF_DOWN);

            if($total > 400){
                return false;
            }else{
                return true;
            }
        }

        /**
         * Actualiza el stock de los productos de un presupuesto al ser convertido a defunción o varios
         *
         * @param string $expedient Expediente
         * @return array
         */
        public function updateHiringStock($expedient, $mode = 0, $numHiring = null){

            /**
             * No es necesario calcular si hay que escribir en Expedients_Hirings o Expedients_Hirings_Rectified ya que esta función se utiliza
             * cuando convertimos un prespuesto a una defunción o varios, entonces la tabla siempre será Expedients_Hirings
            **/

            $where = '';
            if($numHiring == null){
                 $where = " AND eh.num_hiring = (
                    SELECT  MAX(eh2.num_hiring)
                    FROM    Expedients_Hirings eh2
                    WHERE   eh2.expedient = eh.expedient
                )";
            }else{
                $where = " AND eh.num_hiring = $numHiring ";
            }

            $db = new DbHandler;
            $result = $db->query("  SELECT  eh.check, eh.amount, eh.model, eh.warehouse
                                    FROM    Expedients_Hirings eh, Products p, Expedients e
                                    WHERE   eh.product = p.productID AND
                                            p.type = 2 AND
                                            eh.expedient = e.expedientID AND
                                            eh.check = 1 AND
                                            e.expedientID = $expedient AND
                                            e.type != 2
                                            $where
            ");

            if(mysqli_num_rows($result) > 0){
               
                $stock = new Stock;
                $hiringProducts = $db->resultToArray($result);

                foreach($hiringProducts as $product){  
                    if($mode == 0){
                        $stock->delStock($product['warehouse'], $product['model'], $product['amount']);
                    }else{
                        $stock->addStock($product['warehouse'], $product['model'], $product['amount']);
                    }
                }
            }

            return true;
        }

        /**
         * Devuelve si la contratación activa es la normal o la rectificada
         * 
         * @return int
         */
        public function getActiveHiring($expedientID){
            $db = new DbHandler;

            $result = $db->query("  SELECT  COALESCE(MAX(eh.num_hiring), 0) as num_hiring
                                    FROM    Expedients_Hirings eh
                                    WHERE   eh.expedient = $expedientID");

            if(mysqli_num_rows($result) > 0){
                $maxNumHiring = $db->resultToArray($result)[0]['num_hiring'];
                return $maxNumHiring;
            }else{
                return 0;
            }
        }

        /**
         * Obtiene los datos para la estadísticas de control de emisiones
         * 
         * @param int $data
         * 
         * @return array
         */
        public function getEmissionsControlStatistics($from, $to, $scale){
            $db = new DbHandler;

            $from = cleanStr($from);
            $to = cleanStr($to);
            $scale = cleanStr($scale);

            $where = '';
            $where .= $scale != null && $scale != 'null' ? " AND e.smokeOpacityBacharachScale = $scale" : '';
            
            $result = $db->query("  SELECT  e.expedientID, e.number, 
                                            DATE_FORMAT(FROM_UNIXTIME(e.smokeOpacityDateStart), '%d/%m/%Y'), 
                                            DATE_FORMAT(FROM_UNIXTIME(e.smokeOpacityTimeStart), '%H:%i'),
                                            e.smokeOpacityLoadWeight,
                                            DATE_FORMAT(FROM_UNIXTIME(e.smokeOpacityDateEnd), '%d/%m/%Y'), 
                                            DATE_FORMAT(FROM_UNIXTIME(e.smokeOpacityTimeEnd), '%H:%i'),
                                            e.smokeOpacityBacharachScale, 
                                            DATE_FORMAT(FROM_UNIXTIME(e.smokeOpacityDateReading), '%d/%m/%Y'), 
                                            DATE_FORMAT(FROM_UNIXTIME(e.smokeOpacityTimeReading), '%H:%i'),
                                            IF(e.smokeOpacityIncidents = 0, 'No', 'Sí'),
                                            IF(e.smokeOpacityIncidents = 0, '-', e.smokeOpacityIncidentsNotes)
                                    FROM    Expedients e, Events ev
                                    WHERE   e.crematoriumEvent = ev.ID AND 
                                            e.cremation = 1 AND
                                            ev.start >= '$from' AND
                                            ev.end <= '$to' AND
                                            e.leavingDate IS NULL
                                            $where
            ");

            return mysqli_num_rows($result) > 0 ? $db->resultToArrayValue($result) : [];
        }

        /**
        * Obtiene la información de una salida de hoy - TIMELINE EVENT
        *
        * @return array
        */
        public function getDepartureTodayInfo($expedient){
            $db = new DbHandler;

            $result = $db->query("  SELECT      e.expedientID, e.type, e.funeralDate, e.funeralTime, e.number, e.deceasedGender, e.deceasedName, e.deceasedSurname, e.deceasedRoom, e.crematoriumArriveTime,
                                                m.name AS mortuary,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, c.name) AS cemetery,
                                                l.name AS mortuaryLocation,
                                                IF(e.churchLabel = 'Otro', e.otherCeremony, ch.name) AS church,
                                                es.carriersTime,
                                                f.name AS funeralHome
                                    FROM        (Expedients e, Expedients_Services es)
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   Cemeteries c ON e.cemetery = c.cemeteryID
                                    LEFT JOIN   Churches ch ON e.church = ch.churchID
                                    LEFT JOIN   Locations l ON ch.location = l.locationID
                                    LEFT JOIN   FuneralHomes f ON f.funeralHomeID = es.funeralHomeService
                                    WHERE       es.expedient = e.expedientID AND
                                                e.expedientID = $expedient");

            $expedients = $db->resultToArray($result);

            if(mysqli_num_rows($result) > 0){
                foreach($expedients as $key => $expedient){
                    $carriers = $db->query("SELECT  c.name, c.surname, sc.confirmed
                                            FROM    Carriers c, Services_Carriers sc
                                            WHERE   c.carrierID = sc.carrier AND
                                                    sc.service = " . $expedient['expedientID']);

                    if(mysqli_num_rows($carriers) > 0){
                        $expedients[$key]['carriers'] = $db->resultToArray($carriers);
                    }else{
                        $expedients[$key]['carriers'] = array();
                    }

                    $cars = $db->query("    SELECT      ca.name AS driverName, ca.surname AS driverSurname, c.licensePlate, c.brand, c.model, sca.confirmed
                                            FROM        (Cars c, Services_Cars sc, Expedients e)
                                            LEFT JOIN   Carriers ca ON sc.driver = ca.carrierID
                                            LEFT JOIN   Services_Carriers sca ON ca.carrierID = sca.carrier AND sca.service = e.expedientID
                                            WHERE       e.expedientID = sc.service AND
                                                        c.ID = sc.car AND
                                                        sc.service = " . $expedient['expedientID']);

                    if(mysqli_num_rows($cars) > 0){
                        $expedients[$key]['cars'] = $db->resultToArray($cars);
                    }else{
                        $expedients[$key]['cars'] = array();
                    }

                    $maxNumHiring = $this->getActiveHiring($expedient['expedientID']);
                    $buses = $db->query("   SELECT  SUM(eh.amount) AS buses
                                            FROM    Expedients_Hirings eh, Products p
                                            WHERE   eh.expedient = " . $expedient['expedientID'] . " AND
                                                    eh.check = 1 AND
                                                    eh.product = p.productID AND
                                                    eh.num_hiring = $maxNumHiring AND
                                                    p.isBus = 1");

                    if(mysqli_num_rows($buses) > 0){
                        $expedients[$key]['buses'] = $db->resultToArray($buses)[0]['buses'];
                    }else{
                        $expedients[$key]['buses'] = 0;
                    }                                     
                }
            }

            return count($expedients) > 0 ? $expedients[0] : null;
        }

        /**
        * Obtiene la información de una cremación - TIMELINE EVENT
        *
        * @return array
        */
        public function getCremationInfo($expedient){
            $db = new DbHandler;

            $result = $db->query("  SELECT      e.number, e.deceasedName, e.deceasedSurname, f.name AS funeralHome, e.crematoriumPacemaker, e.crematoriumIntroduction, e.crematoriumVaseBio,
                                                e.authDate, e.authTime, e.authPlace, e.trazabilityId
                                    FROM        (Expedients e, Expedients_Services es)
                                    LEFT JOIN   FuneralHomes f ON f.funeralHomeID = es.funeralHomeService
                                    WHERE       es.expedient = e.expedientID AND
                                                e.expedientID = $expedient");
            $cremations = $db->resultToArray($result);

            return count($cremations) > 0 ? $cremations[0] : null;
        }

        /**
         * Obtiene el número del expediente
         * 
         * @param int $id Id del expediente
         * @return string Número del expediente
         */
        public function getDataForDocumentsEditor($expedient){
            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $result = $db->query("  SELECT      e.number, e.requestTime, e.requestDate, e.type, e.clientType, e.policy, e.capital, e.lossNumber, e.internalRef,
                                                e.status, e.applicantName, e.applicantSurname, e.applicantAddress, e.applicantMail, e.applicantPhone,
                                                e.applicantPhone, e.applicantMobilePhone, e.applicantNIF, e.familyContactName, e.familyContactSurname,
                                                e.familyContactAddress, e.familyContactMail, e.familyContactPhone, e.familyContactMobilePhone,
                                                e.familyContactNIF, e.familyContactRelationship, e.familyContactNationality, e.otherContactName,
                                                e.otherContactPhone, e.otherContactRelationship, e.deceasedName, e.deceasedSurname, e.deceasedNIF,
                                                IF(e.deceasedMaritalStatus = 'Otros', e.deceasedMaritalStatusDescription, e.deceasedMaritalStatus) as deceasedMaritalStatus,
                                                e.deceasedFirstNuptials, e.deceasedSecondNuptials, e.deceasedGender,
                                                e.deceasedChildOfFather, e.deceasedChildOfMother, e.deceasedNationality, e.deceasedNationalityName,
                                                e.deceasedNationalityProvince, e.deceasedNationalityLocation, e.deceasedBirthday, e.deceasedUsualAddress,
                                                e.deceasedDate, e.deceasedTime, e.deceasedDoctor, do.name as deceasedDoctorName, e.deceasedDoctorCertificate, e.deceasedCause,
                                                e.deceasedTribunal, e.deceasedTribunalNumber, e.deceasedRoom, 
                                                e.startVelacionDate, e.startVelacionTime, e.endVelacionDate, e.endVelacionTime,
                                                e.startVelacionDate2, e.startVelacionTime2, e.endVelacionDate2, e.endVelacionTime2,
                                                e.churchLabel, e.cemeteryLabel, e.funeralDate, e.funeralTime, e.ceremonyDate, e.ceremonyTime,
                                                e.funeralDateNew, e.funeralTimeNew, e.niche, e.funeralNicheNumber, e.funeralBusyNiche, e.regime,
                                                e.exhumation, e.nicheHeight, e.crematoriumTechnical, e.trazabilityId, e.crematoriumContactPerson,
                                                e.crematoriumContactPersonPhone, e.crematoriumArriveTime, e.authName, e.authDni, e.authContactPhone,
                                                e.authDate, e.authTime, e.authPlace, e.smokeOpacityLoadWeight, e.smokeOpacityBacharachScale,
                                                e.smokeOpacityDateReading, e.smokeOpacityTimeReading, e.funeralHomeEntryDate, e.funeralHomeEntryTime, e.coffin,
                                                e.tanatologicalPractice, e.moveContactPerson, e.moveContactPhone, e.moveLeavingDate, e.moveLeavingTime,
                                                e.moveCollectionAddress, e.moveDestinationAddress, e.moveVia, e.moveFinalDestination,
                                                es.arriveTime, es.arriveDate, e.flightNumber, e.airportOrigin, e.arrivalAirport, e.arrivalDate, e.arrivalTime, e.moveNotes, e.notesExpedient,
                                                e.departureDate, e.departureTime, e.familyContactOtherLocation, e.familyContactOtherProvince, e.familyContactOtherCountry,
                                                e.agency, e.agencyContact, e.agencyContactPhone,
                                                e.otherCoffin, 
                                                e.deceasedNiche, e.funeralDateNiche, 
                                                e.deceasedNiche2, e.funeralDateNiche2, 
                                                e.deceasedNiche3, e.funeralDateNiche3, 
                                                e.crematoriumContactPhonePerson,
                                                e.crematoriumIntroduction, e.crematoriumWaitOnRoom, e.crematoriumVaseBio, e.ecologicCoffin, e.crematoriumPacemaker,
                                                e.covid, e.moveJudicial, e.moveTraslado, e.moveDevolucion, e.funeralDateBurial, e.funeralTimeBurial, e.notesExpedient,
                                                e.refrigeratedChamberName, e.refrigeratedChamberDateStart, e.refrigeratedChamberTimeStart, e.refrigeratedChamberDateEnd, e.refrigeratedChamberTimeEnd,
                                                di.name as deceasedInName, e.deceasedLocality, e.deceasedProvince,
                                                l.name as applicantLocation, l.province as applicantProvince, l.postalCode as applicantPostalCode,
                                                l2.name as familyContactLocation, l2.province as familyContactProvince, l2.postalCode as familyContactPostalCode,
                                                c.brandName as clientBrandName, c.name as clientName, c.surname as clientSurname, c.nif as clientNIF,
                                                c.mail as clientMail, c.address as clientAddress, c.phones as clientPhones,
                                                l3.name as clientLocation, l3.province as clientProvince, l3.postalCode as clientPostalCode,
                                                l4.name as deceasedBirthdayLocation, l4.province as deceasedBirthdayProvince, l4.postalCode as deceasedBirthdayPostalCode,
                                                l5.name as deceasedInLocation, l5.province as deceasedInProvince,
                                                m.name as mortuaryName,
                                                IF(e.churchLabel = 'Otro', e.otherCeremony, ch.name) AS churchName,
                                                IF(e.cemeteryLabel = 'Otro', e.otherInhumation, ce.name) AS cemeteryName,
                                                cr.name as crematoriumName,
                                                ev.status as crematoriumStatus, ev.start as crematoriumStart, ev.end as crematoriumEnd,
                                                fh4.name as crematoriumClientName, fh4.nif as crematoriumClientCif, fh4.phones as crematoriumClientPhone,
                                                fh.name as funeralHomeService,
                                                es.carCollection as carCollection1, ca.licensePlate as carCollectionLicensePlate, ca.brand as carCollectionBrand, ca.model as carCollectionModel,
                                                e.carCollection1LicensePlate, e.carCollection1Brand, e.carCollection1Model,
                                                e.hearse, ca2.licensePlate as hearseLicensePlate, ca2.brand as hearseBrand, ca2.model as hearseModel,
                                                e.hearseLicensePlate as hearseLicensePlateOther, e.hearseBrand as hearseBrandOther, e.hearseModel as hearseModelOther,
                                                st1.name as corpseCollection1Name, st1.surname as corpseCollection1Surname,
                                                st2.name as corpseCollection2Name, st2.surname as corpseCollection2Surname,
                                                dpm.name as placeDestinationMiddleName, l6.name as placeDestinationMiddleLocation,
                                                cm2.name AS placeDestinationFinalCemeteryName,
                                                fh2.name as funeralHomeName, fh2.nif as funeralHomeNif, fh2.fax as funeralHomeFax,
                                                st3.name as responsibleUserName, st3.surname as responsibleUserSurname, st3.nif as responsibleUserNif,
                                                fh3.name as moveFuneralHomeName, fh3.nif as moveFuneralHomeNif, fh3.phones as moveFuneralHomePhone, fh3.fax as moveFuneralHomeFax, fh3.address as moveFuneralHomeAddress,
                                                l7.name as moveCollectionLocation, l7.province as moveCollectionProvince, l7.postalCode as moveCollectionPostalCode,
                                                l8.name as moveDestinationLocation, l8.province as moveDestinationProvince, l8.postalCode as moveDestinationPostalCode,
                                                st4.name as familyAssistanceName, st4.surname as familyAssistanceSurname,
                                                st4.name as crematoriumTechnicalName, st4.surname as crematoriumTechnicalSurname,
                                                exwo.ID as workOrderID,
                                                exwo.arkEmbalmmentDate as workOrderArkEmbalmmentDate,
                                                exwo.arkEmbalmmentTime as workOrderArkEmbalmmentTime,
                                                exwo.arkCTransientDate as workOrderArkCTransientDate,
                                                exwo.arkCTransientTime as workOrderArkCTransientTime,
                                                exwo.arkClothes as workOrderArkClothes,
                                                exwo.arkAesthetics as workOrderArkAesthetics,
                                                exwo.arkCross as workOrderArkCross,
                                                exwo.arkJesus as workOrderArkJesus,
                                                exwo.arkClothesRosary as workOrderArkClothesRosary,
                                                exwo.inhumationIronCross as workOrderInhumationIronCross
                                    FROM        (Expedients e, Expedients_Services es)
                                    LEFT JOIN   Locations l ON e.applicantLocation = l.locationID
                                    LEFT JOIN   Locations l2 ON e.familyContactLocation = l2.locationID
                                    LEFT JOIN   Clients c ON e.client = c.clientID
                                    LEFT JOIN   Locations l3 ON c.location = l3.locationID
                                    LEFT JOIN   Locations l4 ON e.deceasedBirthdayLocation = l4.locationID
                                    LEFT JOIN   DeceasedIn di ON e.deceasedLocation = di.deceasedInID
                                    LEFT JOIN   Locations l5 ON di.location = l5.locationID
                                    LEFT JOIN   Mortuaries m ON e.deceasedMortuary = m.mortuaryID
                                    LEFT JOIN   Churches ch ON e.church = ch.churchID
                                    LEFT JOIN   Cemeteries ce ON e.cemetery = ce.cemeteryID
                                    LEFT JOIN   Crematoriums cr ON e.crematorium = cr.crematoriumID
                                    LEFT JOIN   Events ev ON e.crematoriumEvent = ev.ID
                                    LEFT JOIN   FuneralHomes fh4 ON e.crematoriumClient = fh4.funeralHomeID
                                    LEFT JOIN   FuneralHomes fh ON es.funeralHomeService = fh.funeralHomeID
                                    LEFT JOIN   Cars ca ON es.carCollection = ca.ID
                                    LEFT JOIN   Cars ca2 ON e.hearse = ca2.ID
                                    LEFT JOIN   Staff st1 ON es.corpseCollection1 = st1.ID
                                    LEFT JOIN   Staff st2 ON es.corpseCollection2 = st2.ID
                                    LEFT JOIN   Destination_Places_Middles dpm ON dpm.ID = e.placeDestinationMiddle
                                    LEFT JOIN   Locations l6 ON l6.locationID = dpm.location
                                    LEFT JOIN   Cemeteries cm2  ON e.placeDestinationFinalCemetery = cm2.cemeteryID
                                    LEFT JOIN   FuneralHomes fh2 ON e.funeralHome = fh2.funeralHomeID
                                    LEFT JOIN   Staff st3 ON e.responsibleUser = st3.ID
                                    LEFT JOIN   FuneralHomes fh3 ON e.moveFuneralHome = fh3.funeralHomeID
                                    LEFT JOIN   Locations l7 ON l7.locationID = e.moveCollection
                                    LEFT JOIN   Locations l8 ON l8.locationID = e.moveDestination
                                    LEFT JOIN   Doctors do ON do.ID = e.deceasedDoctor
                                    LEFT JOIN   Staff st4 ON es.familyAssistance = st4.ID
                                    LEFT JOIN   Staff st5 ON e.crematoriumTechnical = st5.ID
                                    LEFT JOIN   Expedients_Work_Orders exwo ON exwo.expedient = e.expedientID
                                    WHERE       e.expedientID = $expedient AND
                                                e.expedientID = es.expedient
            ");

            if(mysqli_num_rows($result) == 0){
                return null;
            }else{
                $expedientInfo = $db->resultToArray($result)[0];

                // Get Ark name
                $expedientInfo['workOrderArkName'] = null;
                $arca = $db->query("    SELECT  CONCAT(s.name, ' - ', pm.name) as name
                                        FROM    Expedients_Hirings eh, Products p, Products_Models pm, Suppliers s
                                        WHERE   eh.expedient = " . $expedient . " AND
                                                eh.check = 1 AND
                                                eh.product = p.productID AND
                                                p.isArca = 1 AND
                                                eh.model = pm.productModelID AND
                                                eh.supplier = s.supplierID
                ");

                if(mysqli_num_rows($arca) > 0){
                    $resultArks = $db->resultToArray($arca);
                    
                    $arkName = '';
                    foreach($resultArks as $item){
                        $arkName .= $item['name'] . ' + ';
                    }
                    if($arkName != ''){
                        $arkName = substr($arkName, 0, -3);
                    }

                    $expedientInfo['workOrderArkName'] = $arkName;
                }

                $expedientInfo['workOrderCommunication'] = array();

                if($expedientInfo['workOrderID'] != null && $expedientInfo['workOrderID'] != ''){

                    $workOrderID = $expedientInfo['workOrderID'];

                    // Comunication Items
                    $communication = $db->query("   SELECT      eh.ID, 
                                                                p.name as product_name, 
                                                                pm.name as model_name,
                                                                exwoc.ID as work_order_communication_id,
                                                                exwoc.date,
                                                                exwoc.photo
                                                    FROM        (Expedients_Hirings eh, Products p, Products_Models pm, Suppliers s)
                                                    LEFT JOIN   Expedients_Work_Orders_Communication exwoc ON exwoc.hiring = eh.ID AND exwoc.leavingDate IS NULL AND exwoc.workOrder = $workOrderID
                                                    WHERE       eh.expedient = " . $expedient . " AND
                                                                eh.check = 1 AND
                                                                eh.product = p.productID AND
                                                                p.blockBelow = 8 AND
                                                                eh.model = pm.productModelID AND
                                                                eh.supplier = s.supplierID
                                                                
                    ");

                    if(mysqli_num_rows($communication) > 0){
                        $expedientInfo['workOrderCommunication'] = $db->resultToArray($communication);
                    }
                }

                return $expedientInfo;
            }
        }
        
        /**
        * Obtiene las contrataciones creadas para un expediente
        *
        * @param array $expedient Expedient id
        *
        * @return array
        */
        public function getHirings($expedient){
            $db = new DbHandler;

            $result = $db->query("  SELECT      DISTINCT eh.num_hiring as id, 
                                                IF(
                                                    (
                                                        SELECT  COUNT(*)
                                                        FROM    Invoices i
                                                        WHERE   i.leavingDate IS NULL AND
                                                                i.expedient = $expedient AND
                                                                i.num_hiring = eh.num_hiring
                                                    ) > 0,
                                                    (
                                                        SELECT  i.generatedInvoiceNumber
                                                        FROM    Invoices i
                                                        WHERE   i.leavingDate IS NULL AND
                                                                i.expedient = $expedient AND
                                                                i.num_hiring = eh.num_hiring 
                                                    ),
                                                    'Actual'
                                                ) as text,
                                                i.invoice_type,
                                                i.rectified_type
                                    FROM        Expedients_Hirings eh
                                    LEFT JOIN   Invoices i ON i.leavingDate iS NULL AND i.expedient = eh.expedient AND i.num_hiring = eh.num_hiring
                                    WHERE       eh.expedient = $expedient
            ");

            $hirings = $db->resultToArray($result);

            return count($hirings) > 0 ? $hirings : [];
        }

        /**
        * Obtiene la información de la contratación actual
        *
        * @param array $expedient Expedient id
        *
        * @return array
        */
        public function getHiringInfo($expedient, $numHiring){
            $db = new DbHandler;

            $result = $db->query("  SELECT      eh.rectified_type,
                                                i.invoice_type
                                    FROM        Expedients_Hirings eh
                                    LEFT JOIN   Invoices i ON i.leavingDate IS NULL AND i.expedient = eh.expedient AND i.num_hiring = eh.num_hiring
                                    WHERE       eh.expedient = $expedient AND
                                                eh.num_hiring = $numHiring
                                    LIMIT       1
            ");

            $hirings = $db->resultToArray($result);

            return count($hirings) > 0 ? $hirings[0] : null;
        }

        /**
        * Generate hiring rectified
        *
        * @param int $expedient Expedient id
        * @param int $rectifiedType Type of rectification (1->S, 2->I)
        *
        * @return array
        */
        public function generateRectificada($expedient, $rectifiedType = null){

            $db = new DbHandler;

            $expedient = cleanStr($expedient);

            $maxNumHiring = $this->getActiveHiring($expedient);
            $newMaxNumHiring = intval($maxNumHiring) + 1;

            // Get expedient price
            $result = $db->query("  SELECT  e.priceExp
                                    FROM    Expedients e
                                    WHERE   e.expedientID = $expedient
            ");
            $priceExp = 'null';
            if(mysqli_num_rows($result) > 0){
                $result = $db->resultToArray($result);
				$priceExp = $result[0]['priceExp'];
			}

            // Get current hirings
            $result = $db->query("  SELECT  *
                                    FROM    Expedients_Hirings eh
                                    WHERE   eh.expedient = $expedient AND 
                                            eh.num_hiring = (
                                                SELECT  MAX(i2.num_hiring)
                                                FROM    Invoices i2
                                                WHERE   i2.expedient = eh.expedient AND
                                                        i2.leavingDate IS NULL AND
                                                        i2.invoice_type != 3
                                            )
            ");

            if(mysqli_num_rows($result) == 0){

                $result = $db->query("  SELECT  *
                                        FROM    Expedients_Hirings eh
                                        WHERE   eh.expedient = $expedient AND 
                                                eh.num_hiring = 0
                ");

                if(mysqli_num_rows($result) == 0){
                    return [
                        "status" => false,
                        "error" => 'Get Expedients_Hirings'
                    ];
                }
            }
            $currentHirings = $db->resultToArray($result);
            
            foreach($currentHirings as $hiring){

                // Calculate extraID
                $result = $db->query(" SELECT MAX(ID) as id FROM Expedients_Hirings");

                $maxID = mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0]['id'] : '1';
                $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 7);
                $extraID .= ($maxID+1);

                if($hiring['template'] == null){
                    $hiring['template'] = 'null';
                }
                if($hiring['warehouse'] == null){
                    $hiring['warehouse'] = 'null';
                }

                // Create new row in hiring
                $response = $db->query(" 
                    INSERT INTO Expedients_Hirings(
                        expedient, template, product, model, supplier, retail, 
                        amount, texts, discount, total, `check`, extraID, 
                        warehouse, num_hiring, priceExp, rectified_type, old_hiring
                    )
                    VALUES ($expedient, " . $hiring['template'] . ", " . $hiring['product'] . ", " . $hiring['model'] . ", " . $hiring['supplier'] . ", " . $hiring['retail'] . ",
                            " . $hiring['amount'] . ", '', " . $hiring['discount'] . ", " . $hiring['total'] . ", " . $hiring['check'] . ", '$extraID',
                            " . $hiring['warehouse'] . ", $newMaxNumHiring, $priceExp, $rectifiedType, " . $hiring['ID'] . "
                    )
                ");

                if(!$response){
                    return [
                        "status" => false,
                        "error" => 'Error insert in Expedients_Hirings'
                    ];
                }
                $newHiringId = $db->getLastInsertId();

                // Search Texts
                $result = $db->query("  SELECT  *
                                        FROM    Expedients_Texts et
                                        WHERE   et.hiring = " . $hiring['ID'] . "
                ");

                if(mysqli_num_rows($result) > 0){
                    $currentHiringsTexts = $db->resultToArray($result);

                    foreach($currentHiringsTexts as $hirText){

                        $response = $db->query("
                            INSERT INTO Expedients_Texts(
                                hiring, rowIndex, value, discount
                            ) VALUES (
                                $newHiringId, " . $hirText['rowIndex'] . ", '" . $hirText['value'] . "', " . $hirText['discount'] . "
                            )
                        ");

                        if(!$response){
                            return [
                                "status" => false,
                                "error" => 'Error insert in Expedients_Texts'
                            ];
                        }
                    }
                }     

                // Pre Orders
                $result = $db->query("  SELECT  *
                                        FROM    Pre_Orders po
                                        WHERE   po.leavingDate IS NULL AND
                                                po.hiring = " . $hiring['ID'] . "
                ");

                if(mysqli_num_rows($result) > 0){
                    $currentHiringsPreOrders = $db->resultToArray($result);

                    foreach($currentHiringsPreOrders as $hirOrd){

                        if($hirOrd['order'] == null){
                            $hirOrd['order'] = 'null';
                        }

                        $response = $db->query("
                            INSERT INTO Pre_Orders(
                                hiring, `order`, sentEmail, sendCopy
                            ) VALUES (
                                $newHiringId, " . $hirOrd['order'] . ", '" . $hirOrd['sentEmail'] . "', '" . $hirOrd['sendCopy'] . "'
                            )
                        ");

                        if(!$response){
                            return [
                                "status" => false,
                                "error" => 'Error insert in Pre_Orders'
                            ];
                        }
                    }
                }

                // Service Auto
                $result = $db->query("  SELECT  *
                                        FROM    Services_Auto sa
                                        WHERE   sa.hiring = " . $hiring['ID'] . "
                ");

                if(mysqli_num_rows($result) > 0){
                    $currentHiringsServiceAuto = $db->resultToArray($result);

                    foreach($currentHiringsServiceAuto as $hirServAuto){

                        $response = $db->query("
                            INSERT INTO Services_Auto(
                                service, model, action, value, status, hiring
                            ) VALUES (
                               " . $hirServAuto['service'] . ", " . $hirServAuto['model'] . ", " . $hirServAuto['action'] . ", '" . $hirServAuto['value'] . "', " . $hirServAuto['status'] . ",  $newHiringId
                            )
                        ");

                        if(!$response){
                            return [
                                "status" => false,
                                "error" => 'Error insert in Services_Auto'
                            ];
                        }
                    }
                }
            }

            return [
                "status" => true,
            ];
        }

        /**
         * Cancela la contratación rectificada de un expediente
         *
         * @param string $expedient Expediente
         * @return array
         */
        public function cancelRectificada($expedient){

            $db = new DbHandler;

            $maxNumHiring = $this->getActiveHiring($expedient);

            // Obtenemos la informacion del actual Expedients Hirings
            $result = $db->query("  SELECT  eh.*
                                    FROM    Expedients_Hirings eh
                                    WHERE   eh.expedient = $expedient AND
                                            eh.num_hiring = $maxNumHiring 
            ");

            if(mysqli_num_rows($result) > 0){
                $hirings = $db->resultToArray($result);

                foreach($hirings as $it){

                    $db->query("DELETE FROM Expedients_Texts WHERE hiring = " . $it['ID'] . "");

                    $db->query("DELETE FROM Pre_Orders WHERE hiring = " . $it['ID'] . "");

                    $db->query("DELETE FROM Expedients_Work_Orders_Communication WHERE hiring = " . $it['ID'] . "");
                    
                    $db->query("DELETE FROM Expedients_Work_Orders_Flowers WHERE hiring = " . $it['ID'] . "");

                    $db->query("DELETE FROM Expedients_Hirings WHERE ID = " . $it['ID'] . "");

                    $db->query("DELETE FROM Services_Auto WHERE hiring = " . $it['ID'] . "");
                }
            }
    
            return true;
        }

        /**
         * Duplica toda la información de un expediente
         * 
         * 
         *   Tabla	                                Asociación	                                    Notas       COMPLETADO
         *   --------------------------------------------------------------------------------------------------------------
         *   Assistances	                            Vinculado a Expedients	                                    SI
         *   Condolences	                            Vinculado a Expedients	                                    SI
         *   Events	                                Vinculado a Expedients	                                    SI
         *   Expedients		                                                                                    SI
         *   Expedients_Closed_Death	                Vinculado a Expedients	                        FILES       SI
         *   Expedients_Documents	                Vinculado a Expedients	                        FILES       SI
         *   Expedients_Documents_Editor	            Vinculado a Expedients	                        FILES       SI
         *   Expedients_Duel_Received                Vinculado a Expedients	                        FILES       SI
         *   Expedients_Hirings	                    Vinculado a Expedients	                                    SI
         *   Expedients_History_Docs_Sent	        Vinculado a Expedients	                                    SI
         *   Expedients_History_Docs_Sent_Emails	    Vinculado a Expedients_History_Docs_Sent	                SI
         *   Expedients_Notes	                    Vinculado a Expedients	                                    SI
         *   Expedients_Notes_Users	                Vinculado a Expedients_Notes	                            SI
         *   Expedients_Obituaries	                Vinculado a Expedients	                        FILES       SI
         *   Expedients_Obituaries_Images	        Vinculado a Expedients	                        FILES       SI
         *   Expedients_Polls	                    Vinculado a Expedients	                                    SI
         *   Expedients_Polls_Results	            Vinculado a Expedients_Polls	                            SI
         *   Expedients_Press	                    Vinculado a Expedients	                        FILES       SI
         *   Expedients_Reminder	                    Vinculado a Expedients	                        FILES       SI
         *   Expedients_Reminder_Packet	            Vinculado a Expedients	                        FILES       SI
         *   Expedients_Reminder_Packet_Cross	    Vinculado a Expedients	                        FILES       SI
         *   Expedients_Services	                    Vinculado a Expedients	                                    SI
         *   Expedients_Texts	                    Vinculado a Expedients_Hirings	                            SI
         *   Expedients_Tombstones	                Vinculado a Expedients	                        FILES       SI
         *   Flowers_Letters	                        Vinculado a Expedients	                                    SI
         *   Incidents	                            Vinculado a Visits_Descriptions	                            SI
         *   Pre_Orders	                            Vinculado a Expedients_Hirings	                            SI
         *   Satisfaction_Survey		                                                                            SI
         *   Services_Auto	                        Vinculado a Expedients_Services	                            SI
         *   Services_Bellringers	                Vinculado a Expedients_Services	                            SI
         *   Services_Carriers	                    Vinculado a Expedients_Services	                            SI
         *   Services_Cars	                        Vinculado a Expedients_Services	                            SI
         *   Services_Choirs	                        Vinculado a Expedients_Services	                            SI
         *   Services_Control	                    Vinculado a Expedients_Services	                            SI
         *   Services_Control_Emails	                Vinculado a Expedients_Services	                            SI
         *   Services_Gravediggers	                Vinculado a Expedients_Services	                            SI
         *   Services_Hirings	                    Vinculado a Expedients_Services	                            NO SE USA
         *   Services_Priests	                    Vinculado a Expedients_Services	                            SI
         *   Survey_Assistance	                    Vinculado a Assistances	                                    SI
         *   Survey_Clients_Info	                    Vinculado a Expedients_Services	                            SI
         *   Visits	                                Vinculado a VisitsControl	                                SI
         *   VisitsControl	                        Vinculado a Expedients	                                    SI
         *   Visits_Descriptions	                    Vinculado a Visits	                                        SI
         *   Visits_Descriptions_Cafe	            Vinculado a Visits_Descriptions                             SI
         *
         * @param string $expedientID Expediente ID
         * @param string $clientType Client type 
         * @param string $clientId Client ID
         * 
         * @return array
         */
        function duplicateExpedient($expedientId, $clientType, $clientId){
           $db = new DbHandler;
    
            $expedientBaseDir = "{$_SESSION['basePath']}resources/files/{$_SESSION['company']}/expedients/$expedientId";
    
            $db->query("START TRANSACTION");
    
            try{
                $time = time();
    
                // Start table: Expedients
                // Current data
                $query = "  SELECT  associate, type, status, user, clientType, applicantLocation, familyContactLocation, client, deceasedBirthdayLocation,
                                    deceasedLocation, otherDeceasedLocation, deceasedMortuary, deceasedDoctor, church, cemetery, niche, crematorium, crematoriumEvent,
                                    crematoriumClient, funeralHome, moveFuneralHome, moveClient, moveCollection, moveDestination, number, entryDate, leavingDate, requestTime,
                                    requestDate, policy, lossNumber, capital, move, room, literal, cremation, applicantName, applicantSurname, applicantNIF, applicantNifType,
                                    applicantAddress, applicantMail, applicantPhone, applicantMobilePhone, familyContactName, familyContactSurname, familyContactNIF,
                                    familyContactNifType, familyContactAddress, familyContactRelationship, familyContactMail, familyContactPhone, familyContactMobilePhone,
                                    familyContactNationality, familyContactOtherCountry, familyContactOtherProvince, familyContactOtherLocation, otherContactName, otherContactPhone,
                                    otherContactRelationship, deceasedName, deceasedSurname, deceasedNIF, deceasedNifType, deceasedGender, deceasedMaritalStatus, deceasedMaritalStatusDescription,
                                    deceasedChildOfFather, deceasedChildOfMother, deceasedFirstNuptials, deceasedSecondNuptials, deceasedNationality, deceasedNationalityName,
                                    deceasedNationalityProvince, deceasedNationalityLocation, deceasedBirthday, deceasedUsualAddress, deceasedDate, deceasedTime, deceasedRoom,
                                    deceasedPanel, deceasedMortuaryAddress, deceasedDoctorCertificate, deceasedCause, deceasedTribunal, deceasedTribunalNumber, churchLabel,
                                    cemeteryLabel, funeralDate, funeralTime, ceremonyDate, ceremonyTime, regime, propertyName, funeralNicheNumber, funeralBusyNiche, deceasedNiche,
                                    funeralDateNiche, exhumation, nicheHeight, cremationServiceLocation, ecologicCoffin, crematoriumContactPerson, crematoriumContactPersonPhone,
                                    crematoriumArriveTime, crematoriumIntroduction, crematoriumWaitOnRoom, crematoriumVaseBio, crematoriumPacemaker, crematoriumTechnical,
                                    crematoriumContactPhonePerson, authContactPhone, authName, authDni, authDate, authTime, authPlace, funeralHomeEntryDate, funeralHomeEntryTime,
                                    coffin, otherCoffin, crematoriumReg, funeralReg, personalReg, mortuaryReg, tanatologicalPractice, responsibleUser, responsibleName, responsibleNIF,
                                    moveLeavingDate, moveLeavingTime, moveVia, moveJudicial, moveNotes, moveContactPhone, moveContactPerson, moveDestinationAddress, moveCollectionAddress,
                                    moveFinalDestination, notesHiring, flightNumber, airportOrigin, departureTime, arrivalAirport, arrivalTime, otherCeremony, otherInhumation, expNumLetter,
                                    expNumSecuence, expNumYear, expNumType, changeStatusAuto, priceExp, extraID, covid, deceasedLocality, deceasedProvince, moveTraslado, moveDevolucion,
                                    trazabilityId, funeralDateNew, funeralTimeNew, funeralDateBurial, funeralTimeBurial, tpv, authDniType, velatorioEntryDate, velatorioEntryTime,
                                    startVelacionDate, startVelacionTime, hearse, placeDestinationMiddle, placeDestinationFinal, placeDestinationFinalCemetery, hiring_rectified,
                                    smokeOpacityDateStart, smokeOpacityTimeStart, smokeOpacityDateEnd, smokeOpacityTimeEnd, smokeOpacityLoadWeight, smokeOpacityBacharachScale,
                                    smokeOpacityDateReading, smokeOpacityTimeReading, smokeOpacityIncidents, smokeOpacityIncidentsNotes, notesExpedient, tellmebyeRoom, tellmebyeRoomName,
                                    entryDateBarrow, entryTimeBarrow, refrigeratedChamberName, refrigeratedChamberDateStart, refrigeratedChamberTimeStart, refrigeratedChamberDateEnd, refrigeratedChamberTimeEnd,
                                    internalRef, endVelacionDate, endVelacionTime, startVelacionDate2, startVelacionTime2, endVelacionDate2, endVelacionTime2,
                                    deceasedNiche2, funeralDateNiche2, deceasedNiche3, funeralDateNiche3, agency, agencyContact, agencyContactPhone, departureDate, arrivalDate,
                                    carCollection1LicensePlate, carCollection1Brand, carCollection1Model, hearseLicensePlate, hearseBrand, hearseModel, mortuaryRegNotes, next_invoice_status,
                                    duplicate_origin, duplicate_user, duplicate_date
                            FROM    Expedients
                            WHERE   expedientID = $expedientId
                ";
                $result = $db->query($query);
    
                $currentExpedientData = mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
    
                if($currentExpedientData == null){
                    throw new Exception('Get current expedient data');
                }
    
                // Create year
                $createYear = explode('-', $currentExpedientData['requestDate'])[0];
    
                // Calculate extraID
                $result = $db->query("  SELECT  MAX(expedientID) as id
                                        FROM    Expedients
                ");
                $maxID = mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0]['id'] : '1';
                $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);
                $extraID .= ($maxID+1);
    
                // Get client price
                if($currentExpedientData['client'] != null && $currentExpedientData['client'] != ''){
                    $result = $db->query("  SELECT   p.name
                                            FROM     Clients c, Prices p
                                            WHERE    c.clientID = {$currentExpedientData['client']} 
                                                AND  p.leavingDate IS NULL
                                                AND  p.priceID = c.price");
                                            
                    if(mysqli_num_rows($result) > 0){
                        $priceName = $db->resultToArray($result)[0]['name'];
    
                        $result = $db->query("  SELECT   p.priceID
                                                FROM     Prices p
                                                WHERE    p.name = '$priceName'
                                                    AND  p.leavingDate IS NULL
                                                    AND  p.year = $createYear");
    
                        if(mysqli_num_rows($result) > 0){
                            $priceClient = $db->resultToArray($result)[0]['priceID'];
                        }else{
                            $result = $db->query("  SELECT   c.price
                                                    FROM     Clients c
                                                    WHERE    c.clientID = {$currentExpedientData['client']}");
                                                
                            if(mysqli_num_rows($result) > 0){
                                $priceClient = $db->resultToArray($result)[0]['price'];
                            }else{
                                $priceClient = 'null';
                            }
                        }
                    }else{
                        $priceClient = 'null';
                    }
                }else{
                    $priceClient = 'null'; 
                }
    
                // Cálculo del número de secuencia expediente
                $result = $db->query("  SELECT  COUNT(expedientID) as total 
                                        FROM    Expedients 
                                        WHERE   leavingDate IS NULL AND
                                                expNumYear = '" . $createYear . "'
                ");
                if(mysqli_num_rows($result) > 0){
                    $numExp = $db->resultToArray($result)[0]['total'] + 1;
                }else{
                    $numExp = 1;
                }
    
                //Tipo de expediente
                switch($currentExpedientData['type']){
                    case '1': //DEFUNCION
                        switch($currentExpedientData['clientType']){
                            case '1': //PARTICULARES
    
                                $expNumLetter = 'P';
    
                                $expNumYear = $createYear;
                                //Calcular el numero de secuencia del expediente par tipo DEFUNCION
                                $result = $db->query("  SELECT  COALESCE(MAX(expNumSecuence), 0) as total 
                                                        FROM    Expedients 
                                                        WHERE   leavingDate IS NULL AND type = 1 AND                                                           
                                                                expNumYear = '" . $expNumYear . "'"
                                );
    
                                if(mysqli_num_rows($result) > 0){
                                    $expNumSec = $db->resultToArray($result)[0]['total'] + 1;
                                }else{
                                    $expNumSec = 1;
                                }
    
                                //Calcular el numero de secuencia del expediente para Particulares
                                $result = $db->query("  SELECT  COALESCE(MAX(expNumType), 0) as total 
                                                        FROM    Expedients 
                                                        WHERE   leavingDate IS NULL AND
                                                                clientType = 1 AND type = 1 AND
                                                                expNumYear = '" . $expNumYear . "'"
                                );
                                
                                if(mysqli_num_rows($result) > 0){
                                    $expNumType = $db->resultToArray($result)[0]['total'] + 1;
                                }else{
                                    $expNumType = 1;
                                }
    
                                $expNumYear = substr($expNumYear, -2);
                                $numberExp = $expNumSec . ' ' . $expNumLetter . $expNumType . '/' . $expNumYear;
    
                            break;
    
                            case '2': //SEGUROS
                                $expNumLetter = 'S';
    
                                $expNumYear = $createYear;
    
                                //Calcular el numero de secuencia del expediente para tipo DEFUNCION
                                $result = $db->query("  SELECT  COALESCE(MAX(expNumSecuence), 0) as total 
                                                        FROM    Expedients 
                                                        WHERE   leavingDate IS NULL AND type = 1 AND                                                           
                                                                expNumYear = '" . $expNumYear . "'"
                                );
                                
                                if(mysqli_num_rows($result) > 0){
                                    $expNumSec = $db->resultToArray($result)[0]['total'] + 1;
                                }else{
                                    $expNumSec = 1;
                                }
    
    
                                //Calcular el numero de secuencia del expediente para seguros
                                $result = $db->query("  SELECT  COALESCE(MAX(expNumType), 0) as total 
                                                        FROM    Expedients 
                                                        WHERE   leavingDate IS NULL AND
                                                                clientType = 2 AND type = 1 AND
                                                                expNumYear = '" . $expNumYear . "'"
                                );
                                
                                if(mysqli_num_rows($result) > 0){
                                    $expNumType = $db->resultToArray($result)[0]['total'] + 1;
                                }else{
                                    $expNumType = 1;
                                }
                                $expNumYear = substr($expNumYear, -2);
    
                                //  $numberExp = $expNumLetter . '-' . $expNumSec . '/' . $expNumYear . ' ' . $expNumType;
                                $numberExp = $expNumSec . ' ' . $expNumLetter . $expNumType . '/' . $expNumYear;
                                break;
    
                            case '3': //EMPRESAS
                                $expNumLetter = 'E';
    
                                $expNumYear = $createYear;
                                //Calcular el numero de secuencia del expediente par tipo DEFUNCION
                                $result = $db->query("  SELECT  COALESCE(MAX(expNumSecuence), 0) as total 
                                                        FROM    Expedients 
                                                        WHERE   leavingDate IS NULL AND type = 1 AND                                                           
                                                                expNumYear = '" . $expNumYear . "'"
                                );
    
                                if(mysqli_num_rows($result) > 0){
                                    $expNumSec = $db->resultToArray($result)[0]['total'] + 1;
                                }else{
                                    $expNumSec = 1;
                                }
    
                                //Calcular el numero de secuencia del expediente para empresas
                                $result = $db->query("  SELECT  COALESCE(MAX(expNumType), 0) as total 
                                                        FROM    Expedients 
                                                        WHERE   leavingDate IS NULL AND
                                                                clientType = 3 AND type = 1 AND
                                                                expNumYear = '" . $expNumYear . "'"
                                );
                                
                                if(mysqli_num_rows($result) > 0){
                                    $expNumType = $db->resultToArray($result)[0]['total'] + 1;
                                }else{
                                    $expNumType = 1;
                                }
    
                                $expNumYear = substr($expNumYear, -2);
                                // $numberExp = $expNumLetter . '-' . $expNumSec . '/' . $expNumYear . ' ' . $expNumType;
                                $numberExp = $expNumSec . ' ' . $expNumLetter . $expNumType . '/' . $expNumYear;
                                break;
                        }
                    break;
    
                    case '2': //PRESUPUESTO
    
                        $expNumYear = $createYear;
    
                        $expNumLetter = 'PR';
                        //Calcular el numero de secuencia del expediente par tipo PRESUPUESTO
                        $result = $db->query("  SELECT  COALESCE(MAX(expNumSecuence), 0) as total 
                                                FROM    Expedients 
                                                WHERE   leavingDate IS NULL AND type = 2 AND                                                           
                                                        expNumYear = '" . $expNumYear . "'"
                        );
    
                        if(mysqli_num_rows($result) > 0){
                            $expNumSec = $db->resultToArray($result)[0]['total'] + 1;
                        }else{
                            $expNumSec = 1;
                        }
                        $expNumYear = $createYear;
                        $expNumYear = substr($expNumYear, -2);
                        //$expNumYear = 2012;
                        $expNumType = 0;
                        $numberExp = $expNumLetter . '-' . $expNumSec . '/' . $expNumYear;
                    break;
    
                    case '3': //VARIOS
                        $expNumYear = $createYear;
                        
                        $expNumLetter = 'V';
                        //Calcular el numero de secuencia del expediente par tipo VARIOS
                        $result = $db->query("  SELECT  COALESCE(MAX(expNumSecuence), 0) as total 
                                                FROM    Expedients 
                                                WHERE   leavingDate IS NULL AND type = 3 AND                                                           
                                                        expNumYear = '" . $expNumYear . "'"
                        );
                        
                        if(mysqli_num_rows($result) > 0){
                            $expNumSec = $db->resultToArray($result)[0]['total'] + 1;
                        }else{
                            $expNumSec = 1;
                        }
                        $expNumYear = $createYear;
                        //$expNumYear = 2012;
                        $expNumYear = substr($expNumYear, -2);
                        $expNumType = 0;
                        $numberExp = $expNumLetter . '-' . $expNumSec . '/' . $expNumYear;
                    break;
                }
                
                // Get next trazability ID
                if($currentExpedientData['cremation'] === 'true'){
                    $result = $db->query("  SELECT  COALESCE(MAX(e.trazabilityId), 0) as max_id_trazability 
                                            FROM    Expedients e
                                            WHERE   e.leavingDate IS NULL AND
                                                    e.cremation = 1  AND 
                                                    e.trazabilityId != 'false' AND e.trazabilityId != ''
                    ");
                    if(mysqli_num_rows($result) > 0){
                        $currentExpedientData['trazabilityId'] = intval($db->resultToArray($result)[0]['max_id_trazability']) + 1;
                    }else{
                        $currentExpedientData['trazabilityId'] = 1;
                    }
                }
    
                $expNumYear = $createYear;
    
                $associate = $currentExpedientData['associate'] == null ? 'null' : $currentExpedientData['associate'];
                $type = $currentExpedientData['type'] == null ? 'null' : $currentExpedientData['type'];
                $status = 2;
                $user = $currentExpedientData['user'] == null ? 'null' : $currentExpedientData['user'];
                $applicantLocation = $currentExpedientData['applicantLocation'] == null ? 'null' : $currentExpedientData['applicantLocation'];
                $familyContactLocation = $currentExpedientData['familyContactLocation'] == null ? 'null' : $currentExpedientData['familyContactLocation'];
                $client = $clientId;
                $deceasedBirthdayLocation = $currentExpedientData['deceasedBirthdayLocation'] == null ? 'null' : $currentExpedientData['deceasedBirthdayLocation'];
                $deceasedLocation = $currentExpedientData['deceasedLocation'] == null ? 'null' : $currentExpedientData['deceasedLocation'];
                $otherDeceasedLocation = $currentExpedientData['otherDeceasedLocation'];
                $deceasedMortuary = $currentExpedientData['deceasedMortuary'] == null ? 'null' : $currentExpedientData['deceasedMortuary'];
                $deceasedDoctor = $currentExpedientData['deceasedDoctor'] == null ? 'null' : $currentExpedientData['deceasedDoctor'];
                $church = $currentExpedientData['church'] == null ? 'null' : $currentExpedientData['church'];
                $cemetery = $currentExpedientData['cemetery'] == null ? 'null' : $currentExpedientData['cemetery'];
                $niche = $currentExpedientData['niche'] == null ? 'null' : $currentExpedientData['niche'];
                $crematorium = $currentExpedientData['crematorium'] == null ? 'null' : $currentExpedientData['crematorium'];
                $crematoriumEvent = $currentExpedientData['crematoriumEvent'] == null ? 'null' : $currentExpedientData['crematoriumEvent'];
                $crematoriumClient = $currentExpedientData['crematoriumClient'] == null ? 'null' : $currentExpedientData['crematoriumClient'];
                $funeralHome = $currentExpedientData['funeralHome'] == null ? 'null' : $currentExpedientData['funeralHome'];
                $moveFuneralHome = $currentExpedientData['moveFuneralHome'] == null ? 'null' : $currentExpedientData['moveFuneralHome'];
                $moveClient = $currentExpedientData['moveClient'] == null ? 'null' : $currentExpedientData['moveClient'];
                $moveCollection = $currentExpedientData['moveCollection'] == null ? 'null' : $currentExpedientData['moveCollection'];
                $moveDestination = $currentExpedientData['moveDestination'] == null ? 'null' : $currentExpedientData['moveDestination'];
                $number = $numberExp;
                $entryDate = $currentExpedientData['entryDate'] == null ? 'null' : "'" . $currentExpedientData['entryDate'] . "'";
                $leavingDate = $currentExpedientData['leavingDate'] == null ? 'null' : "'" . $currentExpedientData['leavingDate'] . "'";
                $requestTime = $currentExpedientData['requestTime'] == null ? 'null' : "'" . $currentExpedientData['requestTime'] . "'";
                $requestDate = $currentExpedientData['requestDate'] == null ? 'null' : "'" . $currentExpedientData['requestDate'] . "'";
                $policy = $currentExpedientData['policy'];
                $lossNumber = $currentExpedientData['lossNumber'];
                $capital = $currentExpedientData['capital'];
                $move = $currentExpedientData['move'] == null ? 0 : $currentExpedientData['move'];
                $room = $currentExpedientData['room'] == null ? 0 : $currentExpedientData['room'];
                $literal = $currentExpedientData['literal'] == null ? 0 : $currentExpedientData['literal'];
                $cremation = $currentExpedientData['cremation'] == null ? 0 : $currentExpedientData['cremation'];
                $applicantName = $currentExpedientData['applicantName'];
                $applicantSurname = $currentExpedientData['applicantSurname'];
                $applicantNIF = $currentExpedientData['applicantNIF'];
                $applicantNifType = $currentExpedientData['applicantNifType'] == null ? 1 : $currentExpedientData['applicantNifType'];
                $applicantAddress = $currentExpedientData['applicantAddress'];
                $applicantMail = $currentExpedientData['applicantMail'];
                $applicantPhone = $currentExpedientData['applicantPhone'];
                $applicantMobilePhone = $currentExpedientData['applicantMobilePhone'];
                $familyContactName = $currentExpedientData['familyContactName'];
                $familyContactSurname = $currentExpedientData['familyContactSurname'];
                $familyContactNIF = $currentExpedientData['familyContactNIF'];
                $familyContactNifType = $currentExpedientData['familyContactNifType'] == null ? 1 : $currentExpedientData['familyContactNifType'];
                $familyContactAddress = $currentExpedientData['familyContactAddress'];
                $familyContactRelationship = $currentExpedientData['familyContactRelationship'];
                $familyContactMail = $currentExpedientData['familyContactMail'];
                $familyContactPhone = $currentExpedientData['familyContactPhone'];
                $familyContactMobilePhone = $currentExpedientData['familyContactMobilePhone'];
                $familyContactNationality = $currentExpedientData['familyContactNationality'] == null ? 1 : $currentExpedientData['familyContactNationality'];
                $familyContactOtherCountry = $currentExpedientData['familyContactOtherCountry'];
                $familyContactOtherProvince = $currentExpedientData['familyContactOtherProvince'];
                $familyContactOtherLocation = $currentExpedientData['familyContactOtherLocation'];
                $otherContactName = $currentExpedientData['otherContactName'];
                $otherContactPhone = $currentExpedientData['otherContactPhone'];
                $otherContactRelationship = $currentExpedientData['otherContactRelationship'];
                $deceasedName = $currentExpedientData['deceasedName'];
                $deceasedSurname = $currentExpedientData['deceasedSurname'];
                $deceasedNIF = $currentExpedientData['deceasedNIF'];
                $deceasedNifType = $currentExpedientData['deceasedNifType'] == null ? 1 : $currentExpedientData['deceasedNifType'];
                $deceasedGender = $currentExpedientData['deceasedGender'];
                $deceasedMaritalStatus = $currentExpedientData['deceasedMaritalStatus'];
                $deceasedMaritalStatusDescription = $currentExpedientData['deceasedMaritalStatusDescription'];
                $deceasedChildOfFather = $currentExpedientData['deceasedChildOfFather'];
                $deceasedChildOfMother = $currentExpedientData['deceasedChildOfMother'];
                $deceasedFirstNuptials = $currentExpedientData['deceasedFirstNuptials'];
                $deceasedSecondNuptials = $currentExpedientData['deceasedSecondNuptials'];
                $deceasedNationality = $currentExpedientData['deceasedNationality'];
                $deceasedNationalityName = $currentExpedientData['deceasedNationalityName'];
                $deceasedNationalityProvince = $currentExpedientData['deceasedNationalityProvince'];
                $deceasedNationalityLocation = $currentExpedientData['deceasedNationalityLocation'];
                $deceasedBirthday = $currentExpedientData['deceasedBirthday'] == null ? 'null' : "'" . $currentExpedientData['deceasedBirthday'] . "'";
                $deceasedUsualAddress = $currentExpedientData['deceasedUsualAddress'];
                $deceasedDate = $currentExpedientData['deceasedDate'] == null ? 'null' : "'" . $currentExpedientData['deceasedDate'] . "'";
                $deceasedTime = $currentExpedientData['deceasedTime'] == null ? 'null' : "'" . $currentExpedientData['deceasedTime'] . "'";
                $deceasedRoom = $currentExpedientData['deceasedRoom'];
                $deceasedPanel = $currentExpedientData['deceasedPanel'] == null ? 0 : $currentExpedientData['deceasedPanel'];
                $deceasedMortuaryAddress = $currentExpedientData['deceasedMortuaryAddress'];
                $deceasedDoctorCertificate = $currentExpedientData['deceasedDoctorCertificate'];
                $deceasedCause = $currentExpedientData['deceasedCause'];
                $deceasedTribunal = $currentExpedientData['deceasedTribunal'];
                $deceasedTribunalNumber = $currentExpedientData['deceasedTribunalNumber'];
                $churchLabel = $currentExpedientData['churchLabel'];
                $cemeteryLabel = $currentExpedientData['cemeteryLabel'];
                $funeralDate = $currentExpedientData['funeralDate'] == null ? 'null' : "'" . $currentExpedientData['funeralDate'] . "'";
                $funeralTime = $currentExpedientData['funeralTime'] == null ? 'null' : "'" . $currentExpedientData['funeralTime'] . "'";
                $ceremonyDate = $currentExpedientData['ceremonyDate'] == null ? 'null' : "'" . $currentExpedientData['ceremonyDate'] . "'";
                $ceremonyTime = $currentExpedientData['ceremonyTime'] == null ? 'null' : "'" . $currentExpedientData['ceremonyTime'] . "'";
                $regime = $currentExpedientData['regime'] == null ? 'null' : $currentExpedientData['regime'];
                $propertyName = $currentExpedientData['propertyName'];
                $funeralNicheNumber = $currentExpedientData['funeralNicheNumber'];
                $funeralBusyNiche = $currentExpedientData['funeralBusyNiche'] == null ? 'null' : $currentExpedientData['funeralBusyNiche'];
                $deceasedNiche = $currentExpedientData['deceasedNiche'];
                $funeralDateNiche = $currentExpedientData['funeralDateNiche'] == null ? 'null' : $currentExpedientData['funeralDateNiche'];
                $exhumation = $currentExpedientData['exhumation'];
                $nicheHeight = $currentExpedientData['nicheHeight'] == null ? 'null' : $currentExpedientData['nicheHeight'];
                $cremationServiceLocation = $currentExpedientData['cremationServiceLocation'] == null ? 'null' : $currentExpedientData['cremationServiceLocation'];
                $ecologicCoffin = $currentExpedientData['ecologicCoffin'] == null ? 'null' : $currentExpedientData['ecologicCoffin'];
                $crematoriumContactPerson = $currentExpedientData['crematoriumContactPerson'];
                $crematoriumContactPersonPhone = $currentExpedientData['crematoriumContactPersonPhone'];
                $crematoriumArriveTime = $currentExpedientData['crematoriumArriveTime'] == null ? 'null' : "'" . $currentExpedientData['crematoriumArriveTime'] . "'";
                $crematoriumIntroduction = $currentExpedientData['crematoriumIntroduction'];
                $crematoriumWaitOnRoom = $currentExpedientData['crematoriumWaitOnRoom'];
                $crematoriumVaseBio = $currentExpedientData['crematoriumVaseBio'] == null ? 'null' : $currentExpedientData['crematoriumVaseBio'];
                $crematoriumPacemaker = $currentExpedientData['crematoriumPacemaker'] == null ? 'null' : $currentExpedientData['crematoriumPacemaker'];
                $crematoriumTechnical = $currentExpedientData['crematoriumTechnical'];
                $crematoriumContactPhonePerson = $currentExpedientData['crematoriumContactPhonePerson'];
                $authContactPhone = $currentExpedientData['authContactPhone'];
                $authName = $currentExpedientData['authName'];
                $authDni = $currentExpedientData['authDni'];
                $authDate = $currentExpedientData['authDate'] == null ? 'null' : $currentExpedientData['authDate'];
                $authTime = $currentExpedientData['authTime'] == null ? 'null' : $currentExpedientData['authTime'];
                $authPlace = $currentExpedientData['authPlace'];
                $funeralHomeEntryDate = $currentExpedientData['funeralHomeEntryDate'] == null ? 'null' : "'" . $currentExpedientData['funeralHomeEntryDate'] . "'";
                $funeralHomeEntryTime = $currentExpedientData['funeralHomeEntryTime'] == null ? 'null' : "'" . $currentExpedientData['funeralHomeEntryTime'] . "'";
                $coffin = $currentExpedientData['coffin'] == null ? 0 : $currentExpedientData['coffin'];
                $otherCoffin = $currentExpedientData['otherCoffin'];
                $crematoriumReg = $currentExpedientData['crematoriumReg'] == null ? 'null' : $currentExpedientData['crematoriumReg'];
                $funeralReg = $currentExpedientData['funeralReg'] == null ? 'null' : $currentExpedientData['funeralReg'];
                $personalReg = $currentExpedientData['personalReg'] == null ? 'null' : $currentExpedientData['personalReg'];
                $mortuaryReg = $currentExpedientData['mortuaryReg'] == null ? 'null' : $currentExpedientData['mortuaryReg'];
                $tanatologicalPractice = $currentExpedientData['tanatologicalPractice'] == null ? 'null' : $currentExpedientData['tanatologicalPractice'];
                $responsibleUser = $currentExpedientData['responsibleUser'] == null ? 'null' : $currentExpedientData['responsibleUser'];
                $responsibleName = $currentExpedientData['responsibleName'];
                $responsibleNIF = $currentExpedientData['responsibleNIF'];
                $moveLeavingDate = $currentExpedientData['moveLeavingDate'] == null ? 'null' : "'" . $currentExpedientData['moveLeavingDate'] . "'";
                $moveLeavingTime = $currentExpedientData['moveLeavingTime'] == null ? 'null' : "'" . $currentExpedientData['moveLeavingTime'] . "'";
                $moveVia = $currentExpedientData['moveVia'] == null ? 0 : $currentExpedientData['moveVia'];
                $moveJudicial = $currentExpedientData['moveJudicial'] == null ? 0 : $currentExpedientData['moveJudicial'];
                $moveNotes = $currentExpedientData['moveNotes'];
                $moveContactPhone = $currentExpedientData['moveContactPhone'];
                $moveContactPerson = $currentExpedientData['moveContactPerson'];
                $moveDestinationAddress = $currentExpedientData['moveDestinationAddress'];
                $moveCollectionAddress = $currentExpedientData['moveCollectionAddress'];
                $moveFinalDestination = $currentExpedientData['moveFinalDestination'];
                $notesHiring = $currentExpedientData['notesHiring'];
                $flightNumber = $currentExpedientData['flightNumber'];
                $airportOrigin = $currentExpedientData['airportOrigin'];
                $departureTime = $currentExpedientData['departureTime'] == null ? 'null' : $currentExpedientData['departureTime'];
                $arrivalAirport = $currentExpedientData['arrivalAirport'];
                $arrivalTime = $currentExpedientData['arrivalTime'] == null ? 'null' : $currentExpedientData['arrivalTime'];
                $otherCeremony = $currentExpedientData['otherCeremony'];
                $otherInhumation = $currentExpedientData['otherInhumation'];
                $expNumLetter = $expNumLetter;
                $expNumSecuence = $expNumSec;
                $expNumYear = $expNumYear;
                $expNumType = $expNumType;
                $changeStatusAuto = $currentExpedientData['changeStatusAuto'] == null ? 1 : $currentExpedientData['changeStatusAuto'];
                $priceExp = $priceClient;
                $extraID = $extraID;
                $covid = $currentExpedientData['covid'] == null ? 'null' : $currentExpedientData['covid'];
                $deceasedLocality = $currentExpedientData['deceasedLocality'];
                $deceasedProvince = $currentExpedientData['deceasedProvince'];
                $moveTraslado = $currentExpedientData['moveTraslado'] == null ? 'null' : $currentExpedientData['moveTraslado'];
                $moveDevolucion = $currentExpedientData['moveDevolucion'] == null ? 'null' : $currentExpedientData['moveDevolucion'];
                $trazabilityId = $currentExpedientData['trazabilityId'];
                $funeralDateNew = $currentExpedientData['funeralDateNew'] == null ? 'null' : "'" . $currentExpedientData['funeralDateNew'] . "'";
                $funeralTimeNew = $currentExpedientData['funeralTimeNew'] == null ? 'null' : "'" . $currentExpedientData['funeralTimeNew'] . "'";
                $funeralDateBurial = $currentExpedientData['funeralDateBurial'] == null ? 'null' : "'" . $currentExpedientData['funeralDateBurial'] . "'";
                $funeralTimeBurial = $currentExpedientData['funeralTimeBurial'] == null ? 'null' : "'" . $currentExpedientData['funeralTimeBurial'] . "'";
                $tpv = $currentExpedientData['tpv'] == null ? 0 : $currentExpedientData['tpv'];
                $authDniType = $currentExpedientData['authDniType'] == null ? 1 : $currentExpedientData['authDniType'];
                $velatorioEntryDate = $currentExpedientData['velatorioEntryDate'] == null ? 'null' : "'" . $currentExpedientData['velatorioEntryDate'] . "'";
                $velatorioEntryTime = $currentExpedientData['velatorioEntryTime'] == null ? 'null' : "'" . $currentExpedientData['velatorioEntryTime'] . "'";
                $startVelacionDate = $currentExpedientData['startVelacionDate'] == null ? 'null' : "'" . $currentExpedientData['startVelacionDate'] . "'";
                $startVelacionTime = $currentExpedientData['startVelacionTime'] == null ? 'null' : "'" . $currentExpedientData['startVelacionTime'] . "'";
                $hearse = $currentExpedientData['hearse'] == null ? 'null' : $currentExpedientData['hearse'];
                $placeDestinationMiddle = $currentExpedientData['placeDestinationMiddle'] == null ? 'null' : $currentExpedientData['placeDestinationMiddle'];
                $placeDestinationFinal = $currentExpedientData['placeDestinationFinal'] == null ? 'null' : $currentExpedientData['placeDestinationFinal'];
                $placeDestinationFinalCemetery = $currentExpedientData['placeDestinationFinalCemetery'] == null ? 'null' : $currentExpedientData['placeDestinationFinalCemetery'];
                $hiring_rectified = 0;
                $smokeOpacityDateStart = $currentExpedientData['smokeOpacityDateStart'] == null ? 'null' : $currentExpedientData['smokeOpacityDateStart'];
                $smokeOpacityTimeStart = $currentExpedientData['smokeOpacityTimeStart'] == null ? 'null' : $currentExpedientData['smokeOpacityTimeStart'];
                $smokeOpacityDateEnd = $currentExpedientData['smokeOpacityDateEnd'] == null ? 'null' : $currentExpedientData['smokeOpacityDateEnd'];
                $smokeOpacityTimeEnd = $currentExpedientData['smokeOpacityTimeEnd'] == null ? 'null' : $currentExpedientData['smokeOpacityTimeEnd'];
                $smokeOpacityLoadWeight = $currentExpedientData['smokeOpacityLoadWeight'] == null ? 'null' : $currentExpedientData['smokeOpacityLoadWeight'];
                $smokeOpacityBacharachScale = $currentExpedientData['smokeOpacityBacharachScale'] == null ? 'null' : $currentExpedientData['smokeOpacityBacharachScale'];
                $smokeOpacityDateReading = $currentExpedientData['smokeOpacityDateReading'] == null ? 'null' : $currentExpedientData['smokeOpacityDateReading'];
                $smokeOpacityTimeReading = $currentExpedientData['smokeOpacityTimeReading'] == null ? 'null' : $currentExpedientData['smokeOpacityTimeReading'];
                $smokeOpacityIncidents = $currentExpedientData['smokeOpacityIncidents'] == null ? 0 : $currentExpedientData['smokeOpacityIncidents'];
                $smokeOpacityIncidentsNotes = $currentExpedientData['smokeOpacityIncidentsNotes'];
                $notesExpedient = $currentExpedientData['notesExpedient'];
                $tellmebyeRoom = $currentExpedientData['tellmebyeRoom'];
                $tellmebyeRoomName = $currentExpedientData['tellmebyeRoomName'];
                $entryDateBarrow = $currentExpedientData['entryDateBarrow'] == null ? 'null' : "'" . $currentExpedientData['entryDateBarrow'] . "'";
                $entryTimeBarrow = $currentExpedientData['entryTimeBarrow'] == null ? 'null' : "'" . $currentExpedientData['entryTimeBarrow'] . "'";

                $refrigeratedChamberName = $currentExpedientData['refrigeratedChamberName'] == null ? 'null' : "'" . $currentExpedientData['refrigeratedChamberName'] . "'";
                $refrigeratedChamberDateStart = $currentExpedientData['refrigeratedChamberDateStart'] == null ? 'null' : "'" . $currentExpedientData['refrigeratedChamberDateStart'] . "'";
                $refrigeratedChamberTimeStart = $currentExpedientData['refrigeratedChamberTimeStart'] == null ? 'null' : "'" . $currentExpedientData['refrigeratedChamberTimeStart'] . "'";
                $refrigeratedChamberDateEnd = $currentExpedientData['refrigeratedChamberDateEnd'] == null ? 'null' : "'" . $currentExpedientData['refrigeratedChamberDateEnd'] . "'";
                $refrigeratedChamberTimeEnd = $currentExpedientData['refrigeratedChamberTimeEnd'] == null ? 'null' : "'" . $currentExpedientData['refrigeratedChamberTimeEnd'] . "'";

                $internalRef = $currentExpedientData['internalRef'];
                $endVelacionDate = $currentExpedientData['endVelacionDate'] == null ? 'null' : "'" . $currentExpedientData['endVelacionDate'] . "'";
                $endVelacionTime = $currentExpedientData['endVelacionTime'] == null ? 'null' : "'" . $currentExpedientData['endVelacionTime'] . "'";
                $startVelacionDate2 = $currentExpedientData['startVelacionDate2'] == null ? 'null' : "'" . $currentExpedientData['startVelacionDate2'] . "'";
                $startVelacionTime2 = $currentExpedientData['startVelacionTime2'] == null ? 'null' : "'" . $currentExpedientData['startVelacionTime2'] . "'";
                $endVelacionDate2 = $currentExpedientData['endVelacionDate2'] == null ? 'null' : "'" . $currentExpedientData['endVelacionDate2'] . "'";
                $endVelacionTime2 = $currentExpedientData['endVelacionTime2'] == null ? 'null' : "'" . $currentExpedientData['endVelacionTime2'] . "'";
                $deceasedNiche2 = $currentExpedientData['deceasedNiche2'];
                $funeralDateNiche2 = $currentExpedientData['funeralDateNiche2'] == null ? 'null' : $currentExpedientData['funeralDateNiche2'];
                $deceasedNiche3 = $currentExpedientData['deceasedNiche3'];
                $funeralDateNiche3 = $currentExpedientData['funeralDateNiche3'] == null ? 'null' : $currentExpedientData['funeralDateNiche3'];
                $agency = $currentExpedientData['agency'];
                $agencyContact = $currentExpedientData['agencyContact'];
                $agencyContactPhone = $currentExpedientData['agencyContactPhone'];
                $departureDate = $currentExpedientData['departureDate'] == null ? 'null' : "'" . $currentExpedientData['departureDate'] . "'";
                $arrivalDate = $currentExpedientData['arrivalDate'] == null ? 'null' : "'" . $currentExpedientData['arrivalDate'] . "'";
                $carCollection1LicensePlate = $currentExpedientData['carCollection1LicensePlate'];
                $carCollection1Brand = $currentExpedientData['carCollection1Brand'];
                $carCollection1Model = $currentExpedientData['carCollection1Model'];
                $hearseLicensePlate = $currentExpedientData['hearseLicensePlate'];
                $hearseBrand = $currentExpedientData['hearseBrand'];
                $hearseModel = $currentExpedientData['hearseModel'];
                $mortuaryRegNotes = $currentExpedientData['mortuaryRegNotes'];
                $next_invoice_status = 0;
                $duplicate_origin = $expedientId;
                $duplicate_user = $_SESSION['user'];
                $duplicate_date = $time;
    
                $query = "  INSERT INTO Expedients(
                                associate, type, status, user, clientType, applicantLocation, familyContactLocation, client, deceasedBirthdayLocation,
                                deceasedLocation, otherDeceasedLocation, deceasedMortuary, deceasedDoctor, church, cemetery, niche, crematorium, crematoriumEvent,
                                crematoriumClient, funeralHome, moveFuneralHome, moveClient, moveCollection, moveDestination, number, entryDate, leavingDate, requestTime,
                                requestDate, policy, lossNumber, capital, move, room, literal, cremation, applicantName, applicantSurname, applicantNIF, applicantNifType,
                                applicantAddress, applicantMail, applicantPhone, applicantMobilePhone, familyContactName, familyContactSurname, familyContactNIF,
                                familyContactNifType, familyContactAddress, familyContactRelationship, familyContactMail, familyContactPhone, familyContactMobilePhone,
                                familyContactNationality, familyContactOtherCountry, familyContactOtherProvince, familyContactOtherLocation, otherContactName, otherContactPhone,
                                otherContactRelationship, deceasedName, deceasedSurname, deceasedNIF, deceasedNifType, deceasedGender, deceasedMaritalStatus, deceasedMaritalStatusDescription,
                                deceasedChildOfFather, deceasedChildOfMother, deceasedFirstNuptials, deceasedSecondNuptials, deceasedNationality, deceasedNationalityName,
                                deceasedNationalityProvince, deceasedNationalityLocation, deceasedBirthday, deceasedUsualAddress, deceasedDate, deceasedTime, deceasedRoom,
                                deceasedPanel, deceasedMortuaryAddress, deceasedDoctorCertificate, deceasedCause, deceasedTribunal, deceasedTribunalNumber, churchLabel,
                                cemeteryLabel, funeralDate, funeralTime, ceremonyDate, ceremonyTime, regime, propertyName, funeralNicheNumber, funeralBusyNiche, deceasedNiche,
                                funeralDateNiche, exhumation, nicheHeight, cremationServiceLocation, ecologicCoffin, crematoriumContactPerson, crematoriumContactPersonPhone,
                                crematoriumArriveTime, crematoriumIntroduction, crematoriumWaitOnRoom, crematoriumVaseBio, crematoriumPacemaker, crematoriumTechnical,
                                crematoriumContactPhonePerson, authContactPhone, authName, authDni, authDate, authTime, authPlace, funeralHomeEntryDate, funeralHomeEntryTime,
                                coffin, otherCoffin, crematoriumReg, funeralReg, personalReg, mortuaryReg, tanatologicalPractice, responsibleUser, responsibleName, responsibleNIF,
                                moveLeavingDate, moveLeavingTime, moveVia, moveJudicial, moveNotes, moveContactPhone, moveContactPerson, moveDestinationAddress, moveCollectionAddress,
                                moveFinalDestination, notesHiring, flightNumber, airportOrigin, departureTime, arrivalAirport, arrivalTime, otherCeremony, otherInhumation, expNumLetter,
                                expNumSecuence, expNumYear, expNumType, changeStatusAuto, priceExp, extraID, covid, deceasedLocality, deceasedProvince, moveTraslado, moveDevolucion,
                                trazabilityId, funeralDateNew, funeralTimeNew, funeralDateBurial, funeralTimeBurial, tpv, authDniType, velatorioEntryDate, velatorioEntryTime,
                                startVelacionDate, startVelacionTime, hearse, placeDestinationMiddle, placeDestinationFinal, placeDestinationFinalCemetery, hiring_rectified,
                                smokeOpacityDateStart, smokeOpacityTimeStart, smokeOpacityDateEnd, smokeOpacityTimeEnd, smokeOpacityLoadWeight, smokeOpacityBacharachScale,
                                smokeOpacityDateReading, smokeOpacityTimeReading, smokeOpacityIncidents, smokeOpacityIncidentsNotes, notesExpedient, tellmebyeRoom, tellmebyeRoomName,
                                entryDateBarrow, entryTimeBarrow, refrigeratedChamberName, refrigeratedChamberDateStart, refrigeratedChamberTimeStart, refrigeratedChamberDateEnd, refrigeratedChamberTimeEnd,
                                internalRef, endVelacionDate, endVelacionTime, startVelacionDate2, startVelacionTime2, endVelacionDate2, endVelacionTime2,
                                deceasedNiche2, funeralDateNiche2, deceasedNiche3, funeralDateNiche3, agency, agencyContact, agencyContactPhone, departureDate, arrivalDate,
                                carCollection1LicensePlate, carCollection1Brand, carCollection1Model, hearseLicensePlate, hearseBrand, hearseModel, mortuaryRegNotes, next_invoice_status,
                                duplicate_origin, duplicate_user, duplicate_date
                            )
                            VALUES (
                                $associate, $type, $status, $user, $clientType, $applicantLocation, $familyContactLocation, $client, $deceasedBirthdayLocation,
                                $deceasedLocation, '$otherDeceasedLocation', $deceasedMortuary, $deceasedDoctor, $church, $cemetery, $niche, $crematorium, $crematoriumEvent,
                                $crematoriumClient, $funeralHome, $moveFuneralHome, $moveClient, $moveCollection, $moveDestination, '$number', $entryDate, $leavingDate, $requestTime,
                                $requestDate, '$policy', '$lossNumber', '$capital', $move, $room, $literal, $cremation, '$applicantName', '$applicantSurname', '$applicantNIF', $applicantNifType,
                                '$applicantAddress', '$applicantMail', '$applicantPhone', '$applicantMobilePhone', '$familyContactName', '$familyContactSurname', '$familyContactNIF',
                                $familyContactNifType, '$familyContactAddress', '$familyContactRelationship', '$familyContactMail', '$familyContactPhone', '$familyContactMobilePhone',
                                $familyContactNationality, '$familyContactOtherCountry', '$familyContactOtherProvince', '$familyContactOtherLocation', '$otherContactName', '$otherContactPhone',
                                '$otherContactRelationship', '$deceasedName', '$deceasedSurname', '$deceasedNIF', $deceasedNifType, '$deceasedGender', '$deceasedMaritalStatus', '$deceasedMaritalStatusDescription',
                                '$deceasedChildOfFather', '$deceasedChildOfMother', '$deceasedFirstNuptials', '$deceasedSecondNuptials', '$deceasedNationality', '$deceasedNationalityName',
                                '$deceasedNationalityProvince', '$deceasedNationalityLocation', $deceasedBirthday, '$deceasedUsualAddress', $deceasedDate, $deceasedTime, '$deceasedRoom',
                                $deceasedPanel, '$deceasedMortuaryAddress', '$deceasedDoctorCertificate', '$deceasedCause', '$deceasedTribunal', '$deceasedTribunalNumber', '$churchLabel',
                                '$cemeteryLabel', $funeralDate, $funeralTime, $ceremonyDate, $ceremonyTime, $regime, '$propertyName', '$funeralNicheNumber', $funeralBusyNiche, '$deceasedNiche',
                                $funeralDateNiche, '$exhumation', $nicheHeight, $cremationServiceLocation, $ecologicCoffin, '$crematoriumContactPerson', '$crematoriumContactPersonPhone',
                                $crematoriumArriveTime, '$crematoriumIntroduction', '$crematoriumWaitOnRoom', $crematoriumVaseBio, $crematoriumPacemaker, '$crematoriumTechnical',
                                '$crematoriumContactPhonePerson', '$authContactPhone', '$authName', '$authDni', $authDate, $authTime, '$authPlace', $funeralHomeEntryDate, $funeralHomeEntryTime,
                                $coffin, '$otherCoffin', $crematoriumReg, $funeralReg, $personalReg, $mortuaryReg, $tanatologicalPractice, $responsibleUser, '$responsibleName', '$responsibleNIF',
                                $moveLeavingDate, $moveLeavingTime, $moveVia, $moveJudicial, '$moveNotes', '$moveContactPhone', '$moveContactPerson', '$moveDestinationAddress', '$moveCollectionAddress',
                                '$moveFinalDestination', '$notesHiring', '$flightNumber', '$airportOrigin', $departureTime, '$arrivalAirport', $arrivalTime, '$otherCeremony', '$otherInhumation', '$expNumLetter',
                                $expNumSecuence, $expNumYear, $expNumType, $changeStatusAuto, $priceExp, '$extraID', $covid, '$deceasedLocality', '$deceasedProvince', $moveTraslado, $moveDevolucion,
                                '$trazabilityId', $funeralDateNew, $funeralTimeNew, $funeralDateBurial, $funeralTimeBurial, $tpv, $authDniType, $velatorioEntryDate, $velatorioEntryTime,
                                $startVelacionDate, $startVelacionTime, $hearse, $placeDestinationMiddle, $placeDestinationFinal, $placeDestinationFinalCemetery, $hiring_rectified,
                                $smokeOpacityDateStart, $smokeOpacityTimeStart, $smokeOpacityDateEnd, $smokeOpacityTimeEnd, $smokeOpacityLoadWeight, $smokeOpacityBacharachScale,
                                $smokeOpacityDateReading, $smokeOpacityTimeReading, $smokeOpacityIncidents, '$smokeOpacityIncidentsNotes', '$notesExpedient', '$tellmebyeRoom', '$tellmebyeRoomName',
                                $entryDateBarrow, $entryTimeBarrow, $refrigeratedChamberName, $refrigeratedChamberDateStart, $refrigeratedChamberTimeStart, $refrigeratedChamberDateEnd, $refrigeratedChamberTimeEnd,
                                '$internalRef', $endVelacionDate, $endVelacionTime, $startVelacionDate2, $startVelacionTime2, $endVelacionDate2, $endVelacionTime2,
                                '$deceasedNiche2', $funeralDateNiche2, '$deceasedNiche3', $funeralDateNiche3, '$agency', '$agencyContact', '$agencyContactPhone', $departureDate, $arrivalDate,
                                '$carCollection1LicensePlate', '$carCollection1Brand', '$carCollection1Model', '$hearseLicensePlate', '$hearseBrand', '$hearseModel', '$mortuaryRegNotes', $next_invoice_status,
                                $duplicate_origin, $duplicate_user, $duplicate_date
                            )
                ";
    
                $result = $db->query($query);
                if(!$result){
                    throw new Exception($query);
                }
    
                $newExpedientId = $db->getLastInsertId();
    
                $newExpedientBaseDir = "{$_SESSION['basePath']}resources/files/{$_SESSION['company']}/expedients/$newExpedientId";
                $created = mkdir($newExpedientBaseDir, 0777, true);
                if(!$created){
                    throw new Exception("Create folder: $newExpedientBaseDir");
                }
                // End table: Expedients
    
                // Start table: Expedients_Services
                $query = "  SELECT  choir, bellringer, funeralHomeService, corpseCollection1, corpseCollection2, familyAssistance,
                                    carCollection, arriveTime, arriveDate, revReqCheck, control, dni, priestTime, priestTimeCheck, gravediggersCheck,
                                    gravediggersCheckPrinted, gravediggersCheckSigned, gravediggersNotApply, notifiedChoir, notifiedBellringer,
                                    carriersTime, carriersTimeCheck, notes, routeSummary, notesSummary, churchSummary, licenseSummary, reminderSummary,
                                    deliveryReceiptSummary, priestsNotification, gravediggersNotification, carriersNotification, choirsNotification,
                                    bellringersNotification, carsNotification, policeNotified, policeNotApply, policeLocation, webNotApply, webConfirm,
                                    webLink, doctorDone, doctorDeliver, doctorNotApply, doctorInProgress, tribunalDeliver, tribunalNotApply, tribunalInProgress,
                                    tribunalLocation, tribunalUser, literalReceived, literalNoFinished, literalRequest, literalVolumePage, literalWhoTakes,
                                    literalCivilRegister, literalDateExit, literalTimeExit, literalNotApply, tombstone, preparationNotApply, preparationConfirm,
                                    policeNotification, webNotification, preparationNotification, doctorNotification, tribunalNotification, controlNotification,
                                    reminderNotifications, flowerNotification, busNotification, taxiNotification, notApplyAll, tombstoneNotApply, tombstonePrint,
                                    vivoSent, vivoNotApply, crematoriumWhoDelivered, crematoriumNotes, crematoriumProgramOven, crematoriumControlDeliversAshes,
                                    crematoriumWhoProgramOven, crematoriumFirstGenerateDocDate, crematoriumFirstGenerateDocUser, priestInspected, priestPayed,
                                    priestNotes, sinceAniversaryWeb, untilAniversaryWeb, showAgeObituaryWeb, churchAniversaryWeb, dateAniversaryWeb,
                                    timeAniversaryWeb, poll, carCollection2, staffTransfer1, staffTransfer2, surveyNotApply, surveySend,
                                    showFinalDestinationWeb, showVelationWeb, showCeremonyWeb
                            FROM    Expedients_Services
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception('Get current expedient service data');
                }
    
                $currentExpedientServiceData = mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
                if($currentExpedientServiceData == null){
                    throw new Exception('Get current expedient service data');
                }
    
                $choir = $currentExpedientServiceData['choir'] == null ? 'null' : $currentExpedientServiceData['choir'];
                $bellringer = $currentExpedientServiceData['bellringer'] == null ? 'null' : $currentExpedientServiceData['bellringer'];
                $funeralHomeService = $currentExpedientServiceData['funeralHomeService'] == null ? 'null' : $currentExpedientServiceData['funeralHomeService'];
                $corpseCollection1 = $currentExpedientServiceData['corpseCollection1'] == null ? 'null' : $currentExpedientServiceData['corpseCollection1'];
                $corpseCollection2 = $currentExpedientServiceData['corpseCollection2'] == null ? 'null' : $currentExpedientServiceData['corpseCollection2'];
                $familyAssistance = $currentExpedientServiceData['familyAssistance'] == null ? 'null' : $currentExpedientServiceData['familyAssistance'];
                $carCollection = $currentExpedientServiceData['carCollection'] == null ? 'null' : $currentExpedientServiceData['carCollection'];
                $arriveTime = $currentExpedientServiceData['arriveTime'] == null ? 'null' : "'" . $currentExpedientServiceData['arriveTime'] . "'";
                $arriveDate = $currentExpedientServiceData['arriveDate'] == null ? 'null' : "'" . $currentExpedientServiceData['arriveDate'] . "'";
                $revReqCheck = $currentExpedientServiceData['revReqCheck'] == null ? 0 : $currentExpedientServiceData['revReqCheck'];
                $control = $currentExpedientServiceData['control'] == null ? 0 : $currentExpedientServiceData['control'];
                $dni = $currentExpedientServiceData['dni'];
                $priestTime = $currentExpedientServiceData['priestTime'] == null ? 'null' : "'" . $currentExpedientServiceData['priestTime'] . "'";
                $priestTimeCheck = $currentExpedientServiceData['priestTimeCheck'] == null ? 0 : $currentExpedientServiceData['priestTimeCheck'];
                $gravediggersCheck = $currentExpedientServiceData['gravediggersCheck'] == null ? 0 : $currentExpedientServiceData['gravediggersCheck'];
                $gravediggersCheckPrinted = $currentExpedientServiceData['gravediggersCheckPrinted'] == null ? 0 : $currentExpedientServiceData['gravediggersCheckPrinted'];
                $gravediggersCheckSigned = $currentExpedientServiceData['gravediggersCheckSigned'] == null ? 0 : $currentExpedientServiceData['gravediggersCheckSigned'];
                $gravediggersNotApply = $currentExpedientServiceData['gravediggersNotApply'] == null ? 0 : $currentExpedientServiceData['gravediggersNotApply'];
                $notifiedChoir = $currentExpedientServiceData['notifiedChoir'] == null ? 0 : $currentExpedientServiceData['notifiedChoir'];
                $notifiedBellringer = $currentExpedientServiceData['notifiedBellringer'] == null ? 0 : $currentExpedientServiceData['notifiedBellringer'];
                $carriersTime = $currentExpedientServiceData['carriersTime'] == null ? 'null' : "'" . $currentExpedientServiceData['carriersTime'] . "'";
                $carriersTimeCheck = $currentExpedientServiceData['carriersTimeCheck'] == null ? 0 : $currentExpedientServiceData['carriersTimeCheck'];
                $notes = $currentExpedientServiceData['notes'];
                $routeSummary = $currentExpedientServiceData['routeSummary'];
                $notesSummary = $currentExpedientServiceData['notesSummary'];
                $churchSummary = $currentExpedientServiceData['churchSummary'] == null ? 0 : $currentExpedientServiceData['churchSummary'];
                $licenseSummary = $currentExpedientServiceData['licenseSummary'] == null ? 0 : $currentExpedientServiceData['licenseSummary'];
                $reminderSummary = $currentExpedientServiceData['reminderSummary'] == null ? 0 : $currentExpedientServiceData['reminderSummary'];
                $deliveryReceiptSummary = $currentExpedientServiceData['deliveryReceiptSummary'] == null ? 0 : $currentExpedientServiceData['deliveryReceiptSummary'];
                $priestsNotification = $currentExpedientServiceData['priestsNotification'] == null ? 0 : $currentExpedientServiceData['priestsNotification'];
                $gravediggersNotification = $currentExpedientServiceData['gravediggersNotification'] == null ? 0 : $currentExpedientServiceData['gravediggersNotification'];
                $carriersNotification = $currentExpedientServiceData['carriersNotification'] == null ? 0 : $currentExpedientServiceData['carriersNotification'];
                $choirsNotification = $currentExpedientServiceData['choirsNotification'] == null ? 0 : $currentExpedientServiceData['choirsNotification'];
                $bellringersNotification = $currentExpedientServiceData['bellringersNotification'] == null ? 0 : $currentExpedientServiceData['bellringersNotification'];
                $carsNotification = $currentExpedientServiceData['carsNotification'] == null ? 0 : $currentExpedientServiceData['carsNotification'];
                $policeNotified = $currentExpedientServiceData['policeNotified'] == null ? 0 : $currentExpedientServiceData['policeNotified'];
                $policeNotApply = $currentExpedientServiceData['policeNotApply'] == null ? 0 : $currentExpedientServiceData['policeNotApply'];
                $policeLocation = $currentExpedientServiceData['policeLocation'];
                $webNotApply = $currentExpedientServiceData['webNotApply'] == null ? 0 : $currentExpedientServiceData['webNotApply'];
                $webConfirm = $currentExpedientServiceData['webConfirm'] == null ? 0 : $currentExpedientServiceData['webConfirm'];
                $webLink = $currentExpedientServiceData['webLink'];
                $doctorDone = $currentExpedientServiceData['doctorDone'] == null ? 0 : $currentExpedientServiceData['doctorDone'];
                $doctorDeliver = $currentExpedientServiceData['doctorDeliver'] == null ? 'null' : $currentExpedientServiceData['doctorDeliver'];
                $doctorNotApply = $currentExpedientServiceData['doctorNotApply'] == null ? 0 : $currentExpedientServiceData['doctorNotApply'];
                $doctorInProgress = $currentExpedientServiceData['doctorInProgress'] == null ? 0 : $currentExpedientServiceData['doctorInProgress'];
                $tribunalDeliver = $currentExpedientServiceData['tribunalDeliver'] == null ? 0 : $currentExpedientServiceData['tribunalDeliver'];
                $tribunalNotApply = $currentExpedientServiceData['tribunalNotApply'] == null ? 0 : $currentExpedientServiceData['tribunalNotApply'];
                $tribunalInProgress = $currentExpedientServiceData['tribunalInProgress'] == null ? 0 : $currentExpedientServiceData['tribunalInProgress'];
                $tribunalLocation = $currentExpedientServiceData['tribunalLocation'];
                $tribunalUser = $currentExpedientServiceData['tribunalUser'] == null ? 'null' : $currentExpedientServiceData['tribunalUser'];
                $literalReceived = $currentExpedientServiceData['literalReceived'] == null ? 0 : $currentExpedientServiceData['literalReceived'];
                $literalNoFinished = $currentExpedientServiceData['literalNoFinished'] == null ? 0 : $currentExpedientServiceData['literalNoFinished'];
                $literalRequest = $currentExpedientServiceData['literalRequest'] == null ? 0 : $currentExpedientServiceData['literalRequest'];
                $literalVolumePage = $currentExpedientServiceData['literalVolumePage'];
                $literalWhoTakes = $currentExpedientServiceData['literalWhoTakes'];
                $literalCivilRegister = $currentExpedientServiceData['literalCivilRegister'];
                $literalDateExit = $currentExpedientServiceData['literalDateExit'] == null ? 'null' : "'" . $currentExpedientServiceData['literalDateExit'] . "'";
                $literalTimeExit = $currentExpedientServiceData['literalTimeExit'];
                $literalNotApply = $currentExpedientServiceData['literalNotApply'] == null ? 0 : $currentExpedientServiceData['literalNotApply'];
                $tombstone = $currentExpedientServiceData['tombstone'];
                $preparationNotApply = $currentExpedientServiceData['preparationNotApply'] == null ? 0 : $currentExpedientServiceData['preparationNotApply'];
                $preparationConfirm = $currentExpedientServiceData['preparationConfirm'] == null ? 0 : $currentExpedientServiceData['preparationConfirm'];
                $policeNotification = $currentExpedientServiceData['policeNotification'] == null ? 0 : $currentExpedientServiceData['policeNotification'];
                $webNotification = $currentExpedientServiceData['webNotification'] == null ? 0 : $currentExpedientServiceData['webNotification'];
                $preparationNotification = $currentExpedientServiceData['preparationNotification'] == null ? 0 : $currentExpedientServiceData['preparationNotification'];
                $doctorNotification = $currentExpedientServiceData['doctorNotification'] == null ? 0 : $currentExpedientServiceData['doctorNotification'];
                $tribunalNotification = $currentExpedientServiceData['tribunalNotification'] == null ? 0 : $currentExpedientServiceData['tribunalNotification'];
                $controlNotification = $currentExpedientServiceData['controlNotification'] == null ? 0 : $currentExpedientServiceData['controlNotification'];
                $reminderNotifications = $currentExpedientServiceData['reminderNotifications'] == null ? 0 : $currentExpedientServiceData['reminderNotifications'];
                $flowerNotification = $currentExpedientServiceData['flowerNotification'] == null ? 0 : $currentExpedientServiceData['flowerNotification'];
                $busNotification = $currentExpedientServiceData['busNotification'] == null ? 0 : $currentExpedientServiceData['busNotification'];
                $taxiNotification = $currentExpedientServiceData['taxiNotification'] == null ? 0 : $currentExpedientServiceData['taxiNotification'];
                $notApplyAll = $currentExpedientServiceData['notApplyAll'] == null ? 0 : $currentExpedientServiceData['notApplyAll'];
                $tombstoneNotApply = $currentExpedientServiceData['tombstoneNotApply'] == null ? 0 : $currentExpedientServiceData['tombstoneNotApply'];
                $tombstonePrint = $currentExpedientServiceData['tombstonePrint'] == null ? 0 : $currentExpedientServiceData['tombstonePrint'];
                $vivoSent = $currentExpedientServiceData['vivoSent'] == null ? 0 : $currentExpedientServiceData['vivoSent'];
                $vivoNotApply = $currentExpedientServiceData['vivoNotApply'] == null ? 0 : $currentExpedientServiceData['vivoNotApply'];
                $crematoriumWhoDelivered = $currentExpedientServiceData['crematoriumWhoDelivered'] == null ? 'null' : $currentExpedientServiceData['crematoriumWhoDelivered'];
                $crematoriumNotes = $currentExpedientServiceData['crematoriumNotes'];
                $crematoriumProgramOven = $currentExpedientServiceData['crematoriumProgramOven'] == null ? 0 : $currentExpedientServiceData['crematoriumProgramOven'];
                $crematoriumControlDeliversAshes = $currentExpedientServiceData['crematoriumControlDeliversAshes'] == null ? 0 : $currentExpedientServiceData['crematoriumControlDeliversAshes'];
                $crematoriumWhoProgramOven = $currentExpedientServiceData['crematoriumWhoProgramOven'] == null ? 'null' : $currentExpedientServiceData['crematoriumWhoProgramOven'];
                $crematoriumFirstGenerateDocDate = $currentExpedientServiceData['crematoriumFirstGenerateDocDate'] == null ? 'null' : $currentExpedientServiceData['crematoriumFirstGenerateDocDate'];
                $crematoriumFirstGenerateDocUser = $currentExpedientServiceData['crematoriumFirstGenerateDocUser'] == null ? 'null' : $currentExpedientServiceData['crematoriumFirstGenerateDocUser'];
                $priestInspected = $currentExpedientServiceData['priestInspected'] == null ? 0 : $currentExpedientServiceData['priestInspected'];
                $priestPayed = $currentExpedientServiceData['priestPayed'] == null ? 0 : $currentExpedientServiceData['priestPayed'];
                $priestNotes = $currentExpedientServiceData['priestNotes'];
                $sinceAniversaryWeb = $currentExpedientServiceData['sinceAniversaryWeb'] == null ? 'null' : "'" . $currentExpedientServiceData['sinceAniversaryWeb'] . "'";
                $untilAniversaryWeb = $currentExpedientServiceData['untilAniversaryWeb'] == null ? 'null' : "'" . $currentExpedientServiceData['untilAniversaryWeb'] . "'";
                $showAgeObituaryWeb = $currentExpedientServiceData['showAgeObituaryWeb'] == null ? 0 : $currentExpedientServiceData['showAgeObituaryWeb'];
                $churchAniversaryWeb = $currentExpedientServiceData['churchAniversaryWeb'] == null ? 'null' : $currentExpedientServiceData['churchAniversaryWeb'];
                $dateAniversaryWeb = $currentExpedientServiceData['dateAniversaryWeb'] == null ? 'null' : "'" . $currentExpedientServiceData['dateAniversaryWeb'] . "'";
                $timeAniversaryWeb = $currentExpedientServiceData['timeAniversaryWeb'] == null ? 'null' : "'" . $currentExpedientServiceData['timeAniversaryWeb'] . "'";
                $poll = $currentExpedientServiceData['poll'] == null ? 'null' : $currentExpedientServiceData['poll'];
                $carCollection2 = $currentExpedientServiceData['carCollection2'] == null ? 'null' : $currentExpedientServiceData['carCollection2'];
                $staffTransfer1 = $currentExpedientServiceData['staffTransfer1'] == null ? 'null' : $currentExpedientServiceData['staffTransfer1'];
                $staffTransfer2 = $currentExpedientServiceData['staffTransfer2'] == null ? 'null' : $currentExpedientServiceData['staffTransfer2'];
                $surveyNotApply = $currentExpedientServiceData['surveyNotApply'] == null ? 0 : $currentExpedientServiceData['surveyNotApply'];
                $surveySend = $currentExpedientServiceData['surveySend'] == null ? 0 : $currentExpedientServiceData['surveySend'];
                $showFinalDestinationWeb = $currentExpedientServiceData['showFinalDestinationWeb'] == null ? 0 : $currentExpedientServiceData['showFinalDestinationWeb'];
                $showVelationWeb = $currentExpedientServiceData['showVelationWeb'] == null ? 0 : $currentExpedientServiceData['showVelationWeb'];
                $showCeremonyWeb = $currentExpedientServiceData['showCeremonyWeb'] == null ? 0 : $currentExpedientServiceData['showCeremonyWeb'];
    
                $query = "  INSERT INTO Expedients_Services(
                                expedient, choir, bellringer, funeralHomeService, corpseCollection1, corpseCollection2, familyAssistance,
                                carCollection, arriveTime, arriveDate, revReqCheck, control, dni, priestTime, priestTimeCheck, gravediggersCheck,
                                gravediggersCheckPrinted, gravediggersCheckSigned, gravediggersNotApply, notifiedChoir, notifiedBellringer,
                                carriersTime, carriersTimeCheck, notes, routeSummary, notesSummary, churchSummary, licenseSummary, reminderSummary,
                                deliveryReceiptSummary, priestsNotification, gravediggersNotification, carriersNotification, choirsNotification,
                                bellringersNotification, carsNotification, policeNotified, policeNotApply, policeLocation, webNotApply, webConfirm,
                                webLink, doctorDone, doctorDeliver, doctorNotApply, doctorInProgress, tribunalDeliver, tribunalNotApply, tribunalInProgress,
                                tribunalLocation, tribunalUser, literalReceived, literalNoFinished, literalRequest, literalVolumePage, literalWhoTakes,
                                literalCivilRegister, literalDateExit, literalTimeExit, literalNotApply, tombstone, preparationNotApply, preparationConfirm,
                                policeNotification, webNotification, preparationNotification, doctorNotification, tribunalNotification, controlNotification,
                                reminderNotifications, flowerNotification, busNotification, taxiNotification, notApplyAll, tombstoneNotApply, tombstonePrint,
                                vivoSent, vivoNotApply, crematoriumWhoDelivered, crematoriumNotes, crematoriumProgramOven, crematoriumControlDeliversAshes,
                                crematoriumWhoProgramOven, crematoriumFirstGenerateDocDate, crematoriumFirstGenerateDocUser, priestInspected, priestPayed,
                                priestNotes, sinceAniversaryWeb, untilAniversaryWeb, showAgeObituaryWeb, churchAniversaryWeb, dateAniversaryWeb,
                                timeAniversaryWeb, poll, carCollection2, staffTransfer1, staffTransfer2, surveyNotApply, surveySend,
                                showFinalDestinationWeb, showVelationWeb, showCeremonyWeb
                            )
                            VALUES (
                                $newExpedientId, $choir, $bellringer, $funeralHomeService, $corpseCollection1, $corpseCollection2, $familyAssistance,
                                $carCollection, $arriveTime, $arriveDate, $revReqCheck, $control, '$dni', $priestTime, $priestTimeCheck, $gravediggersCheck,
                                $gravediggersCheckPrinted, $gravediggersCheckSigned, $gravediggersNotApply, $notifiedChoir, $notifiedBellringer,
                                $carriersTime, $carriersTimeCheck, '$notes', '$routeSummary', '$notesSummary', $churchSummary, $licenseSummary, $reminderSummary,
                                $deliveryReceiptSummary, $priestsNotification, $gravediggersNotification, $carriersNotification, $choirsNotification,
                                $bellringersNotification, $carsNotification, $policeNotified, $policeNotApply, '$policeLocation', $webNotApply, $webConfirm,
                                '$webLink', $doctorDone, $doctorDeliver, $doctorNotApply, $doctorInProgress, $tribunalDeliver, $tribunalNotApply, $tribunalInProgress,
                                '$tribunalLocation', $tribunalUser, $literalReceived, $literalNoFinished, $literalRequest, '$literalVolumePage', '$literalWhoTakes',
                                '$literalCivilRegister', $literalDateExit, '$literalTimeExit', $literalNotApply, '$tombstone', $preparationNotApply, $preparationConfirm,
                                $policeNotification, $webNotification, $preparationNotification, $doctorNotification, $tribunalNotification, $controlNotification,
                                $reminderNotifications, $flowerNotification, $busNotification, $taxiNotification, $notApplyAll, $tombstoneNotApply, $tombstonePrint,
                                $vivoSent, $vivoNotApply, $crematoriumWhoDelivered, '$crematoriumNotes', $crematoriumProgramOven, $crematoriumControlDeliversAshes,
                                $crematoriumWhoProgramOven, $crematoriumFirstGenerateDocDate, $crematoriumFirstGenerateDocUser, $priestInspected, $priestPayed,
                                '$priestNotes', $sinceAniversaryWeb, $untilAniversaryWeb, $showAgeObituaryWeb, $churchAniversaryWeb, $dateAniversaryWeb,
                                $timeAniversaryWeb, $poll, $carCollection2, $staffTransfer1, $staffTransfer2, $surveyNotApply, $surveySend,
                                $showFinalDestinationWeb, $showVelationWeb, $showCeremonyWeb
                            )
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception($query);
                }
                // End table: Expedients_Services
    
                // Start table: Expedients_Hirings + Expedients Texts + Services_Auto
                $query = "  SELECT  ID, template, product, model, supplier, retail, amount, texts, discount, total, `check`, extraID, warehouse, num_hiring, old_hiring, priceExp
                            FROM    Expedients_Hirings
                            WHERE   expedient = $expedientId AND 
                                    num_hiring = (SELECT MAX(eh2.num_hiring) FROM Expedients_Hirings eh2 WHERE eh2.expedient = $expedientId)
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception('Get current expedient hirings data');
                }
    
                $currentExpedientServiceData = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : null;
                if($currentExpedientServiceData == null){
                    throw new Exception('Get current expedient hirings data');
                }
    
                // Services auto
                $query = "  SELECT  service, model, action, value, status, hiring
                            FROM    Services_Auto
                            WHERE   service = $expedientId
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception('Get current services auto data');
                }
    
                $currentServiceAutoData = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                foreach($currentServiceAutoData as $item){
                    $model = $item['model'] == null ? 'null' : $item['model'];
                    $action = $item['action'] == null ? 'null' : $item['action'];
                    $value = $item['value'] == null ? '' : $item['value'];
                    $status = $item['status'] == null ? 0 : $item['status'];
                    $hiring = 'null';
    
                    $query = "  INSERT INTO Services_Auto(
                                    service, model, action, value, status, hiring
                                )
                                VALUES (
                                    $newExpedientId, $model, $action, '$value', $status, $hiring
                                )
                    ";
    
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception($query);
                    }
                }
    
                foreach($currentExpedientServiceData as $index => $elem){
                    $hiringId = $elem['ID'];
                    $template = $elem['template'] == null ? 'null' : $elem['template'];
                    $product = $elem['product'] == null ? 'null' : $elem['product'];
                    $model = $elem['model'] == null ? 'null' : $elem['model'];
                    $supplier = $elem['supplier'] == null ? 'null' : $elem['supplier'];
                    $retail = $elem['retail'] == null ? 'null' : $elem['retail'];
                    $amount = $elem['amount'] == null ? 0 : $elem['amount'];
                    $texts = $elem['texts'] == null ? '' : $elem['texts'];
                    $discount = $elem['discount'] == null ? 0 : $elem['discount'];
                    $total = $elem['total'] == null ? 0 : $elem['total'];
                    $check = $elem['check'] == null ? 0 : $elem['check'];
                    $warehouse = $elem['warehouse'] == null ? 'null' : $elem['warehouse'];
                    $num_hiring = $elem['num_hiring'] == null ? 0 : $elem['num_hiring'];
                    $priceExp = $elem['priceExp'] == null ? 'null' : $elem['priceExp'];
    
                    $result = $db->query("  SELECT  MAX(ID) as id
                                            FROM    Expedients_Hirings
                    ");
    
                    $maxID = mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0]['id'] : '1';
                    $extraID = $maxID.$index;
    
                    $query = "  INSERT INTO Expedients_Hirings(
                                    expedient, template, product, model, supplier, retail, amount, texts, discount, total,
                                    `check`, extraID, warehouse, num_hiring, priceExp
                                )
                                VALUES (
                                    $newExpedientId, $template, $product, $model, $supplier, $retail, $amount, '$texts', $discount, $total,
                                    $check, '$extraID', $warehouse, $num_hiring, $priceExp
                                )
                    ";
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception($query);
                    }
                    $newHiringId = $db->getLastInsertId();
    
                    // Get current texts associated
                    $query = "  SELECT  hiring, rowIndex, value, discount
                                FROM    Expedients_Texts
                                WHERE   hiring = $hiringId
                    ";
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception('Get current expedient texts data');
                    }
    
                    $currentExpedientTextsData = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                    foreach($currentExpedientTextsData as $item){
                        $rowIndex = $item['rowIndex'] == null ? 0 : $item['rowIndex'];
                        $value = $item['value'] == null ? '' : $item['value'];
                        $discount = $item['discount'] == null ? 0 : $item['discount'];
    
                        $query = "  INSERT INTO Expedients_Texts(
                                        hiring, rowIndex, value, discount
                                    )
                                    VALUES (
                                        $newHiringId, $rowIndex, '$value', $discount
                                    )
                        ";
    
                        $result = $db->query($query);
                        if(!$result){
                            throw new Exception($query);
                        }
                    }
    
                    $query = "  SELECT  ID
                                FROM    Services_Auto
                                WHERE   service = $newExpedientId AND
                                        model = $model
                    ";
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception('Get services auto data');
                    }
    
                    $serviceAutoId = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                    foreach($serviceAutoId as $item){
                        $query = "  UPDATE  Services_Auto
                                    SET     hiring = $newHiringId
                                    WHERE   ID = {$item['ID']}
                        ";
                        $result = $db->query($query);
                        if(!$result){
                            throw new Exception($query);
                        }
                    }
    
                    // Gets pre orders
                    $query = "  SELECT  hiring, `order`, sentEmail, sendCopy, leavingDate
                                FROM    Pre_Orders
                                WHERE   hiring = $hiringId
                    ";
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception('Get pre orders data');
                    }
                    $currentPreOrdersInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
    
                    foreach($currentPreOrdersInfo as $item){
                        $order = 'null';
                        $sentEmail = 0;
                        $sendCopy = 'null';
                        $leavingDate = $item['leavingDate'] == null ? 'null' : $item['leavingDate'];
    
                        $query = "  INSERT INTO Pre_Orders(
                                        hiring, `order`, sentEmail, sendCopy, leavingDate
                                    )
                                    VALUES (
                                        $newHiringId, $order, $sentEmail, $sendCopy, $leavingDate
                                    )
                        ";
    
                        $result = $db->query($query);
                        if(!$result){
                            throw new Exception($query);
                        }
                    }
                }
                // End table: Expedients_Hirings + Expedients Texts + Services_Auto
    
                // Start table: Services_Bellringers
                $query = "  SELECT  service, bellringer, notified, day, fromTime, toTime
                            FROM    Services_Bellringers
                            WHERE   service = $expedientId
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception('Get current services bellringers data');
                }
    
                $currentServiceBellringers = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                foreach($currentServiceBellringers as $elem){
                    $bellringer = $elem['bellringer'] == null ? 'null' : $elem['bellringer'];
                    $notified = $elem['notified'] == null ? 0 : $elem['notified'];
                    $day = $elem['day'] == null ? 'null' : "'" . $elem['day'] . "'";
                    $fromTime = $elem['fromTime'] == null ? 'null' : "'" . $elem['fromTime'] . "'";
                    $toTime = $elem['toTime'] == null ? 'null' : "'" . $elem['toTime'] . "'";
    
                    $query = "  INSERT INTO Services_Bellringers(
                                    service, bellringer, notified, day, fromTime, toTime
                                )
                                VALUES (
                                    $newExpedientId, $bellringer, $notified, $day, $fromTime, $toTime
                                )
                    ";
    
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception($query);
                    }   
                }
                // End table: Services_Bellringers
    
                // Start table: Services_Carriers
                $query = "  SELECT  service, carrier, confirmed, day, fromTime, toTime
                            FROM    Services_Carriers
                            WHERE   service = $expedientId
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception('Get current services carriers data');
                }
    
                $currentServiceCarriers = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                foreach($currentServiceCarriers as $elem){
                    $carrier = $elem['carrier'] == null ? 'null' : $elem['carrier'];
                    $confirmed = $elem['confirmed'] == null ? 0 : $elem['confirmed'];
                    $day = $elem['day'] == null ? 'null' : "'" . $elem['day'] . "'";
                    $fromTime = $elem['fromTime'] == null ? 'null' : "'" . $elem['fromTime'] . "'";
                    $toTime = $elem['toTime'] == null ? 'null' : "'" . $elem['toTime'] . "'";
    
                    $query = "  INSERT INTO Services_Carriers(
                                    service, carrier, confirmed, day, fromTime, toTime
                                )
                                VALUES (
                                    $newExpedientId, $carrier, $confirmed, $day, $fromTime, $toTime
                                )
                    ";
    
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception($query);
                    }   
                }
                // End table: Services_Carriers
    
                // Start table: Services_Cars
                $query = "  SELECT  service, car, driver, cleanBefore, cleanAfter
                            FROM    Services_Cars
                            WHERE   service = $expedientId
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception('Get current services carriers data');
                }
    
                $currentServiceCars = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                foreach($currentServiceCars as $elem){
                    $car = $elem['car'] == null ? 'null' : $elem['car'];
                    $driver = $elem['driver'] == null ? 'null' : $elem['driver'];
                    $cleanBefore = $elem['cleanBefore'] == null ? 'null' : $elem['cleanBefore'];
                    $cleanAfter = $elem['cleanAfter'] == null ? 'null' : $elem['cleanAfter'];
    
                    $query = "  INSERT INTO Services_Cars(
                                    service, car, driver, cleanBefore, cleanAfter
                                )
                                VALUES (
                                    $newExpedientId, $car, $driver, $cleanBefore, $cleanAfter
                                )
                    ";
    
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception($query);
                    }   
                }
                // End table: Services_Cars
    
                // Start table: Services_Choirs
                $query = "  SELECT  service, choir, notified, day, fromTime, toTime
                            FROM    Services_Choirs
                            WHERE   service = $expedientId
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception('Get current services choirs data');
                }
    
                $currentServiceChoirs = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                foreach($currentServiceChoirs as $elem){
                    $choir = $elem['choir'] == null ? 'null' : $elem['choir'];
                    $notified = $elem['notified'] == null ? 0 : $elem['notified'];
                    $day = $elem['day'] == null ? 'null' : "'" . $elem['day'] . "'";
                    $fromTime = $elem['fromTime'] == null ? 'null' : "'" . $elem['fromTime'] . "'";
                    $toTime = $elem['toTime'] == null ? 'null' : "'" . $elem['toTime'] . "'";
    
                    $query = "  INSERT INTO Services_Choirs(
                                    service, choir, notified, day, fromTime, toTime
                                )
                                VALUES (
                                    $newExpedientId, $choir, $notified, $day, $fromTime, $toTime
                                )
                    ";
    
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception($query);
                    }   
                }
                // End table: Services_Choirs
    
                // Start table: Services_Gravediggers
                $query = "  SELECT  service, gravedigger, notified, day, fromTime, toTime
                            FROM    Services_Gravediggers
                            WHERE   service = $expedientId
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception('Get current services gravediggers data');
                }
    
                $currentServiceGravediggers = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                foreach($currentServiceGravediggers as $elem){
                    $gravedigger = $elem['gravedigger'] == null ? 'null' : $elem['gravedigger'];
                    $notified = $elem['notified'] == null ? 0 : $elem['notified'];
                    $day = $elem['day'] == null ? 'null' : "'" . $elem['day'] . "'";
                    $fromTime = $elem['fromTime'] == null ? 'null' : "'" . $elem['fromTime'] . "'";
                    $toTime = $elem['toTime'] == null ? 'null' : "'" . $elem['toTime'] . "'";
    
                    $query = "  INSERT INTO Services_Gravediggers(
                                    service, gravedigger, notified, day, fromTime, toTime
                                )
                                VALUES (
                                    $newExpedientId, $gravedigger, $notified, $day, $fromTime, $toTime
                                )
                    ";
    
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception($query);
                    }   
                }
                // End table: Services_Gravediggers
    
                // Start table: Services_Priests
                $query = "  SELECT  service, priest, notified, day, fromTime, toTime
                            FROM    Services_Priests
                            WHERE   service = $expedientId
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception('Get current services priests data');
                }
    
                $currentServicePriests = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                foreach($currentServicePriests as $elem){
                    $priest = $elem['priest'] == null ? 'null' : $elem['priest'];
                    $notified = $elem['notified'] == null ? 0 : $elem['notified'];
                    $day = $elem['day'] == null ? 'null' : "'" . $elem['day'] . "'";
                    $fromTime = $elem['fromTime'] == null ? 'null' : "'" . $elem['fromTime'] . "'";
                    $toTime = $elem['toTime'] == null ? 'null' : "'" . $elem['toTime'] . "'";
    
                    $query = "  INSERT INTO Services_Priests(
                                    service, priest, notified, day, fromTime, toTime
                                )
                                VALUES (
                                    $newExpedientId, $priest, $notified, $day, $fromTime, $toTime
                                )
                    ";
    
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception($query);
                    }   
                }
                // End table: Services_Priests
    
                // Start table: Services_Control
                $query = "  SELECT  assistance, notes, mailTo, send, sent
                            FROM    Services_Control
                            WHERE   service = $expedientId
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception('Get current services control data');
                }
                $currentServiceControl = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                foreach($currentServiceControl as $elem){
                    $assistance = $elem['assistance'] == null ? 'null' : "'" . $elem['assistance'] . "'";
                    $notes = $elem['notes'] == null ? 'null' : "'" . $elem['notes'] . "'";
                    $mailTo = $elem['mailTo'] == null ? 'null' : "'" . $elem['mailTo'] . "'";
                    $send = $elem['send'] == null ? 'null' : "'" . $elem['send'] . "'";
                    $sent = $elem['sent'] == null ? 0 : $elem['sent'];
    
                    $query = "  INSERT INTO Services_Control(
                                    service, assistance, notes, mailTo, send, sent
                                )
                                VALUES (
                                    $newExpedientId, $assistance, $notes, $mailTo, $send, $sent
                                )
                    ";
    
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception($query);
                    }   
                }
                // End table: Services_Control
    
                // Start table: Services_Control_Emails
                $query = "  SELECT  email
                            FROM    Services_Control_Emails
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception('Get current services control emails data');
                }
                $currentServiceControlEmails = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                foreach($currentServiceControlEmails as $elem){
                    $email = $elem['email'] == null ? 1 : $elem['email'];
    
                    $query = "  INSERT INTO Services_Control_Emails(
                                    expedient, email
                                )
                                VALUES (
                                    $newExpedientId, $email
                                )
                    ";
    
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception($query);
                    }   
                }
                // End table: Services_Control_Emails
    
                // Start table: Survey_Clients_Info
                $query = "  SELECT  survey, service, value, notes
                            FROM    Survey_Clients_Info
                            WHERE   service = $expedientId
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception('Get current survey clients info data');
                }
                $currentSurveyClientsInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                foreach($currentSurveyClientsInfo as $elem){
                    $survey = $elem['survey'] == null ? 'null' : $elem['survey'];
                    $value = $elem['value'] == null ? 'null' : $elem['value'];
                    $notes = $elem['notes'] == null ? 'null' : "'" . $elem['notes'] . "'";
    
                    $query = "  INSERT INTO Survey_Clients_Info(
                                    survey, service, value, notes
                                )
                                VALUES (
                                    $survey, $newExpedientId, $value, $notes
                                )
                    ";
    
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception($query);
                    }   
                }
                // End table: Survey_Clients_Info
    
                // Start table: Satisfaction_Survey
                $query = "  SELECT  expedient, attention, advice, time, cafe, room, building, crematorium, cleaning, organization, doubt,
                                    attentionText, adviceText, timeText, cafeText, roomText, buildingText, crematoriumText, cleaningText,
                                    organizationText, doubtText, aspects, date, relationship, name
                            FROM    Satisfaction_Survey
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception('Get current satisfaction survey data');
                }
                $currentSatifactionSurveyInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                foreach($currentSatifactionSurveyInfo as $elem){
                    $attention = $elem['attention'] == null ? 'null' : $elem['attention'];
                    $advice = $elem['advice'] == null ? 'null' : $elem['advice'];
                    $time = $elem['time'] == null ? 'null' : $elem['time'];
                    $cafe = $elem['cafe'] == null ? 'null' : $elem['cafe'];
                    $room = $elem['room'] == null ? 'null' : $elem['room'];
                    $building = $elem['building'] == null ? 'null' : $elem['building'];
                    $crematorium = $elem['crematorium'] == null ? 'null' : $elem['crematorium'];
                    $cleaning = $elem['cleaning'] == null ? 'null' : $elem['cleaning'];
                    $organization = $elem['organization'] == null ? 'null' : $elem['organization'];
                    $doubt = $elem['doubt'] == null ? 'null' : $elem['doubt'];
                    $attentionText = $elem['attentionText'] == null ? 'null' : "'" . $elem['attentionText'] . "'";
                    $adviceText = $elem['adviceText'] == null ? 'null' : "'" . $elem['adviceText'] . "'";
                    $timeText = $elem['timeText'] == null ? 'null' : "'" . $elem['timeText'] . "'";
                    $cafeText = $elem['cafeText'] == null ? 'null' : "'" . $elem['cafeText'] . "'";
                    $roomText = $elem['roomText'] == null ? 'null' : "'" . $elem['roomText'] . "'";
                    $buildingText = $elem['buildingText'] == null ? 'null' : "'" . $elem['buildingText'] . "'";
                    $crematoriumText = $elem['crematoriumText'] == null ? 'null' : "'" . $elem['crematoriumText'] . "'";
                    $cleaningText = $elem['cleaningText'] == null ? 'null' : "'" . $elem['cleaningText'] . "'";
                    $organizationText = $elem['organizationText'] == null ? 'null' : "'" . $elem['organizationText'] . "'";
                    $doubtText = $elem['doubtText'] == null ? 'null' : "'" . $elem['doubtText'] . "'";
                    $aspects = $elem['aspects'] == null ? 'null' : "'" . $elem['aspects'] . "'";
                    $date = $elem['date'] == null ? 'null' : $elem['date'];
                    $relationship = $elem['relationship'] == null ? 'null' : "'" . $elem['relationship'] . "'";
                    $name = $elem['name'] == null ? 'null' : "'" . $elem['name'] . "'";
    
                    $query = "  INSERT INTO Satisfaction_Survey(
                                    expedient, attention, advice, time, cafe, room, building, crematorium, cleaning, organization, doubt,
                                    attentionText, adviceText, timeText, cafeText, roomText, buildingText, crematoriumText, cleaningText,
                                    organizationText, doubtText, aspects, date, relationship, name
                                )
                                VALUES (
                                    $newExpedientId, $attention, $advice, $time, $cafe, $room, $building, $crematorium, $cleaning, $organization, $doubt,
                                    $attentionText, $adviceText, $timeText, $cafeText, $roomText, $buildingText, $crematoriumText, $cleaningText,
                                    $organizationText, $doubtText, $aspects, $date, $relationship, $name
                                )
                    ";
    
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception($query);
                    }   
                }
                // End table: Satisfaction_Survey
    
                // Start table: Condolences
                $query = "  SELECT  expedient, name, phone, address, city, condolence, doc, date, delivered, extraID
                            FROM    Condolences
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception('Get current condolences data');
                }
                $currentCondolencesInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                foreach($currentCondolencesInfo as $elem){
                    $name = $elem['name'] == null ? 'null' : "'" . $elem['name'] . "'";
                    $phone = $elem['phone'] == null ? 'null' : "'" . $elem['phone'] . "'";
                    $address = $elem['address'] == null ? 'null' : "'" . $elem['address'] . "'";
                    $city = $elem['city'] == null ? 'null' : "'" . $elem['city'] . "'";
                    $condolence = $elem['condolence'] == null ? 'null' : "'" . $elem['condolence'] . "'";
                    $doc = $elem['doc'] == null ? 'null' : "'" . $elem['doc'] . "'";
                    $date = $elem['date'] == null ? 'null' : $elem['date'];
                    $delivered = $elem['delivered$delivered'] == null ? 0 : $elem['delivered$delivered'];
    
                    $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);
                    $result = $db->query("  SELECT  * 
                                            FROM    Condolences 
                                            WHERE   extraID = '" . $extraID . "'"
                    );
                    while(mysqli_num_rows($result) > 0){
                        $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);
                        $result = $db->query("  SELECT  * 
                                                FROM    Condolences 
                                                WHERE   extraID = '" . $extraID . "'"
                        );
                    }
    
                    $query = "  INSERT INTO Condolences(
                                    expedient, name, phone, address, city, condolence, doc, date, delivered, extraID
                                )
                                VALUES (
                                    $newExpedientId, $name, $phone, $address, $city, $condolence, $doc, $date, $delivered, '$extraID'
                                )
                    ";
    
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception($query);
                    }   
                }
                // End table: Condolences
    
                // Start table: Events
                $query = "  SELECT  status, user, cleaningType, cleaningMortuary, cleaningUser, type, expedient, car, upkeeps,
                                    name, start, end, regularity, reminder, cremation, success, allDay, leavingDate, mailSend,
                                    mailDate, mailTo, mailSent, description, dischargeDay, extraID
                            FROM    Events
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception('Get current events data');
                }
                $currentEventsInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                foreach($currentEventsInfo as $elem){
                    $isCrematiumEvent = false;
                    $status = $elem['status'] == null ? 1 : $elem['status'];
                    $user = $elem['user'] == null ? 'null' : $elem['user'];
                    $cleaningType = $elem['cleaningType'] == null ? 'null' : $elem['cleaningType'];
                    $cleaningMortuary = $elem['cleaningMortuary'] == null ? 'null' : $elem['cleaningMortuary'];
                    $cleaningUser = $elem['cleaningUser'] == null ? 'null' : $elem['cleaningUser'];
                    $car = $elem['car'] == null ? 'null' : $elem['car'];
                    $upkeeps = $elem['upkeeps'] == null ? 'null' : $elem['upkeeps'];
                    $type = $elem['type'] == null ? 'null' : $elem['type'];
                    if($type == 1){
                        $name = "'Cremación Exp. " . $number . "'";
                        $isCrematiumEvent = true;
                    }else{
                        $name = $elem['name'] == null ? 'null' : "'" . $elem['name'] . "'";
                    }
                    $start = $elem['start'] == null ? 'null' : "'" . $elem['start'] . "'";
                    $end = $elem['end'] == null ? 'null' : "'" . $elem['end'] . "'";
                    $regularity = $elem['regularity'] == null ? 'null' : $elem['regularity'];
                    $reminder = $elem['reminder'] == null ? 'null' : $elem['reminder'];
                    $cremation = $elem['cremation'] == null ? 0 : $elem['cremation'];
                    $success = $elem['success'] == null ? 0 : $elem['success'];
                    $allDay = $elem['allDay'] == null ? 0 : $elem['allDay'];
                    $leavingDate = $elem['leavingDate'] == null ? 'null' : "'" . $elem['leavingDate'] . "'";
                    $mailSend = $elem['mailSend'] == null ? 0 : $elem['mailSend'];
                    $mailDate = $elem['mailDate'] == null ? 'null' : $elem['mailDate'];
                    $mailTo = $elem['mailTo'] == null ? 'null' : "'" . $elem['mailTo'] . "'";
                    $mailSent = $elem['mailSent'] == null ? 0 : $elem['mailSent'];
                    $description = $elem['description'] == null ? 'null' : "'" . $elem['description'] . "'";
                    $dischargeDay = $elem['dischargeDay'] == null ? 0 : $elem['dischargeDay'];
    
                    $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);
                    $result = $db->query("  SELECT  * 
                                            FROM    Events 
                                            WHERE   extraID = '" . $extraID . "'"
                    );
                    while(mysqli_num_rows($result) > 0){
                        $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);
                        $result = $db->query("  SELECT  * 
                                                FROM    Events 
                                                WHERE   extraID = '" . $extraID . "'"
                        );
                    }
    
                    $query = "  INSERT INTO Events(
                                    status, user, cleaningType, cleaningMortuary, cleaningUser, type, expedient, car, upkeeps,
                                    name, start, end, regularity, reminder, cremation, success, allDay, leavingDate, mailSend,
                                    mailDate, mailTo, mailSent, description, dischargeDay, extraID
                                )
                                VALUES (
                                    $status, $user, $cleaningType, $cleaningMortuary, $cleaningUser, $type, $newExpedientId, $car, $upkeeps,
                                    $name, $start, $end, $regularity, $reminder, $cremation, $success, $allDay, $leavingDate, $mailSend,
                                    $mailDate, $mailTo, $mailSent, $description, $dischargeDay, '$extraID'
                                )
                    ";
    
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception($query);
                    }

                    // Asociate crematium event
                    if($isCrematiumEvent){
                        $newEventId = $db->getLastInsertId();

                        $query = "  UPDATE  Expedients
                                    SET     crematoriumEvent = $newEventId
                                    WHERE   expedientID = $newExpedientId
                        ";    

                        $result = $db->query($query);
                        if(!$result){
                            throw new Exception($query);
                        }
                    }
                }
                // End table: Events
    
                // Start table: Expedients_History_Docs_Sent + Expedients_History_Docs_Sent_Emails
                $query = "  SELECT  id, doc_name, user_create, create_date
                            FROM    Expedients_History_Docs_Sent
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception('Get current history documents sent data');
                }
                $currentHistoryDocumentsSentInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                foreach($currentHistoryDocumentsSentInfo as $elem){
                    $historyDocId = $elem['id'];
                    $docName = $elem['doc_name'] == null ? 'null' : "'" . $elem['doc_name'] . "'";
                    $userCreate = $elem['user_create'] == null ? 'null' : $elem['user_create'];
                    $createDate = $elem['create_date'] == null ? 'null' : $elem['create_date'];
    
                    $query = "  INSERT INTO Expedients_History_Docs_Sent(
                                    expedient, doc_name, user_create, create_date
                                )
                                VALUES (
                                    $newExpedientId, $docName, $userCreate, $createDate
                                )
                    ";
    
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception($query);
                    }
                    $newDocId = $db->getLastInsertId();
    
                    $query = "  SELECT  assistant, bellringer, cemetery, client, choir, priest, gravedigger, church, doctor, staff,
                                        carrier, supplier, email, create_date
                                FROM    Expedients_History_Docs_Sent_Emails
                                WHERE   expedient_history_doc_sent = $historyDocId
                    ";
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception('Get current history documents sent emails data');
                    }
                    $currentHistoryDocumentsSentEmailsInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                    foreach($currentHistoryDocumentsSentEmailsInfo as $elem){
                        $assistant = $elem['assistant'] == null ? 'null' : $elem['assistant'];
                        $bellringer = $elem['bellringer'] == null ? 'null' : $elem['bellringer'];
                        $cemetery = $elem['cemetery'] == null ? 'null' : $elem['cemetery'];
                        $client = $elem['client'] == null ? 'null' : $elem['client'];
                        $choir = $elem['choir'] == null ? 'null' : $elem['choir'];
                        $priest = $elem['priest'] == null ? 'null' : $elem['priest'];
                        $gravedigger = $elem['gravedigger'] == null ? 'null' : $elem['gravedigger'];
                        $church = $elem['church'] == null ? 'null' : $elem['church'];
                        $doctor = $elem['doctor'] == null ? 'null' : $elem['doctor'];
                        $staff = $elem['staff'] == null ? 'null' : $elem['staff'];
                        $carrier = $elem['carrier'] == null ? 'null' : $elem['carrier'];
                        $supplier = $elem['supplier'] == null ? 'null' : $elem['supplier'];
                        $email = $elem['email'] == null ? 'null' : "'" . $elem['email'] . "'";
                        $createDate = $elem['create_date'] == null ? 'null' : $elem['create_date'];
    
                        $query = "  INSERT INTO Expedients_History_Docs_Sent_Emails(
                                        expedient_history_doc_sent, assistant, bellringer, cemetery, client, choir, priest, gravedigger,
                                        church, doctor, staff, carrier, supplier, email, create_date
                                    )
                                    VALUES (
                                        $newDocId, $assistant, $bellringer, $cemetery, $client, $choir, $priest, $gravedigger,
                                        $church, $doctor, $staff, $carrier, $supplier, $email, $createDate
                                    )
                        ";
    
                        $result = $db->query($query);
                        if(!$result){
                            throw new Exception($query);
                        }   
                    }
                }
                // End table: Expedients_History_Docs_Sent + Expedients_History_Docs_Sent_Emails
    
                // Start table: Expedients_Polls + Expedients_Polls_Results
                $query = "  SELECT  id, phone, sent, admin_notes, leavingDate
                            FROM    Expedients_Polls
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception('Get current expedients polls data');
                }
                $currentExpedientPollInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                foreach($currentExpedientPollInfo as $elem){
                    $expedientPollId = $elem['id'];
                    $phone = $elem['phone'] == null ? 'null' : "'" . $elem['phone'] . "'";
                    $sent = $elem['sent'] == null ? 0 : $elem['sent'];
                    $adminNotes = $elem['admin_notes'] == null ? 'null' : "'" . $elem['admin_notes'] . "'";
                    $leavingDate = $elem['leavingDate'] == null ? 'null' : $elem['leavingDate'];
    
                    $query = "  INSERT INTO Expedients_Polls(
                                    expedient, phone, sent, admin_notes, leavingDate
                                )
                                VALUES (
                                    $newExpedientId, $phone, $sent, $adminNotes, $createDate
                                )
                    ";
    
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception($query);
                    }
                    $newPollId = $db->getLastInsertId();
    
                    $query = "  SELECT  poll_item, score, notes, creationDate, leavingDate
                                FROM    Expedients_Polls_Results
                                WHERE   expedient_poll = $expedientPollId
                    ";
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception('Get current expedients polls results data');
                    }
                    $currentHistoryDocumentsSentEmailsInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                    foreach($currentHistoryDocumentsSentEmailsInfo as $elem){
                        $pollItem = $elem['poll_item'] == null ? 1 : $elem['poll_item'];
                        $score = $elem['score'] == null ? 0 : $elem['score'];
                        $notes = $elem['notes'] == null ? 'null' : "'" . $elem['notes'] . "'";
                        $creationDate = $elem['creationDate'] == null ? 'null' : $elem['creationDate'];
                        $leavingDate = $elem['leavingDate'] == null ? 'null' : $elem['leavingDate'];
    
                        $query = "  INSERT INTO Expedients_Polls_Results(
                                        expedient_poll, poll_item, score, notes, creationDate, leavingDate
                                    )
                                    VALUES (
                                        $newPollId, $pollItem, $score, $notes, $creationDate, $leavingDate
                                    )
                        ";
    
                        $result = $db->query($query);
                        if(!$result){
                            throw new Exception($query);
                        }   
                    }
                }
                // End table: Expedients_Polls + Expedients_Polls_Results
    
                // Start table: Expedients_Notes + Expedients_Notes_Users
                $query = "  SELECT  id, user, section, note, create_date, update_date, delete_date
                            FROM    Expedients_Notes
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception('Get current expedients notes data');
                }
                $currentExpedientNotesInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                foreach($currentExpedientNotesInfo as $elem){
                    $expedientNoteId = $elem['id'];
                    $user = $elem['user'] == null ? 'null' : $elem['user'];
                    $section = $elem['section'] == null ? 'null' : $elem['section'];
                    $note = $elem['note'] == null ? 'null' : "'" . $elem['note'] . "'";
                    $createDate = $elem['create_date'] == null ? 'null' : $elem['create_date'];
                    $updateDate = $elem['update_date'] == null ? 'null' : $elem['update_date'];
                    $deleteDate = $elem['delete_date'] == null ? 'null' : $elem['delete_date'];
    
                    $query = "  INSERT INTO Expedients_Notes(
                                    user, expedient, section, note, create_date, update_date, delete_date
                                )
                                VALUES (
                                    $user, $newExpedientId, $section, $note, $createDate, $updateDate, $deleteDate
                                )
                    ";
    
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception($query);
                    }
                    $newNoteId = $db->getLastInsertId();
    
                    $query = "  SELECT  note, user, date, seen, create_date, update_date, delete_date
                                FROM    Expedients_Notes_Users
                                WHERE   note = $expedientNoteId
                    ";
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception('Get current expedients notes users data');
                    }
                    $currentNotesUsersInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                    foreach($currentNotesUsersInfo as $elem){
                        $note = $elem['note'] == null ? 'null' : $elem['note'];
                        $user = $elem['user'] == null ? 'null' : $elem['user'];
                        $date = $elem['date'] == null ? 'null' : $elem['date'];
                        $seen = $elem['seen'] == null ? 'null' : $elem['seen'];
                        $createDate = $elem['create_date'] == null ? 'null' : $elem['create_date'];
                        $updateDate = $elem['update_date'] == null ? 'null' : $elem['update_date'];
                        $deleteDate = $elem['delete_date'] == null ? 'null' : $elem['delete_date'];
    
                        $query = "  INSERT INTO Expedients_Notes_Users(
                                        note, user, date, seen, create_date, update_date, delete_date
                                    )
                                    VALUES (
                                        $newNoteId, $user, $date, $seen, $createDate, $updateDate, $deleteDate
                                    )
                        ";
    
                        $result = $db->query($query);
                        if(!$result){
                            throw new Exception($query);
                        }   
                    }
                }
                // End table: Expedients_Notes + Expedients_Notes_Users
    
                // Start table: Assistances + Survey_Assistance
                $query = "  SELECT  ID, attendanceDate, address, location, phone1, phone2, phone3, literalDate, receiptDate, ssDateStartCheck,
                                    ssDateStart, ssDateEndCheck, ssDateEnd, spanishPension, foreignPension, inssDateStartCheck, inssDateStart,
                                    inssDateEndCheck, inssDateEnd, ismDateStartCheck, ismDateStart, ismDateEndCheck, ismDateEnd, socialDateStartCheck,
                                    socialDateStart, socialDateEndCheck, socialDateEnd, passiveDateStartCheck, passiveDateStart, passiveDateEndCheck,
                                    passiveDateEnd, isfasDateStartCheck, isfasDateStart, isfasDateEndCheck, isfasDateEnd, lastWishDateStartCheck,
                                    lastWishDateStart, lastWishDateEndCheck, lastWishDateEnd, insuranceCoverageStartCheck, insuranceCoverageStart,
                                    insuranceCoverageEndCheck, insuranceCoverageEnd, dniDateGStartCheck, dniDateGStart, dniDateGEndCheck, dniDateGEnd,
                                    familyBookDateGStartCheck, familyBookDateGStart, familyBookDateGEndCheck, familyBookDateGEnd, literalMarriageDateGStartCheck,
                                    literalMarriageDateGStart, literalMarriageDateGEndCheck, literalMarriageDateGEnd, literalBirthdayDateGStartCheck,
                                    literalBirthdayDateGStart, literalBirthdayDateGEndCheck, literalBirthdayDateGEnd, registrationDateGStartCheck,
                                    registrationDateGStart, registrationDateGEndCheck, registrationDateGEnd, several, dniDateRStartCheck, dniDateRStart,
                                    dniDateREndCheck, dniDateREnd, familyBookDateRStartCheck, familyBookDateRStart, familyBookDateREndCheck, familyBookDateREnd,
                                    literalMarriageDateRStartCheck, literalMarriageDateRStart, literalMarriageDateREndCheck, literalMarriageDateREnd,
                                    literalBirthdayDateRStartCheck, literalBirthdayDateRStart, literalBirthdayDateREndCheck, literalBirthdayDateREnd,
                                    registrationDateRStartCheck, registrationDateRStart, registrationDateREndCheck, registrationDateREnd, km, successions,
                                    deathReport, production, notes, extraID, leavingDate
                            FROM    Assistances
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
                if(!$result){
                    throw new Exception('Get current assistances data');
                }
                $currentAssistantesInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                foreach($currentAssistantesInfo as $elem){
                    $assistanceId = $elem['ID'];
                    $attendanceDate = $elem['attendanceDate'] == null ? 'null' : $elem['attendanceDate'];
                    $address = $elem['address'] == null ? 'null' : "'" . $elem['address'] . "'";
                    $location = $elem['location'] == null ? 'null' : $elem['location'];
                    $phone1 = $elem['phone1'] == null ? 'null' : "'" . $elem['phone1'] . "'";
                    $phone2 = $elem['phone2'] == null ? 'null' : "'" . $elem['phone2'] . "'";
                    $phone3 = $elem['phone3'] == null ? 'null' : "'" . $elem['phone3'] . "'";
                    $literalDate = $elem['literalDate'] == null ? 'null' : $elem['literalDate'];
                    $receiptDate = $elem['receiptDate'] == null ? 'null' : $elem['receiptDate'];
                    $ssDateStartCheck = $elem['ssDateStartCheck'] == null ? 0 : $elem['ssDateStartCheck'];
                    $ssDateStart = $elem['ssDateStart'] == null ? 'null' : $elem['ssDateStart'];
                    $ssDateEndCheck = $elem['ssDateEndCheck'] == null ? 0 : $elem['ssDateEndCheck'];
                    $ssDateEnd = $elem['ssDateEnd'] == null ? 'null' : $elem['ssDateEnd'];
                    $spanishPension = $elem['spanishPension'] == null ? 0 : $elem['spanishPension'];
                    $foreignPension = $elem['foreignPension'] == null ? 0 : $elem['foreignPension'];
                    $inssDateStartCheck = $elem['inssDateStartCheck'] == null ? 0 : $elem['inssDateStartCheck'];
                    $inssDateStart = $elem['inssDateStart'] == null ? 'null' : $elem['inssDateStart'];
                    $inssDateEndCheck = $elem['inssDateEndCheck'] == null ? 0 : $elem['inssDateEndCheck'];
                    $inssDateEnd = $elem['inssDateEnd'] == null ? 'null' : $elem['inssDateEnd'];
                    $ismDateStartCheck = $elem['ismDateStartCheck'] == null ? 0 : $elem['ismDateStartCheck'];
                    $ismDateStart = $elem['ismDateStart'] == null ? 'null' : $elem['ismDateStart'];
                    $ismDateEndCheck = $elem['ismDateEndCheck'] == null ? 0 : $elem['ismDateEndCheck'];
                    $ismDateEnd = $elem['ismDateEnd'] == null ? 'null' : $elem['ismDateEnd'];
                    $socialDateStartCheck = $elem['socialDateStartCheck'] == null ? 0 : $elem['socialDateStartCheck'];
                    $socialDateStart = $elem['socialDateStart'] == null ? 'null' : $elem['socialDateStart'];
                    $socialDateEndCheck = $elem['socialDateEndCheck'] == null ? 0 : $elem['socialDateEndCheck'];
                    $socialDateEnd = $elem['socialDateEnd'] == null ? 'null' : $elem['socialDateEnd'];
                    $passiveDateStartCheck = $elem['passiveDateStartCheck'] == null ? 0 : $elem['passiveDateStartCheck'];
                    $passiveDateStart = $elem['passiveDateStart'] == null ? 'null' : $elem['passiveDateStart'];
                    $passiveDateEndCheck = $elem['passiveDateEndCheck'] == null ? 0 : $elem['passiveDateEndCheck'];
                    $passiveDateEnd = $elem['passiveDateEnd'] == null ? 'null' : $elem['passiveDateEnd'];
                    $isfasDateStartCheck = $elem['isfasDateStartCheck'] == null ? 0 : $elem['isfasDateStartCheck'];
                    $isfasDateStart = $elem['isfasDateStart'] == null ? 'null' : $elem['isfasDateStart'];
                    $isfasDateEndCheck = $elem['isfasDateEndCheck'] == null ? 0 : $elem['isfasDateEndCheck'];
                    $isfasDateEnd = $elem['isfasDateEnd'] == null ? 'null' : $elem['isfasDateEnd'];
                    $lastWishDateStartCheck = $elem['lastWishDateStartCheck'] == null ? 0 : $elem['lastWishDateStartCheck'];
                    $lastWishDateStart = $elem['lastWishDateStart'] == null ? 'null' : $elem['lastWishDateStart'];
                    $lastWishDateEndCheck = $elem['lastWishDateEndCheck'] == null ? 0 : $elem['lastWishDateEndCheck'];
                    $lastWishDateEnd = $elem['lastWishDateEnd'] == null ? 'null' : $elem['lastWishDateEnd'];
                    $insuranceCoverageStartCheck = $elem['insuranceCoverageStartCheck'] == null ? 0 : $elem['insuranceCoverageStartCheck'];
                    $insuranceCoverageStart = $elem['insuranceCoverageStart'] == null ? 'null' : $elem['insuranceCoverageStart'];
                    $insuranceCoverageEndCheck = $elem['insuranceCoverageEndCheck'] == null ? 0 : $elem['insuranceCoverageEndCheck'];
                    $insuranceCoverageEnd = $elem['insuranceCoverageEnd'] == null ? 'null' : $elem['insuranceCoverageEnd'];
                    $dniDateGStartCheck = $elem['dniDateGStartCheck'] == null ? 0 : $elem['dniDateGStartCheck'];
                    $dniDateGStart = $elem['dniDateGStart'] == null ? 'null' : $elem['dniDateGStart'];
                    $dniDateGEndCheck = $elem['dniDateGEndCheck'] == null ? 0 : $elem['dniDateGEndCheck'];
                    $dniDateGEnd = $elem['dniDateGEnd'] == null ? 'null' : $elem['dniDateGEnd'];
                    $familyBookDateGStartCheck = $elem['familyBookDateGStartCheck'] == null ? 0 : $elem['familyBookDateGStartCheck'];
                    $familyBookDateGStart = $elem['familyBookDateGStart'] == null ? 'null' : $elem['familyBookDateGStart'];
                    $familyBookDateGEndCheck = $elem['familyBookDateGEndCheck'] == null ? 0 : $elem['familyBookDateGEndCheck'];
                    $familyBookDateGEnd = $elem['familyBookDateGEnd'] == null ? 'null' : $elem['familyBookDateGEnd'];
                    $literalMarriageDateGStartCheck = $elem['literalMarriageDateGStartCheck'] == null ? 0 : $elem['literalMarriageDateGStartCheck'];
                    $literalMarriageDateGStart = $elem['literalMarriageDateGStart'] == null ? 'null' : $elem['literalMarriageDateGStart'];
                    $literalMarriageDateGEndCheck = $elem['literalMarriageDateGEndCheck'] == null ? 0 : $elem['literalMarriageDateGEndCheck'];
                    $literalMarriageDateGEnd = $elem['literalMarriageDateGEnd'] == null ? 'null' : $elem['literalMarriageDateGEnd'];
                    $literalBirthdayDateGStartCheck = $elem['literalBirthdayDateGStartCheck'] == null ? 0 : $elem['literalBirthdayDateGStartCheck'];
                    $literalBirthdayDateGStart = $elem['literalBirthdayDateGStart'] == null ? 'null' : $elem['literalBirthdayDateGStart'];
                    $literalBirthdayDateGEndCheck = $elem['literalBirthdayDateGEndCheck'] == null ? 0 : $elem['literalBirthdayDateGEndCheck'];
                    $literalBirthdayDateGEnd = $elem['literalBirthdayDateGEnd'] == null ? 'null' : $elem['literalBirthdayDateGEnd'];
                    $registrationDateGStartCheck = $elem['registrationDateGStartCheck'] == null ? 0 : $elem['registrationDateGStartCheck'];
                    $registrationDateGStart = $elem['registrationDateGStart'] == null ? 'null' : $elem['registrationDateGStart'];
                    $registrationDateGEndCheck = $elem['registrationDateGEndCheck'] == null ? 0 : $elem['registrationDateGEndCheck'];
                    $registrationDateGEnd = $elem['registrationDateGEnd'] == null ? 'null' : $elem['registrationDateGEnd'];
                    $several = $elem['several'] == null ? 'null' : "'" . $elem['several'] . "'";
                    $dniDateRStartCheck = $elem['dniDateRStartCheck'] == null ? 0 : $elem['dniDateRStartCheck'];
                    $dniDateRStart = $elem['dniDateRStart'] == null ? 'null' : $elem['dniDateRStart'];
                    $dniDateREndCheck = $elem['dniDateREndCheck'] == null ? 0 : $elem['dniDateREndCheck'];
                    $dniDateREnd = $elem['dniDateREnd'] == null ? 'null' : $elem['dniDateREnd'];
                    $familyBookDateRStartCheck = $elem['familyBookDateRStartCheck'] == null ? 0 : $elem['familyBookDateRStartCheck'];
                    $familyBookDateRStart = $elem['familyBookDateRStart'] == null ? 'null' : $elem['familyBookDateRStart'];
                    $familyBookDateREndCheck = $elem['familyBookDateREndCheck'] == null ? 0 : $elem['familyBookDateREndCheck'];
                    $familyBookDateREnd = $elem['familyBookDateREnd'] == null ? 'null' : $elem['familyBookDateREnd'];
                    $literalMarriageDateRStartCheck = $elem['literalMarriageDateRStartCheck'] == null ? 0 : $elem['literalMarriageDateRStartCheck'];
                    $literalMarriageDateRStart = $elem['literalMarriageDateRStart'] == null ? 'null' : $elem['literalMarriageDateRStart'];
                    $literalMarriageDateREndCheck = $elem['literalMarriageDateREndCheck'] == null ? 0 : $elem['literalMarriageDateREndCheck'];
                    $literalMarriageDateREnd = $elem['literalMarriageDateREnd'] == null ? 'null' : $elem['literalMarriageDateREnd'];
                    $literalBirthdayDateRStartCheck = $elem['literalBirthdayDateRStartCheck'] == null ? 0 : $elem['literalBirthdayDateRStartCheck'];
                    $literalBirthdayDateRStart = $elem['literalBirthdayDateRStart'] == null ? 'null' : $elem['literalBirthdayDateRStart'];
                    $literalBirthdayDateREndCheck = $elem['literalBirthdayDateREndCheck'] == null ? 0 : $elem['literalBirthdayDateREndCheck'];
                    $literalBirthdayDateREnd = $elem['literalBirthdayDateREnd'] == null ? 'null' : $elem['literalBirthdayDateREnd'];
                    $registrationDateRStartCheck = $elem['registrationDateRStartCheck'] == null ? 0 : $elem['registrationDateRStartCheck'];
                    $registrationDateRStart = $elem['registrationDateRStart'] == null ? 'null' : $elem['registrationDateRStart'];
                    $registrationDateREndCheck = $elem['registrationDateREndCheck'] == null ? 0 : $elem['registrationDateREndCheck'];
                    $registrationDateREnd = $elem['registrationDateREnd'] == null ? 'null' : $elem['registrationDateREnd'];
                    $km = $elem['km'] == null ? 'null' : $elem['km'];
                    $successions = $elem['successions'] == null ? 'null' : "'" . $elem['successions'] . "'";
                    $deathReport = $elem['deathReport'] == null ? 'null' : "'" . $elem['deathReport'] . "'";
                    $production = $elem['production'] == null ? 'null' : "'" . $elem['production'] . "'";
                    $notes = $elem['notes'] == null ? 'null' : "'" . $elem['notes'] . "'";
                    $leavingDate = $elem['leavingDate'] == null ? 'null' : $elem['leavingDate'];
    
                    $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);
                    $result = $db->query("  SELECT    * 
                                            FROM      Assistances 
                                            WHERE     extraID = '" . $extraID . "'");
                    while(mysqli_num_rows($result) > 0){
                        $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 10);
                        $result = $db->query("  SELECT    * 
                                                FROM      Assistances 
                                                WHERE     extraID = '" . $extraID . "'");
                    }
                    
                    $query = "  INSERT INTO Assistances(
                                    expedient, attendanceDate, address, location, phone1, phone2, phone3, literalDate, receiptDate, ssDateStartCheck,
                                    ssDateStart, ssDateEndCheck, ssDateEnd, spanishPension, foreignPension, inssDateStartCheck, inssDateStart,
                                    inssDateEndCheck, inssDateEnd, ismDateStartCheck, ismDateStart, ismDateEndCheck, ismDateEnd, socialDateStartCheck,
                                    socialDateStart, socialDateEndCheck, socialDateEnd, passiveDateStartCheck, passiveDateStart, passiveDateEndCheck,
                                    passiveDateEnd, isfasDateStartCheck, isfasDateStart, isfasDateEndCheck, isfasDateEnd, lastWishDateStartCheck,
                                    lastWishDateStart, lastWishDateEndCheck, lastWishDateEnd, insuranceCoverageStartCheck, insuranceCoverageStart,
                                    insuranceCoverageEndCheck, insuranceCoverageEnd, dniDateGStartCheck, dniDateGStart, dniDateGEndCheck, dniDateGEnd,
                                    familyBookDateGStartCheck, familyBookDateGStart, familyBookDateGEndCheck, familyBookDateGEnd, literalMarriageDateGStartCheck,
                                    literalMarriageDateGStart, literalMarriageDateGEndCheck, literalMarriageDateGEnd, literalBirthdayDateGStartCheck,
                                    literalBirthdayDateGStart, literalBirthdayDateGEndCheck, literalBirthdayDateGEnd, registrationDateGStartCheck,
                                    registrationDateGStart, registrationDateGEndCheck, registrationDateGEnd, several, dniDateRStartCheck, dniDateRStart,
                                    dniDateREndCheck, dniDateREnd, familyBookDateRStartCheck, familyBookDateRStart, familyBookDateREndCheck, familyBookDateREnd,
                                    literalMarriageDateRStartCheck, literalMarriageDateRStart, literalMarriageDateREndCheck, literalMarriageDateREnd,
                                    literalBirthdayDateRStartCheck, literalBirthdayDateRStart, literalBirthdayDateREndCheck, literalBirthdayDateREnd,
                                    registrationDateRStartCheck, registrationDateRStart, registrationDateREndCheck, registrationDateREnd, km, successions,
                                    deathReport, production, notes, extraID, leavingDate
                                )
                                VALUES (
                                    $newExpedientId, $attendanceDate, $address, $location, $phone1, $phone2, $phone3, $literalDate, $receiptDate, $ssDateStartCheck,
                                    $ssDateStart, $ssDateEndCheck, $ssDateEnd, $spanishPension, $foreignPension, $inssDateStartCheck, $inssDateStart,
                                    $inssDateEndCheck, $inssDateEnd, $ismDateStartCheck, $ismDateStart, $ismDateEndCheck, $ismDateEnd, $socialDateStartCheck,
                                    $socialDateStart, $socialDateEndCheck, $socialDateEnd, $passiveDateStartCheck, $passiveDateStart, $passiveDateEndCheck,
                                    $passiveDateEnd, $isfasDateStartCheck, $isfasDateStart, $isfasDateEndCheck, $isfasDateEnd, $lastWishDateStartCheck,
                                    $lastWishDateStart, $lastWishDateEndCheck, $lastWishDateEnd, $insuranceCoverageStartCheck, $insuranceCoverageStart,
                                    $insuranceCoverageEndCheck, $insuranceCoverageEnd, $dniDateGStartCheck, $dniDateGStart, $dniDateGEndCheck, $dniDateGEnd,
                                    $familyBookDateGStartCheck, $familyBookDateGStart, $familyBookDateGEndCheck, $familyBookDateGEnd, $literalMarriageDateGStartCheck,
                                    $literalMarriageDateGStart, $literalMarriageDateGEndCheck, $literalMarriageDateGEnd, $literalBirthdayDateGStartCheck,
                                    $literalBirthdayDateGStart, $literalBirthdayDateGEndCheck, $literalBirthdayDateGEnd, $registrationDateGStartCheck,
                                    $registrationDateGStart, $registrationDateGEndCheck, $registrationDateGEnd, $several, $dniDateRStartCheck, $dniDateRStart,
                                    $dniDateREndCheck, $dniDateREnd, $familyBookDateRStartCheck, $familyBookDateRStart, $familyBookDateREndCheck, $familyBookDateREnd,
                                    $literalMarriageDateRStartCheck, $literalMarriageDateRStart, $literalMarriageDateREndCheck, $literalMarriageDateREnd,
                                    $literalBirthdayDateRStartCheck, $literalBirthdayDateRStart, $literalBirthdayDateREndCheck, $literalBirthdayDateREnd,
                                    $registrationDateRStartCheck, $registrationDateRStart, $registrationDateREndCheck, $registrationDateREnd, $km, $successions,
                                    $deathReport, $production, $notes, '$extraID', $leavingDate
                                )
                    ";
    
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception($query);
                    }
                    $newAssistanceId = $db->getLastInsertId();
    
                    // Gets current assistance survey data
                    $query = "  SELECT  survey, value, notes
                                FROM    Survey_Assistance
                                WHERE   assistance = $assistanceId
                    ";
                    $result = $db->query($query);
                    if(!$result){
                        throw new Exception('Get current survey assistance data');
                    }
                    $currentSurveyAssistanteInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                    foreach($currentSurveyAssistanteInfo as $item){
                        $survey = $item['survey'] == null ? 'null' : $item['survey'];
                        $value = $item['value'] == null ? 'null' : $item['value'];
                        $notes = $item['notes'] == null ? 'null' : "'" . $item['notes'] . "'";
    
                        $query = "  INSERT INTO Survey_Assistance(
                                        survey, assistance, value, notes
                                    )
                                    VALUES (
                                        $survey, $newAssistanceId, $value, $notes
                                    )
                        ";
    
                        $result = $db->query($query);
                        if(!$result){
                            throw new Exception($query);
                        }
                    }
                }
                // End table: Assistances + Survey_Assistance
    
                // Start table: Flowers_Letters
                $result = $db->query("  SELECT  category, value
                                        FROM    Flowers_Letters
                                        WHERE   expedient = $expedientId
                ");
    
                $currentFlowersInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
                if($currentFlowersInfo != null){
                    $category = $currentFlowersInfo['category'] == null ? 'null' : "'" . $currentFlowersInfo['category'] . "'";
                    $value = $currentFlowersInfo['value'] == null ? 'null' : "'" . $currentFlowersInfo['value'] . "'";
    
                    $query = "  INSERT INTO Flowers_Letters(expedient, category, value)
                                            VALUES ($newExpedientId, $category, $value)
                    ";
                    $result = $db->query($query);
    
                    if(!$result){
                        throw new Exception('INSERT INTO Flowers_Letters');
                    }
                }
                // End table: Flowers_Letters
    
                // Start table: Visits + VisitsControl + Visits_Descriptions + Visits_Descriptions_Cafe + Incidents
                $result = $db->query("  SELECT  ID, control, leavingDate
                                        FROM    VisitsControl
                                        WHERE   expedient = $expedientId
                ");
    
                if(!$result){
                    throw new Exception('Get current visits control data');
                }
    
                $currentVisitsControlInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0] : null;
                if($currentVisitsControlInfo != null){
                    $visitControlId = $currentVisitsControlInfo['ID'];
                    $control = $currentVisitsControlInfo['control'] == null ? 'null' : "'" . $currentVisitsControlInfo['control'] . "'";
                    $leavingDate = $currentVisitsControlInfo['leavingDate'] == null ? 'null' : $currentVisitsControlInfo['leavingDate'];
    
                    $result = $db->query("  SELECT  MAX(ID) as id
                                            FROM    VisitsControl
                    ");
                    $maxID = mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0]['id'] : '1';
                    $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 2);
                    $extraID .= ($maxID+1);
    
                    $query = "  INSERT INTO VisitsControl(expedient, control, extraID, leavingDate)
                                VALUES ($newExpedientId, $control, '$extraID', $leavingDate)
                    ";
                    $result = $db->query($query);
    
                    if(!$result){
                        throw new Exception('INSERT INTO VisitsControl');
                    }
                    $newVisitsControlId = $db->getLastInsertId();
    
                    // Gets current visits
                    $query = "  SELECT  ID, visitControl, user, date, time, name, updateTime, leavingDate, extraID
                                FROM    Visits
                                WHERE   visitControl = $visitControlId
                    ";
                    $result = $db->query($query);
    
                    if(!$result){
                        throw new Exception('Get current visits data');
                    }
    
                    $currentVisitsInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                    foreach($currentVisitsInfo as $item){
                        $visitId = $item['ID'];
                        $user = $item['user'] == null ? 'null' : $item['user'];
                        $date = $item['date'] == null ? 'null' : "'" . $item['date'] . "'";
                        $time = $item['time'] == null ? 'null' : "'" . $item['time'] . "'";
                        $name = $item['name'] == null ? 'null' : "'" . $item['name'] . "'";
                        $updateTime = $item['updateTime'] == null ? 'null' : "'" . $item['updateTime'] . "'";
                        $leavingDate = $item['leavingDate'] == null ? 'null' : "'" . $item['leavingDate'] . "'";
    
                        $result = $db->query("  SELECT  MAX(ID) as id
                                                FROM    Visits");
                        $maxID = mysqli_num_rows($result) > 0 ? $db->resultToArray($result)[0]['id'] : '1';
                        $extraID = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 2);
                        $extraID .= ($maxID+1);
    
                        $query = "  INSERT INTO Visits(visitControl, user, date, time, name, updateTime, leavingDate, extraID)
                                    VALUES ($newVisitsControlId, $user, $date, $time, $name, $updateTime, $leavingDate, '$extraID')
                        ";
                        $result = $db->query($query);
    
                        if(!$result){
                            throw new Exception('INSERT INTO Visits');
                        }
                        $newVisitId = $db->getLastInsertId();
    
                        // Gets current visits descriptions
                        $query = "  SELECT  startCoffeShopCheck, startCoffeShopUser, startCoffeShopTime, startCoffeShopResolved, deliveryKeysCheck,
                                            deliveryKeysUser, deliveryKeysTo, deliveryKeysTime, deliveryKeysResolved, courtesyQuestionCheck, courtesyQuestionUser,
                                            courtesyQuestionTime, courtesyQuestionResolved, roomReviewCheck, roomReviewUser, roomReviewTime, roomReviewResolved,
                                            roomHandkerchiefReviewCheck, roomHandkerchiefReviewUser, roomHandkerchiefReviewTime, roomHandkerchiefReviewResolved,
                                            toiletReviewCheck, toiletReviewUser, toiletReviewTime, toiletReviewResolved, toiletPaperReviewCheck, toiletPaperReviewUser,
                                            toiletPaperReviewTime, toiletPaperReviewResolved, roomBurialReviewCheck, roomBurialReviewUser, roomBurialReviewTime,
                                            roomBurialReviewResolved, roomTempCheck, roomTempUser, roomTempTime, roomTempResolved, burialTemp, burialTempCheck,
                                            burialTempUser, burialTempTime, burialTempResolved, thanatopraxieTempCheck, thanatopraxieTempUser, thanatopraxieTempTime,
                                            thanatopraxieTempResolved, controlProductsCoffeShopCheck, controlProductsCoffeShopUser, controlProductsCoffeShopTime,
                                            controlProductsCoffeShopResolved, offeringCheck, offeringUser, offeringTime, offeringResolved, commonBathroomsCleaningCheck,
                                            commonBathroomsCleaningUser, commonBathroomsCleaningTime, commonBathroomsCleaningResolved, roomBathroomsCleaningCheck,
                                            roomBathroomsCleaningUser, roomBathroomsCleaningTime, roomBathroomsCleaningResolved, roomCleaningCheck, roomCleaningUser,
                                            roomCleaningTime, roomCleaningResolved, thanatopraxieCleaningCheck, thanatopraxieCleaningUser, thanatopraxieCleaningTime,
                                            thanatopraxieCleaningResolved, commonZonesCleaningCheck, commonZonesCleaningUser, commonZonesCleaningTime,
                                            commonZonesCleaningResolved, burialCleaningCheck, burialCleaningUser, burialCleaningTime, burialCleaningResolved, notes
                                    FROM    Visits_Descriptions
                                    WHERE   visit = $visitId
                        ";
                        $result = $db->query($query);
    
                        if(!$result){
                            throw new Exception('Get current visits descriptions data');
                        }
                        $currentVisitsDescriptionsInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
    
                        foreach($currentVisitsDescriptionsInfo as $value){
                            $startCoffeShopCheck = $value['startCoffeShopCheck'] == null ? 0 : $value['startCoffeShopCheck'];
                            $startCoffeShopUser = $value['startCoffeShopUser'] == null ? 'null' : $value['startCoffeShopUser'];
                            $startCoffeShopTime = $value['startCoffeShopTime'] == null ? 'null' : $value['startCoffeShopTime'];
                            $startCoffeShopResolved = $value['startCoffeShopResolved'] == null ? 0 : $value['startCoffeShopResolved'];
                            $deliveryKeysCheck = $value['deliveryKeysCheck'] == null ? 0 : $value['deliveryKeysCheck'];
                            $deliveryKeysUser = $value['deliveryKeysUser'] == null ? 'null' : $value['deliveryKeysUser'];
                            $deliveryKeysTo = $value['deliveryKeysTo'] == null ? 'null' : "'" . $value['deliveryKeysTo'] . "'";
                            $deliveryKeysTime = $value['deliveryKeysTime'] == null ? 'null' : $value['deliveryKeysTime'];
                            $deliveryKeysResolved = $value['deliveryKeysResolved'] == null ? 0 : $value['deliveryKeysResolved'];
                            $courtesyQuestionCheck = $value['courtesyQuestionCheck'] == null ? 0 : $value['courtesyQuestionCheck'];
                            $courtesyQuestionUser = $value['courtesyQuestionUser'] == null ? 'null' : $value['courtesyQuestionUser'];
                            $courtesyQuestionTime = $value['courtesyQuestionTime'] == null ? 'null' : $value['courtesyQuestionTime'];
                            $courtesyQuestionResolved = $value['courtesyQuestionResolved'] == null ? 0 : $value['courtesyQuestionResolved'];
                            $roomReviewCheck = $value['roomReviewCheck'] == null ? 0 : $value['roomReviewCheck'];
                            $roomReviewUser = $value['roomReviewUser'] == null ? 'null' : $value['roomReviewUser'];
                            $roomReviewTime = $value['roomReviewTime'] == null ? 'null' : $value['roomReviewTime'];
                            $roomReviewResolved = $value['roomReviewResolved'] == null ? 0 : $value['roomReviewResolved'];
                            $roomHandkerchiefReviewCheck = $value['roomHandkerchiefReviewCheck'] == null ? 0 : $value['roomHandkerchiefReviewCheck'];
                            $roomHandkerchiefReviewUser = $value['roomHandkerchiefReviewUser'] == null ? 'null' : $value['roomHandkerchiefReviewUser'];
                            $roomHandkerchiefReviewTime = $value['roomHandkerchiefReviewTime'] == null ? 'null' : $value['roomHandkerchiefReviewTime'];
                            $roomHandkerchiefReviewResolved = $value['roomHandkerchiefReviewResolved'] == null ? 0 : $value['roomHandkerchiefReviewResolved'];
                            $toiletReviewCheck = $value['toiletReviewCheck'] == null ? 0 : $value['toiletReviewCheck'];
                            $toiletReviewUser = $value['toiletReviewUser'] == null ? 'null' : $value['toiletReviewUser'];
                            $toiletReviewTime = $value['toiletReviewTime'] == null ? 'null' : $value['toiletReviewTime'];
                            $toiletReviewResolved = $value['toiletReviewResolved'] == null ? 0 : $value['toiletReviewResolved'];
                            $toiletPaperReviewCheck = $value['toiletPaperReviewCheck'] == null ? 0 : $value['toiletPaperReviewCheck'];
                            $toiletPaperReviewUser = $value['toiletPaperReviewUser'] == null ? 'null' : $value['toiletPaperReviewUser'];
                            $toiletPaperReviewTime = $value['toiletPaperReviewTime'] == null ? 'null' : $value['toiletPaperReviewTime'];
                            $toiletPaperReviewResolved = $value['toiletPaperReviewResolved'] == null ? 0 : $value['toiletPaperReviewResolved'];
                            $roomBurialReviewCheck = $value['roomBurialReviewCheck'] == null ? 0 : $value['roomBurialReviewCheck'];
                            $roomBurialReviewUser = $value['roomBurialReviewUser'] == null ? 'null' : $value['roomBurialReviewUser'];
                            $roomBurialReviewTime = $value['roomBurialReviewTime'] == null ? 'null' : $value['roomBurialReviewTime'];
                            $roomBurialReviewResolved = $value['roomBurialReviewResolved'] == null ? 0 : $value['roomBurialReviewResolved'];
                            $roomTempCheck = $value['roomTempCheck'] == null ? 0 : $value['roomTempCheck'];
                            $roomTempUser = $value['roomTempUser'] == null ? 'null' : $value['roomTempUser'];
                            $roomTempTime = $value['roomTempTime'] == null ? 'null' : $value['roomTempTime'];
                            $roomTempResolved = $value['roomTempResolved'] == null ? 0 : $value['roomTempResolved'];
                            $burialTemp = $value['burialTemp'] == null ? 'null' : $value['burialTemp'];
                            $burialTempCheck = $value['burialTempCheck'] == null ? 0 : $value['burialTempCheck'];
                            $burialTempUser = $value['burialTempUser'] == null ? 'null' : $value['burialTempUser'];
                            $burialTempTime = $value['burialTempTime'] == null ? 'null' : $value['burialTempTime'];
                            $burialTempResolved = $value['burialTempResolved'] == null ? 0 : $value['burialTempResolved'];
                            $thanatopraxieTempCheck = $value['thanatopraxieTempCheck'] == null ? 0 : $value['thanatopraxieTempCheck'];
                            $thanatopraxieTempUser = $value['thanatopraxieTempUser'] == null ? 'null' : $value['thanatopraxieTempUser'];
                            $thanatopraxieTempTime = $value['thanatopraxieTempTime'] == null ? 'null' : $value['thanatopraxieTempTime'];
                            $thanatopraxieTempResolved = $value['thanatopraxieTempResolved'] == null ? 0 : $value['thanatopraxieTempResolved'];
                            $controlProductsCoffeShopCheck = $value['controlProductsCoffeShopCheck'] == null ? 0 : $value['controlProductsCoffeShopCheck'];
                            $controlProductsCoffeShopUser = $value['controlProductsCoffeShopUser'] == null ? 'null' : $value['controlProductsCoffeShopUser'];
                            $controlProductsCoffeShopTime = $value['controlProductsCoffeShopTime'] == null ? 'null' : $value['controlProductsCoffeShopTime'];
                            $controlProductsCoffeShopResolved = $value['controlProductsCoffeShopResolved'] == null ? 0 : $value['controlProductsCoffeShopResolved'];
                            $offeringCheck = $value['offeringCheck'] == null ? 0 : $value['offeringCheck'];
                            $offeringUser = $value['offeringUser'] == null ? 'null' : $value['offeringUser'];
                            $offeringTime = $value['offeringTime'] == null ? 'null' : $value['offeringTime'];
                            $offeringResolved = $value['offeringResolved'] == null ? 0 : $value['offeringResolved'];
                            $commonBathroomsCleaningCheck = $value['commonBathroomsCleaningCheck'] == null ? 0 : $value['commonBathroomsCleaningCheck'];
                            $commonBathroomsCleaningUser = $value['commonBathroomsCleaningUser'] == null ? 'null' : $value['commonBathroomsCleaningUser'];
                            $commonBathroomsCleaningTime = $value['commonBathroomsCleaningTime'] == null ? 'null' : $value['commonBathroomsCleaningTime'];
                            $commonBathroomsCleaningResolved = $value['commonBathroomsCleaningResolved'] == null ? 0 : $value['commonBathroomsCleaningResolved'];
                            $roomBathroomsCleaningCheck = $value['roomBathroomsCleaningCheck'] == null ? 0 : $value['roomBathroomsCleaningCheck'];
                            $roomBathroomsCleaningUser = $value['roomBathroomsCleaningUser'] == null ? 'null' : $value['roomBathroomsCleaningUser'];
                            $roomBathroomsCleaningTime = $value['roomBathroomsCleaningTime'] == null ? 'null' : $value['roomBathroomsCleaningTime'];
                            $roomBathroomsCleaningResolved = $value['roomBathroomsCleaningResolved'] == null ? 0 : $value['roomBathroomsCleaningResolved'];
                            $roomCleaningCheck = $value['roomCleaningCheck'] == null ? 0 : $value['roomCleaningCheck'];
                            $roomCleaningUser = $value['roomCleaningUser'] == null ? 'null' : $value['roomCleaningUser'];
                            $roomCleaningTime = $value['roomCleaningTime'] == null ? 'null' : $value['roomCleaningTime'];
                            $roomCleaningResolved = $value['roomCleaningResolved'] == null ? 0 : $value['roomCleaningResolved'];
                            $thanatopraxieCleaningCheck = $value['thanatopraxieCleaningCheck'] == null ? 0 : $value['thanatopraxieCleaningCheck'];
                            $thanatopraxieCleaningUser = $value['thanatopraxieCleaningUser'] == null ? 'null' : $value['thanatopraxieCleaningUser'];
                            $thanatopraxieCleaningTime = $value['thanatopraxieCleaningTime'] == null ? 'null' : $value['thanatopraxieCleaningTime'];
                            $thanatopraxieCleaningResolved = $value['thanatopraxieCleaningResolved'] == null ? 0 : $value['thanatopraxieCleaningResolved'];
                            $commonZonesCleaningCheck = $value['commonZonesCleaningCheck'] == null ? 0 : $value['commonZonesCleaningCheck'];
                            $commonZonesCleaningUser = $value['commonZonesCleaningUser'] == null ? 'null' : $value['commonZonesCleaningUser'];
                            $commonZonesCleaningTime = $value['commonZonesCleaningTime'] == null ? 'null' : $value['commonZonesCleaningTime'];
                            $commonZonesCleaningResolved = $value['commonZonesCleaningResolved'] == null ? 0 : $value['commonZonesCleaningResolved'];
                            $burialCleaningCheck = $value['burialCleaningCheck'] == null ? 0 : $value['burialCleaningCheck'];
                            $burialCleaningUser = $value['burialCleaningUser'] == null ? 'null' : $value['burialCleaningUser'];
                            $burialCleaningTime = $value['burialCleaningTime'] == null ? 'null' : $value['burialCleaningTime'];
                            $burialCleaningResolved = $value['burialCleaningResolved'] == null ? 0 : $value['burialCleaningResolved'];
                            $notes = $value['notes'] == null ? 'null' : "'" . $value['notes'] . "'";
    
                            $query = "  INSERT INTO Visits_Descriptions(
                                            visit, startCoffeShopCheck, startCoffeShopUser, startCoffeShopTime, startCoffeShopResolved, deliveryKeysCheck,
                                            deliveryKeysUser, deliveryKeysTo, deliveryKeysTime, deliveryKeysResolved, courtesyQuestionCheck, courtesyQuestionUser,
                                            courtesyQuestionTime, courtesyQuestionResolved, roomReviewCheck, roomReviewUser, roomReviewTime, roomReviewResolved,
                                            roomHandkerchiefReviewCheck, roomHandkerchiefReviewUser, roomHandkerchiefReviewTime, roomHandkerchiefReviewResolved,
                                            toiletReviewCheck, toiletReviewUser, toiletReviewTime, toiletReviewResolved, toiletPaperReviewCheck, toiletPaperReviewUser,
                                            toiletPaperReviewTime, toiletPaperReviewResolved, roomBurialReviewCheck, roomBurialReviewUser, roomBurialReviewTime,
                                            roomBurialReviewResolved, roomTempCheck, roomTempUser, roomTempTime, roomTempResolved, burialTemp, burialTempCheck,
                                            burialTempUser, burialTempTime, burialTempResolved, thanatopraxieTempCheck, thanatopraxieTempUser, thanatopraxieTempTime,
                                            thanatopraxieTempResolved, controlProductsCoffeShopCheck, controlProductsCoffeShopUser, controlProductsCoffeShopTime,
                                            controlProductsCoffeShopResolved, offeringCheck, offeringUser, offeringTime, offeringResolved, commonBathroomsCleaningCheck,
                                            commonBathroomsCleaningUser, commonBathroomsCleaningTime, commonBathroomsCleaningResolved, roomBathroomsCleaningCheck,
                                            roomBathroomsCleaningUser, roomBathroomsCleaningTime, roomBathroomsCleaningResolved, roomCleaningCheck, roomCleaningUser,
                                            roomCleaningTime, roomCleaningResolved, thanatopraxieCleaningCheck, thanatopraxieCleaningUser, thanatopraxieCleaningTime,
                                            thanatopraxieCleaningResolved, commonZonesCleaningCheck, commonZonesCleaningUser, commonZonesCleaningTime,
                                            commonZonesCleaningResolved, burialCleaningCheck, burialCleaningUser, burialCleaningTime, burialCleaningResolved, notes
                                        )
                                        VALUES (
                                            $newVisitId, $startCoffeShopCheck, $startCoffeShopUser, $startCoffeShopTime, $startCoffeShopResolved, $deliveryKeysCheck,
                                            $deliveryKeysUser, $deliveryKeysTo, $deliveryKeysTime, $deliveryKeysResolved, $courtesyQuestionCheck, $courtesyQuestionUser,
                                            $courtesyQuestionTime, $courtesyQuestionResolved, $roomReviewCheck, $roomReviewUser, $roomReviewTime, $roomReviewResolved,
                                            $roomHandkerchiefReviewCheck, $roomHandkerchiefReviewUser, $roomHandkerchiefReviewTime, $roomHandkerchiefReviewResolved,
                                            $toiletReviewCheck, $toiletReviewUser, $toiletReviewTime, $toiletReviewResolved, $toiletPaperReviewCheck, $toiletPaperReviewUser,
                                            $toiletPaperReviewTime, $toiletPaperReviewResolved, $roomBurialReviewCheck, $roomBurialReviewUser, $roomBurialReviewTime,
                                            $roomBurialReviewResolved, $roomTempCheck, $roomTempUser, $roomTempTime, $roomTempResolved, $burialTemp, $burialTempCheck,
                                            $burialTempUser, $burialTempTime, $burialTempResolved, $thanatopraxieTempCheck, $thanatopraxieTempUser, $thanatopraxieTempTime,
                                            $thanatopraxieTempResolved, $controlProductsCoffeShopCheck, $controlProductsCoffeShopUser, $controlProductsCoffeShopTime,
                                            $controlProductsCoffeShopResolved, $offeringCheck, $offeringUser, $offeringTime, $offeringResolved, $commonBathroomsCleaningCheck,
                                            $commonBathroomsCleaningUser, $commonBathroomsCleaningTime, $commonBathroomsCleaningResolved, $roomBathroomsCleaningCheck,
                                            $roomBathroomsCleaningUser, $roomBathroomsCleaningTime, $roomBathroomsCleaningResolved, $roomCleaningCheck, $roomCleaningUser,
                                            $roomCleaningTime, $roomCleaningResolved, $thanatopraxieCleaningCheck, $thanatopraxieCleaningUser, $thanatopraxieCleaningTime,
                                            $thanatopraxieCleaningResolved, $commonZonesCleaningCheck, $commonZonesCleaningUser, $commonZonesCleaningTime,
                                            $commonZonesCleaningResolved, $burialCleaningCheck, $burialCleaningUser, $burialCleaningTime, $burialCleaningResolved, $notes
                                        )
                            ";
                            $result = $db->query($query);
    
                            if(!$result){
                                throw new Exception('INSERT INTO Visits');
                            }
                        }
    
                        // Gets visits descriptions cafe
                        $query = "  SELECT  product, model, user, amount
                                    FROM    Visits_Descriptions_Cafe
                                    WHERE   visitDescription = $visitId
                        ";
                        $result = $db->query($query);
    
                        if(!$result){
                            throw new Exception('Get current visits descriptions data');
                        }
                        $currentVisitsDescriptionsCafeInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
    
                        foreach($currentVisitsDescriptionsCafeInfo as $value){
                            $product = $value['product'] == null ? 'null' : $value['product'];
                            $model = $value['model'] == null ? 'null' : $value['model'];
                            $user = $value['user'] == null ? 'null' : $value['user'];
                            $amount = $value['amount'] == null ? 0 : $value['amount'];
    
                            $query = "  INSERT INTO Visits_Descriptions_Cafe(
                                            visitDescription, product, model, user, amount
                                        )
                                        VALUES (
                                            $newVisitId, $product, $model, $user, $amount
                                        )
                            ";
                            $result = $db->query($query);
    
                            if(!$result){
                                throw new Exception('INSERT INTO Visits_Descriptions_Cafe');
                            }
                        }
    
                        // Gets current incidents
                        $query = "  SELECT  visit, type, name, description, date
                                    FROM    Incidents
                                    WHERE   visit = $visitId
                        ";
                        $result = $db->query($query);
    
                        if(!$result){
                            throw new Exception('Get current incidents data');
                        }
                        $currentIncidentsInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                        foreach($currentIncidentsInfo as $value){
                            $type = $value['type'] == null ? "''" : "'" . $value['type'] . "'";
                            $name = $value['name'] == null ? 'null' : "'" . $value['name'] . "'";
                            $description = $value['description'] == null ? 'null' : "'" . $value['description'] . "'";
                            $date = $value['date'] == null ? 'null' : "'" . $value['date'] . "'";
    
                            $query = "  INSERT INTO Incidents(
                                            visit, type, name, description, date
                                        )
                                        VALUES (
                                            $newVisitId, $type, $name, $description, $date
                                        )
                            ";
                            $result = $db->query($query);
    
                            if(!$result){
                                throw new Exception('INSERT INTO Incidents');
                            }
                        }
                    }
                }
                // End table: Visits + VisitsControl + Visits_Descriptions + Visits_Descriptions_Cafe + Incidents
    
                // Start table: Expedients_Closed_Death
                $query = "  SELECT  type, model, isOpen, user
                            FROM    Expedients_Closed_Death
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
    
                $currentClosedDeathInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                if(count($currentClosedDeathInfo) > 0){
                    foreach($currentClosedDeathInfo as $elem){
                        $type = $elem['type'] == null ? 'null' : $elem['type'];
                        $model = $elem['model'] == null ? 'null' : $elem['model'];
                        $isOpen = $elem['isOpen'] == null ? 0 : $elem['isOpen'];
                        $user = $elem['user'] == null ? 'null' : $elem['user'];
    
                        $query = "  INSERT INTO Expedients_Closed_Death(expedient, type, model, isOpen, user)
                                    VALUES ($newExpedientId, $type, $model, $isOpen, $user)
                        ";
                        $result = $db->query($query);
    
                        if(!$result){
                            throw new Exception('INSERT INTO Expedients_Closed_Death');
                        }
                    }
    
                    exec("cp -r $expedientBaseDir/closed-death $newExpedientBaseDir/closed-death", $output, $code);
                    if(!empty($output) || $code != 0){
                        throw new Exception("Copy folder: $newExpedientBaseDir/closed-death");
                    }
                }
                // End table: Expedients_Closed_Death
    
                // Start table: Expedients_Duel_Received
                $query = "  SELECT  type, model, isOpen, user
                            FROM    Expedients_Duel_Received
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
    
                $currentDuelReceivedInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                if(count($currentDuelReceivedInfo) > 0){
                    foreach($currentDuelReceivedInfo as $elem){
                        $type = $elem['type'] == null ? 'null' : $elem['type'];
                        $model = $elem['model'] == null ? 'null' : $elem['model'];
                        $isOpen = $elem['isOpen'] == null ? 0 : $elem['isOpen'];
                        $user = $elem['user'] == null ? 'null' : $elem['user'];
    
                        $query = "  INSERT INTO Expedients_Duel_Received(expedient, type, model, isOpen, user)
                                    VALUES ($newExpedientId, $type, $model, $isOpen, $user)
                        ";
                        $result = $db->query($query);
    
                        if(!$result){
                            throw new Exception('INSERT INTO Expedients_Duel_Received');
                        }
                    }
    
                    exec("cp -r $expedientBaseDir/no-duel-received $newExpedientBaseDir/no-duel-received", $output, $code);
                    if(!empty($output) || $code != 0){
                        throw new Exception("Copy folder: $newExpedientBaseDir/no-duel-received");
                    }
                }
                // End table: Expedients_Duel_Received
    
                // Start table: Expedients_Reminder
                $query = "  SELECT  type, model, isOpen, user
                            FROM    Expedients_Reminder
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
    
                $currentReminderInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                if(count($currentReminderInfo) > 0){
                    foreach($currentReminderInfo as $elem){
                        $type = $elem['type'] == null ? 'null' : $elem['type'];
                        $model = $elem['model'] == null ? 'null' : $elem['model'];
                        $isOpen = $elem['isOpen'] == null ? 0 : $elem['isOpen'];
                        $user = $elem['user'] == null ? 'null' : $elem['user'];
    
                        $query = "  INSERT INTO Expedients_Reminder(expedient, type, model, isOpen, user)
                                                VALUES ($newExpedientId, $type, $model, $isOpen, $user)
                        ";
                        $result = $db->query($query);
    
                        if(!$result){
                            throw new Exception('INSERT INTO Expedients_Reminder');
                        }
                    }
    
                    exec("cp -r $expedientBaseDir/reminder $newExpedientBaseDir/reminder", $output, $code);
                    if(!empty($output) || $code != 0){
                        throw new Exception("Copy folder: $newExpedientBaseDir/reminder");
                    }
                }
                // End table: Expedients_Reminder
    
                // Start table: Expedients_Reminder_Packet
                $query = "  SELECT  type, model, isOpen, user
                            FROM    Expedients_Reminder_Packet
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
    
                $currentReminderPacketInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                if(count($currentReminderPacketInfo) > 0){
                    foreach($currentReminderPacketInfo as $elem){
                        $type = $elem['type'] == null ? 'null' : $elem['type'];
                        $model = $elem['model'] == null ? 'null' : $elem['model'];
                        $isOpen = $elem['isOpen'] == null ? 0 : $elem['isOpen'];
                        $user = $elem['user'] == null ? 'null' : $elem['user'];
    
                        $query = "  INSERT INTO Expedients_Reminder_Packet(expedient, type, model, isOpen, user)
                                                VALUES ($newExpedientId, $type, $model, $isOpen, $user)
                        ";
                        $result = $db->query($query);
    
                        if(!$result){
                            throw new Exception('INSERT INTO Expedients_Reminder_Packet');
                        }
                    }
    
                    exec("cp -r $expedientBaseDir/reminder-packet $newExpedientBaseDir/reminder-packet", $output, $code);
                    if(!empty($output) || $code != 0){
                        throw new Exception("Copy folder: $newExpedientBaseDir/reminder-packet");
                    }
                }
                // End table: Expedients_Reminder_Packet
    
                // Start table: Expedients_Reminder_Packet_Cross
                $query = "  SELECT  type, model, isOpen, user
                            FROM    Expedients_Reminder_Packet_Cross
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
    
                $currentReminderPacketCrossInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                if(count($currentReminderPacketCrossInfo) > 0){
                    foreach($currentReminderPacketCrossInfo as $elem){
                        $type = $elem['type'] == null ? 'null' : $elem['type'];
                        $model = $elem['model'] == null ? 'null' : $elem['model'];
                        $isOpen = $elem['isOpen'] == null ? 0 : $elem['isOpen'];
                        $user = $elem['user'] == null ? 'null' : $elem['user'];
    
                        $query = "  INSERT INTO Expedients_Reminder_Packet_Cross(expedient, type, model, isOpen, user)
                                                VALUES ($newExpedientId, $type, $model, $isOpen, $user)
                        ";
                        $result = $db->query($query);
    
                        if(!$result){
                            throw new Exception('INSERT INTO Expedients_Reminder_Packet_Cross');
                        }
                    }
    
                    exec("cp -r $expedientBaseDir/reminder-packet-cross $newExpedientBaseDir/reminder-packet-cross", $output, $code);
                    if(!empty($output) || $code != 0){
                        throw new Exception("Copy folder: $newExpedientBaseDir/reminder-packet-cross");
                    }
                }
                // End table: Expedients_Reminder_Packet_Cross
    
                // Start table: Expedients_Tombstones
                $query = "  SELECT  type, model, isOpen, user
                            FROM    Expedients_Tombstones
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
    
                $currentTombstoneInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                if(count($currentTombstoneInfo) > 0){
                    foreach($currentTombstoneInfo as $elem){
                        $type = $elem['type'] == null ? 'null' : $elem['type'];
                        $model = $elem['model'] == null ? 'null' : $elem['model'];
                        $isOpen = $elem['isOpen'] == null ? 0 : $elem['isOpen'];
                        $user = $elem['user'] == null ? 'null' : $elem['user'];
    
                        $query = "  INSERT INTO Expedients_Tombstones(expedient, type, model, isOpen, user)
                                    VALUES ($newExpedientId, $type, $model, $isOpen, $user)
                        ";
                        $result = $db->query($query);
    
                        if(!$result){
                            throw new Exception('INSERT INTO Expedients_Tombstones');
                        }
                    }
    
                    exec("cp -r $expedientBaseDir/tombstone $newExpedientBaseDir/tombstone", $output, $code);
                    if(!empty($output) || $code != 0){
                        throw new Exception("Copy folder: $newExpedientBaseDir/tombstone");
                    }
                }
                // End table: Expedients_Tombstones
    
                // Start table: Expedients_Press
                $query = "  SELECT  type, model, isOpen, selected, user
                            FROM    Expedients_Press
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
    
                $currentPressInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                if(count($currentPressInfo) > 0){
                    foreach($currentPressInfo as $elem){
                        $type = $elem['type'] == null ? 'null' : $elem['type'];
                        $model = $elem['model'] == null ? 'null' : $elem['model'];
                        $isOpen = $elem['isOpen'] == null ? 0 : $elem['isOpen'];
                        $selected = $elem['selected'] == null ? 0 : $elem['selected'];
                        $user = $elem['user'] == null ? 'null' : $elem['user'];
    
                        $query = "  INSERT INTO Expedients_Press(expedient, type, model, isOpen, selected, user)
                                    VALUES ($newExpedientId, $type, $model, $isOpen, $selected, $user)
                        ";
                        $result = $db->query($query);
    
                        if(!$result){
                            throw new Exception('INSERT INTO Expedients_Press');
                        }
                    }
    
                    exec("cp -r $expedientBaseDir/obituary-press $newExpedientBaseDir/obituary-press", $output, $code);
                    if(!empty($output) || $code != 0){
                        throw new Exception("Copy folder: $newExpedientBaseDir/obituary-press");
                    }
                }
                // End table: Expedients_Press
    
                // Start table: Expedients_Obituaries
                $query = "  SELECT  ID, namePre, name, surname, extraText, died, prayForCheck, prayForText,
                                    prayForGenre, dep, spousePre, spouseName, childrenPre, childrenNames, childrenInLawPre,
                                    childrenInLawNames, grandchildrenPre, grandchildrenNames, grandchildrenInLawPre,
                                    grandchildrenInLawNames, greatGrandchildrenPre, greatGrandchildrenNames, parentsPre,
                                    parentsNames, parentsInLawPre, parentsInLawNames, paternalGrandfathersPre,
                                    paternalGrandfathersNames, paternalGrandmotherPre, paternalGrandmotherNames, siblingsPre,
                                    siblingsNames, politicalSiblingsPre, politicalSiblingsNames, siblings, politicalSiblings,
                                    grandchildren, politicalGrandchildren, greatGrandchildren, uncles, nephews, cousins,
                                    restFamily, pray, funeral, mourning, deliverObituariesIn, busRoute, type, model, selected,
                                    mortuary, location, roomNumber, html, `update`, obituary, isOpen, user
                            FROM    Expedients_Obituaries
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
    
                $currentObituaryInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                if(count($currentObituaryInfo) > 0){
                    foreach($currentObituaryInfo as $elem){
                        $namePre = $elem['namePre'] == null ? 'null' : "'" . $elem['namePre'] . "'";
                        $name = $elem['name'] == null ? "''" : "'" . $elem['name'] . "'";
                        $surname = $elem['surname'] == null ? "''" : "'" . $elem['surname'] . "'";
                        $extraText = $elem['extraText'] == null ? 'null' : "'" . $elem['extraText'] . "'";
                        $died = $elem['died'] == null ? 'null' : "'" . $elem['died'] . "'";
                        $prayForCheck = $elem['prayForCheck'] == null ? 0 : $elem['prayForCheck'];
                        $prayForText = $elem['prayForText'] == null ? 'null' : "'" . $elem['prayForText'] . "'";
                        $prayForGenre = $elem['prayForGenre'] == null ? 'null' : "'" . $elem['prayForGenre'] . "'";
                        $dep = $elem['dep'] == null ? 0 : $elem['dep'];
                        $spousePre = $elem['spousePre'] == null ? 'null' : "'" . $elem['spousePre'] . "'";
                        $spouseName = $elem['spouseName'] == null ? 'null' : "'" . $elem['spouseName'] . "'";
                        $childrenPre = $elem['childrenPre'] == null ? 'null' : "'" . $elem['childrenPre'] . "'";
                        $childrenNames = $elem['childrenNames'] == null ? 'null' : "'" . $elem['childrenNames'] . "'";
                        $childrenInLawPre = $elem['childrenInLawPre'] == null ? 'null' : "'" . $elem['childrenInLawPre'] . "'";
                        $childrenInLawNames = $elem['childrenInLawNames'] == null ? 'null' : "'" . $elem['childrenInLawNames'] . "'";
                        $grandchildrenPre = $elem['grandchildrenPre'] == null ? 'null' : "'" . $elem['grandchildrenPre'] . "'";
                        $grandchildrenNames = $elem['grandchildrenNames'] == null ? 'null' : "'" . $elem['grandchildrenNames'] . "'";
                        $grandchildrenInLawPre = $elem['grandchildrenInLawPre'] == null ? 'null' : "'" . $elem['grandchildrenInLawPre'] . "'";
                        $grandchildrenInLawNames = $elem['grandchildrenInLawNames'] == null ? 'null' : "'" . $elem['grandchildrenInLawNames'] . "'";
                        $greatGrandchildrenPre = $elem['greatGrandchildrenPre'] == null ? 'null' : "'" . $elem['greatGrandchildrenPre'] . "'";
                        $greatGrandchildrenNames = $elem['greatGrandchildrenNames'] == null ? 'null' : "'" . $elem['greatGrandchildrenNames'] . "'";
                        $parentsPre = $elem['parentsPre'] == null ? 'null' : "'" . $elem['parentsPre'] . "'";
                        $parentsNames = $elem['parentsNames'] == null ? 'null' : "'" . $elem['parentsNames'] . "'";
                        $parentsInLawPre = $elem['parentsInLawPre'] == null ? 'null' : "'" . $elem['parentsInLawPre'] . "'";
                        $parentsInLawNames = $elem['parentsInLawNames'] == null ? 'null' : "'" . $elem['parentsInLawNames'] . "'";
                        $paternalGrandfathersPre = $elem['paternalGrandfathersPre'] == null ? 'null' : "'" . $elem['paternalGrandfathersPre'] . "'";
                        $paternalGrandfathersNames = $elem['paternalGrandfathersNames'] == null ? 'null' : "'" . $elem['paternalGrandfathersNames'] . "'";
                        $paternalGrandmotherPre = $elem['paternalGrandmotherPre'] == null ? 'null' : "'" . $elem['paternalGrandmotherPre'] . "'";
                        $paternalGrandmotherNames = $elem['paternalGrandmotherNames'] == null ? 'null' : "'" . $elem['paternalGrandmotherNames'] . "'";
                        $siblingsPre = $elem['siblingsPre'] == null ? 'null' : "'" . $elem['siblingsPre'] . "'";
                        $siblingsNames = $elem['siblingsNames'] == null ? 'null' : "'" . $elem['siblingsNames'] . "'";
                        $politicalSiblingsPre = $elem['politicalSiblingsPre'] == null ? 'null' : "'" . $elem['politicalSiblingsPre'] . "'";
                        $politicalSiblingsNames = $elem['politicalSiblingsNames'] == null ? 'null' : "'" . $elem['politicalSiblingsNames'] . "'";
                        $siblings = $elem['siblings'] == null ? 0 : $elem['siblings'];
                        $politicalSiblings = $elem['politicalSiblings'] == null ? 0 : $elem['politicalSiblings'];
                        $grandchildren = $elem['grandchildren'] == null ? 0 : $elem['grandchildren'];
                        $politicalGrandchildren = $elem['politicalGrandchildren'] == null ? 0 : $elem['politicalGrandchildren'];
                        $greatGrandchildren = $elem['greatGrandchildren'] == null ? 0 : $elem['greatGrandchildren'];
                        $uncles = $elem['uncles'] == null ? 0 : $elem['uncles'];
                        $nephews = $elem['nephews'] == null ? 0 : $elem['nephews'];
                        $cousins = $elem['cousins'] == null ? 0 : $elem['cousins'];
                        $restFamily = $elem['restFamily'] == null ? 'null' : "'" . $elem['restFamily'] . "'";
                        $pray = $elem['pray'] == null ? 'null' : "'" . $elem['pray'] . "'";
                        $funeral = $elem['funeral'] == null ? 'null' : "'" . $elem['funeral'] . "'";
                        $mourning = $elem['mourning'] == null ? 0 : $elem['mourning'];
                        $deliverObituariesIn = $elem['deliverObituariesIn'] == null ? 'null' : "'" . $elem['deliverObituariesIn'] . "'";
                        $busRoute = $elem['busRoute'] == null ? 'null' : "'" . $elem['busRoute'] . "'";
                        $type = $elem['type'] == null ? 0 : $elem['type'];
                        $model = $elem['model'] == null ? 0 : $elem['model'];
                        $selected = $elem['selected'] == null ? 0 : $elem['selected'];
                        $mortuary = $elem['mortuary'] == null ? "''" : "'" . $elem['mortuary'] . "'";
                        $location = $elem['location'] == null ? "''" : "'" . $elem['location'] . "'";
                        $roomNumber = $elem['roomNumber'] == null ? 'null' : "'" . $elem['roomNumber'] . "'";
                        $html = $elem['html'] == null ? 'null' : "'" . $elem['html'] . "'";
                        $update = $elem['update'] == null ? $time : "'" . $elem['update'] . "'";
                        $obituary = $elem['obituary'] == null ? 'null' : "'" . $elem['obituary'] . "'";
                        $isOpen = $elem['isOpen'] == null ? 0 : $elem['isOpen'];
                        $user = $elem['user'] == null ? 'null' : $elem['user'];
    
                        $query = "  INSERT INTO Expedients_Obituaries(
                                        expedient, namePre, name, surname, extraText, died, prayForCheck, prayForText,
                                        prayForGenre, dep, spousePre, spouseName, childrenPre, childrenNames, childrenInLawPre,
                                        childrenInLawNames, grandchildrenPre, grandchildrenNames, grandchildrenInLawPre,
                                        grandchildrenInLawNames, greatGrandchildrenPre, greatGrandchildrenNames, parentsPre,
                                        parentsNames, parentsInLawPre, parentsInLawNames, paternalGrandfathersPre,
                                        paternalGrandfathersNames, paternalGrandmotherPre, paternalGrandmotherNames, siblingsPre,
                                        siblingsNames, politicalSiblingsPre, politicalSiblingsNames, siblings, politicalSiblings,
                                        grandchildren, politicalGrandchildren, greatGrandchildren, uncles, nephews, cousins,
                                        restFamily, pray, funeral, mourning, deliverObituariesIn, busRoute, type, model, selected,
                                        mortuary, location, roomNumber, html, `update`, obituary, isOpen, user
                                    )
                                    VALUES (
                                        $newExpedientId, $namePre, $name, $surname, $extraText, $died, $prayForCheck, $prayForText,
                                        $prayForGenre, $dep, $spousePre, $spouseName, $childrenPre, $childrenNames, $childrenInLawPre,
                                        $childrenInLawNames, $grandchildrenPre, $grandchildrenNames, $grandchildrenInLawPre,
                                        $grandchildrenInLawNames, $greatGrandchildrenPre, $greatGrandchildrenNames, $parentsPre,
                                        $parentsNames, $parentsInLawPre, $parentsInLawNames, $paternalGrandfathersPre,
                                        $paternalGrandfathersNames, $paternalGrandmotherPre, $paternalGrandmotherNames, $siblingsPre,
                                        $siblingsNames, $politicalSiblingsPre, $politicalSiblingsNames, $siblings, $politicalSiblings,
                                        $grandchildren, $politicalGrandchildren, $greatGrandchildren, $uncles, $nephews, $cousins,
                                        $restFamily, $pray, $funeral, $mourning, $deliverObituariesIn, $busRoute, $type, $model, $selected,
                                        $mortuary, $location, $roomNumber, $html, $update, $obituary, $isOpen, $user
                                    )
                        ";
                        $result = $db->query($query);
    
                        if(!$result){
                            throw new Exception('INSERT INTO Expedients_Obituaries');
                        }
                    }
    
                    exec("cp -r $expedientBaseDir/obituary $newExpedientBaseDir/obituary", $output, $code);
                    if(!empty($output) || $code != 0){
                        throw new Exception("Copy folder: $newExpedientBaseDir/obituary");
                    }
                }
                // End table: Expedients_Obituaries
    
                // Start table: Expedients_Obituaries_Images
                $query = "  SELECT  name, main, create_date, update_date, delete_date
                            FROM    Expedients_Obituaries_Images
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
    
                $currentObituaryImagesInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                if(count($currentObituaryImagesInfo) > 0){
                    foreach($currentObituaryImagesInfo as $elem){
                        $name = $elem['name'] == null ? 'null' : "'" . $elem['name'] . "'";
                        $main = $elem['main'] == null ? 0 : $elem['main'];
                        $createDate = $elem['create_date'] == null ? 'null' : $elem['create_date'];
                        $updateDate = $elem['update_date'] == null ? 'null' : $elem['update_date'];
                        $deleteDate = $elem['delete_date'] == null ? 'null' : $elem['delete_date'];
    
                        $query = "  INSERT INTO Expedients_Obituaries_Images(
                                        expedient, name, main, create_date, update_date, delete_date
                                    )
                                    VALUES (
                                        $newExpedientId, $name, $main, $createDate, $updateDate, $deleteDate
                                    )
                        ";
                        $result = $db->query($query);
    
                        if(!$result){
                            throw new Exception('INSERT INTO Expedients_Obituaries_Images');
                        }
                    }
                }
                // End table: Expedients_Obituaries_Images
    
                // Start table: Expedients_Documents
                $query = "  SELECT  user, type, date, name, file, nameFile
                            FROM    Expedients_Documents
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
    
                $currentDocumentsInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                if(count($currentDocumentsInfo) > 0){
                    foreach($currentDocumentsInfo as $elem){
                        $user = $elem['user'] == null ? 'null' : $elem['user'];
                        $type = $elem['type'] == null ? 1 : $elem['type'];
                        $date = $elem['date'] == null ? 'null' : "'" . $elem['date'] . "'";
                        $name = $elem['name'] == null ? "''" : "'" . $elem['name'] . "'";
                        $file = $elem['file'] == null ? 'null' : "'" . $elem['file'] . "'";
                        $nameFile = $elem['nameFile'] == null ? 'null' : "'" . $elem['nameFile'] . "'";
    
                        $query = "  INSERT INTO Expedients_Documents(
                                        expedient, user, type, date, name, file, nameFile
                                    )
                                    VALUES (
                                        $newExpedientId, $user, $type, $date, $name, $file, $nameFile
                                    )
                        ";
                        $result = $db->query($query);
    
                        if(!$result){
                            throw new Exception('INSERT INTO Expedients_Documents');
                        }
                    }
    
                    exec("cp -r $expedientBaseDir/docs $newExpedientBaseDir/docs", $output, $code);
                    if(!empty($output) || $code != 0){
                        throw new Exception("Copy folder: $newExpedientBaseDir/docs");
                    }
                }
                // End table: Expedients_Documents
    
                // Start table: Expedients_Documents_Editor
                $query = "  SELECT  ID, document, user, userOpen, documentName, date, isOpen, leavingDate, isSigned
                            FROM    Expedients_Documents_Editor
                            WHERE   expedient = $expedientId
                ";
                $result = $db->query($query);
    
                $currentDocumentsInfo = mysqli_num_rows($result) > 0 ? $db->resultToArray($result) : array();
                if(count($currentDocumentsInfo) > 0){
                    foreach($currentDocumentsInfo as $elem){
                        $documentId = $elem['ID'] == null ? 'null' : $elem['ID'];
                        $document = $elem['document'] == null ? 'null' : $elem['document'];
                        $user = $elem['user'] == null ? 'null' : $elem['user'];
                        $userOpen = $elem['userOpen'] == null ? 'null' : $elem['userOpen'];
                        $documentName = $elem['documentName'] == null ? 'null' : "'" . $elem['documentName'] . "'";
                        $date = $elem['date'] == null ? 'null' : $elem['date'];
                        $isOpen = $elem['isOpen'] == null ? 0 : $elem['isOpen'];
                        $leavingDate = $elem['leavingDate'] == null ? 'null' : $elem['leavingDate'];
                        $isSigned = $elem['isSigned'] == null ? 'null' : $elem['isSigned'];
    
                        $query = "  INSERT INTO Expedients_Documents_Editor(
                                        expedient, document, user, userOpen, documentName, date, isOpen, leavingDate, isSigned
                                    )
                                    VALUES (
                                        $newExpedientId, $document, $user, $userOpen, $documentName, $date, $isOpen, $leavingDate, $isSigned
                                    )
                        ";
                        $result = $db->query($query);
    
                        if(!$result){
                            throw new Exception('INSERT INTO Expedients_Documents_Editor');
                        }
                        $newDocumentId = $db->getLastInsertId();
    
                        mkdir("$newExpedientBaseDir/documentsEditor/$newDocumentId", 0777, true);
                        
                        if(is_dir("$expedientBaseDir/documentsEditor/$documentId/files")){
                            exec("cp -r $expedientBaseDir/documentsEditor/$documentId/files $newExpedientBaseDir/documentsEditor/$newDocumentId", $output, $code);
                            if(!empty($output) || $code != 0){
                                throw new Exception("Copy folder: $expedientBaseDir/documentsEditor/$documentId/files $newExpedientBaseDir/documentsEditor/$newDocumentId");
                            }
                        }

                        if(is_dir("$expedientBaseDir/documentsEditor/$documentId/img")){
                            exec("cp -r $expedientBaseDir/documentsEditor/$documentId/img $newExpedientBaseDir/documentsEditor/$newDocumentId", $output, $code);
                            if(!empty($output) || $code != 0){
                                throw new Exception("Copy folder: $expedientBaseDir/documentsEditor/$documentId/img $newExpedientBaseDir/documentsEditor/$newDocumentId");
                            }
                        }
                    }
                }
                // End table: Expedients_Documents_Editor
    
                $db->query("COMMIT");

                return [
                    "status" => true,
                    "expedientID" => $newExpedientId
                ];
            }catch (Exception $e) {
                $db->query("ROLLBACK");
    
                return [
                    "status" => false,
                    "error" => $e->getMessage()
                ];
            }
        }
    }

?>